This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.
The content has been processed where line numbers have been added.

# File Summary

## Purpose
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

## File Format
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  a. A header with the file path (## File: path/to/file)
  b. The full contents of the file in a code block

## Usage Guidelines
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
- Pay special attention to the Repository Description. These contain important context and guidelines specific to this project.
- Pay special attention to the Repository Instruction. These contain important context and guidelines specific to this project.

## Notes
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: lib/**/*.ex, lib/**/*.html.heex, config/*.exs, priv/repo/migrations/*.exs, priv/repo/seeds.exs, priv/gettext/**/*.po, assets/js/**/*.js, assets/css/**/*.css, test/**/*.exs, mix.exs, README.md, CLAUDE.md, docker-compose.yml, .env.example, .formatter.exs, lib/**/*.ex, lib/**/*.heex, config/*.exs, priv/repo/migrations/*.exs, mix.exs, CLAUDE.md
- Files matching these patterns are excluded: _build/**, deps/**, node_modules/**, .git/**, .elixir_ls/**, priv/static/**, erl_crash.dump, .env, .env.local, .env.*.local, tmp/**, cover/**, .DS_Store, .idea/**, .vscode/**, .claude/**, .playwright-mcp/**, *.tar, *.ez, mix.lock, assets/vendor/**, assets/js/_*.js, assets/css/_*.css, repomix-output.md, **/*.beam, **/*.dump, deps, _build, *.dump, *.log, priv/static, priv/firebase-service-account.json, .elixir_ls, node_modules
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Line numbers have been added to the beginning of each line
- Files are sorted by Git change count (files with more changes are at the bottom)

# User Provided Header
# Hellen AI - Codebase Context

This file contains the complete source code of the Hellen AI project, a lesson analysis platform built with Phoenix/Elixir.

## Quick Reference

- **Framework**: Phoenix 1.7.14 + Elixir
- **Database**: TimescaleDB (PostgreSQL)
- **Background Jobs**: Oban
- **Auth**: Guardian (JWT)
- **Storage**: Cloudflare R2 (S3-compatible)
- **AI**: NVIDIA NIM API (Parakeet ASR + Qwen3)

## Architecture

```
Audio Upload → Transcription Job → Analysis Job → Results
     ↓              ↓                   ↓            ↓
  R2 Storage    NVIDIA Parakeet     NVIDIA Qwen3   WebSocket
```

# Directory Structure
```
assets/
  css/
    app.css
  js/
    hooks/
      charts.js
      firebase.js
      pwa.js
      scroll_animation.js
      sidebar.js
      ui_enhancements.js
    app.js
config/
  config.exs
  dev.exs
  prod.exs
  runtime.exs
  test.exs
lib/
  hellen/
    accounts/
      institution.ex
      invitation.ex
      user.ex
    ai/
      assessment_generator.ex
      audio_extractor.ex
      client_behaviour.ex
      embeddings.ex
      nvidia_client.ex
      planning_generator.ex
      qdrant_client.ex
    analysis/
      analysis.ex
      bncc_match.ex
      bullying_alert.ex
    assessments/
      assessment.ex
    auth/
      firebase.ex
      guardian.ex
    billing/
      credit_transaction.ex
      stripe_service.ex
    gamification/
      user_achievement.ex
    lessons/
      lesson.ex
      transcription.ex
    notifications/
      emails.ex
      mailer.ex
      notification.ex
      preference.ex
    plannings/
      planning.ex
    storage/
      behaviour.ex
    workers/
      analysis_job.ex
      cleanup_job.ex
      notification_job.ex
      transcription_job.ex
    accounts.ex
    analysis.ex
    application.ex
    assessments.ex
    billing.ex
    exports.ex
    gamification.ex
    lessons.ex
    notifications.ex
    plannings.ex
    release.ex
    repo.ex
    reports.ex
    storage.ex
  hellen_web/
    channels/
      lesson_channel.ex
      user_socket.ex
    components/
      layouts/
        app.html.heex
        auth.html.heex
        landing.html.heex
        root.html.heex
      core_components.ex
      landing_components.ex
      layouts.ex
      sidebar.ex
      ui_components.ex
    controllers/
      api/
        analysis_controller.ex
        analysis_json.ex
        auth_controller.ex
        credit_controller.ex
        credit_json.ex
        lesson_controller.ex
        lesson_json.ex
      changeset_json.ex
      error_html.ex
      error_json.ex
      fallback_controller.ex
      health_controller.ex
      page_controller.ex
      report_controller.ex
      session_controller.ex
      stripe_webhook_controller.ex
    live/
      admin_live/
        health.ex
        index.ex
        institutions.ex
        users.ex
      alerts_live/
        index.ex
      analytics_live/
        index.ex
      assessments_live/
        edit.ex
        index.ex
        new.ex
        show.ex
      auth_live/
        invite.ex
        login.ex
        register.ex
      billing_live/
        index.ex
      dashboard_live/
        index.ex
      institution_live/
        index.ex
        reports.ex
        teachers.ex
      legal_live/
        privacy_live.ex
        support_live.ex
        terms_live.ex
      lesson_live/
        new.ex
        show.ex
      lessons_live/
        index.ex
      plannings_live/
        edit.ex
        index.ex
        new.ex
        show.ex
      reports_live/
        index.ex
      settings_live/
        index.ex
      achievements_live.ex
      landing_live.ex
      notification_bell_live.ex
      onboarding_live.ex
    plugs/
      auth.ex
      authorize.ex
      stripe_webhook_plug.ex
      tenant.ex
    endpoint.ex
    gettext.ex
    live_auth.ex
    router.ex
    telemetry.ex
  hellen_web.ex
  hellen.ex
priv/
  repo/
    migrations/
      20241201000000_add_oban_jobs_table.exs
      20241201000001_create_institutions.exs
      20241201000002_create_users.exs
      20241201000003_create_lessons.exs
      20241201000004_create_transcriptions.exs
      20241201000005_create_analyses.exs
      20241201000006_create_bncc_matches.exs
      20241201000007_create_bullying_alerts.exs
      20241201000008_create_credit_transactions.exs
      20241202000001_add_firebase_fields_to_users.exs
      20251204000001_add_institution_to_lessons.exs
      20251204000002_add_institution_to_analyses.exs
      20251204144700_convert_maps_to_jsonb.exs
      20251204144701_add_missing_indexes.exs
      20251204182909_create_notifications.exs
      20251204190117_create_invitations.exs
      20251204192834_add_stripe_fields.exs
      20251206000001_create_plannings.exs
      20251206000002_create_assessments.exs
      20251207015959_add_onboarding_to_users.exs
      20251207020414_set_existing_users_onboarding_completed.exs
      20251207020447_create_achievements.exs
    seeds.exs
test/
  hellen/
    accounts_test.exs
    analysis_test.exs
    billing_test.exs
    lessons_test.exs
    notifications_test.exs
  hellen_web/
    controllers/
      api/
        analysis_controller_test.exs
        auth_controller_test.exs
        credit_controller_test.exs
        lesson_controller_test.exs
  test_helper.exs
.env.example
.formatter.exs
CLAUDE.md
docker-compose.yml
mix.exs
README.md
```

# Files

## File: assets/js/hooks/firebase.js
````javascript
  1: // Firebase Authentication Hook for Phoenix LiveView
  2: // Uses Firebase SDK loaded via CDN in root.html.heex
  3: 
  4: const firebaseConfig = {
  5:   apiKey: "AIzaSyD-xkOOfGgaEZ_fyzCvUhsxuIyLJJpaXWc",
  6:   authDomain: "hellen-ai.firebaseapp.com",
  7:   projectId: "hellen-ai",
  8:   storageBucket: "hellen-ai.firebasestorage.app",
  9:   messagingSenderId: "366151843508",
 10:   appId: "1:366151843508:web:8e1f3b3191e9392e31e1e1",
 11:   measurementId: "G-42LER22MWF"
 12: };
 13: 
 14: let firebaseApp = null;
 15: let firebaseAuth = null;
 16: 
 17: // Initialize Firebase (called once)
 18: function initFirebase() {
 19:   if (firebaseApp) return { app: firebaseApp, auth: firebaseAuth };
 20: 
 21:   // Check if Firebase SDK is loaded
 22:   if (typeof firebase === 'undefined') {
 23:     console.error('[Firebase] SDK not loaded. Make sure Firebase scripts are included in the page.');
 24:     return null;
 25:   }
 26: 
 27:   // Initialize app if not already initialized
 28:   if (!firebase.apps.length) {
 29:     firebaseApp = firebase.initializeApp(firebaseConfig);
 30:   } else {
 31:     firebaseApp = firebase.app();
 32:   }
 33: 
 34:   firebaseAuth = firebase.auth();
 35:   console.log('[Firebase] Initialized successfully');
 36: 
 37:   return { app: firebaseApp, auth: firebaseAuth };
 38: }
 39: 
 40: // Google Sign In Hook
 41: export const GoogleSignIn = {
 42:   mounted() {
 43:     this.button = this.el;
 44:     this.originalText = this.button.innerHTML;
 45: 
 46:     // Initialize Firebase
 47:     const firebase = initFirebase();
 48:     if (!firebase) {
 49:       this.showError('Firebase SDK nao carregado');
 50:       return;
 51:     }
 52: 
 53:     this.auth = firebase.auth;
 54:     this.provider = new window.firebase.auth.GoogleAuthProvider();
 55: 
 56:     // Add scopes for user info
 57:     this.provider.addScope('email');
 58:     this.provider.addScope('profile');
 59: 
 60:     // Handle click
 61:     this.button.addEventListener('click', (e) => this.handleSignIn(e));
 62:   },
 63: 
 64:   async handleSignIn(e) {
 65:     e.preventDefault();
 66: 
 67:     if (!this.auth) {
 68:       this.showError('Firebase nao inicializado');
 69:       return;
 70:     }
 71: 
 72:     this.setLoading(true);
 73: 
 74:     try {
 75:       // Sign in with popup
 76:       const result = await this.auth.signInWithPopup(this.provider);
 77:       const user = result.user;
 78: 
 79:       console.log('[Firebase] Google sign-in successful:', user.email);
 80: 
 81:       // Get ID token
 82:       const idToken = await user.getIdToken();
 83: 
 84:       // Send token to backend
 85:       await this.sendTokenToBackend(idToken);
 86: 
 87:     } catch (error) {
 88:       console.error('[Firebase] Sign-in error:', error);
 89:       this.setLoading(false);
 90: 
 91:       // Handle specific errors
 92:       if (error.code === 'auth/popup-closed-by-user') {
 93:         // User closed popup, no need to show error
 94:         return;
 95:       } else if (error.code === 'auth/network-request-failed') {
 96:         this.showError('Erro de conexao. Verifique sua internet.');
 97:       } else if (error.code === 'auth/popup-blocked') {
 98:         this.showError('Popup bloqueado. Permita popups para este site.');
 99:       } else {
100:         this.showError('Erro ao fazer login com Google');
101:       }
102:     }
103:   },
104: 
105:   async sendTokenToBackend(idToken) {
106:     try {
107:       // Get CSRF token
108:       const csrfToken = document.querySelector("meta[name='csrf-token']")?.getAttribute("content");
109: 
110:       // Send to backend session endpoint
111:       const response = await fetch('/session/firebase', {
112:         method: 'POST',
113:         headers: {
114:           'Content-Type': 'application/json',
115:           'X-CSRF-Token': csrfToken
116:         },
117:         body: JSON.stringify({ id_token: idToken })
118:       });
119: 
120:       const data = await response.json();
121: 
122:       if (response.ok && data.redirect) {
123:         // Redirect to dashboard
124:         window.location.href = data.redirect;
125:       } else {
126:         this.setLoading(false);
127:         this.showError(data.error || 'Erro ao autenticar');
128:       }
129: 
130:     } catch (error) {
131:       console.error('[Firebase] Backend auth error:', error);
132:       this.setLoading(false);
133:       this.showError('Erro ao comunicar com o servidor');
134:     }
135:   },
136: 
137:   setLoading(loading) {
138:     if (loading) {
139:       this.button.disabled = true;
140:       this.button.innerHTML = `
141:         <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
142:           <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
143:           <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
144:         </svg>
145:         <span>Conectando...</span>
146:       `;
147:     } else {
148:       this.button.disabled = false;
149:       this.button.innerHTML = this.originalText;
150:     }
151:   },
152: 
153:   showError(message) {
154:     // Push event to LiveView to show flash message
155:     this.pushEvent('firebase_error', { message });
156:   }
157: };
158: 
159: export { initFirebase };
````

## File: assets/js/hooks/pwa.js
````javascript
  1: // PWA Hooks for LiveView
  2: 
  3: // Register service worker
  4: export function registerServiceWorker() {
  5:   if ('serviceWorker' in navigator) {
  6:     window.addEventListener('load', () => {
  7:       navigator.serviceWorker.register('/sw.js')
  8:         .then((registration) => {
  9:           console.log('[PWA] Service Worker registered:', registration.scope);
 10:         })
 11:         .catch((error) => {
 12:           console.error('[PWA] Service Worker registration failed:', error);
 13:         });
 14:     });
 15:   }
 16: }
 17: 
 18: // Install Prompt Hook - Shows install banner when PWA can be installed
 19: export const InstallPrompt = {
 20:   mounted() {
 21:     this.deferredPrompt = null;
 22: 
 23:     // Listen for the beforeinstallprompt event
 24:     window.addEventListener('beforeinstallprompt', (e) => {
 25:       e.preventDefault();
 26:       this.deferredPrompt = e;
 27:       this.showBanner();
 28:     });
 29: 
 30:     // Check if already installed
 31:     window.addEventListener('appinstalled', () => {
 32:       this.deferredPrompt = null;
 33:       this.hideBanner();
 34:       console.log('[PWA] App installed');
 35:     });
 36: 
 37:     // Check if running as standalone (already installed)
 38:     if (window.matchMedia('(display-mode: standalone)').matches) {
 39:       this.hideBanner();
 40:     }
 41:   },
 42: 
 43:   showBanner() {
 44:     this.el.classList.remove('hidden');
 45:     this.el.classList.add('flex');
 46:   },
 47: 
 48:   hideBanner() {
 49:     this.el.classList.add('hidden');
 50:     this.el.classList.remove('flex');
 51:   },
 52: 
 53:   handleEvent(event, callback) {
 54:     if (event === 'install') {
 55:       this.install();
 56:     } else if (event === 'dismiss') {
 57:       this.hideBanner();
 58:     }
 59:   },
 60: 
 61:   install() {
 62:     if (this.deferredPrompt) {
 63:       this.deferredPrompt.prompt();
 64:       this.deferredPrompt.userChoice.then((choiceResult) => {
 65:         if (choiceResult.outcome === 'accepted') {
 66:           console.log('[PWA] User accepted the install prompt');
 67:         }
 68:         this.deferredPrompt = null;
 69:       });
 70:     }
 71:   }
 72: };
 73: 
 74: // Offline Indicator Hook - Shows indicator when offline
 75: export const OfflineIndicator = {
 76:   mounted() {
 77:     this.updateStatus();
 78: 
 79:     window.addEventListener('online', () => this.updateStatus());
 80:     window.addEventListener('offline', () => this.updateStatus());
 81:   },
 82: 
 83:   updateStatus() {
 84:     if (navigator.onLine) {
 85:       this.el.classList.add('hidden');
 86:       this.pushEvent('online', {});
 87:     } else {
 88:       this.el.classList.remove('hidden');
 89:       this.pushEvent('offline', {});
 90:     }
 91:   }
 92: };
 93: 
 94: // Update Available Hook - Shows notification when new version is available
 95: export const UpdateAvailable = {
 96:   mounted() {
 97:     if ('serviceWorker' in navigator) {
 98:       navigator.serviceWorker.ready.then((registration) => {
 99:         registration.addEventListener('updatefound', () => {
100:           const newWorker = registration.installing;
101:           newWorker.addEventListener('statechange', () => {
102:             if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
103:               // New version available
104:               this.el.classList.remove('hidden');
105:             }
106:           });
107:         });
108:       });
109:     }
110:   },
111: 
112:   handleEvent(event, callback) {
113:     if (event === 'update') {
114:       window.location.reload();
115:     } else if (event === 'dismiss') {
116:       this.el.classList.add('hidden');
117:     }
118:   }
119: };
````

## File: assets/js/hooks/ui_enhancements.js
````javascript
  1: /**
  2:  * UI Enhancement Hooks for LiveView
  3:  * Micro-interactions, animated counters, drag-drop, and ripple effects
  4:  */
  5: 
  6: /**
  7:  * AnimatedCounter Hook
  8:  * Animates a number from 0 to target value with easing
  9:  */
 10: export const AnimatedCounter = {
 11:   mounted() {
 12:     this.animateCounter()
 13:     this.handleEvent("update_counter", ({ value }) => {
 14:       this.el.dataset.target = value
 15:       this.animateCounter()
 16:     })
 17:   },
 18: 
 19:   animateCounter() {
 20:     const target = parseFloat(this.el.dataset.target) || 0
 21:     const duration = parseInt(this.el.dataset.duration) || 1500
 22:     const prefix = this.el.dataset.prefix || ""
 23:     const suffix = this.el.dataset.suffix || ""
 24:     const counterEl = this.el.querySelector(".counter-value")
 25: 
 26:     if (!counterEl) return
 27: 
 28:     const isFloat = target % 1 !== 0
 29:     const decimals = isFloat ? 1 : 0
 30:     let startTime = null
 31:     const startValue = parseFloat(counterEl.textContent) || 0
 32: 
 33:     const easeOutQuart = (t) => 1 - Math.pow(1 - t, 4)
 34: 
 35:     const animate = (currentTime) => {
 36:       if (!startTime) startTime = currentTime
 37:       const elapsed = currentTime - startTime
 38:       const progress = Math.min(elapsed / duration, 1)
 39:       const easedProgress = easeOutQuart(progress)
 40: 
 41:       const currentValue = startValue + (target - startValue) * easedProgress
 42:       counterEl.textContent = currentValue.toFixed(decimals)
 43: 
 44:       if (progress < 1) {
 45:         requestAnimationFrame(animate)
 46:       }
 47:     }
 48: 
 49:     requestAnimationFrame(animate)
 50:   }
 51: }
 52: 
 53: /**
 54:  * DropZone Hook
 55:  * Enhanced drag-and-drop file upload with visual feedback
 56:  */
 57: export const DropZone = {
 58:   mounted() {
 59:     this.el.addEventListener("dragenter", this.handleDragEnter.bind(this))
 60:     this.el.addEventListener("dragleave", this.handleDragLeave.bind(this))
 61:     this.el.addEventListener("dragover", this.handleDragOver.bind(this))
 62:     this.el.addEventListener("drop", this.handleDrop.bind(this))
 63: 
 64:     // Click to open file dialog
 65:     this.el.addEventListener("click", (e) => {
 66:       if (e.target.tagName !== "INPUT") {
 67:         const input = this.el.querySelector("input[type='file']")
 68:         if (input) input.click()
 69:       }
 70:     })
 71: 
 72:     this.dragCounter = 0
 73:   },
 74: 
 75:   handleDragEnter(e) {
 76:     e.preventDefault()
 77:     e.stopPropagation()
 78:     this.dragCounter++
 79: 
 80:     if (this.dragCounter === 1) {
 81:       this.el.classList.add(
 82:         "border-teal-500",
 83:         "bg-teal-50",
 84:         "dark:bg-teal-900/20",
 85:         "scale-[1.02]"
 86:       )
 87:       this.el.classList.remove(
 88:         "border-slate-300",
 89:         "dark:border-slate-600"
 90:       )
 91:     }
 92:   },
 93: 
 94:   handleDragLeave(e) {
 95:     e.preventDefault()
 96:     e.stopPropagation()
 97:     this.dragCounter--
 98: 
 99:     if (this.dragCounter === 0) {
100:       this.resetStyles()
101:     }
102:   },
103: 
104:   handleDragOver(e) {
105:     e.preventDefault()
106:     e.stopPropagation()
107:   },
108: 
109:   handleDrop(e) {
110:     e.preventDefault()
111:     e.stopPropagation()
112:     this.dragCounter = 0
113:     this.resetStyles()
114: 
115:     // Add drop animation
116:     this.el.classList.add("animate-bounce-subtle")
117:     setTimeout(() => {
118:       this.el.classList.remove("animate-bounce-subtle")
119:     }, 500)
120:   },
121: 
122:   resetStyles() {
123:     this.el.classList.remove(
124:       "border-teal-500",
125:       "bg-teal-50",
126:       "dark:bg-teal-900/20",
127:       "scale-[1.02]"
128:     )
129:     this.el.classList.add(
130:       "border-slate-300",
131:       "dark:border-slate-600"
132:     )
133:   },
134: 
135:   destroyed() {
136:     this.el.removeEventListener("dragenter", this.handleDragEnter)
137:     this.el.removeEventListener("dragleave", this.handleDragLeave)
138:     this.el.removeEventListener("dragover", this.handleDragOver)
139:     this.el.removeEventListener("drop", this.handleDrop)
140:   }
141: }
142: 
143: /**
144:  * Ripple Hook
145:  * Material-style ripple effect on click
146:  */
147: export const Ripple = {
148:   mounted() {
149:     this.el.style.position = "relative"
150:     this.el.style.overflow = "hidden"
151: 
152:     this.el.addEventListener("click", this.createRipple.bind(this))
153:   },
154: 
155:   createRipple(e) {
156:     const button = this.el
157:     const circle = document.createElement("span")
158:     const diameter = Math.max(button.clientWidth, button.clientHeight)
159:     const radius = diameter / 2
160: 
161:     const rect = button.getBoundingClientRect()
162: 
163:     circle.style.width = circle.style.height = `${diameter}px`
164:     circle.style.left = `${e.clientX - rect.left - radius}px`
165:     circle.style.top = `${e.clientY - rect.top - radius}px`
166:     circle.classList.add("ripple")
167: 
168:     // Add ripple styles if not already in document
169:     if (!document.getElementById("ripple-styles")) {
170:       const style = document.createElement("style")
171:       style.id = "ripple-styles"
172:       style.textContent = `
173:         .ripple {
174:           position: absolute;
175:           border-radius: 50%;
176:           transform: scale(0);
177:           animation: ripple-animation 0.6s ease-out;
178:           background-color: rgba(255, 255, 255, 0.3);
179:           pointer-events: none;
180:         }
181: 
182:         @keyframes ripple-animation {
183:           to {
184:             transform: scale(4);
185:             opacity: 0;
186:           }
187:         }
188:       `
189:       document.head.appendChild(style)
190:     }
191: 
192:     const existingRipple = button.querySelector(".ripple")
193:     if (existingRipple) {
194:       existingRipple.remove()
195:     }
196: 
197:     button.appendChild(circle)
198: 
199:     // Remove ripple after animation
200:     setTimeout(() => {
201:       circle.remove()
202:     }, 600)
203:   },
204: 
205:   destroyed() {
206:     this.el.removeEventListener("click", this.createRipple)
207:   }
208: }
209: 
210: /**
211:  * TypeWriter Hook
212:  * Types text character by character
213:  */
214: export const TypeWriter = {
215:   mounted() {
216:     this.text = this.el.dataset.text || this.el.textContent
217:     this.speed = parseInt(this.el.dataset.speed) || 50
218:     this.delay = parseInt(this.el.dataset.delay) || 0
219: 
220:     this.el.textContent = ""
221: 
222:     setTimeout(() => {
223:       this.typeText()
224:     }, this.delay)
225:   },
226: 
227:   typeText() {
228:     let i = 0
229:     const type = () => {
230:       if (i < this.text.length) {
231:         this.el.textContent += this.text.charAt(i)
232:         i++
233:         setTimeout(type, this.speed)
234:       }
235:     }
236:     type()
237:   }
238: }
239: 
240: /**
241:  * IntersectionObserver Hook
242:  * Triggers animations when element enters viewport
243:  */
244: export const AnimateOnScroll = {
245:   mounted() {
246:     const animation = this.el.dataset.animation || "fade-in-up"
247:     const delay = this.el.dataset.delay || "0"
248:     const threshold = parseFloat(this.el.dataset.threshold) || 0.1
249: 
250:     // Initially hide
251:     this.el.style.opacity = "0"
252: 
253:     const observer = new IntersectionObserver((entries) => {
254:       entries.forEach(entry => {
255:         if (entry.isIntersecting) {
256:           setTimeout(() => {
257:             this.el.style.opacity = "1"
258:             this.el.classList.add(`animate-${animation}`)
259:           }, parseInt(delay))
260:           observer.unobserve(this.el)
261:         }
262:       })
263:     }, { threshold })
264: 
265:     observer.observe(this.el)
266:     this.observer = observer
267:   },
268: 
269:   destroyed() {
270:     if (this.observer) {
271:       this.observer.disconnect()
272:     }
273:   }
274: }
275: 
276: /**
277:  * Parallax Hook
278:  * Simple parallax scrolling effect
279:  */
280: export const Parallax = {
281:   mounted() {
282:     this.speed = parseFloat(this.el.dataset.speed) || 0.5
283:     this.handleScroll = this.handleScroll.bind(this)
284: 
285:     window.addEventListener("scroll", this.handleScroll, { passive: true })
286:     this.handleScroll()
287:   },
288: 
289:   handleScroll() {
290:     const scrolled = window.pageYOffset
291:     const rect = this.el.getBoundingClientRect()
292:     const offset = (rect.top + scrolled) - scrolled
293: 
294:     if (rect.top < window.innerHeight && rect.bottom > 0) {
295:       const yPos = -((scrolled - offset) * this.speed)
296:       this.el.style.transform = `translateY(${yPos}px)`
297:     }
298:   },
299: 
300:   destroyed() {
301:     window.removeEventListener("scroll", this.handleScroll)
302:   }
303: }
304: 
305: /**
306:  * ProgressiveImage Hook
307:  * Loads low-res placeholder then high-res image
308:  */
309: export const ProgressiveImage = {
310:   mounted() {
311:     const fullSrc = this.el.dataset.src
312:     const placeholder = this.el.dataset.placeholder
313: 
314:     if (placeholder) {
315:       this.el.src = placeholder
316:       this.el.classList.add("blur-sm", "scale-105")
317:     }
318: 
319:     const fullImage = new Image()
320:     fullImage.src = fullSrc
321: 
322:     fullImage.onload = () => {
323:       this.el.src = fullSrc
324:       this.el.classList.remove("blur-sm", "scale-105")
325:       this.el.classList.add("transition-all", "duration-500")
326:     }
327:   }
328: }
329: 
330: /**
331:  * CopyToClipboard Hook
332:  * Copies text to clipboard with visual feedback
333:  */
334: export const CopyToClipboard = {
335:   mounted() {
336:     this.el.addEventListener("click", this.handleCopy.bind(this))
337:   },
338: 
339:   handleCopy() {
340:     const text = this.el.dataset.copyText || this.el.textContent
341: 
342:     navigator.clipboard.writeText(text).then(() => {
343:       // Visual feedback
344:       const originalContent = this.el.innerHTML
345:       const originalTitle = this.el.title
346: 
347:       this.el.classList.add("text-emerald-500")
348:       this.el.title = "Copiado!"
349: 
350:       // Add check icon temporarily
351:       const checkIcon = document.createElement("span")
352:       checkIcon.innerHTML = "&#10003;"
353:       checkIcon.classList.add("ml-1")
354:       this.el.appendChild(checkIcon)
355: 
356:       setTimeout(() => {
357:         this.el.classList.remove("text-emerald-500")
358:         this.el.title = originalTitle
359:         checkIcon.remove()
360:       }, 2000)
361:     })
362:   },
363: 
364:   destroyed() {
365:     this.el.removeEventListener("click", this.handleCopy)
366:   }
367: }
````

## File: config/test.exs
````elixir
 1: import Config
 2: 
 3: # Configure your database
 4: config :hellen, Hellen.Repo,
 5:   username: "hellen",
 6:   password: "hellen_dev",
 7:   hostname: "localhost",
 8:   database: "hellen_test#{System.get_env("MIX_TEST_PARTITION")}",
 9:   pool: Ecto.Adapters.SQL.Sandbox,
10:   pool_size: System.schedulers_online() * 2
11: 
12: # We don't run a server during test.
13: config :hellen, HellenWeb.Endpoint,
14:   http: [ip: {127, 0, 0, 1}, port: 4002],
15:   secret_key_base: "test_secret_key_base_hellen_ai_2024",
16:   server: false
17: 
18: # Print only warnings and errors during test
19: config :logger, level: :warning
20: 
21: # Initialize plugs at runtime for faster test compilation
22: config :phoenix, :plug_init_mode, :runtime
23: 
24: # Disable Oban in tests
25: config :hellen, Oban, testing: :inline
````

## File: lib/hellen/accounts/institution.ex
````elixir
 1: defmodule Hellen.Accounts.Institution do
 2:   @moduledoc """
 3:   Schema for educational institutions with plan and settings.
 4:   """
 5:   use Ecto.Schema
 6:   import Ecto.Changeset
 7: 
 8:   @primary_key {:id, :binary_id, autogenerate: true}
 9:   @foreign_key_type :binary_id
10: 
11:   schema "institutions" do
12:     field :name, :string
13:     field :plan, :string, default: "free"
14:     field :settings, :map, default: %{}
15: 
16:     has_many :users, Hellen.Accounts.User
17: 
18:     timestamps(type: :utc_datetime)
19:   end
20: 
21:   @doc false
22:   def changeset(institution, attrs) do
23:     institution
24:     |> cast(attrs, [:name, :plan, :settings])
25:     |> validate_required([:name])
26:     |> validate_inclusion(:plan, ["free", "pro", "enterprise"])
27:   end
28: end
````

## File: lib/hellen/accounts/invitation.ex
````elixir
 1: defmodule Hellen.Accounts.Invitation do
 2:   @moduledoc """
 3:   Schema for team invitations.
 4:   Invitations allow coordinators to invite teachers to their institution.
 5:   """
 6:   use Ecto.Schema
 7:   import Ecto.Changeset
 8: 
 9:   @primary_key {:id, :binary_id, autogenerate: true}
10:   @foreign_key_type :binary_id
11: 
12:   @token_bytes 32
13:   @expires_in_days 7
14: 
15:   schema "invitations" do
16:     field :email, :string
17:     field :name, :string
18:     field :token, :string
19:     field :expires_at, :utc_datetime
20:     field :accepted_at, :utc_datetime
21:     field :revoked_at, :utc_datetime
22:     field :role, :string, default: "teacher"
23: 
24:     belongs_to :invited_by, Hellen.Accounts.User
25:     belongs_to :institution, Hellen.Accounts.Institution
26:     belongs_to :user, Hellen.Accounts.User
27: 
28:     timestamps(type: :utc_datetime)
29:   end
30: 
31:   @doc false
32:   def changeset(invitation, attrs) do
33:     invitation
34:     |> cast(attrs, [:email, :name, :role, :invited_by_id, :institution_id])
35:     |> validate_required([:email, :institution_id])
36:     |> validate_format(:email, ~r/^[^\s]+@[^\s]+$/, message: "must have @ sign and no spaces")
37:     |> validate_inclusion(:role, ["teacher", "coordinator"])
38:     |> put_token()
39:     |> put_expires_at()
40:   end
41: 
42:   @doc false
43:   def accept_changeset(invitation, attrs) do
44:     invitation
45:     |> cast(attrs, [:user_id, :accepted_at])
46:     |> validate_required([:user_id, :accepted_at])
47:   end
48: 
49:   @doc false
50:   def revoke_changeset(invitation) do
51:     invitation
52:     |> change(revoked_at: DateTime.utc_now() |> DateTime.truncate(:second))
53:   end
54: 
55:   defp put_token(changeset) do
56:     if get_field(changeset, :token) do
57:       changeset
58:     else
59:       token =
60:         :crypto.strong_rand_bytes(@token_bytes)
61:         |> Base.url_encode64(padding: false)
62: 
63:       put_change(changeset, :token, token)
64:     end
65:   end
66: 
67:   defp put_expires_at(changeset) do
68:     if get_field(changeset, :expires_at) do
69:       changeset
70:     else
71:       expires_at =
72:         DateTime.utc_now()
73:         |> DateTime.add(@expires_in_days, :day)
74:         |> DateTime.truncate(:second)
75: 
76:       put_change(changeset, :expires_at, expires_at)
77:     end
78:   end
79: 
80:   @doc """
81:   Checks if the invitation is valid (not expired, not revoked, not accepted).
82:   """
83:   def valid?(%__MODULE__{} = invitation) do
84:     now = DateTime.utc_now()
85: 
86:     is_nil(invitation.revoked_at) and
87:       is_nil(invitation.accepted_at) and
88:       DateTime.compare(invitation.expires_at, now) == :gt
89:   end
90: 
91:   @doc """
92:   Checks if the invitation is expired.
93:   """
94:   def expired?(%__MODULE__{expires_at: expires_at}) do
95:     DateTime.compare(expires_at, DateTime.utc_now()) == :lt
96:   end
97: end
````

## File: lib/hellen/ai/assessment_generator.ex
````elixir
  1: defmodule Hellen.AI.AssessmentGenerator do
  2:   @moduledoc """
  3:   AI-powered assessment (prova) generator.
  4: 
  5:   Uses NVIDIA NIM LLM to generate structured assessments from:
  6:   - Lesson plannings
  7:   - Topic descriptions
  8:   - BNCC competency codes
  9: 
 10:   Features:
 11:   - Multiple question types support
 12:   - Difficulty level customization
 13:   - BNCC alignment
 14:   - Answer key generation
 15:   - Rubric suggestions
 16:   """
 17: 
 18:   require Logger
 19: 
 20:   alias Hellen.AI.Embeddings
 21:   alias Hellen.Assessments
 22:   alias Hellen.Assessments.Assessment
 23:   alias Hellen.Plannings
 24: 
 25:   # NVIDIA NIM API
 26:   @llm_base_url "https://integrate.api.nvidia.com/v1"
 27:   @llm_model "nvidia/llama-3.1-nemotron-70b-instruct"
 28: 
 29:   # ============================================================================
 30:   # GENERATION FROM PLANNING
 31:   # ============================================================================
 32: 
 33:   @doc """
 34:   Generates an assessment from an existing lesson planning.
 35: 
 36:   ## Options
 37:     * `:assessment_type` - Type of assessment (default: "prova")
 38:     * `:difficulty_level` - Difficulty level (default: "medio")
 39:     * `:num_questions` - Number of questions (default: 10)
 40:     * `:question_types` - List of question types to include
 41:     * `:duration_minutes` - Duration in minutes
 42:   """
 43:   def from_planning(planning_id, user_id, opts \\ []) do
 44:     with {:ok, planning} <- get_planning(planning_id),
 45:          {:ok, assessment_data} <- generate_assessment_from_planning(planning, opts) do
 46:       attrs =
 47:         assessment_data
 48:         |> Map.put(:user_id, user_id)
 49:         |> Map.put(:source_planning_id, planning_id)
 50:         |> Map.put(:institution_id, planning.institution_id)
 51:         |> Map.put(:generated_by_ai, true)
 52: 
 53:       Assessments.create_ai_assessment(attrs)
 54:     end
 55:   end
 56: 
 57:   @doc """
 58:   Generates an assessment from a topic description.
 59: 
 60:   ## Options
 61:     * `:assessment_type` - Type of assessment (default: "prova")
 62:     * `:difficulty_level` - Difficulty level (default: "medio")
 63:     * `:num_questions` - Number of questions (default: 10)
 64:     * `:question_types` - List of question types to include
 65:     * `:duration_minutes` - Duration in minutes
 66:   """
 67:   def from_topic(topic, subject, grade_level, user_id, opts \\ []) do
 68:     with {:ok, bncc_matches} <- find_bncc_matches(topic),
 69:          {:ok, assessment_data} <-
 70:            generate_assessment_from_topic(topic, subject, grade_level, bncc_matches, opts) do
 71:       attrs =
 72:         assessment_data
 73:         |> Map.put(:user_id, user_id)
 74:         |> Map.put(:generated_by_ai, true)
 75: 
 76:       Assessments.create_ai_assessment(attrs)
 77:     end
 78:   end
 79: 
 80:   @doc """
 81:   Generates additional questions for an existing assessment.
 82:   """
 83:   def generate_more_questions(assessment, num_questions, opts \\ []) do
 84:     question_types = Keyword.get(opts, :question_types, ["multiple_choice"])
 85:     difficulty = Keyword.get(opts, :difficulty_level, assessment.difficulty_level)
 86: 
 87:     prompt =
 88:       build_additional_questions_prompt(assessment, num_questions, question_types, difficulty)
 89: 
 90:     case call_llm(prompt) do
 91:       {:ok, response} ->
 92:         parse_questions_response(response)
 93: 
 94:       {:error, reason} ->
 95:         {:error, reason}
 96:     end
 97:   end
 98: 
 99:   @doc """
100:   Improves an existing assessment with AI suggestions.
101:   """
102:   def improve_assessment(assessment, focus_areas \\ []) do
103:     prompt = build_improvement_prompt(assessment, focus_areas)
104: 
105:     case call_llm(prompt) do
106:       {:ok, response} ->
107:         parse_improvement_response(response)
108: 
109:       {:error, reason} ->
110:         {:error, reason}
111:     end
112:   end
113: 
114:   # ============================================================================
115:   # PRIVATE - GENERATION LOGIC
116:   # ============================================================================
117: 
118:   defp get_planning(planning_id) do
119:     try do
120:       planning = Plannings.get_planning!(planning_id)
121:       {:ok, planning}
122:     rescue
123:       Ecto.NoResultsError ->
124:         {:error, :planning_not_found}
125:     end
126:   end
127: 
128:   defp find_bncc_matches(text) do
129:     case Embeddings.match_bncc(text, limit: 5) do
130:       {:ok, matches} ->
131:         codes = Enum.map(matches, & &1.payload["code"])
132:         {:ok, codes}
133: 
134:       {:error, _reason} ->
135:         {:ok, []}
136:     end
137:   end
138: 
139:   defp generate_assessment_from_planning(planning, opts) do
140:     assessment_type = Keyword.get(opts, :assessment_type, "prova")
141:     difficulty = Keyword.get(opts, :difficulty_level, "medio")
142:     num_questions = Keyword.get(opts, :num_questions, 10)
143: 
144:     question_types =
145:       Keyword.get(opts, :question_types, ["multiple_choice", "true_false", "short_answer"])
146: 
147:     duration = Keyword.get(opts, :duration_minutes, 60)
148: 
149:     prompt = """
150:     Você é um especialista em educação brasileira. Crie uma #{assessment_type_text(assessment_type)} baseada no plano de aula abaixo.
151: 
152:     PLANO DE AULA:
153:     Título: #{planning.title}
154:     Descrição: #{planning.description || ""}
155:     Disciplina: #{planning.subject}
156:     Ano/Série: #{planning.grade_level}
157:     Objetivos: #{Enum.join(planning.objectives || [], "; ")}
158:     Códigos BNCC: #{Enum.join(planning.bncc_codes || [], ", ")}
159:     Metodologia: #{planning.methodology || ""}
160: 
161:     CONFIGURAÇÕES DA AVALIAÇÃO:
162:     - Tipo: #{assessment_type_text(assessment_type)}
163:     - Nível de dificuldade: #{difficulty_text(difficulty)}
164:     - Número de questões: #{num_questions}
165:     - Tipos de questões permitidos: #{Enum.join(question_types, ", ")}
166:     - Duração: #{duration} minutos
167: 
168:     #{question_type_instructions()}
169: 
170:     Gere um JSON com a seguinte estrutura (responda APENAS com o JSON, sem texto adicional):
171:     #{assessment_json_template()}
172:     """
173: 
174:     case call_llm(prompt) do
175:       {:ok, response} ->
176:         parse_assessment_response(
177:           response,
178:           planning.subject,
179:           planning.grade_level,
180:           assessment_type,
181:           difficulty,
182:           duration
183:         )
184: 
185:       {:error, reason} ->
186:         {:error, reason}
187:     end
188:   end
189: 
190:   defp generate_assessment_from_topic(topic, subject, grade_level, bncc_codes, opts) do
191:     assessment_type = Keyword.get(opts, :assessment_type, "prova")
192:     difficulty = Keyword.get(opts, :difficulty_level, "medio")
193:     num_questions = Keyword.get(opts, :num_questions, 10)
194: 
195:     question_types =
196:       Keyword.get(opts, :question_types, ["multiple_choice", "true_false", "short_answer"])
197: 
198:     duration = Keyword.get(opts, :duration_minutes, 60)
199: 
200:     prompt = """
201:     Você é um especialista em educação brasileira. Crie uma #{assessment_type_text(assessment_type)} sobre o tema especificado.
202: 
203:     TEMA: #{topic}
204: 
205:     INFORMAÇÕES:
206:     - Disciplina: #{subject}
207:     - Ano/Série: #{grade_level}
208:     - Códigos BNCC sugeridos: #{Enum.join(bncc_codes, ", ")}
209: 
210:     CONFIGURAÇÕES DA AVALIAÇÃO:
211:     - Tipo: #{assessment_type_text(assessment_type)}
212:     - Nível de dificuldade: #{difficulty_text(difficulty)}
213:     - Número de questões: #{num_questions}
214:     - Tipos de questões permitidos: #{Enum.join(question_types, ", ")}
215:     - Duração: #{duration} minutos
216: 
217:     #{question_type_instructions()}
218: 
219:     Gere um JSON com a seguinte estrutura (responda APENAS com o JSON, sem texto adicional):
220:     #{assessment_json_template()}
221:     """
222: 
223:     case call_llm(prompt) do
224:       {:ok, response} ->
225:         parse_assessment_response(
226:           response,
227:           subject,
228:           grade_level,
229:           assessment_type,
230:           difficulty,
231:           duration
232:         )
233: 
234:       {:error, reason} ->
235:         {:error, reason}
236:     end
237:   end
238: 
239:   defp build_additional_questions_prompt(assessment, num_questions, question_types, difficulty) do
240:     existing_questions =
241:       (assessment.questions || [])
242:       |> Enum.map_join("\n- ", fn q -> q["text"] end)
243: 
244:     """
245:     Você é um especialista em educação brasileira. Gere #{num_questions} questões adicionais para esta avaliação.
246: 
247:     AVALIAÇÃO EXISTENTE:
248:     Título: #{assessment.title}
249:     Disciplina: #{assessment.subject}
250:     Ano/Série: #{assessment.grade_level}
251:     Tipo: #{assessment.assessment_type}
252: 
253:     QUESTÕES JÁ EXISTENTES (não repita):
254:     - #{existing_questions}
255: 
256:     CONFIGURAÇÕES:
257:     - Nível de dificuldade: #{difficulty_text(difficulty)}
258:     - Tipos de questões: #{Enum.join(question_types, ", ")}
259: 
260:     #{question_type_instructions()}
261: 
262:     Gere um JSON com a seguinte estrutura:
263:     {
264:       "questions": [
265:         // Array de questões no formato especificado acima
266:       ]
267:     }
268:     """
269:   end
270: 
271:   defp build_improvement_prompt(assessment, focus_areas) do
272:     focus_text =
273:       if Enum.empty?(focus_areas) do
274:         "clareza das questões, equilíbrio de dificuldade, alinhamento BNCC"
275:       else
276:         Enum.join(focus_areas, ", ")
277:       end
278: 
279:     questions_preview =
280:       (assessment.questions || [])
281:       |> Enum.take(5)
282:       |> Enum.map_join("\n", fn q ->
283:         "#{q["type"]}: #{String.slice(q["text"] || "", 0, 100)}..."
284:       end)
285: 
286:     """
287:     Você é um especialista em educação brasileira. Analise esta avaliação e sugira melhorias.
288: 
289:     AVALIAÇÃO:
290:     Título: #{assessment.title}
291:     Disciplina: #{assessment.subject}
292:     Ano/Série: #{assessment.grade_level}
293:     Tipo: #{assessment.assessment_type}
294:     Dificuldade: #{assessment.difficulty_level}
295:     Número de questões: #{length(assessment.questions || [])}
296: 
297:     AMOSTRA DE QUESTÕES:
298:     #{questions_preview}
299: 
300:     FOCO DAS MELHORIAS: #{focus_text}
301: 
302:     Responda em JSON com sugestões específicas:
303:     {
304:       "suggestions": [
305:         {"area": "Questões", "issue": "...", "improvement": "...", "priority": "alta|media|baixa"},
306:         {"area": "Dificuldade", "issue": "...", "improvement": "...", "priority": "alta|media|baixa"}
307:       ],
308:       "question_improvements": [
309:         {"question_index": 0, "current": "...", "improved": "...", "reason": "..."}
310:       ],
311:       "additional_recommendations": ["Recomendação 1", "Recomendação 2"]
312:     }
313:     """
314:   end
315: 
316:   defp question_type_instructions do
317:     """
318:     FORMATOS DE QUESTÕES:
319: 
320:     1. multiple_choice (Múltipla Escolha):
321:     {
322:       "type": "multiple_choice",
323:       "text": "Texto da pergunta",
324:       "options": ["A) Opção 1", "B) Opção 2", "C) Opção 3", "D) Opção 4"],
325:       "correct_answer": "A",
326:       "points": 1,
327:       "difficulty": "facil|medio|dificil",
328:       "explanation": "Explicação da resposta correta"
329:     }
330: 
331:     2. true_false (Verdadeiro/Falso):
332:     {
333:       "type": "true_false",
334:       "text": "Afirmação para avaliar",
335:       "correct_answer": true,
336:       "points": 1,
337:       "difficulty": "facil|medio|dificil",
338:       "explanation": "Explicação"
339:     }
340: 
341:     3. short_answer (Resposta Curta):
342:     {
343:       "type": "short_answer",
344:       "text": "Pergunta que requer resposta breve",
345:       "expected_answer": "Resposta esperada",
346:       "points": 2,
347:       "difficulty": "medio",
348:       "keywords": ["palavra-chave1", "palavra-chave2"]
349:     }
350: 
351:     4. essay (Dissertativa):
352:     {
353:       "type": "essay",
354:       "text": "Questão dissertativa",
355:       "points": 5,
356:       "difficulty": "dificil",
357:       "rubric": {
358:         "criteria": ["Critério 1", "Critério 2"],
359:         "max_words": 200
360:       }
361:     }
362: 
363:     5. fill_blank (Preencher Lacunas):
364:     {
365:       "type": "fill_blank",
366:       "text": "Texto com _____ para preencher",
367:       "blanks": ["resposta1", "resposta2"],
368:       "points": 1,
369:       "difficulty": "facil"
370:     }
371: 
372:     6. matching (Associação):
373:     {
374:       "type": "matching",
375:       "text": "Associe as colunas:",
376:       "left_column": ["Item A", "Item B", "Item C"],
377:       "right_column": ["Definição 1", "Definição 2", "Definição 3"],
378:       "correct_matches": {"0": "1", "1": "0", "2": "2"},
379:       "points": 3,
380:       "difficulty": "medio"
381:     }
382:     """
383:   end
384: 
385:   defp assessment_json_template do
386:     """
387:     {
388:       "title": "Título da Avaliação",
389:       "description": "Breve descrição do que será avaliado",
390:       "instructions": "Instruções para os alunos",
391:       "bncc_codes": ["Código BNCC 1", "Código BNCC 2"],
392:       "questions": [
393:         // Array de questões seguindo os formatos acima
394:       ],
395:       "answer_key": {
396:         "0": "resposta_questao_0",
397:         "1": "resposta_questao_1"
398:       },
399:       "rubrics": {
400:         "general": "Critérios gerais de avaliação",
401:         "partial_credit": "Regras para crédito parcial"
402:       }
403:     }
404:     """
405:   end
406: 
407:   defp assessment_type_text("prova"), do: "prova"
408:   defp assessment_type_text("atividade"), do: "atividade avaliativa"
409:   defp assessment_type_text("simulado"), do: "simulado"
410:   defp assessment_type_text("exercicio"), do: "lista de exercícios"
411:   defp assessment_type_text("trabalho"), do: "trabalho"
412:   defp assessment_type_text("quiz"), do: "quiz rápido"
413:   defp assessment_type_text(_), do: "avaliação"
414: 
415:   defp difficulty_text("facil"), do: "Fácil (questões diretas e básicas)"
416:   defp difficulty_text("medio"), do: "Médio (equilíbrio entre básico e desafiador)"
417:   defp difficulty_text("dificil"), do: "Difícil (questões que exigem análise e síntese)"
418:   defp difficulty_text("misto"), do: "Misto (progressão de fácil a difícil)"
419:   defp difficulty_text(_), do: "Médio"
420: 
421:   # ============================================================================
422:   # LLM INTEGRATION
423:   # ============================================================================
424: 
425:   defp call_llm(prompt) do
426:     start_time = System.monotonic_time(:millisecond)
427: 
428:     result =
429:       Req.post("#{@llm_base_url}/chat/completions",
430:         json: %{
431:           model: @llm_model,
432:           messages: [
433:             %{
434:               role: "system",
435:               content:
436:                 "Você é um assistente especializado em educação brasileira. Crie avaliações pedagogicamente adequadas. Responda sempre em português e em formato JSON quando solicitado."
437:             },
438:             %{role: "user", content: prompt}
439:           ],
440:           max_tokens: 8000,
441:           temperature: 0.7
442:         },
443:         headers: auth_headers(),
444:         receive_timeout: 180_000
445:       )
446: 
447:     case result do
448:       {:ok, %{status: 200, body: body}} ->
449:         content = get_in(body, ["choices", Access.at(0), "message", "content"])
450:         processing_time = System.monotonic_time(:millisecond) - start_time
451:         Logger.info("Assessment LLM call completed in #{processing_time}ms")
452:         {:ok, content}
453: 
454:       {:ok, %{status: status, body: body}} ->
455:         Logger.error("Assessment LLM error #{status}: #{inspect(body)}")
456:         {:error, %{status: status, message: body["error"] || "Unknown error"}}
457: 
458:       {:error, reason} ->
459:         Logger.error("Assessment LLM request failed: #{inspect(reason)}")
460:         {:error, reason}
461:     end
462:   end
463: 
464:   defp auth_headers do
465:     api_key = Application.get_env(:hellen, :nvidia_api_key)
466: 
467:     [
468:       {"Authorization", "Bearer #{api_key}"},
469:       {"Content-Type", "application/json"}
470:     ]
471:   end
472: 
473:   # ============================================================================
474:   # RESPONSE PARSING
475:   # ============================================================================
476: 
477:   defp parse_assessment_response(
478:          response,
479:          subject,
480:          grade_level,
481:          assessment_type,
482:          difficulty,
483:          duration
484:        ) do
485:     json_str =
486:       response
487:       |> String.trim()
488:       |> extract_json()
489: 
490:     case Jason.decode(json_str) do
491:       {:ok, data} ->
492:         assessment_attrs = %{
493:           title: data["title"] || "Avaliação",
494:           description: data["description"],
495:           subject: normalize_subject(subject),
496:           grade_level: normalize_grade_level(grade_level),
497:           assessment_type: assessment_type,
498:           difficulty_level: difficulty,
499:           duration_minutes: duration,
500:           instructions: data["instructions"],
501:           bncc_codes: data["bncc_codes"] || [],
502:           questions: data["questions"] || [],
503:           answer_key: data["answer_key"] || %{},
504:           rubrics: data["rubrics"] || %{},
505:           total_points: calculate_total_points(data["questions"] || [])
506:         }
507: 
508:         {:ok, assessment_attrs}
509: 
510:       {:error, _} ->
511:         Logger.warning("Failed to parse assessment JSON: #{String.slice(json_str, 0, 200)}")
512:         {:error, :invalid_json_response}
513:     end
514:   end
515: 
516:   defp parse_questions_response(response) do
517:     json_str = extract_json(response)
518: 
519:     case Jason.decode(json_str) do
520:       {:ok, %{"questions" => questions}} -> {:ok, questions}
521:       {:ok, _} -> {:error, :invalid_response_format}
522:       {:error, _} -> {:error, :invalid_json_response}
523:     end
524:   end
525: 
526:   defp parse_improvement_response(response) do
527:     json_str = extract_json(response)
528: 
529:     case Jason.decode(json_str) do
530:       {:ok, data} -> {:ok, data}
531:       {:error, _} -> {:error, :invalid_json_response}
532:     end
533:   end
534: 
535:   defp extract_json(text) do
536:     case Regex.run(~r/```(?:json)?\s*\n?([\s\S]*?)\n?```/, text) do
537:       [_, json] -> String.trim(json)
538:       nil -> String.trim(text)
539:     end
540:   end
541: 
542:   defp calculate_total_points(questions) do
543:     questions
544:     |> Enum.map(fn q -> Decimal.new(to_string(q["points"] || "1")) end)
545:     |> Enum.reduce(Decimal.new("0"), &Decimal.add/2)
546:   end
547: 
548:   defp normalize_subject(subject) do
549:     subject
550:     |> String.downcase()
551:     |> String.replace(~r/[áàãâä]/, "a")
552:     |> String.replace(~r/[éèêë]/, "e")
553:     |> String.replace(~r/[íìîï]/, "i")
554:     |> String.replace(~r/[óòõôö]/, "o")
555:     |> String.replace(~r/[úùûü]/, "u")
556:     |> String.replace(~r/ç/, "c")
557:     |> String.replace(~r/\s+/, "_")
558:     |> then(fn s ->
559:       if s in Assessment.subjects(), do: s, else: "portugues"
560:     end)
561:   end
562: 
563:   defp normalize_grade_level(level) do
564:     level
565:     |> String.downcase()
566:     |> String.replace(~r/º\s*/, "_")
567:     |> String.replace(~r/\s+/, "_")
568:     |> then(fn s ->
569:       if s in Assessment.grade_levels(), do: s, else: "5_ano"
570:     end)
571:   end
572: end
````

## File: lib/hellen/ai/audio_extractor.ex
````elixir
  1: defmodule Hellen.AI.AudioExtractor do
  2:   @moduledoc """
  3:   Optimized audio extraction from video files using FFmpeg.
  4: 
  5:   Uses stream copy when possible (10x faster, no quality loss),
  6:   falls back to re-encoding only when necessary.
  7:   """
  8: 
  9:   require Logger
 10: 
 11:   @video_extensions ~w(.mp4 .mkv .avi .mov .webm .flv .wmv .m4v)
 12:   @audio_extensions ~w(.mp3 .wav .m4a .aac .ogg .flac .opus)
 13: 
 14:   # Codecs that Groq Whisper API accepts natively
 15:   @groq_compatible_codecs ~w(aac mp3 opus flac vorbis pcm_s16le pcm_s24le)
 16: 
 17:   @doc """
 18:   Processes a media file for transcription.
 19: 
 20:   If it's a video file, extracts audio using the fastest method available.
 21:   If it's already audio, returns it directly (or converts if needed).
 22: 
 23:   Returns {:ok, audio_binary, content_type} or {:error, reason}
 24:   """
 25:   def process_for_transcription(file_binary, original_filename) do
 26:     ext = Path.extname(original_filename) |> String.downcase()
 27: 
 28:     cond do
 29:       ext in @audio_extensions ->
 30:         # Already audio - return as-is (Groq handles most formats)
 31:         Logger.info("File is already audio (#{ext}), skipping extraction")
 32:         {:ok, file_binary, guess_content_type(ext)}
 33: 
 34:       ext in @video_extensions ->
 35:         # Video file - extract audio
 36:         Logger.info("Video file detected (#{ext}), extracting audio...")
 37:         extract_audio_from_video(file_binary, ext)
 38: 
 39:       true ->
 40:         Logger.warning("Unknown file extension: #{ext}, attempting as video")
 41:         extract_audio_from_video(file_binary, ext)
 42:     end
 43:   end
 44: 
 45:   @doc """
 46:   Extracts audio from video binary using FFmpeg.
 47: 
 48:   Strategy:
 49:   1. Probe the video to detect audio codec
 50:   2. If codec is Groq-compatible, use stream copy (ultra-fast)
 51:   3. Otherwise, re-encode to MP3 (slower but compatible)
 52:   """
 53:   def extract_audio_from_video(video_binary, ext \\ ".mp4") do
 54:     # Create temp files
 55:     temp_dir = System.tmp_dir!()
 56:     input_path = Path.join(temp_dir, "input_#{:erlang.unique_integer([:positive])}#{ext}")
 57: 
 58:     try do
 59:       # Write video to temp file
 60:       File.write!(input_path, video_binary)
 61: 
 62:       # Detect audio codec
 63:       case detect_audio_codec(input_path) do
 64:         {:ok, codec} ->
 65:           Logger.info("Detected audio codec: #{codec}")
 66:           extract_with_strategy(input_path, codec)
 67: 
 68:         {:error, reason} ->
 69:           Logger.error("Failed to detect codec: #{inspect(reason)}")
 70:           {:error, :codec_detection_failed}
 71:       end
 72:     after
 73:       # Cleanup input file
 74:       File.rm(input_path)
 75:     end
 76:   end
 77: 
 78:   @doc """
 79:   Detects the audio codec of a video file using ffprobe.
 80:   """
 81:   def detect_audio_codec(file_path) do
 82:     args = [
 83:       "-v",
 84:       "quiet",
 85:       "-select_streams",
 86:       "a:0",
 87:       "-show_entries",
 88:       "stream=codec_name",
 89:       "-of",
 90:       "csv=p=0",
 91:       file_path
 92:     ]
 93: 
 94:     case System.cmd("ffprobe", args, stderr_to_stdout: true) do
 95:       {output, 0} ->
 96:         codec = output |> String.trim() |> String.downcase()
 97:         if codec == "", do: {:error, :no_audio_stream}, else: {:ok, codec}
 98: 
 99:       {error, _} ->
100:         {:error, {:ffprobe_failed, error}}
101:     end
102:   end
103: 
104:   # Choose extraction strategy based on codec
105:   defp extract_with_strategy(input_path, codec) do
106:     if codec in @groq_compatible_codecs do
107:       # Stream copy - 10x faster, no quality loss
108:       Logger.info("Using STREAM COPY (fast path) for codec: #{codec}")
109:       extract_with_stream_copy(input_path, codec)
110:     else
111:       # Re-encode to MP3 - slower but guaranteed compatible
112:       Logger.info("Using RE-ENCODE (slow path) for codec: #{codec}")
113:       extract_with_reencode(input_path)
114:     end
115:   end
116: 
117:   @doc """
118:   Extracts audio using stream copy (no re-encoding).
119:   This is ~10x faster and preserves original quality.
120:   """
121:   def extract_with_stream_copy(input_path, codec) do
122:     temp_dir = System.tmp_dir!()
123:     output_ext = codec_to_extension(codec)
124: 
125:     output_path =
126:       Path.join(temp_dir, "audio_#{:erlang.unique_integer([:positive])}.#{output_ext}")
127: 
128:     args = [
129:       "-i",
130:       input_path,
131:       # No video
132:       "-vn",
133:       # Stream copy (no re-encoding)
134:       "-acodec",
135:       "copy",
136:       # Overwrite
137:       "-y",
138:       output_path
139:     ]
140: 
141:     start_time = System.monotonic_time(:millisecond)
142: 
143:     try do
144:       case System.cmd("ffmpeg", args, stderr_to_stdout: true) do
145:         {_output, 0} ->
146:           elapsed = System.monotonic_time(:millisecond) - start_time
147:           audio_binary = File.read!(output_path)
148:           audio_size = byte_size(audio_binary)
149: 
150:           Logger.info(
151:             "Stream copy extraction completed in #{elapsed}ms, output size: #{format_bytes(audio_size)}"
152:           )
153: 
154:           content_type = extension_to_content_type(output_ext)
155:           {:ok, audio_binary, content_type}
156: 
157:         {error, code} ->
158:           Logger.error("FFmpeg stream copy failed (code #{code}): #{String.slice(error, 0, 500)}")
159:           # Fallback to re-encode
160:           Logger.info("Falling back to re-encode...")
161:           extract_with_reencode(input_path)
162:       end
163:     after
164:       File.rm(output_path)
165:     end
166:   end
167: 
168:   @doc """
169:   Extracts and re-encodes audio to MP3.
170:   Slower but guaranteed to work with any input.
171:   """
172:   def extract_with_reencode(input_path) do
173:     temp_dir = System.tmp_dir!()
174:     output_path = Path.join(temp_dir, "audio_#{:erlang.unique_integer([:positive])}.mp3")
175: 
176:     args = [
177:       "-i",
178:       input_path,
179:       # No video
180:       "-vn",
181:       # MP3 encoder
182:       "-acodec",
183:       "libmp3lame",
184:       # 128kbps (good balance for speech)
185:       "-b:a",
186:       "128k",
187:       # 16kHz (optimal for ASR)
188:       "-ar",
189:       "16000",
190:       # Mono (ASR doesn't need stereo)
191:       "-ac",
192:       "1",
193:       # Use all CPU cores
194:       "-threads",
195:       "0",
196:       # Overwrite
197:       "-y",
198:       output_path
199:     ]
200: 
201:     start_time = System.monotonic_time(:millisecond)
202: 
203:     try do
204:       case System.cmd("ffmpeg", args, stderr_to_stdout: true) do
205:         {_output, 0} ->
206:           elapsed = System.monotonic_time(:millisecond) - start_time
207:           audio_binary = File.read!(output_path)
208:           audio_size = byte_size(audio_binary)
209: 
210:           Logger.info(
211:             "Re-encode extraction completed in #{elapsed}ms, output size: #{format_bytes(audio_size)}"
212:           )
213: 
214:           {:ok, audio_binary, "audio/mpeg"}
215: 
216:         {error, code} ->
217:           Logger.error("FFmpeg re-encode failed (code #{code}): #{String.slice(error, 0, 500)}")
218:           {:error, :ffmpeg_failed}
219:       end
220:     after
221:       File.rm(output_path)
222:     end
223:   end
224: 
225:   @doc """
226:   Gets file info using ffprobe.
227:   """
228:   def get_media_info(file_path) do
229:     args = [
230:       "-v",
231:       "quiet",
232:       "-print_format",
233:       "json",
234:       "-show_format",
235:       "-show_streams",
236:       file_path
237:     ]
238: 
239:     case System.cmd("ffprobe", args, stderr_to_stdout: true) do
240:       {output, 0} ->
241:         case Jason.decode(output) do
242:           {:ok, info} -> {:ok, info}
243:           {:error, _} -> {:error, :json_parse_failed}
244:         end
245: 
246:       {error, _} ->
247:         {:error, {:ffprobe_failed, error}}
248:     end
249:   end
250: 
251:   # Helpers
252: 
253:   defp codec_to_extension("aac"), do: "aac"
254:   defp codec_to_extension("mp3"), do: "mp3"
255:   defp codec_to_extension("opus"), do: "opus"
256:   defp codec_to_extension("flac"), do: "flac"
257:   defp codec_to_extension("vorbis"), do: "ogg"
258:   defp codec_to_extension("pcm_s16le"), do: "wav"
259:   defp codec_to_extension("pcm_s24le"), do: "wav"
260:   defp codec_to_extension(_), do: "mp3"
261: 
262:   defp extension_to_content_type("aac"), do: "audio/aac"
263:   defp extension_to_content_type("m4a"), do: "audio/mp4"
264:   defp extension_to_content_type("mp3"), do: "audio/mpeg"
265:   defp extension_to_content_type("opus"), do: "audio/opus"
266:   defp extension_to_content_type("flac"), do: "audio/flac"
267:   defp extension_to_content_type("ogg"), do: "audio/ogg"
268:   defp extension_to_content_type("wav"), do: "audio/wav"
269:   defp extension_to_content_type(_), do: "audio/mpeg"
270: 
271:   defp guess_content_type(".mp3"), do: "audio/mpeg"
272:   defp guess_content_type(".wav"), do: "audio/wav"
273:   defp guess_content_type(".m4a"), do: "audio/mp4"
274:   defp guess_content_type(".aac"), do: "audio/aac"
275:   defp guess_content_type(".ogg"), do: "audio/ogg"
276:   defp guess_content_type(".flac"), do: "audio/flac"
277:   defp guess_content_type(".opus"), do: "audio/opus"
278:   defp guess_content_type(_), do: "audio/mpeg"
279: 
280:   defp format_bytes(bytes) when bytes < 1024, do: "#{bytes} B"
281:   defp format_bytes(bytes) when bytes < 1_048_576, do: "#{Float.round(bytes / 1024, 1)} KB"
282:   defp format_bytes(bytes), do: "#{Float.round(bytes / 1_048_576, 1)} MB"
283: end
````

## File: lib/hellen/ai/client_behaviour.ex
````elixir
 1: defmodule Hellen.AI.ClientBehaviour do
 2:   @moduledoc """
 3:   Behaviour for AI client implementations.
 4:   Allows mocking AI services in tests.
 5:   """
 6: 
 7:   @doc "Transcribe audio to text"
 8:   @callback transcribe(audio_url :: String.t(), opts :: keyword()) ::
 9:               {:ok, map()} | {:error, term()}
10: 
11:   @doc "Analyze transcription for pedagogical insights"
12:   @callback analyze_pedagogy(transcription :: String.t(), opts :: keyword()) ::
13:               {:ok, map()} | {:error, term()}
14: end
````

## File: lib/hellen/ai/embeddings.ex
````elixir
  1: defmodule Hellen.AI.Embeddings do
  2:   @moduledoc """
  3:   Service for generating text embeddings using NVIDIA NIM API.
  4: 
  5:   Uses NV-Embed-v2 model which produces 1024-dimensional vectors
  6:   optimized for semantic search and similarity tasks.
  7: 
  8:   Features:
  9:   - Single and batch embedding generation
 10:   - Text chunking for long documents
 11:   - Caching with Redis (optional)
 12:   - Automatic retry with exponential backoff
 13:   """
 14: 
 15:   require Logger
 16: 
 17:   alias Hellen.AI.QdrantClient
 18: 
 19:   # NVIDIA NIM Embedding API
 20:   @embedding_base_url "https://integrate.api.nvidia.com/v1"
 21:   @embedding_model "nvidia/nv-embedqa-e5-v5"
 22:   @embedding_dimensions 1024
 23: 
 24:   # Text chunking settings
 25:   @default_chunk_size 500
 26:   @default_chunk_overlap 50
 27: 
 28:   # Collections
 29:   @lessons_collection "lessons"
 30:   @bncc_collection "bncc_competencies"
 31: 
 32:   # ============================================================================
 33:   # EMBEDDING GENERATION
 34:   # ============================================================================
 35: 
 36:   @doc """
 37:   Generates an embedding vector for a single text.
 38: 
 39:   ## Examples
 40: 
 41:       {:ok, %{embedding: vector, tokens: 42}} = Embeddings.generate("Hello world")
 42:   """
 43:   @spec generate(String.t(), keyword()) :: {:ok, map()} | {:error, term()}
 44:   def generate(text, opts \\ []) when is_binary(text) do
 45:     input_type = Keyword.get(opts, :input_type, "query")
 46:     truncate = Keyword.get(opts, :truncate, "END")
 47: 
 48:     start_time = System.monotonic_time(:millisecond)
 49: 
 50:     result =
 51:       Req.post("#{@embedding_base_url}/embeddings",
 52:         json: %{
 53:           model: @embedding_model,
 54:           input: [text],
 55:           input_type: input_type,
 56:           truncate: truncate
 57:         },
 58:         headers: auth_headers(),
 59:         receive_timeout: 30_000
 60:       )
 61: 
 62:     case result do
 63:       {:ok, %{status: 200, body: body}} ->
 64:         embedding = get_in(body, ["data", Access.at(0), "embedding"])
 65:         tokens = get_in(body, ["usage", "total_tokens"]) || 0
 66:         processing_time = System.monotonic_time(:millisecond) - start_time
 67: 
 68:         Logger.debug("Generated embedding in #{processing_time}ms (#{tokens} tokens)")
 69: 
 70:         {:ok,
 71:          %{
 72:            embedding: embedding,
 73:            tokens: tokens,
 74:            dimensions: length(embedding),
 75:            processing_time_ms: processing_time
 76:          }}
 77: 
 78:       {:ok, %{status: status, body: body}} ->
 79:         Logger.error("Embedding API error #{status}: #{inspect(body)}")
 80:         {:error, %{status: status, message: body["error"] || "Unknown error"}}
 81: 
 82:       {:error, reason} ->
 83:         Logger.error("Embedding request failed: #{inspect(reason)}")
 84:         {:error, reason}
 85:     end
 86:   end
 87: 
 88:   @doc """
 89:   Generates embeddings for multiple texts in a single batch request.
 90:   More efficient than calling generate/1 multiple times.
 91: 
 92:   ## Examples
 93: 
 94:       {:ok, embeddings} = Embeddings.generate_batch(["text1", "text2", "text3"])
 95:   """
 96:   @spec generate_batch(list(String.t()), keyword()) :: {:ok, list(map())} | {:error, term()}
 97:   def generate_batch(texts, opts \\ []) when is_list(texts) do
 98:     input_type = Keyword.get(opts, :input_type, "passage")
 99:     truncate = Keyword.get(opts, :truncate, "END")
100: 
101:     start_time = System.monotonic_time(:millisecond)
102: 
103:     result =
104:       Req.post("#{@embedding_base_url}/embeddings",
105:         json: %{
106:           model: @embedding_model,
107:           input: texts,
108:           input_type: input_type,
109:           truncate: truncate
110:         },
111:         headers: auth_headers(),
112:         receive_timeout: 60_000
113:       )
114: 
115:     case result do
116:       {:ok, %{status: 200, body: body}} ->
117:         embeddings =
118:           body["data"]
119:           |> Enum.sort_by(& &1["index"])
120:           |> Enum.map(& &1["embedding"])
121: 
122:         tokens = get_in(body, ["usage", "total_tokens"]) || 0
123:         processing_time = System.monotonic_time(:millisecond) - start_time
124: 
125:         Logger.info(
126:           "Generated #{length(embeddings)} embeddings in #{processing_time}ms (#{tokens} tokens)"
127:         )
128: 
129:         {:ok,
130:          %{
131:            embeddings: embeddings,
132:            count: length(embeddings),
133:            tokens: tokens,
134:            processing_time_ms: processing_time
135:          }}
136: 
137:       {:ok, %{status: status, body: body}} ->
138:         {:error, %{status: status, message: body["error"] || "Unknown error"}}
139: 
140:       {:error, reason} ->
141:         {:error, reason}
142:     end
143:   end
144: 
145:   # ============================================================================
146:   # TEXT CHUNKING
147:   # ============================================================================
148: 
149:   @doc """
150:   Splits text into chunks suitable for embedding.
151:   Uses sentence-aware chunking to avoid cutting mid-sentence.
152: 
153:   ## Options
154:   - :chunk_size - Target chunk size in characters (default: 500)
155:   - :overlap - Overlap between chunks (default: 50)
156: 
157:   ## Examples
158: 
159:       chunks = Embeddings.chunk_text(long_text, chunk_size: 1000)
160:   """
161:   @spec chunk_text(String.t(), keyword()) :: list(map())
162:   def chunk_text(text, opts \\ []) when is_binary(text) do
163:     chunk_size = Keyword.get(opts, :chunk_size, @default_chunk_size)
164:     overlap = Keyword.get(opts, :overlap, @default_chunk_overlap)
165: 
166:     # Split by sentences first
167:     sentences =
168:       text
169:       |> String.split(~r/(?<=[.!?])\s+/)
170:       |> Enum.filter(&(String.trim(&1) != ""))
171: 
172:     # Build chunks from sentences
173:     build_chunks(sentences, chunk_size, overlap)
174:   end
175: 
176:   defp build_chunks(sentences, chunk_size, overlap) do
177:     build_chunks(sentences, chunk_size, overlap, [], "", 0)
178:   end
179: 
180:   defp build_chunks([], _chunk_size, _overlap, chunks, current_chunk, _start_idx)
181:        when current_chunk != "" do
182:     chunks ++ [%{text: String.trim(current_chunk), index: length(chunks)}]
183:   end
184: 
185:   defp build_chunks([], _chunk_size, _overlap, chunks, _current_chunk, _start_idx), do: chunks
186: 
187:   defp build_chunks([sentence | rest], chunk_size, overlap, chunks, current_chunk, start_idx) do
188:     potential_chunk = if current_chunk == "", do: sentence, else: current_chunk <> " " <> sentence
189: 
190:     if String.length(potential_chunk) > chunk_size and current_chunk != "" do
191:       # Save current chunk and start new one with overlap
192:       new_chunk = %{text: String.trim(current_chunk), index: length(chunks)}
193:       overlap_text = get_overlap_text(current_chunk, overlap)
194:       new_current = overlap_text <> " " <> sentence
195: 
196:       build_chunks(rest, chunk_size, overlap, chunks ++ [new_chunk], new_current, start_idx)
197:     else
198:       build_chunks(rest, chunk_size, overlap, chunks, potential_chunk, start_idx)
199:     end
200:   end
201: 
202:   defp get_overlap_text(text, overlap_chars) do
203:     if String.length(text) > overlap_chars do
204:       String.slice(text, -overlap_chars, overlap_chars)
205:     else
206:       text
207:     end
208:   end
209: 
210:   # ============================================================================
211:   # LESSON INDEXING
212:   # ============================================================================
213: 
214:   @doc """
215:   Indexes a lesson transcription into Qdrant for semantic search.
216:   Chunks the transcription and stores with metadata.
217: 
218:   ## Examples
219: 
220:       {:ok, count} = Embeddings.index_lesson(lesson_id, transcription, %{
221:         subject: "Matematica",
222:         grade_level: "5o ano"
223:       })
224:   """
225:   @spec index_lesson(String.t(), String.t(), map()) :: {:ok, integer()} | {:error, term()}
226:   def index_lesson(lesson_id, transcription, metadata \\ %{}) do
227:     # Ensure collection exists
228:     :ok = QdrantClient.ensure_collection(@lessons_collection, :nv_embed)
229: 
230:     # Chunk the transcription
231:     chunks = chunk_text(transcription)
232: 
233:     if Enum.empty?(chunks) do
234:       Logger.warning("No chunks generated for lesson #{lesson_id}")
235:       {:ok, 0}
236:     else
237:       # Generate embeddings for all chunks
238:       texts = Enum.map(chunks, & &1.text)
239: 
240:       case generate_batch(texts, input_type: "passage") do
241:         {:ok, %{embeddings: embeddings}} ->
242:           # Build points for Qdrant
243:           points =
244:             chunks
245:             |> Enum.zip(embeddings)
246:             |> Enum.map(fn {chunk, embedding} ->
247:               %{
248:                 id: Ecto.UUID.generate(),
249:                 vector: embedding,
250:                 payload:
251:                   Map.merge(metadata, %{
252:                     lesson_id: lesson_id,
253:                     chunk_index: chunk.index,
254:                     text: chunk.text,
255:                     indexed_at: DateTime.utc_now() |> DateTime.to_iso8601()
256:                   })
257:               }
258:             end)
259: 
260:           # Upsert to Qdrant
261:           case QdrantClient.upsert_points(@lessons_collection, points) do
262:             {:ok, count} ->
263:               Logger.info("Indexed #{count} chunks for lesson #{lesson_id}")
264:               {:ok, count}
265: 
266:             {:error, reason} ->
267:               {:error, reason}
268:           end
269: 
270:         {:error, reason} ->
271:           {:error, reason}
272:       end
273:     end
274:   end
275: 
276:   @doc """
277:   Removes a lesson's vectors from the index.
278:   """
279:   @spec remove_lesson(String.t()) :: :ok | {:error, term()}
280:   def remove_lesson(lesson_id) do
281:     filter = %{
282:       must: [
283:         %{key: "lesson_id", match: %{value: lesson_id}}
284:       ]
285:     }
286: 
287:     QdrantClient.delete_points_by_filter(@lessons_collection, filter)
288:   end
289: 
290:   @doc """
291:   Searches for similar content across indexed lessons.
292: 
293:   ## Options
294:   - :limit - Maximum results (default: 10)
295:   - :lesson_id - Filter to specific lesson
296:   - :score_threshold - Minimum similarity (default: 0.7)
297: 
298:   ## Examples
299: 
300:       {:ok, results} = Embeddings.search_lessons("explain fractions")
301:   """
302:   @spec search_lessons(String.t(), keyword()) :: {:ok, list()} | {:error, term()}
303:   def search_lessons(query, opts \\ []) do
304:     limit = Keyword.get(opts, :limit, 10)
305:     lesson_id = Keyword.get(opts, :lesson_id, nil)
306:     score_threshold = Keyword.get(opts, :score_threshold, 0.7)
307: 
308:     # Generate query embedding
309:     case generate(query, input_type: "query") do
310:       {:ok, %{embedding: vector}} ->
311:         # Build filter if lesson_id provided
312:         filter =
313:           if lesson_id do
314:             %{must: [%{key: "lesson_id", match: %{value: lesson_id}}]}
315:           else
316:             nil
317:           end
318: 
319:         # Search Qdrant
320:         QdrantClient.search(@lessons_collection, vector,
321:           limit: limit,
322:           filter: filter,
323:           score_threshold: score_threshold
324:         )
325: 
326:       {:error, reason} ->
327:         {:error, {:embedding_failed, reason}}
328:     end
329:   end
330: 
331:   # ============================================================================
332:   # BNCC COMPETENCIES
333:   # ============================================================================
334: 
335:   @doc """
336:   Indexes BNCC competencies for semantic matching.
337:   Should be called once to populate the BNCC collection.
338:   """
339:   @spec index_bncc_competencies(list(map())) :: {:ok, integer()} | {:error, term()}
340:   def index_bncc_competencies(competencies) when is_list(competencies) do
341:     # Ensure collection exists
342:     :ok = QdrantClient.ensure_collection(@bncc_collection, :nv_embed)
343: 
344:     # Generate embeddings for competency descriptions
345:     texts = Enum.map(competencies, & &1.description)
346: 
347:     case generate_batch(texts, input_type: "passage") do
348:       {:ok, %{embeddings: embeddings}} ->
349:         points =
350:           competencies
351:           |> Enum.zip(embeddings)
352:           |> Enum.map(fn {comp, embedding} ->
353:             %{
354:               id: comp.code || Ecto.UUID.generate(),
355:               vector: embedding,
356:               payload: %{
357:                 code: comp.code,
358:                 area: comp[:area],
359:                 component: comp[:component],
360:                 description: comp.description,
361:                 grade_levels: comp[:grade_levels] || []
362:               }
363:             }
364:           end)
365: 
366:         QdrantClient.upsert_points(@bncc_collection, points)
367: 
368:       {:error, reason} ->
369:         {:error, reason}
370:     end
371:   end
372: 
373:   @doc """
374:   Finds BNCC competencies that match a given text.
375: 
376:   ## Examples
377: 
378:       {:ok, matches} = Embeddings.match_bncc("explain fractions using visual models")
379:   """
380:   @spec match_bncc(String.t(), keyword()) :: {:ok, list()} | {:error, term()}
381:   def match_bncc(text, opts \\ []) do
382:     limit = Keyword.get(opts, :limit, 5)
383:     score_threshold = Keyword.get(opts, :score_threshold, 0.75)
384: 
385:     case generate(text, input_type: "query") do
386:       {:ok, %{embedding: vector}} ->
387:         QdrantClient.search(@bncc_collection, vector,
388:           limit: limit,
389:           score_threshold: score_threshold
390:         )
391: 
392:       {:error, reason} ->
393:         {:error, {:embedding_failed, reason}}
394:     end
395:   end
396: 
397:   # ============================================================================
398:   # GENERIC COLLECTION OPERATIONS
399:   # ============================================================================
400: 
401:   @doc """
402:   Generic search across any collection.
403: 
404:   ## Options
405:   - :limit - Maximum results (default: 10)
406:   - :score_threshold - Minimum similarity (default: 0.7)
407:   - :filter - Additional filter criteria
408:   """
409:   @spec search(String.t(), String.t(), keyword()) :: {:ok, list()} | {:error, term()}
410:   def search(collection, query, opts \\ []) do
411:     limit = Keyword.get(opts, :limit, 10)
412:     score_threshold = Keyword.get(opts, :score_threshold, 0.7)
413:     filter = Keyword.get(opts, :filter, nil)
414: 
415:     case generate(query, input_type: "query") do
416:       {:ok, %{embedding: vector}} ->
417:         QdrantClient.search(collection, vector,
418:           limit: limit,
419:           filter: filter,
420:           score_threshold: score_threshold
421:         )
422: 
423:       {:error, reason} ->
424:         {:error, {:embedding_failed, reason}}
425:     end
426:   end
427: 
428:   @doc """
429:   Generic index operation for any collection.
430:   Indexes a single item with its text and payload.
431:   """
432:   @spec index(String.t(), String.t(), String.t(), map()) :: :ok | {:error, term()}
433:   def index(collection, id, text, payload \\ %{}) do
434:     # Ensure collection exists
435:     :ok = QdrantClient.ensure_collection(collection, :nv_embed)
436: 
437:     case generate(text, input_type: "passage") do
438:       {:ok, %{embedding: vector}} ->
439:         point = %{
440:           id: id,
441:           vector: vector,
442:           payload: Map.put(payload, :indexed_at, DateTime.utc_now() |> DateTime.to_iso8601())
443:         }
444: 
445:         case QdrantClient.upsert_points(collection, [point]) do
446:           {:ok, _} -> :ok
447:           {:error, reason} -> {:error, reason}
448:         end
449: 
450:       {:error, reason} ->
451:         {:error, reason}
452:     end
453:   end
454: 
455:   # ============================================================================
456:   # SIMILARITY
457:   # ============================================================================
458: 
459:   @doc """
460:   Computes cosine similarity between two texts.
461:   """
462:   @spec similarity(String.t(), String.t()) :: {:ok, float()} | {:error, term()}
463:   def similarity(text1, text2) do
464:     case generate_batch([text1, text2]) do
465:       {:ok, %{embeddings: [vec1, vec2]}} ->
466:         {:ok, cosine_similarity(vec1, vec2)}
467: 
468:       {:error, reason} ->
469:         {:error, reason}
470:     end
471:   end
472: 
473:   @doc """
474:   Computes cosine similarity between two vectors.
475:   """
476:   @spec cosine_similarity(list(float()), list(float())) :: float()
477:   def cosine_similarity(vec1, vec2) when length(vec1) == length(vec2) do
478:     dot_product = Enum.zip(vec1, vec2) |> Enum.map(fn {a, b} -> a * b end) |> Enum.sum()
479:     norm1 = :math.sqrt(Enum.map(vec1, fn x -> x * x end) |> Enum.sum())
480:     norm2 = :math.sqrt(Enum.map(vec2, fn x -> x * x end) |> Enum.sum())
481: 
482:     if norm1 == 0 or norm2 == 0 do
483:       0.0
484:     else
485:       dot_product / (norm1 * norm2)
486:     end
487:   end
488: 
489:   # ============================================================================
490:   # HELPERS
491:   # ============================================================================
492: 
493:   @doc """
494:   Returns the embedding dimensions for the current model.
495:   """
496:   @spec dimensions() :: integer()
497:   def dimensions, do: @embedding_dimensions
498: 
499:   @doc """
500:   Returns the model name being used.
501:   """
502:   @spec model() :: String.t()
503:   def model, do: @embedding_model
504: 
505:   defp auth_headers do
506:     api_key = Application.get_env(:hellen, :nvidia_api_key)
507: 
508:     [
509:       {"Authorization", "Bearer #{api_key}"},
510:       {"Content-Type", "application/json"}
511:     ]
512:   end
513: end
````

## File: lib/hellen/ai/planning_generator.ex
````elixir
  1: defmodule Hellen.AI.PlanningGenerator do
  2:   @moduledoc """
  3:   AI-powered lesson planning generator.
  4: 
  5:   Uses NVIDIA NIM LLM to generate structured lesson plans from:
  6:   - Lesson transcriptions
  7:   - Topic descriptions
  8:   - BNCC competency codes
  9: 
 10:   Features:
 11:   - BNCC alignment
 12:   - Grade-level appropriate content
 13:   - Structured methodology sections
 14:   - Assessment criteria suggestions
 15:   """
 16: 
 17:   require Logger
 18: 
 19:   alias Hellen.AI.Embeddings
 20:   alias Hellen.Lessons
 21:   alias Hellen.Plannings
 22:   alias Hellen.Plannings.Planning
 23: 
 24:   # NVIDIA NIM API
 25:   @llm_base_url "https://integrate.api.nvidia.com/v1"
 26:   @llm_model "nvidia/llama-3.1-nemotron-70b-instruct"
 27: 
 28:   # ============================================================================
 29:   # GENERATION FROM LESSON
 30:   # ============================================================================
 31: 
 32:   @doc """
 33:   Generates a lesson planning from an existing lesson transcription.
 34: 
 35:   The planning will include:
 36:   - Learning objectives extracted from the lesson
 37:   - BNCC codes matched from content
 38:   - Structured methodology based on actual teaching
 39:   - Assessment criteria aligned with objectives
 40:   """
 41:   def from_lesson(lesson_id, user_id, opts \\ []) do
 42:     with {:ok, lesson} <- get_lesson_with_transcription(lesson_id),
 43:          {:ok, bncc_matches} <- find_bncc_matches(lesson.transcription.text),
 44:          {:ok, planning_data} <- generate_planning_from_transcription(lesson, bncc_matches, opts) do
 45:       # Create the planning
 46:       attrs =
 47:         planning_data
 48:         |> Map.put(:user_id, user_id)
 49:         |> Map.put(:source_lesson_id, lesson_id)
 50:         |> Map.put(:institution_id, lesson.institution_id)
 51:         |> Map.put(:generated_by_ai, true)
 52: 
 53:       Plannings.create_planning(attrs)
 54:     end
 55:   end
 56: 
 57:   @doc """
 58:   Generates a lesson planning from a topic description.
 59: 
 60:   Useful for creating plannings without existing lessons.
 61:   """
 62:   def from_topic(topic, subject, grade_level, user_id, opts \\ []) do
 63:     with {:ok, bncc_matches} <- find_bncc_matches(topic),
 64:          {:ok, planning_data} <-
 65:            generate_planning_from_topic(topic, subject, grade_level, bncc_matches, opts) do
 66:       attrs =
 67:         planning_data
 68:         |> Map.put(:user_id, user_id)
 69:         |> Map.put(:generated_by_ai, true)
 70: 
 71:       Plannings.create_planning(attrs)
 72:     end
 73:   end
 74: 
 75:   @doc """
 76:   Generates inline suggestions for form fields based on basic info.
 77: 
 78:   Used for real-time AI assistance while filling the manual form.
 79:   Returns suggestions for description, methodology, and assessment_criteria.
 80:   """
 81:   def suggest_fields(title, subject, grade_level, description \\ nil) do
 82:     prompt = build_suggestion_prompt(title, subject, grade_level, description)
 83: 
 84:     case call_llm(prompt) do
 85:       {:ok, response} ->
 86:         parse_suggestion_response(response)
 87: 
 88:       {:error, reason} ->
 89:         {:error, reason}
 90:     end
 91:   end
 92: 
 93:   defp build_suggestion_prompt(title, subject, grade_level, description) do
 94:     subject_label = Plannings.Planning.subject_label(subject)
 95:     grade_label = Plannings.Planning.grade_level_label(grade_level)
 96: 
 97:     context =
 98:       if description && String.trim(description) != "" do
 99:         "Descrição fornecida: #{description}"
100:       else
101:         "Sem descrição prévia"
102:       end
103: 
104:     """
105:     Você é um especialista em pedagogia brasileira. Baseado nas informações abaixo, sugira conteúdo para um plano de aula.
106: 
107:     INFORMAÇÕES:
108:     - Título: #{title}
109:     - Disciplina: #{subject_label}
110:     - Ano/Série: #{grade_label}
111:     - #{context}
112: 
113:     Gere sugestões criativas e pedagógicamente sólidas em JSON (responda APENAS com o JSON):
114:     {
115:       "description": "Uma descrição concisa do que será abordado na aula (2-3 frases)",
116:       "methodology": "Descrição da metodologia sugerida, incluindo abordagens didáticas específicas para #{grade_label}",
117:       "assessment_criteria": "Critérios claros de avaliação alinhados aos objetivos da aula"
118:     }
119:     """
120:   end
121: 
122:   defp parse_suggestion_response(response) do
123:     json_str = extract_json(response)
124: 
125:     case Jason.decode(json_str) do
126:       {:ok, data} ->
127:         {:ok,
128:          %{
129:            description: data["description"],
130:            methodology: data["methodology"],
131:            assessment_criteria: data["assessment_criteria"]
132:          }}
133: 
134:       {:error, _} ->
135:         {:error, :invalid_json_response}
136:     end
137:   end
138: 
139:   @doc """
140:   Improves an existing planning using AI suggestions.
141:   """
142:   def improve_planning(%Planning{} = planning, focus_areas \\ []) do
143:     prompt = build_improvement_prompt(planning, focus_areas)
144: 
145:     case call_llm(prompt) do
146:       {:ok, response} ->
147:         parse_improvement_response(response)
148: 
149:       {:error, reason} ->
150:         {:error, reason}
151:     end
152:   end
153: 
154:   # ============================================================================
155:   # PRIVATE - GENERATION LOGIC
156:   # ============================================================================
157: 
158:   defp get_lesson_with_transcription(lesson_id) do
159:     try do
160:       lesson = Lessons.get_lesson!(lesson_id)
161:       lesson = Hellen.Repo.preload(lesson, :transcription)
162: 
163:       if lesson.transcription && lesson.transcription.text do
164:         {:ok, lesson}
165:       else
166:         {:error, :no_transcription}
167:       end
168:     rescue
169:       Ecto.NoResultsError ->
170:         {:error, :lesson_not_found}
171:     end
172:   end
173: 
174:   defp find_bncc_matches(text) do
175:     case Embeddings.match_bncc(text, limit: 5) do
176:       {:ok, matches} ->
177:         codes = Enum.map(matches, & &1.payload["code"])
178:         {:ok, codes}
179: 
180:       {:error, _reason} ->
181:         # Return empty if BNCC collection not available
182:         {:ok, []}
183:     end
184:   end
185: 
186:   defp generate_planning_from_transcription(lesson, bncc_codes, opts) do
187:     duration = Keyword.get(opts, :duration_minutes, 50)
188: 
189:     prompt = """
190:     Você é um especialista em pedagogia brasileira. Analise a transcrição desta aula e gere um plano de aula estruturado.
191: 
192:     TRANSCRIÇÃO DA AULA:
193:     #{String.slice(lesson.transcription.text, 0, 8000)}
194: 
195:     INFORMAÇÕES:
196:     - Disciplina: #{lesson.subject || "Não especificada"}
197:     - Ano/Série: #{lesson.grade_level || "Não especificado"}
198:     - Duração prevista: #{duration} minutos
199:     - Códigos BNCC sugeridos: #{Enum.join(bncc_codes, ", ")}
200: 
201:     Gere um JSON com a seguinte estrutura (responda APENAS com o JSON, sem texto adicional):
202:     {
203:       "title": "Título claro e descritivo do plano de aula",
204:       "description": "Breve descrição do que será abordado",
205:       "objectives": ["Objetivo 1", "Objetivo 2", "Objetivo 3"],
206:       "bncc_codes": ["EF05MA01", "EF05MA02"],
207:       "content": {
208:         "introduction": "Descrição da introdução/contextualização (5-10 min)",
209:         "development": [
210:           {"step": 1, "activity": "Descrição da atividade", "duration_minutes": 15},
211:           {"step": 2, "activity": "Descrição da atividade", "duration_minutes": 20}
212:         ],
213:         "closure": "Atividade de encerramento e síntese",
214:         "homework": "Tarefa para casa (opcional)",
215:         "adaptations": "Sugestões de adaptação para alunos com necessidades especiais"
216:       },
217:       "materials": ["Material 1", "Material 2"],
218:       "methodology": "Descrição da metodologia utilizada (expositiva, dialogada, prática, etc.)",
219:       "assessment_criteria": "Como avaliar se os objetivos foram alcançados"
220:     }
221:     """
222: 
223:     case call_llm(prompt) do
224:       {:ok, response} ->
225:         parse_planning_response(response, lesson.subject, lesson.grade_level, duration)
226: 
227:       {:error, reason} ->
228:         {:error, reason}
229:     end
230:   end
231: 
232:   defp generate_planning_from_topic(topic, subject, grade_level, bncc_codes, opts) do
233:     duration = Keyword.get(opts, :duration_minutes, 50)
234: 
235:     prompt = """
236:     Você é um especialista em pedagogia brasileira. Crie um plano de aula completo sobre o tema especificado.
237: 
238:     TEMA: #{topic}
239: 
240:     INFORMAÇÕES:
241:     - Disciplina: #{subject}
242:     - Ano/Série: #{grade_level}
243:     - Duração prevista: #{duration} minutos
244:     - Códigos BNCC sugeridos: #{Enum.join(bncc_codes, ", ")}
245: 
246:     Gere um JSON com a seguinte estrutura (responda APENAS com o JSON, sem texto adicional):
247:     {
248:       "title": "Título claro e descritivo do plano de aula",
249:       "description": "Breve descrição do que será abordado",
250:       "objectives": ["Objetivo 1", "Objetivo 2", "Objetivo 3"],
251:       "bncc_codes": ["Código BNCC 1", "Código BNCC 2"],
252:       "content": {
253:         "introduction": "Descrição da introdução/contextualização (5-10 min)",
254:         "development": [
255:           {"step": 1, "activity": "Descrição da atividade", "duration_minutes": 15},
256:           {"step": 2, "activity": "Descrição da atividade", "duration_minutes": 20}
257:         ],
258:         "closure": "Atividade de encerramento e síntese",
259:         "homework": "Tarefa para casa (opcional)",
260:         "adaptations": "Sugestões de adaptação para alunos com necessidades especiais"
261:       },
262:       "materials": ["Material 1", "Material 2"],
263:       "methodology": "Descrição da metodologia utilizada",
264:       "assessment_criteria": "Como avaliar se os objetivos foram alcançados"
265:     }
266:     """
267: 
268:     case call_llm(prompt) do
269:       {:ok, response} ->
270:         parse_planning_response(response, subject, grade_level, duration)
271: 
272:       {:error, reason} ->
273:         {:error, reason}
274:     end
275:   end
276: 
277:   defp build_improvement_prompt(%Planning{} = planning, focus_areas) do
278:     focus_text =
279:       if Enum.empty?(focus_areas) do
280:         "engajamento dos alunos, clareza dos objetivos, alinhamento BNCC"
281:       else
282:         Enum.join(focus_areas, ", ")
283:       end
284: 
285:     """
286:     Você é um especialista em pedagogia brasileira. Analise este plano de aula e sugira melhorias.
287: 
288:     PLANO ATUAL:
289:     Título: #{planning.title}
290:     Descrição: #{planning.description}
291:     Objetivos: #{Enum.join(planning.objectives || [], ", ")}
292:     Metodologia: #{planning.methodology}
293:     Avaliação: #{planning.assessment_criteria}
294: 
295:     FOCO DAS MELHORIAS: #{focus_text}
296: 
297:     Responda em JSON com sugestões específicas:
298:     {
299:       "suggestions": [
300:         {"area": "Objetivos", "current": "...", "improved": "...", "reason": "..."},
301:         {"area": "Metodologia", "current": "...", "improved": "...", "reason": "..."}
302:       ],
303:       "additional_activities": ["Atividade sugerida 1", "Atividade sugerida 2"],
304:       "resources": ["Recurso adicional 1", "Recurso adicional 2"]
305:     }
306:     """
307:   end
308: 
309:   # ============================================================================
310:   # LLM INTEGRATION
311:   # ============================================================================
312: 
313:   defp call_llm(prompt) do
314:     start_time = System.monotonic_time(:millisecond)
315: 
316:     result =
317:       Req.post("#{@llm_base_url}/chat/completions",
318:         json: %{
319:           model: @llm_model,
320:           messages: [
321:             %{
322:               role: "system",
323:               content:
324:                 "Você é um assistente especializado em educação brasileira. Responda sempre em português e em formato JSON quando solicitado."
325:             },
326:             %{role: "user", content: prompt}
327:           ],
328:           max_tokens: 4000,
329:           temperature: 0.7
330:         },
331:         headers: auth_headers(),
332:         receive_timeout: 120_000
333:       )
334: 
335:     case result do
336:       {:ok, %{status: 200, body: body}} ->
337:         content = get_in(body, ["choices", Access.at(0), "message", "content"])
338:         processing_time = System.monotonic_time(:millisecond) - start_time
339:         Logger.info("Planning LLM call completed in #{processing_time}ms")
340:         {:ok, content}
341: 
342:       {:ok, %{status: status, body: body}} ->
343:         Logger.error("Planning LLM error #{status}: #{inspect(body)}")
344:         {:error, %{status: status, message: body["error"] || "Unknown error"}}
345: 
346:       {:error, reason} ->
347:         Logger.error("Planning LLM request failed: #{inspect(reason)}")
348:         {:error, reason}
349:     end
350:   end
351: 
352:   defp auth_headers do
353:     api_key = Application.get_env(:hellen, :nvidia_api_key)
354: 
355:     [
356:       {"Authorization", "Bearer #{api_key}"},
357:       {"Content-Type", "application/json"}
358:     ]
359:   end
360: 
361:   # ============================================================================
362:   # RESPONSE PARSING
363:   # ============================================================================
364: 
365:   defp parse_planning_response(response, subject, grade_level, duration) do
366:     # Extract JSON from response (handle markdown code blocks)
367:     json_str =
368:       response
369:       |> String.trim()
370:       |> extract_json()
371: 
372:     case Jason.decode(json_str) do
373:       {:ok, data} ->
374:         planning_attrs = %{
375:           title: data["title"] || "Plano de Aula",
376:           description: data["description"],
377:           subject: normalize_subject(subject),
378:           grade_level: normalize_grade_level(grade_level),
379:           duration_minutes: duration,
380:           objectives: data["objectives"] || [],
381:           bncc_codes: data["bncc_codes"] || [],
382:           content: data["content"] || %{},
383:           materials: data["materials"] || [],
384:           methodology: data["methodology"],
385:           assessment_criteria: data["assessment_criteria"]
386:         }
387: 
388:         {:ok, planning_attrs}
389: 
390:       {:error, _} ->
391:         Logger.warning("Failed to parse planning JSON: #{String.slice(json_str, 0, 200)}")
392:         {:error, :invalid_json_response}
393:     end
394:   end
395: 
396:   defp parse_improvement_response(response) do
397:     json_str = extract_json(response)
398: 
399:     case Jason.decode(json_str) do
400:       {:ok, data} -> {:ok, data}
401:       {:error, _} -> {:error, :invalid_json_response}
402:     end
403:   end
404: 
405:   defp extract_json(text) do
406:     # Try to extract JSON from markdown code blocks
407:     case Regex.run(~r/```(?:json)?\s*\n?([\s\S]*?)\n?```/, text) do
408:       [_, json] -> String.trim(json)
409:       nil -> String.trim(text)
410:     end
411:   end
412: 
413:   defp normalize_subject(nil), do: "portugues"
414: 
415:   defp normalize_subject(subject) do
416:     subject
417:     |> String.downcase()
418:     |> String.replace(~r/[áàãâä]/, "a")
419:     |> String.replace(~r/[éèêë]/, "e")
420:     |> String.replace(~r/[íìîï]/, "i")
421:     |> String.replace(~r/[óòõôö]/, "o")
422:     |> String.replace(~r/[úùûü]/, "u")
423:     |> String.replace(~r/ç/, "c")
424:     |> String.replace(~r/\s+/, "_")
425:     |> then(fn s ->
426:       if s in Planning.subjects(), do: s, else: "portugues"
427:     end)
428:   end
429: 
430:   defp normalize_grade_level(nil), do: "5_ano"
431: 
432:   defp normalize_grade_level(level) do
433:     level
434:     |> String.downcase()
435:     |> String.replace(~r/º\s*/, "_")
436:     |> String.replace(~r/\s+/, "_")
437:     |> then(fn s ->
438:       if s in Planning.grade_levels(), do: s, else: "5_ano"
439:     end)
440:   end
441: end
````

## File: lib/hellen/ai/qdrant_client.ex
````elixir
  1: defmodule Hellen.AI.QdrantClient do
  2:   @moduledoc """
  3:   Client for Qdrant vector database.
  4:   Handles collection management, vector insertion, and semantic search.
  5: 
  6:   Uses Qdrant REST API on port 6333.
  7: 
  8:   Collections:
  9:   - lessons: Transcription chunks for semantic search
 10:   - bncc: BNCC competencies for matching
 11:   - feedback_templates: Pedagogical feedback templates
 12:   """
 13: 
 14:   require Logger
 15: 
 16:   alias Hellen.AI.Embeddings
 17: 
 18:   @default_url "http://localhost:6333"
 19:   @default_timeout 30_000
 20: 
 21:   # Vector dimensions for different embedding models
 22:   @dimensions %{
 23:     # NVIDIA NV-Embed-v2 (1024 dimensions)
 24:     nv_embed: 1024,
 25:     # OpenAI text-embedding-3-small
 26:     openai_small: 1536,
 27:     # Sentence transformers
 28:     sentence_transformers: 384
 29:   }
 30: 
 31:   # Get base URL from config or use default
 32:   defp base_url do
 33:     Application.get_env(:hellen, :qdrant_url, @default_url)
 34:   end
 35: 
 36:   # ============================================================================
 37:   # COLLECTION MANAGEMENT
 38:   # ============================================================================
 39: 
 40:   @doc """
 41:   Creates a collection with the specified vector configuration.
 42: 
 43:   ## Examples
 44: 
 45:       QdrantClient.create_collection("lessons", :nv_embed)
 46:       QdrantClient.create_collection("bncc", :nv_embed, distance: "Cosine")
 47:   """
 48:   @spec create_collection(String.t(), atom(), keyword()) :: {:ok, map()} | {:error, term()}
 49:   def create_collection(name, embedding_type \\ :nv_embed, opts \\ []) do
 50:     distance = Keyword.get(opts, :distance, "Cosine")
 51:     dimensions = Map.get(@dimensions, embedding_type, @dimensions.nv_embed)
 52: 
 53:     body = %{
 54:       vectors: %{
 55:         size: dimensions,
 56:         distance: distance
 57:       },
 58:       optimizers_config: %{
 59:         indexing_threshold: 20_000
 60:       },
 61:       replication_factor: 1
 62:     }
 63: 
 64:     case request(:put, "/collections/#{name}", body) do
 65:       {:ok, %{status: status}} when status in [200, 201] ->
 66:         Logger.info("Created Qdrant collection: #{name} (#{dimensions}d, #{distance})")
 67:         {:ok, %{name: name, dimensions: dimensions, distance: distance}}
 68: 
 69:       {:ok, %{status: 400, body: %{"status" => %{"error" => error}}}} ->
 70:         if String.contains?(error, "already exists") do
 71:           Logger.info("Collection #{name} already exists")
 72:           {:ok, %{name: name, exists: true}}
 73:         else
 74:           {:error, error}
 75:         end
 76: 
 77:       {:error, reason} ->
 78:         {:error, reason}
 79:     end
 80:   end
 81: 
 82:   @doc """
 83:   Deletes a collection.
 84:   """
 85:   @spec delete_collection(String.t()) :: :ok | {:error, term()}
 86:   def delete_collection(name) do
 87:     case request(:delete, "/collections/#{name}") do
 88:       {:ok, %{status: 200}} ->
 89:         Logger.info("Deleted Qdrant collection: #{name}")
 90:         :ok
 91: 
 92:       {:ok, %{status: 404}} ->
 93:         {:error, :not_found}
 94: 
 95:       {:error, reason} ->
 96:         {:error, reason}
 97:     end
 98:   end
 99: 
100:   @doc """
101:   Gets collection info.
102:   """
103:   @spec get_collection(String.t()) :: {:ok, map()} | {:error, term()}
104:   def get_collection(name) do
105:     case request(:get, "/collections/#{name}") do
106:       {:ok, %{status: 200, body: body}} ->
107:         {:ok, body["result"]}
108: 
109:       {:ok, %{status: 404}} ->
110:         {:error, :not_found}
111: 
112:       {:error, reason} ->
113:         {:error, reason}
114:     end
115:   end
116: 
117:   @doc """
118:   Lists all collections.
119:   """
120:   @spec list_collections() :: {:ok, list()} | {:error, term()}
121:   def list_collections do
122:     case request(:get, "/collections") do
123:       {:ok, %{status: 200, body: body}} ->
124:         collections =
125:           body["result"]["collections"]
126:           |> Enum.map(& &1["name"])
127: 
128:         {:ok, collections}
129: 
130:       {:error, reason} ->
131:         {:error, reason}
132:     end
133:   end
134: 
135:   @doc """
136:   Ensures a collection exists, creating it if needed.
137:   """
138:   @spec ensure_collection(String.t(), atom(), keyword()) :: :ok | {:error, term()}
139:   def ensure_collection(name, embedding_type \\ :nv_embed, opts \\ []) do
140:     case get_collection(name) do
141:       {:ok, _} ->
142:         :ok
143: 
144:       {:error, :not_found} ->
145:         case create_collection(name, embedding_type, opts) do
146:           {:ok, _} -> :ok
147:           {:error, reason} -> {:error, reason}
148:         end
149: 
150:       {:error, reason} ->
151:         {:error, reason}
152:     end
153:   end
154: 
155:   # ============================================================================
156:   # POINT OPERATIONS
157:   # ============================================================================
158: 
159:   @doc """
160:   Inserts points (vectors with payloads) into a collection.
161: 
162:   ## Examples
163: 
164:       points = [
165:         %{id: "uuid-1", vector: [0.1, 0.2, ...], payload: %{text: "chunk 1", lesson_id: "..."}},
166:         %{id: "uuid-2", vector: [0.3, 0.4, ...], payload: %{text: "chunk 2", lesson_id: "..."}}
167:       ]
168:       QdrantClient.upsert_points("lessons", points)
169:   """
170:   @spec upsert_points(String.t(), list(map())) :: {:ok, integer()} | {:error, term()}
171:   def upsert_points(collection, points) when is_list(points) do
172:     # Format points for Qdrant API
173:     formatted_points =
174:       Enum.map(points, fn point ->
175:         %{
176:           id: point.id || Ecto.UUID.generate(),
177:           vector: point.vector,
178:           payload: point[:payload] || %{}
179:         }
180:       end)
181: 
182:     body = %{
183:       points: formatted_points
184:     }
185: 
186:     case request(:put, "/collections/#{collection}/points", body) do
187:       {:ok, %{status: 200, body: %{"status" => "ok"}}} ->
188:         Logger.debug("Upserted #{length(points)} points to #{collection}")
189:         {:ok, length(points)}
190: 
191:       {:ok, %{status: status, body: body}} ->
192:         Logger.error("Failed to upsert points: #{status} - #{inspect(body)}")
193:         {:error, body}
194: 
195:       {:error, reason} ->
196:         {:error, reason}
197:     end
198:   end
199: 
200:   @doc """
201:   Gets points by IDs.
202:   """
203:   @spec get_points(String.t(), list(String.t())) :: {:ok, list()} | {:error, term()}
204:   def get_points(collection, ids) when is_list(ids) do
205:     body = %{
206:       ids: ids,
207:       with_payload: true,
208:       with_vector: false
209:     }
210: 
211:     case request(:post, "/collections/#{collection}/points", body) do
212:       {:ok, %{status: 200, body: body}} ->
213:         {:ok, body["result"]}
214: 
215:       {:error, reason} ->
216:         {:error, reason}
217:     end
218:   end
219: 
220:   @doc """
221:   Deletes points by IDs.
222:   """
223:   @spec delete_points(String.t(), list(String.t())) :: :ok | {:error, term()}
224:   def delete_points(collection, ids) when is_list(ids) do
225:     body = %{
226:       points: ids
227:     }
228: 
229:     case request(:post, "/collections/#{collection}/points/delete", body) do
230:       {:ok, %{status: 200}} ->
231:         Logger.debug("Deleted #{length(ids)} points from #{collection}")
232:         :ok
233: 
234:       {:error, reason} ->
235:         {:error, reason}
236:     end
237:   end
238: 
239:   @doc """
240:   Deletes points matching a filter.
241:   """
242:   @spec delete_points_by_filter(String.t(), map()) :: :ok | {:error, term()}
243:   def delete_points_by_filter(collection, filter) do
244:     body = %{
245:       filter: filter
246:     }
247: 
248:     case request(:post, "/collections/#{collection}/points/delete", body) do
249:       {:ok, %{status: 200}} ->
250:         Logger.debug("Deleted points by filter from #{collection}")
251:         :ok
252: 
253:       {:error, reason} ->
254:         {:error, reason}
255:     end
256:   end
257: 
258:   # ============================================================================
259:   # SEARCH OPERATIONS
260:   # ============================================================================
261: 
262:   @doc """
263:   Performs semantic search using a query vector.
264: 
265:   ## Options
266:   - :limit - Maximum number of results (default: 10)
267:   - :score_threshold - Minimum similarity score (default: 0.7)
268:   - :filter - Qdrant filter conditions
269:   - :with_payload - Include payload in results (default: true)
270: 
271:   ## Examples
272: 
273:       {:ok, results} = QdrantClient.search("lessons", query_vector, limit: 5)
274:       {:ok, results} = QdrantClient.search("lessons", query_vector,
275:         filter: %{must: [%{key: "lesson_id", match: %{value: "uuid"}}]}
276:       )
277:   """
278:   @spec search(String.t(), list(float()), keyword()) :: {:ok, list()} | {:error, term()}
279:   def search(collection, vector, opts \\ []) when is_list(vector) do
280:     limit = Keyword.get(opts, :limit, 10)
281:     score_threshold = Keyword.get(opts, :score_threshold, 0.7)
282:     filter = Keyword.get(opts, :filter, nil)
283:     with_payload = Keyword.get(opts, :with_payload, true)
284: 
285:     body =
286:       %{
287:         vector: vector,
288:         limit: limit,
289:         score_threshold: score_threshold,
290:         with_payload: with_payload
291:       }
292:       |> maybe_add_filter(filter)
293: 
294:     case request(:post, "/collections/#{collection}/points/search", body) do
295:       {:ok, %{status: 200, body: body}} ->
296:         results =
297:           body["result"]
298:           |> Enum.map(fn result ->
299:             %{
300:               id: result["id"],
301:               score: result["score"],
302:               payload: result["payload"]
303:             }
304:           end)
305: 
306:         {:ok, results}
307: 
308:       {:error, reason} ->
309:         {:error, reason}
310:     end
311:   end
312: 
313:   @doc """
314:   Searches using text by first generating an embedding.
315:   Requires the Embeddings module to be configured.
316:   """
317:   @spec search_text(String.t(), String.t(), keyword()) :: {:ok, list()} | {:error, term()}
318:   def search_text(collection, query_text, opts \\ []) do
319:     case Embeddings.generate(query_text) do
320:       {:ok, %{embedding: vector}} ->
321:         search(collection, vector, opts)
322: 
323:       {:error, reason} ->
324:         {:error, {:embedding_failed, reason}}
325:     end
326:   end
327: 
328:   @doc """
329:   Batch search with multiple vectors.
330:   """
331:   @spec batch_search(String.t(), list(list(float())), keyword()) ::
332:           {:ok, list(list())} | {:error, term()}
333:   def batch_search(collection, vectors, opts \\ []) when is_list(vectors) do
334:     limit = Keyword.get(opts, :limit, 10)
335:     score_threshold = Keyword.get(opts, :score_threshold, 0.7)
336: 
337:     searches =
338:       Enum.map(vectors, fn vector ->
339:         %{
340:           vector: vector,
341:           limit: limit,
342:           score_threshold: score_threshold,
343:           with_payload: true
344:         }
345:       end)
346: 
347:     body = %{
348:       searches: searches
349:     }
350: 
351:     case request(:post, "/collections/#{collection}/points/search/batch", body) do
352:       {:ok, %{status: 200, body: body}} ->
353:         results =
354:           body["result"]
355:           |> Enum.map(fn search_result ->
356:             Enum.map(search_result, fn result ->
357:               %{
358:                 id: result["id"],
359:                 score: result["score"],
360:                 payload: result["payload"]
361:               }
362:             end)
363:           end)
364: 
365:         {:ok, results}
366: 
367:       {:error, reason} ->
368:         {:error, reason}
369:     end
370:   end
371: 
372:   # ============================================================================
373:   # SCROLL/PAGINATION
374:   # ============================================================================
375: 
376:   @doc """
377:   Scrolls through all points in a collection.
378:   Useful for iteration or export.
379:   """
380:   @spec scroll(String.t(), keyword()) :: {:ok, list(), String.t() | nil} | {:error, term()}
381:   def scroll(collection, opts \\ []) do
382:     limit = Keyword.get(opts, :limit, 100)
383:     offset = Keyword.get(opts, :offset, nil)
384:     filter = Keyword.get(opts, :filter, nil)
385: 
386:     body =
387:       %{
388:         limit: limit,
389:         with_payload: true,
390:         with_vector: false
391:       }
392:       |> maybe_add_filter(filter)
393:       |> maybe_add_offset(offset)
394: 
395:     case request(:post, "/collections/#{collection}/points/scroll", body) do
396:       {:ok, %{status: 200, body: body}} ->
397:         points = body["result"]["points"]
398:         next_offset = body["result"]["next_page_offset"]
399:         {:ok, points, next_offset}
400: 
401:       {:error, reason} ->
402:         {:error, reason}
403:     end
404:   end
405: 
406:   # ============================================================================
407:   # HEALTH CHECK
408:   # ============================================================================
409: 
410:   @doc """
411:   Checks if Qdrant is healthy.
412:   """
413:   @spec health() :: :ok | {:error, term()}
414:   def health do
415:     case Req.get("#{base_url()}/health", receive_timeout: 5_000) do
416:       {:ok, %{status: 200}} -> :ok
417:       {:ok, %{status: status}} -> {:error, {:unhealthy, status}}
418:       {:error, reason} -> {:error, reason}
419:     end
420:   end
421: 
422:   @doc """
423:   Gets Qdrant cluster info.
424:   """
425:   @spec info() :: {:ok, map()} | {:error, term()}
426:   def info do
427:     case request(:get, "/") do
428:       {:ok, %{status: 200, body: body}} ->
429:         {:ok, body}
430: 
431:       {:error, reason} ->
432:         {:error, reason}
433:     end
434:   end
435: 
436:   # ============================================================================
437:   # PRIVATE HELPERS
438:   # ============================================================================
439: 
440:   defp request(method, path, body \\ nil) do
441:     url = "#{base_url()}#{path}"
442: 
443:     opts =
444:       [
445:         receive_timeout: @default_timeout
446:       ]
447:       |> add_json_body(method, body)
448: 
449:     case apply(Req, method, [url, opts]) do
450:       {:ok, %{status: status, body: body}} ->
451:         {:ok, %{status: status, body: body}}
452: 
453:       {:error, reason} ->
454:         Logger.error("Qdrant request failed: #{method} #{path} - #{inspect(reason)}")
455:         {:error, reason}
456:     end
457:   end
458: 
459:   defp add_json_body(opts, method, body)
460:        when method in [:put, :post, :patch] and not is_nil(body) do
461:     Keyword.put(opts, :json, body)
462:   end
463: 
464:   defp add_json_body(opts, _method, _body), do: opts
465: 
466:   defp maybe_add_filter(body, nil), do: body
467:   defp maybe_add_filter(body, filter), do: Map.put(body, :filter, filter)
468: 
469:   defp maybe_add_offset(body, nil), do: body
470:   defp maybe_add_offset(body, offset), do: Map.put(body, :offset, offset)
471: end
````

## File: lib/hellen/analysis/bncc_match.ex
````elixir
 1: defmodule Hellen.Analysis.BnccMatch do
 2:   @moduledoc """
 3:   Schema for BNCC competency matches found during lesson analysis.
 4:   """
 5:   use Ecto.Schema
 6:   import Ecto.Changeset
 7: 
 8:   @primary_key {:id, :binary_id, autogenerate: true}
 9:   @foreign_key_type :binary_id
10: 
11:   schema "bncc_matches" do
12:     field :competencia_code, :string
13:     field :competencia_name, :string
14:     field :match_score, :float
15:     field :evidence_text, :string
16:     field :evidence_timestamp_start, :float
17:     field :evidence_timestamp_end, :float
18: 
19:     belongs_to :analysis, Hellen.Analysis.Analysis
20: 
21:     timestamps(type: :utc_datetime, updated_at: false)
22:   end
23: 
24:   @doc false
25:   def changeset(bncc_match, attrs) do
26:     bncc_match
27:     |> cast(attrs, [
28:       :competencia_code,
29:       :competencia_name,
30:       :match_score,
31:       :evidence_text,
32:       :evidence_timestamp_start,
33:       :evidence_timestamp_end,
34:       :analysis_id
35:     ])
36:     |> validate_required([:competencia_code, :analysis_id])
37:     |> validate_number(:match_score, greater_than_or_equal_to: 0, less_than_or_equal_to: 1)
38:     |> foreign_key_constraint(:analysis_id)
39:   end
40: end
````

## File: lib/hellen/assessments/assessment.ex
````elixir
  1: defmodule Hellen.Assessments.Assessment do
  2:   @moduledoc """
  3:   Schema for assessments (provas, atividades, simulados).
  4: 
  5:   Supports multiple question types:
  6:   - multiple_choice: Multiple choice with options
  7:   - true_false: True/False statements
  8:   - short_answer: Short text response
  9:   - essay: Long-form written response
 10:   - matching: Match items between columns
 11:   - fill_blank: Fill in the blank
 12:   """
 13: 
 14:   use Ecto.Schema
 15:   import Ecto.Changeset
 16: 
 17:   alias Hellen.Plannings.Planning
 18: 
 19:   @primary_key {:id, :binary_id, autogenerate: true}
 20:   @foreign_key_type :binary_id
 21: 
 22:   schema "assessments" do
 23:     field :title, :string
 24:     field :description, :string
 25:     field :subject, :string
 26:     field :grade_level, :string
 27:     field :assessment_type, :string, default: "prova"
 28:     field :difficulty_level, :string, default: "medio"
 29:     field :duration_minutes, :integer
 30:     field :total_points, :decimal
 31:     field :instructions, :string
 32:     field :bncc_codes, {:array, :string}, default: []
 33:     field :questions, {:array, :map}, default: []
 34:     field :answer_key, :map, default: %{}
 35:     field :rubrics, :map, default: %{}
 36:     field :status, :string, default: "draft"
 37:     field :generated_by_ai, :boolean, default: false
 38:     field :embeddings_indexed, :boolean, default: false
 39:     field :metadata, :map, default: %{}
 40: 
 41:     belongs_to :user, Hellen.Accounts.User
 42:     belongs_to :institution, Hellen.Accounts.Institution
 43:     belongs_to :source_planning, Hellen.Plannings.Planning
 44: 
 45:     timestamps(type: :utc_datetime)
 46:   end
 47: 
 48:   @doc "Valid assessment types"
 49:   def assessment_types do
 50:     ~w(prova atividade simulado exercicio trabalho quiz)
 51:   end
 52: 
 53:   @doc "Valid difficulty levels"
 54:   def difficulty_levels do
 55:     ~w(facil medio dificil misto)
 56:   end
 57: 
 58:   @doc "Valid statuses"
 59:   def statuses do
 60:     ~w(draft published archived)
 61:   end
 62: 
 63:   @doc "Valid question types"
 64:   def question_types do
 65:     ~w(multiple_choice true_false short_answer essay matching fill_blank)
 66:   end
 67: 
 68:   @doc "Same subjects as plannings"
 69:   def subjects do
 70:     Planning.subjects()
 71:   end
 72: 
 73:   @doc "Same grade levels as plannings"
 74:   def grade_levels do
 75:     Planning.grade_levels()
 76:   end
 77: 
 78:   @doc "Human-readable labels for assessment types"
 79:   def assessment_type_label("prova"), do: "Prova"
 80:   def assessment_type_label("atividade"), do: "Atividade"
 81:   def assessment_type_label("simulado"), do: "Simulado"
 82:   def assessment_type_label("exercicio"), do: "Exercício"
 83:   def assessment_type_label("trabalho"), do: "Trabalho"
 84:   def assessment_type_label("quiz"), do: "Quiz"
 85:   def assessment_type_label(_), do: "Avaliação"
 86: 
 87:   @doc "Human-readable labels for difficulty levels"
 88:   def difficulty_label("facil"), do: "Fácil"
 89:   def difficulty_label("medio"), do: "Médio"
 90:   def difficulty_label("dificil"), do: "Difícil"
 91:   def difficulty_label("misto"), do: "Misto"
 92:   def difficulty_label(_), do: "Médio"
 93: 
 94:   @doc "Use planning labels"
 95:   defdelegate subject_label(subject), to: Hellen.Plannings.Planning
 96:   defdelegate grade_level_label(level), to: Hellen.Plannings.Planning
 97:   defdelegate status_label(status), to: Hellen.Plannings.Planning
 98: 
 99:   @doc "Question type labels"
100:   def question_type_label("multiple_choice"), do: "Múltipla Escolha"
101:   def question_type_label("true_false"), do: "Verdadeiro/Falso"
102:   def question_type_label("short_answer"), do: "Resposta Curta"
103:   def question_type_label("essay"), do: "Dissertativa"
104:   def question_type_label("matching"), do: "Associação"
105:   def question_type_label("fill_blank"), do: "Preencher Lacunas"
106:   def question_type_label(_), do: "Questão"
107: 
108:   @doc false
109:   def changeset(assessment, attrs) do
110:     assessment
111:     |> cast(attrs, [
112:       :title,
113:       :description,
114:       :subject,
115:       :grade_level,
116:       :assessment_type,
117:       :difficulty_level,
118:       :duration_minutes,
119:       :total_points,
120:       :instructions,
121:       :bncc_codes,
122:       :questions,
123:       :answer_key,
124:       :rubrics,
125:       :status,
126:       :generated_by_ai,
127:       :embeddings_indexed,
128:       :metadata,
129:       :user_id,
130:       :institution_id,
131:       :source_planning_id
132:     ])
133:     |> validate_required([:title, :subject, :grade_level, :user_id])
134:     |> validate_inclusion(:subject, subjects())
135:     |> validate_inclusion(:grade_level, grade_levels())
136:     |> validate_inclusion(:assessment_type, assessment_types())
137:     |> validate_inclusion(:difficulty_level, difficulty_levels())
138:     |> validate_inclusion(:status, statuses())
139:     |> validate_number(:duration_minutes, greater_than: 0, less_than_or_equal_to: 480)
140:     |> validate_number(:total_points, greater_than: 0)
141:     |> validate_questions()
142:     |> foreign_key_constraint(:user_id)
143:     |> foreign_key_constraint(:institution_id)
144:     |> foreign_key_constraint(:source_planning_id)
145:   end
146: 
147:   @doc "Changeset for creating from AI generation"
148:   def ai_changeset(assessment, attrs) do
149:     assessment
150:     |> changeset(attrs)
151:     |> put_change(:generated_by_ai, true)
152:   end
153: 
154:   @doc "Changeset for publishing"
155:   def publish_changeset(assessment) do
156:     assessment
157:     |> change()
158:     |> put_change(:status, "published")
159:     |> validate_questions_for_publish()
160:   end
161: 
162:   @doc "Changeset for archiving"
163:   def archive_changeset(assessment) do
164:     assessment
165:     |> change()
166:     |> put_change(:status, "archived")
167:   end
168: 
169:   defp validate_questions(changeset) do
170:     case get_change(changeset, :questions) do
171:       nil ->
172:         changeset
173: 
174:       questions when is_list(questions) ->
175:         if Enum.all?(questions, &valid_question?/1) do
176:           changeset
177:         else
178:           add_error(changeset, :questions, "contém questões com formato inválido")
179:         end
180: 
181:       _ ->
182:         add_error(changeset, :questions, "deve ser uma lista de questões")
183:     end
184:   end
185: 
186:   defp validate_questions_for_publish(changeset) do
187:     assessment = changeset.data
188:     questions = assessment.questions || []
189: 
190:     if Enum.empty?(questions) do
191:       add_error(changeset, :questions, "deve ter pelo menos uma questão para publicar")
192:     else
193:       changeset
194:     end
195:   end
196: 
197:   defp valid_question?(question) when is_map(question) do
198:     Map.has_key?(question, "type") and
199:       Map.has_key?(question, "text") and
200:       question["type"] in question_types()
201:   end
202: 
203:   defp valid_question?(_), do: false
204: end
````

## File: lib/hellen/auth/firebase.ex
````elixir
  1: defmodule Hellen.Auth.Firebase do
  2:   @moduledoc """
  3:   Firebase ID Token verification using JOSE.
  4: 
  5:   Verifies tokens issued by Firebase Authentication by:
  6:   1. Fetching Google's public keys (with caching)
  7:   2. Verifying JWT signature using RS256
  8:   3. Validating claims (issuer, audience, expiration)
  9:   """
 10: 
 11:   require Logger
 12: 
 13:   @google_certs_url "https://www.googleapis.com/robot/v1/metadata/x509/securetoken@system.gserviceaccount.com"
 14:   @cache_ttl :timer.hours(1)
 15: 
 16:   @doc """
 17:   Verifies a Firebase ID token and returns the decoded claims.
 18: 
 19:   ## Options
 20:     * `:project_id` - Firebase project ID (required for audience validation)
 21: 
 22:   ## Returns
 23:     * `{:ok, claims}` - Token is valid, returns decoded claims map
 24:     * `{:error, reason}` - Token is invalid
 25:   """
 26:   def verify_id_token(token, opts \\ []) do
 27:     project_id = opts[:project_id] || get_project_id()
 28: 
 29:     with {:ok, header} <- peek_header(token),
 30:          {:ok, certs} <- fetch_google_certs(),
 31:          {:ok, jwk} <- get_jwk_for_kid(certs, header["kid"]),
 32:          {:ok, claims} <- verify_signature(token, jwk),
 33:          :ok <- validate_claims(claims, project_id) do
 34:       {:ok, claims}
 35:     end
 36:   end
 37: 
 38:   @doc """
 39:   Extracts user info from verified Firebase claims.
 40:   """
 41:   def extract_user_info(claims) do
 42:     %{
 43:       firebase_uid: claims["sub"],
 44:       email: claims["email"],
 45:       email_verified: claims["email_verified"] || false,
 46:       name: claims["name"],
 47:       picture: claims["picture"],
 48:       provider: get_provider(claims),
 49:       raw_claims: claims
 50:     }
 51:   end
 52: 
 53:   # Private functions
 54: 
 55:   defp get_project_id do
 56:     Application.get_env(:hellen, :firebase)[:project_id] || "hellen-ai"
 57:   end
 58: 
 59:   defp peek_header(token) do
 60:     case String.split(token, ".") do
 61:       [header_b64 | _] ->
 62:         case Base.url_decode64(header_b64, padding: false) do
 63:           {:ok, header_json} ->
 64:             {:ok, Jason.decode!(header_json)}
 65: 
 66:           :error ->
 67:             {:error, :invalid_token_format}
 68:         end
 69: 
 70:       _ ->
 71:         {:error, :invalid_token_format}
 72:     end
 73:   end
 74: 
 75:   defp fetch_google_certs do
 76:     cache_key = :firebase_google_certs
 77:     now = System.system_time(:millisecond)
 78: 
 79:     case :persistent_term.get(cache_key, nil) do
 80:       {certs, expires_at} when is_integer(expires_at) ->
 81:         if expires_at > now do
 82:           {:ok, certs}
 83:         else
 84:           fetch_and_cache_certs(cache_key)
 85:         end
 86: 
 87:       _ ->
 88:         fetch_and_cache_certs(cache_key)
 89:     end
 90:   end
 91: 
 92:   defp fetch_and_cache_certs(cache_key) do
 93:     case Req.get(@google_certs_url) do
 94:       {:ok, %{status: 200, body: body}} when is_map(body) ->
 95:         expires_at = System.system_time(:millisecond) + @cache_ttl
 96:         :persistent_term.put(cache_key, {body, expires_at})
 97:         {:ok, body}
 98: 
 99:       {:ok, %{status: status}} ->
100:         Logger.error("Failed to fetch Google certs: HTTP #{status}")
101:         {:error, :certs_fetch_failed}
102: 
103:       {:error, reason} ->
104:         Logger.error("Failed to fetch Google certs: #{inspect(reason)}")
105:         {:error, :certs_fetch_failed}
106:     end
107:   end
108: 
109:   defp get_jwk_for_kid(certs, kid) do
110:     case Map.get(certs, kid) do
111:       nil ->
112:         {:error, :unknown_key_id}
113: 
114:       cert_pem ->
115:         jwk = JOSE.JWK.from_pem(cert_pem)
116:         {:ok, jwk}
117:     end
118:   end
119: 
120:   defp verify_signature(token, jwk) do
121:     case JOSE.JWT.verify_strict(jwk, ["RS256"], token) do
122:       {true, %JOSE.JWT{fields: fields}, _jws} ->
123:         {:ok, fields}
124: 
125:       {false, _, _} ->
126:         {:error, :invalid_signature}
127:     end
128:   end
129: 
130:   defp validate_claims(claims, project_id) do
131:     now = System.system_time(:second)
132:     expected_issuer = "https://securetoken.google.com/#{project_id}"
133: 
134:     cond do
135:       claims["iss"] != expected_issuer ->
136:         {:error, :invalid_issuer}
137: 
138:       claims["aud"] != project_id ->
139:         {:error, :invalid_audience}
140: 
141:       claims["exp"] <= now ->
142:         {:error, :token_expired}
143: 
144:       claims["iat"] > now ->
145:         {:error, :token_not_yet_valid}
146: 
147:       is_nil(claims["sub"]) or claims["sub"] == "" ->
148:         {:error, :missing_subject}
149: 
150:       true ->
151:         :ok
152:     end
153:   end
154: 
155:   defp get_provider(claims) do
156:     case claims["firebase"]["sign_in_provider"] do
157:       "password" -> "email"
158:       "google.com" -> "google"
159:       provider -> provider
160:     end
161:   rescue
162:     _ -> "unknown"
163:   end
164: end
````

## File: lib/hellen/gamification/user_achievement.ex
````elixir
 1: defmodule Hellen.Gamification.UserAchievement do
 2:   @moduledoc """
 3:   Schema for tracking user achievements (badges unlocked).
 4:   """
 5:   use Ecto.Schema
 6:   import Ecto.Changeset
 7: 
 8:   @primary_key {:id, :binary_id, autogenerate: true}
 9:   @foreign_key_type :binary_id
10: 
11:   schema "user_achievements" do
12:     field :achievement_key, :string
13:     field :unlocked_at, :utc_datetime
14: 
15:     belongs_to :user, Hellen.Accounts.User
16: 
17:     timestamps(type: :utc_datetime)
18:   end
19: 
20:   @doc false
21:   def changeset(user_achievement, attrs) do
22:     user_achievement
23:     |> cast(attrs, [:user_id, :achievement_key, :unlocked_at])
24:     |> validate_required([:user_id, :achievement_key, :unlocked_at])
25:     |> unique_constraint([:user_id, :achievement_key])
26:     |> foreign_key_constraint(:user_id)
27:   end
28: end
````

## File: lib/hellen/lessons/transcription.ex
````elixir
 1: defmodule Hellen.Lessons.Transcription do
 2:   @moduledoc """
 3:   Schema for lesson transcriptions with full text, segments, and confidence score.
 4:   """
 5:   use Ecto.Schema
 6:   import Ecto.Changeset
 7: 
 8:   @primary_key {:id, :binary_id, autogenerate: true}
 9:   @foreign_key_type :binary_id
10: 
11:   schema "transcriptions" do
12:     field :full_text, :string
13:     field :language, :string, default: "pt-BR"
14:     field :confidence_score, :float
15:     field :word_count, :integer
16:     field :segments, {:array, :map}, default: []
17: 
18:     belongs_to :lesson, Hellen.Lessons.Lesson
19: 
20:     timestamps(type: :utc_datetime, updated_at: false)
21:   end
22: 
23:   @doc false
24:   def changeset(transcription, attrs) do
25:     transcription
26:     |> cast(attrs, [:full_text, :language, :confidence_score, :word_count, :segments, :lesson_id])
27:     |> validate_required([:lesson_id])
28:     |> unique_constraint(:lesson_id)
29:     |> foreign_key_constraint(:lesson_id)
30:     |> compute_word_count()
31:   end
32: 
33:   defp compute_word_count(changeset) do
34:     case get_change(changeset, :full_text) do
35:       nil -> changeset
36:       text -> put_change(changeset, :word_count, text |> String.split() |> length())
37:     end
38:   end
39: end
````

## File: lib/hellen/notifications/emails.ex
````elixir
  1: defmodule Hellen.Notifications.Emails do
  2:   @moduledoc """
  3:   Email templates for notifications.
  4:   """
  5:   import Swoosh.Email
  6: 
  7:   @from_address {"Hellen AI", "noreply@hellen.ai"}
  8:   @alerts_address {"Hellen AI Alertas", "alertas@hellen.ai"}
  9: 
 10:   @doc "Build email for alert notification"
 11:   def alert_email(user, notification) do
 12:     alert_data = notification.data || %{}
 13: 
 14:     new()
 15:     |> to({user.name || user.email, user.email})
 16:     |> from(@alerts_address)
 17:     |> subject(alert_subject(notification.type, alert_data))
 18:     |> html_body(alert_html(user, notification, alert_data))
 19:     |> text_body(alert_text(user, notification, alert_data))
 20:   end
 21: 
 22:   @doc "Build email for analysis complete notification"
 23:   def analysis_complete_email(user, notification) do
 24:     data = notification.data || %{}
 25: 
 26:     new()
 27:     |> to({user.name || user.email, user.email})
 28:     |> from(@from_address)
 29:     |> subject("Analise Concluida - #{data["lesson_title"] || "Aula"}")
 30:     |> html_body(analysis_complete_html(user, notification, data))
 31:     |> text_body(analysis_complete_text(user, notification, data))
 32:   end
 33: 
 34:   @doc "Build email for weekly summary"
 35:   def weekly_summary_email(user, stats) do
 36:     new()
 37:     |> to({user.name || user.email, user.email})
 38:     |> from(@from_address)
 39:     |> subject("Resumo Semanal - Hellen AI")
 40:     |> html_body(weekly_summary_html(user, stats))
 41:     |> text_body(weekly_summary_text(user, stats))
 42:   end
 43: 
 44:   @doc "Build the appropriate email based on notification type"
 45:   def build_email(notification, user) do
 46:     case notification.type do
 47:       type when type in ~w(alert_critical alert_high) ->
 48:         alert_email(user, notification)
 49: 
 50:       "analysis_complete" ->
 51:         analysis_complete_email(user, notification)
 52: 
 53:       "weekly_summary" ->
 54:         weekly_summary_email(user, notification.data)
 55: 
 56:       _ ->
 57:         nil
 58:     end
 59:   end
 60: 
 61:   # Private helpers
 62: 
 63:   defp alert_subject("alert_critical", data) do
 64:     "[URGENTE] Alerta Critico - #{alert_type_label(data["alert_type"])}"
 65:   end
 66: 
 67:   defp alert_subject("alert_high", data) do
 68:     "[Alerta] #{alert_type_label(data["alert_type"])} Detectado"
 69:   end
 70: 
 71:   defp alert_subject(_type, data) do
 72:     "Alerta - #{alert_type_label(data["alert_type"])}"
 73:   end
 74: 
 75:   defp alert_type_label("verbal_aggression"), do: "Agressao Verbal"
 76:   defp alert_type_label("exclusion"), do: "Exclusao"
 77:   defp alert_type_label("intimidation"), do: "Intimidacao"
 78:   defp alert_type_label("mockery"), do: "Zombaria"
 79:   defp alert_type_label("discrimination"), do: "Discriminacao"
 80:   defp alert_type_label("threat"), do: "Ameaca"
 81:   defp alert_type_label("inappropriate_language"), do: "Linguagem Inapropriada"
 82:   defp alert_type_label(_), do: "Comportamento Inadequado"
 83: 
 84:   defp severity_color("critical"), do: "#dc2626"
 85:   defp severity_color("high"), do: "#ea580c"
 86:   defp severity_color("medium"), do: "#ca8a04"
 87:   defp severity_color(_), do: "#6b7280"
 88: 
 89:   defp alert_html(user, notification, data) do
 90:     severity = data["severity"] || "medium"
 91: 
 92:     """
 93:     <!DOCTYPE html>
 94:     <html>
 95:     <head>
 96:       <meta charset="UTF-8">
 97:       <style>
 98:         body { font-family: 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; }
 99:         .container { max-width: 600px; margin: 0 auto; padding: 20px; }
100:         .header { background: #{severity_color(severity)}; color: white; padding: 20px; border-radius: 8px 8px 0 0; }
101:         .content { background: #f9fafb; padding: 20px; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 8px 8px; }
102:         .alert-box { background: white; border-left: 4px solid #{severity_color(severity)}; padding: 15px; margin: 15px 0; }
103:         .footer { margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #6b7280; }
104:         .btn { display: inline-block; background: #4f46e5; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; }
105:       </style>
106:     </head>
107:     <body>
108:       <div class="container">
109:         <div class="header">
110:           <h1 style="margin: 0; font-size: 20px;">#{notification.title}</h1>
111:         </div>
112:         <div class="content">
113:           <p>Ola, #{user.name || "Professor(a)"}!</p>
114:           <p>#{notification.message}</p>
115: 
116:           <div class="alert-box">
117:             <p><strong>Tipo:</strong> #{alert_type_label(data["alert_type"])}</p>
118:             <p><strong>Severidade:</strong> #{String.capitalize(severity)}</p>
119:             #{if data["lesson_title"], do: "<p><strong>Aula:</strong> #{data["lesson_title"]}</p>", else: ""}
120:             #{if data["evidence_text"], do: "<p><strong>Evidencia:</strong> \"#{data["evidence_text"]}\"</p>", else: ""}
121:           </div>
122: 
123:           <p>
124:             <a href="#{data["alert_url"] || "#"}" class="btn">Ver Detalhes</a>
125:           </p>
126: 
127:           <div class="footer">
128:             <p>Este email foi enviado automaticamente pelo sistema Hellen AI.</p>
129:             <p>Conforme a Lei 13.185/2015 (Programa de Combate ao Bullying), alertas de comportamento inadequado devem ser tratados com prioridade.</p>
130:           </div>
131:         </div>
132:       </div>
133:     </body>
134:     </html>
135:     """
136:   end
137: 
138:   defp alert_text(user, notification, data) do
139:     """
140:     #{notification.title}
141: 
142:     Ola, #{user.name || "Professor(a)"}!
143: 
144:     #{notification.message}
145: 
146:     Tipo: #{alert_type_label(data["alert_type"])}
147:     Severidade: #{data["severity"] || "medium"}
148:     #{if data["lesson_title"], do: "Aula: #{data["lesson_title"]}", else: ""}
149:     #{if data["evidence_text"], do: "Evidencia: \"#{data["evidence_text"]}\"", else: ""}
150: 
151:     --
152:     Este email foi enviado automaticamente pelo sistema Hellen AI.
153:     """
154:   end
155: 
156:   defp analysis_complete_html(user, _notification, data) do
157:     score = data["score"] || 0
158: 
159:     """
160:     <!DOCTYPE html>
161:     <html>
162:     <head>
163:       <meta charset="UTF-8">
164:       <style>
165:         body { font-family: 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; }
166:         .container { max-width: 600px; margin: 0 auto; padding: 20px; }
167:         .header { background: #4f46e5; color: white; padding: 20px; border-radius: 8px 8px 0 0; }
168:         .content { background: #f9fafb; padding: 20px; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 8px 8px; }
169:         .score { font-size: 48px; font-weight: bold; color: #4f46e5; text-align: center; }
170:         .footer { margin-top: 20px; font-size: 12px; color: #6b7280; }
171:         .btn { display: inline-block; background: #4f46e5; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; }
172:       </style>
173:     </head>
174:     <body>
175:       <div class="container">
176:         <div class="header">
177:           <h1 style="margin: 0; font-size: 20px;">Analise Concluida</h1>
178:         </div>
179:         <div class="content">
180:           <p>Ola, #{user.name || "Professor(a)"}!</p>
181:           <p>A analise da sua aula <strong>#{data["lesson_title"] || "Aula"}</strong> foi concluida.</p>
182: 
183:           <div class="score">#{Float.round(score / 1, 1)}</div>
184:           <p style="text-align: center; color: #6b7280;">Score Pedagogico</p>
185: 
186:           <p style="text-align: center;">
187:             <a href="#{data["analysis_url"] || "#"}" class="btn">Ver Analise Completa</a>
188:           </p>
189: 
190:           <div class="footer">
191:             <p>Este email foi enviado automaticamente pelo sistema Hellen AI.</p>
192:           </div>
193:         </div>
194:       </div>
195:     </body>
196:     </html>
197:     """
198:   end
199: 
200:   defp analysis_complete_text(user, _notification, data) do
201:     """
202:     Analise Concluida
203: 
204:     Ola, #{user.name || "Professor(a)"}!
205: 
206:     A analise da sua aula "#{data["lesson_title"] || "Aula"}" foi concluida.
207: 
208:     Score Pedagogico: #{data["score"] || 0}
209: 
210:     Acesse a plataforma para ver a analise completa.
211: 
212:     --
213:     Este email foi enviado automaticamente pelo sistema Hellen AI.
214:     """
215:   end
216: 
217:   defp weekly_summary_html(user, stats) do
218:     """
219:     <!DOCTYPE html>
220:     <html>
221:     <head>
222:       <meta charset="UTF-8">
223:       <style>
224:         body { font-family: 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; }
225:         .container { max-width: 600px; margin: 0 auto; padding: 20px; }
226:         .header { background: #4f46e5; color: white; padding: 20px; border-radius: 8px 8px 0 0; }
227:         .content { background: #f9fafb; padding: 20px; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 8px 8px; }
228:         .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0; }
229:         .stat-card { background: white; padding: 15px; border-radius: 8px; text-align: center; }
230:         .stat-value { font-size: 32px; font-weight: bold; color: #4f46e5; }
231:         .stat-label { font-size: 14px; color: #6b7280; }
232:         .footer { margin-top: 20px; font-size: 12px; color: #6b7280; }
233:       </style>
234:     </head>
235:     <body>
236:       <div class="container">
237:         <div class="header">
238:           <h1 style="margin: 0; font-size: 20px;">Resumo Semanal</h1>
239:         </div>
240:         <div class="content">
241:           <p>Ola, #{user.name || "Usuario"}!</p>
242:           <p>Confira o resumo da ultima semana:</p>
243: 
244:           <div class="stats-grid">
245:             <div class="stat-card">
246:               <div class="stat-value">#{stats["lessons"] || 0}</div>
247:               <div class="stat-label">Aulas</div>
248:             </div>
249:             <div class="stat-card">
250:               <div class="stat-value">#{stats["analyses"] || 0}</div>
251:               <div class="stat-label">Analises</div>
252:             </div>
253:             <div class="stat-card">
254:               <div class="stat-value">#{stats["alerts"] || 0}</div>
255:               <div class="stat-label">Alertas</div>
256:             </div>
257:             <div class="stat-card">
258:               <div class="stat-value">#{stats["avg_score"] || "-"}</div>
259:               <div class="stat-label">Score Medio</div>
260:             </div>
261:           </div>
262: 
263:           <div class="footer">
264:             <p>Este email foi enviado automaticamente pelo sistema Hellen AI.</p>
265:           </div>
266:         </div>
267:       </div>
268:     </body>
269:     </html>
270:     """
271:   end
272: 
273:   defp weekly_summary_text(user, stats) do
274:     """
275:     Resumo Semanal - Hellen AI
276: 
277:     Ola, #{user.name || "Usuario"}!
278: 
279:     Confira o resumo da ultima semana:
280: 
281:     - Aulas: #{stats["lessons"] || 0}
282:     - Analises: #{stats["analyses"] || 0}
283:     - Alertas: #{stats["alerts"] || 0}
284:     - Score Medio: #{stats["avg_score"] || "-"}
285: 
286:     --
287:     Este email foi enviado automaticamente pelo sistema Hellen AI.
288:     """
289:   end
290: end
````

## File: lib/hellen/notifications/mailer.ex
````elixir
1: defmodule Hellen.Notifications.Mailer do
2:   @moduledoc """
3:   Mailer for sending notification emails using Swoosh.
4:   """
5:   use Swoosh.Mailer, otp_app: :hellen
6: end
````

## File: lib/hellen/notifications/notification.ex
````elixir
 1: defmodule Hellen.Notifications.Notification do
 2:   @moduledoc """
 3:   Schema for notifications sent to users.
 4: 
 5:   Types:
 6:   - alert_critical: Critical bullying alert
 7:   - alert_high: High severity alert
 8:   - alert_medium: Medium severity alert
 9:   - alert_low: Low severity alert
10:   - analysis_complete: Analysis finished
11:   - daily_summary: Daily summary (coordinators)
12:   - weekly_summary: Weekly summary
13:   """
14:   use Ecto.Schema
15:   import Ecto.Changeset
16: 
17:   @primary_key {:id, :binary_id, autogenerate: true}
18:   @foreign_key_type :binary_id
19: 
20:   @notification_types ~w(
21:     alert_critical
22:     alert_high
23:     alert_medium
24:     alert_low
25:     analysis_complete
26:     daily_summary
27:     weekly_summary
28:   )
29: 
30:   schema "notifications" do
31:     field :type, :string
32:     field :title, :string
33:     field :message, :string
34:     field :data, :map, default: %{}
35:     field :read_at, :utc_datetime
36:     field :email_sent_at, :utc_datetime
37: 
38:     belongs_to :user, Hellen.Accounts.User
39:     belongs_to :institution, Hellen.Accounts.Institution
40: 
41:     timestamps()
42:   end
43: 
44:   @doc false
45:   def changeset(notification, attrs) do
46:     notification
47:     |> cast(attrs, [
48:       :type,
49:       :title,
50:       :message,
51:       :data,
52:       :read_at,
53:       :email_sent_at,
54:       :user_id,
55:       :institution_id
56:     ])
57:     |> validate_required([:type, :title, :message, :user_id])
58:     |> validate_inclusion(:type, @notification_types)
59:     |> foreign_key_constraint(:user_id)
60:     |> foreign_key_constraint(:institution_id)
61:   end
62: 
63:   @doc "Mark notification as read"
64:   def mark_read_changeset(notification) do
65:     notification
66:     |> change(read_at: DateTime.utc_now() |> DateTime.truncate(:second))
67:   end
68: 
69:   @doc "Mark email as sent"
70:   def mark_email_sent_changeset(notification) do
71:     notification
72:     |> change(email_sent_at: DateTime.utc_now() |> DateTime.truncate(:second))
73:   end
74: 
75:   def notification_types, do: @notification_types
76: end
````

## File: lib/hellen/notifications/preference.ex
````elixir
 1: defmodule Hellen.Notifications.Preference do
 2:   @moduledoc """
 3:   Schema for user notification preferences.
 4:   Controls which notifications users receive via email and in-app.
 5:   """
 6:   use Ecto.Schema
 7:   import Ecto.Changeset
 8: 
 9:   @primary_key {:id, :binary_id, autogenerate: true}
10:   @foreign_key_type :binary_id
11: 
12:   schema "notification_preferences" do
13:     # Email preferences
14:     field :email_critical_alerts, :boolean, default: true
15:     field :email_high_alerts, :boolean, default: true
16:     field :email_analysis_complete, :boolean, default: false
17:     field :email_daily_summary, :boolean, default: false
18:     field :email_weekly_summary, :boolean, default: true
19: 
20:     # In-app preferences
21:     field :inapp_all_alerts, :boolean, default: true
22:     field :inapp_analysis_complete, :boolean, default: true
23: 
24:     belongs_to :user, Hellen.Accounts.User
25: 
26:     timestamps()
27:   end
28: 
29:   @doc false
30:   def changeset(preference, attrs) do
31:     preference
32:     |> cast(attrs, [
33:       :email_critical_alerts,
34:       :email_high_alerts,
35:       :email_analysis_complete,
36:       :email_daily_summary,
37:       :email_weekly_summary,
38:       :inapp_all_alerts,
39:       :inapp_analysis_complete,
40:       :user_id
41:     ])
42:     |> validate_required([:user_id])
43:     |> unique_constraint(:user_id)
44:     |> foreign_key_constraint(:user_id)
45:   end
46: 
47:   @doc "Check if user should receive email for notification type"
48:   def should_email?(%__MODULE__{} = pref, "alert_critical"), do: pref.email_critical_alerts
49:   def should_email?(%__MODULE__{} = pref, "alert_high"), do: pref.email_high_alerts
50:   def should_email?(%__MODULE__{} = pref, "analysis_complete"), do: pref.email_analysis_complete
51:   def should_email?(%__MODULE__{} = pref, "daily_summary"), do: pref.email_daily_summary
52:   def should_email?(%__MODULE__{} = pref, "weekly_summary"), do: pref.email_weekly_summary
53:   def should_email?(_pref, _type), do: false
54: 
55:   @doc "Check if user should receive in-app notification for type"
56:   def should_inapp?(%__MODULE__{} = pref, type)
57:       when type in ~w(alert_critical alert_high alert_medium alert_low) do
58:     pref.inapp_all_alerts
59:   end
60: 
61:   def should_inapp?(%__MODULE__{} = pref, "analysis_complete"), do: pref.inapp_analysis_complete
62:   def should_inapp?(_pref, _type), do: true
63: end
````

## File: lib/hellen/plannings/planning.ex
````elixir
  1: defmodule Hellen.Plannings.Planning do
  2:   @moduledoc """
  3:   Schema for lesson plannings.
  4: 
  5:   Plannings can be created manually or generated from lesson transcriptions using AI.
  6:   They include objectives, BNCC alignments, methodology, and assessment criteria.
  7:   """
  8: 
  9:   use Ecto.Schema
 10:   import Ecto.Changeset
 11: 
 12:   alias Hellen.Accounts.{Institution, User}
 13:   alias Hellen.Lessons.Lesson
 14: 
 15:   @primary_key {:id, :binary_id, autogenerate: true}
 16:   @foreign_key_type :binary_id
 17: 
 18:   @statuses ~w(draft published archived)
 19:   @subjects ~w(
 20:     portugues matematica ciencias historia geografia
 21:     arte educacao_fisica ingles espanhol
 22:     ensino_religioso educacao_infantil
 23:   )
 24:   @grade_levels ~w(
 25:     infantil_1 infantil_2 infantil_3 infantil_4 infantil_5
 26:     1_ano 2_ano 3_ano 4_ano 5_ano
 27:     6_ano 7_ano 8_ano 9_ano
 28:     1_em 2_em 3_em
 29:     eja_fundamental eja_medio
 30:   )
 31: 
 32:   schema "plannings" do
 33:     field :title, :string
 34:     field :description, :string
 35:     field :subject, :string
 36:     field :grade_level, :string
 37:     field :duration_minutes, :integer
 38:     field :objectives, {:array, :string}, default: []
 39:     field :bncc_codes, {:array, :string}, default: []
 40:     field :content, :map, default: %{}
 41:     field :materials, {:array, :string}, default: []
 42:     field :methodology, :string
 43:     field :assessment_criteria, :string
 44:     field :status, :string, default: "draft"
 45:     field :generated_by_ai, :boolean, default: false
 46:     field :embeddings_indexed, :boolean, default: false
 47:     field :metadata, :map, default: %{}
 48: 
 49:     belongs_to :user, User
 50:     belongs_to :institution, Institution
 51:     belongs_to :source_lesson, Lesson
 52: 
 53:     timestamps(type: :utc_datetime)
 54:   end
 55: 
 56:   @required_fields ~w(title subject grade_level user_id)a
 57:   @optional_fields ~w(
 58:     description duration_minutes objectives bncc_codes content
 59:     materials methodology assessment_criteria status generated_by_ai
 60:     embeddings_indexed metadata institution_id source_lesson_id
 61:   )a
 62: 
 63:   def changeset(planning, attrs) do
 64:     planning
 65:     |> cast(attrs, @required_fields ++ @optional_fields)
 66:     |> validate_required(@required_fields)
 67:     |> validate_inclusion(:status, @statuses)
 68:     |> validate_inclusion(:subject, @subjects)
 69:     |> validate_inclusion(:grade_level, @grade_levels)
 70:     |> validate_number(:duration_minutes, greater_than: 0)
 71:     |> foreign_key_constraint(:user_id)
 72:     |> foreign_key_constraint(:institution_id)
 73:     |> foreign_key_constraint(:source_lesson_id)
 74:   end
 75: 
 76:   def create_changeset(planning, attrs) do
 77:     planning
 78:     |> changeset(attrs)
 79:     |> put_change(:status, "draft")
 80:   end
 81: 
 82:   def publish_changeset(planning) do
 83:     planning
 84:     |> change(%{status: "published"})
 85:   end
 86: 
 87:   def archive_changeset(planning) do
 88:     planning
 89:     |> change(%{status: "archived"})
 90:   end
 91: 
 92:   def mark_indexed_changeset(planning) do
 93:     planning
 94:     |> change(%{embeddings_indexed: true})
 95:   end
 96: 
 97:   # Content structure for AI-generated plannings
 98:   @doc """
 99:   Expected content structure:
100:   %{
101:     "introduction" => "Contextualização inicial...",
102:     "development" => [
103:       %{"step" => 1, "activity" => "...", "duration_minutes" => 10},
104:       %{"step" => 2, "activity" => "...", "duration_minutes" => 15}
105:     ],
106:     "closure" => "Atividade de encerramento...",
107:     "homework" => "Tarefa para casa...",
108:     "adaptations" => "Adaptações para alunos com necessidades especiais...",
109:     "cross_curricular" => ["Arte", "Ciências"]
110:   }
111:   """
112:   def content_template do
113:     %{
114:       "introduction" => "",
115:       "development" => [],
116:       "closure" => "",
117:       "homework" => "",
118:       "adaptations" => "",
119:       "cross_curricular" => []
120:     }
121:   end
122: 
123:   # Helper functions
124:   def statuses, do: @statuses
125:   def subjects, do: @subjects
126:   def grade_levels, do: @grade_levels
127: 
128:   def subject_label(subject) do
129:     %{
130:       "portugues" => "Língua Portuguesa",
131:       "matematica" => "Matemática",
132:       "ciencias" => "Ciências",
133:       "historia" => "História",
134:       "geografia" => "Geografia",
135:       "arte" => "Arte",
136:       "educacao_fisica" => "Educação Física",
137:       "ingles" => "Língua Inglesa",
138:       "espanhol" => "Língua Espanhola",
139:       "ensino_religioso" => "Ensino Religioso",
140:       "educacao_infantil" => "Educação Infantil"
141:     }[subject] || subject
142:   end
143: 
144:   def grade_level_label(level) do
145:     %{
146:       "infantil_1" => "Infantil 1",
147:       "infantil_2" => "Infantil 2",
148:       "infantil_3" => "Infantil 3",
149:       "infantil_4" => "Infantil 4",
150:       "infantil_5" => "Infantil 5",
151:       "1_ano" => "1º Ano",
152:       "2_ano" => "2º Ano",
153:       "3_ano" => "3º Ano",
154:       "4_ano" => "4º Ano",
155:       "5_ano" => "5º Ano",
156:       "6_ano" => "6º Ano",
157:       "7_ano" => "7º Ano",
158:       "8_ano" => "8º Ano",
159:       "9_ano" => "9º Ano",
160:       "1_em" => "1º Médio",
161:       "2_em" => "2º Médio",
162:       "3_em" => "3º Médio",
163:       "eja_fundamental" => "EJA Fundamental",
164:       "eja_medio" => "EJA Médio"
165:     }[level] || level
166:   end
167: 
168:   def status_label(status) do
169:     %{
170:       "draft" => "Rascunho",
171:       "published" => "Publicado",
172:       "archived" => "Arquivado"
173:     }[status] || status
174:   end
175: end
````

## File: lib/hellen/storage/behaviour.ex
````elixir
 1: defmodule Hellen.Storage.Behaviour do
 2:   @moduledoc """
 3:   Behaviour for storage implementations.
 4:   Allows mocking file storage in tests.
 5:   """
 6: 
 7:   @doc "Upload a file to storage"
 8:   @callback upload(path :: String.t(), content :: binary(), opts :: keyword()) ::
 9:               {:ok, url :: String.t()} | {:error, term()}
10: 
11:   @doc "Download a file from storage"
12:   @callback download(url :: String.t()) ::
13:               {:ok, binary()} | {:error, term()}
14: 
15:   @doc "Delete a file from storage"
16:   @callback delete(url :: String.t()) ::
17:               :ok | {:error, term()}
18: 
19:   @doc "Generate a presigned URL for upload"
20:   @callback presigned_url(path :: String.t(), opts :: keyword()) ::
21:               {:ok, url :: String.t()} | {:error, term()}
22: end
````

## File: lib/hellen/workers/cleanup_job.ex
````elixir
 1: defmodule Hellen.Workers.CleanupJob do
 2:   @moduledoc """
 3:   Periodic cleanup job that runs daily to maintain database health.
 4:   Handles cleanup of old Oban job records and temporary data.
 5:   """
 6:   use Oban.Worker, queue: :default, max_attempts: 3
 7: 
 8:   require Logger
 9: 
10:   @impl Oban.Worker
11:   def perform(_job) do
12:     Logger.info("[CleanupJob] Starting daily cleanup")
13: 
14:     # Oban.Plugins.Pruner already handles job cleanup
15:     # Add any additional cleanup tasks here
16: 
17:     # Example: Clean up stale upload records older than 30 days
18:     cleanup_stale_uploads()
19: 
20:     Logger.info("[CleanupJob] Daily cleanup completed")
21:     :ok
22:   end
23: 
24:   defp cleanup_stale_uploads do
25:     # Placeholder for future cleanup logic
26:     # Could clean up orphaned files, expired sessions, etc.
27:     :ok
28:   end
29: end
````

## File: lib/hellen/workers/notification_job.ex
````elixir
 1: defmodule Hellen.Workers.NotificationJob do
 2:   @moduledoc """
 3:   Oban worker for sending notification emails.
 4:   """
 5:   use Oban.Worker, queue: :notifications, max_attempts: 3
 6: 
 7:   alias Hellen.Notifications
 8: 
 9:   @impl Oban.Worker
10:   def perform(%Oban.Job{args: %{"type" => "send_email", "notification_id" => notification_id}}) do
11:     notification = Notifications.get_notification!(notification_id)
12:     user_id = notification.user_id
13: 
14:     if Notifications.should_send_email?(user_id, notification.type) do
15:       case Notifications.send_notification_email(notification) do
16:         {:ok, _} -> :ok
17:         {:error, reason} -> {:error, reason}
18:       end
19:     else
20:       :ok
21:     end
22:   end
23: 
24:   def perform(%Oban.Job{args: args}) do
25:     require Logger
26:     Logger.warning("Unknown notification job args: #{inspect(args)}")
27:     :ok
28:   end
29: end
````

## File: lib/hellen/assessments.ex
````elixir
  1: defmodule Hellen.Assessments do
  2:   @moduledoc """
  3:   Context for managing assessments (provas, atividades, avaliações).
  4: 
  5:   Features:
  6:   - CRUD operations for assessments
  7:   - Question management
  8:   - AI-powered generation from plannings
  9:   - Semantic search via Qdrant
 10:   - Statistics and analytics
 11:   """
 12: 
 13:   import Ecto.Query, warn: false
 14: 
 15:   alias Hellen.AI.Embeddings
 16:   alias Hellen.Assessments.Assessment
 17:   alias Hellen.Repo
 18: 
 19:   # ============================================================================
 20:   # CRUD OPERATIONS
 21:   # ============================================================================
 22: 
 23:   @doc """
 24:   Returns the list of assessments for a user.
 25: 
 26:   ## Options
 27:     * `:status` - Filter by status
 28:     * `:subject` - Filter by subject
 29:     * `:grade_level` - Filter by grade level
 30:     * `:assessment_type` - Filter by type
 31:     * `:difficulty_level` - Filter by difficulty
 32:     * `:search` - Search in title and description
 33:     * `:limit` - Limit results
 34:     * `:offset` - Offset results
 35:   """
 36:   def list_assessments(user_id, opts \\ []) do
 37:     base_query(user_id)
 38:     |> apply_filters(opts)
 39:     |> order_by([a], desc: a.inserted_at)
 40:     |> maybe_limit(opts)
 41:     |> Repo.all()
 42:   end
 43: 
 44:   @doc """
 45:   Gets a single assessment.
 46: 
 47:   Raises `Ecto.NoResultsError` if not found.
 48:   """
 49:   def get_assessment!(id), do: Repo.get!(Assessment, id)
 50: 
 51:   @doc """
 52:   Gets a single assessment for a specific user.
 53:   """
 54:   def get_user_assessment(user_id, assessment_id) do
 55:     Assessment
 56:     |> where([a], a.id == ^assessment_id and a.user_id == ^user_id)
 57:     |> Repo.one()
 58:   end
 59: 
 60:   @doc """
 61:   Gets assessment with all associations preloaded.
 62:   """
 63:   def get_assessment_with_preloads!(id) do
 64:     Assessment
 65:     |> Repo.get!(id)
 66:     |> Repo.preload([:user, :institution, :source_planning])
 67:   end
 68: 
 69:   @doc """
 70:   Creates an assessment.
 71:   """
 72:   def create_assessment(attrs \\ %{}) do
 73:     %Assessment{}
 74:     |> Assessment.changeset(attrs)
 75:     |> Repo.insert()
 76:   end
 77: 
 78:   @doc """
 79:   Creates an assessment from AI generation.
 80:   """
 81:   def create_ai_assessment(attrs \\ %{}) do
 82:     %Assessment{}
 83:     |> Assessment.ai_changeset(attrs)
 84:     |> Repo.insert()
 85:   end
 86: 
 87:   @doc """
 88:   Updates an assessment.
 89:   """
 90:   def update_assessment(%Assessment{} = assessment, attrs) do
 91:     assessment
 92:     |> Assessment.changeset(attrs)
 93:     |> Repo.update()
 94:   end
 95: 
 96:   @doc """
 97:   Deletes an assessment.
 98:   """
 99:   def delete_assessment(%Assessment{} = assessment) do
100:     Repo.delete(assessment)
101:   end
102: 
103:   @doc """
104:   Returns an `%Ecto.Changeset{}` for tracking assessment changes.
105:   """
106:   def change_assessment(%Assessment{} = assessment, attrs \\ %{}) do
107:     Assessment.changeset(assessment, attrs)
108:   end
109: 
110:   # ============================================================================
111:   # STATUS MANAGEMENT
112:   # ============================================================================
113: 
114:   @doc """
115:   Publishes an assessment (makes it active).
116:   """
117:   def publish_assessment(%Assessment{} = assessment) do
118:     assessment
119:     |> Assessment.publish_changeset()
120:     |> Repo.update()
121:   end
122: 
123:   @doc """
124:   Archives an assessment.
125:   """
126:   def archive_assessment(%Assessment{} = assessment) do
127:     assessment
128:     |> Assessment.archive_changeset()
129:     |> Repo.update()
130:   end
131: 
132:   @doc """
133:   Duplicates an assessment with a new title.
134:   """
135:   def duplicate_assessment(%Assessment{} = assessment, user_id) do
136:     attrs =
137:       assessment
138:       |> Map.from_struct()
139:       |> Map.drop([
140:         :id,
141:         :__meta__,
142:         :user,
143:         :institution,
144:         :source_planning,
145:         :inserted_at,
146:         :updated_at
147:       ])
148:       |> Map.put(:title, "#{assessment.title} (cópia)")
149:       |> Map.put(:status, "draft")
150:       |> Map.put(:user_id, user_id)
151: 
152:     create_assessment(attrs)
153:   end
154: 
155:   # ============================================================================
156:   # QUESTION MANAGEMENT
157:   # ============================================================================
158: 
159:   @doc """
160:   Adds a question to an assessment.
161:   """
162:   def add_question(%Assessment{} = assessment, question) do
163:     questions = (assessment.questions || []) ++ [question]
164: 
165:     update_assessment(assessment, %{
166:       questions: questions,
167:       total_points: calculate_total_points(questions)
168:     })
169:   end
170: 
171:   @doc """
172:   Updates a question in an assessment by index.
173:   """
174:   def update_question(%Assessment{} = assessment, index, question) do
175:     questions = List.replace_at(assessment.questions || [], index, question)
176: 
177:     update_assessment(assessment, %{
178:       questions: questions,
179:       total_points: calculate_total_points(questions)
180:     })
181:   end
182: 
183:   @doc """
184:   Removes a question from an assessment by index.
185:   """
186:   def remove_question(%Assessment{} = assessment, index) do
187:     questions = List.delete_at(assessment.questions || [], index)
188: 
189:     update_assessment(assessment, %{
190:       questions: questions,
191:       total_points: calculate_total_points(questions)
192:     })
193:   end
194: 
195:   @doc """
196:   Reorders questions in an assessment.
197:   """
198:   def reorder_questions(%Assessment{} = assessment, new_order) do
199:     questions = assessment.questions || []
200: 
201:     reordered =
202:       new_order
203:       |> Enum.map(fn index -> Enum.at(questions, index) end)
204:       |> Enum.reject(&is_nil/1)
205: 
206:     update_assessment(assessment, %{questions: reordered})
207:   end
208: 
209:   defp calculate_total_points(questions) do
210:     questions
211:     |> Enum.map(fn q -> Decimal.new(to_string(q["points"] || "1")) end)
212:     |> Enum.reduce(Decimal.new("0"), &Decimal.add/2)
213:   end
214: 
215:   # ============================================================================
216:   # STATISTICS
217:   # ============================================================================
218: 
219:   @doc """
220:   Returns assessment counts by status for a user.
221:   """
222:   def count_by_status(user_id) do
223:     Assessment
224:     |> where([a], a.user_id == ^user_id)
225:     |> group_by([a], a.status)
226:     |> select([a], {a.status, count(a.id)})
227:     |> Repo.all()
228:     |> Map.new()
229:   end
230: 
231:   @doc """
232:   Returns assessment counts by type for a user.
233:   """
234:   def count_by_type(user_id) do
235:     Assessment
236:     |> where([a], a.user_id == ^user_id)
237:     |> group_by([a], a.assessment_type)
238:     |> select([a], {a.assessment_type, count(a.id)})
239:     |> Repo.all()
240:     |> Map.new()
241:   end
242: 
243:   @doc """
244:   Returns total assessments and questions count for a user.
245:   """
246:   def get_stats(user_id) do
247:     assessments = list_assessments(user_id)
248: 
249:     total_assessments = length(assessments)
250: 
251:     total_questions =
252:       assessments
253:       |> Enum.map(fn a -> length(a.questions || []) end)
254:       |> Enum.sum()
255: 
256:     %{
257:       total: total_assessments,
258:       total_questions: total_questions,
259:       by_status: count_by_status(user_id),
260:       by_type: count_by_type(user_id)
261:     }
262:   end
263: 
264:   # ============================================================================
265:   # SEMANTIC SEARCH (QDRANT)
266:   # ============================================================================
267: 
268:   @doc """
269:   Searches for similar assessments using semantic search.
270:   """
271:   def search_similar(query, user_id, opts \\ []) do
272:     limit = Keyword.get(opts, :limit, 5)
273: 
274:     case Embeddings.search("assessments", query, limit: limit) do
275:       {:ok, results} ->
276:         # Filter by user and fetch full records
277:         ids =
278:           results
279:           |> Enum.filter(fn r -> r.payload["user_id"] == user_id end)
280:           |> Enum.map(& &1.payload["assessment_id"])
281: 
282:         assessments =
283:           Assessment
284:           |> where([a], a.id in ^ids)
285:           |> Repo.all()
286: 
287:         {:ok, assessments}
288: 
289:       {:error, reason} ->
290:         {:error, reason}
291:     end
292:   end
293: 
294:   @doc """
295:   Indexes an assessment in Qdrant for semantic search.
296:   """
297:   def index_assessment(%Assessment{} = assessment) do
298:     text = build_index_text(assessment)
299: 
300:     payload = %{
301:       "assessment_id" => assessment.id,
302:       "user_id" => assessment.user_id,
303:       "title" => assessment.title,
304:       "subject" => assessment.subject,
305:       "grade_level" => assessment.grade_level,
306:       "assessment_type" => assessment.assessment_type
307:     }
308: 
309:     case Embeddings.index("assessments", assessment.id, text, payload) do
310:       :ok ->
311:         update_assessment(assessment, %{embeddings_indexed: true})
312: 
313:       {:error, reason} ->
314:         {:error, reason}
315:     end
316:   end
317: 
318:   defp build_index_text(assessment) do
319:     questions_text =
320:       (assessment.questions || [])
321:       |> Enum.map_join(" ", fn q -> q["text"] || "" end)
322: 
323:     """
324:     #{assessment.title}
325:     #{assessment.description || ""}
326:     #{Assessment.subject_label(assessment.subject)}
327:     #{Assessment.grade_level_label(assessment.grade_level)}
328:     #{Assessment.assessment_type_label(assessment.assessment_type)}
329:     #{questions_text}
330:     """
331:   end
332: 
333:   # ============================================================================
334:   # PRIVATE HELPERS
335:   # ============================================================================
336: 
337:   defp base_query(user_id) do
338:     from(a in Assessment, where: a.user_id == ^user_id)
339:   end
340: 
341:   defp apply_filters(query, opts) do
342:     query
343:     |> filter_by_status(opts[:status])
344:     |> filter_by_subject(opts[:subject])
345:     |> filter_by_grade_level(opts[:grade_level])
346:     |> filter_by_type(opts[:assessment_type])
347:     |> filter_by_difficulty(opts[:difficulty_level])
348:     |> filter_by_search(opts[:search])
349:   end
350: 
351:   defp filter_by_status(query, nil), do: query
352:   defp filter_by_status(query, status), do: where(query, [a], a.status == ^status)
353: 
354:   defp filter_by_subject(query, nil), do: query
355:   defp filter_by_subject(query, subject), do: where(query, [a], a.subject == ^subject)
356: 
357:   defp filter_by_grade_level(query, nil), do: query
358:   defp filter_by_grade_level(query, level), do: where(query, [a], a.grade_level == ^level)
359: 
360:   defp filter_by_type(query, nil), do: query
361:   defp filter_by_type(query, type), do: where(query, [a], a.assessment_type == ^type)
362: 
363:   defp filter_by_difficulty(query, nil), do: query
364:   defp filter_by_difficulty(query, level), do: where(query, [a], a.difficulty_level == ^level)
365: 
366:   defp filter_by_search(query, nil), do: query
367:   defp filter_by_search(query, ""), do: query
368: 
369:   defp filter_by_search(query, search) do
370:     search_term = "%#{search}%"
371:     where(query, [a], ilike(a.title, ^search_term) or ilike(a.description, ^search_term))
372:   end
373: 
374:   defp maybe_limit(query, opts) do
375:     case opts[:limit] do
376:       nil -> query
377:       limit -> limit(query, ^limit)
378:     end
379:   end
380: end
````

## File: lib/hellen/exports.ex
````elixir
  1: defmodule Hellen.Exports do
  2:   @moduledoc """
  3:   Context for generating CSV exports of analytics data.
  4:   """
  5: 
  6:   alias Hellen.Analysis
  7: 
  8:   @doc """
  9:   Generate CSV content for various export types.
 10: 
 11:   ## Types
 12:   - `:score_history` - Score history for a user
 13:   - `:bncc_coverage` - BNCC coverage details
 14:   - `:alerts` - Bullying alerts (requires institution_id)
 15:   - `:daily_scores` - Daily score averages
 16:   """
 17:   def generate_csv(type, id, opts \\ [])
 18: 
 19:   def generate_csv(:score_history, user_id, opts) do
 20:     analyses = Analysis.list_analyses_for_export(user_id, opts)
 21: 
 22:     headers = ["Data", "Aula", "Score", "Competencias BNCC", "Alertas"]
 23: 
 24:     rows =
 25:       Enum.map(analyses, fn analysis ->
 26:         [
 27:           format_date(analysis.inserted_at),
 28:           analysis.lesson.title,
 29:           format_score(analysis.overall_score),
 30:           length(analysis.bncc_matches),
 31:           length(analysis.bullying_alerts)
 32:         ]
 33:       end)
 34: 
 35:     build_csv(headers, rows)
 36:   end
 37: 
 38:   def generate_csv(:bncc_coverage, user_id, opts) do
 39:     coverage = Analysis.get_bncc_coverage_detailed(user_id, opts)
 40: 
 41:     headers = [
 42:       "Codigo",
 43:       "Competencia",
 44:       "Categoria",
 45:       "Ocorrencias",
 46:       "Score Medio",
 47:       "Score Min",
 48:       "Score Max"
 49:     ]
 50: 
 51:     rows =
 52:       Enum.map(coverage, fn item ->
 53:         [
 54:           item.code || "N/A",
 55:           item.name || "N/A",
 56:           item.category,
 57:           item.count,
 58:           format_score(item.avg_score),
 59:           format_score(item.min_score),
 60:           format_score(item.max_score)
 61:         ]
 62:       end)
 63: 
 64:     build_csv(headers, rows)
 65:   end
 66: 
 67:   def generate_csv(:alerts, institution_id, opts) do
 68:     alerts = Analysis.list_alerts_by_institution(institution_id, opts)
 69: 
 70:     headers = ["Data", "Aula", "Tipo", "Severidade", "Descricao", "Status"]
 71: 
 72:     rows =
 73:       Enum.map(alerts, fn alert ->
 74:         [
 75:           format_date(alert.inserted_at),
 76:           alert.analysis.lesson.title,
 77:           translate_alert_type(alert.alert_type),
 78:           translate_severity(alert.severity),
 79:           alert.description || "N/A",
 80:           if(alert.reviewed, do: "Revisado", else: "Pendente")
 81:         ]
 82:       end)
 83: 
 84:     build_csv(headers, rows)
 85:   end
 86: 
 87:   def generate_csv(:daily_scores, user_id, opts) do
 88:     scores = Analysis.get_daily_scores(user_id, opts)
 89: 
 90:     headers = ["Data", "Score Medio", "Quantidade de Analises"]
 91: 
 92:     rows =
 93:       Enum.map(scores, fn item ->
 94:         [
 95:           Date.to_string(item.date),
 96:           format_score(item.avg_score),
 97:           item.count
 98:         ]
 99:       end)
100: 
101:     build_csv(headers, rows)
102:   end
103: 
104:   defp build_csv(headers, rows) do
105:     header_line = Enum.join(headers, ",")
106: 
107:     data_lines =
108:       Enum.map(rows, fn row ->
109:         Enum.map_join(row, ",", &escape_csv_field/1)
110:       end)
111: 
112:     Enum.join([header_line | data_lines], "\n")
113:   end
114: 
115:   defp escape_csv_field(nil), do: ""
116:   defp escape_csv_field(value) when is_number(value), do: to_string(value)
117: 
118:   defp escape_csv_field(value) when is_binary(value) do
119:     if String.contains?(value, [",", "\"", "\n"]) do
120:       "\"" <> String.replace(value, "\"", "\"\"") <> "\""
121:     else
122:       value
123:     end
124:   end
125: 
126:   defp escape_csv_field(value), do: to_string(value)
127: 
128:   defp format_date(nil), do: "N/A"
129:   defp format_date(%DateTime{} = dt), do: Calendar.strftime(dt, "%d/%m/%Y %H:%M")
130:   defp format_date(%NaiveDateTime{} = dt), do: Calendar.strftime(dt, "%d/%m/%Y %H:%M")
131:   defp format_date(date), do: to_string(date)
132: 
133:   defp format_score(nil), do: "N/A"
134: 
135:   defp format_score(score) when is_float(score) do
136:     score |> Float.round(2) |> to_string()
137:   end
138: 
139:   defp format_score(score) when is_integer(score) do
140:     to_string(score)
141:   end
142: 
143:   defp format_score(%Decimal{} = score) do
144:     score |> Decimal.round(2) |> Decimal.to_string()
145:   end
146: 
147:   defp translate_alert_type("bullying"), do: "Bullying"
148:   defp translate_alert_type("harassment"), do: "Assedio"
149:   defp translate_alert_type("discrimination"), do: "Discriminacao"
150:   defp translate_alert_type("violence"), do: "Violencia"
151:   defp translate_alert_type(type), do: type || "N/A"
152: 
153:   defp translate_severity("high"), do: "Alta"
154:   defp translate_severity("medium"), do: "Media"
155:   defp translate_severity("low"), do: "Baixa"
156:   defp translate_severity(sev), do: sev || "N/A"
157: end
````

## File: lib/hellen/gamification.ex
````elixir
  1: defmodule Hellen.Gamification do
  2:   @moduledoc """
  3:   Gamification context for achievements, badges, and XP system.
  4:   Motivates teachers through achievements and progress tracking.
  5:   """
  6: 
  7:   import Ecto.Query
  8: 
  9:   alias Hellen.Accounts.User
 10:   alias Hellen.Gamification.UserAchievement
 11:   alias Hellen.Lessons
 12:   alias Hellen.Repo
 13: 
 14:   # XP rewards for actions
 15:   @xp_first_lesson 50
 16:   @xp_per_level 100
 17: 
 18:   # Achievement definitions
 19:   @achievements %{
 20:     # Lesson milestones
 21:     "first_lesson" => %{
 22:       name: "Primeira Aula",
 23:       description: "Enviou sua primeira aula para analise",
 24:       icon: "hero-academic-cap",
 25:       color: "teal",
 26:       xp: @xp_first_lesson,
 27:       category: :lessons
 28:     },
 29:     "lesson_explorer" => %{
 30:       name: "Explorador",
 31:       description: "Enviou 5 aulas para analise",
 32:       icon: "hero-map",
 33:       color: "emerald",
 34:       xp: 100,
 35:       category: :lessons
 36:     },
 37:     "lesson_master" => %{
 38:       name: "Mestre das Aulas",
 39:       description: "Enviou 25 aulas para analise",
 40:       icon: "hero-trophy",
 41:       color: "amber",
 42:       xp: 250,
 43:       category: :lessons
 44:     },
 45:     "lesson_legend" => %{
 46:       name: "Lenda Pedagogica",
 47:       description: "Enviou 100 aulas para analise",
 48:       icon: "hero-star",
 49:       color: "violet",
 50:       xp: 500,
 51:       category: :lessons
 52:     },
 53: 
 54:     # Analysis achievements
 55:     "first_analysis" => %{
 56:       name: "Primeiro Insight",
 57:       description: "Recebeu sua primeira analise completa",
 58:       icon: "hero-light-bulb",
 59:       color: "cyan",
 60:       xp: 30,
 61:       category: :analysis
 62:     },
 63:     "score_champion" => %{
 64:       name: "Nota Alta",
 65:       description: "Obteve score acima de 90% em uma analise",
 66:       icon: "hero-chart-bar",
 67:       color: "emerald",
 68:       xp: 50,
 69:       category: :analysis
 70:     },
 71:     "consistent_quality" => %{
 72:       name: "Qualidade Consistente",
 73:       description: "Manteve score acima de 80% em 5 aulas consecutivas",
 74:       icon: "hero-check-badge",
 75:       color: "teal",
 76:       xp: 100,
 77:       category: :analysis
 78:     },
 79: 
 80:     # BNCC achievements
 81:     "bncc_aligned" => %{
 82:       name: "Alinhado a BNCC",
 83:       description: "Teve competencias BNCC identificadas em 10 aulas",
 84:       icon: "hero-document-check",
 85:       color: "violet",
 86:       xp: 75,
 87:       category: :bncc
 88:     },
 89:     "bncc_expert" => %{
 90:       name: "Expert BNCC",
 91:       description: "Cobriu 5 diferentes competencias da BNCC",
 92:       icon: "hero-puzzle-piece",
 93:       color: "purple",
 94:       xp: 150,
 95:       category: :bncc
 96:     },
 97: 
 98:     # Engagement achievements
 99:     "early_adopter" => %{
100:       name: "Early Adopter",
101:       description: "Um dos primeiros a usar o Hellen AI",
102:       icon: "hero-rocket-launch",
103:       color: "orange",
104:       xp: 100,
105:       category: :special
106:     },
107:     "weekly_streak" => %{
108:       name: "Semana Produtiva",
109:       description: "Enviou aulas por 7 dias consecutivos",
110:       icon: "hero-fire",
111:       color: "red",
112:       xp: 75,
113:       category: :engagement
114:     },
115:     "complete_profile" => %{
116:       name: "Perfil Completo",
117:       description: "Completou o onboarding e configurou seu perfil",
118:       icon: "hero-user-circle",
119:       color: "blue",
120:       xp: 25,
121:       category: :profile
122:     }
123:   }
124: 
125:   @doc """
126:   Returns all available achievement definitions.
127:   """
128:   def list_achievement_definitions do
129:     @achievements
130:   end
131: 
132:   @doc """
133:   Returns achievement definition by key.
134:   """
135:   def get_achievement_definition(key) do
136:     Map.get(@achievements, key)
137:   end
138: 
139:   @doc """
140:   Lists all achievements for a user (unlocked only).
141:   """
142:   def list_user_achievements(user_id) do
143:     UserAchievement
144:     |> where([ua], ua.user_id == ^user_id)
145:     |> order_by([ua], desc: ua.unlocked_at)
146:     |> Repo.all()
147:     |> Enum.map(fn ua ->
148:       Map.put(ua, :definition, get_achievement_definition(ua.achievement_key))
149:     end)
150:   end
151: 
152:   @doc """
153:   Returns user's achievement progress (unlocked + locked with progress).
154:   """
155:   def get_user_achievement_progress(user_id) do
156:     unlocked_keys =
157:       UserAchievement
158:       |> where([ua], ua.user_id == ^user_id)
159:       |> select([ua], ua.achievement_key)
160:       |> Repo.all()
161:       |> MapSet.new()
162: 
163:     lesson_count = Lessons.count_lessons_by_user(user_id)
164:     # completed_count = Lessons.count_completed_lessons_by_user(user_id)
165: 
166:     @achievements
167:     |> Enum.map(fn {key, definition} ->
168:       unlocked = MapSet.member?(unlocked_keys, key)
169: 
170:       progress =
171:         cond do
172:           unlocked -> 100
173:           key == "first_lesson" -> if lesson_count >= 1, do: 100, else: 0
174:           key == "lesson_explorer" -> min(lesson_count / 5 * 100, 100) |> round()
175:           key == "lesson_master" -> min(lesson_count / 25 * 100, 100) |> round()
176:           key == "lesson_legend" -> min(lesson_count / 100 * 100, 100) |> round()
177:           true -> 0
178:         end
179: 
180:       %{
181:         key: key,
182:         definition: definition,
183:         unlocked: unlocked,
184:         progress: progress
185:       }
186:     end)
187:     |> Enum.sort_by(fn a -> {!a.unlocked, -a.progress, a.definition.name} end)
188:   end
189: 
190:   @doc """
191:   Unlocks an achievement for a user if not already unlocked.
192:   Returns {:ok, achievement} or {:already_unlocked, nil}.
193:   """
194:   def unlock_achievement(user_id, achievement_key) do
195:     if get_achievement_definition(achievement_key) == nil do
196:       {:error, :invalid_achievement}
197:     else
198:       case Repo.get_by(UserAchievement, user_id: user_id, achievement_key: achievement_key) do
199:         nil ->
200:           %UserAchievement{}
201:           |> UserAchievement.changeset(%{
202:             user_id: user_id,
203:             achievement_key: achievement_key,
204:             unlocked_at: DateTime.utc_now()
205:           })
206:           |> Repo.insert()
207: 
208:         _existing ->
209:           {:already_unlocked, nil}
210:       end
211:     end
212:   end
213: 
214:   @doc """
215:   Checks and unlocks achievements based on lesson count.
216:   Called after a new lesson is created.
217:   """
218:   def check_lesson_achievements(user_id) do
219:     lesson_count = Lessons.count_lessons_by_user(user_id)
220: 
221:     newly_unlocked = []
222: 
223:     newly_unlocked =
224:       if lesson_count >= 1 do
225:         case unlock_achievement(user_id, "first_lesson") do
226:           {:ok, achievement} -> [achievement | newly_unlocked]
227:           _ -> newly_unlocked
228:         end
229:       else
230:         newly_unlocked
231:       end
232: 
233:     newly_unlocked =
234:       if lesson_count >= 5 do
235:         case unlock_achievement(user_id, "lesson_explorer") do
236:           {:ok, achievement} -> [achievement | newly_unlocked]
237:           _ -> newly_unlocked
238:         end
239:       else
240:         newly_unlocked
241:       end
242: 
243:     newly_unlocked =
244:       if lesson_count >= 25 do
245:         case unlock_achievement(user_id, "lesson_master") do
246:           {:ok, achievement} -> [achievement | newly_unlocked]
247:           _ -> newly_unlocked
248:         end
249:       else
250:         newly_unlocked
251:       end
252: 
253:     newly_unlocked =
254:       if lesson_count >= 100 do
255:         case unlock_achievement(user_id, "lesson_legend") do
256:           {:ok, achievement} -> [achievement | newly_unlocked]
257:           _ -> newly_unlocked
258:         end
259:       else
260:         newly_unlocked
261:       end
262: 
263:     # Award XP for newly unlocked achievements
264:     Enum.each(newly_unlocked, fn achievement ->
265:       definition = get_achievement_definition(achievement.achievement_key)
266:       if definition, do: award_xp(user_id, definition.xp)
267:     end)
268: 
269:     newly_unlocked
270:   end
271: 
272:   @doc """
273:   Awards XP to a user and levels up if needed.
274:   """
275:   def award_xp(user_id, xp_amount) do
276:     user = Repo.get!(User, user_id)
277:     new_xp = (user.experience_points || 0) + xp_amount
278:     new_level = calculate_level(new_xp)
279: 
280:     user
281:     |> Ecto.Changeset.change(%{
282:       experience_points: new_xp,
283:       level: new_level
284:     })
285:     |> Repo.update()
286:   end
287: 
288:   @doc """
289:   Calculates level based on XP.
290:   """
291:   def calculate_level(xp) do
292:     # Level 1: 0-99 XP
293:     # Level 2: 100-299 XP
294:     # Level 3: 300-599 XP
295:     # Each level requires progressively more XP
296:     level = 1
297:     xp_needed = @xp_per_level
298: 
299:     do_calculate_level(xp, level, xp_needed)
300:   end
301: 
302:   defp do_calculate_level(xp, level, xp_needed) when xp >= xp_needed do
303:     # Next level requires 50% more XP
304:     next_xp_needed = xp_needed + round(@xp_per_level * (level * 0.5))
305:     do_calculate_level(xp - xp_needed, level + 1, next_xp_needed)
306:   end
307: 
308:   defp do_calculate_level(_xp, level, _xp_needed), do: level
309: 
310:   @doc """
311:   Returns XP needed for the next level.
312:   """
313:   def xp_for_next_level(current_level) do
314:     # Same formula as calculate_level
315:     round(@xp_per_level * (1 + (current_level - 1) * 0.5))
316:   end
317: 
318:   @doc """
319:   Returns user's current XP progress towards next level.
320:   """
321:   def get_level_progress(user) do
322:     xp = user.experience_points || 0
323:     level = user.level || 1
324: 
325:     # Calculate XP accumulated in previous levels
326:     xp_in_previous_levels =
327:       Enum.reduce(1..(level - 1)//1, 0, fn l, acc ->
328:         acc + round(@xp_per_level * (1 + (l - 1) * 0.5))
329:       end)
330: 
331:     current_level_xp = xp - xp_in_previous_levels
332:     xp_for_next = xp_for_next_level(level)
333: 
334:     %{
335:       level: level,
336:       current_xp: current_level_xp,
337:       xp_for_next_level: xp_for_next,
338:       total_xp: xp,
339:       progress_percent: min(round(current_level_xp / xp_for_next * 100), 100)
340:     }
341:   end
342: 
343:   @doc """
344:   Returns count of unlocked achievements for a user.
345:   """
346:   def count_user_achievements(user_id) do
347:     UserAchievement
348:     |> where([ua], ua.user_id == ^user_id)
349:     |> Repo.aggregate(:count)
350:   end
351: 
352:   @doc """
353:   Returns total available achievements count.
354:   """
355:   def total_achievements_count do
356:     map_size(@achievements)
357:   end
358: end
````

## File: lib/hellen/notifications.ex
````elixir
  1: defmodule Hellen.Notifications do
  2:   @moduledoc """
  3:   Context for managing notifications.
  4: 
  5:   Handles creating, listing, and managing notifications for users.
  6:   Supports both in-app (PubSub) and email notifications.
  7:   """
  8:   import Ecto.Query
  9: 
 10:   alias Hellen.Accounts
 11:   alias Hellen.Accounts.User
 12:   alias Hellen.Notifications.{Emails, Mailer, Notification, Preference}
 13:   alias Hellen.Repo
 14:   alias Hellen.Workers.NotificationJob
 15: 
 16:   # ============================================================================
 17:   # Notification CRUD
 18:   # ============================================================================
 19: 
 20:   @doc "Get a notification by ID"
 21:   def get_notification!(id), do: Repo.get!(Notification, id)
 22: 
 23:   @doc "Get a notification by ID with user preloaded"
 24:   def get_notification_with_user!(id) do
 25:     Notification
 26:     |> Repo.get!(id)
 27:     |> Repo.preload(:user)
 28:   end
 29: 
 30:   @doc "List notifications for a user"
 31:   def list_user_notifications(user_id, opts \\ []) do
 32:     limit = Keyword.get(opts, :limit, 20)
 33:     offset = Keyword.get(opts, :offset, 0)
 34:     unread_only = Keyword.get(opts, :unread_only, false)
 35: 
 36:     query =
 37:       from n in Notification,
 38:         where: n.user_id == ^user_id,
 39:         order_by: [desc: n.inserted_at],
 40:         limit: ^limit,
 41:         offset: ^offset
 42: 
 43:     query =
 44:       if unread_only do
 45:         from n in query, where: is_nil(n.read_at)
 46:       else
 47:         query
 48:       end
 49: 
 50:     Repo.all(query)
 51:   end
 52: 
 53:   @doc "Count unread notifications for a user"
 54:   def count_unread(user_id) do
 55:     from(n in Notification,
 56:       where: n.user_id == ^user_id and is_nil(n.read_at),
 57:       select: count(n.id)
 58:     )
 59:     |> Repo.one()
 60:   end
 61: 
 62:   @doc "Mark a notification as read"
 63:   def mark_as_read(notification_id) do
 64:     notification = get_notification!(notification_id)
 65: 
 66:     notification
 67:     |> Notification.mark_read_changeset()
 68:     |> Repo.update()
 69:   end
 70: 
 71:   @doc "Mark all notifications as read for a user"
 72:   def mark_all_as_read(user_id) do
 73:     now = DateTime.utc_now() |> DateTime.truncate(:second)
 74: 
 75:     from(n in Notification,
 76:       where: n.user_id == ^user_id and is_nil(n.read_at)
 77:     )
 78:     |> Repo.update_all(set: [read_at: now])
 79:   end
 80: 
 81:   @doc "Mark notification email as sent"
 82:   def mark_email_sent(%Notification{} = notification) do
 83:     notification
 84:     |> Notification.mark_email_sent_changeset()
 85:     |> Repo.update()
 86:   end
 87: 
 88:   @doc "Create a notification"
 89:   def create_notification(attrs) do
 90:     %Notification{}
 91:     |> Notification.changeset(attrs)
 92:     |> Repo.insert()
 93:   end
 94: 
 95:   # ============================================================================
 96:   # Preferences
 97:   # ============================================================================
 98: 
 99:   @doc "Get or create notification preferences for a user"
100:   def get_or_create_preferences(user_id) do
101:     case Repo.get_by(Preference, user_id: user_id) do
102:       nil ->
103:         %Preference{}
104:         |> Preference.changeset(%{user_id: user_id})
105:         |> Repo.insert()
106: 
107:       preference ->
108:         {:ok, preference}
109:     end
110:   end
111: 
112:   @doc "Update notification preferences"
113:   def update_preferences(user_id, attrs) do
114:     {:ok, preference} = get_or_create_preferences(user_id)
115: 
116:     preference
117:     |> Preference.changeset(attrs)
118:     |> Repo.update()
119:   end
120: 
121:   @doc "Check if user should receive email for notification type"
122:   def should_send_email?(user_id, notification_type) do
123:     case get_or_create_preferences(user_id) do
124:       {:ok, pref} -> Preference.should_email?(pref, notification_type)
125:       _ -> false
126:     end
127:   end
128: 
129:   # ============================================================================
130:   # Notification Triggers
131:   # ============================================================================
132: 
133:   @doc """
134:   Notify about a bullying alert.
135:   Creates notifications for the lesson owner and coordinators (for high/critical).
136:   """
137:   def notify_alert(alert, opts \\ []) do
138:     alert = Repo.preload(alert, analysis: [lesson: [:user, :institution]])
139:     lesson = alert.analysis.lesson
140:     teacher = lesson.user
141:     institution_id = lesson.institution_id
142: 
143:     notification_type = alert_type_to_notification_type(alert.severity)
144: 
145:     # Build notification data
146:     notification_data = %{
147:       "alert_id" => alert.id,
148:       "alert_type" => alert.alert_type,
149:       "severity" => alert.severity,
150:       "lesson_id" => lesson.id,
151:       "lesson_title" => lesson.title,
152:       "evidence_text" => String.slice(alert.evidence_text || "", 0, 200),
153:       "alert_url" => Keyword.get(opts, :base_url, "") <> "/lessons/#{lesson.id}/analysis"
154:     }
155: 
156:     # Notify the teacher (lesson owner)
157:     {:ok, teacher_notification} =
158:       create_and_broadcast_notification(teacher, %{
159:         type: notification_type,
160:         title: alert_title(alert.severity),
161:         message: alert_message(alert),
162:         data: notification_data,
163:         institution_id: institution_id
164:       })
165: 
166:     # Enqueue email for high/critical alerts
167:     if alert.severity in ["high", "critical"] do
168:       enqueue_email(teacher_notification)
169:     end
170: 
171:     # For high/critical alerts, also notify coordinators
172:     if alert.severity in ["high", "critical"] do
173:       notify_coordinators(institution_id, notification_type, notification_data, alert)
174:     end
175: 
176:     {:ok, teacher_notification}
177:   end
178: 
179:   @doc """
180:   Notify about analysis completion.
181:   Creates notification for the lesson owner.
182:   """
183:   def notify_analysis_complete(analysis, opts \\ []) do
184:     analysis = Repo.preload(analysis, lesson: [:user, :institution])
185:     lesson = analysis.lesson
186:     teacher = lesson.user
187:     institution_id = lesson.institution_id
188: 
189:     notification_data = %{
190:       "analysis_id" => analysis.id,
191:       "lesson_id" => lesson.id,
192:       "lesson_title" => lesson.title,
193:       "score" => analysis.score,
194:       "analysis_url" => Keyword.get(opts, :base_url, "") <> "/lessons/#{lesson.id}/analysis"
195:     }
196: 
197:     {:ok, notification} =
198:       create_and_broadcast_notification(teacher, %{
199:         type: "analysis_complete",
200:         title: "Analise Concluida",
201:         message:
202:           "A analise da aula \"#{lesson.title}\" foi concluida com score #{analysis.score}.",
203:         data: notification_data,
204:         institution_id: institution_id
205:       })
206: 
207:     # Optionally enqueue email based on preferences
208:     if should_send_email?(teacher.id, "analysis_complete") do
209:       enqueue_email(notification)
210:     end
211: 
212:     {:ok, notification}
213:   end
214: 
215:   # ============================================================================
216:   # Email
217:   # ============================================================================
218: 
219:   @doc "Enqueue email notification to be sent via Oban"
220:   def enqueue_email(%Notification{} = notification) do
221:     %{notification_id: notification.id, type: "send_email"}
222:     |> NotificationJob.new()
223:     |> Oban.insert()
224:   end
225: 
226:   @doc "Send email for a notification"
227:   def send_notification_email(%Notification{} = notification) do
228:     user = Accounts.get_user!(notification.user_id)
229: 
230:     case Emails.build_email(notification, user) do
231:       nil ->
232:         {:ok, :skipped}
233: 
234:       email ->
235:         case Mailer.deliver(email) do
236:           {:ok, _} ->
237:             mark_email_sent(notification)
238:             {:ok, :sent}
239: 
240:           {:error, reason} ->
241:             {:error, reason}
242:         end
243:     end
244:   end
245: 
246:   # ============================================================================
247:   # Private Helpers
248:   # ============================================================================
249: 
250:   defp create_and_broadcast_notification(%User{} = user, attrs) do
251:     attrs = Map.put(attrs, :user_id, user.id)
252: 
253:     with {:ok, notification} <- create_notification(attrs) do
254:       # Broadcast via PubSub for real-time updates
255:       broadcast_notification(user.id, notification)
256:       {:ok, notification}
257:     end
258:   end
259: 
260:   defp broadcast_notification(user_id, notification) do
261:     Phoenix.PubSub.broadcast(
262:       Hellen.PubSub,
263:       "user:#{user_id}:notifications",
264:       {:new_notification, notification}
265:     )
266:   end
267: 
268:   defp notify_coordinators(institution_id, notification_type, notification_data, alert) do
269:     coordinators = list_coordinators(institution_id)
270: 
271:     Enum.each(coordinators, fn coordinator ->
272:       {:ok, notification} =
273:         create_and_broadcast_notification(coordinator, %{
274:           type: notification_type,
275:           title: alert_title(alert.severity) <> " (Coordenador)",
276:           message: alert_message(alert),
277:           data: notification_data,
278:           institution_id: institution_id
279:         })
280: 
281:       enqueue_email(notification)
282:     end)
283:   end
284: 
285:   defp list_coordinators(institution_id) do
286:     from(u in User,
287:       where: u.institution_id == ^institution_id and u.role in ["coordinator", "admin"]
288:     )
289:     |> Repo.all()
290:   end
291: 
292:   defp alert_type_to_notification_type("critical"), do: "alert_critical"
293:   defp alert_type_to_notification_type("high"), do: "alert_high"
294:   defp alert_type_to_notification_type("medium"), do: "alert_medium"
295:   defp alert_type_to_notification_type(_), do: "alert_low"
296: 
297:   defp alert_title("critical"), do: "Alerta Critico Detectado"
298:   defp alert_title("high"), do: "Alerta de Alta Severidade"
299:   defp alert_title("medium"), do: "Alerta Detectado"
300:   defp alert_title(_), do: "Alerta de Baixa Severidade"
301: 
302:   defp alert_message(alert) do
303:     type_label = alert_type_label(alert.alert_type)
304:     "Foi detectado um alerta de #{type_label} durante a aula."
305:   end
306: 
307:   defp alert_type_label("verbal_aggression"), do: "agressao verbal"
308:   defp alert_type_label("exclusion"), do: "exclusao"
309:   defp alert_type_label("intimidation"), do: "intimidacao"
310:   defp alert_type_label("mockery"), do: "zombaria"
311:   defp alert_type_label("discrimination"), do: "discriminacao"
312:   defp alert_type_label("threat"), do: "ameaca"
313:   defp alert_type_label("inappropriate_language"), do: "linguagem inapropriada"
314:   defp alert_type_label(_), do: "comportamento inadequado"
315: end
````

## File: lib/hellen/plannings.ex
````elixir
  1: defmodule Hellen.Plannings do
  2:   @moduledoc """
  3:   Context for managing lesson plannings.
  4: 
  5:   Provides CRUD operations, AI-powered generation, and semantic search capabilities.
  6:   """
  7: 
  8:   import Ecto.Query, warn: false
  9: 
 10:   alias Hellen.AI.{Embeddings, QdrantClient}
 11:   alias Hellen.Plannings.Planning
 12:   alias Hellen.Repo
 13: 
 14:   @plannings_collection "plannings"
 15: 
 16:   # ============================================================================
 17:   # CRUD OPERATIONS
 18:   # ============================================================================
 19: 
 20:   @doc """
 21:   Lists plannings for a user with optional filters.
 22: 
 23:   ## Options
 24:   - :status - Filter by status
 25:   - :subject - Filter by subject
 26:   - :grade_level - Filter by grade level
 27:   - :search - Search in title/description
 28:   - :limit - Limit results
 29:   - :offset - Offset for pagination
 30:   """
 31:   def list_plannings(user_id, opts \\ []) do
 32:     base_query()
 33:     |> where([p], p.user_id == ^user_id)
 34:     |> apply_filters(opts)
 35:     |> order_by([p], desc: p.inserted_at)
 36:     |> Repo.all()
 37:   end
 38: 
 39:   @doc """
 40:   Lists plannings for an institution (coordinator view).
 41:   """
 42:   def list_institution_plannings(institution_id, opts \\ []) do
 43:     base_query()
 44:     |> where([p], p.institution_id == ^institution_id)
 45:     |> apply_filters(opts)
 46:     |> order_by([p], desc: p.inserted_at)
 47:     |> Repo.all()
 48:   end
 49: 
 50:   @doc """
 51:   Gets a single planning by ID.
 52:   """
 53:   def get_planning(id) do
 54:     Repo.get(Planning, id)
 55:     |> Repo.preload([:user, :institution, :source_lesson])
 56:   end
 57: 
 58:   @doc """
 59:   Gets a planning and raises if not found.
 60:   """
 61:   def get_planning!(id) do
 62:     Repo.get!(Planning, id)
 63:     |> Repo.preload([:user, :institution, :source_lesson])
 64:   end
 65: 
 66:   @doc """
 67:   Creates a new planning.
 68:   """
 69:   def create_planning(attrs) do
 70:     %Planning{}
 71:     |> Planning.create_changeset(attrs)
 72:     |> Repo.insert()
 73:     |> maybe_index_embeddings()
 74:   end
 75: 
 76:   @doc """
 77:   Updates a planning.
 78:   """
 79:   def update_planning(%Planning{} = planning, attrs) do
 80:     planning
 81:     |> Planning.changeset(attrs)
 82:     |> Repo.update()
 83:     |> maybe_reindex_embeddings(planning)
 84:   end
 85: 
 86:   @doc """
 87:   Deletes a planning.
 88:   """
 89:   def delete_planning(%Planning{} = planning) do
 90:     # Remove from vector index
 91:     remove_from_index(planning.id)
 92: 
 93:     Repo.delete(planning)
 94:   end
 95: 
 96:   @doc """
 97:   Publishes a planning (changes status to published).
 98:   """
 99:   def publish_planning(%Planning{} = planning) do
100:     planning
101:     |> Planning.publish_changeset()
102:     |> Repo.update()
103:   end
104: 
105:   @doc """
106:   Archives a planning.
107:   """
108:   def archive_planning(%Planning{} = planning) do
109:     planning
110:     |> Planning.archive_changeset()
111:     |> Repo.update()
112:   end
113: 
114:   @doc """
115:   Duplicates a planning for the same or different user.
116:   """
117:   def duplicate_planning(%Planning{} = planning, new_attrs \\ %{}) do
118:     attrs =
119:       planning
120:       |> Map.from_struct()
121:       |> Map.drop([
122:         :__meta__,
123:         :id,
124:         :inserted_at,
125:         :updated_at,
126:         :user,
127:         :institution,
128:         :source_lesson
129:       ])
130:       |> Map.put(:status, "draft")
131:       |> Map.put(:title, "#{planning.title} (Cópia)")
132:       |> Map.put(:embeddings_indexed, false)
133:       |> Map.merge(new_attrs)
134: 
135:     create_planning(attrs)
136:   end
137: 
138:   @doc """
139:   Returns a changeset for tracking planning changes.
140:   """
141:   def change_planning(%Planning{} = planning, attrs \\ %{}) do
142:     Planning.changeset(planning, attrs)
143:   end
144: 
145:   # ============================================================================
146:   # STATISTICS
147:   # ============================================================================
148: 
149:   @doc """
150:   Counts plannings by status for a user.
151:   """
152:   def count_by_status(user_id) do
153:     Planning
154:     |> where([p], p.user_id == ^user_id)
155:     |> group_by([p], p.status)
156:     |> select([p], {p.status, count(p.id)})
157:     |> Repo.all()
158:     |> Map.new()
159:   end
160: 
161:   @doc """
162:   Counts plannings by subject for a user.
163:   """
164:   def count_by_subject(user_id) do
165:     Planning
166:     |> where([p], p.user_id == ^user_id)
167:     |> group_by([p], p.subject)
168:     |> select([p], {p.subject, count(p.id)})
169:     |> Repo.all()
170:     |> Map.new()
171:   end
172: 
173:   @doc """
174:   Gets total planning count for a user.
175:   """
176:   def count_total(user_id) do
177:     Planning
178:     |> where([p], p.user_id == ^user_id)
179:     |> Repo.aggregate(:count)
180:   end
181: 
182:   @doc """
183:   Gets recent plannings for a user.
184:   """
185:   def recent_plannings(user_id, limit \\ 5) do
186:     Planning
187:     |> where([p], p.user_id == ^user_id)
188:     |> order_by([p], desc: p.inserted_at)
189:     |> limit(^limit)
190:     |> Repo.all()
191:   end
192: 
193:   # ============================================================================
194:   # SEMANTIC SEARCH
195:   # ============================================================================
196: 
197:   @doc """
198:   Searches plannings using semantic similarity.
199: 
200:   Returns plannings similar to the query text based on vector embeddings.
201:   """
202:   def search_similar(query_text, opts \\ []) do
203:     user_id = Keyword.get(opts, :user_id)
204:     limit = Keyword.get(opts, :limit, 10)
205:     score_threshold = Keyword.get(opts, :score_threshold, 0.7)
206: 
207:     with {:ok, %{embedding: vector}} <- Embeddings.generate(query_text, input_type: "query") do
208:       filter =
209:         if user_id do
210:           %{must: [%{key: "user_id", match: %{value: user_id}}]}
211:         else
212:           nil
213:         end
214: 
215:       case QdrantClient.search(@plannings_collection, vector,
216:              limit: limit,
217:              filter: filter,
218:              score_threshold: score_threshold
219:            ) do
220:         {:ok, results} ->
221:           planning_ids = Enum.map(results, & &1.payload["planning_id"])
222: 
223:           plannings =
224:             Planning
225:             |> where([p], p.id in ^planning_ids)
226:             |> Repo.all()
227:             |> Map.new(&{&1.id, &1})
228: 
229:           enriched =
230:             Enum.map(results, fn result ->
231:               planning = Map.get(plannings, result.payload["planning_id"])
232:               %{planning: planning, score: result.score, payload: result.payload}
233:             end)
234:             |> Enum.filter(& &1.planning)
235: 
236:           {:ok, enriched}
237: 
238:         {:error, reason} ->
239:           {:error, reason}
240:       end
241:     end
242:   end
243: 
244:   @doc """
245:   Finds plannings similar to an existing planning.
246:   """
247:   def find_similar(%Planning{} = planning, opts \\ []) do
248:     text = build_searchable_text(planning)
249:     search_similar(text, opts)
250:   end
251: 
252:   # ============================================================================
253:   # EMBEDDINGS INDEXING
254:   # ============================================================================
255: 
256:   @doc """
257:   Indexes a planning into Qdrant for semantic search.
258:   """
259:   def index_planning(%Planning{} = planning) do
260:     # Ensure collection exists
261:     :ok = QdrantClient.ensure_collection(@plannings_collection, :nv_embed)
262: 
263:     # Build searchable text
264:     text = build_searchable_text(planning)
265: 
266:     # Generate embedding
267:     case Embeddings.generate(text, input_type: "passage") do
268:       {:ok, %{embedding: vector}} ->
269:         point = %{
270:           id: planning.id,
271:           vector: vector,
272:           payload: %{
273:             planning_id: planning.id,
274:             user_id: planning.user_id,
275:             title: planning.title,
276:             subject: planning.subject,
277:             grade_level: planning.grade_level,
278:             bncc_codes: planning.bncc_codes,
279:             status: planning.status,
280:             indexed_at: DateTime.utc_now() |> DateTime.to_iso8601()
281:           }
282:         }
283: 
284:         case QdrantClient.upsert_points(@plannings_collection, [point]) do
285:           {:ok, _} ->
286:             # Mark as indexed
287:             planning
288:             |> Planning.mark_indexed_changeset()
289:             |> Repo.update()
290: 
291:           {:error, reason} ->
292:             {:error, reason}
293:         end
294: 
295:       {:error, reason} ->
296:         {:error, reason}
297:     end
298:   end
299: 
300:   @doc """
301:   Removes a planning from the vector index.
302:   """
303:   def remove_from_index(planning_id) do
304:     QdrantClient.delete_points(@plannings_collection, [planning_id])
305:   end
306: 
307:   @doc """
308:   Re-indexes all plannings for a user.
309:   """
310:   def reindex_all(user_id) do
311:     plannings = list_plannings(user_id, status: "published")
312: 
313:     results =
314:       Enum.map(plannings, fn planning ->
315:         case index_planning(planning) do
316:           {:ok, _} -> {:ok, planning.id}
317:           {:error, reason} -> {:error, {planning.id, reason}}
318:         end
319:       end)
320: 
321:     successes = Enum.count(results, &match?({:ok, _}, &1))
322:     failures = Enum.filter(results, &match?({:error, _}, &1))
323: 
324:     {:ok, %{indexed: successes, failed: length(failures), failures: failures}}
325:   end
326: 
327:   # ============================================================================
328:   # PRIVATE HELPERS
329:   # ============================================================================
330: 
331:   defp base_query do
332:     from(p in Planning, preload: [:user, :institution])
333:   end
334: 
335:   defp apply_filters(query, opts) do
336:     query
337:     |> filter_by_status(opts[:status])
338:     |> filter_by_subject(opts[:subject])
339:     |> filter_by_grade_level(opts[:grade_level])
340:     |> filter_by_search(opts[:search])
341:     |> apply_limit(opts[:limit])
342:     |> apply_offset(opts[:offset])
343:   end
344: 
345:   defp filter_by_status(query, nil), do: query
346:   defp filter_by_status(query, status), do: where(query, [p], p.status == ^status)
347: 
348:   defp filter_by_subject(query, nil), do: query
349:   defp filter_by_subject(query, subject), do: where(query, [p], p.subject == ^subject)
350: 
351:   defp filter_by_grade_level(query, nil), do: query
352:   defp filter_by_grade_level(query, level), do: where(query, [p], p.grade_level == ^level)
353: 
354:   defp filter_by_search(query, nil), do: query
355: 
356:   defp filter_by_search(query, search) do
357:     search_term = "%#{search}%"
358:     where(query, [p], ilike(p.title, ^search_term) or ilike(p.description, ^search_term))
359:   end
360: 
361:   defp apply_limit(query, nil), do: query
362:   defp apply_limit(query, limit), do: limit(query, ^limit)
363: 
364:   defp apply_offset(query, nil), do: query
365:   defp apply_offset(query, offset), do: offset(query, ^offset)
366: 
367:   defp build_searchable_text(%Planning{} = planning) do
368:     [
369:       planning.title,
370:       planning.description,
371:       Planning.subject_label(planning.subject),
372:       Planning.grade_level_label(planning.grade_level),
373:       Enum.join(planning.objectives || [], " "),
374:       Enum.join(planning.bncc_codes || [], " "),
375:       planning.methodology
376:     ]
377:     |> Enum.filter(& &1)
378:     |> Enum.join(" ")
379:   end
380: 
381:   defp maybe_index_embeddings({:ok, planning} = result) do
382:     # Index asynchronously for published plannings
383:     if planning.status == "published" do
384:       Task.start(fn -> index_planning(planning) end)
385:     end
386: 
387:     result
388:   end
389: 
390:   defp maybe_index_embeddings(error), do: error
391: 
392:   defp maybe_reindex_embeddings({:ok, updated_planning} = result, old_planning) do
393:     # Reindex if content changed significantly
394:     if content_changed?(old_planning, updated_planning) do
395:       Task.start(fn -> index_planning(updated_planning) end)
396:     end
397: 
398:     result
399:   end
400: 
401:   defp maybe_reindex_embeddings(error, _), do: error
402: 
403:   defp content_changed?(old, new) do
404:     old.title != new.title ||
405:       old.description != new.description ||
406:       old.objectives != new.objectives ||
407:       old.methodology != new.methodology
408:   end
409: end
````

## File: lib/hellen/release.ex
````elixir
 1: defmodule Hellen.Release do
 2:   @moduledoc """
 3:   Used for executing DB release tasks when run in production without Mix installed.
 4:   """
 5:   @app :hellen
 6: 
 7:   def migrate do
 8:     load_app()
 9: 
10:     for repo <- repos() do
11:       {:ok, _, _} = Ecto.Migrator.with_repo(repo, &Ecto.Migrator.run(&1, :up, all: true))
12:     end
13:   end
14: 
15:   def rollback(repo, version) do
16:     load_app()
17:     {:ok, _, _} = Ecto.Migrator.with_repo(repo, &Ecto.Migrator.run(&1, :down, to: version))
18:   end
19: 
20:   defp repos do
21:     Application.fetch_env!(@app, :ecto_repos)
22:   end
23: 
24:   defp load_app do
25:     Application.load(@app)
26:   end
27: end
````

## File: lib/hellen/repo.ex
````elixir
1: defmodule Hellen.Repo do
2:   use Ecto.Repo,
3:     otp_app: :hellen,
4:     adapter: Ecto.Adapters.Postgres
5: end
````

## File: lib/hellen_web/channels/lesson_channel.ex
````elixir
 1: defmodule HellenWeb.LessonChannel do
 2:   @moduledoc """
 3:   Channel for real-time lesson processing updates via WebSocket.
 4:   """
 5:   use HellenWeb, :channel
 6: 
 7:   @impl true
 8:   def join("lesson:" <> lesson_id, _params, socket) do
 9:     # Subscribe to lesson updates
10:     Phoenix.PubSub.subscribe(Hellen.PubSub, "lesson:#{lesson_id}")
11:     {:ok, assign(socket, :lesson_id, lesson_id)}
12:   end
13: 
14:   @impl true
15:   def handle_info({event, payload}, socket) do
16:     push(socket, to_string(event), payload)
17:     {:noreply, socket}
18:   end
19: 
20:   @impl true
21:   def handle_in("ping", _payload, socket) do
22:     {:reply, {:ok, %{message: "pong"}}, socket}
23:   end
24: end
````

## File: lib/hellen_web/components/layouts.ex
````elixir
1: defmodule HellenWeb.Layouts do
2:   @moduledoc """
3:   This module holds different layouts used by your application.
4:   """
5:   use HellenWeb, :html
6: 
7:   embed_templates "layouts/*"
8: end
````

## File: lib/hellen_web/controllers/api/analysis_json.ex
````elixir
 1: defmodule HellenWeb.API.AnalysisJSON do
 2:   alias Hellen.Analysis.{Analysis, BnccMatch, BullyingAlert}
 3: 
 4:   def index(%{analyses: analyses}) do
 5:     %{data: for(analysis <- analyses, do: data(analysis))}
 6:   end
 7: 
 8:   def show(%{analysis: analysis}) do
 9:     %{data: data_with_details(analysis)}
10:   end
11: 
12:   defp data(%Analysis{} = analysis) do
13:     %{
14:       id: analysis.id,
15:       analysis_type: analysis.analysis_type,
16:       model_used: analysis.model_used,
17:       overall_score: analysis.overall_score,
18:       processing_time_ms: analysis.processing_time_ms,
19:       tokens_used: analysis.tokens_used,
20:       inserted_at: analysis.inserted_at
21:     }
22:   end
23: 
24:   defp data_with_details(%Analysis{} = analysis) do
25:     analysis
26:     |> data()
27:     |> Map.merge(%{
28:       result: analysis.result,
29:       bncc_matches: bncc_matches_data(analysis),
30:       bullying_alerts: bullying_alerts_data(analysis)
31:     })
32:   end
33: 
34:   defp bncc_matches_data(%{bncc_matches: %Ecto.Association.NotLoaded{}}), do: []
35: 
36:   defp bncc_matches_data(%{bncc_matches: matches}) do
37:     Enum.map(matches, fn %BnccMatch{} = match ->
38:       %{
39:         id: match.id,
40:         competencia_code: match.competencia_code,
41:         competencia_name: match.competencia_name,
42:         match_score: match.match_score,
43:         evidence_text: match.evidence_text
44:       }
45:     end)
46:   end
47: 
48:   defp bullying_alerts_data(%{bullying_alerts: %Ecto.Association.NotLoaded{}}), do: []
49: 
50:   defp bullying_alerts_data(%{bullying_alerts: alerts}) do
51:     Enum.map(alerts, fn %BullyingAlert{} = alert ->
52:       %{
53:         id: alert.id,
54:         severity: alert.severity,
55:         alert_type: alert.alert_type,
56:         description: alert.description,
57:         evidence_text: alert.evidence_text,
58:         reviewed: alert.reviewed
59:       }
60:     end)
61:   end
62: end
````

## File: lib/hellen_web/controllers/api/credit_json.ex
````elixir
 1: defmodule HellenWeb.API.CreditJSON do
 2:   alias Hellen.Billing.CreditTransaction
 3: 
 4:   def balance(%{balance: balance}) do
 5:     %{data: %{credits: balance}}
 6:   end
 7: 
 8:   def history(%{transactions: transactions}) do
 9:     %{data: for(tx <- transactions, do: transaction_data(tx))}
10:   end
11: 
12:   defp transaction_data(%CreditTransaction{} = tx) do
13:     %{
14:       id: tx.id,
15:       amount: tx.amount,
16:       balance_after: tx.balance_after,
17:       reason: tx.reason,
18:       lesson_id: tx.lesson_id,
19:       inserted_at: tx.inserted_at
20:     }
21:   end
22: end
````

## File: lib/hellen_web/controllers/api/lesson_json.ex
````elixir
 1: defmodule HellenWeb.API.LessonJSON do
 2:   alias Hellen.Lessons.Lesson
 3: 
 4:   def index(%{lessons: lessons}) do
 5:     %{data: for(lesson <- lessons, do: data(lesson))}
 6:   end
 7: 
 8:   def show(%{lesson: lesson}) do
 9:     %{data: data(lesson)}
10:   end
11: 
12:   defp data(%Lesson{} = lesson) do
13:     %{
14:       id: lesson.id,
15:       title: lesson.title,
16:       description: lesson.description,
17:       video_url: lesson.video_url,
18:       audio_url: lesson.audio_url,
19:       duration_seconds: lesson.duration_seconds,
20:       grade_level: lesson.grade_level,
21:       subject: lesson.subject,
22:       status: lesson.status,
23:       inserted_at: lesson.inserted_at,
24:       updated_at: lesson.updated_at,
25:       transcription: transcription_data(lesson)
26:     }
27:   end
28: 
29:   defp transcription_data(%{transcription: nil}), do: nil
30: 
31:   defp transcription_data(%{transcription: %Ecto.Association.NotLoaded{}}), do: nil
32: 
33:   defp transcription_data(%{transcription: transcription}) do
34:     %{
35:       id: transcription.id,
36:       full_text: transcription.full_text,
37:       language: transcription.language,
38:       word_count: transcription.word_count,
39:       inserted_at: transcription.inserted_at
40:     }
41:   end
42: end
````

## File: lib/hellen_web/controllers/changeset_json.ex
````elixir
 1: defmodule HellenWeb.ChangesetJSON do
 2:   @doc """
 3:   Renders changeset errors.
 4:   """
 5:   def error(%{changeset: changeset}) do
 6:     %{errors: Ecto.Changeset.traverse_errors(changeset, &translate_error/1)}
 7:   end
 8: 
 9:   defp translate_error({msg, opts}) do
10:     Regex.replace(~r"%{(\w+)}", msg, fn _, key ->
11:       opts |> Keyword.get(String.to_existing_atom(key), key) |> to_string()
12:     end)
13:   end
14: end
````

## File: lib/hellen_web/controllers/error_html.ex
````elixir
 1: defmodule HellenWeb.ErrorHTML do
 2:   @moduledoc """
 3:   This module is invoked by your endpoint in case of errors on HTML requests.
 4:   """
 5:   use HellenWeb, :html
 6: 
 7:   def render(template, _assigns) do
 8:     Phoenix.Controller.status_message_from_template(template)
 9:   end
10: end
````

## File: lib/hellen_web/controllers/error_json.ex
````elixir
 1: defmodule HellenWeb.ErrorJSON do
 2:   @moduledoc """
 3:   This module is invoked by your endpoint in case of errors on JSON requests.
 4:   """
 5: 
 6:   def render("404.json", _assigns) do
 7:     %{errors: %{detail: "Not Found"}}
 8:   end
 9: 
10:   def render("401.json", _assigns) do
11:     %{errors: %{detail: "Unauthorized"}}
12:   end
13: 
14:   def render("403.json", _assigns) do
15:     %{errors: %{detail: "Forbidden"}}
16:   end
17: 
18:   def render("500.json", _assigns) do
19:     %{errors: %{detail: "Internal Server Error"}}
20:   end
21: 
22:   def render("insufficient_credits.json", _assigns) do
23:     %{
24:       errors: %{
25:         detail: "Insufficient credits",
26:         code: "INSUFFICIENT_CREDITS",
27:         message:
28:           "You don't have enough credits to perform this action. Please purchase more credits."
29:       }
30:     }
31:   end
32: 
33:   # By default, Phoenix returns the status message from
34:   # the template name.
35:   def render(template, _assigns) do
36:     %{errors: %{detail: Phoenix.Controller.status_message_from_template(template)}}
37:   end
38: end
````

## File: lib/hellen_web/controllers/page_controller.ex
````elixir
 1: defmodule HellenWeb.PageController do
 2:   use HellenWeb, :controller
 3: 
 4:   def home(conn, _params) do
 5:     json(conn, %{
 6:       name: "Hellen AI",
 7:       version: "0.1.0",
 8:       description: "AI-powered lesson analysis platform",
 9:       status: "ok"
10:     })
11:   end
12: end
````

## File: lib/hellen_web/controllers/stripe_webhook_controller.ex
````elixir
 1: defmodule HellenWeb.StripeWebhookController do
 2:   @moduledoc """
 3:   Controller for handling Stripe webhook events.
 4:   """
 5:   use HellenWeb, :controller
 6: 
 7:   alias Hellen.Billing.StripeService
 8: 
 9:   require Logger
10: 
11:   @doc """
12:   Handles incoming Stripe webhooks.
13:   Verifies the webhook signature and processes supported events.
14:   """
15:   def webhook(conn, _params) do
16:     payload = conn.assigns[:raw_body]
17:     signature = get_stripe_signature(conn)
18: 
19:     case verify_webhook(payload, signature) do
20:       {:ok, %Stripe.Event{} = event} ->
21:         handle_event(conn, event)
22: 
23:       {:error, reason} ->
24:         Logger.warning("Stripe webhook verification failed: #{inspect(reason)}")
25:         send_resp(conn, 400, "Webhook verification failed")
26:     end
27:   end
28: 
29:   defp get_stripe_signature(conn) do
30:     case get_req_header(conn, "stripe-signature") do
31:       [signature | _] -> signature
32:       _ -> ""
33:     end
34:   end
35: 
36:   defp verify_webhook(payload, signature) do
37:     webhook_secret = Application.get_env(:stripity_stripe, :webhook_secret)
38: 
39:     if webhook_secret do
40:       Stripe.Webhook.construct_event(payload, signature, webhook_secret)
41:     else
42:       # In development without webhook secret, just parse the payload
43:       case Jason.decode(payload) do
44:         {:ok, decoded} -> {:ok, struct(Stripe.Event, atomize_keys(decoded))}
45:         error -> error
46:       end
47:     end
48:   end
49: 
50:   defp atomize_keys(map) when is_map(map) do
51:     Map.new(map, fn {k, v} -> {String.to_atom(k), atomize_keys(v)} end)
52:   end
53: 
54:   defp atomize_keys(list) when is_list(list), do: Enum.map(list, &atomize_keys/1)
55:   defp atomize_keys(value), do: value
56: 
57:   defp handle_event(conn, %Stripe.Event{type: type, data: %{object: object}}) do
58:     Logger.info("Processing Stripe event: #{type}")
59: 
60:     case type do
61:       "checkout.session.completed" ->
62:         handle_checkout_completed(conn, object)
63: 
64:       "payment_intent.payment_failed" ->
65:         handle_payment_failed(conn, object)
66: 
67:       _ ->
68:         Logger.debug("Unhandled Stripe event type: #{type}")
69:         send_resp(conn, 200, "Event ignored")
70:     end
71:   end
72: 
73:   defp handle_checkout_completed(conn, session) do
74:     session_map = if is_struct(session), do: Map.from_struct(session), else: session
75: 
76:     case StripeService.handle_checkout_completed(session_map) do
77:       {:ok, _user} ->
78:         send_resp(conn, 200, "Credits added")
79: 
80:       {:error, reason} ->
81:         Logger.error("Failed to process checkout: #{inspect(reason)}")
82:         send_resp(conn, 200, "Processed with errors")
83:     end
84:   end
85: 
86:   defp handle_payment_failed(conn, payment_intent) do
87:     payment_map =
88:       if is_struct(payment_intent), do: Map.from_struct(payment_intent), else: payment_intent
89: 
90:     StripeService.handle_payment_failed(payment_map)
91:     send_resp(conn, 200, "Payment failure recorded")
92:   end
93: end
````

## File: lib/hellen_web/live/admin_live/index.ex
````elixir
  1: defmodule HellenWeb.AdminLive.Index do
  2:   @moduledoc """
  3:   Admin Dashboard - System-wide statistics and recent activity.
  4:   """
  5:   use HellenWeb, :live_view
  6: 
  7:   alias Hellen.Accounts
  8: 
  9:   @impl true
 10:   def mount(_params, _session, socket) do
 11:     stats = Accounts.get_system_stats()
 12:     activity = Accounts.get_recent_platform_activity(5)
 13:     registrations = Accounts.get_daily_registrations(30)
 14: 
 15:     {:ok,
 16:      socket
 17:      |> assign(page_title: "Painel Admin")
 18:      |> assign(stats: stats)
 19:      |> assign(activity: activity)
 20:      |> assign(registrations: registrations)}
 21:   end
 22: 
 23:   @impl true
 24:   def render(assigns) do
 25:     ~H"""
 26:     <div class="space-y-6">
 27:       <!-- Header -->
 28:       <div class="flex items-center justify-between">
 29:         <div>
 30:           <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Painel Administrativo</h1>
 31:           <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
 32:             Visao geral do sistema Hellen AI
 33:           </p>
 34:         </div>
 35:         <div class="flex items-center gap-2">
 36:           <.link
 37:             navigate={~p"/admin/institutions"}
 38:             class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-700"
 39:           >
 40:             <.icon name="hero-building-office-2" class="h-4 w-4 inline mr-1" /> Instituicoes
 41:           </.link>
 42:           <.link
 43:             navigate={~p"/admin/users"}
 44:             class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700"
 45:           >
 46:             <.icon name="hero-user-group" class="h-4 w-4 inline mr-1" /> Usuarios
 47:           </.link>
 48:         </div>
 49:       </div>
 50:       <!-- Stats Grid -->
 51:       <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
 52:         <.admin_stat_card
 53:           label="Instituicoes"
 54:           value={@stats.institutions}
 55:           icon="hero-building-office-2"
 56:           color="indigo"
 57:         />
 58:         <.admin_stat_card label="Usuarios" value={@stats.users} icon="hero-users" color="blue" />
 59:         <.admin_stat_card
 60:           label="Aulas"
 61:           value={@stats.lessons}
 62:           icon="hero-academic-cap"
 63:           color="emerald"
 64:         />
 65:         <.admin_stat_card
 66:           label="Analises"
 67:           value={@stats.analyses}
 68:           icon="hero-chart-bar"
 69:           color="purple"
 70:         />
 71:         <.admin_stat_card
 72:           label="Alertas Pendentes"
 73:           value={@stats.pending_alerts}
 74:           icon="hero-bell-alert"
 75:           color={if @stats.pending_alerts > 0, do: "red", else: "gray"}
 76:         />
 77:       </div>
 78:       <!-- Distribution Cards -->
 79:       <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
 80:         <!-- Users by Role -->
 81:         <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
 82:           <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Usuarios por Cargo</h3>
 83:           <div class="space-y-3">
 84:             <.distribution_bar
 85:               label="Professores"
 86:               count={Map.get(@stats.users_by_role, "teacher", 0)}
 87:               total={@stats.users}
 88:               color="bg-blue-500"
 89:             />
 90:             <.distribution_bar
 91:               label="Coordenadores"
 92:               count={Map.get(@stats.users_by_role, "coordinator", 0)}
 93:               total={@stats.users}
 94:               color="bg-amber-500"
 95:             />
 96:             <.distribution_bar
 97:               label="Administradores"
 98:               count={Map.get(@stats.users_by_role, "admin", 0)}
 99:               total={@stats.users}
100:               color="bg-red-500"
101:             />
102:           </div>
103:         </div>
104:         <!-- Users by Plan -->
105:         <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
106:           <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Usuarios por Plano</h3>
107:           <div class="space-y-3">
108:             <.distribution_bar
109:               label="Free"
110:               count={Map.get(@stats.users_by_plan, "free", 0)}
111:               total={@stats.users}
112:               color="bg-gray-500"
113:             />
114:             <.distribution_bar
115:               label="Pro"
116:               count={Map.get(@stats.users_by_plan, "pro", 0)}
117:               total={@stats.users}
118:               color="bg-indigo-500"
119:             />
120:             <.distribution_bar
121:               label="Enterprise"
122:               count={Map.get(@stats.users_by_plan, "enterprise", 0)}
123:               total={@stats.users}
124:               color="bg-purple-500"
125:             />
126:           </div>
127:         </div>
128:       </div>
129:       <!-- Registrations Chart -->
130:       <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
131:         <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
132:           Novos Usuarios (30 dias)
133:         </h3>
134:         <div
135:           id="registrations-chart"
136:           phx-hook="AdminRegistrationsChart"
137:           data-registrations={Jason.encode!(@registrations)}
138:           class="h-64"
139:         >
140:           <!-- Chart placeholder if no data -->
141:           <div
142:             :if={Enum.empty?(@registrations)}
143:             class="flex items-center justify-center h-full text-gray-500 dark:text-gray-400"
144:           >
145:             Sem dados de registro no periodo
146:           </div>
147:         </div>
148:       </div>
149:       <!-- Recent Activity -->
150:       <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
151:         <!-- Recent Lessons -->
152:         <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
153:           <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Aulas Recentes</h3>
154:           <div class="space-y-3">
155:             <div
156:               :for={lesson <- @activity.lessons}
157:               class="flex items-start gap-3 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-700/50"
158:             >
159:               <div class="w-8 h-8 rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center">
160:                 <.icon
161:                   name="hero-academic-cap"
162:                   class="h-4 w-4 text-emerald-600 dark:text-emerald-400"
163:                 />
164:               </div>
165:               <div class="flex-1 min-w-0">
166:                 <p class="text-sm font-medium text-gray-900 dark:text-white truncate">
167:                   <%= lesson.title %>
168:                 </p>
169:                 <p class="text-xs text-gray-500 dark:text-gray-400">
170:                   <%= lesson.user && lesson.user.name %> - <%= format_relative(lesson.inserted_at) %>
171:                 </p>
172:               </div>
173:             </div>
174:             <div
175:               :if={Enum.empty?(@activity.lessons)}
176:               class="text-sm text-gray-500 dark:text-gray-400 text-center py-4"
177:             >
178:               Nenhuma aula recente
179:             </div>
180:           </div>
181:         </div>
182:         <!-- Recent Analyses -->
183:         <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
184:           <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Analises Recentes</h3>
185:           <div class="space-y-3">
186:             <div
187:               :for={analysis <- @activity.analyses}
188:               class="flex items-start gap-3 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-700/50"
189:             >
190:               <div class="w-8 h-8 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
191:                 <.icon name="hero-chart-bar" class="h-4 w-4 text-purple-600 dark:text-purple-400" />
192:               </div>
193:               <div class="flex-1 min-w-0">
194:                 <p class="text-sm font-medium text-gray-900 dark:text-white truncate">
195:                   <%= analysis.lesson && analysis.lesson.title %>
196:                 </p>
197:                 <p class="text-xs text-gray-500 dark:text-gray-400">
198:                   Score: <%= analysis.overall_score || "-" %> - <%= format_relative(
199:                     analysis.inserted_at
200:                   ) %>
201:                 </p>
202:               </div>
203:             </div>
204:             <div
205:               :if={Enum.empty?(@activity.analyses)}
206:               class="text-sm text-gray-500 dark:text-gray-400 text-center py-4"
207:             >
208:               Nenhuma analise recente
209:             </div>
210:           </div>
211:         </div>
212:         <!-- Pending Alerts -->
213:         <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
214:           <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Alertas Pendentes</h3>
215:           <div class="space-y-3">
216:             <div
217:               :for={alert <- @activity.alerts}
218:               class="flex items-start gap-3 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-700/50"
219:             >
220:               <div class={[
221:                 "w-8 h-8 rounded-full flex items-center justify-center",
222:                 severity_bg(alert.severity)
223:               ]}>
224:                 <.icon
225:                   name="hero-exclamation-triangle"
226:                   class={"h-4 w-4 " <> severity_icon_color(alert.severity)}
227:                 />
228:               </div>
229:               <div class="flex-1 min-w-0">
230:                 <p class="text-sm font-medium text-gray-900 dark:text-white truncate">
231:                   <%= String.capitalize(alert.alert_type) %>
232:                 </p>
233:                 <p class="text-xs text-gray-500 dark:text-gray-400">
234:                   <%= alert.analysis && alert.analysis.lesson && alert.analysis.lesson.user &&
235:                     alert.analysis.lesson.user.name %>
236:                 </p>
237:               </div>
238:               <.badge variant={severity_variant(alert.severity)}>
239:                 <%= String.capitalize(alert.severity) %>
240:               </.badge>
241:             </div>
242:             <div
243:               :if={Enum.empty?(@activity.alerts)}
244:               class="text-sm text-gray-500 dark:text-gray-400 text-center py-4"
245:             >
246:               Nenhum alerta pendente
247:             </div>
248:           </div>
249:         </div>
250:       </div>
251:     </div>
252:     """
253:   end
254: 
255:   # Component helpers
256: 
257:   defp admin_stat_card(assigns) do
258:     ~H"""
259:     <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-4">
260:       <div class="flex items-center gap-3">
261:         <div class={[
262:           "w-10 h-10 rounded-lg flex items-center justify-center",
263:           stat_bg(@color)
264:         ]}>
265:           <.icon name={@icon} class={"h-5 w-5 " <> stat_icon_color(@color)} />
266:         </div>
267:         <div>
268:           <p class="text-2xl font-bold text-gray-900 dark:text-white"><%= @value %></p>
269:           <p class="text-xs text-gray-500 dark:text-gray-400"><%= @label %></p>
270:         </div>
271:       </div>
272:     </div>
273:     """
274:   end
275: 
276:   defp distribution_bar(assigns) do
277:     percentage =
278:       if assigns.total > 0, do: Float.round(assigns.count / assigns.total * 100, 1), else: 0
279: 
280:     assigns = assign(assigns, :percentage, percentage)
281: 
282:     ~H"""
283:     <div>
284:       <div class="flex items-center justify-between mb-1">
285:         <span class="text-sm text-gray-700 dark:text-gray-300"><%= @label %></span>
286:         <span class="text-sm font-medium text-gray-900 dark:text-white">
287:           <%= @count %> (<%= @percentage %>%)
288:         </span>
289:       </div>
290:       <div class="w-full h-2 bg-gray-200 dark:bg-slate-700 rounded-full overflow-hidden">
291:         <div class={[@color, "h-full rounded-full transition-all"]} style={"width: #{@percentage}%"}>
292:         </div>
293:       </div>
294:     </div>
295:     """
296:   end
297: 
298:   defp stat_bg("indigo"), do: "bg-indigo-100 dark:bg-indigo-900/30"
299:   defp stat_bg("blue"), do: "bg-blue-100 dark:bg-blue-900/30"
300:   defp stat_bg("emerald"), do: "bg-emerald-100 dark:bg-emerald-900/30"
301:   defp stat_bg("purple"), do: "bg-purple-100 dark:bg-purple-900/30"
302:   defp stat_bg("red"), do: "bg-red-100 dark:bg-red-900/30"
303:   defp stat_bg(_), do: "bg-gray-100 dark:bg-gray-900/30"
304: 
305:   defp stat_icon_color("indigo"), do: "text-indigo-600 dark:text-indigo-400"
306:   defp stat_icon_color("blue"), do: "text-blue-600 dark:text-blue-400"
307:   defp stat_icon_color("emerald"), do: "text-emerald-600 dark:text-emerald-400"
308:   defp stat_icon_color("purple"), do: "text-purple-600 dark:text-purple-400"
309:   defp stat_icon_color("red"), do: "text-red-600 dark:text-red-400"
310:   defp stat_icon_color(_), do: "text-gray-600 dark:text-gray-400"
311: 
312:   defp severity_bg("critical"), do: "bg-red-100 dark:bg-red-900/30"
313:   defp severity_bg("high"), do: "bg-orange-100 dark:bg-orange-900/30"
314:   defp severity_bg("medium"), do: "bg-yellow-100 dark:bg-yellow-900/30"
315:   defp severity_bg(_), do: "bg-blue-100 dark:bg-blue-900/30"
316: 
317:   defp severity_icon_color("critical"), do: "text-red-600 dark:text-red-400"
318:   defp severity_icon_color("high"), do: "text-orange-600 dark:text-orange-400"
319:   defp severity_icon_color("medium"), do: "text-yellow-600 dark:text-yellow-400"
320:   defp severity_icon_color(_), do: "text-blue-600 dark:text-blue-400"
321: 
322:   defp severity_variant("critical"), do: "error"
323:   defp severity_variant("high"), do: "warning"
324:   defp severity_variant(_), do: "default"
325: 
326:   defp format_relative(datetime) do
327:     diff = DateTime.diff(DateTime.utc_now(), datetime, :second)
328: 
329:     cond do
330:       diff < 60 -> "agora"
331:       diff < 3600 -> "#{div(diff, 60)}m atras"
332:       diff < 86_400 -> "#{div(diff, 3600)}h atras"
333:       true -> "#{div(diff, 86_400)}d atras"
334:     end
335:   end
336: end
````

## File: lib/hellen_web/live/admin_live/institutions.ex
````elixir
  1: defmodule HellenWeb.AdminLive.Institutions do
  2:   @moduledoc """
  3:   Admin Institutions Management - View and manage all institutions.
  4:   """
  5:   use HellenWeb, :live_view
  6: 
  7:   alias Hellen.Accounts
  8: 
  9:   @impl true
 10:   def mount(_params, _session, socket) do
 11:     institutions = Accounts.list_institutions_with_stats()
 12: 
 13:     {:ok,
 14:      socket
 15:      |> assign(page_title: "Instituicoes - Admin")
 16:      |> assign(institutions: institutions)
 17:      |> assign(show_modal: false)
 18:      |> assign(selected_institution: nil)
 19:      |> assign(form: to_form(%{"name" => "", "slug" => ""}))}
 20:   end
 21: 
 22:   @impl true
 23:   def handle_event("show_create_modal", _params, socket) do
 24:     {:noreply,
 25:      socket
 26:      |> assign(show_modal: true)
 27:      |> assign(selected_institution: nil)
 28:      |> assign(form: to_form(%{"name" => "", "slug" => ""}))}
 29:   end
 30: 
 31:   def handle_event("close_modal", _params, socket) do
 32:     {:noreply, assign(socket, show_modal: false, selected_institution: nil)}
 33:   end
 34: 
 35:   def handle_event("create_institution", %{"name" => name, "slug" => slug}, socket) do
 36:     case Accounts.create_institution(%{name: name, slug: slug}) do
 37:       {:ok, _institution} ->
 38:         institutions = Accounts.list_institutions_with_stats()
 39: 
 40:         {:noreply,
 41:          socket
 42:          |> assign(institutions: institutions)
 43:          |> assign(show_modal: false)
 44:          |> put_flash(:info, "Instituicao criada com sucesso!")}
 45: 
 46:       {:error, _changeset} ->
 47:         {:noreply, put_flash(socket, :error, "Erro ao criar instituicao")}
 48:     end
 49:   end
 50: 
 51:   @impl true
 52:   def render(assigns) do
 53:     ~H"""
 54:     <div class="space-y-6">
 55:       <!-- Header -->
 56:       <div class="flex items-center justify-between">
 57:         <div>
 58:           <div class="flex items-center gap-2">
 59:             <.link
 60:               navigate={~p"/admin"}
 61:               class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"
 62:             >
 63:               <.icon name="hero-arrow-left" class="h-5 w-5" />
 64:             </.link>
 65:             <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Instituicoes</h1>
 66:           </div>
 67:           <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
 68:             Gerenciar todas as instituicoes da plataforma
 69:           </p>
 70:         </div>
 71:         <button
 72:           phx-click="show_create_modal"
 73:           class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700"
 74:         >
 75:           <.icon name="hero-plus" class="h-4 w-4 inline mr-1" /> Nova Instituicao
 76:         </button>
 77:       </div>
 78:       <!-- Institutions Table -->
 79:       <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 overflow-hidden">
 80:         <table class="min-w-full divide-y divide-gray-200 dark:divide-slate-700">
 81:           <thead class="bg-gray-50 dark:bg-slate-900/50">
 82:             <tr>
 83:               <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
 84:                 Instituicao
 85:               </th>
 86:               <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
 87:                 Usuarios
 88:               </th>
 89:               <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
 90:                 Aulas
 91:               </th>
 92:               <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
 93:                 Analises
 94:               </th>
 95:               <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
 96:                 Criada em
 97:               </th>
 98:             </tr>
 99:           </thead>
100:           <tbody class="divide-y divide-gray-200 dark:divide-slate-700">
101:             <tr :for={item <- @institutions} class="hover:bg-gray-50 dark:hover:bg-slate-700/50">
102:               <td class="px-6 py-4">
103:                 <div>
104:                   <p class="text-sm font-medium text-gray-900 dark:text-white">
105:                     <%= item.institution.name %>
106:                   </p>
107:                   <p class="text-xs text-gray-500 dark:text-gray-400"><%= item.institution.slug %></p>
108:                 </div>
109:               </td>
110:               <td class="px-6 py-4 text-sm text-gray-700 dark:text-gray-300">
111:                 <%= item.users_count %>
112:               </td>
113:               <td class="px-6 py-4 text-sm text-gray-700 dark:text-gray-300">
114:                 <%= item.lessons_count %>
115:               </td>
116:               <td class="px-6 py-4 text-sm text-gray-700 dark:text-gray-300">
117:                 <%= item.analyses_count %>
118:               </td>
119:               <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
120:                 <%= Calendar.strftime(item.institution.inserted_at, "%d/%m/%Y") %>
121:               </td>
122:             </tr>
123:           </tbody>
124:         </table>
125: 
126:         <div :if={Enum.empty?(@institutions)} class="p-8 text-center text-gray-500 dark:text-gray-400">
127:           Nenhuma instituicao cadastrada
128:         </div>
129:       </div>
130:       <!-- Create Modal -->
131:       <div :if={@show_modal} class="fixed inset-0 z-50 overflow-y-auto" aria-modal="true">
132:         <div class="flex min-h-screen items-center justify-center p-4">
133:           <div class="fixed inset-0 bg-black/50" phx-click="close_modal"></div>
134:           <div class="relative bg-white dark:bg-slate-800 rounded-xl shadow-xl max-w-md w-full p-6">
135:             <div class="flex items-center justify-between mb-4">
136:               <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Nova Instituicao</h3>
137:               <button
138:                 phx-click="close_modal"
139:                 class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"
140:               >
141:                 <.icon name="hero-x-mark" class="h-5 w-5" />
142:               </button>
143:             </div>
144: 
145:             <form phx-submit="create_institution" class="space-y-4">
146:               <div>
147:                 <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
148:                   Nome
149:                 </label>
150:                 <input
151:                   type="text"
152:                   name="name"
153:                   required
154:                   class="w-full rounded-lg border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-indigo-500 focus:border-indigo-500"
155:                   placeholder="Nome da instituicao"
156:                 />
157:               </div>
158:               <div>
159:                 <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
160:                   Slug
161:                 </label>
162:                 <input
163:                   type="text"
164:                   name="slug"
165:                   required
166:                   pattern="[a-z0-9-]+"
167:                   class="w-full rounded-lg border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-indigo-500 focus:border-indigo-500"
168:                   placeholder="nome-da-instituicao"
169:                 />
170:                 <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
171:                   Apenas letras minusculas, numeros e hifens
172:                 </p>
173:               </div>
174:               <div class="flex justify-end gap-3 pt-4">
175:                 <button
176:                   type="button"
177:                   phx-click="close_modal"
178:                   class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-slate-700 rounded-lg hover:bg-gray-200 dark:hover:bg-slate-600"
179:                 >
180:                   Cancelar
181:                 </button>
182:                 <button
183:                   type="submit"
184:                   class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700"
185:                 >
186:                   Criar Instituicao
187:                 </button>
188:               </div>
189:             </form>
190:           </div>
191:         </div>
192:       </div>
193:     </div>
194:     """
195:   end
196: end
````

## File: lib/hellen_web/live/admin_live/users.ex
````elixir
  1: defmodule HellenWeb.AdminLive.Users do
  2:   @moduledoc """
  3:   Admin Users Management - View and manage all users.
  4:   """
  5:   use HellenWeb, :live_view
  6: 
  7:   alias Hellen.Accounts
  8: 
  9:   @impl true
 10:   def mount(_params, _session, socket) do
 11:     {users, total} = Accounts.list_all_users(page: 1, per_page: 20)
 12:     institutions = Accounts.list_institutions()
 13: 
 14:     {:ok,
 15:      socket
 16:      |> assign(page_title: "Usuarios - Admin")
 17:      |> assign(users: users)
 18:      |> assign(total: total)
 19:      |> assign(page: 1)
 20:      |> assign(per_page: 20)
 21:      |> assign(institutions: institutions)
 22:      |> assign(filter_role: nil)
 23:      |> assign(filter_plan: nil)
 24:      |> assign(filter_institution: nil)
 25:      |> assign(search: "")
 26:      |> assign(show_modal: false)
 27:      |> assign(selected_user: nil)}
 28:   end
 29: 
 30:   @impl true
 31:   def handle_event("filter", params, socket) do
 32:     role = if params["role"] == "", do: nil, else: params["role"]
 33:     plan = if params["plan"] == "", do: nil, else: params["plan"]
 34:     institution_id = if params["institution_id"] == "", do: nil, else: params["institution_id"]
 35:     search = params["search"] || ""
 36: 
 37:     {users, total} =
 38:       Accounts.list_all_users(
 39:         page: 1,
 40:         per_page: socket.assigns.per_page,
 41:         role: role,
 42:         plan: plan,
 43:         institution_id: institution_id,
 44:         search: search
 45:       )
 46: 
 47:     {:noreply,
 48:      socket
 49:      |> assign(users: users)
 50:      |> assign(total: total)
 51:      |> assign(page: 1)
 52:      |> assign(filter_role: role)
 53:      |> assign(filter_plan: plan)
 54:      |> assign(filter_institution: institution_id)
 55:      |> assign(search: search)}
 56:   end
 57: 
 58:   def handle_event("load_more", _params, socket) do
 59:     next_page = socket.assigns.page + 1
 60: 
 61:     {users, _total} =
 62:       Accounts.list_all_users(
 63:         page: next_page,
 64:         per_page: socket.assigns.per_page,
 65:         role: socket.assigns.filter_role,
 66:         plan: socket.assigns.filter_plan,
 67:         institution_id: socket.assigns.filter_institution,
 68:         search: socket.assigns.search
 69:       )
 70: 
 71:     {:noreply,
 72:      socket
 73:      |> assign(users: socket.assigns.users ++ users)
 74:      |> assign(page: next_page)}
 75:   end
 76: 
 77:   def handle_event("edit_user", %{"id" => id}, socket) do
 78:     user = Accounts.get_user!(id)
 79:     {:noreply, socket |> assign(show_modal: true) |> assign(selected_user: user)}
 80:   end
 81: 
 82:   def handle_event("close_modal", _params, socket) do
 83:     {:noreply, assign(socket, show_modal: false, selected_user: nil)}
 84:   end
 85: 
 86:   def handle_event("update_user", params, socket) do
 87:     user = socket.assigns.selected_user
 88: 
 89:     with {:ok, user} <- maybe_update_role(user, params["role"]),
 90:          {:ok, user} <- maybe_update_plan(user, params["plan"]),
 91:          {:ok, _user} <- maybe_update_institution(user, params["institution_id"]) do
 92:       # Reload users list
 93:       {users, total} =
 94:         Accounts.list_all_users(
 95:           page: 1,
 96:           per_page: socket.assigns.per_page,
 97:           role: socket.assigns.filter_role,
 98:           plan: socket.assigns.filter_plan,
 99:           institution_id: socket.assigns.filter_institution,
100:           search: socket.assigns.search
101:         )
102: 
103:       {:noreply,
104:        socket
105:        |> assign(users: users)
106:        |> assign(total: total)
107:        |> assign(page: 1)
108:        |> assign(show_modal: false)
109:        |> assign(selected_user: nil)
110:        |> put_flash(:info, "Usuario atualizado com sucesso!")}
111:     else
112:       {:error, _} ->
113:         {:noreply, put_flash(socket, :error, "Erro ao atualizar usuario")}
114:     end
115:   end
116: 
117:   def handle_event("add_credits", %{"user_id" => user_id, "amount" => amount_str}, socket) do
118:     user = Accounts.get_user!(user_id)
119:     amount = String.to_integer(amount_str)
120: 
121:     case Accounts.admin_add_user_credits(user, amount) do
122:       {:ok, _user} ->
123:         {users, total} =
124:           Accounts.list_all_users(
125:             page: 1,
126:             per_page: socket.assigns.per_page,
127:             role: socket.assigns.filter_role,
128:             plan: socket.assigns.filter_plan,
129:             institution_id: socket.assigns.filter_institution,
130:             search: socket.assigns.search
131:           )
132: 
133:         {:noreply,
134:          socket
135:          |> assign(users: users)
136:          |> assign(total: total)
137:          |> assign(page: 1)
138:          |> put_flash(:info, "#{amount} creditos adicionados!")}
139: 
140:       {:error, _} ->
141:         {:noreply, put_flash(socket, :error, "Erro ao adicionar creditos")}
142:     end
143:   end
144: 
145:   defp maybe_update_role(user, role) when role in ["teacher", "coordinator", "admin"] do
146:     if user.role != role do
147:       Accounts.admin_update_user_role(user, role)
148:     else
149:       {:ok, user}
150:     end
151:   end
152: 
153:   defp maybe_update_role(user, _), do: {:ok, user}
154: 
155:   defp maybe_update_plan(user, plan) when plan in ["free", "pro", "enterprise"] do
156:     if user.plan != plan do
157:       Accounts.admin_update_user_plan(user, plan)
158:     else
159:       {:ok, user}
160:     end
161:   end
162: 
163:   defp maybe_update_plan(user, _), do: {:ok, user}
164: 
165:   defp maybe_update_institution(user, institution_id) do
166:     institution_id = if institution_id == "", do: nil, else: institution_id
167: 
168:     if user.institution_id != institution_id do
169:       Accounts.admin_assign_user_to_institution(user, institution_id)
170:     else
171:       {:ok, user}
172:     end
173:   end
174: 
175:   @impl true
176:   def render(assigns) do
177:     ~H"""
178:     <div class="space-y-6">
179:       <!-- Header -->
180:       <div class="flex items-center justify-between">
181:         <div>
182:           <div class="flex items-center gap-2">
183:             <.link
184:               navigate={~p"/admin"}
185:               class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"
186:             >
187:               <.icon name="hero-arrow-left" class="h-5 w-5" />
188:             </.link>
189:             <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Usuarios</h1>
190:           </div>
191:           <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
192:             <%= @total %> usuarios no total
193:           </p>
194:         </div>
195:       </div>
196:       <!-- Filters -->
197:       <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-4">
198:         <form phx-change="filter" class="flex flex-wrap gap-4">
199:           <div class="flex-1 min-w-[200px]">
200:             <input
201:               type="text"
202:               name="search"
203:               value={@search}
204:               placeholder="Buscar por nome ou email..."
205:               phx-debounce="300"
206:               class="w-full rounded-lg border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-indigo-500 focus:border-indigo-500"
207:             />
208:           </div>
209:           <select
210:             name="role"
211:             class="rounded-lg border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-indigo-500 focus:border-indigo-500"
212:           >
213:             <option value="">Todos os cargos</option>
214:             <option value="teacher" selected={@filter_role == "teacher"}>Professor</option>
215:             <option value="coordinator" selected={@filter_role == "coordinator"}>Coordenador</option>
216:             <option value="admin" selected={@filter_role == "admin"}>Admin</option>
217:           </select>
218:           <select
219:             name="plan"
220:             class="rounded-lg border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-indigo-500 focus:border-indigo-500"
221:           >
222:             <option value="">Todos os planos</option>
223:             <option value="free" selected={@filter_plan == "free"}>Free</option>
224:             <option value="pro" selected={@filter_plan == "pro"}>Pro</option>
225:             <option value="enterprise" selected={@filter_plan == "enterprise"}>Enterprise</option>
226:           </select>
227:           <select
228:             name="institution_id"
229:             class="rounded-lg border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-indigo-500 focus:border-indigo-500"
230:           >
231:             <option value="">Todas instituicoes</option>
232:             <option
233:               :for={inst <- @institutions}
234:               value={inst.id}
235:               selected={@filter_institution == inst.id}
236:             >
237:               <%= inst.name %>
238:             </option>
239:           </select>
240:         </form>
241:       </div>
242:       <!-- Users Table -->
243:       <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 overflow-hidden">
244:         <table class="min-w-full divide-y divide-gray-200 dark:divide-slate-700">
245:           <thead class="bg-gray-50 dark:bg-slate-900/50">
246:             <tr>
247:               <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
248:                 Usuario
249:               </th>
250:               <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
251:                 Cargo
252:               </th>
253:               <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
254:                 Plano
255:               </th>
256:               <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
257:                 Creditos
258:               </th>
259:               <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
260:                 Instituicao
261:               </th>
262:               <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
263:                 Criado em
264:               </th>
265:               <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
266:                 Acoes
267:               </th>
268:             </tr>
269:           </thead>
270:           <tbody class="divide-y divide-gray-200 dark:divide-slate-700">
271:             <tr :for={user <- @users} class="hover:bg-gray-50 dark:hover:bg-slate-700/50">
272:               <td class="px-6 py-4">
273:                 <div class="flex items-center gap-3">
274:                   <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white font-medium text-sm">
275:                     <%= String.first(user.name || "U") |> String.upcase() %>
276:                   </div>
277:                   <div>
278:                     <p class="text-sm font-medium text-gray-900 dark:text-white"><%= user.name %></p>
279:                     <p class="text-xs text-gray-500 dark:text-gray-400"><%= user.email %></p>
280:                   </div>
281:                 </div>
282:               </td>
283:               <td class="px-6 py-4">
284:                 <.badge variant={role_variant(user.role)}><%= role_label(user.role) %></.badge>
285:               </td>
286:               <td class="px-6 py-4">
287:                 <.badge variant={plan_variant(user.plan)}><%= plan_label(user.plan) %></.badge>
288:               </td>
289:               <td class="px-6 py-4 text-sm text-gray-700 dark:text-gray-300">
290:                 <%= user.credits %>
291:               </td>
292:               <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
293:                 <%= (user.institution && user.institution.name) || "-" %>
294:               </td>
295:               <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
296:                 <%= Calendar.strftime(user.inserted_at, "%d/%m/%Y") %>
297:               </td>
298:               <td class="px-6 py-4 text-right">
299:                 <button
300:                   phx-click="edit_user"
301:                   phx-value-id={user.id}
302:                   class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 text-sm font-medium"
303:                 >
304:                   Editar
305:                 </button>
306:               </td>
307:             </tr>
308:           </tbody>
309:         </table>
310: 
311:         <div :if={Enum.empty?(@users)} class="p-8 text-center text-gray-500 dark:text-gray-400">
312:           Nenhum usuario encontrado
313:         </div>
314:         <!-- Load More -->
315:         <div :if={length(@users) < @total} class="p-4 border-t border-gray-200 dark:border-slate-700">
316:           <button
317:             phx-click="load_more"
318:             class="w-full py-2 text-sm font-medium text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300"
319:           >
320:             Carregar mais (<%= @total - length(@users) %> restantes)
321:           </button>
322:         </div>
323:       </div>
324:       <!-- Edit Modal -->
325:       <div
326:         :if={@show_modal && @selected_user}
327:         class="fixed inset-0 z-50 overflow-y-auto"
328:         aria-modal="true"
329:       >
330:         <div class="flex min-h-screen items-center justify-center p-4">
331:           <div class="fixed inset-0 bg-black/50" phx-click="close_modal"></div>
332:           <div class="relative bg-white dark:bg-slate-800 rounded-xl shadow-xl max-w-md w-full p-6">
333:             <div class="flex items-center justify-between mb-4">
334:               <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Editar Usuario</h3>
335:               <button
336:                 phx-click="close_modal"
337:                 class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"
338:               >
339:                 <.icon name="hero-x-mark" class="h-5 w-5" />
340:               </button>
341:             </div>
342: 
343:             <div class="mb-4">
344:               <div class="flex items-center gap-3">
345:                 <div class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white font-medium text-lg">
346:                   <%= String.first(@selected_user.name || "U") |> String.upcase() %>
347:                 </div>
348:                 <div>
349:                   <p class="text-lg font-medium text-gray-900 dark:text-white">
350:                     <%= @selected_user.name %>
351:                   </p>
352:                   <p class="text-sm text-gray-500 dark:text-gray-400"><%= @selected_user.email %></p>
353:                 </div>
354:               </div>
355:             </div>
356: 
357:             <form phx-submit="update_user" class="space-y-4">
358:               <div>
359:                 <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
360:                   Cargo
361:                 </label>
362:                 <select
363:                   name="role"
364:                   class="w-full rounded-lg border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-indigo-500 focus:border-indigo-500"
365:                 >
366:                   <option value="teacher" selected={@selected_user.role == "teacher"}>
367:                     Professor
368:                   </option>
369:                   <option value="coordinator" selected={@selected_user.role == "coordinator"}>
370:                     Coordenador
371:                   </option>
372:                   <option value="admin" selected={@selected_user.role == "admin"}>
373:                     Administrador
374:                   </option>
375:                 </select>
376:               </div>
377: 
378:               <div>
379:                 <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
380:                   Plano
381:                 </label>
382:                 <select
383:                   name="plan"
384:                   class="w-full rounded-lg border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-indigo-500 focus:border-indigo-500"
385:                 >
386:                   <option value="free" selected={@selected_user.plan == "free"}>Free</option>
387:                   <option value="pro" selected={@selected_user.plan == "pro"}>Pro</option>
388:                   <option value="enterprise" selected={@selected_user.plan == "enterprise"}>
389:                     Enterprise
390:                   </option>
391:                 </select>
392:               </div>
393: 
394:               <div>
395:                 <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
396:                   Instituicao
397:                 </label>
398:                 <select
399:                   name="institution_id"
400:                   class="w-full rounded-lg border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-indigo-500 focus:border-indigo-500"
401:                 >
402:                   <option value="">Sem instituicao</option>
403:                   <option
404:                     :for={inst <- @institutions}
405:                     value={inst.id}
406:                     selected={@selected_user.institution_id == inst.id}
407:                   >
408:                     <%= inst.name %>
409:                   </option>
410:                 </select>
411:               </div>
412: 
413:               <div class="border-t border-gray-200 dark:border-slate-700 pt-4">
414:                 <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
415:                   Creditos atuais: <span class="font-bold"><%= @selected_user.credits %></span>
416:                 </label>
417:                 <div class="flex gap-2">
418:                   <button
419:                     type="button"
420:                     phx-click="add_credits"
421:                     phx-value-user_id={@selected_user.id}
422:                     phx-value-amount="5"
423:                     class="px-3 py-1 text-xs font-medium text-emerald-700 dark:text-emerald-400 bg-emerald-100 dark:bg-emerald-900/30 rounded-full hover:bg-emerald-200 dark:hover:bg-emerald-900/50"
424:                   >
425:                     +5
426:                   </button>
427:                   <button
428:                     type="button"
429:                     phx-click="add_credits"
430:                     phx-value-user_id={@selected_user.id}
431:                     phx-value-amount="10"
432:                     class="px-3 py-1 text-xs font-medium text-emerald-700 dark:text-emerald-400 bg-emerald-100 dark:bg-emerald-900/30 rounded-full hover:bg-emerald-200 dark:hover:bg-emerald-900/50"
433:                   >
434:                     +10
435:                   </button>
436:                   <button
437:                     type="button"
438:                     phx-click="add_credits"
439:                     phx-value-user_id={@selected_user.id}
440:                     phx-value-amount="50"
441:                     class="px-3 py-1 text-xs font-medium text-emerald-700 dark:text-emerald-400 bg-emerald-100 dark:bg-emerald-900/30 rounded-full hover:bg-emerald-200 dark:hover:bg-emerald-900/50"
442:                   >
443:                     +50
444:                   </button>
445:                 </div>
446:               </div>
447: 
448:               <div class="flex justify-end gap-3 pt-4">
449:                 <button
450:                   type="button"
451:                   phx-click="close_modal"
452:                   class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-slate-700 rounded-lg hover:bg-gray-200 dark:hover:bg-slate-600"
453:                 >
454:                   Cancelar
455:                 </button>
456:                 <button
457:                   type="submit"
458:                   class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700"
459:                 >
460:                   Salvar Alteracoes
461:                 </button>
462:               </div>
463:             </form>
464:           </div>
465:         </div>
466:       </div>
467:     </div>
468:     """
469:   end
470: 
471:   defp role_label("teacher"), do: "Professor"
472:   defp role_label("coordinator"), do: "Coordenador"
473:   defp role_label("admin"), do: "Admin"
474:   defp role_label(_), do: "Usuario"
475: 
476:   defp role_variant("coordinator"), do: "warning"
477:   defp role_variant("admin"), do: "error"
478:   defp role_variant(_), do: "default"
479: 
480:   defp plan_label("free"), do: "Free"
481:   defp plan_label("pro"), do: "Pro"
482:   defp plan_label("enterprise"), do: "Enterprise"
483:   defp plan_label(_), do: "Plano"
484: 
485:   defp plan_variant("pro"), do: "success"
486:   defp plan_variant("enterprise"), do: "processing"
487:   defp plan_variant(_), do: "default"
488: end
````

## File: lib/hellen_web/live/alerts_live/index.ex
````elixir
  1: defmodule HellenWeb.AlertsLive.Index do
  2:   @moduledoc """
  3:   Centralized alerts panel for bullying and legislation compliance monitoring.
  4:   Shows alerts by severity with filtering and review capabilities.
  5:   """
  6:   use HellenWeb, :live_view
  7: 
  8:   alias Hellen.Analysis
  9: 
 10:   @impl true
 11:   def mount(_params, _session, socket) do
 12:     user = socket.assigns.current_user
 13: 
 14:     {:ok,
 15:      socket
 16:      |> assign(page_title: "Alertas")
 17:      |> assign(filter: :all)
 18:      |> load_alerts_async(user)}
 19:   end
 20: 
 21:   defp load_alerts_async(socket, user) do
 22:     if connected?(socket) and user.institution_id do
 23:       start_async(socket, :load_alerts, fn ->
 24:         alerts = Analysis.list_alerts_by_institution(user.institution_id, limit: 100)
 25:         stats = Analysis.get_alert_stats(user.institution_id)
 26:         %{alerts: alerts, stats: stats}
 27:       end)
 28:     else
 29:       socket
 30:       |> assign(alerts: [])
 31:       |> assign(stats: %{total: 0, unreviewed: 0, reviewed: 0, by_severity: %{}, by_type: %{}})
 32:     end
 33:   end
 34: 
 35:   @impl true
 36:   def handle_async(:load_alerts, {:ok, data}, socket) do
 37:     {:noreply,
 38:      socket
 39:      |> assign(alerts: data.alerts)
 40:      |> assign(stats: data.stats)}
 41:   end
 42: 
 43:   def handle_async(:load_alerts, {:exit, _reason}, socket) do
 44:     {:noreply,
 45:      socket
 46:      |> assign(alerts: [])
 47:      |> assign(stats: %{total: 0, unreviewed: 0, reviewed: 0, by_severity: %{}, by_type: %{}})
 48:      |> put_flash(:error, "Erro ao carregar alertas")}
 49:   end
 50: 
 51:   @impl true
 52:   def handle_event("filter", %{"status" => status}, socket) do
 53:     filter =
 54:       case status do
 55:         "all" -> :all
 56:         "unreviewed" -> :unreviewed
 57:         "reviewed" -> :reviewed
 58:         _ -> :all
 59:       end
 60: 
 61:     {:noreply, assign(socket, filter: filter)}
 62:   end
 63: 
 64:   def handle_event("review", %{"id" => alert_id}, socket) do
 65:     user = socket.assigns.current_user
 66: 
 67:     case Analysis.review_bullying_alert(alert_id, user.id) do
 68:       {:ok, _alert} ->
 69:         {:noreply,
 70:          socket
 71:          |> load_alerts_async(user)
 72:          |> put_flash(:info, "Alerta marcado como revisado")}
 73: 
 74:       {:error, _} ->
 75:         {:noreply, put_flash(socket, :error, "Erro ao revisar alerta")}
 76:     end
 77:   end
 78: 
 79:   defp filtered_alerts(alerts, :all), do: alerts
 80:   defp filtered_alerts(alerts, :unreviewed), do: Enum.filter(alerts, &(!&1.reviewed))
 81:   defp filtered_alerts(alerts, :reviewed), do: Enum.filter(alerts, & &1.reviewed)
 82: 
 83:   @impl true
 84:   def render(assigns) do
 85:     filtered = filtered_alerts(assigns[:alerts] || [], assigns.filter)
 86:     assigns = assign(assigns, :filtered_alerts, filtered)
 87: 
 88:     ~H"""
 89:     <div class="space-y-6">
 90:       <.page_header title="Alertas" description="Monitoramento de bullying e conformidade legal">
 91:         <:actions>
 92:           <div class="flex items-center gap-2">
 93:             <.badge :if={@stats.unreviewed > 0} variant="error">
 94:               <%= @stats.unreviewed %> não revisados
 95:             </.badge>
 96:           </div>
 97:         </:actions>
 98:       </.page_header>
 99:       <!-- Stats Cards -->
100:       <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
101:         <.stat_card
102:           title="Total de Alertas"
103:           value={@stats.total}
104:           icon="hero-bell-alert"
105:           variant="default"
106:         />
107:         <.stat_card
108:           title="Não Revisados"
109:           value={@stats.unreviewed}
110:           icon="hero-exclamation-circle"
111:           variant="pending"
112:         />
113:         <.stat_card
114:           title="Revisados"
115:           value={@stats.reviewed}
116:           icon="hero-check-circle"
117:           variant="success"
118:         />
119:         <.stat_card
120:           title="Alta Severidade"
121:           value={(@stats.by_severity["high"] || 0) + (@stats.by_severity["critical"] || 0)}
122:           icon="hero-fire"
123:           variant="error"
124:         />
125:       </div>
126:       <!-- Charts Row -->
127:       <div :if={@stats.total > 0} class="grid gap-6 lg:grid-cols-2">
128:         <.card>
129:           <:header>
130:             <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Por Severidade</h2>
131:           </:header>
132:           <div
133:             id="severity-chart"
134:             phx-hook="AlertsChart"
135:             phx-update="ignore"
136:             data-chart-data={Jason.encode!(@stats)}
137:             data-chart-type="severity"
138:           >
139:           </div>
140:         </.card>
141: 
142:         <.card>
143:           <:header>
144:             <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Por Tipo</h2>
145:           </:header>
146:           <div
147:             id="type-chart"
148:             phx-hook="AlertsChart"
149:             phx-update="ignore"
150:             data-chart-data={Jason.encode!(@stats)}
151:             data-chart-type="type"
152:           >
153:           </div>
154:         </.card>
155:       </div>
156:       <!-- Filters -->
157:       <div class="flex items-center gap-2">
158:         <span class="text-sm text-gray-500 dark:text-gray-400">Filtrar:</span>
159:         <button
160:           :for={
161:             {value, label} <- [
162:               {"all", "Todos"},
163:               {"unreviewed", "Não revisados"},
164:               {"reviewed", "Revisados"}
165:             ]
166:           }
167:           type="button"
168:           phx-click="filter"
169:           phx-value-status={value}
170:           class={[
171:             "px-3 py-1.5 text-sm rounded-lg transition-colors",
172:             @filter == String.to_atom(value) &&
173:               "bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 font-medium",
174:             @filter != String.to_atom(value) &&
175:               "bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-slate-600"
176:           ]}
177:         >
178:           <%= label %>
179:         </button>
180:       </div>
181:       <!-- Alerts List -->
182:       <div class="space-y-4">
183:         <.alert_card :for={alert <- @filtered_alerts} alert={alert} />
184: 
185:         <.empty_state
186:           :if={length(@filtered_alerts) == 0}
187:           icon="hero-bell-slash"
188:           title="Nenhum alerta encontrado"
189:           description={
190:             if @filter == :all,
191:               do: "Nenhum alerta de bullying foi detectado ainda.",
192:               else: "Nenhum alerta corresponde ao filtro selecionado."
193:           }
194:         />
195:       </div>
196:       <!-- Legal References -->
197:       <.card>
198:         <:header>
199:           <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
200:             Referências Legais
201:           </h2>
202:         </:header>
203:         <div class="grid gap-4 sm:grid-cols-2">
204:           <div class="p-4 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800">
205:             <h3 class="font-semibold text-blue-900 dark:text-blue-300">Lei 13.185/2015</h3>
206:             <p class="mt-1 text-sm text-blue-700 dark:text-blue-400">
207:               Programa de Combate à Intimidação Sistemática (Bullying)
208:             </p>
209:           </div>
210:           <div class="p-4 rounded-lg bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800">
211:             <h3 class="font-semibold text-purple-900 dark:text-purple-300">Lei 14.811/2024</h3>
212:             <p class="mt-1 text-sm text-purple-700 dark:text-purple-400">
213:               Tipificação do crime de bullying e cyberbullying
214:             </p>
215:           </div>
216:         </div>
217:       </.card>
218:     </div>
219:     """
220:   end
221: 
222:   defp alert_card(assigns) do
223:     ~H"""
224:     <div class={[
225:       "p-4 rounded-xl border",
226:       !@alert.reviewed && "bg-white dark:bg-slate-800 border-gray-200 dark:border-slate-700",
227:       @alert.reviewed &&
228:         "bg-gray-50 dark:bg-slate-800/50 border-gray-200 dark:border-slate-700 opacity-75"
229:     ]}>
230:       <div class="flex items-start justify-between gap-4">
231:         <div class="flex items-start gap-3">
232:           <div class={[
233:             "flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center",
234:             @alert.severity == "critical" && "bg-red-100 dark:bg-red-900/30",
235:             @alert.severity == "high" && "bg-orange-100 dark:bg-orange-900/30",
236:             @alert.severity == "medium" && "bg-yellow-100 dark:bg-yellow-900/30",
237:             @alert.severity == "low" && "bg-green-100 dark:bg-green-900/30"
238:           ]}>
239:             <.icon
240:               name={severity_icon(@alert.severity)}
241:               class={"h-5 w-5 #{severity_icon_color(@alert.severity)}"}
242:             />
243:           </div>
244:           <div class="flex-1">
245:             <div class="flex items-center gap-2 mb-1">
246:               <span class={[
247:                 "px-2 py-0.5 text-xs font-medium rounded-full",
248:                 @alert.severity == "critical" &&
249:                   "bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400",
250:                 @alert.severity == "high" &&
251:                   "bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400",
252:                 @alert.severity == "medium" &&
253:                   "bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400",
254:                 @alert.severity == "low" &&
255:                   "bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400"
256:               ]}>
257:                 <%= severity_label(@alert.severity) %>
258:               </span>
259:               <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-400">
260:                 <%= type_label(@alert.alert_type) %>
261:               </span>
262:               <span :if={@alert.reviewed} class="text-xs text-green-600 dark:text-green-400">
263:                 ✓ Revisado
264:               </span>
265:             </div>
266:             <p class="text-sm text-gray-900 dark:text-white font-medium">
267:               <%= @alert.description || "Alerta de comportamento detectado" %>
268:             </p>
269:             <p :if={@alert.evidence_text} class="mt-1 text-sm text-gray-500 dark:text-gray-400 italic">
270:               "<%= String.slice(@alert.evidence_text, 0, 200) %><%= if String.length(
271:                                                                          @alert.evidence_text || ""
272:                                                                        ) > 200, do: "..." %>"
273:             </p>
274:             <div class="mt-2 flex items-center gap-4 text-xs text-gray-500 dark:text-gray-400">
275:               <span :if={@alert.analysis && @alert.analysis.lesson}>
276:                 <.icon name="hero-academic-cap" class="h-3 w-3 inline mr-1" />
277:                 <%= @alert.analysis.lesson.title || "Aula sem título" %>
278:               </span>
279:               <span>
280:                 <.icon name="hero-calendar" class="h-3 w-3 inline mr-1" />
281:                 <%= format_datetime(@alert.inserted_at) %>
282:               </span>
283:             </div>
284:           </div>
285:         </div>
286:         <div class="flex items-center gap-2">
287:           <.link
288:             :if={@alert.analysis && @alert.analysis.lesson}
289:             navigate={~p"/lessons/#{@alert.analysis.lesson.id}"}
290:             class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 text-gray-500 dark:text-gray-400"
291:             title="Ver aula"
292:           >
293:             <.icon name="hero-eye" class="h-5 w-5" />
294:           </.link>
295:           <button
296:             :if={!@alert.reviewed}
297:             type="button"
298:             phx-click="review"
299:             phx-value-id={@alert.id}
300:             class="p-2 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/30 text-gray-500 hover:text-green-600 dark:text-gray-400 dark:hover:text-green-400"
301:             title="Marcar como revisado"
302:           >
303:             <.icon name="hero-check" class="h-5 w-5" />
304:           </button>
305:         </div>
306:       </div>
307:     </div>
308:     """
309:   end
310: 
311:   defp severity_icon("critical"), do: "hero-fire"
312:   defp severity_icon("high"), do: "hero-exclamation-triangle"
313:   defp severity_icon("medium"), do: "hero-exclamation-circle"
314:   defp severity_icon(_), do: "hero-information-circle"
315: 
316:   defp severity_icon_color("critical"), do: "text-red-600 dark:text-red-400"
317:   defp severity_icon_color("high"), do: "text-orange-600 dark:text-orange-400"
318:   defp severity_icon_color("medium"), do: "text-yellow-600 dark:text-yellow-400"
319:   defp severity_icon_color("low"), do: "text-green-600 dark:text-green-400"
320:   defp severity_icon_color(_), do: "text-gray-600 dark:text-gray-400"
321: 
322:   defp severity_label("critical"), do: "Crítico"
323:   defp severity_label("high"), do: "Alto"
324:   defp severity_label("medium"), do: "Médio"
325:   defp severity_label("low"), do: "Baixo"
326:   defp severity_label(_), do: "Indefinido"
327: 
328:   defp type_label("verbal_aggression"), do: "Agressão Verbal"
329:   defp type_label("exclusion"), do: "Exclusão"
330:   defp type_label("intimidation"), do: "Intimidação"
331:   defp type_label("mockery"), do: "Zombaria"
332:   defp type_label("discrimination"), do: "Discriminação"
333:   defp type_label("threat"), do: "Ameaça"
334:   defp type_label("inappropriate_language"), do: "Linguagem Imprópria"
335:   defp type_label("other"), do: "Outros"
336:   defp type_label(_), do: "Indefinido"
337: end
````

## File: lib/hellen_web/live/assessments_live/edit.ex
````elixir
  1: defmodule HellenWeb.AssessmentsLive.Edit do
  2:   @moduledoc """
  3:   LiveView for editing assessments.
  4:   """
  5: 
  6:   use HellenWeb, :live_view
  7: 
  8:   alias Hellen.Assessments
  9:   alias Hellen.Assessments.Assessment
 10: 
 11:   @impl true
 12:   def mount(%{"id" => id}, _session, socket) do
 13:     assessment = Assessments.get_assessment!(id)
 14:     changeset = Assessments.change_assessment(assessment)
 15: 
 16:     {:ok,
 17:      socket
 18:      |> assign(:page_title, "Editar Avaliação")
 19:      |> assign(:assessment, assessment)
 20:      |> assign(:changeset, changeset)}
 21:   end
 22: 
 23:   @impl true
 24:   def handle_event("validate", %{"assessment" => assessment_params}, socket) do
 25:     changeset =
 26:       socket.assigns.assessment
 27:       |> Assessments.change_assessment(assessment_params)
 28:       |> Map.put(:action, :validate)
 29: 
 30:     {:noreply, assign(socket, :changeset, changeset)}
 31:   end
 32: 
 33:   @impl true
 34:   def handle_event("save", %{"assessment" => assessment_params}, socket) do
 35:     case Assessments.update_assessment(socket.assigns.assessment, assessment_params) do
 36:       {:ok, assessment} ->
 37:         {:noreply,
 38:          socket
 39:          |> put_flash(:info, "Avaliação atualizada com sucesso!")
 40:          |> push_navigate(to: ~p"/assessments/#{assessment.id}")}
 41: 
 42:       {:error, %Ecto.Changeset{} = changeset} ->
 43:         {:noreply, assign(socket, :changeset, changeset)}
 44:     end
 45:   end
 46: 
 47:   @impl true
 48:   def render(assigns) do
 49:     ~H"""
 50:     <div class="min-h-screen bg-slate-50 dark:bg-slate-900">
 51:       <!-- Header -->
 52:       <div class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
 53:         <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
 54:           <div class="flex items-center gap-4">
 55:             <.link
 56:               navigate={~p"/assessments/#{@assessment.id}"}
 57:               class="p-2 rounded-lg text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"
 58:             >
 59:               <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
 60:                 <path
 61:                   stroke-linecap="round"
 62:                   stroke-linejoin="round"
 63:                   stroke-width="2"
 64:                   d="M10 19l-7-7m0 0l7-7m-7 7h18"
 65:                 />
 66:               </svg>
 67:             </.link>
 68:             <div>
 69:               <h1 class="text-2xl font-bold text-slate-900 dark:text-white">
 70:                 Editar Avaliação
 71:               </h1>
 72:               <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">
 73:                 <%= @assessment.title %>
 74:               </p>
 75:             </div>
 76:           </div>
 77:         </div>
 78:       </div>
 79:       <!-- Content -->
 80:       <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
 81:         <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
 82:           <.form for={@changeset} phx-change="validate" phx-submit="save" class="space-y-6">
 83:             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
 84:               <div class="md:col-span-2">
 85:                 <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
 86:                   Título *
 87:                 </label>
 88:                 <input
 89:                   type="text"
 90:                   name="assessment[title]"
 91:                   value={Phoenix.HTML.Form.input_value(@changeset, :title)}
 92:                   placeholder="Ex: Prova de Matemática - 1º Bimestre"
 93:                   class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-teal-500"
 94:                   required
 95:                 />
 96:               </div>
 97: 
 98:               <div>
 99:                 <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
100:                   Disciplina *
101:                 </label>
102:                 <select
103:                   name="assessment[subject]"
104:                   class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
105:                   required
106:                 >
107:                   <option value="">Selecione...</option>
108:                   <%= for subject <- Assessment.subjects() do %>
109:                     <option
110:                       value={subject}
111:                       selected={Phoenix.HTML.Form.input_value(@changeset, :subject) == subject}
112:                     >
113:                       <%= Assessment.subject_label(subject) %>
114:                     </option>
115:                   <% end %>
116:                 </select>
117:               </div>
118: 
119:               <div>
120:                 <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
121:                   Ano/Série *
122:                 </label>
123:                 <select
124:                   name="assessment[grade_level]"
125:                   class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
126:                   required
127:                 >
128:                   <option value="">Selecione...</option>
129:                   <%= for level <- Assessment.grade_levels() do %>
130:                     <option
131:                       value={level}
132:                       selected={Phoenix.HTML.Form.input_value(@changeset, :grade_level) == level}
133:                     >
134:                       <%= Assessment.grade_level_label(level) %>
135:                     </option>
136:                   <% end %>
137:                 </select>
138:               </div>
139: 
140:               <div>
141:                 <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
142:                   Tipo de Avaliação
143:                 </label>
144:                 <select
145:                   name="assessment[assessment_type]"
146:                   class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
147:                 >
148:                   <%= for type <- Assessment.assessment_types() do %>
149:                     <option
150:                       value={type}
151:                       selected={Phoenix.HTML.Form.input_value(@changeset, :assessment_type) == type}
152:                     >
153:                       <%= Assessment.assessment_type_label(type) %>
154:                     </option>
155:                   <% end %>
156:                 </select>
157:               </div>
158: 
159:               <div>
160:                 <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
161:                   Dificuldade
162:                 </label>
163:                 <select
164:                   name="assessment[difficulty_level]"
165:                   class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
166:                 >
167:                   <%= for level <- Assessment.difficulty_levels() do %>
168:                     <option
169:                       value={level}
170:                       selected={Phoenix.HTML.Form.input_value(@changeset, :difficulty_level) == level}
171:                     >
172:                       <%= Assessment.difficulty_label(level) %>
173:                     </option>
174:                   <% end %>
175:                 </select>
176:               </div>
177: 
178:               <div>
179:                 <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
180:                   Duração (minutos)
181:                 </label>
182:                 <input
183:                   type="number"
184:                   name="assessment[duration_minutes]"
185:                   value={Phoenix.HTML.Form.input_value(@changeset, :duration_minutes)}
186:                   min="15"
187:                   max="480"
188:                   class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
189:                 />
190:               </div>
191: 
192:               <div>
193:                 <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
194:                   Status
195:                 </label>
196:                 <select
197:                   name="assessment[status]"
198:                   class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
199:                 >
200:                   <%= for status <- Assessment.statuses() do %>
201:                     <option
202:                       value={status}
203:                       selected={Phoenix.HTML.Form.input_value(@changeset, :status) == status}
204:                     >
205:                       <%= Assessment.status_label(status) %>
206:                     </option>
207:                   <% end %>
208:                 </select>
209:               </div>
210: 
211:               <div class="md:col-span-2">
212:                 <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
213:                   Descrição
214:                 </label>
215:                 <textarea
216:                   name="assessment[description]"
217:                   rows="3"
218:                   placeholder="Breve descrição do que será avaliado"
219:                   class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-teal-500"
220:                 ><%= Phoenix.HTML.Form.input_value(@changeset, :description) %></textarea>
221:               </div>
222: 
223:               <div class="md:col-span-2">
224:                 <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
225:                   Instruções para os Alunos
226:                 </label>
227:                 <textarea
228:                   name="assessment[instructions]"
229:                   rows="4"
230:                   placeholder="Instruções que aparecerão no início da avaliação"
231:                   class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-teal-500"
232:                 ><%= Phoenix.HTML.Form.input_value(@changeset, :instructions) %></textarea>
233:               </div>
234:             </div>
235: 
236:             <div class="flex justify-end gap-3 pt-4 border-t border-slate-200 dark:border-slate-700">
237:               <.link
238:                 navigate={~p"/assessments/#{@assessment.id}"}
239:                 class="px-4 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"
240:               >
241:                 Cancelar
242:               </.link>
243:               <button
244:                 type="submit"
245:                 class="px-6 py-2 bg-teal-600 hover:bg-teal-700 text-white font-medium rounded-lg transition-colors"
246:               >
247:                 Salvar Alterações
248:               </button>
249:             </div>
250:           </.form>
251:         </div>
252:       </div>
253:     </div>
254:     """
255:   end
256: end
````

## File: lib/hellen_web/live/assessments_live/index.ex
````elixir
  1: defmodule HellenWeb.AssessmentsLive.Index do
  2:   @moduledoc """
  3:   LiveView for listing and managing assessments.
  4:   """
  5: 
  6:   use HellenWeb, :live_view
  7: 
  8:   alias Hellen.Assessments
  9:   alias Hellen.Assessments.Assessment
 10: 
 11:   @impl true
 12:   def mount(_params, _session, socket) do
 13:     {:ok,
 14:      socket
 15:      |> assign(:page_title, "Avaliações")
 16:      |> assign(:filter_status, nil)
 17:      |> assign(:filter_subject, nil)
 18:      |> assign(:filter_type, nil)
 19:      |> assign(:search_query, "")
 20:      |> assign(:view_mode, "cards")
 21:      |> load_assessments()
 22:      |> load_stats()}
 23:   end
 24: 
 25:   @impl true
 26:   def handle_params(params, _url, socket) do
 27:     {:noreply, apply_action(socket, socket.assigns.live_action, params)}
 28:   end
 29: 
 30:   defp apply_action(socket, :index, _params) do
 31:     socket
 32:   end
 33: 
 34:   @impl true
 35:   def handle_event("filter_status", %{"status" => status}, socket) do
 36:     status = if status == "", do: nil, else: status
 37: 
 38:     {:noreply,
 39:      socket
 40:      |> assign(:filter_status, status)
 41:      |> load_assessments()}
 42:   end
 43: 
 44:   @impl true
 45:   def handle_event("filter_subject", %{"subject" => subject}, socket) do
 46:     subject = if subject == "", do: nil, else: subject
 47: 
 48:     {:noreply,
 49:      socket
 50:      |> assign(:filter_subject, subject)
 51:      |> load_assessments()}
 52:   end
 53: 
 54:   @impl true
 55:   def handle_event("filter_type", %{"type" => type}, socket) do
 56:     type = if type == "", do: nil, else: type
 57: 
 58:     {:noreply,
 59:      socket
 60:      |> assign(:filter_type, type)
 61:      |> load_assessments()}
 62:   end
 63: 
 64:   @impl true
 65:   def handle_event("search", %{"query" => query}, socket) do
 66:     {:noreply,
 67:      socket
 68:      |> assign(:search_query, query)
 69:      |> load_assessments()}
 70:   end
 71: 
 72:   @impl true
 73:   def handle_event("toggle_view", %{"mode" => mode}, socket) do
 74:     {:noreply, assign(socket, :view_mode, mode)}
 75:   end
 76: 
 77:   @impl true
 78:   def handle_event("delete", %{"id" => id}, socket) do
 79:     assessment = Assessments.get_assessment!(id)
 80: 
 81:     case Assessments.delete_assessment(assessment) do
 82:       {:ok, _} ->
 83:         {:noreply,
 84:          socket
 85:          |> put_flash(:info, "Avaliação excluída com sucesso!")
 86:          |> load_assessments()
 87:          |> load_stats()}
 88: 
 89:       {:error, _} ->
 90:         {:noreply, put_flash(socket, :error, "Erro ao excluir avaliação")}
 91:     end
 92:   end
 93: 
 94:   @impl true
 95:   def handle_event("duplicate", %{"id" => id}, socket) do
 96:     assessment = Assessments.get_assessment!(id)
 97:     user_id = socket.assigns.current_user.id
 98: 
 99:     case Assessments.duplicate_assessment(assessment, user_id) do
100:       {:ok, new_assessment} ->
101:         {:noreply,
102:          socket
103:          |> put_flash(:info, "Avaliação duplicada!")
104:          |> push_navigate(to: ~p"/assessments/#{new_assessment.id}/edit")}
105: 
106:       {:error, _} ->
107:         {:noreply, put_flash(socket, :error, "Erro ao duplicar avaliação")}
108:     end
109:   end
110: 
111:   @impl true
112:   def handle_event("publish", %{"id" => id}, socket) do
113:     assessment = Assessments.get_assessment!(id)
114: 
115:     case Assessments.publish_assessment(assessment) do
116:       {:ok, _} ->
117:         {:noreply,
118:          socket
119:          |> put_flash(:info, "Avaliação publicada!")
120:          |> load_assessments()
121:          |> load_stats()}
122: 
123:       {:error, changeset} ->
124:         error_msg = error_message(changeset)
125:         {:noreply, put_flash(socket, :error, error_msg)}
126:     end
127:   end
128: 
129:   @impl true
130:   def handle_event("archive", %{"id" => id}, socket) do
131:     assessment = Assessments.get_assessment!(id)
132: 
133:     case Assessments.archive_assessment(assessment) do
134:       {:ok, _} ->
135:         {:noreply,
136:          socket
137:          |> put_flash(:info, "Avaliação arquivada!")
138:          |> load_assessments()
139:          |> load_stats()}
140: 
141:       {:error, _} ->
142:         {:noreply, put_flash(socket, :error, "Erro ao arquivar avaliação")}
143:     end
144:   end
145: 
146:   defp load_assessments(socket) do
147:     user_id = socket.assigns.current_user.id
148: 
149:     filters =
150:       [
151:         status: socket.assigns.filter_status,
152:         subject: socket.assigns.filter_subject,
153:         assessment_type: socket.assigns.filter_type,
154:         search: socket.assigns.search_query
155:       ]
156:       |> Enum.reject(fn {_k, v} -> is_nil(v) or v == "" end)
157: 
158:     assessments = Assessments.list_assessments(user_id, filters)
159:     assign(socket, :assessments, assessments)
160:   end
161: 
162:   defp load_stats(socket) do
163:     user_id = socket.assigns.current_user.id
164:     stats = Assessments.get_stats(user_id)
165:     assign(socket, :stats, stats)
166:   end
167: 
168:   defp error_message(changeset) do
169:     changeset
170:     |> Ecto.Changeset.traverse_errors(fn {msg, _opts} -> msg end)
171:     |> Enum.map_join("; ", fn {field, msgs} -> "#{field}: #{Enum.join(msgs, ", ")}" end)
172:   end
173: 
174:   @impl true
175:   def render(assigns) do
176:     ~H"""
177:     <div class="min-h-screen bg-slate-50 dark:bg-slate-900">
178:       <!-- Header -->
179:       <div class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
180:         <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
181:           <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
182:             <div>
183:               <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Avaliações</h1>
184:               <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">
185:                 Gerencie suas provas, atividades e avaliações
186:               </p>
187:             </div>
188:             <.link
189:               navigate={~p"/assessments/new"}
190:               class="inline-flex items-center gap-2 px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white font-medium rounded-lg transition-colors"
191:             >
192:               <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
193:                 <path
194:                   stroke-linecap="round"
195:                   stroke-linejoin="round"
196:                   stroke-width="2"
197:                   d="M12 4v16m8-8H4"
198:                 />
199:               </svg>
200:               Nova Avaliação
201:             </.link>
202:           </div>
203:         </div>
204:       </div>
205:       <!-- Stats Cards -->
206:       <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
207:         <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
208:           <div class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
209:             <div class="flex items-center gap-3">
210:               <div class="p-2 bg-teal-100 dark:bg-teal-900/30 rounded-lg">
211:                 <svg
212:                   class="w-5 h-5 text-teal-600 dark:text-teal-400"
213:                   fill="none"
214:                   stroke="currentColor"
215:                   viewBox="0 0 24 24"
216:                 >
217:                   <path
218:                     stroke-linecap="round"
219:                     stroke-linejoin="round"
220:                     stroke-width="2"
221:                     d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
222:                   />
223:                 </svg>
224:               </div>
225:               <div>
226:                 <p class="text-2xl font-bold text-slate-900 dark:text-white"><%= @stats.total %></p>
227:                 <p class="text-xs text-slate-500 dark:text-slate-400">Total</p>
228:               </div>
229:             </div>
230:           </div>
231: 
232:           <div class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
233:             <div class="flex items-center gap-3">
234:               <div class="p-2 bg-amber-100 dark:bg-amber-900/30 rounded-lg">
235:                 <svg
236:                   class="w-5 h-5 text-amber-600 dark:text-amber-400"
237:                   fill="none"
238:                   stroke="currentColor"
239:                   viewBox="0 0 24 24"
240:                 >
241:                   <path
242:                     stroke-linecap="round"
243:                     stroke-linejoin="round"
244:                     stroke-width="2"
245:                     d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
246:                   />
247:                 </svg>
248:               </div>
249:               <div>
250:                 <p class="text-2xl font-bold text-slate-900 dark:text-white">
251:                   <%= @stats.by_status["draft"] || 0 %>
252:                 </p>
253:                 <p class="text-xs text-slate-500 dark:text-slate-400">Rascunhos</p>
254:               </div>
255:             </div>
256:           </div>
257: 
258:           <div class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
259:             <div class="flex items-center gap-3">
260:               <div class="p-2 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg">
261:                 <svg
262:                   class="w-5 h-5 text-emerald-600 dark:text-emerald-400"
263:                   fill="none"
264:                   stroke="currentColor"
265:                   viewBox="0 0 24 24"
266:                 >
267:                   <path
268:                     stroke-linecap="round"
269:                     stroke-linejoin="round"
270:                     stroke-width="2"
271:                     d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
272:                   />
273:                 </svg>
274:               </div>
275:               <div>
276:                 <p class="text-2xl font-bold text-slate-900 dark:text-white">
277:                   <%= @stats.by_status["published"] || 0 %>
278:                 </p>
279:                 <p class="text-xs text-slate-500 dark:text-slate-400">Publicadas</p>
280:               </div>
281:             </div>
282:           </div>
283: 
284:           <div class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
285:             <div class="flex items-center gap-3">
286:               <div class="p-2 bg-violet-100 dark:bg-violet-900/30 rounded-lg">
287:                 <svg
288:                   class="w-5 h-5 text-violet-600 dark:text-violet-400"
289:                   fill="none"
290:                   stroke="currentColor"
291:                   viewBox="0 0 24 24"
292:                 >
293:                   <path
294:                     stroke-linecap="round"
295:                     stroke-linejoin="round"
296:                     stroke-width="2"
297:                     d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
298:                   />
299:                 </svg>
300:               </div>
301:               <div>
302:                 <p class="text-2xl font-bold text-slate-900 dark:text-white">
303:                   <%= @stats.total_questions %>
304:                 </p>
305:                 <p class="text-xs text-slate-500 dark:text-slate-400">Questões</p>
306:               </div>
307:             </div>
308:           </div>
309:         </div>
310:         <!-- Filters -->
311:         <div class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700 mb-6">
312:           <div class="flex flex-wrap items-center gap-4">
313:             <div class="flex-1 min-w-[200px]">
314:               <form phx-change="search" phx-submit="search">
315:                 <div class="relative">
316:                   <svg
317:                     class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"
318:                     fill="none"
319:                     stroke="currentColor"
320:                     viewBox="0 0 24 24"
321:                   >
322:                     <path
323:                       stroke-linecap="round"
324:                       stroke-linejoin="round"
325:                       stroke-width="2"
326:                       d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
327:                     />
328:                   </svg>
329:                   <input
330:                     type="text"
331:                     name="query"
332:                     value={@search_query}
333:                     placeholder="Buscar avaliações..."
334:                     class="w-full pl-10 pr-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-teal-500"
335:                     phx-debounce="300"
336:                   />
337:                 </div>
338:               </form>
339:             </div>
340: 
341:             <form phx-change="filter_status">
342:               <select
343:                 name="status"
344:                 class="px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-teal-500"
345:               >
346:                 <option value="">Todos os status</option>
347:                 <%= for status <- Assessment.statuses() do %>
348:                   <option value={status} selected={@filter_status == status}>
349:                     <%= Assessment.status_label(status) %>
350:                   </option>
351:                 <% end %>
352:               </select>
353:             </form>
354: 
355:             <form phx-change="filter_subject">
356:               <select
357:                 name="subject"
358:                 class="px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-teal-500"
359:               >
360:                 <option value="">Todas as disciplinas</option>
361:                 <%= for subject <- Assessment.subjects() do %>
362:                   <option value={subject} selected={@filter_subject == subject}>
363:                     <%= Assessment.subject_label(subject) %>
364:                   </option>
365:                 <% end %>
366:               </select>
367:             </form>
368: 
369:             <form phx-change="filter_type">
370:               <select
371:                 name="type"
372:                 class="px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-teal-500"
373:               >
374:                 <option value="">Todos os tipos</option>
375:                 <%= for type <- Assessment.assessment_types() do %>
376:                   <option value={type} selected={@filter_type == type}>
377:                     <%= Assessment.assessment_type_label(type) %>
378:                   </option>
379:                 <% end %>
380:               </select>
381:             </form>
382: 
383:             <div class="flex items-center gap-1 bg-slate-100 dark:bg-slate-700 rounded-lg p-1">
384:               <button
385:                 type="button"
386:                 phx-click="toggle_view"
387:                 phx-value-mode="cards"
388:                 class={"px-3 py-1 rounded text-sm transition-colors #{if @view_mode == "cards", do: "bg-white dark:bg-slate-600 text-slate-900 dark:text-white shadow-sm", else: "text-slate-500 hover:text-slate-700 dark:text-slate-400"}"}
389:               >
390:                 <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
391:                   <path
392:                     stroke-linecap="round"
393:                     stroke-linejoin="round"
394:                     stroke-width="2"
395:                     d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
396:                   />
397:                 </svg>
398:               </button>
399:               <button
400:                 type="button"
401:                 phx-click="toggle_view"
402:                 phx-value-mode="table"
403:                 class={"px-3 py-1 rounded text-sm transition-colors #{if @view_mode == "table", do: "bg-white dark:bg-slate-600 text-slate-900 dark:text-white shadow-sm", else: "text-slate-500 hover:text-slate-700 dark:text-slate-400"}"}
404:               >
405:                 <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
406:                   <path
407:                     stroke-linecap="round"
408:                     stroke-linejoin="round"
409:                     stroke-width="2"
410:                     d="M4 6h16M4 10h16M4 14h16M4 18h16"
411:                   />
412:                 </svg>
413:               </button>
414:             </div>
415:           </div>
416:         </div>
417:         <!-- Content -->
418:         <%= if Enum.empty?(@assessments) do %>
419:           <div class="bg-white dark:bg-slate-800 rounded-xl p-12 border border-slate-200 dark:border-slate-700 text-center">
420:             <div class="w-16 h-16 mx-auto mb-4 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center">
421:               <svg
422:                 class="w-8 h-8 text-slate-400"
423:                 fill="none"
424:                 stroke="currentColor"
425:                 viewBox="0 0 24 24"
426:               >
427:                 <path
428:                   stroke-linecap="round"
429:                   stroke-linejoin="round"
430:                   stroke-width="2"
431:                   d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"
432:                 />
433:               </svg>
434:             </div>
435:             <h3 class="text-lg font-medium text-slate-900 dark:text-white mb-2">
436:               Nenhuma avaliação encontrada
437:             </h3>
438:             <p class="text-slate-500 dark:text-slate-400 mb-6">
439:               Crie sua primeira avaliação para começar
440:             </p>
441:             <.link
442:               navigate={~p"/assessments/new"}
443:               class="inline-flex items-center gap-2 px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white font-medium rounded-lg transition-colors"
444:             >
445:               <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
446:                 <path
447:                   stroke-linecap="round"
448:                   stroke-linejoin="round"
449:                   stroke-width="2"
450:                   d="M12 4v16m8-8H4"
451:                 />
452:               </svg>
453:               Nova Avaliação
454:             </.link>
455:           </div>
456:         <% else %>
457:           <%= if @view_mode == "cards" do %>
458:             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
459:               <%= for assessment <- @assessments do %>
460:                 <.assessment_card assessment={assessment} />
461:               <% end %>
462:             </div>
463:           <% else %>
464:             <.assessments_table assessments={@assessments} />
465:           <% end %>
466:         <% end %>
467:       </div>
468:     </div>
469:     """
470:   end
471: 
472:   defp assessment_card(assigns) do
473:     ~H"""
474:     <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-5 hover:shadow-lg transition-shadow">
475:       <div class="flex items-start justify-between mb-3">
476:         <span class={"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium #{status_color(@assessment.status)}"}>
477:           <%= Assessment.status_label(@assessment.status) %>
478:         </span>
479:         <span class="text-xs text-slate-400">
480:           <%= Calendar.strftime(@assessment.inserted_at, "%d/%m/%Y") %>
481:         </span>
482:       </div>
483: 
484:       <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-2 line-clamp-2">
485:         <%= @assessment.title %>
486:       </h3>
487: 
488:       <div class="flex flex-wrap gap-2 mb-4 text-xs text-slate-500 dark:text-slate-400">
489:         <span class="inline-flex items-center gap-1">
490:           <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
491:             <path
492:               stroke-linecap="round"
493:               stroke-linejoin="round"
494:               stroke-width="2"
495:               d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
496:             />
497:           </svg>
498:           <%= Assessment.subject_label(@assessment.subject) %>
499:         </span>
500:         <span class="inline-flex items-center gap-1">
501:           <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
502:             <path
503:               stroke-linecap="round"
504:               stroke-linejoin="round"
505:               stroke-width="2"
506:               d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
507:             />
508:           </svg>
509:           <%= Assessment.grade_level_label(@assessment.grade_level) %>
510:         </span>
511:         <span class={"inline-flex items-center gap-1 #{type_color(@assessment.assessment_type)}"}>
512:           <%= Assessment.assessment_type_label(@assessment.assessment_type) %>
513:         </span>
514:       </div>
515: 
516:       <div class="flex items-center gap-4 mb-4">
517:         <div class="text-center">
518:           <p class="text-lg font-bold text-slate-900 dark:text-white">
519:             <%= length(@assessment.questions || []) %>
520:           </p>
521:           <p class="text-xs text-slate-500">questões</p>
522:         </div>
523:         <div class="text-center">
524:           <p class="text-lg font-bold text-slate-900 dark:text-white">
525:             <%= @assessment.total_points || 0 %>
526:           </p>
527:           <p class="text-xs text-slate-500">pontos</p>
528:         </div>
529:         <div class="text-center">
530:           <p class="text-lg font-bold text-slate-900 dark:text-white">
531:             <%= @assessment.duration_minutes || "-" %>
532:           </p>
533:           <p class="text-xs text-slate-500">min</p>
534:         </div>
535:       </div>
536: 
537:       <%= if @assessment.generated_by_ai do %>
538:         <div class="mb-4">
539:           <span class="inline-flex items-center gap-1 px-2 py-1 bg-violet-100 dark:bg-violet-900/30 text-violet-600 dark:text-violet-400 rounded text-xs">
540:             <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
541:               <path
542:                 stroke-linecap="round"
543:                 stroke-linejoin="round"
544:                 stroke-width="2"
545:                 d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
546:               />
547:             </svg>
548:             Gerado com IA
549:           </span>
550:         </div>
551:       <% end %>
552: 
553:       <div class="flex items-center justify-between pt-4 border-t border-slate-200 dark:border-slate-700">
554:         <.link
555:           navigate={~p"/assessments/#{@assessment.id}"}
556:           class="text-teal-600 hover:text-teal-700 dark:text-teal-400 dark:hover:text-teal-300 font-medium text-sm"
557:         >
558:           Ver detalhes
559:         </.link>
560: 
561:         <div class="flex items-center gap-1">
562:           <.link
563:             navigate={~p"/assessments/#{@assessment.id}/edit"}
564:             class="p-2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"
565:             title="Editar"
566:           >
567:             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
568:               <path
569:                 stroke-linecap="round"
570:                 stroke-linejoin="round"
571:                 stroke-width="2"
572:                 d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
573:               />
574:             </svg>
575:           </.link>
576: 
577:           <button
578:             type="button"
579:             phx-click="duplicate"
580:             phx-value-id={@assessment.id}
581:             class="p-2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"
582:             title="Duplicar"
583:           >
584:             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
585:               <path
586:                 stroke-linecap="round"
587:                 stroke-linejoin="round"
588:                 stroke-width="2"
589:                 d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
590:               />
591:             </svg>
592:           </button>
593: 
594:           <button
595:             type="button"
596:             phx-click="delete"
597:             phx-value-id={@assessment.id}
598:             data-confirm="Tem certeza que deseja excluir esta avaliação?"
599:             class="p-2 text-slate-400 hover:text-red-600 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
600:             title="Excluir"
601:           >
602:             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
603:               <path
604:                 stroke-linecap="round"
605:                 stroke-linejoin="round"
606:                 stroke-width="2"
607:                 d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
608:               />
609:             </svg>
610:           </button>
611:         </div>
612:       </div>
613:     </div>
614:     """
615:   end
616: 
617:   defp assessments_table(assigns) do
618:     ~H"""
619:     <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
620:       <table class="w-full">
621:         <thead class="bg-slate-50 dark:bg-slate-700/50">
622:           <tr>
623:             <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
624:               Avaliação
625:             </th>
626:             <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
627:               Tipo
628:             </th>
629:             <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
630:               Questões
631:             </th>
632:             <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
633:               Status
634:             </th>
635:             <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
636:               Data
637:             </th>
638:             <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
639:               Ações
640:             </th>
641:           </tr>
642:         </thead>
643:         <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
644:           <%= for assessment <- @assessments do %>
645:             <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
646:               <td class="px-6 py-4">
647:                 <div>
648:                   <.link
649:                     navigate={~p"/assessments/#{assessment.id}"}
650:                     class="font-medium text-slate-900 dark:text-white hover:text-teal-600 dark:hover:text-teal-400"
651:                   >
652:                     <%= assessment.title %>
653:                   </.link>
654:                   <p class="text-sm text-slate-500 dark:text-slate-400">
655:                     <%= Assessment.subject_label(assessment.subject) %> • <%= Assessment.grade_level_label(
656:                       assessment.grade_level
657:                     ) %>
658:                   </p>
659:                 </div>
660:               </td>
661:               <td class="px-6 py-4">
662:                 <span class={"text-sm #{type_color(assessment.assessment_type)}"}>
663:                   <%= Assessment.assessment_type_label(assessment.assessment_type) %>
664:                 </span>
665:               </td>
666:               <td class="px-6 py-4 text-sm text-slate-900 dark:text-white">
667:                 <%= length(assessment.questions || []) %>
668:               </td>
669:               <td class="px-6 py-4">
670:                 <span class={"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium #{status_color(assessment.status)}"}>
671:                   <%= Assessment.status_label(assessment.status) %>
672:                 </span>
673:               </td>
674:               <td class="px-6 py-4 text-sm text-slate-500 dark:text-slate-400">
675:                 <%= Calendar.strftime(assessment.inserted_at, "%d/%m/%Y") %>
676:               </td>
677:               <td class="px-6 py-4 text-right">
678:                 <div class="flex items-center justify-end gap-1">
679:                   <.link
680:                     navigate={~p"/assessments/#{assessment.id}/edit"}
681:                     class="p-2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
682:                   >
683:                     <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
684:                       <path
685:                         stroke-linecap="round"
686:                         stroke-linejoin="round"
687:                         stroke-width="2"
688:                         d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
689:                       />
690:                     </svg>
691:                   </.link>
692:                   <button
693:                     type="button"
694:                     phx-click="delete"
695:                     phx-value-id={assessment.id}
696:                     data-confirm="Tem certeza?"
697:                     class="p-2 text-slate-400 hover:text-red-600 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg"
698:                   >
699:                     <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
700:                       <path
701:                         stroke-linecap="round"
702:                         stroke-linejoin="round"
703:                         stroke-width="2"
704:                         d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
705:                       />
706:                     </svg>
707:                   </button>
708:                 </div>
709:               </td>
710:             </tr>
711:           <% end %>
712:         </tbody>
713:       </table>
714:     </div>
715:     """
716:   end
717: 
718:   defp status_color("draft"),
719:     do: "bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400"
720: 
721:   defp status_color("published"),
722:     do: "bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400"
723: 
724:   defp status_color("archived"),
725:     do: "bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400"
726: 
727:   defp status_color(_), do: "bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400"
728: 
729:   defp type_color("prova"), do: "text-teal-600 dark:text-teal-400"
730:   defp type_color("simulado"), do: "text-violet-600 dark:text-violet-400"
731:   defp type_color("quiz"), do: "text-pink-600 dark:text-pink-400"
732:   defp type_color(_), do: "text-slate-600 dark:text-slate-400"
733: end
````

## File: lib/hellen_web/live/assessments_live/new.ex
````elixir
  1: defmodule HellenWeb.AssessmentsLive.New do
  2:   @moduledoc """
  3:   LiveView for creating new assessments.
  4: 
  5:   Supports three creation modes:
  6:   - Manual: Fill form manually
  7:   - From Planning: AI generates from existing planning
  8:   - From Topic: AI generates from topic description
  9:   """
 10: 
 11:   use HellenWeb, :live_view
 12: 
 13:   alias Hellen.AI.AssessmentGenerator
 14:   alias Hellen.Assessments
 15:   alias Hellen.Assessments.Assessment
 16:   alias Hellen.Plannings
 17: 
 18:   @impl true
 19:   def mount(_params, _session, socket) do
 20:     changeset = Assessments.change_assessment(%Assessment{})
 21:     user_id = socket.assigns.current_user.id
 22:     plannings = Plannings.list_plannings(user_id, status: "published", limit: 50)
 23: 
 24:     {:ok,
 25:      socket
 26:      |> assign(:page_title, "Nova Avaliação")
 27:      |> assign(:form, to_form(changeset))
 28:      |> assign(:mode, "manual")
 29:      |> assign(:plannings, plannings)
 30:      |> assign(:selected_planning_id, nil)
 31:      |> assign(:topic, "")
 32:      |> assign(:subject, "portugues")
 33:      |> assign(:grade_level, "5_ano")
 34:      |> assign(:assessment_type, "prova")
 35:      |> assign(:difficulty_level, "medio")
 36:      |> assign(:num_questions, 10)
 37:      |> assign(:question_types, ["multiple_choice", "true_false", "short_answer"])
 38:      |> assign(:generating, false)
 39:      |> assign(:generation_error, nil)}
 40:   end
 41: 
 42:   @impl true
 43:   def handle_event("change_mode", %{"mode" => mode}, socket) do
 44:     {:noreply, assign(socket, :mode, mode)}
 45:   end
 46: 
 47:   @impl true
 48:   def handle_event("validate", %{"assessment" => params}, socket) do
 49:     changeset =
 50:       %Assessment{}
 51:       |> Assessments.change_assessment(params)
 52:       |> Map.put(:action, :validate)
 53: 
 54:     {:noreply, assign(socket, :form, to_form(changeset))}
 55:   end
 56: 
 57:   @impl true
 58:   def handle_event("save", %{"assessment" => params}, socket) do
 59:     user_id = socket.assigns.current_user.id
 60:     params = Map.put(params, "user_id", user_id)
 61: 
 62:     case Assessments.create_assessment(params) do
 63:       {:ok, assessment} ->
 64:         {:noreply,
 65:          socket
 66:          |> put_flash(:info, "Avaliação criada com sucesso!")
 67:          |> push_navigate(to: ~p"/assessments/#{assessment.id}")}
 68: 
 69:       {:error, changeset} ->
 70:         {:noreply, assign(socket, :form, to_form(changeset))}
 71:     end
 72:   end
 73: 
 74:   @impl true
 75:   def handle_event("select_planning", %{"id" => id}, socket) do
 76:     {:noreply, assign(socket, :selected_planning_id, id)}
 77:   end
 78: 
 79:   @impl true
 80:   def handle_event("update_topic", %{"topic" => topic}, socket) do
 81:     {:noreply, assign(socket, :topic, topic)}
 82:   end
 83: 
 84:   @impl true
 85:   def handle_event("update_config", params, socket) do
 86:     socket =
 87:       socket
 88:       |> maybe_assign(:subject, params["subject"])
 89:       |> maybe_assign(:grade_level, params["grade_level"])
 90:       |> maybe_assign(:assessment_type, params["assessment_type"])
 91:       |> maybe_assign(:difficulty_level, params["difficulty_level"])
 92:       |> maybe_assign_int(:num_questions, params["num_questions"])
 93: 
 94:     {:noreply, socket}
 95:   end
 96: 
 97:   @impl true
 98:   def handle_event("toggle_question_type", %{"type" => type}, socket) do
 99:     types = socket.assigns.question_types
100: 
101:     new_types =
102:       if type in types do
103:         List.delete(types, type)
104:       else
105:         types ++ [type]
106:       end
107: 
108:     {:noreply, assign(socket, :question_types, new_types)}
109:   end
110: 
111:   @impl true
112:   def handle_event("generate_from_planning", _params, socket) do
113:     planning_id = socket.assigns.selected_planning_id
114: 
115:     if is_nil(planning_id) do
116:       {:noreply, put_flash(socket, :error, "Selecione um planejamento")}
117:     else
118:       socket = assign(socket, generating: true, generation_error: nil)
119:       user_id = socket.assigns.current_user.id
120: 
121:       opts = [
122:         assessment_type: socket.assigns.assessment_type,
123:         difficulty_level: socket.assigns.difficulty_level,
124:         num_questions: socket.assigns.num_questions,
125:         question_types: socket.assigns.question_types
126:       ]
127: 
128:       task = Task.async(fn -> AssessmentGenerator.from_planning(planning_id, user_id, opts) end)
129:       {:noreply, assign(socket, :generation_task, task)}
130:     end
131:   end
132: 
133:   @impl true
134:   def handle_event("generate_from_topic", _params, socket) do
135:     topic = socket.assigns.topic
136: 
137:     if String.trim(topic) == "" do
138:       {:noreply, put_flash(socket, :error, "Digite um tema para a avaliação")}
139:     else
140:       socket = assign(socket, generating: true, generation_error: nil)
141:       user_id = socket.assigns.current_user.id
142: 
143:       opts = [
144:         assessment_type: socket.assigns.assessment_type,
145:         difficulty_level: socket.assigns.difficulty_level,
146:         num_questions: socket.assigns.num_questions,
147:         question_types: socket.assigns.question_types
148:       ]
149: 
150:       task =
151:         Task.async(fn ->
152:           AssessmentGenerator.from_topic(
153:             topic,
154:             socket.assigns.subject,
155:             socket.assigns.grade_level,
156:             user_id,
157:             opts
158:           )
159:         end)
160: 
161:       {:noreply, assign(socket, :generation_task, task)}
162:     end
163:   end
164: 
165:   @impl true
166:   def handle_info({ref, result}, socket) do
167:     if Map.has_key?(socket.assigns, :generation_task) and
168:          socket.assigns.generation_task.ref == ref do
169:       Process.demonitor(ref, [:flush])
170: 
171:       case result do
172:         {:ok, assessment} ->
173:           {:noreply,
174:            socket
175:            |> assign(:generating, false)
176:            |> put_flash(:info, "Avaliação gerada com sucesso!")
177:            |> push_navigate(to: ~p"/assessments/#{assessment.id}")}
178: 
179:         {:error, reason} ->
180:           error_msg =
181:             case reason do
182:               :planning_not_found -> "Planejamento não encontrado"
183:               :invalid_json_response -> "Erro ao processar resposta da IA"
184:               %{message: msg} -> msg
185:               _ -> "Erro ao gerar avaliação"
186:             end
187: 
188:           {:noreply,
189:            socket
190:            |> assign(:generating, false)
191:            |> assign(:generation_error, error_msg)}
192:       end
193:     else
194:       {:noreply, socket}
195:     end
196:   end
197: 
198:   @impl true
199:   def handle_info({:DOWN, _ref, :process, _pid, _reason}, socket) do
200:     {:noreply,
201:      socket
202:      |> assign(:generating, false)
203:      |> assign(:generation_error, "Erro inesperado ao gerar avaliação")}
204:   end
205: 
206:   defp maybe_assign(socket, _key, nil), do: socket
207:   defp maybe_assign(socket, key, value), do: assign(socket, key, value)
208: 
209:   defp maybe_assign_int(socket, _key, nil), do: socket
210: 
211:   defp maybe_assign_int(socket, key, value) do
212:     case Integer.parse(value) do
213:       {int, _} -> assign(socket, key, int)
214:       :error -> socket
215:     end
216:   end
217: 
218:   @impl true
219:   def render(assigns) do
220:     ~H"""
221:     <div class="min-h-screen bg-slate-50 dark:bg-slate-900">
222:       <!-- Header -->
223:       <div class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
224:         <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
225:           <div class="flex items-center gap-4">
226:             <.link
227:               navigate={~p"/assessments"}
228:               class="p-2 rounded-lg text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"
229:             >
230:               <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
231:                 <path
232:                   stroke-linecap="round"
233:                   stroke-linejoin="round"
234:                   stroke-width="2"
235:                   d="M10 19l-7-7m0 0l7-7m-7 7h18"
236:                 />
237:               </svg>
238:             </.link>
239:             <div>
240:               <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Nova Avaliação</h1>
241:               <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">
242:                 Crie uma prova, atividade ou avaliação
243:               </p>
244:             </div>
245:           </div>
246:         </div>
247:       </div>
248:       <!-- Mode Selector -->
249:       <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
250:         <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-4 mb-6">
251:           <h3 class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-3">
252:             Como deseja criar a avaliação?
253:           </h3>
254:           <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
255:             <button
256:               type="button"
257:               phx-click="change_mode"
258:               phx-value-mode="manual"
259:               class={"p-4 rounded-xl border-2 transition-all text-left #{if @mode == "manual", do: "border-teal-500 bg-teal-50 dark:bg-teal-900/20", else: "border-slate-200 dark:border-slate-600 hover:border-slate-300 dark:hover:border-slate-500"}"}
260:             >
261:               <div class="flex items-center gap-3 mb-2">
262:                 <div class={"p-2 rounded-lg #{if @mode == "manual", do: "bg-teal-100 dark:bg-teal-900/40", else: "bg-slate-100 dark:bg-slate-700"}"}>
263:                   <svg
264:                     class={"w-5 h-5 #{if @mode == "manual", do: "text-teal-600 dark:text-teal-400", else: "text-slate-500"}"}
265:                     fill="none"
266:                     stroke="currentColor"
267:                     viewBox="0 0 24 24"
268:                   >
269:                     <path
270:                       stroke-linecap="round"
271:                       stroke-linejoin="round"
272:                       stroke-width="2"
273:                       d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
274:                     />
275:                   </svg>
276:                 </div>
277:                 <span class={"font-medium #{if @mode == "manual", do: "text-teal-700 dark:text-teal-300", else: "text-slate-700 dark:text-slate-300"}"}>
278:                   Manual
279:                 </span>
280:               </div>
281:               <p class="text-xs text-slate-500 dark:text-slate-400">
282:                 Crie do zero preenchendo os campos
283:               </p>
284:             </button>
285: 
286:             <button
287:               type="button"
288:               phx-click="change_mode"
289:               phx-value-mode="from_planning"
290:               class={"p-4 rounded-xl border-2 transition-all text-left #{if @mode == "from_planning", do: "border-violet-500 bg-violet-50 dark:bg-violet-900/20", else: "border-slate-200 dark:border-slate-600 hover:border-slate-300 dark:hover:border-slate-500"}"}
291:             >
292:               <div class="flex items-center gap-3 mb-2">
293:                 <div class={"p-2 rounded-lg #{if @mode == "from_planning", do: "bg-violet-100 dark:bg-violet-900/40", else: "bg-slate-100 dark:bg-slate-700"}"}>
294:                   <svg
295:                     class={"w-5 h-5 #{if @mode == "from_planning", do: "text-violet-600 dark:text-violet-400", else: "text-slate-500"}"}
296:                     fill="none"
297:                     stroke="currentColor"
298:                     viewBox="0 0 24 24"
299:                   >
300:                     <path
301:                       stroke-linecap="round"
302:                       stroke-linejoin="round"
303:                       stroke-width="2"
304:                       d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
305:                     />
306:                   </svg>
307:                 </div>
308:                 <span class={"font-medium #{if @mode == "from_planning", do: "text-violet-700 dark:text-violet-300", else: "text-slate-700 dark:text-slate-300"}"}>
309:                   De Planejamento
310:                 </span>
311:               </div>
312:               <p class="text-xs text-slate-500 dark:text-slate-400">
313:                 IA gera a partir de um planejamento existente
314:               </p>
315:             </button>
316: 
317:             <button
318:               type="button"
319:               phx-click="change_mode"
320:               phx-value-mode="from_topic"
321:               class={"p-4 rounded-xl border-2 transition-all text-left #{if @mode == "from_topic", do: "border-cyan-500 bg-cyan-50 dark:bg-cyan-900/20", else: "border-slate-200 dark:border-slate-600 hover:border-slate-300 dark:hover:border-slate-500"}"}
322:             >
323:               <div class="flex items-center gap-3 mb-2">
324:                 <div class={"p-2 rounded-lg #{if @mode == "from_topic", do: "bg-cyan-100 dark:bg-cyan-900/40", else: "bg-slate-100 dark:bg-slate-700"}"}>
325:                   <svg
326:                     class={"w-5 h-5 #{if @mode == "from_topic", do: "text-cyan-600 dark:text-cyan-400", else: "text-slate-500"}"}
327:                     fill="none"
328:                     stroke="currentColor"
329:                     viewBox="0 0 24 24"
330:                   >
331:                     <path
332:                       stroke-linecap="round"
333:                       stroke-linejoin="round"
334:                       stroke-width="2"
335:                       d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"
336:                     />
337:                   </svg>
338:                 </div>
339:                 <span class={"font-medium #{if @mode == "from_topic", do: "text-cyan-700 dark:text-cyan-300", else: "text-slate-700 dark:text-slate-300"}"}>
340:                   De Tema
341:                 </span>
342:               </div>
343:               <p class="text-xs text-slate-500 dark:text-slate-400">
344:                 IA gera a partir de um tema descrito
345:               </p>
346:             </button>
347:           </div>
348:         </div>
349:         <!-- Error Message -->
350:         <%= if @generation_error do %>
351:           <div class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl">
352:             <div class="flex items-center gap-3">
353:               <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
354:                 <path
355:                   stroke-linecap="round"
356:                   stroke-linejoin="round"
357:                   stroke-width="2"
358:                   d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
359:                 />
360:               </svg>
361:               <p class="text-red-700 dark:text-red-300"><%= @generation_error %></p>
362:             </div>
363:           </div>
364:         <% end %>
365:         <!-- Mode Content -->
366:         <%= if @mode == "manual" do %>
367:           <.manual_form form={@form} />
368:         <% end %>
369: 
370:         <%= if @mode == "from_planning" do %>
371:           <.from_planning_form
372:             plannings={@plannings}
373:             selected_planning_id={@selected_planning_id}
374:             assessment_type={@assessment_type}
375:             difficulty_level={@difficulty_level}
376:             num_questions={@num_questions}
377:             question_types={@question_types}
378:             generating={@generating}
379:           />
380:         <% end %>
381: 
382:         <%= if @mode == "from_topic" do %>
383:           <.from_topic_form
384:             topic={@topic}
385:             subject={@subject}
386:             grade_level={@grade_level}
387:             assessment_type={@assessment_type}
388:             difficulty_level={@difficulty_level}
389:             num_questions={@num_questions}
390:             question_types={@question_types}
391:             generating={@generating}
392:           />
393:         <% end %>
394:       </div>
395:     </div>
396:     """
397:   end
398: 
399:   defp manual_form(assigns) do
400:     ~H"""
401:     <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
402:       <.form for={@form} phx-change="validate" phx-submit="save" class="space-y-6">
403:         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
404:           <div class="md:col-span-2">
405:             <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
406:               Título *
407:             </label>
408:             <input
409:               type="text"
410:               name="assessment[title]"
411:               value={@form[:title].value}
412:               placeholder="Ex: Prova de Matemática - 1º Bimestre"
413:               class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-teal-500"
414:               required
415:             />
416:           </div>
417: 
418:           <div>
419:             <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
420:               Disciplina *
421:             </label>
422:             <select
423:               name="assessment[subject]"
424:               class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
425:               required
426:             >
427:               <option value="">Selecione...</option>
428:               <%= for subject <- Assessment.subjects() do %>
429:                 <option value={subject} selected={@form[:subject].value == subject}>
430:                   <%= Assessment.subject_label(subject) %>
431:                 </option>
432:               <% end %>
433:             </select>
434:           </div>
435: 
436:           <div>
437:             <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
438:               Ano/Série *
439:             </label>
440:             <select
441:               name="assessment[grade_level]"
442:               class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
443:               required
444:             >
445:               <option value="">Selecione...</option>
446:               <%= for level <- Assessment.grade_levels() do %>
447:                 <option value={level} selected={@form[:grade_level].value == level}>
448:                   <%= Assessment.grade_level_label(level) %>
449:                 </option>
450:               <% end %>
451:             </select>
452:           </div>
453: 
454:           <div>
455:             <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
456:               Tipo de Avaliação
457:             </label>
458:             <select
459:               name="assessment[assessment_type]"
460:               class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
461:             >
462:               <%= for type <- Assessment.assessment_types() do %>
463:                 <option value={type} selected={@form[:assessment_type].value == type}>
464:                   <%= Assessment.assessment_type_label(type) %>
465:                 </option>
466:               <% end %>
467:             </select>
468:           </div>
469: 
470:           <div>
471:             <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
472:               Dificuldade
473:             </label>
474:             <select
475:               name="assessment[difficulty_level]"
476:               class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
477:             >
478:               <%= for level <- Assessment.difficulty_levels() do %>
479:                 <option value={level} selected={@form[:difficulty_level].value == level}>
480:                   <%= Assessment.difficulty_label(level) %>
481:                 </option>
482:               <% end %>
483:             </select>
484:           </div>
485: 
486:           <div>
487:             <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
488:               Duração (minutos)
489:             </label>
490:             <input
491:               type="number"
492:               name="assessment[duration_minutes]"
493:               value={@form[:duration_minutes].value}
494:               min="15"
495:               max="480"
496:               class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
497:             />
498:           </div>
499: 
500:           <div class="md:col-span-2">
501:             <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
502:               Descrição
503:             </label>
504:             <textarea
505:               name="assessment[description]"
506:               rows="3"
507:               placeholder="Breve descrição do que será avaliado"
508:               class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-teal-500"
509:             ><%= @form[:description].value %></textarea>
510:           </div>
511: 
512:           <div class="md:col-span-2">
513:             <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
514:               Instruções para os Alunos
515:             </label>
516:             <textarea
517:               name="assessment[instructions]"
518:               rows="3"
519:               placeholder="Instruções que aparecerão no início da avaliação"
520:               class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-teal-500"
521:             ><%= @form[:instructions].value %></textarea>
522:           </div>
523:         </div>
524: 
525:         <div class="flex justify-end gap-3 pt-4 border-t border-slate-200 dark:border-slate-700">
526:           <.link
527:             navigate={~p"/assessments"}
528:             class="px-4 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"
529:           >
530:             Cancelar
531:           </.link>
532:           <button
533:             type="submit"
534:             class="px-6 py-2 bg-teal-600 hover:bg-teal-700 text-white font-medium rounded-lg transition-colors"
535:           >
536:             Criar Avaliação
537:           </button>
538:         </div>
539:       </.form>
540:     </div>
541:     """
542:   end
543: 
544:   defp from_planning_form(assigns) do
545:     ~H"""
546:     <div class="space-y-6">
547:       <!-- Planning Selection -->
548:       <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
549:         <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">
550:           Selecione o Planejamento
551:         </h3>
552: 
553:         <%= if Enum.empty?(@plannings) do %>
554:           <div class="text-center py-8">
555:             <svg
556:               class="w-12 h-12 mx-auto text-slate-300 mb-4"
557:               fill="none"
558:               stroke="currentColor"
559:               viewBox="0 0 24 24"
560:             >
561:               <path
562:                 stroke-linecap="round"
563:                 stroke-linejoin="round"
564:                 stroke-width="2"
565:                 d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
566:               />
567:             </svg>
568:             <p class="text-slate-500 dark:text-slate-400 mb-4">
569:               Você não tem planejamentos publicados
570:             </p>
571:             <.link navigate={~p"/plannings/new"} class="text-teal-600 hover:text-teal-700 font-medium">
572:               Criar um planejamento primeiro
573:             </.link>
574:           </div>
575:         <% else %>
576:           <div class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-64 overflow-y-auto">
577:             <%= for planning <- @plannings do %>
578:               <button
579:                 type="button"
580:                 phx-click="select_planning"
581:                 phx-value-id={planning.id}
582:                 class={"p-4 rounded-lg border-2 text-left transition-all #{if @selected_planning_id == planning.id, do: "border-violet-500 bg-violet-50 dark:bg-violet-900/20", else: "border-slate-200 dark:border-slate-600 hover:border-slate-300"}"}
583:               >
584:                 <p class="font-medium text-slate-900 dark:text-white line-clamp-1">
585:                   <%= planning.title %>
586:                 </p>
587:                 <p class="text-sm text-slate-500 dark:text-slate-400">
588:                   <%= Assessment.subject_label(planning.subject) %> • <%= Assessment.grade_level_label(
589:                     planning.grade_level
590:                   ) %>
591:                 </p>
592:               </button>
593:             <% end %>
594:           </div>
595:         <% end %>
596:       </div>
597:       <!-- Generation Config -->
598:       <.generation_config
599:         assessment_type={@assessment_type}
600:         difficulty_level={@difficulty_level}
601:         num_questions={@num_questions}
602:         question_types={@question_types}
603:       />
604:       <!-- Generate Button -->
605:       <div class="flex justify-end gap-3">
606:         <.link
607:           navigate={~p"/assessments"}
608:           class="px-4 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"
609:         >
610:           Cancelar
611:         </.link>
612:         <button
613:           type="button"
614:           phx-click="generate_from_planning"
615:           disabled={@generating or is_nil(@selected_planning_id)}
616:           class="inline-flex items-center gap-2 px-6 py-2 bg-violet-600 hover:bg-violet-700 disabled:bg-slate-400 text-white font-medium rounded-lg transition-colors"
617:         >
618:           <%= if @generating do %>
619:             <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
620:               <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
621:               </circle>
622:               <path
623:                 class="opacity-75"
624:                 fill="currentColor"
625:                 d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
626:               >
627:               </path>
628:             </svg>
629:             Gerando...
630:           <% else %>
631:             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
632:               <path
633:                 stroke-linecap="round"
634:                 stroke-linejoin="round"
635:                 stroke-width="2"
636:                 d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
637:               />
638:             </svg>
639:             Gerar com IA
640:           <% end %>
641:         </button>
642:       </div>
643:     </div>
644:     """
645:   end
646: 
647:   defp from_topic_form(assigns) do
648:     ~H"""
649:     <div class="space-y-6">
650:       <!-- Topic Input -->
651:       <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
652:         <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">
653:           Descreva o Tema
654:         </h3>
655: 
656:         <div class="space-y-4">
657:           <div>
658:             <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
659:               Tema da Avaliação *
660:             </label>
661:             <textarea
662:               phx-change="update_topic"
663:               name="topic"
664:               rows="4"
665:               placeholder="Ex: Frações equivalentes e operações com frações. Incluir problemas do cotidiano que envolvam divisão de partes iguais."
666:               class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-teal-500"
667:               phx-debounce="300"
668:             ><%= @topic %></textarea>
669:             <p class="mt-1 text-xs text-slate-500">
670:               Quanto mais detalhado, melhor será a avaliação gerada
671:             </p>
672:           </div>
673: 
674:           <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
675:             <div>
676:               <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
677:                 Disciplina *
678:               </label>
679:               <select
680:                 phx-change="update_config"
681:                 name="subject"
682:                 class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
683:               >
684:                 <%= for subject <- Assessment.subjects() do %>
685:                   <option value={subject} selected={@subject == subject}>
686:                     <%= Assessment.subject_label(subject) %>
687:                   </option>
688:                 <% end %>
689:               </select>
690:             </div>
691: 
692:             <div>
693:               <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
694:                 Ano/Série *
695:               </label>
696:               <select
697:                 phx-change="update_config"
698:                 name="grade_level"
699:                 class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
700:               >
701:                 <%= for level <- Assessment.grade_levels() do %>
702:                   <option value={level} selected={@grade_level == level}>
703:                     <%= Assessment.grade_level_label(level) %>
704:                   </option>
705:                 <% end %>
706:               </select>
707:             </div>
708:           </div>
709:         </div>
710:       </div>
711:       <!-- Generation Config -->
712:       <.generation_config
713:         assessment_type={@assessment_type}
714:         difficulty_level={@difficulty_level}
715:         num_questions={@num_questions}
716:         question_types={@question_types}
717:       />
718:       <!-- Generate Button -->
719:       <div class="flex justify-end gap-3">
720:         <.link
721:           navigate={~p"/assessments"}
722:           class="px-4 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"
723:         >
724:           Cancelar
725:         </.link>
726:         <button
727:           type="button"
728:           phx-click="generate_from_topic"
729:           disabled={@generating or String.trim(@topic) == ""}
730:           class="inline-flex items-center gap-2 px-6 py-2 bg-cyan-600 hover:bg-cyan-700 disabled:bg-slate-400 text-white font-medium rounded-lg transition-colors"
731:         >
732:           <%= if @generating do %>
733:             <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
734:               <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
735:               </circle>
736:               <path
737:                 class="opacity-75"
738:                 fill="currentColor"
739:                 d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
740:               >
741:               </path>
742:             </svg>
743:             Gerando...
744:           <% else %>
745:             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
746:               <path
747:                 stroke-linecap="round"
748:                 stroke-linejoin="round"
749:                 stroke-width="2"
750:                 d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
751:               />
752:             </svg>
753:             Gerar com IA
754:           <% end %>
755:         </button>
756:       </div>
757:     </div>
758:     """
759:   end
760: 
761:   defp generation_config(assigns) do
762:     ~H"""
763:     <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
764:       <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">
765:         Configurações da Avaliação
766:       </h3>
767: 
768:       <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
769:         <div>
770:           <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
771:             Tipo
772:           </label>
773:           <select
774:             phx-change="update_config"
775:             name="assessment_type"
776:             class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-teal-500"
777:           >
778:             <%= for type <- Assessment.assessment_types() do %>
779:               <option value={type} selected={@assessment_type == type}>
780:                 <%= Assessment.assessment_type_label(type) %>
781:               </option>
782:             <% end %>
783:           </select>
784:         </div>
785: 
786:         <div>
787:           <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
788:             Dificuldade
789:           </label>
790:           <select
791:             phx-change="update_config"
792:             name="difficulty_level"
793:             class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-teal-500"
794:           >
795:             <%= for level <- Assessment.difficulty_levels() do %>
796:               <option value={level} selected={@difficulty_level == level}>
797:                 <%= Assessment.difficulty_label(level) %>
798:               </option>
799:             <% end %>
800:           </select>
801:         </div>
802: 
803:         <div>
804:           <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
805:             Nº de Questões
806:           </label>
807:           <input
808:             type="number"
809:             phx-change="update_config"
810:             name="num_questions"
811:             value={@num_questions}
812:             min="3"
813:             max="30"
814:             class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-teal-500"
815:           />
816:         </div>
817:       </div>
818: 
819:       <div>
820:         <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
821:           Tipos de Questões
822:         </label>
823:         <div class="flex flex-wrap gap-2">
824:           <%= for type <- Assessment.question_types() do %>
825:             <button
826:               type="button"
827:               phx-click="toggle_question_type"
828:               phx-value-type={type}
829:               class={"px-3 py-1.5 rounded-lg text-sm font-medium transition-colors #{if type in @question_types, do: "bg-teal-100 text-teal-700 dark:bg-teal-900/40 dark:text-teal-300", else: "bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400 hover:bg-slate-200"}"}
830:             >
831:               <%= Assessment.question_type_label(type) %>
832:             </button>
833:           <% end %>
834:         </div>
835:       </div>
836:     </div>
837:     """
838:   end
839: end
````

## File: lib/hellen_web/live/assessments_live/show.ex
````elixir
  1: defmodule HellenWeb.AssessmentsLive.Show do
  2:   @moduledoc """
  3:   LiveView for displaying assessment details and questions.
  4:   """
  5: 
  6:   use HellenWeb, :live_view
  7: 
  8:   alias Hellen.Assessments
  9:   alias Hellen.Assessments.Assessment
 10: 
 11:   @impl true
 12:   def mount(%{"id" => id}, _session, socket) do
 13:     assessment = Assessments.get_assessment_with_preloads!(id)
 14: 
 15:     {:ok,
 16:      socket
 17:      |> assign(:page_title, assessment.title)
 18:      |> assign(:assessment, assessment)
 19:      |> assign(:show_answers, false)
 20:      |> assign(:active_tab, "questions")}
 21:   end
 22: 
 23:   @impl true
 24:   def handle_event("toggle_answers", _params, socket) do
 25:     {:noreply, assign(socket, :show_answers, !socket.assigns.show_answers)}
 26:   end
 27: 
 28:   @impl true
 29:   def handle_event("change_tab", %{"tab" => tab}, socket) do
 30:     {:noreply, assign(socket, :active_tab, tab)}
 31:   end
 32: 
 33:   @impl true
 34:   def handle_event("publish", _params, socket) do
 35:     case Assessments.publish_assessment(socket.assigns.assessment) do
 36:       {:ok, assessment} ->
 37:         {:noreply,
 38:          socket
 39:          |> assign(:assessment, assessment)
 40:          |> put_flash(:info, "Avaliação publicada!")}
 41: 
 42:       {:error, changeset} ->
 43:         error_msg = error_message(changeset)
 44:         {:noreply, put_flash(socket, :error, error_msg)}
 45:     end
 46:   end
 47: 
 48:   @impl true
 49:   def handle_event("archive", _params, socket) do
 50:     case Assessments.archive_assessment(socket.assigns.assessment) do
 51:       {:ok, assessment} ->
 52:         {:noreply,
 53:          socket
 54:          |> assign(:assessment, assessment)
 55:          |> put_flash(:info, "Avaliação arquivada!")}
 56: 
 57:       {:error, _} ->
 58:         {:noreply, put_flash(socket, :error, "Erro ao arquivar")}
 59:     end
 60:   end
 61: 
 62:   @impl true
 63:   def handle_event("delete", _params, socket) do
 64:     case Assessments.delete_assessment(socket.assigns.assessment) do
 65:       {:ok, _} ->
 66:         {:noreply,
 67:          socket
 68:          |> put_flash(:info, "Avaliação excluída!")
 69:          |> push_navigate(to: ~p"/assessments")}
 70: 
 71:       {:error, _} ->
 72:         {:noreply, put_flash(socket, :error, "Erro ao excluir")}
 73:     end
 74:   end
 75: 
 76:   defp error_message(changeset) do
 77:     changeset
 78:     |> Ecto.Changeset.traverse_errors(fn {msg, _opts} -> msg end)
 79:     |> Enum.map_join("; ", fn {field, msgs} -> "#{field}: #{Enum.join(msgs, ", ")}" end)
 80:   end
 81: 
 82:   @impl true
 83:   def render(assigns) do
 84:     ~H"""
 85:     <div class="min-h-screen bg-slate-50 dark:bg-slate-900">
 86:       <!-- Header -->
 87:       <div class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
 88:         <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
 89:           <div class="flex items-start justify-between gap-4">
 90:             <div class="flex items-start gap-4">
 91:               <.link
 92:                 navigate={~p"/assessments"}
 93:                 class="mt-1 p-2 rounded-lg text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"
 94:               >
 95:                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
 96:                   <path
 97:                     stroke-linecap="round"
 98:                     stroke-linejoin="round"
 99:                     stroke-width="2"
100:                     d="M10 19l-7-7m0 0l7-7m-7 7h18"
101:                   />
102:                 </svg>
103:               </.link>
104:               <div>
105:                 <div class="flex items-center gap-3 mb-2">
106:                   <span class={"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium #{status_color(@assessment.status)}"}>
107:                     <%= Assessment.status_label(@assessment.status) %>
108:                   </span>
109:                   <span class={"text-sm #{type_color(@assessment.assessment_type)}"}>
110:                     <%= Assessment.assessment_type_label(@assessment.assessment_type) %>
111:                   </span>
112:                   <%= if @assessment.generated_by_ai do %>
113:                     <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-violet-100 dark:bg-violet-900/30 text-violet-600 dark:text-violet-400 rounded text-xs">
114:                       <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
115:                         <path
116:                           stroke-linecap="round"
117:                           stroke-linejoin="round"
118:                           stroke-width="2"
119:                           d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
120:                         />
121:                       </svg>
122:                       IA
123:                     </span>
124:                   <% end %>
125:                 </div>
126:                 <h1 class="text-2xl font-bold text-slate-900 dark:text-white">
127:                   <%= @assessment.title %>
128:                 </h1>
129:                 <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">
130:                   <%= Assessment.subject_label(@assessment.subject) %> • <%= Assessment.grade_level_label(
131:                     @assessment.grade_level
132:                   ) %>
133:                 </p>
134:               </div>
135:             </div>
136: 
137:             <div class="flex items-center gap-2">
138:               <%= if @assessment.status == "draft" do %>
139:                 <button
140:                   type="button"
141:                   phx-click="publish"
142:                   class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-medium rounded-lg transition-colors text-sm"
143:                 >
144:                   Publicar
145:                 </button>
146:               <% end %>
147: 
148:               <.link
149:                 navigate={~p"/assessments/#{@assessment.id}/edit"}
150:                 class="px-4 py-2 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 font-medium rounded-lg transition-colors text-sm"
151:               >
152:                 Editar
153:               </.link>
154: 
155:               <div class="relative" x-data="{ open: false }">
156:                 <button
157:                   type="button"
158:                   @click="open = !open"
159:                   class="p-2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"
160:                 >
161:                   <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
162:                     <path
163:                       stroke-linecap="round"
164:                       stroke-linejoin="round"
165:                       stroke-width="2"
166:                       d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"
167:                     />
168:                   </svg>
169:                 </button>
170: 
171:                 <div
172:                   x-show="open"
173:                   @click.away="open = false"
174:                   x-transition
175:                   class="absolute right-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-lg shadow-lg border border-slate-200 dark:border-slate-700 py-1 z-10"
176:                 >
177:                   <button
178:                     type="button"
179:                     @click="window.print(); open = false"
180:                     class="w-full px-4 py-2 text-left text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700"
181:                   >
182:                     Imprimir
183:                   </button>
184:                   <%= if @assessment.status != "archived" do %>
185:                     <button
186:                       type="button"
187:                       phx-click="archive"
188:                       @click="open = false"
189:                       class="w-full px-4 py-2 text-left text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700"
190:                     >
191:                       Arquivar
192:                     </button>
193:                   <% end %>
194:                   <button
195:                     type="button"
196:                     phx-click="delete"
197:                     @click="open = false"
198:                     data-confirm="Tem certeza que deseja excluir esta avaliação?"
199:                     class="w-full px-4 py-2 text-left text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20"
200:                   >
201:                     Excluir
202:                   </button>
203:                 </div>
204:               </div>
205:             </div>
206:           </div>
207:         </div>
208:       </div>
209:       <!-- Stats -->
210:       <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
211:         <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
212:           <div class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
213:             <p class="text-2xl font-bold text-slate-900 dark:text-white">
214:               <%= length(@assessment.questions || []) %>
215:             </p>
216:             <p class="text-sm text-slate-500">Questões</p>
217:           </div>
218:           <div class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
219:             <p class="text-2xl font-bold text-slate-900 dark:text-white">
220:               <%= @assessment.total_points || 0 %>
221:             </p>
222:             <p class="text-sm text-slate-500">Pontos</p>
223:           </div>
224:           <div class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
225:             <p class="text-2xl font-bold text-slate-900 dark:text-white">
226:               <%= @assessment.duration_minutes || "-" %>
227:             </p>
228:             <p class="text-sm text-slate-500">Minutos</p>
229:           </div>
230:           <div class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
231:             <p class="text-2xl font-bold text-slate-900 dark:text-white">
232:               <%= Assessment.difficulty_label(@assessment.difficulty_level) %>
233:             </p>
234:             <p class="text-sm text-slate-500">Dificuldade</p>
235:           </div>
236:         </div>
237:         <!-- Tabs -->
238:         <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
239:           <div class="border-b border-slate-200 dark:border-slate-700">
240:             <nav class="flex -mb-px">
241:               <button
242:                 type="button"
243:                 phx-click="change_tab"
244:                 phx-value-tab="questions"
245:                 class={"px-6 py-3 text-sm font-medium border-b-2 transition-colors #{if @active_tab == "questions", do: "border-teal-500 text-teal-600 dark:text-teal-400", else: "border-transparent text-slate-500 hover:text-slate-700 dark:hover:text-slate-300"}"}
246:               >
247:                 Questões
248:               </button>
249:               <button
250:                 type="button"
251:                 phx-click="change_tab"
252:                 phx-value-tab="info"
253:                 class={"px-6 py-3 text-sm font-medium border-b-2 transition-colors #{if @active_tab == "info", do: "border-teal-500 text-teal-600 dark:text-teal-400", else: "border-transparent text-slate-500 hover:text-slate-700 dark:hover:text-slate-300"}"}
254:               >
255:                 Informações
256:               </button>
257:               <button
258:                 type="button"
259:                 phx-click="change_tab"
260:                 phx-value-tab="rubrics"
261:                 class={"px-6 py-3 text-sm font-medium border-b-2 transition-colors #{if @active_tab == "rubrics", do: "border-teal-500 text-teal-600 dark:text-teal-400", else: "border-transparent text-slate-500 hover:text-slate-700 dark:hover:text-slate-300"}"}
262:               >
263:                 Gabarito e Rubricas
264:               </button>
265:             </nav>
266:           </div>
267: 
268:           <div class="p-6">
269:             <%= if @active_tab == "questions" do %>
270:               <.questions_tab assessment={@assessment} show_answers={@show_answers} />
271:             <% end %>
272: 
273:             <%= if @active_tab == "info" do %>
274:               <.info_tab assessment={@assessment} />
275:             <% end %>
276: 
277:             <%= if @active_tab == "rubrics" do %>
278:               <.rubrics_tab assessment={@assessment} />
279:             <% end %>
280:           </div>
281:         </div>
282:       </div>
283:     </div>
284:     """
285:   end
286: 
287:   defp questions_tab(assigns) do
288:     ~H"""
289:     <div>
290:       <div class="flex items-center justify-between mb-6">
291:         <h3 class="text-lg font-semibold text-slate-900 dark:text-white">
292:           Questões (<%= length(@assessment.questions || []) %>)
293:         </h3>
294:         <button
295:           type="button"
296:           phx-click="toggle_answers"
297:           class={"px-3 py-1.5 rounded-lg text-sm font-medium transition-colors #{if @show_answers, do: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400", else: "bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400"}"}
298:         >
299:           <%= if @show_answers, do: "Ocultar Respostas", else: "Mostrar Respostas" %>
300:         </button>
301:       </div>
302: 
303:       <%= if Enum.empty?(@assessment.questions || []) do %>
304:         <div class="text-center py-12">
305:           <svg
306:             class="w-12 h-12 mx-auto text-slate-300 mb-4"
307:             fill="none"
308:             stroke="currentColor"
309:             viewBox="0 0 24 24"
310:           >
311:             <path
312:               stroke-linecap="round"
313:               stroke-linejoin="round"
314:               stroke-width="2"
315:               d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
316:             />
317:           </svg>
318:           <p class="text-slate-500 dark:text-slate-400">
319:             Nenhuma questão cadastrada
320:           </p>
321:         </div>
322:       <% else %>
323:         <div class="space-y-6">
324:           <%= for {question, index} <- Enum.with_index(@assessment.questions || []) do %>
325:             <.question_card question={question} index={index} show_answer={@show_answers} />
326:           <% end %>
327:         </div>
328:       <% end %>
329:     </div>
330:     """
331:   end
332: 
333:   defp question_card(assigns) do
334:     ~H"""
335:     <div class="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-xl">
336:       <div class="flex items-start gap-4">
337:         <div class="flex-shrink-0 w-8 h-8 bg-teal-100 dark:bg-teal-900/40 rounded-full flex items-center justify-center">
338:           <span class="text-sm font-bold text-teal-600 dark:text-teal-400"><%= @index + 1 %></span>
339:         </div>
340:         <div class="flex-1">
341:           <div class="flex items-center gap-2 mb-2">
342:             <span class={"px-2 py-0.5 rounded text-xs font-medium #{question_type_color(@question["type"])}"}>
343:               <%= Assessment.question_type_label(@question["type"]) %>
344:             </span>
345:             <span class="text-xs text-slate-500">
346:               <%= @question["points"] || 1 %> ponto(s)
347:             </span>
348:             <%= if @question["difficulty"] do %>
349:               <span class="text-xs text-slate-400">
350:                 • <%= difficulty_label(@question["difficulty"]) %>
351:               </span>
352:             <% end %>
353:           </div>
354: 
355:           <p class="text-slate-900 dark:text-white mb-3 whitespace-pre-wrap">
356:             <%= @question["text"] %>
357:           </p>
358: 
359:           <%= case @question["type"] do %>
360:             <% "multiple_choice" -> %>
361:               <div class="space-y-2 ml-4">
362:                 <%= for option <- @question["options"] || [] do %>
363:                   <div class={"flex items-center gap-2 p-2 rounded #{if @show_answer and String.starts_with?(option, @question["correct_answer"] <> ")"), do: "bg-emerald-100 dark:bg-emerald-900/30", else: ""}"}>
364:                     <span class="text-slate-700 dark:text-slate-300"><%= option %></span>
365:                   </div>
366:                 <% end %>
367:               </div>
368:             <% "true_false" -> %>
369:               <div class="flex gap-4 ml-4">
370:                 <span class={"px-3 py-1 rounded #{if @show_answer and @question["correct_answer"] == true, do: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400", else: "bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-slate-300"}"}>
371:                   Verdadeiro
372:                 </span>
373:                 <span class={"px-3 py-1 rounded #{if @show_answer and @question["correct_answer"] == false, do: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400", else: "bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-slate-300"}"}>
374:                   Falso
375:                 </span>
376:               </div>
377:             <% "matching" -> %>
378:               <div class="grid grid-cols-2 gap-4 ml-4">
379:                 <div>
380:                   <p class="text-xs font-medium text-slate-500 mb-2">Coluna A</p>
381:                   <%= for {item, idx} <- Enum.with_index(@question["left_column"] || []) do %>
382:                     <div class="p-2 bg-white dark:bg-slate-800 rounded mb-1 text-sm">
383:                       <%= idx + 1 %>. <%= item %>
384:                     </div>
385:                   <% end %>
386:                 </div>
387:                 <div>
388:                   <p class="text-xs font-medium text-slate-500 mb-2">Coluna B</p>
389:                   <%= for {item, idx} <- Enum.with_index(@question["right_column"] || []) do %>
390:                     <div class="p-2 bg-white dark:bg-slate-800 rounded mb-1 text-sm">
391:                       <%= <<65 + idx>> %>. <%= item %>
392:                     </div>
393:                   <% end %>
394:                 </div>
395:               </div>
396:             <% "fill_blank" -> %>
397:               <div class="ml-4 text-sm text-slate-500">
398:                 Preencher lacunas
399:               </div>
400:             <% "short_answer" -> %>
401:               <div class="ml-4 p-3 bg-white dark:bg-slate-800 rounded border border-dashed border-slate-300 dark:border-slate-600">
402:                 <p class="text-xs text-slate-400">Espaço para resposta curta</p>
403:               </div>
404:             <% "essay" -> %>
405:               <div class="ml-4 p-3 bg-white dark:bg-slate-800 rounded border border-dashed border-slate-300 dark:border-slate-600 min-h-[100px]">
406:                 <p class="text-xs text-slate-400">Espaço para resposta dissertativa</p>
407:               </div>
408:             <% _ -> %>
409:               <div></div>
410:           <% end %>
411: 
412:           <%= if @show_answer and @question["explanation"] do %>
413:             <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
414:               <p class="text-xs font-medium text-blue-700 dark:text-blue-300 mb-1">Explicação:</p>
415:               <p class="text-sm text-blue-600 dark:text-blue-400"><%= @question["explanation"] %></p>
416:             </div>
417:           <% end %>
418:         </div>
419:       </div>
420:     </div>
421:     """
422:   end
423: 
424:   defp info_tab(assigns) do
425:     ~H"""
426:     <div class="space-y-6">
427:       <%= if @assessment.description do %>
428:         <div>
429:           <h4 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">Descrição</h4>
430:           <p class="text-slate-900 dark:text-white"><%= @assessment.description %></p>
431:         </div>
432:       <% end %>
433: 
434:       <%= if @assessment.instructions do %>
435:         <div>
436:           <h4 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">Instruções</h4>
437:           <p class="text-slate-900 dark:text-white whitespace-pre-wrap">
438:             <%= @assessment.instructions %>
439:           </p>
440:         </div>
441:       <% end %>
442: 
443:       <%= if not Enum.empty?(@assessment.bncc_codes || []) do %>
444:         <div>
445:           <h4 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">Códigos BNCC</h4>
446:           <div class="flex flex-wrap gap-2">
447:             <%= for code <- @assessment.bncc_codes do %>
448:               <span class="px-3 py-1 bg-teal-100 dark:bg-teal-900/30 text-teal-700 dark:text-teal-300 rounded-full text-sm font-medium">
449:                 <%= code %>
450:               </span>
451:             <% end %>
452:           </div>
453:         </div>
454:       <% end %>
455: 
456:       <div class="grid grid-cols-2 gap-4">
457:         <div>
458:           <h4 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">Criado em</h4>
459:           <p class="text-slate-900 dark:text-white">
460:             <%= Calendar.strftime(@assessment.inserted_at, "%d/%m/%Y às %H:%M") %>
461:           </p>
462:         </div>
463:         <div>
464:           <h4 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">Atualizado em</h4>
465:           <p class="text-slate-900 dark:text-white">
466:             <%= Calendar.strftime(@assessment.updated_at, "%d/%m/%Y às %H:%M") %>
467:           </p>
468:         </div>
469:       </div>
470:     </div>
471:     """
472:   end
473: 
474:   defp rubrics_tab(assigns) do
475:     ~H"""
476:     <div class="space-y-6">
477:       <div>
478:         <h4 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-3">Gabarito</h4>
479:         <%= if Enum.empty?(@assessment.answer_key || %{}) do %>
480:           <p class="text-slate-400">Nenhum gabarito definido</p>
481:         <% else %>
482:           <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-4">
483:             <div class="grid grid-cols-5 gap-2">
484:               <%= for {key, value} <- @assessment.answer_key || %{} do %>
485:                 <div class="text-center p-2 bg-white dark:bg-slate-800 rounded">
486:                   <p class="text-xs text-slate-500">Q<%= String.to_integer(key) + 1 %></p>
487:                   <p class="font-bold text-slate-900 dark:text-white"><%= value %></p>
488:                 </div>
489:               <% end %>
490:             </div>
491:           </div>
492:         <% end %>
493:       </div>
494: 
495:       <div>
496:         <h4 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-3">
497:           Rubricas de Avaliação
498:         </h4>
499:         <%= if Enum.empty?(@assessment.rubrics || %{}) do %>
500:           <p class="text-slate-400">Nenhuma rubrica definida</p>
501:         <% else %>
502:           <div class="space-y-3">
503:             <%= if @assessment.rubrics["general"] do %>
504:               <div class="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
505:                 <p class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
506:                   Critérios Gerais
507:                 </p>
508:                 <p class="text-slate-600 dark:text-slate-400">
509:                   <%= @assessment.rubrics["general"] %>
510:                 </p>
511:               </div>
512:             <% end %>
513:             <%= if @assessment.rubrics["partial_credit"] do %>
514:               <div class="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
515:                 <p class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
516:                   Crédito Parcial
517:                 </p>
518:                 <p class="text-slate-600 dark:text-slate-400">
519:                   <%= @assessment.rubrics["partial_credit"] %>
520:                 </p>
521:               </div>
522:             <% end %>
523:           </div>
524:         <% end %>
525:       </div>
526:     </div>
527:     """
528:   end
529: 
530:   defp status_color("draft"),
531:     do: "bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400"
532: 
533:   defp status_color("published"),
534:     do: "bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400"
535: 
536:   defp status_color("archived"),
537:     do: "bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400"
538: 
539:   defp status_color(_), do: "bg-slate-100 text-slate-600"
540: 
541:   defp type_color("prova"), do: "text-teal-600 dark:text-teal-400"
542:   defp type_color("simulado"), do: "text-violet-600 dark:text-violet-400"
543:   defp type_color("quiz"), do: "text-pink-600 dark:text-pink-400"
544:   defp type_color(_), do: "text-slate-600 dark:text-slate-400"
545: 
546:   defp question_type_color("multiple_choice"),
547:     do: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400"
548: 
549:   defp question_type_color("true_false"),
550:     do: "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400"
551: 
552:   defp question_type_color("short_answer"),
553:     do: "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400"
554: 
555:   defp question_type_color("essay"),
556:     do: "bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400"
557: 
558:   defp question_type_color("matching"),
559:     do: "bg-cyan-100 text-cyan-700 dark:bg-cyan-900/30 dark:text-cyan-400"
560: 
561:   defp question_type_color("fill_blank"),
562:     do: "bg-pink-100 text-pink-700 dark:bg-pink-900/30 dark:text-pink-400"
563: 
564:   defp question_type_color(_),
565:     do: "bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300"
566: 
567:   defp difficulty_label("facil"), do: "Fácil"
568:   defp difficulty_label("medio"), do: "Médio"
569:   defp difficulty_label("dificil"), do: "Difícil"
570:   defp difficulty_label(_), do: ""
571: end
````

## File: lib/hellen_web/live/legal_live/privacy_live.ex
````elixir
  1: defmodule HellenWeb.LegalLive.PrivacyLive do
  2:   @moduledoc """
  3:   Privacy Policy page for Hellen AI.
  4:   """
  5:   use HellenWeb, :live_view
  6: 
  7:   import HellenWeb.LandingComponents
  8: 
  9:   @impl true
 10:   def mount(_params, _session, socket) do
 11:     {:ok, socket, layout: {HellenWeb.Layouts, :landing}}
 12:   end
 13: 
 14:   @impl true
 15:   def render(assigns) do
 16:     ~H"""
 17:     <div class="min-h-screen">
 18:       <.landing_navbar />
 19: 
 20:       <main class="pt-24 pb-16">
 21:         <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
 22:           <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-800 p-8 md:p-12">
 23:             <div class="text-center mb-12">
 24:               <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-violet-500 to-violet-600 shadow-lg shadow-violet-500/30 mb-6">
 25:                 <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
 26:                   <path
 27:                     stroke-linecap="round"
 28:                     stroke-linejoin="round"
 29:                     stroke-width="2"
 30:                     d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
 31:                   />
 32:                 </svg>
 33:               </div>
 34:               <h1 class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-white mb-4">
 35:                 Politica de Privacidade
 36:               </h1>
 37:               <p class="text-slate-600 dark:text-slate-400">
 38:                 Ultima atualizacao: <%= Date.utc_today() |> Calendar.strftime("%d de %B de %Y") %>
 39:               </p>
 40:             </div>
 41: 
 42:             <div class="prose prose-slate dark:prose-invert max-w-none">
 43:               <section class="mb-10">
 44:                 <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
 45:                   <span class="w-8 h-8 rounded-lg bg-violet-100 dark:bg-violet-900/50 flex items-center justify-center text-violet-600 dark:text-violet-400 text-sm font-bold">
 46:                     1
 47:                   </span>
 48:                   Introducao
 49:                 </h2>
 50:                 <p class="text-slate-600 dark:text-slate-400 leading-relaxed">
 51:                   A Hellen AI esta comprometida com a protecao da sua privacidade. Esta politica descreve como coletamos, usamos, armazenamos e protegemos suas informacoes pessoais em conformidade com a Lei Geral de Protecao de Dados (LGPD - Lei 13.709/2018).
 52:                 </p>
 53:               </section>
 54: 
 55:               <section class="mb-10">
 56:                 <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
 57:                   <span class="w-8 h-8 rounded-lg bg-violet-100 dark:bg-violet-900/50 flex items-center justify-center text-violet-600 dark:text-violet-400 text-sm font-bold">
 58:                     2
 59:                   </span>
 60:                   Dados Coletados
 61:                 </h2>
 62:                 <p class="text-slate-600 dark:text-slate-400 leading-relaxed mb-4">
 63:                   Coletamos os seguintes tipos de dados:
 64:                 </p>
 65:                 <div class="space-y-4 ml-4">
 66:                   <div>
 67:                     <h3 class="font-semibold text-slate-800 dark:text-slate-200 mb-2">
 68:                       Dados de Cadastro:
 69:                     </h3>
 70:                     <ul class="list-disc list-inside text-slate-600 dark:text-slate-400 space-y-1">
 71:                       <li>Nome completo</li>
 72:                       <li>Endereco de e-mail</li>
 73:                       <li>Instituicao de ensino (opcional)</li>
 74:                       <li>Dados de autenticacao via Google/Firebase</li>
 75:                     </ul>
 76:                   </div>
 77:                   <div>
 78:                     <h3 class="font-semibold text-slate-800 dark:text-slate-200 mb-2">
 79:                       Dados de Uso:
 80:                     </h3>
 81:                     <ul class="list-disc list-inside text-slate-600 dark:text-slate-400 space-y-1">
 82:                       <li>Gravacoes de aulas enviadas para analise</li>
 83:                       <li>Transcricoes geradas</li>
 84:                       <li>Resultados de analises pedagogicas</li>
 85:                       <li>Historico de transacoes de creditos</li>
 86:                     </ul>
 87:                   </div>
 88:                 </div>
 89:               </section>
 90: 
 91:               <section class="mb-10">
 92:                 <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
 93:                   <span class="w-8 h-8 rounded-lg bg-violet-100 dark:bg-violet-900/50 flex items-center justify-center text-violet-600 dark:text-violet-400 text-sm font-bold">
 94:                     3
 95:                   </span>
 96:                   Finalidade do Tratamento
 97:                 </h2>
 98:                 <p class="text-slate-600 dark:text-slate-400 leading-relaxed mb-4">
 99:                   Utilizamos seus dados para:
100:                 </p>
101:                 <ul class="list-disc list-inside text-slate-600 dark:text-slate-400 space-y-2 ml-4">
102:                   <li>Fornecer e melhorar nossos servicos de analise pedagogica</li>
103:                   <li>Processar transacoes de creditos</li>
104:                   <li>Enviar comunicacoes relevantes sobre o servico</li>
105:                   <li>Cumprir obrigacoes legais</li>
106:                   <li>Gerar insights agregados e anonimizados para melhoria da plataforma</li>
107:                 </ul>
108:               </section>
109: 
110:               <section class="mb-10">
111:                 <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
112:                   <span class="w-8 h-8 rounded-lg bg-violet-100 dark:bg-violet-900/50 flex items-center justify-center text-violet-600 dark:text-violet-400 text-sm font-bold">
113:                     4
114:                   </span>
115:                   Base Legal
116:                 </h2>
117:                 <p class="text-slate-600 dark:text-slate-400 leading-relaxed">
118:                   O tratamento de dados e realizado com base no consentimento do usuario (Art. 7, I da LGPD) e na execucao de contrato (Art. 7, V da LGPD). Para dados sensiveis presentes em gravacoes, obtemos consentimento especifico.
119:                 </p>
120:               </section>
121: 
122:               <section class="mb-10">
123:                 <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
124:                   <span class="w-8 h-8 rounded-lg bg-violet-100 dark:bg-violet-900/50 flex items-center justify-center text-violet-600 dark:text-violet-400 text-sm font-bold">
125:                     5
126:                   </span>
127:                   Armazenamento e Seguranca
128:                 </h2>
129:                 <p class="text-slate-600 dark:text-slate-400 leading-relaxed mb-4">
130:                   Implementamos medidas tecnicas e organizacionais para proteger seus dados:
131:                 </p>
132:                 <ul class="list-disc list-inside text-slate-600 dark:text-slate-400 space-y-2 ml-4">
133:                   <li>Criptografia em transito (TLS/SSL) e em repouso</li>
134:                   <li>Armazenamento em servidores seguros (Cloudflare R2)</li>
135:                   <li>Controle de acesso baseado em funcoes</li>
136:                   <li>Monitoramento continuo de seguranca</li>
137:                   <li>Backups regulares com retencao adequada</li>
138:                 </ul>
139:               </section>
140: 
141:               <section class="mb-10">
142:                 <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
143:                   <span class="w-8 h-8 rounded-lg bg-violet-100 dark:bg-violet-900/50 flex items-center justify-center text-violet-600 dark:text-violet-400 text-sm font-bold">
144:                     6
145:                   </span>
146:                   Compartilhamento de Dados
147:                 </h2>
148:                 <p class="text-slate-600 dark:text-slate-400 leading-relaxed mb-4">
149:                   Podemos compartilhar dados com:
150:                 </p>
151:                 <ul class="list-disc list-inside text-slate-600 dark:text-slate-400 space-y-2 ml-4">
152:                   <li>
153:                     <strong>Processadores de IA:</strong>
154:                     NVIDIA e Groq para processamento de transcricao e analise
155:                   </li>
156:                   <li>
157:                     <strong>Processadores de pagamento:</strong> Stripe para transacoes de creditos
158:                   </li>
159:                   <li>
160:                     <strong>Autoridades:</strong> quando exigido por lei ou ordem judicial
161:                   </li>
162:                 </ul>
163:                 <p class="text-slate-600 dark:text-slate-400 leading-relaxed mt-4">
164:                   Nao vendemos nem compartilhamos seus dados para fins de marketing de terceiros.
165:                 </p>
166:               </section>
167: 
168:               <section class="mb-10">
169:                 <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
170:                   <span class="w-8 h-8 rounded-lg bg-violet-100 dark:bg-violet-900/50 flex items-center justify-center text-violet-600 dark:text-violet-400 text-sm font-bold">
171:                     7
172:                   </span>
173:                   Seus Direitos (LGPD)
174:                 </h2>
175:                 <p class="text-slate-600 dark:text-slate-400 leading-relaxed mb-4">
176:                   Como titular dos dados, voce tem direito a:
177:                 </p>
178:                 <ul class="list-disc list-inside text-slate-600 dark:text-slate-400 space-y-2 ml-4">
179:                   <li>Confirmar a existencia de tratamento de dados</li>
180:                   <li>Acessar seus dados pessoais</li>
181:                   <li>Corrigir dados incompletos ou desatualizados</li>
182:                   <li>Solicitar anonimizacao ou exclusao de dados</li>
183:                   <li>Solicitar portabilidade dos dados</li>
184:                   <li>Revogar o consentimento</li>
185:                 </ul>
186:               </section>
187: 
188:               <section class="mb-10">
189:                 <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
190:                   <span class="w-8 h-8 rounded-lg bg-violet-100 dark:bg-violet-900/50 flex items-center justify-center text-violet-600 dark:text-violet-400 text-sm font-bold">
191:                     8
192:                   </span>
193:                   Retencao de Dados
194:                 </h2>
195:                 <p class="text-slate-600 dark:text-slate-400 leading-relaxed">
196:                   Mantemos seus dados enquanto sua conta estiver ativa ou conforme necessario para fornecer servicos. Gravacoes de aulas sao mantidas por 90 dias apos a analise, podendo ser excluidas antecipadamente a pedido do usuario. Dados de transacoes sao mantidos conforme exigencias fiscais.
197:                 </p>
198:               </section>
199: 
200:               <section class="mb-10">
201:                 <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
202:                   <span class="w-8 h-8 rounded-lg bg-violet-100 dark:bg-violet-900/50 flex items-center justify-center text-violet-600 dark:text-violet-400 text-sm font-bold">
203:                     9
204:                   </span>
205:                   Cookies
206:                 </h2>
207:                 <p class="text-slate-600 dark:text-slate-400 leading-relaxed">
208:                   Utilizamos cookies essenciais para funcionamento da plataforma (autenticacao e sessao). Nao utilizamos cookies de rastreamento ou publicidade.
209:                 </p>
210:               </section>
211: 
212:               <section>
213:                 <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
214:                   <span class="w-8 h-8 rounded-lg bg-violet-100 dark:bg-violet-900/50 flex items-center justify-center text-violet-600 dark:text-violet-400 text-sm font-bold">
215:                     10
216:                   </span>
217:                   Contato do DPO
218:                 </h2>
219:                 <p class="text-slate-600 dark:text-slate-400 leading-relaxed">
220:                   Para exercer seus direitos ou esclarecer duvidas sobre privacidade, entre em contato com nosso Encarregado de Protecao de Dados atraves da nossa <a
221:                     href="/support"
222:                     class="text-violet-600 dark:text-violet-400 hover:underline font-medium"
223:                   >
224:                     pagina de suporte
225:                   </a>.
226:                 </p>
227:               </section>
228:             </div>
229:           </div>
230:         </div>
231:       </main>
232: 
233:       <.landing_footer />
234:     </div>
235:     """
236:   end
237: end
````

## File: lib/hellen_web/live/legal_live/support_live.ex
````elixir
  1: defmodule HellenWeb.LegalLive.SupportLive do
  2:   @moduledoc """
  3:   Support page for Hellen AI.
  4:   Provides contact information and FAQ.
  5:   """
  6:   use HellenWeb, :live_view
  7: 
  8:   import HellenWeb.LandingComponents
  9: 
 10:   @whatsapp_number "5515997701743"
 11:   @whatsapp_display "+55 15 99770-1743"
 12: 
 13:   @impl true
 14:   def mount(_params, _session, socket) do
 15:     {:ok,
 16:      assign(socket,
 17:        whatsapp_number: @whatsapp_number,
 18:        whatsapp_display: @whatsapp_display,
 19:        expanded_faq: nil
 20:      ), layout: {HellenWeb.Layouts, :landing}}
 21:   end
 22: 
 23:   @impl true
 24:   def handle_event("toggle_faq", %{"id" => id}, socket) do
 25:     new_expanded =
 26:       if socket.assigns.expanded_faq == id do
 27:         nil
 28:       else
 29:         id
 30:       end
 31: 
 32:     {:noreply, assign(socket, :expanded_faq, new_expanded)}
 33:   end
 34: 
 35:   @impl true
 36:   def render(assigns) do
 37:     ~H"""
 38:     <div class="min-h-screen">
 39:       <.landing_navbar />
 40: 
 41:       <main class="pt-24 pb-16">
 42:         <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
 43:           <!-- Header -->
 44:           <div class="text-center mb-16">
 45:             <div class="inline-flex items-center justify-center w-20 h-20 rounded-3xl bg-gradient-to-br from-emerald-500 to-teal-600 shadow-lg shadow-emerald-500/30 mb-6">
 46:               <svg class="w-10 h-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
 47:                 <path
 48:                   stroke-linecap="round"
 49:                   stroke-linejoin="round"
 50:                   stroke-width="2"
 51:                   d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"
 52:                 />
 53:               </svg>
 54:             </div>
 55:             <h1 class="text-4xl md:text-5xl font-bold text-slate-900 dark:text-white mb-4">
 56:               Central de Suporte
 57:             </h1>
 58:             <p class="text-lg text-slate-600 dark:text-slate-400 max-w-2xl mx-auto">
 59:               Estamos aqui para ajudar! Entre em contato conosco ou confira as perguntas frequentes.
 60:             </p>
 61:           </div>
 62:           <!-- Contact Cards -->
 63:           <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-16">
 64:             <!-- WhatsApp Card -->
 65:             <a
 66:               href={"https://wa.me/#{@whatsapp_number}?text=Ol%C3%A1%21%20Preciso%20de%20ajuda%20com%20o%20Hellen%20AI."}
 67:               target="_blank"
 68:               rel="noopener noreferrer"
 69:               class="group relative bg-gradient-to-br from-green-500 to-green-600 rounded-2xl p-6 text-white shadow-xl shadow-green-500/30 hover:shadow-2xl hover:shadow-green-500/40 transition-all duration-300 hover:-translate-y-1"
 70:             >
 71:               <div class="absolute top-4 right-4 w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
 72:                 <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
 73:                   <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z" />
 74:                 </svg>
 75:               </div>
 76:               <div class="pr-16">
 77:                 <h3 class="text-xl font-bold mb-2">WhatsApp</h3>
 78:                 <p class="text-white/90 text-sm mb-4">
 79:                   Atendimento rapido e direto pelo WhatsApp
 80:                 </p>
 81:                 <span class="inline-flex items-center gap-2 text-sm font-medium bg-white/20 rounded-full px-4 py-2">
 82:                   <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
 83:                     <path
 84:                       stroke-linecap="round"
 85:                       stroke-linejoin="round"
 86:                       stroke-width="2"
 87:                       d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
 88:                     />
 89:                   </svg>
 90:                   <%= @whatsapp_display %>
 91:                 </span>
 92:               </div>
 93:               <div class="absolute bottom-0 right-0 opacity-10">
 94:                 <svg class="w-32 h-32" fill="currentColor" viewBox="0 0 24 24">
 95:                   <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z" />
 96:                 </svg>
 97:               </div>
 98:             </a>
 99:             <!-- Email Card -->
100:             <a
101:               href="mailto:suporte@hellen.ai"
102:               class="group relative bg-white dark:bg-slate-800 rounded-2xl p-6 border border-slate-200 dark:border-slate-700 shadow-xl hover:shadow-2xl transition-all duration-300 hover:-translate-y-1"
103:             >
104:               <div class="absolute top-4 right-4 w-12 h-12 rounded-full bg-teal-100 dark:bg-teal-900/50 flex items-center justify-center">
105:                 <svg
106:                   class="w-6 h-6 text-teal-600 dark:text-teal-400"
107:                   fill="none"
108:                   viewBox="0 0 24 24"
109:                   stroke="currentColor"
110:                 >
111:                   <path
112:                     stroke-linecap="round"
113:                     stroke-linejoin="round"
114:                     stroke-width="2"
115:                     d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
116:                   />
117:                 </svg>
118:               </div>
119:               <div class="pr-16">
120:                 <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2">E-mail</h3>
121:                 <p class="text-slate-600 dark:text-slate-400 text-sm mb-4">
122:                   Para questoes mais detalhadas ou documentacao
123:                 </p>
124:                 <span class="inline-flex items-center gap-2 text-sm font-medium text-teal-600 dark:text-teal-400">
125:                   <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
126:                     <path
127:                       stroke-linecap="round"
128:                       stroke-linejoin="round"
129:                       stroke-width="2"
130:                       d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
131:                     />
132:                   </svg>
133:                   suporte@hellen.ai
134:                 </span>
135:               </div>
136:             </a>
137:             <!-- Hours Card -->
138:             <div class="group relative bg-white dark:bg-slate-800 rounded-2xl p-6 border border-slate-200 dark:border-slate-700 shadow-xl md:col-span-2 lg:col-span-1">
139:               <div class="absolute top-4 right-4 w-12 h-12 rounded-full bg-amber-100 dark:bg-amber-900/50 flex items-center justify-center">
140:                 <svg
141:                   class="w-6 h-6 text-amber-600 dark:text-amber-400"
142:                   fill="none"
143:                   viewBox="0 0 24 24"
144:                   stroke="currentColor"
145:                 >
146:                   <path
147:                     stroke-linecap="round"
148:                     stroke-linejoin="round"
149:                     stroke-width="2"
150:                     d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
151:                   />
152:                 </svg>
153:               </div>
154:               <div class="pr-16">
155:                 <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2">
156:                   Horario de Atendimento
157:                 </h3>
158:                 <p class="text-slate-600 dark:text-slate-400 text-sm mb-4">
159:                   Respondemos o mais rapido possivel
160:                 </p>
161:                 <div class="space-y-1 text-sm">
162:                   <p class="text-slate-700 dark:text-slate-300">
163:                     <span class="font-medium">Seg - Sex:</span> 09:00 - 18:00
164:                   </p>
165:                   <p class="text-slate-500 dark:text-slate-500">
166:                     Sabados, Domingos e Feriados: Fechado
167:                   </p>
168:                 </div>
169:               </div>
170:             </div>
171:           </div>
172:           <!-- FAQ Section -->
173:           <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-800 p-8 md:p-12">
174:             <div class="text-center mb-10">
175:               <h2 class="text-2xl md:text-3xl font-bold text-slate-900 dark:text-white mb-4">
176:                 Perguntas Frequentes
177:               </h2>
178:               <p class="text-slate-600 dark:text-slate-400">
179:                 Encontre respostas rapidas para as duvidas mais comuns
180:               </p>
181:             </div>
182: 
183:             <div class="max-w-3xl mx-auto space-y-4">
184:               <.faq_item
185:                 id="faq-1"
186:                 question="Como funciona o sistema de creditos?"
187:                 expanded={@expanded_faq}
188:               >
189:                 Cada analise de aula consome 1 credito. Voce pode adquirir pacotes de creditos na pagina de Billing. Ao criar uma nova aula e solicitar analise, 1 credito sera debitado. Caso ocorra alguma falha no processamento, o credito e automaticamente devolvido.
190:               </.faq_item>
191: 
192:               <.faq_item
193:                 id="faq-2"
194:                 question="Quais formatos de audio sao aceitos?"
195:                 expanded={@expanded_faq}
196:               >
197:                 Aceitamos os principais formatos de audio: MP3, WAV, M4A, OGG, WEBM e FLAC. O tamanho maximo por arquivo e de 200MB. Para melhores resultados, recomendamos gravacoes com boa qualidade de audio e minimo de ruido de fundo.
198:               </.faq_item>
199: 
200:               <.faq_item id="faq-3" question="Quanto tempo leva uma analise?" expanded={@expanded_faq}>
201:                 O tempo de processamento varia de acordo com a duracao da aula. Em geral, uma aula de 50 minutos leva cerca de 5-10 minutos para ser transcrita e analisada. Voce recebera uma notificacao quando a analise estiver pronta.
202:               </.faq_item>
203: 
204:               <.faq_item id="faq-4" question="Meus dados estao seguros?" expanded={@expanded_faq}>
205:                 Sim! Levamos a seguranca muito a serio. Todos os dados sao criptografados em transito e em repouso. As gravacoes sao armazenadas de forma segura e voce pode solicitar a exclusao a qualquer momento. Consulte nossa Politica de Privacidade para mais detalhes.
206:               </.faq_item>
207: 
208:               <.faq_item
209:                 id="faq-5"
210:                 question="Como a deteccao de bullying funciona?"
211:                 expanded={@expanded_faq}
212:               >
213:                 Nosso sistema de IA analisa o conteudo da transcricao em busca de padroes que possam indicar situacoes de bullying, conforme definido na Lei 13.185. Quando detectado, geramos um alerta com a severidade e o trecho relevante para que voce possa tomar as medidas necessarias.
214:               </.faq_item>
215: 
216:               <.faq_item
217:                 id="faq-6"
218:                 question="Posso cancelar minha conta e pedir reembolso?"
219:                 expanded={@expanded_faq}
220:               >
221:                 Voce pode cancelar sua conta a qualquer momento nas Configuracoes. Creditos nao utilizados nao sao reembolsaveis, porem permanecem disponiveis ate o cancelamento efetivo. Seus dados serao excluidos conforme nossa politica de retencao.
222:               </.faq_item>
223:             </div>
224:           </div>
225:           <!-- CTA Section -->
226:           <div class="mt-16 text-center">
227:             <p class="text-slate-600 dark:text-slate-400 mb-6">
228:               Nao encontrou o que procurava? Estamos aqui para ajudar!
229:             </p>
230:             <a
231:               href={"https://wa.me/#{@whatsapp_number}?text=Ol%C3%A1%21%20Preciso%20de%20ajuda%20com%20o%20Hellen%20AI."}
232:               target="_blank"
233:               rel="noopener noreferrer"
234:               class="inline-flex items-center gap-3 px-8 py-4 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold rounded-xl shadow-lg shadow-green-500/30 hover:shadow-xl hover:shadow-green-500/40 transition-all duration-300 hover:-translate-y-0.5"
235:             >
236:               <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
237:                 <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z" />
238:               </svg>
239:               Falar pelo WhatsApp
240:             </a>
241:           </div>
242:         </div>
243:       </main>
244: 
245:       <.landing_footer />
246:     </div>
247:     """
248:   end
249: 
250:   attr :id, :string, required: true
251:   attr :question, :string, required: true
252:   attr :expanded, :string, default: nil
253:   slot :inner_block, required: true
254: 
255:   defp faq_item(assigns) do
256:     ~H"""
257:     <div class="border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden">
258:       <button
259:         type="button"
260:         phx-click="toggle_faq"
261:         phx-value-id={@id}
262:         class="w-full flex items-center justify-between p-5 text-left bg-slate-50 dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
263:       >
264:         <span class="font-semibold text-slate-900 dark:text-white pr-4"><%= @question %></span>
265:         <svg
266:           class={[
267:             "w-5 h-5 text-slate-500 dark:text-slate-400 transition-transform duration-200 flex-shrink-0",
268:             @expanded == @id && "rotate-180"
269:           ]}
270:           fill="none"
271:           viewBox="0 0 24 24"
272:           stroke="currentColor"
273:         >
274:           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
275:         </svg>
276:       </button>
277:       <div class={[
278:         "overflow-hidden transition-all duration-200",
279:         @expanded == @id && "max-h-96",
280:         @expanded != @id && "max-h-0"
281:       ]}>
282:         <div class="p-5 pt-0 text-slate-600 dark:text-slate-400 leading-relaxed">
283:           <%= render_slot(@inner_block) %>
284:         </div>
285:       </div>
286:     </div>
287:     """
288:   end
289: end
````

## File: lib/hellen_web/live/legal_live/terms_live.ex
````elixir
  1: defmodule HellenWeb.LegalLive.TermsLive do
  2:   @moduledoc """
  3:   Terms of Service page for Hellen AI.
  4:   """
  5:   use HellenWeb, :live_view
  6: 
  7:   import HellenWeb.LandingComponents
  8: 
  9:   @impl true
 10:   def mount(_params, _session, socket) do
 11:     {:ok, socket, layout: {HellenWeb.Layouts, :landing}}
 12:   end
 13: 
 14:   @impl true
 15:   def render(assigns) do
 16:     ~H"""
 17:     <div class="min-h-screen">
 18:       <.landing_navbar />
 19: 
 20:       <main class="pt-24 pb-16">
 21:         <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
 22:           <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-800 p-8 md:p-12">
 23:             <div class="text-center mb-12">
 24:               <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-teal-500 to-teal-600 shadow-lg shadow-teal-500/30 mb-6">
 25:                 <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
 26:                   <path
 27:                     stroke-linecap="round"
 28:                     stroke-linejoin="round"
 29:                     stroke-width="2"
 30:                     d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
 31:                   />
 32:                 </svg>
 33:               </div>
 34:               <h1 class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-white mb-4">
 35:                 Termos de Uso
 36:               </h1>
 37:               <p class="text-slate-600 dark:text-slate-400">
 38:                 Ultima atualizacao: <%= Date.utc_today() |> Calendar.strftime("%d de %B de %Y") %>
 39:               </p>
 40:             </div>
 41: 
 42:             <div class="prose prose-slate dark:prose-invert max-w-none">
 43:               <section class="mb-10">
 44:                 <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
 45:                   <span class="w-8 h-8 rounded-lg bg-teal-100 dark:bg-teal-900/50 flex items-center justify-center text-teal-600 dark:text-teal-400 text-sm font-bold">
 46:                     1
 47:                   </span>
 48:                   Aceitacao dos Termos
 49:                 </h2>
 50:                 <p class="text-slate-600 dark:text-slate-400 leading-relaxed">
 51:                   Ao acessar e utilizar a plataforma Hellen AI, voce concorda em cumprir e estar vinculado a estes Termos de Uso. Se voce nao concordar com qualquer parte destes termos, nao devera utilizar nossos servicos.
 52:                 </p>
 53:               </section>
 54: 
 55:               <section class="mb-10">
 56:                 <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
 57:                   <span class="w-8 h-8 rounded-lg bg-teal-100 dark:bg-teal-900/50 flex items-center justify-center text-teal-600 dark:text-teal-400 text-sm font-bold">
 58:                     2
 59:                   </span>
 60:                   Descricao do Servico
 61:                 </h2>
 62:                 <p class="text-slate-600 dark:text-slate-400 leading-relaxed mb-4">
 63:                   O Hellen AI e uma plataforma de analise pedagogica que utiliza inteligencia artificial para:
 64:                 </p>
 65:                 <ul class="list-disc list-inside text-slate-600 dark:text-slate-400 space-y-2 ml-4">
 66:                   <li>Transcrever gravacoes de aulas</li>
 67:                   <li>Analisar o conteudo pedagogico com base na BNCC</li>
 68:                   <li>Identificar potenciais situacoes de bullying conforme a Lei 13.185</li>
 69:                   <li>Gerar relatorios e recomendacoes pedagogicas</li>
 70:                 </ul>
 71:               </section>
 72: 
 73:               <section class="mb-10">
 74:                 <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
 75:                   <span class="w-8 h-8 rounded-lg bg-teal-100 dark:bg-teal-900/50 flex items-center justify-center text-teal-600 dark:text-teal-400 text-sm font-bold">
 76:                     3
 77:                   </span>
 78:                   Cadastro e Conta
 79:                 </h2>
 80:                 <p class="text-slate-600 dark:text-slate-400 leading-relaxed">
 81:                   Para utilizar o Hellen AI, voce deve criar uma conta fornecendo informacoes precisas e completas. Voce e responsavel por manter a confidencialidade de suas credenciais de acesso e por todas as atividades que ocorram em sua conta.
 82:                 </p>
 83:               </section>
 84: 
 85:               <section class="mb-10">
 86:                 <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
 87:                   <span class="w-8 h-8 rounded-lg bg-teal-100 dark:bg-teal-900/50 flex items-center justify-center text-teal-600 dark:text-teal-400 text-sm font-bold">
 88:                     4
 89:                   </span>
 90:                   Sistema de Creditos
 91:                 </h2>
 92:                 <p class="text-slate-600 dark:text-slate-400 leading-relaxed mb-4">
 93:                   O Hellen AI opera com um sistema de creditos:
 94:                 </p>
 95:                 <ul class="list-disc list-inside text-slate-600 dark:text-slate-400 space-y-2 ml-4">
 96:                   <li>Cada analise de aula consome 1 credito</li>
 97:                   <li>
 98:                     Creditos podem ser adquiridos atraves de pacotes disponiveis na plataforma
 99:                   </li>
100:                   <li>Creditos nao expiram e nao sao reembolsaveis</li>
101:                   <li>Em caso de falha na analise, os creditos sao automaticamente restituidos</li>
102:                 </ul>
103:               </section>
104: 
105:               <section class="mb-10">
106:                 <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
107:                   <span class="w-8 h-8 rounded-lg bg-teal-100 dark:bg-teal-900/50 flex items-center justify-center text-teal-600 dark:text-teal-400 text-sm font-bold">
108:                     5
109:                   </span>
110:                   Uso Aceitavel
111:                 </h2>
112:                 <p class="text-slate-600 dark:text-slate-400 leading-relaxed mb-4">
113:                   Voce concorda em nao utilizar o Hellen AI para:
114:                 </p>
115:                 <ul class="list-disc list-inside text-slate-600 dark:text-slate-400 space-y-2 ml-4">
116:                   <li>Fins ilegais ou nao autorizados</li>
117:                   <li>Violar direitos de propriedade intelectual</li>
118:                   <li>Transmitir conteudo ofensivo, difamatorio ou ilegal</li>
119:                   <li>Interferir no funcionamento da plataforma</li>
120:                   <li>Coletar dados de outros usuarios sem autorizacao</li>
121:                 </ul>
122:               </section>
123: 
124:               <section class="mb-10">
125:                 <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
126:                   <span class="w-8 h-8 rounded-lg bg-teal-100 dark:bg-teal-900/50 flex items-center justify-center text-teal-600 dark:text-teal-400 text-sm font-bold">
127:                     6
128:                   </span>
129:                   Propriedade Intelectual
130:                 </h2>
131:                 <p class="text-slate-600 dark:text-slate-400 leading-relaxed">
132:                   Todo o conteudo da plataforma Hellen AI, incluindo textos, graficos, logotipos, icones e software, e de propriedade da Hellen AI ou de seus licenciadores. O conteudo das aulas enviadas permanece de propriedade do usuario.
133:                 </p>
134:               </section>
135: 
136:               <section class="mb-10">
137:                 <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
138:                   <span class="w-8 h-8 rounded-lg bg-teal-100 dark:bg-teal-900/50 flex items-center justify-center text-teal-600 dark:text-teal-400 text-sm font-bold">
139:                     7
140:                   </span>
141:                   Limitacao de Responsabilidade
142:                 </h2>
143:                 <p class="text-slate-600 dark:text-slate-400 leading-relaxed">
144:                   O Hellen AI e fornecido "como esta". Nao garantimos que o servico sera ininterrupto ou livre de erros. As analises geradas pela IA sao sugestoes e nao substituem o julgamento profissional do educador.
145:                 </p>
146:               </section>
147: 
148:               <section class="mb-10">
149:                 <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
150:                   <span class="w-8 h-8 rounded-lg bg-teal-100 dark:bg-teal-900/50 flex items-center justify-center text-teal-600 dark:text-teal-400 text-sm font-bold">
151:                     8
152:                   </span>
153:                   Alteracoes nos Termos
154:                 </h2>
155:                 <p class="text-slate-600 dark:text-slate-400 leading-relaxed">
156:                   Reservamo-nos o direito de modificar estes termos a qualquer momento. Alteracoes significativas serao comunicadas por e-mail ou atraves de aviso na plataforma. O uso continuado apos as alteracoes constitui aceitacao dos novos termos.
157:                 </p>
158:               </section>
159: 
160:               <section>
161:                 <h2 class="text-xl font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
162:                   <span class="w-8 h-8 rounded-lg bg-teal-100 dark:bg-teal-900/50 flex items-center justify-center text-teal-600 dark:text-teal-400 text-sm font-bold">
163:                     9
164:                   </span>
165:                   Contato
166:                 </h2>
167:                 <p class="text-slate-600 dark:text-slate-400 leading-relaxed">
168:                   Para duvidas sobre estes termos, entre em contato atraves da nossa <a
169:                     href="/support"
170:                     class="text-teal-600 dark:text-teal-400 hover:underline font-medium"
171:                   >
172:                     pagina de suporte
173:                   </a>.
174:                 </p>
175:               </section>
176:             </div>
177:           </div>
178:         </div>
179:       </main>
180: 
181:       <.landing_footer />
182:     </div>
183:     """
184:   end
185: end
````

## File: lib/hellen_web/live/plannings_live/edit.ex
````elixir
  1: defmodule HellenWeb.PlanningsLive.Edit do
  2:   @moduledoc """
  3:   LiveView for editing plannings.
  4:   """
  5: 
  6:   use HellenWeb, :live_view
  7: 
  8:   alias Hellen.Plannings
  9:   alias Hellen.Plannings.Planning
 10: 
 11:   @impl true
 12:   def mount(%{"id" => id}, _session, socket) do
 13:     planning = Plannings.get_planning!(id)
 14:     changeset = Plannings.change_planning(planning)
 15: 
 16:     {:ok,
 17:      socket
 18:      |> assign(:page_title, "Editar Planejamento")
 19:      |> assign(:planning, planning)
 20:      |> assign(:changeset, changeset)}
 21:   end
 22: 
 23:   @impl true
 24:   def handle_event("validate", %{"planning" => planning_params}, socket) do
 25:     changeset =
 26:       socket.assigns.planning
 27:       |> Plannings.change_planning(planning_params)
 28:       |> Map.put(:action, :validate)
 29: 
 30:     {:noreply, assign(socket, :changeset, changeset)}
 31:   end
 32: 
 33:   @impl true
 34:   def handle_event("save", %{"planning" => planning_params}, socket) do
 35:     case Plannings.update_planning(socket.assigns.planning, planning_params) do
 36:       {:ok, planning} ->
 37:         {:noreply,
 38:          socket
 39:          |> put_flash(:info, "Planejamento atualizado com sucesso!")
 40:          |> push_navigate(to: ~p"/plannings/#{planning.id}")}
 41: 
 42:       {:error, %Ecto.Changeset{} = changeset} ->
 43:         {:noreply, assign(socket, :changeset, changeset)}
 44:     end
 45:   end
 46: 
 47:   @impl true
 48:   def render(assigns) do
 49:     ~H"""
 50:     <div class="min-h-screen bg-slate-50 dark:bg-slate-900">
 51:       <!-- Header -->
 52:       <div class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
 53:         <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
 54:           <div class="flex items-center gap-4">
 55:             <.link
 56:               navigate={~p"/plannings/#{@planning.id}"}
 57:               class="p-2 rounded-lg text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"
 58:             >
 59:               <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
 60:                 <path
 61:                   stroke-linecap="round"
 62:                   stroke-linejoin="round"
 63:                   stroke-width="2"
 64:                   d="M10 19l-7-7m0 0l7-7m-7 7h18"
 65:                 />
 66:               </svg>
 67:             </.link>
 68:             <div>
 69:               <h1 class="text-2xl font-bold text-slate-900 dark:text-white">
 70:                 Editar Planejamento
 71:               </h1>
 72:               <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">
 73:                 <%= @planning.title %>
 74:               </p>
 75:             </div>
 76:           </div>
 77:         </div>
 78:       </div>
 79:       <!-- Content -->
 80:       <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
 81:         <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
 82:           <.form for={@changeset} phx-change="validate" phx-submit="save" class="space-y-6">
 83:             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
 84:               <div class="md:col-span-2">
 85:                 <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
 86:                   Título *
 87:                 </label>
 88:                 <input
 89:                   type="text"
 90:                   name="planning[title]"
 91:                   value={Phoenix.HTML.Form.input_value(@changeset, :title)}
 92:                   placeholder="Ex: Introdução às Frações"
 93:                   class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-teal-500"
 94:                   required
 95:                 />
 96:               </div>
 97: 
 98:               <div>
 99:                 <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
100:                   Disciplina *
101:                 </label>
102:                 <select
103:                   name="planning[subject]"
104:                   class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
105:                   required
106:                 >
107:                   <option value="">Selecione...</option>
108:                   <%= for subject <- Planning.subjects() do %>
109:                     <option
110:                       value={subject}
111:                       selected={Phoenix.HTML.Form.input_value(@changeset, :subject) == subject}
112:                     >
113:                       <%= Planning.subject_label(subject) %>
114:                     </option>
115:                   <% end %>
116:                 </select>
117:               </div>
118: 
119:               <div>
120:                 <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
121:                   Ano/Série *
122:                 </label>
123:                 <select
124:                   name="planning[grade_level]"
125:                   class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
126:                   required
127:                 >
128:                   <option value="">Selecione...</option>
129:                   <%= for level <- Planning.grade_levels() do %>
130:                     <option
131:                       value={level}
132:                       selected={Phoenix.HTML.Form.input_value(@changeset, :grade_level) == level}
133:                     >
134:                       <%= Planning.grade_level_label(level) %>
135:                     </option>
136:                   <% end %>
137:                 </select>
138:               </div>
139: 
140:               <div>
141:                 <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
142:                   Duração (minutos)
143:                 </label>
144:                 <input
145:                   type="number"
146:                   name="planning[duration_minutes]"
147:                   value={Phoenix.HTML.Form.input_value(@changeset, :duration_minutes)}
148:                   min="15"
149:                   max="240"
150:                   class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
151:                 />
152:               </div>
153: 
154:               <div>
155:                 <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
156:                   Status
157:                 </label>
158:                 <select
159:                   name="planning[status]"
160:                   class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
161:                 >
162:                   <%= for status <- Planning.statuses() do %>
163:                     <option
164:                       value={status}
165:                       selected={Phoenix.HTML.Form.input_value(@changeset, :status) == status}
166:                     >
167:                       <%= Planning.status_label(status) %>
168:                     </option>
169:                   <% end %>
170:                 </select>
171:               </div>
172: 
173:               <div class="md:col-span-2">
174:                 <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
175:                   Descrição
176:                 </label>
177:                 <textarea
178:                   name="planning[description]"
179:                   rows="3"
180:                   placeholder="Breve descrição do que será abordado na aula"
181:                   class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-teal-500"
182:                 ><%= Phoenix.HTML.Form.input_value(@changeset, :description) %></textarea>
183:               </div>
184: 
185:               <div class="md:col-span-2">
186:                 <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
187:                   Metodologia
188:                 </label>
189:                 <textarea
190:                   name="planning[methodology]"
191:                   rows="4"
192:                   placeholder="Descreva a metodologia que será utilizada"
193:                   class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-teal-500"
194:                 ><%= Phoenix.HTML.Form.input_value(@changeset, :methodology) %></textarea>
195:               </div>
196: 
197:               <div class="md:col-span-2">
198:                 <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
199:                   Critérios de Avaliação
200:                 </label>
201:                 <textarea
202:                   name="planning[assessment_criteria]"
203:                   rows="3"
204:                   placeholder="Como você avaliará se os objetivos foram alcançados?"
205:                   class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-teal-500"
206:                 ><%= Phoenix.HTML.Form.input_value(@changeset, :assessment_criteria) %></textarea>
207:               </div>
208:             </div>
209: 
210:             <div class="flex justify-end gap-3 pt-4 border-t border-slate-200 dark:border-slate-700">
211:               <.link
212:                 navigate={~p"/plannings/#{@planning.id}"}
213:                 class="px-4 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"
214:               >
215:                 Cancelar
216:               </.link>
217:               <button
218:                 type="submit"
219:                 class="px-6 py-2 bg-teal-600 hover:bg-teal-700 text-white font-medium rounded-lg transition-colors"
220:               >
221:                 Salvar Alterações
222:               </button>
223:             </div>
224:           </.form>
225:         </div>
226:       </div>
227:     </div>
228:     """
229:   end
230: end
````

## File: lib/hellen_web/live/plannings_live/index.ex
````elixir
  1: defmodule HellenWeb.PlanningsLive.Index do
  2:   @moduledoc """
  3:   LiveView for listing and managing lesson plannings.
  4:   """
  5: 
  6:   use HellenWeb, :live_view
  7: 
  8:   alias Hellen.Plannings
  9:   alias Hellen.Plannings.Planning
 10: 
 11:   @impl true
 12:   def mount(_params, _session, socket) do
 13:     {:ok,
 14:      socket
 15:      |> assign(:page_title, "Planejamentos")
 16:      |> assign(:filter_status, nil)
 17:      |> assign(:filter_subject, nil)
 18:      |> assign(:search_query, "")
 19:      |> assign(:view_mode, "cards")
 20:      |> load_plannings()
 21:      |> load_stats()}
 22:   end
 23: 
 24:   @impl true
 25:   def handle_params(params, _url, socket) do
 26:     {:noreply, apply_action(socket, socket.assigns.live_action, params)}
 27:   end
 28: 
 29:   defp apply_action(socket, :index, _params) do
 30:     socket
 31:   end
 32: 
 33:   @impl true
 34:   def handle_event("filter_status", %{"status" => status}, socket) do
 35:     status = if status == "", do: nil, else: status
 36: 
 37:     {:noreply,
 38:      socket
 39:      |> assign(:filter_status, status)
 40:      |> load_plannings()}
 41:   end
 42: 
 43:   @impl true
 44:   def handle_event("filter_subject", %{"subject" => subject}, socket) do
 45:     subject = if subject == "", do: nil, else: subject
 46: 
 47:     {:noreply,
 48:      socket
 49:      |> assign(:filter_subject, subject)
 50:      |> load_plannings()}
 51:   end
 52: 
 53:   @impl true
 54:   def handle_event("search", %{"search" => %{"query" => query}}, socket) do
 55:     {:noreply,
 56:      socket
 57:      |> assign(:search_query, query)
 58:      |> load_plannings()}
 59:   end
 60: 
 61:   @impl true
 62:   def handle_event("toggle_view", %{"mode" => mode}, socket) do
 63:     {:noreply, assign(socket, :view_mode, mode)}
 64:   end
 65: 
 66:   @impl true
 67:   def handle_event("delete", %{"id" => id}, socket) do
 68:     planning = Plannings.get_planning!(id)
 69: 
 70:     case Plannings.delete_planning(planning) do
 71:       {:ok, _} ->
 72:         {:noreply,
 73:          socket
 74:          |> put_flash(:info, "Planejamento excluído com sucesso!")
 75:          |> load_plannings()
 76:          |> load_stats()}
 77: 
 78:       {:error, _} ->
 79:         {:noreply, put_flash(socket, :error, "Erro ao excluir planejamento")}
 80:     end
 81:   end
 82: 
 83:   @impl true
 84:   def handle_event("duplicate", %{"id" => id}, socket) do
 85:     planning = Plannings.get_planning!(id)
 86: 
 87:     case Plannings.duplicate_planning(planning, %{user_id: socket.assigns.current_user.id}) do
 88:       {:ok, new_planning} ->
 89:         {:noreply,
 90:          socket
 91:          |> put_flash(:info, "Planejamento duplicado: #{new_planning.title}")
 92:          |> load_plannings()
 93:          |> load_stats()}
 94: 
 95:       {:error, _} ->
 96:         {:noreply, put_flash(socket, :error, "Erro ao duplicar planejamento")}
 97:     end
 98:   end
 99: 
100:   @impl true
101:   def handle_event("publish", %{"id" => id}, socket) do
102:     planning = Plannings.get_planning!(id)
103: 
104:     case Plannings.publish_planning(planning) do
105:       {:ok, _} ->
106:         {:noreply,
107:          socket
108:          |> put_flash(:info, "Planejamento publicado!")
109:          |> load_plannings()}
110: 
111:       {:error, _} ->
112:         {:noreply, put_flash(socket, :error, "Erro ao publicar")}
113:     end
114:   end
115: 
116:   @impl true
117:   def handle_event("archive", %{"id" => id}, socket) do
118:     planning = Plannings.get_planning!(id)
119: 
120:     case Plannings.archive_planning(planning) do
121:       {:ok, _} ->
122:         {:noreply,
123:          socket
124:          |> put_flash(:info, "Planejamento arquivado!")
125:          |> load_plannings()}
126: 
127:       {:error, _} ->
128:         {:noreply, put_flash(socket, :error, "Erro ao arquivar")}
129:     end
130:   end
131: 
132:   defp load_plannings(socket) do
133:     user = socket.assigns.current_user
134: 
135:     opts =
136:       []
137:       |> maybe_add_filter(:status, socket.assigns.filter_status)
138:       |> maybe_add_filter(:subject, socket.assigns.filter_subject)
139:       |> maybe_add_filter(:search, socket.assigns.search_query)
140: 
141:     plannings = Plannings.list_plannings(user.id, opts)
142:     assign(socket, :plannings, plannings)
143:   end
144: 
145:   defp load_stats(socket) do
146:     user = socket.assigns.current_user
147: 
148:     stats = %{
149:       total: Plannings.count_total(user.id),
150:       by_status: Plannings.count_by_status(user.id),
151:       by_subject: Plannings.count_by_subject(user.id)
152:     }
153: 
154:     assign(socket, :stats, stats)
155:   end
156: 
157:   defp maybe_add_filter(opts, _key, nil), do: opts
158:   defp maybe_add_filter(opts, _key, ""), do: opts
159:   defp maybe_add_filter(opts, key, value), do: Keyword.put(opts, key, value)
160: 
161:   @impl true
162:   def render(assigns) do
163:     ~H"""
164:     <div class="min-h-screen bg-slate-50 dark:bg-slate-900">
165:       <!-- Header -->
166:       <div class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
167:         <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
168:           <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
169:             <div>
170:               <h1 class="text-2xl font-bold text-slate-900 dark:text-white">
171:                 Planejamentos
172:               </h1>
173:               <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">
174:                 Gerencie seus planos de aula
175:               </p>
176:             </div>
177: 
178:             <.link
179:               navigate={~p"/plannings/new"}
180:               class="inline-flex items-center gap-2 px-4 py-2.5 bg-teal-600 hover:bg-teal-700 text-white font-medium rounded-xl transition-colors"
181:             >
182:               <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
183:                 <path
184:                   stroke-linecap="round"
185:                   stroke-linejoin="round"
186:                   stroke-width="2"
187:                   d="M12 4v16m8-8H4"
188:                 />
189:               </svg>
190:               Novo Planejamento
191:             </.link>
192:           </div>
193:         </div>
194:       </div>
195:       <!-- Stats Cards -->
196:       <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
197:         <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
198:           <div class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
199:             <div class="flex items-center gap-3">
200:               <div class="p-2 bg-teal-100 dark:bg-teal-900/30 rounded-lg">
201:                 <svg
202:                   class="w-5 h-5 text-teal-600 dark:text-teal-400"
203:                   fill="none"
204:                   stroke="currentColor"
205:                   viewBox="0 0 24 24"
206:                 >
207:                   <path
208:                     stroke-linecap="round"
209:                     stroke-linejoin="round"
210:                     stroke-width="2"
211:                     d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
212:                   />
213:                 </svg>
214:               </div>
215:               <div>
216:                 <p class="text-2xl font-bold text-slate-900 dark:text-white"><%= @stats.total %></p>
217:                 <p class="text-xs text-slate-500 dark:text-slate-400">Total</p>
218:               </div>
219:             </div>
220:           </div>
221: 
222:           <div class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
223:             <div class="flex items-center gap-3">
224:               <div class="p-2 bg-amber-100 dark:bg-amber-900/30 rounded-lg">
225:                 <svg
226:                   class="w-5 h-5 text-amber-600 dark:text-amber-400"
227:                   fill="none"
228:                   stroke="currentColor"
229:                   viewBox="0 0 24 24"
230:                 >
231:                   <path
232:                     stroke-linecap="round"
233:                     stroke-linejoin="round"
234:                     stroke-width="2"
235:                     d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
236:                   />
237:                 </svg>
238:               </div>
239:               <div>
240:                 <p class="text-2xl font-bold text-slate-900 dark:text-white">
241:                   <%= Map.get(@stats.by_status, "draft", 0) %>
242:                 </p>
243:                 <p class="text-xs text-slate-500 dark:text-slate-400">Rascunhos</p>
244:               </div>
245:             </div>
246:           </div>
247: 
248:           <div class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
249:             <div class="flex items-center gap-3">
250:               <div class="p-2 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg">
251:                 <svg
252:                   class="w-5 h-5 text-emerald-600 dark:text-emerald-400"
253:                   fill="none"
254:                   stroke="currentColor"
255:                   viewBox="0 0 24 24"
256:                 >
257:                   <path
258:                     stroke-linecap="round"
259:                     stroke-linejoin="round"
260:                     stroke-width="2"
261:                     d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
262:                   />
263:                 </svg>
264:               </div>
265:               <div>
266:                 <p class="text-2xl font-bold text-slate-900 dark:text-white">
267:                   <%= Map.get(@stats.by_status, "published", 0) %>
268:                 </p>
269:                 <p class="text-xs text-slate-500 dark:text-slate-400">Publicados</p>
270:               </div>
271:             </div>
272:           </div>
273: 
274:           <div class="bg-white dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
275:             <div class="flex items-center gap-3">
276:               <div class="p-2 bg-slate-100 dark:bg-slate-700 rounded-lg">
277:                 <svg
278:                   class="w-5 h-5 text-slate-600 dark:text-slate-400"
279:                   fill="none"
280:                   stroke="currentColor"
281:                   viewBox="0 0 24 24"
282:                 >
283:                   <path
284:                     stroke-linecap="round"
285:                     stroke-linejoin="round"
286:                     stroke-width="2"
287:                     d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"
288:                   />
289:                 </svg>
290:               </div>
291:               <div>
292:                 <p class="text-2xl font-bold text-slate-900 dark:text-white">
293:                   <%= Map.get(@stats.by_status, "archived", 0) %>
294:                 </p>
295:                 <p class="text-xs text-slate-500 dark:text-slate-400">Arquivados</p>
296:               </div>
297:             </div>
298:           </div>
299:         </div>
300:       </div>
301:       <!-- Filters -->
302:       <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
303:         <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-4">
304:           <div class="flex flex-col sm:flex-row gap-4">
305:             <!-- Search -->
306:             <div class="flex-1">
307:               <form phx-change="search" phx-submit="search">
308:                 <div class="relative">
309:                   <svg
310:                     class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"
311:                     fill="none"
312:                     stroke="currentColor"
313:                     viewBox="0 0 24 24"
314:                   >
315:                     <path
316:                       stroke-linecap="round"
317:                       stroke-linejoin="round"
318:                       stroke-width="2"
319:                       d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
320:                     />
321:                   </svg>
322:                   <input
323:                     type="text"
324:                     name="search[query]"
325:                     value={@search_query}
326:                     placeholder="Buscar planejamentos..."
327:                     class="w-full pl-10 pr-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-teal-500"
328:                     phx-debounce="300"
329:                   />
330:                 </div>
331:               </form>
332:             </div>
333:             <!-- Status Filter -->
334:             <div>
335:               <select
336:                 phx-change="filter_status"
337:                 name="status"
338:                 class="px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
339:               >
340:                 <option value="">Todos os status</option>
341:                 <option value="draft" selected={@filter_status == "draft"}>Rascunhos</option>
342:                 <option value="published" selected={@filter_status == "published"}>Publicados</option>
343:                 <option value="archived" selected={@filter_status == "archived"}>Arquivados</option>
344:               </select>
345:             </div>
346:             <!-- Subject Filter -->
347:             <div>
348:               <select
349:                 phx-change="filter_subject"
350:                 name="subject"
351:                 class="px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
352:               >
353:                 <option value="">Todas as disciplinas</option>
354:                 <%= for subject <- Planning.subjects() do %>
355:                   <option value={subject} selected={@filter_subject == subject}>
356:                     <%= Planning.subject_label(subject) %>
357:                   </option>
358:                 <% end %>
359:               </select>
360:             </div>
361:             <!-- View Toggle -->
362:             <div class="flex items-center gap-1 bg-slate-100 dark:bg-slate-700 rounded-lg p-1">
363:               <button
364:                 phx-click="toggle_view"
365:                 phx-value-mode="cards"
366:                 class={"px-3 py-1.5 rounded-md text-sm font-medium transition-colors #{if @view_mode == "cards", do: "bg-white dark:bg-slate-600 text-slate-900 dark:text-white shadow-sm", else: "text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300"}"}
367:               >
368:                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
369:                   <path
370:                     stroke-linecap="round"
371:                     stroke-linejoin="round"
372:                     stroke-width="2"
373:                     d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
374:                   />
375:                 </svg>
376:               </button>
377:               <button
378:                 phx-click="toggle_view"
379:                 phx-value-mode="table"
380:                 class={"px-3 py-1.5 rounded-md text-sm font-medium transition-colors #{if @view_mode == "table", do: "bg-white dark:bg-slate-600 text-slate-900 dark:text-white shadow-sm", else: "text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300"}"}
381:               >
382:                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
383:                   <path
384:                     stroke-linecap="round"
385:                     stroke-linejoin="round"
386:                     stroke-width="2"
387:                     d="M4 6h16M4 10h16M4 14h16M4 18h16"
388:                   />
389:                 </svg>
390:               </button>
391:             </div>
392:           </div>
393:         </div>
394:       </div>
395:       <!-- Plannings List -->
396:       <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
397:         <%= if Enum.empty?(@plannings) do %>
398:           <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-12 text-center">
399:             <svg
400:               class="mx-auto w-16 h-16 text-slate-300 dark:text-slate-600"
401:               fill="none"
402:               stroke="currentColor"
403:               viewBox="0 0 24 24"
404:             >
405:               <path
406:                 stroke-linecap="round"
407:                 stroke-linejoin="round"
408:                 stroke-width="1.5"
409:                 d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
410:               />
411:             </svg>
412:             <h3 class="mt-4 text-lg font-medium text-slate-900 dark:text-white">
413:               Nenhum planejamento encontrado
414:             </h3>
415:             <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">
416:               Comece criando seu primeiro plano de aula
417:             </p>
418:             <.link
419:               navigate={~p"/plannings/new"}
420:               class="mt-4 inline-flex items-center gap-2 px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white font-medium rounded-lg transition-colors"
421:             >
422:               <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
423:                 <path
424:                   stroke-linecap="round"
425:                   stroke-linejoin="round"
426:                   stroke-width="2"
427:                   d="M12 4v16m8-8H4"
428:                 />
429:               </svg>
430:               Criar Planejamento
431:             </.link>
432:           </div>
433:         <% else %>
434:           <%= if @view_mode == "cards" do %>
435:             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
436:               <%= for planning <- @plannings do %>
437:                 <.planning_card planning={planning} />
438:               <% end %>
439:             </div>
440:           <% else %>
441:             <.planning_table plannings={@plannings} />
442:           <% end %>
443:         <% end %>
444:       </div>
445:     </div>
446:     """
447:   end
448: 
449:   defp planning_card(assigns) do
450:     ~H"""
451:     <div class="group bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-5 hover:shadow-lg hover:-translate-y-0.5 transition-all duration-200">
452:       <div class="flex items-start justify-between">
453:         <.status_badge status={@planning.status} />
454:         <div class="relative">
455:           <button
456:             phx-click={JS.toggle(to: "#menu-#{@planning.id}")}
457:             class="p-1.5 rounded-lg text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"
458:           >
459:             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
460:               <path
461:                 stroke-linecap="round"
462:                 stroke-linejoin="round"
463:                 stroke-width="2"
464:                 d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"
465:               />
466:             </svg>
467:           </button>
468:           <div
469:             id={"menu-#{@planning.id}"}
470:             class="hidden absolute right-0 mt-1 w-48 bg-white dark:bg-slate-700 rounded-lg shadow-lg border border-slate-200 dark:border-slate-600 py-1 z-10"
471:           >
472:             <.link
473:               navigate={~p"/plannings/#{@planning.id}"}
474:               class="flex items-center gap-2 px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-600"
475:             >
476:               <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
477:                 <path
478:                   stroke-linecap="round"
479:                   stroke-linejoin="round"
480:                   stroke-width="2"
481:                   d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
482:                 />
483:                 <path
484:                   stroke-linecap="round"
485:                   stroke-linejoin="round"
486:                   stroke-width="2"
487:                   d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
488:                 />
489:               </svg>
490:               Ver Detalhes
491:             </.link>
492:             <.link
493:               navigate={~p"/plannings/#{@planning.id}/edit"}
494:               class="flex items-center gap-2 px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-600"
495:             >
496:               <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
497:                 <path
498:                   stroke-linecap="round"
499:                   stroke-linejoin="round"
500:                   stroke-width="2"
501:                   d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
502:                 />
503:               </svg>
504:               Editar
505:             </.link>
506:             <button
507:               phx-click="duplicate"
508:               phx-value-id={@planning.id}
509:               class="flex items-center gap-2 w-full px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-600"
510:             >
511:               <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
512:                 <path
513:                   stroke-linecap="round"
514:                   stroke-linejoin="round"
515:                   stroke-width="2"
516:                   d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
517:                 />
518:               </svg>
519:               Duplicar
520:             </button>
521:             <%= if @planning.status == "draft" do %>
522:               <button
523:                 phx-click="publish"
524:                 phx-value-id={@planning.id}
525:                 class="flex items-center gap-2 w-full px-4 py-2 text-sm text-emerald-600 dark:text-emerald-400 hover:bg-slate-100 dark:hover:bg-slate-600"
526:               >
527:                 <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
528:                   <path
529:                     stroke-linecap="round"
530:                     stroke-linejoin="round"
531:                     stroke-width="2"
532:                     d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
533:                   />
534:                 </svg>
535:                 Publicar
536:               </button>
537:             <% end %>
538:             <%= if @planning.status != "archived" do %>
539:               <button
540:                 phx-click="archive"
541:                 phx-value-id={@planning.id}
542:                 class="flex items-center gap-2 w-full px-4 py-2 text-sm text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-600"
543:               >
544:                 <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
545:                   <path
546:                     stroke-linecap="round"
547:                     stroke-linejoin="round"
548:                     stroke-width="2"
549:                     d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"
550:                   />
551:                 </svg>
552:                 Arquivar
553:               </button>
554:             <% end %>
555:             <hr class="my-1 border-slate-200 dark:border-slate-600" />
556:             <button
557:               phx-click="delete"
558:               phx-value-id={@planning.id}
559:               data-confirm="Tem certeza que deseja excluir este planejamento?"
560:               class="flex items-center gap-2 w-full px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-slate-100 dark:hover:bg-slate-600"
561:             >
562:               <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
563:                 <path
564:                   stroke-linecap="round"
565:                   stroke-linejoin="round"
566:                   stroke-width="2"
567:                   d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
568:                 />
569:               </svg>
570:               Excluir
571:             </button>
572:           </div>
573:         </div>
574:       </div>
575: 
576:       <.link navigate={~p"/plannings/#{@planning.id}"} class="block mt-4">
577:         <h3 class="text-lg font-semibold text-slate-900 dark:text-white group-hover:text-teal-600 dark:group-hover:text-teal-400 transition-colors line-clamp-2">
578:           <%= @planning.title %>
579:         </h3>
580:       </.link>
581: 
582:       <div class="mt-2 flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400">
583:         <span class="px-2 py-0.5 bg-slate-100 dark:bg-slate-700 rounded-md">
584:           <%= Planning.subject_label(@planning.subject) %>
585:         </span>
586:         <span>•</span>
587:         <span><%= Planning.grade_level_label(@planning.grade_level) %></span>
588:       </div>
589: 
590:       <%= if @planning.description do %>
591:         <p class="mt-3 text-sm text-slate-600 dark:text-slate-300 line-clamp-2">
592:           <%= @planning.description %>
593:         </p>
594:       <% end %>
595: 
596:       <div class="mt-4 flex items-center justify-between text-xs text-slate-400 dark:text-slate-500">
597:         <div class="flex items-center gap-1">
598:           <%= if @planning.generated_by_ai do %>
599:             <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-violet-100 dark:bg-violet-900/30 text-violet-600 dark:text-violet-400 rounded-full">
600:               <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
601:                 <path
602:                   stroke-linecap="round"
603:                   stroke-linejoin="round"
604:                   stroke-width="2"
605:                   d="M13 10V3L4 14h7v7l9-11h-7z"
606:                 />
607:               </svg>
608:               IA
609:             </span>
610:           <% end %>
611:           <%= if length(@planning.bncc_codes || []) > 0 do %>
612:             <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-teal-100 dark:bg-teal-900/30 text-teal-600 dark:text-teal-400 rounded-full">
613:               BNCC: <%= length(@planning.bncc_codes) %>
614:             </span>
615:           <% end %>
616:         </div>
617:         <span><%= Calendar.strftime(@planning.inserted_at, "%d/%m/%Y") %></span>
618:       </div>
619:     </div>
620:     """
621:   end
622: 
623:   defp planning_table(assigns) do
624:     ~H"""
625:     <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
626:       <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
627:         <thead class="bg-slate-50 dark:bg-slate-800">
628:           <tr>
629:             <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
630:               Planejamento
631:             </th>
632:             <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
633:               Disciplina / Ano
634:             </th>
635:             <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
636:               Status
637:             </th>
638:             <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
639:               BNCC
640:             </th>
641:             <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
642:               Data
643:             </th>
644:             <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
645:               Ações
646:             </th>
647:           </tr>
648:         </thead>
649:         <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
650:           <%= for planning <- @plannings do %>
651:             <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
652:               <td class="px-6 py-4">
653:                 <.link navigate={~p"/plannings/#{planning.id}"} class="block">
654:                   <div class="font-medium text-slate-900 dark:text-white hover:text-teal-600 dark:hover:text-teal-400">
655:                     <%= planning.title %>
656:                   </div>
657:                   <%= if planning.generated_by_ai do %>
658:                     <span class="inline-flex items-center gap-1 text-xs text-violet-600 dark:text-violet-400">
659:                       <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
660:                         <path
661:                           stroke-linecap="round"
662:                           stroke-linejoin="round"
663:                           stroke-width="2"
664:                           d="M13 10V3L4 14h7v7l9-11h-7z"
665:                         />
666:                       </svg>
667:                       Gerado por IA
668:                     </span>
669:                   <% end %>
670:                 </.link>
671:               </td>
672:               <td class="px-6 py-4 text-sm text-slate-500 dark:text-slate-400">
673:                 <div><%= Planning.subject_label(planning.subject) %></div>
674:                 <div class="text-xs"><%= Planning.grade_level_label(planning.grade_level) %></div>
675:               </td>
676:               <td class="px-6 py-4">
677:                 <.status_badge status={planning.status} />
678:               </td>
679:               <td class="px-6 py-4 text-sm text-slate-500 dark:text-slate-400">
680:                 <%= length(planning.bncc_codes || []) %> códigos
681:               </td>
682:               <td class="px-6 py-4 text-sm text-slate-500 dark:text-slate-400">
683:                 <%= Calendar.strftime(planning.inserted_at, "%d/%m/%Y") %>
684:               </td>
685:               <td class="px-6 py-4 text-right">
686:                 <.link
687:                   navigate={~p"/plannings/#{planning.id}"}
688:                   class="text-teal-600 dark:text-teal-400 hover:text-teal-800 dark:hover:text-teal-300 font-medium text-sm"
689:                 >
690:                   Ver
691:                 </.link>
692:               </td>
693:             </tr>
694:           <% end %>
695:         </tbody>
696:       </table>
697:     </div>
698:     """
699:   end
700: 
701:   defp status_badge(assigns) do
702:     {bg, text} =
703:       case assigns.status do
704:         "draft" ->
705:           {"bg-amber-100 dark:bg-amber-900/30", "text-amber-700 dark:text-amber-400"}
706: 
707:         "published" ->
708:           {"bg-emerald-100 dark:bg-emerald-900/30", "text-emerald-700 dark:text-emerald-400"}
709: 
710:         "archived" ->
711:           {"bg-slate-100 dark:bg-slate-700", "text-slate-600 dark:text-slate-400"}
712: 
713:         _ ->
714:           {"bg-slate-100 dark:bg-slate-700", "text-slate-600 dark:text-slate-400"}
715:       end
716: 
717:     assigns = assign(assigns, :bg, bg)
718:     assigns = assign(assigns, :text, text)
719: 
720:     ~H"""
721:     <span class={"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium #{@bg} #{@text}"}>
722:       <%= Planning.status_label(@status) %>
723:     </span>
724:     """
725:   end
726: end
````

## File: lib/hellen_web/live/plannings_live/new.ex
````elixir
  1: defmodule HellenWeb.PlanningsLive.New do
  2:   @moduledoc """
  3:   LiveView for creating new plannings - manual or AI-generated.
  4:   """
  5: 
  6:   use HellenWeb, :live_view
  7: 
  8:   alias Hellen.AI.PlanningGenerator
  9:   alias Hellen.Lessons
 10:   alias Hellen.Plannings
 11:   alias Hellen.Plannings.Planning
 12: 
 13:   @impl true
 14:   def mount(_params, _session, socket) do
 15:     user = socket.assigns.current_user
 16: 
 17:     # Get user's lessons for AI generation
 18:     lessons = Lessons.list_lessons_by_user(user.id, status: "analyzed", limit: 20)
 19: 
 20:     changeset = Plannings.change_planning(%Planning{}, %{})
 21: 
 22:     {:ok,
 23:      socket
 24:      |> assign(:page_title, "Novo Planejamento")
 25:      |> assign(:form, to_form(changeset))
 26:      |> assign(:lessons, lessons)
 27:      |> assign(:mode, "manual")
 28:      |> assign(:generating, false)
 29:      |> assign(:suggesting, false)
 30:      |> assign(:suggestions, nil)
 31:      |> assign(:selected_lesson_id, nil)
 32:      |> assign(:ai_topic, "")}
 33:   end
 34: 
 35:   @impl true
 36:   def handle_event("switch_mode", %{"mode" => mode}, socket) do
 37:     {:noreply, assign(socket, :mode, mode)}
 38:   end
 39: 
 40:   @impl true
 41:   def handle_event("select_lesson", %{"id" => lesson_id}, socket) do
 42:     {:noreply, assign(socket, :selected_lesson_id, lesson_id)}
 43:   end
 44: 
 45:   @impl true
 46:   def handle_event("update_topic", %{"topic" => topic}, socket) do
 47:     {:noreply, assign(socket, :ai_topic, topic)}
 48:   end
 49: 
 50:   @impl true
 51:   def handle_event("generate_from_lesson", _params, socket) do
 52:     lesson_id = socket.assigns.selected_lesson_id
 53:     user_id = socket.assigns.current_user.id
 54: 
 55:     if lesson_id do
 56:       socket = assign(socket, :generating, true)
 57: 
 58:       # Run AI generation in a task
 59:       task =
 60:         Task.async(fn ->
 61:           PlanningGenerator.from_lesson(lesson_id, user_id)
 62:         end)
 63: 
 64:       {:noreply, assign(socket, :generation_task, task)}
 65:     else
 66:       {:noreply, put_flash(socket, :error, "Selecione uma aula primeiro")}
 67:     end
 68:   end
 69: 
 70:   @impl true
 71:   def handle_event(
 72:         "generate_from_topic",
 73:         %{"subject" => subject, "grade_level" => grade_level},
 74:         socket
 75:       ) do
 76:     topic = socket.assigns.ai_topic
 77:     user_id = socket.assigns.current_user.id
 78: 
 79:     if topic != "" and subject != "" and grade_level != "" do
 80:       socket = assign(socket, :generating, true)
 81: 
 82:       task =
 83:         Task.async(fn ->
 84:           PlanningGenerator.from_topic(topic, subject, grade_level, user_id)
 85:         end)
 86: 
 87:       {:noreply, assign(socket, :generation_task, task)}
 88:     else
 89:       {:noreply, put_flash(socket, :error, "Preencha todos os campos")}
 90:     end
 91:   end
 92: 
 93:   @impl true
 94:   def handle_event("validate", %{"planning" => planning_params}, socket) do
 95:     changeset =
 96:       %Planning{}
 97:       |> Plannings.change_planning(planning_params)
 98:       |> Map.put(:action, :validate)
 99: 
100:     {:noreply, assign(socket, :form, to_form(changeset))}
101:   end
102: 
103:   @impl true
104:   def handle_event("request_suggestions", %{"planning" => params}, socket) do
105:     title = params["title"] || ""
106:     subject = params["subject"] || ""
107:     grade_level = params["grade_level"] || ""
108:     description = params["description"]
109: 
110:     if String.trim(title) != "" and subject != "" and grade_level != "" do
111:       socket = assign(socket, :suggesting, true)
112: 
113:       task =
114:         Task.async(fn ->
115:           PlanningGenerator.suggest_fields(title, subject, grade_level, description)
116:         end)
117: 
118:       {:noreply, assign(socket, :suggestion_task, task)}
119:     else
120:       {:noreply,
121:        put_flash(socket, :error, "Preencha título, disciplina e série para gerar sugestões")}
122:     end
123:   end
124: 
125:   @impl true
126:   def handle_event("apply_suggestion", %{"field" => field}, socket) do
127:     suggestions = socket.assigns.suggestions
128: 
129:     if suggestions do
130:       value = Map.get(suggestions, String.to_existing_atom(field))
131:       form = socket.assigns.form
132:       current_params = form.source.changes
133: 
134:       new_params = Map.put(current_params, String.to_existing_atom(field), value)
135: 
136:       changeset =
137:         %Planning{}
138:         |> Plannings.change_planning(new_params)
139: 
140:       {:noreply, assign(socket, :form, to_form(changeset))}
141:     else
142:       {:noreply, socket}
143:     end
144:   end
145: 
146:   @impl true
147:   def handle_event("dismiss_suggestions", _params, socket) do
148:     {:noreply, assign(socket, :suggestions, nil)}
149:   end
150: 
151:   @impl true
152:   def handle_event("save", %{"planning" => planning_params}, socket) do
153:     user = socket.assigns.current_user
154: 
155:     planning_params =
156:       planning_params
157:       |> Map.put("user_id", user.id)
158:       |> Map.put("institution_id", user.institution_id)
159: 
160:     case Plannings.create_planning(planning_params) do
161:       {:ok, planning} ->
162:         {:noreply,
163:          socket
164:          |> put_flash(:info, "Planejamento criado com sucesso!")
165:          |> push_navigate(to: ~p"/plannings/#{planning.id}")}
166: 
167:       {:error, %Ecto.Changeset{} = changeset} ->
168:         {:noreply, assign(socket, :changeset, changeset)}
169:     end
170:   end
171: 
172:   @impl true
173:   def handle_info({ref, result}, socket) do
174:     cond do
175:       # Handle generation task result
176:       Map.has_key?(socket.assigns, :generation_task) and
177:         socket.assigns.generation_task != nil and
178:           ref == socket.assigns.generation_task.ref ->
179:         Process.demonitor(ref, [:flush])
180: 
181:         case result do
182:           {:ok, planning} ->
183:             {:noreply,
184:              socket
185:              |> assign(:generating, false)
186:              |> put_flash(:info, "Planejamento gerado com sucesso!")
187:              |> push_navigate(to: ~p"/plannings/#{planning.id}/edit")}
188: 
189:           {:error, reason} ->
190:             {:noreply,
191:              socket
192:              |> assign(:generating, false)
193:              |> put_flash(:error, "Erro ao gerar planejamento: #{inspect(reason)}")}
194:         end
195: 
196:       # Handle suggestion task result
197:       Map.has_key?(socket.assigns, :suggestion_task) and
198:         socket.assigns.suggestion_task != nil and
199:           ref == socket.assigns.suggestion_task.ref ->
200:         Process.demonitor(ref, [:flush])
201: 
202:         case result do
203:           {:ok, suggestions} ->
204:             {:noreply,
205:              socket
206:              |> assign(:suggesting, false)
207:              |> assign(:suggestions, suggestions)}
208: 
209:           {:error, _reason} ->
210:             {:noreply,
211:              socket
212:              |> assign(:suggesting, false)
213:              |> put_flash(:error, "Erro ao gerar sugestões")}
214:         end
215: 
216:       true ->
217:         {:noreply, socket}
218:     end
219:   end
220: 
221:   @impl true
222:   def handle_info({:DOWN, _ref, :process, _pid, _reason}, socket) do
223:     {:noreply, assign(socket, :generating, false)}
224:   end
225: 
226:   @impl true
227:   def render(assigns) do
228:     ~H"""
229:     <div class="min-h-screen bg-slate-50 dark:bg-slate-900">
230:       <!-- Header -->
231:       <div class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
232:         <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
233:           <div class="flex items-center gap-4">
234:             <.link
235:               navigate={~p"/plannings"}
236:               class="p-2 rounded-lg text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"
237:             >
238:               <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
239:                 <path
240:                   stroke-linecap="round"
241:                   stroke-linejoin="round"
242:                   stroke-width="2"
243:                   d="M10 19l-7-7m0 0l7-7m-7 7h18"
244:                 />
245:               </svg>
246:             </.link>
247:             <div>
248:               <h1 class="text-2xl font-bold text-slate-900 dark:text-white">
249:                 Novo Planejamento
250:               </h1>
251:               <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">
252:                 Crie um plano de aula manual ou use IA
253:               </p>
254:             </div>
255:           </div>
256:         </div>
257:       </div>
258:       <!-- Mode Selector -->
259:       <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
260:         <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-1 inline-flex">
261:           <button
262:             phx-click="switch_mode"
263:             phx-value-mode="manual"
264:             class={"px-4 py-2 rounded-lg text-sm font-medium transition-colors #{if @mode == "manual", do: "bg-teal-600 text-white", else: "text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"}"}
265:           >
266:             Criar Manualmente
267:           </button>
268:           <button
269:             phx-click="switch_mode"
270:             phx-value-mode="from_lesson"
271:             class={"px-4 py-2 rounded-lg text-sm font-medium transition-colors #{if @mode == "from_lesson", do: "bg-teal-600 text-white", else: "text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"}"}
272:           >
273:             <span class="inline-flex items-center gap-1">
274:               <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
275:                 <path
276:                   stroke-linecap="round"
277:                   stroke-linejoin="round"
278:                   stroke-width="2"
279:                   d="M13 10V3L4 14h7v7l9-11h-7z"
280:                 />
281:               </svg>
282:               De uma Aula
283:             </span>
284:           </button>
285:           <button
286:             phx-click="switch_mode"
287:             phx-value-mode="from_topic"
288:             class={"px-4 py-2 rounded-lg text-sm font-medium transition-colors #{if @mode == "from_topic", do: "bg-teal-600 text-white", else: "text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"}"}
289:           >
290:             <span class="inline-flex items-center gap-1">
291:               <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
292:                 <path
293:                   stroke-linecap="round"
294:                   stroke-linejoin="round"
295:                   stroke-width="2"
296:                   d="M13 10V3L4 14h7v7l9-11h-7z"
297:                 />
298:               </svg>
299:               De um Tema
300:             </span>
301:           </button>
302:         </div>
303:       </div>
304:       <!-- Content -->
305:       <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
306:         <%= if @generating do %>
307:           <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-12 text-center">
308:             <div class="animate-spin w-12 h-12 border-4 border-teal-600 border-t-transparent rounded-full mx-auto">
309:             </div>
310:             <h3 class="mt-4 text-lg font-medium text-slate-900 dark:text-white">
311:               Gerando planejamento com IA...
312:             </h3>
313:             <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">
314:               Isso pode levar alguns segundos
315:             </p>
316:           </div>
317:         <% else %>
318:           <%= case @mode do %>
319:             <% "manual" -> %>
320:               <.manual_form form={@form} suggesting={@suggesting} suggestions={@suggestions} />
321:             <% "from_lesson" -> %>
322:               <.from_lesson_form lessons={@lessons} selected={@selected_lesson_id} />
323:             <% "from_topic" -> %>
324:               <.from_topic_form topic={@ai_topic} />
325:           <% end %>
326:         <% end %>
327:       </div>
328:     </div>
329:     """
330:   end
331: 
332:   defp manual_form(assigns) do
333:     ~H"""
334:     <div class="space-y-4">
335:       <!-- AI Suggestions Panel -->
336:       <%= if @suggestions do %>
337:         <div class="bg-violet-50 dark:bg-violet-900/20 border border-violet-200 dark:border-violet-800 rounded-xl p-4">
338:           <div class="flex items-start justify-between mb-3">
339:             <div class="flex items-center gap-2">
340:               <svg
341:                 class="w-5 h-5 text-violet-600 dark:text-violet-400"
342:                 fill="none"
343:                 stroke="currentColor"
344:                 viewBox="0 0 24 24"
345:               >
346:                 <path
347:                   stroke-linecap="round"
348:                   stroke-linejoin="round"
349:                   stroke-width="2"
350:                   d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
351:                 />
352:               </svg>
353:               <h3 class="font-medium text-violet-900 dark:text-violet-200">Sugestoes da IA</h3>
354:             </div>
355:             <button
356:               type="button"
357:               phx-click="dismiss_suggestions"
358:               class="text-violet-400 hover:text-violet-600 dark:hover:text-violet-300"
359:             >
360:               <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
361:                 <path
362:                   stroke-linecap="round"
363:                   stroke-linejoin="round"
364:                   stroke-width="2"
365:                   d="M6 18L18 6M6 6l12 12"
366:                 />
367:               </svg>
368:             </button>
369:           </div>
370: 
371:           <div class="space-y-3">
372:             <%= if @suggestions.description do %>
373:               <div class="bg-white dark:bg-slate-800 rounded-lg p-3">
374:                 <div class="flex items-center justify-between mb-1">
375:                   <span class="text-xs font-medium text-violet-600 dark:text-violet-400">
376:                     Descricao
377:                   </span>
378:                   <button
379:                     type="button"
380:                     phx-click="apply_suggestion"
381:                     phx-value-field="description"
382:                     class="text-xs text-violet-600 hover:text-violet-800 dark:text-violet-400 dark:hover:text-violet-300 font-medium"
383:                   >
384:                     Aplicar
385:                   </button>
386:                 </div>
387:                 <p class="text-sm text-slate-700 dark:text-slate-300">
388:                   <%= @suggestions.description %>
389:                 </p>
390:               </div>
391:             <% end %>
392: 
393:             <%= if @suggestions.methodology do %>
394:               <div class="bg-white dark:bg-slate-800 rounded-lg p-3">
395:                 <div class="flex items-center justify-between mb-1">
396:                   <span class="text-xs font-medium text-violet-600 dark:text-violet-400">
397:                     Metodologia
398:                   </span>
399:                   <button
400:                     type="button"
401:                     phx-click="apply_suggestion"
402:                     phx-value-field="methodology"
403:                     class="text-xs text-violet-600 hover:text-violet-800 dark:text-violet-400 dark:hover:text-violet-300 font-medium"
404:                   >
405:                     Aplicar
406:                   </button>
407:                 </div>
408:                 <p class="text-sm text-slate-700 dark:text-slate-300">
409:                   <%= @suggestions.methodology %>
410:                 </p>
411:               </div>
412:             <% end %>
413: 
414:             <%= if @suggestions.assessment_criteria do %>
415:               <div class="bg-white dark:bg-slate-800 rounded-lg p-3">
416:                 <div class="flex items-center justify-between mb-1">
417:                   <span class="text-xs font-medium text-violet-600 dark:text-violet-400">
418:                     Criterios de Avaliacao
419:                   </span>
420:                   <button
421:                     type="button"
422:                     phx-click="apply_suggestion"
423:                     phx-value-field="assessment_criteria"
424:                     class="text-xs text-violet-600 hover:text-violet-800 dark:text-violet-400 dark:hover:text-violet-300 font-medium"
425:                   >
426:                     Aplicar
427:                   </button>
428:                 </div>
429:                 <p class="text-sm text-slate-700 dark:text-slate-300">
430:                   <%= @suggestions.assessment_criteria %>
431:                 </p>
432:               </div>
433:             <% end %>
434:           </div>
435:         </div>
436:       <% end %>
437: 
438:       <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
439:         <.form for={@form} phx-change="validate" phx-submit="save" class="space-y-6">
440:           <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
441:             <div class="md:col-span-2">
442:               <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
443:                 Titulo *
444:               </label>
445:               <input
446:                 type="text"
447:                 name="planning[title]"
448:                 value={@form[:title].value}
449:                 placeholder="Ex: Introducao as Fracoes"
450:                 class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-teal-500"
451:                 required
452:               />
453:             </div>
454: 
455:             <div>
456:               <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
457:                 Disciplina *
458:               </label>
459:               <select
460:                 name="planning[subject]"
461:                 class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
462:                 required
463:               >
464:                 <option value="">Selecione...</option>
465:                 <%= for subject <- Planning.subjects() do %>
466:                   <option value={subject} selected={@form[:subject].value == subject}>
467:                     <%= Planning.subject_label(subject) %>
468:                   </option>
469:                 <% end %>
470:               </select>
471:             </div>
472: 
473:             <div>
474:               <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
475:                 Ano/Serie *
476:               </label>
477:               <select
478:                 name="planning[grade_level]"
479:                 class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
480:                 required
481:               >
482:                 <option value="">Selecione...</option>
483:                 <%= for level <- Planning.grade_levels() do %>
484:                   <option value={level} selected={@form[:grade_level].value == level}>
485:                     <%= Planning.grade_level_label(level) %>
486:                   </option>
487:                 <% end %>
488:               </select>
489:             </div>
490: 
491:             <div>
492:               <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
493:                 Duracao (minutos)
494:               </label>
495:               <input
496:                 type="number"
497:                 name="planning[duration_minutes]"
498:                 value={@form[:duration_minutes].value || 50}
499:                 min="15"
500:                 max="240"
501:                 class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
502:               />
503:             </div>
504:             <!-- AI Suggest Button -->
505:             <div class="flex items-end">
506:               <button
507:                 type="button"
508:                 phx-click="request_suggestions"
509:                 disabled={@suggesting}
510:                 class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 bg-violet-100 hover:bg-violet-200 dark:bg-violet-900/30 dark:hover:bg-violet-900/50 text-violet-700 dark:text-violet-300 font-medium rounded-lg transition-colors disabled:opacity-50"
511:               >
512:                 <%= if @suggesting do %>
513:                   <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
514:                     <circle
515:                       class="opacity-25"
516:                       cx="12"
517:                       cy="12"
518:                       r="10"
519:                       stroke="currentColor"
520:                       stroke-width="4"
521:                     >
522:                     </circle>
523:                     <path
524:                       class="opacity-75"
525:                       fill="currentColor"
526:                       d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
527:                     >
528:                     </path>
529:                   </svg>
530:                   Gerando...
531:                 <% else %>
532:                   <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
533:                     <path
534:                       stroke-linecap="round"
535:                       stroke-linejoin="round"
536:                       stroke-width="2"
537:                       d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
538:                     />
539:                   </svg>
540:                   Sugerir com IA
541:                 <% end %>
542:               </button>
543:             </div>
544: 
545:             <div class="md:col-span-2">
546:               <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
547:                 Descricao
548:               </label>
549:               <textarea
550:                 name="planning[description]"
551:                 rows="3"
552:                 placeholder="Breve descricao do que sera abordado na aula"
553:                 class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-teal-500"
554:               ><%= @form[:description].value %></textarea>
555:             </div>
556: 
557:             <div class="md:col-span-2">
558:               <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
559:                 Metodologia
560:               </label>
561:               <textarea
562:                 name="planning[methodology]"
563:                 rows="4"
564:                 placeholder="Descreva a metodologia que sera utilizada (expositiva, dialogada, pratica, etc.)"
565:                 class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-teal-500"
566:               ><%= @form[:methodology].value %></textarea>
567:             </div>
568: 
569:             <div class="md:col-span-2">
570:               <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
571:                 Criterios de Avaliacao
572:               </label>
573:               <textarea
574:                 name="planning[assessment_criteria]"
575:                 rows="3"
576:                 placeholder="Como voce avaliara se os objetivos foram alcancados?"
577:                 class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-teal-500"
578:               ><%= @form[:assessment_criteria].value %></textarea>
579:             </div>
580:           </div>
581: 
582:           <div class="flex justify-end gap-3 pt-4 border-t border-slate-200 dark:border-slate-700">
583:             <.link
584:               navigate={~p"/plannings"}
585:               class="px-4 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"
586:             >
587:               Cancelar
588:             </.link>
589:             <button
590:               type="submit"
591:               class="px-6 py-2 bg-teal-600 hover:bg-teal-700 text-white font-medium rounded-lg transition-colors"
592:             >
593:               Criar Planejamento
594:             </button>
595:           </div>
596:         </.form>
597:       </div>
598:     </div>
599:     """
600:   end
601: 
602:   defp from_lesson_form(assigns) do
603:     ~H"""
604:     <div class="space-y-6">
605:       <div class="bg-violet-50 dark:bg-violet-900/20 border border-violet-200 dark:border-violet-800 rounded-xl p-4">
606:         <div class="flex items-start gap-3">
607:           <svg
608:             class="w-5 h-5 text-violet-600 dark:text-violet-400 mt-0.5"
609:             fill="none"
610:             stroke="currentColor"
611:             viewBox="0 0 24 24"
612:           >
613:             <path
614:               stroke-linecap="round"
615:               stroke-linejoin="round"
616:               stroke-width="2"
617:               d="M13 10V3L4 14h7v7l9-11h-7z"
618:             />
619:           </svg>
620:           <div>
621:             <h3 class="font-medium text-violet-900 dark:text-violet-200">Geração com IA</h3>
622:             <p class="mt-1 text-sm text-violet-700 dark:text-violet-300">
623:               Selecione uma aula já analisada para gerar automaticamente um planejamento baseado na transcrição.
624:             </p>
625:           </div>
626:         </div>
627:       </div>
628: 
629:       <%= if Enum.empty?(@lessons) do %>
630:         <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-12 text-center">
631:           <svg
632:             class="mx-auto w-16 h-16 text-slate-300 dark:text-slate-600"
633:             fill="none"
634:             stroke="currentColor"
635:             viewBox="0 0 24 24"
636:           >
637:             <path
638:               stroke-linecap="round"
639:               stroke-linejoin="round"
640:               stroke-width="1.5"
641:               d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
642:             />
643:           </svg>
644:           <h3 class="mt-4 text-lg font-medium text-slate-900 dark:text-white">
645:             Nenhuma aula analisada
646:           </h3>
647:           <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">
648:             Você precisa ter aulas já analisadas para gerar planejamentos automaticamente.
649:           </p>
650:           <.link
651:             navigate={~p"/lessons/new"}
652:             class="mt-4 inline-flex items-center gap-2 px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white font-medium rounded-lg transition-colors"
653:           >
654:             Enviar uma Aula
655:           </.link>
656:         </div>
657:       <% else %>
658:         <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
659:           <h3 class="text-lg font-medium text-slate-900 dark:text-white mb-4">
660:             Selecione uma aula
661:           </h3>
662:           <div class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-96 overflow-y-auto">
663:             <%= for lesson <- @lessons do %>
664:               <button
665:                 phx-click="select_lesson"
666:                 phx-value-id={lesson.id}
667:                 class={"p-4 text-left rounded-xl border-2 transition-all #{if @selected == lesson.id, do: "border-teal-500 bg-teal-50 dark:bg-teal-900/20", else: "border-slate-200 dark:border-slate-700 hover:border-slate-300 dark:hover:border-slate-600"}"}
668:               >
669:                 <div class="font-medium text-slate-900 dark:text-white line-clamp-1">
670:                   <%= lesson.title %>
671:                 </div>
672:                 <div class="mt-1 text-sm text-slate-500 dark:text-slate-400">
673:                   <%= lesson.subject || "Disciplina não definida" %> • <%= lesson.grade_level ||
674:                     "Série não definida" %>
675:                 </div>
676:                 <div class="mt-2 text-xs text-slate-400 dark:text-slate-500">
677:                   <%= Calendar.strftime(lesson.inserted_at, "%d/%m/%Y") %>
678:                 </div>
679:               </button>
680:             <% end %>
681:           </div>
682: 
683:           <div class="mt-6 flex justify-end">
684:             <button
685:               phx-click="generate_from_lesson"
686:               disabled={@selected == nil}
687:               class={"px-6 py-2 font-medium rounded-lg transition-colors #{if @selected, do: "bg-violet-600 hover:bg-violet-700 text-white", else: "bg-slate-200 dark:bg-slate-700 text-slate-400 cursor-not-allowed"}"}
688:             >
689:               <span class="inline-flex items-center gap-2">
690:                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
691:                   <path
692:                     stroke-linecap="round"
693:                     stroke-linejoin="round"
694:                     stroke-width="2"
695:                     d="M13 10V3L4 14h7v7l9-11h-7z"
696:                   />
697:                 </svg>
698:                 Gerar Planejamento
699:               </span>
700:             </button>
701:           </div>
702:         </div>
703:       <% end %>
704:     </div>
705:     """
706:   end
707: 
708:   defp from_topic_form(assigns) do
709:     ~H"""
710:     <div class="space-y-6">
711:       <div class="bg-violet-50 dark:bg-violet-900/20 border border-violet-200 dark:border-violet-800 rounded-xl p-4">
712:         <div class="flex items-start gap-3">
713:           <svg
714:             class="w-5 h-5 text-violet-600 dark:text-violet-400 mt-0.5"
715:             fill="none"
716:             stroke="currentColor"
717:             viewBox="0 0 24 24"
718:           >
719:             <path
720:               stroke-linecap="round"
721:               stroke-linejoin="round"
722:               stroke-width="2"
723:               d="M13 10V3L4 14h7v7l9-11h-7z"
724:             />
725:           </svg>
726:           <div>
727:             <h3 class="font-medium text-violet-900 dark:text-violet-200">Geração com IA</h3>
728:             <p class="mt-1 text-sm text-violet-700 dark:text-violet-300">
729:               Descreva o tema que você quer ensinar e a IA criará um planejamento completo.
730:             </p>
731:           </div>
732:         </div>
733:       </div>
734: 
735:       <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
736:         <form phx-submit="generate_from_topic" class="space-y-6">
737:           <div>
738:             <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
739:               Tema da Aula *
740:             </label>
741:             <textarea
742:               name="topic"
743:               rows="3"
744:               value={@topic}
745:               phx-change="update_topic"
746:               phx-debounce="300"
747:               placeholder="Descreva o tema que você quer ensinar. Ex: 'Introdução às frações com material concreto para alunos do 5º ano'"
748:               class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-teal-500"
749:               required
750:             ><%= @topic %></textarea>
751:           </div>
752: 
753:           <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
754:             <div>
755:               <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
756:                 Disciplina *
757:               </label>
758:               <select
759:                 name="subject"
760:                 class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
761:                 required
762:               >
763:                 <option value="">Selecione...</option>
764:                 <%= for subject <- Planning.subjects() do %>
765:                   <option value={subject}><%= Planning.subject_label(subject) %></option>
766:                 <% end %>
767:               </select>
768:             </div>
769: 
770:             <div>
771:               <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
772:                 Ano/Série *
773:               </label>
774:               <select
775:                 name="grade_level"
776:                 class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
777:                 required
778:               >
779:                 <option value="">Selecione...</option>
780:                 <%= for level <- Planning.grade_levels() do %>
781:                   <option value={level}><%= Planning.grade_level_label(level) %></option>
782:                 <% end %>
783:               </select>
784:             </div>
785:           </div>
786: 
787:           <div class="flex justify-end">
788:             <button
789:               type="submit"
790:               class="px-6 py-2 bg-violet-600 hover:bg-violet-700 text-white font-medium rounded-lg transition-colors"
791:             >
792:               <span class="inline-flex items-center gap-2">
793:                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
794:                   <path
795:                     stroke-linecap="round"
796:                     stroke-linejoin="round"
797:                     stroke-width="2"
798:                     d="M13 10V3L4 14h7v7l9-11h-7z"
799:                   />
800:                 </svg>
801:                 Gerar Planejamento
802:               </span>
803:             </button>
804:           </div>
805:         </form>
806:       </div>
807:     </div>
808:     """
809:   end
810: end
````

## File: lib/hellen_web/live/plannings_live/show.ex
````elixir
  1: defmodule HellenWeb.PlanningsLive.Show do
  2:   @moduledoc """
  3:   LiveView for viewing planning details.
  4:   """
  5: 
  6:   use HellenWeb, :live_view
  7: 
  8:   alias Hellen.Plannings
  9:   alias Hellen.Plannings.Planning
 10: 
 11:   @impl true
 12:   def mount(%{"id" => id}, _session, socket) do
 13:     planning = Plannings.get_planning!(id)
 14: 
 15:     {:ok,
 16:      socket
 17:      |> assign(:page_title, planning.title)
 18:      |> assign(:planning, planning)}
 19:   end
 20: 
 21:   @impl true
 22:   def handle_event("publish", _params, socket) do
 23:     case Plannings.publish_planning(socket.assigns.planning) do
 24:       {:ok, planning} ->
 25:         {:noreply,
 26:          socket
 27:          |> assign(:planning, planning)
 28:          |> put_flash(:info, "Planejamento publicado!")}
 29: 
 30:       {:error, _} ->
 31:         {:noreply, put_flash(socket, :error, "Erro ao publicar")}
 32:     end
 33:   end
 34: 
 35:   @impl true
 36:   def handle_event("archive", _params, socket) do
 37:     case Plannings.archive_planning(socket.assigns.planning) do
 38:       {:ok, planning} ->
 39:         {:noreply,
 40:          socket
 41:          |> assign(:planning, planning)
 42:          |> put_flash(:info, "Planejamento arquivado!")}
 43: 
 44:       {:error, _} ->
 45:         {:noreply, put_flash(socket, :error, "Erro ao arquivar")}
 46:     end
 47:   end
 48: 
 49:   @impl true
 50:   def render(assigns) do
 51:     ~H"""
 52:     <div class="min-h-screen bg-slate-50 dark:bg-slate-900">
 53:       <!-- Header -->
 54:       <div class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
 55:         <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
 56:           <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
 57:             <div class="flex items-start gap-4">
 58:               <.link
 59:                 navigate={~p"/plannings"}
 60:                 class="p-2 rounded-lg text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 mt-1"
 61:               >
 62:                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
 63:                   <path
 64:                     stroke-linecap="round"
 65:                     stroke-linejoin="round"
 66:                     stroke-width="2"
 67:                     d="M10 19l-7-7m0 0l7-7m-7 7h18"
 68:                   />
 69:                 </svg>
 70:               </.link>
 71:               <div>
 72:                 <div class="flex items-center gap-2">
 73:                   <.status_badge status={@planning.status} />
 74:                   <%= if @planning.generated_by_ai do %>
 75:                     <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-violet-100 dark:bg-violet-900/30 text-violet-600 dark:text-violet-400 rounded-full text-xs font-medium">
 76:                       <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
 77:                         <path
 78:                           stroke-linecap="round"
 79:                           stroke-linejoin="round"
 80:                           stroke-width="2"
 81:                           d="M13 10V3L4 14h7v7l9-11h-7z"
 82:                         />
 83:                       </svg>
 84:                       Gerado por IA
 85:                     </span>
 86:                   <% end %>
 87:                 </div>
 88:                 <h1 class="mt-2 text-2xl font-bold text-slate-900 dark:text-white">
 89:                   <%= @planning.title %>
 90:                 </h1>
 91:                 <div class="mt-2 flex flex-wrap items-center gap-3 text-sm text-slate-500 dark:text-slate-400">
 92:                   <span class="inline-flex items-center gap-1">
 93:                     <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
 94:                       <path
 95:                         stroke-linecap="round"
 96:                         stroke-linejoin="round"
 97:                         stroke-width="2"
 98:                         d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
 99:                       />
100:                     </svg>
101:                     <%= Planning.subject_label(@planning.subject) %>
102:                   </span>
103:                   <span class="inline-flex items-center gap-1">
104:                     <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
105:                       <path
106:                         stroke-linecap="round"
107:                         stroke-linejoin="round"
108:                         stroke-width="2"
109:                         d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"
110:                       />
111:                     </svg>
112:                     <%= Planning.grade_level_label(@planning.grade_level) %>
113:                   </span>
114:                   <%= if @planning.duration_minutes do %>
115:                     <span class="inline-flex items-center gap-1">
116:                       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
117:                         <path
118:                           stroke-linecap="round"
119:                           stroke-linejoin="round"
120:                           stroke-width="2"
121:                           d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
122:                         />
123:                       </svg>
124:                       <%= @planning.duration_minutes %> min
125:                     </span>
126:                   <% end %>
127:                 </div>
128:               </div>
129:             </div>
130: 
131:             <div class="flex items-center gap-2">
132:               <.link
133:                 navigate={~p"/plannings/#{@planning.id}/edit"}
134:                 class="inline-flex items-center gap-2 px-4 py-2 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"
135:               >
136:                 <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
137:                   <path
138:                     stroke-linecap="round"
139:                     stroke-linejoin="round"
140:                     stroke-width="2"
141:                     d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
142:                   />
143:                 </svg>
144:                 Editar
145:               </.link>
146:               <%= if @planning.status == "draft" do %>
147:                 <button
148:                   phx-click="publish"
149:                   class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg transition-colors"
150:                 >
151:                   <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
152:                     <path
153:                       stroke-linecap="round"
154:                       stroke-linejoin="round"
155:                       stroke-width="2"
156:                       d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
157:                     />
158:                   </svg>
159:                   Publicar
160:                 </button>
161:               <% end %>
162:             </div>
163:           </div>
164:         </div>
165:       </div>
166:       <!-- Content -->
167:       <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
168:         <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
169:           <!-- Main Content -->
170:           <div class="lg:col-span-2 space-y-6">
171:             <!-- Description -->
172:             <%= if @planning.description do %>
173:               <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
174:                 <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-3">
175:                   Descrição
176:                 </h2>
177:                 <p class="text-slate-600 dark:text-slate-300 whitespace-pre-wrap">
178:                   <%= @planning.description %>
179:                 </p>
180:               </div>
181:             <% end %>
182:             <!-- Objectives -->
183:             <%= if length(@planning.objectives || []) > 0 do %>
184:               <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
185:                 <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-3">
186:                   Objetivos de Aprendizagem
187:                 </h2>
188:                 <ul class="space-y-2">
189:                   <%= for objective <- @planning.objectives do %>
190:                     <li class="flex items-start gap-2 text-slate-600 dark:text-slate-300">
191:                       <svg
192:                         class="w-5 h-5 text-teal-500 mt-0.5 flex-shrink-0"
193:                         fill="none"
194:                         stroke="currentColor"
195:                         viewBox="0 0 24 24"
196:                       >
197:                         <path
198:                           stroke-linecap="round"
199:                           stroke-linejoin="round"
200:                           stroke-width="2"
201:                           d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
202:                         />
203:                       </svg>
204:                       <%= objective %>
205:                     </li>
206:                   <% end %>
207:                 </ul>
208:               </div>
209:             <% end %>
210:             <!-- Content Structure -->
211:             <%= if @planning.content && map_size(@planning.content) > 0 do %>
212:               <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
213:                 <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">
214:                   Estrutura da Aula
215:                 </h2>
216:                 <div class="space-y-4">
217:                   <%= if @planning.content["introduction"] do %>
218:                     <div class="p-4 bg-teal-50 dark:bg-teal-900/20 rounded-lg border border-teal-200 dark:border-teal-800">
219:                       <h3 class="font-medium text-teal-900 dark:text-teal-200 mb-2">
220:                         Introdução
221:                       </h3>
222:                       <p class="text-teal-800 dark:text-teal-300 text-sm">
223:                         <%= @planning.content["introduction"] %>
224:                       </p>
225:                     </div>
226:                   <% end %>
227: 
228:                   <%= if @planning.content["development"] do %>
229:                     <div>
230:                       <h3 class="font-medium text-slate-900 dark:text-white mb-3">
231:                         Desenvolvimento
232:                       </h3>
233:                       <div class="space-y-3">
234:                         <%= for step <- @planning.content["development"] || [] do %>
235:                           <div class="flex gap-4 p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
236:                             <div class="flex-shrink-0 w-8 h-8 bg-teal-600 text-white rounded-full flex items-center justify-center font-semibold text-sm">
237:                               <%= step["step"] %>
238:                             </div>
239:                             <div class="flex-1">
240:                               <p class="text-slate-700 dark:text-slate-200">
241:                                 <%= step["activity"] %>
242:                               </p>
243:                               <%= if step["duration_minutes"] do %>
244:                                 <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">
245:                                   <%= step["duration_minutes"] %> minutos
246:                                 </p>
247:                               <% end %>
248:                             </div>
249:                           </div>
250:                         <% end %>
251:                       </div>
252:                     </div>
253:                   <% end %>
254: 
255:                   <%= if @planning.content["closure"] do %>
256:                     <div class="p-4 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg border border-emerald-200 dark:border-emerald-800">
257:                       <h3 class="font-medium text-emerald-900 dark:text-emerald-200 mb-2">
258:                         Encerramento
259:                       </h3>
260:                       <p class="text-emerald-800 dark:text-emerald-300 text-sm">
261:                         <%= @planning.content["closure"] %>
262:                       </p>
263:                     </div>
264:                   <% end %>
265: 
266:                   <%= if @planning.content["homework"] && @planning.content["homework"] != "" do %>
267:                     <div class="p-4 bg-amber-50 dark:bg-amber-900/20 rounded-lg border border-amber-200 dark:border-amber-800">
268:                       <h3 class="font-medium text-amber-900 dark:text-amber-200 mb-2">
269:                         Tarefa de Casa
270:                       </h3>
271:                       <p class="text-amber-800 dark:text-amber-300 text-sm">
272:                         <%= @planning.content["homework"] %>
273:                       </p>
274:                     </div>
275:                   <% end %>
276:                 </div>
277:               </div>
278:             <% end %>
279:             <!-- Methodology -->
280:             <%= if @planning.methodology do %>
281:               <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
282:                 <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-3">
283:                   Metodologia
284:                 </h2>
285:                 <p class="text-slate-600 dark:text-slate-300 whitespace-pre-wrap">
286:                   <%= @planning.methodology %>
287:                 </p>
288:               </div>
289:             <% end %>
290:             <!-- Assessment -->
291:             <%= if @planning.assessment_criteria do %>
292:               <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
293:                 <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-3">
294:                   Critérios de Avaliação
295:                 </h2>
296:                 <p class="text-slate-600 dark:text-slate-300 whitespace-pre-wrap">
297:                   <%= @planning.assessment_criteria %>
298:                 </p>
299:               </div>
300:             <% end %>
301:           </div>
302:           <!-- Sidebar -->
303:           <div class="space-y-6">
304:             <!-- BNCC Codes -->
305:             <%= if length(@planning.bncc_codes || []) > 0 do %>
306:               <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
307:                 <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-3">
308:                   Códigos BNCC
309:                 </h2>
310:                 <div class="flex flex-wrap gap-2">
311:                   <%= for code <- @planning.bncc_codes do %>
312:                     <span class="px-3 py-1 bg-teal-100 dark:bg-teal-900/30 text-teal-700 dark:text-teal-300 rounded-full text-sm font-medium">
313:                       <%= code %>
314:                     </span>
315:                   <% end %>
316:                 </div>
317:               </div>
318:             <% end %>
319:             <!-- Materials -->
320:             <%= if length(@planning.materials || []) > 0 do %>
321:               <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
322:                 <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-3">
323:                   Materiais Necessários
324:                 </h2>
325:                 <ul class="space-y-2">
326:                   <%= for material <- @planning.materials do %>
327:                     <li class="flex items-center gap-2 text-slate-600 dark:text-slate-300 text-sm">
328:                       <svg
329:                         class="w-4 h-4 text-slate-400"
330:                         fill="none"
331:                         stroke="currentColor"
332:                         viewBox="0 0 24 24"
333:                       >
334:                         <path
335:                           stroke-linecap="round"
336:                           stroke-linejoin="round"
337:                           stroke-width="2"
338:                           d="M5 13l4 4L19 7"
339:                         />
340:                       </svg>
341:                       <%= material %>
342:                     </li>
343:                   <% end %>
344:                 </ul>
345:               </div>
346:             <% end %>
347:             <!-- Info -->
348:             <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
349:               <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-3">
350:                 Informações
351:               </h2>
352:               <dl class="space-y-3 text-sm">
353:                 <div class="flex justify-between">
354:                   <dt class="text-slate-500 dark:text-slate-400">Criado em</dt>
355:                   <dd class="text-slate-900 dark:text-white font-medium">
356:                     <%= Calendar.strftime(@planning.inserted_at, "%d/%m/%Y às %H:%M") %>
357:                   </dd>
358:                 </div>
359:                 <div class="flex justify-between">
360:                   <dt class="text-slate-500 dark:text-slate-400">Atualizado em</dt>
361:                   <dd class="text-slate-900 dark:text-white font-medium">
362:                     <%= Calendar.strftime(@planning.updated_at, "%d/%m/%Y às %H:%M") %>
363:                   </dd>
364:                 </div>
365:                 <%= if @planning.source_lesson do %>
366:                   <div class="pt-3 border-t border-slate-200 dark:border-slate-700">
367:                     <dt class="text-slate-500 dark:text-slate-400 mb-1">Baseado na aula</dt>
368:                     <dd>
369:                       <.link
370:                         navigate={~p"/lessons/#{@planning.source_lesson.id}"}
371:                         class="text-teal-600 dark:text-teal-400 hover:underline font-medium"
372:                       >
373:                         <%= @planning.source_lesson.title %>
374:                       </.link>
375:                     </dd>
376:                   </div>
377:                 <% end %>
378:               </dl>
379:             </div>
380:             <!-- Actions -->
381:             <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
382:               <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-3">
383:                 Ações
384:               </h2>
385:               <div class="space-y-2">
386:                 <.link
387:                   navigate={~p"/assessments/new?planning_id=#{@planning.id}"}
388:                   class="flex items-center gap-2 w-full px-4 py-2 text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"
389:                 >
390:                   <svg
391:                     class="w-5 h-5 text-violet-500"
392:                     fill="none"
393:                     stroke="currentColor"
394:                     viewBox="0 0 24 24"
395:                   >
396:                     <path
397:                       stroke-linecap="round"
398:                       stroke-linejoin="round"
399:                       stroke-width="2"
400:                       d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
401:                     />
402:                   </svg>
403:                   Gerar Prova
404:                 </.link>
405:                 <button
406:                   onclick="window.print()"
407:                   class="flex items-center gap-2 w-full px-4 py-2 text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"
408:                 >
409:                   <svg
410:                     class="w-5 h-5 text-slate-400"
411:                     fill="none"
412:                     stroke="currentColor"
413:                     viewBox="0 0 24 24"
414:                   >
415:                     <path
416:                       stroke-linecap="round"
417:                       stroke-linejoin="round"
418:                       stroke-width="2"
419:                       d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"
420:                     />
421:                   </svg>
422:                   Imprimir
423:                 </button>
424:                 <%= if @planning.status != "archived" do %>
425:                   <button
426:                     phx-click="archive"
427:                     class="flex items-center gap-2 w-full px-4 py-2 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"
428:                   >
429:                     <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
430:                       <path
431:                         stroke-linecap="round"
432:                         stroke-linejoin="round"
433:                         stroke-width="2"
434:                         d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"
435:                       />
436:                     </svg>
437:                     Arquivar
438:                   </button>
439:                 <% end %>
440:               </div>
441:             </div>
442:           </div>
443:         </div>
444:       </div>
445:     </div>
446:     """
447:   end
448: 
449:   defp status_badge(assigns) do
450:     {bg, text} =
451:       case assigns.status do
452:         "draft" ->
453:           {"bg-amber-100 dark:bg-amber-900/30", "text-amber-700 dark:text-amber-400"}
454: 
455:         "published" ->
456:           {"bg-emerald-100 dark:bg-emerald-900/30", "text-emerald-700 dark:text-emerald-400"}
457: 
458:         "archived" ->
459:           {"bg-slate-100 dark:bg-slate-700", "text-slate-600 dark:text-slate-400"}
460: 
461:         _ ->
462:           {"bg-slate-100 dark:bg-slate-700", "text-slate-600 dark:text-slate-400"}
463:       end
464: 
465:     assigns = assign(assigns, :bg, bg)
466:     assigns = assign(assigns, :text, text)
467: 
468:     ~H"""
469:     <span class={"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium #{@bg} #{@text}"}>
470:       <%= Planning.status_label(@status) %>
471:     </span>
472:     """
473:   end
474: end
````

## File: lib/hellen_web/live/reports_live/index.ex
````elixir
  1: defmodule HellenWeb.ReportsLive.Index do
  2:   @moduledoc """
  3:   LiveView para pagina de relatorios do professor.
  4:   Oferece visualizacao de dados, analytics e exportacao PDF.
  5:   """
  6: 
  7:   use HellenWeb, :live_view
  8: 
  9:   import Ecto.Query, warn: false
 10: 
 11:   alias Hellen.Analysis.{Analysis, BnccMatch, BullyingAlert}
 12:   alias Hellen.Assessments.Assessment
 13:   alias Hellen.Lessons.Lesson
 14:   alias Hellen.Plannings.Planning
 15:   alias Hellen.Repo
 16: 
 17:   @impl true
 18:   def mount(_params, _session, socket) do
 19:     user = socket.assigns.current_user
 20:     current_date = Date.utc_today()
 21: 
 22:     # Default to current month
 23:     start_date = Date.beginning_of_month(current_date)
 24:     end_date = Date.end_of_month(current_date)
 25: 
 26:     socket =
 27:       socket
 28:       |> assign(:page_title, "Relatorios")
 29:       |> assign(:selected_period, "month")
 30:       |> assign(:start_date, start_date)
 31:       |> assign(:end_date, end_date)
 32:       |> assign(:selected_report, nil)
 33:       |> assign(:generating, false)
 34:       |> load_stats(user.id, start_date, end_date)
 35:       |> load_charts_data(user.id, start_date, end_date)
 36: 
 37:     {:ok, socket}
 38:   end
 39: 
 40:   @impl true
 41:   def handle_event("change_period", %{"period" => period}, socket) do
 42:     current_date = Date.utc_today()
 43: 
 44:     {start_date, end_date} =
 45:       case period do
 46:         "week" ->
 47:           start = Date.add(current_date, -7)
 48:           {start, current_date}
 49: 
 50:         "month" ->
 51:           {Date.beginning_of_month(current_date), Date.end_of_month(current_date)}
 52: 
 53:         "quarter" ->
 54:           start = Date.add(current_date, -90)
 55:           {start, current_date}
 56: 
 57:         "year" ->
 58:           start = Date.new!(current_date.year, 1, 1)
 59:           {start, current_date}
 60: 
 61:         "all" ->
 62:           {~D[2020-01-01], current_date}
 63: 
 64:         _ ->
 65:           {Date.beginning_of_month(current_date), Date.end_of_month(current_date)}
 66:       end
 67: 
 68:     user = socket.assigns.current_user
 69: 
 70:     socket =
 71:       socket
 72:       |> assign(:selected_period, period)
 73:       |> assign(:start_date, start_date)
 74:       |> assign(:end_date, end_date)
 75:       |> load_stats(user.id, start_date, end_date)
 76:       |> load_charts_data(user.id, start_date, end_date)
 77: 
 78:     {:noreply, socket}
 79:   end
 80: 
 81:   def handle_event("select_report", %{"type" => type}, socket) do
 82:     {:noreply, assign(socket, :selected_report, type)}
 83:   end
 84: 
 85:   def handle_event("clear_report", _params, socket) do
 86:     {:noreply, assign(socket, :selected_report, nil)}
 87:   end
 88: 
 89:   def handle_event("generate_pdf", %{"type" => type}, socket) do
 90:     {:noreply, assign(socket, :generating, true)}
 91: 
 92:     user_id = socket.assigns.current_user.id
 93:     start_date = socket.assigns.start_date
 94:     end_date = socket.assigns.end_date
 95: 
 96:     # Spawn async task to generate PDF
 97:     Task.start(fn ->
 98:       case generate_report(type, user_id, start_date, end_date) do
 99:         {:ok, _pdf} ->
100:           send(self(), {:pdf_generated, type})
101: 
102:         {:error, _reason} ->
103:           send(self(), {:pdf_error, type})
104:       end
105:     end)
106: 
107:     {:noreply, socket}
108:   end
109: 
110:   @impl true
111:   def handle_info({:pdf_generated, _type}, socket) do
112:     {:noreply,
113:      socket
114:      |> assign(:generating, false)
115:      |> put_flash(:info, "Relatorio gerado com sucesso!")}
116:   end
117: 
118:   def handle_info({:pdf_error, _type}, socket) do
119:     {:noreply,
120:      socket
121:      |> assign(:generating, false)
122:      |> put_flash(:error, "Erro ao gerar relatorio. Tente novamente.")}
123:   end
124: 
125:   # ============================================
126:   # Private Functions - Data Loading
127:   # ============================================
128: 
129:   defp load_stats(socket, user_id, start_date, end_date) do
130:     start_dt = DateTime.new!(start_date, ~T[00:00:00], "Etc/UTC")
131:     end_dt = DateTime.new!(Date.add(end_date, 1), ~T[00:00:00], "Etc/UTC")
132: 
133:     # Lessons stats
134:     lessons_count =
135:       Lesson
136:       |> where([l], l.user_id == ^user_id)
137:       |> where([l], l.inserted_at >= ^start_dt and l.inserted_at < ^end_dt)
138:       |> Repo.aggregate(:count)
139: 
140:     total_duration =
141:       Lesson
142:       |> where([l], l.user_id == ^user_id)
143:       |> where([l], l.inserted_at >= ^start_dt and l.inserted_at < ^end_dt)
144:       |> where([l], not is_nil(l.duration))
145:       |> Repo.aggregate(:sum, :duration) || 0
146: 
147:     # Analyses stats
148:     analyses_count =
149:       Analysis
150:       |> join(:inner, [a], l in assoc(a, :lesson))
151:       |> where([a, l], l.user_id == ^user_id)
152:       |> where([a], a.inserted_at >= ^start_dt and a.inserted_at < ^end_dt)
153:       |> Repo.aggregate(:count)
154: 
155:     avg_score =
156:       Analysis
157:       |> join(:inner, [a], l in assoc(a, :lesson))
158:       |> where([a, l], l.user_id == ^user_id)
159:       |> where([a], a.inserted_at >= ^start_dt and a.inserted_at < ^end_dt)
160:       |> where([a], not is_nil(a.overall_score))
161:       |> Repo.aggregate(:avg, :overall_score)
162: 
163:     # BNCC matches count
164:     bncc_count =
165:       BnccMatch
166:       |> join(:inner, [m], a in assoc(m, :analysis))
167:       |> join(:inner, [m, a], l in assoc(a, :lesson))
168:       |> where([m, a, l], l.user_id == ^user_id)
169:       |> where([m, a], a.inserted_at >= ^start_dt and a.inserted_at < ^end_dt)
170:       |> Repo.aggregate(:count)
171: 
172:     # Bullying alerts
173:     alerts_count =
174:       BullyingAlert
175:       |> join(:inner, [b], a in assoc(b, :analysis))
176:       |> join(:inner, [b, a], l in assoc(a, :lesson))
177:       |> where([b, a, l], l.user_id == ^user_id)
178:       |> where([b], b.inserted_at >= ^start_dt and b.inserted_at < ^end_dt)
179:       |> Repo.aggregate(:count)
180: 
181:     # Plannings count
182:     plannings_count =
183:       Planning
184:       |> where([p], p.user_id == ^user_id)
185:       |> where([p], p.inserted_at >= ^start_dt and p.inserted_at < ^end_dt)
186:       |> Repo.aggregate(:count)
187: 
188:     # Assessments count
189:     assessments_count =
190:       Assessment
191:       |> where([a], a.user_id == ^user_id)
192:       |> where([a], a.inserted_at >= ^start_dt and a.inserted_at < ^end_dt)
193:       |> Repo.aggregate(:count)
194: 
195:     stats = %{
196:       lessons: lessons_count,
197:       duration_hours: Float.round(total_duration / 3600, 1),
198:       analyses: analyses_count,
199:       avg_score: avg_score && Float.round(avg_score, 1),
200:       bncc_matches: bncc_count,
201:       alerts: alerts_count,
202:       plannings: plannings_count,
203:       assessments: assessments_count
204:     }
205: 
206:     assign(socket, :stats, stats)
207:   end
208: 
209:   defp load_charts_data(socket, user_id, start_date, end_date) do
210:     start_dt = DateTime.new!(start_date, ~T[00:00:00], "Etc/UTC")
211:     end_dt = DateTime.new!(Date.add(end_date, 1), ~T[00:00:00], "Etc/UTC")
212: 
213:     # Score evolution data
214:     score_data =
215:       Analysis
216:       |> join(:inner, [a], l in assoc(a, :lesson))
217:       |> where([a, l], l.user_id == ^user_id)
218:       |> where([a], a.inserted_at >= ^start_dt and a.inserted_at < ^end_dt)
219:       |> where([a], not is_nil(a.overall_score))
220:       |> order_by([a], asc: a.inserted_at)
221:       |> select([a, l], %{
222:         date: a.inserted_at,
223:         score: a.overall_score,
224:         title: l.title
225:       })
226:       |> Repo.all()
227: 
228:     # BNCC coverage data
229:     bncc_data =
230:       BnccMatch
231:       |> join(:inner, [m], a in assoc(m, :analysis))
232:       |> join(:inner, [m, a], l in assoc(a, :lesson))
233:       |> where([m, a, l], l.user_id == ^user_id)
234:       |> where([m, a], a.inserted_at >= ^start_dt and a.inserted_at < ^end_dt)
235:       |> group_by([m], [m.competencia_code, m.competencia_name])
236:       |> select([m], %{
237:         code: m.competencia_code,
238:         name: m.competencia_name,
239:         count: count(m.id),
240:         avg_score: avg(m.match_score)
241:       })
242:       |> order_by([m], desc: count(m.id))
243:       |> limit(10)
244:       |> Repo.all()
245:       |> Enum.map(fn row ->
246:         %{row | avg_score: row.avg_score && Float.round(row.avg_score, 2)}
247:       end)
248: 
249:     # Lessons by subject
250:     lessons_by_subject =
251:       Lesson
252:       |> where([l], l.user_id == ^user_id)
253:       |> where([l], l.inserted_at >= ^start_dt and l.inserted_at < ^end_dt)
254:       |> where([l], not is_nil(l.disciplina))
255:       |> group_by([l], l.disciplina)
256:       |> select([l], %{
257:         subject: l.disciplina,
258:         count: count(l.id)
259:       })
260:       |> order_by([l], desc: count(l.id))
261:       |> Repo.all()
262: 
263:     # Lessons by status
264:     lessons_by_status =
265:       Lesson
266:       |> where([l], l.user_id == ^user_id)
267:       |> where([l], l.inserted_at >= ^start_dt and l.inserted_at < ^end_dt)
268:       |> group_by([l], l.status)
269:       |> select([l], %{
270:         status: l.status,
271:         count: count(l.id)
272:       })
273:       |> Repo.all()
274: 
275:     # Recent activity (last 10 items)
276:     recent_lessons =
277:       Lesson
278:       |> where([l], l.user_id == ^user_id)
279:       |> order_by([l], desc: l.inserted_at)
280:       |> limit(5)
281:       |> preload(:analyses)
282:       |> Repo.all()
283:       |> Enum.map(fn lesson ->
284:         latest_analysis = Enum.max_by(lesson.analyses, & &1.inserted_at, fn -> nil end)
285: 
286:         %{
287:           type: :lesson,
288:           title: lesson.title || "Aula sem titulo",
289:           date: lesson.inserted_at,
290:           status: lesson.status,
291:           score: latest_analysis && latest_analysis.overall_score
292:         }
293:       end)
294: 
295:     socket
296:     |> assign(:score_data, score_data)
297:     |> assign(:bncc_data, bncc_data)
298:     |> assign(:lessons_by_subject, lessons_by_subject)
299:     |> assign(:lessons_by_status, lessons_by_status)
300:     |> assign(:recent_activity, recent_lessons)
301:   end
302: 
303:   defp generate_report(type, user_id, start_date, _end_date) do
304:     opts = [
305:       month: start_date.month,
306:       year: start_date.year
307:     ]
308: 
309:     case type do
310:       "performance" ->
311:         Hellen.Reports.generate_teacher_report(user_id, opts)
312: 
313:       "bncc" ->
314:         # Future: implement BNCC-specific report
315:         {:error, :not_implemented}
316: 
317:       "detailed" ->
318:         Hellen.Reports.generate_teacher_report(user_id, opts)
319: 
320:       _ ->
321:         {:error, :invalid_type}
322:     end
323:   end
324: 
325:   # ============================================
326:   # Render
327:   # ============================================
328: 
329:   @impl true
330:   def render(assigns) do
331:     ~H"""
332:     <div class="min-h-screen bg-slate-50 dark:bg-slate-900">
333:       <!-- Header -->
334:       <div class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
335:         <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
336:           <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
337:             <div>
338:               <h1 class="text-2xl font-bold text-slate-900 dark:text-white">
339:                 Relatorios & Analytics
340:               </h1>
341:               <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">
342:                 Acompanhe seu desempenho e gere relatorios detalhados
343:               </p>
344:             </div>
345:             <!-- Period Selector -->
346:             <div class="flex items-center gap-2">
347:               <span class="text-sm text-slate-500 dark:text-slate-400">Periodo:</span>
348:               <select
349:                 phx-change="change_period"
350:                 name="period"
351:                 class="rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500"
352:               >
353:                 <option value="week" selected={@selected_period == "week"}>Ultima semana</option>
354:                 <option value="month" selected={@selected_period == "month"}>Este mes</option>
355:                 <option value="quarter" selected={@selected_period == "quarter"}>
356:                   Ultimo trimestre
357:                 </option>
358:                 <option value="year" selected={@selected_period == "year"}>Este ano</option>
359:                 <option value="all" selected={@selected_period == "all"}>Todo periodo</option>
360:               </select>
361:             </div>
362:           </div>
363:         </div>
364:       </div>
365: 
366:       <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
367:         <!-- Stats Cards -->
368:         <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
369:           <.reports_stat_card
370:             label="Aulas"
371:             value={@stats.lessons}
372:             icon="hero-academic-cap"
373:             color="teal"
374:           />
375:           <.reports_stat_card
376:             label="Horas Gravadas"
377:             value={@stats.duration_hours}
378:             suffix="h"
379:             icon="hero-clock"
380:             color="violet"
381:           />
382:           <.reports_stat_card
383:             label="Score Medio"
384:             value={@stats.avg_score || "-"}
385:             suffix={if @stats.avg_score, do: "/10", else: ""}
386:             icon="hero-star"
387:             color="amber"
388:           />
389:           <.reports_stat_card
390:             label="Competencias BNCC"
391:             value={@stats.bncc_matches}
392:             icon="hero-bookmark"
393:             color="emerald"
394:           />
395:         </div>
396:         <!-- Secondary Stats -->
397:         <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
398:           <.mini_stat label="Analises" value={@stats.analyses} />
399:           <.mini_stat label="Alertas" value={@stats.alerts} color={if @stats.alerts > 0, do: "red"} />
400:           <.mini_stat label="Planejamentos" value={@stats.plannings} />
401:           <.mini_stat label="Avaliacoes" value={@stats.assessments} />
402:         </div>
403:         <!-- Charts Section -->
404:         <div class="grid lg:grid-cols-2 gap-6">
405:           <!-- Score Evolution -->
406:           <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
407:             <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">
408:               Evolucao do Score
409:             </h3>
410:             <%= if Enum.empty?(@score_data) do %>
411:               <div class="flex flex-col items-center justify-center py-12 text-slate-400">
412:                 <.icon name="hero-chart-bar" class="h-12 w-12 mb-3" />
413:                 <p>Sem dados de score no periodo</p>
414:               </div>
415:             <% else %>
416:               <div class="space-y-3">
417:                 <%= for item <- Enum.take(@score_data, 8) do %>
418:                   <div class="flex items-center gap-3">
419:                     <div class="w-24 text-xs text-slate-500 dark:text-slate-400 truncate">
420:                       <%= fmt_date(item.date) %>
421:                     </div>
422:                     <div class="flex-1 h-6 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
423:                       <div
424:                         class={[
425:                           "h-full rounded-full transition-all",
426:                           score_color(item.score)
427:                         ]}
428:                         style={"width: #{item.score * 10}%"}
429:                       >
430:                       </div>
431:                     </div>
432:                     <div class={[
433:                       "w-12 text-right text-sm font-semibold",
434:                       score_text_color(item.score)
435:                     ]}>
436:                       <%= Float.round(item.score, 1) %>
437:                     </div>
438:                   </div>
439:                 <% end %>
440:               </div>
441:             <% end %>
442:           </div>
443:           <!-- BNCC Coverage -->
444:           <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
445:             <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">
446:               Cobertura BNCC
447:             </h3>
448:             <%= if Enum.empty?(@bncc_data) do %>
449:               <div class="flex flex-col items-center justify-center py-12 text-slate-400">
450:                 <.icon name="hero-bookmark" class="h-12 w-12 mb-3" />
451:                 <p>Sem competencias identificadas no periodo</p>
452:               </div>
453:             <% else %>
454:               <div class="space-y-3">
455:                 <%= for comp <- Enum.take(@bncc_data, 6) do %>
456:                   <div class="group">
457:                     <div class="flex items-center justify-between mb-1">
458:                       <span class="text-xs font-medium text-teal-600 dark:text-teal-400">
459:                         <%= comp.code %>
460:                       </span>
461:                       <span class="text-xs text-slate-500 dark:text-slate-400">
462:                         <%= comp.count %> ocorrencias
463:                       </span>
464:                     </div>
465:                     <div class="h-2 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
466:                       <div
467:                         class="h-full bg-gradient-to-r from-teal-500 to-emerald-500 rounded-full"
468:                         style={"width: #{min(comp.count * 10, 100)}%"}
469:                       >
470:                       </div>
471:                     </div>
472:                     <p class="text-xs text-slate-500 dark:text-slate-400 mt-1 truncate group-hover:whitespace-normal">
473:                       <%= truncate(comp.name, 60) %>
474:                     </p>
475:                   </div>
476:                 <% end %>
477:               </div>
478:             <% end %>
479:           </div>
480:         </div>
481:         <!-- Distribution Charts -->
482:         <div class="grid lg:grid-cols-2 gap-6">
483:           <!-- By Subject -->
484:           <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
485:             <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">
486:               Aulas por Disciplina
487:             </h3>
488:             <%= if Enum.empty?(@lessons_by_subject) do %>
489:               <div class="flex flex-col items-center justify-center py-8 text-slate-400">
490:                 <.icon name="hero-squares-2x2" class="h-10 w-10 mb-2" />
491:                 <p class="text-sm">Sem dados de disciplina</p>
492:               </div>
493:             <% else %>
494:               <div class="space-y-3">
495:                 <%= for item <- @lessons_by_subject do %>
496:                   <div class="flex items-center gap-3">
497:                     <div class="w-32 text-sm text-slate-700 dark:text-slate-300 truncate">
498:                       <%= item.subject || "Nao definida" %>
499:                     </div>
500:                     <div class="flex-1 h-4 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
501:                       <div
502:                         class="h-full bg-gradient-to-r from-violet-500 to-purple-500 rounded-full"
503:                         style={"width: #{min(item.count * 20, 100)}%"}
504:                       >
505:                       </div>
506:                     </div>
507:                     <div class="w-8 text-right text-sm font-medium text-slate-700 dark:text-slate-300">
508:                       <%= item.count %>
509:                     </div>
510:                   </div>
511:                 <% end %>
512:               </div>
513:             <% end %>
514:           </div>
515:           <!-- By Status -->
516:           <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
517:             <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">
518:               Status das Aulas
519:             </h3>
520:             <%= if Enum.empty?(@lessons_by_status) do %>
521:               <div class="flex flex-col items-center justify-center py-8 text-slate-400">
522:                 <.icon name="hero-signal" class="h-10 w-10 mb-2" />
523:                 <p class="text-sm">Sem dados de status</p>
524:               </div>
525:             <% else %>
526:               <div class="grid grid-cols-2 gap-4">
527:                 <%= for item <- @lessons_by_status do %>
528:                   <div class={[
529:                     "p-4 rounded-xl text-center",
530:                     status_bg(item.status)
531:                   ]}>
532:                     <div class="text-2xl font-bold text-slate-900 dark:text-white">
533:                       <%= item.count %>
534:                     </div>
535:                     <div class="text-xs text-slate-500 dark:text-slate-400 capitalize">
536:                       <%= get_status_label(item.status) %>
537:                     </div>
538:                   </div>
539:                 <% end %>
540:               </div>
541:             <% end %>
542:           </div>
543:         </div>
544:         <!-- Recent Activity -->
545:         <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
546:           <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">
547:             Atividade Recente
548:           </h3>
549:           <%= if Enum.empty?(@recent_activity) do %>
550:             <div class="flex flex-col items-center justify-center py-8 text-slate-400">
551:               <.icon name="hero-clock" class="h-10 w-10 mb-2" />
552:               <p class="text-sm">Nenhuma atividade recente</p>
553:             </div>
554:           <% else %>
555:             <div class="divide-y divide-slate-100 dark:divide-slate-700">
556:               <%= for item <- @recent_activity do %>
557:                 <div class="flex items-center gap-4 py-3">
558:                   <div class={[
559:                     "w-10 h-10 rounded-lg flex items-center justify-center",
560:                     status_icon_bg(item.status)
561:                   ]}>
562:                     <.icon name="hero-academic-cap" class="h-5 w-5 text-white" />
563:                   </div>
564:                   <div class="flex-1 min-w-0">
565:                     <p class="text-sm font-medium text-slate-900 dark:text-white truncate">
566:                       <%= item.title %>
567:                     </p>
568:                     <p class="text-xs text-slate-500 dark:text-slate-400">
569:                       <%= fmt_datetime(item.date) %>
570:                     </p>
571:                   </div>
572:                   <div class="flex items-center gap-3">
573:                     <%= if item.score do %>
574:                       <span class={[
575:                         "px-2 py-1 text-xs font-semibold rounded-full",
576:                         score_badge_class(item.score)
577:                       ]}>
578:                         <%= Float.round(item.score, 1) %>
579:                       </span>
580:                     <% end %>
581:                     <span class={[
582:                       "px-2 py-1 text-xs font-medium rounded-full",
583:                       status_badge_class(item.status)
584:                     ]}>
585:                       <%= get_status_label(item.status) %>
586:                     </span>
587:                   </div>
588:                 </div>
589:               <% end %>
590:             </div>
591:           <% end %>
592:         </div>
593:         <!-- Export Section -->
594:         <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-6">
595:           <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-2">
596:             Exportar Relatorios
597:           </h3>
598:           <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">
599:             Gere relatorios em PDF para apresentacoes e documentacao
600:           </p>
601: 
602:           <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
603:             <!-- Performance Report -->
604:             <.report_card
605:               title="Relatorio de Performance"
606:               description="Resumo completo do periodo com scores, evolucao e estatisticas"
607:               icon="hero-chart-bar"
608:               color="teal"
609:               href={
610:                 ~p"/reports/download/teacher/#{@current_user.id}?month=#{@start_date.month}&year=#{@start_date.year}"
611:               }
612:             />
613:             <!-- BNCC Report -->
614:             <.report_card
615:               title="Cobertura BNCC"
616:               description="Detalhamento das competencias trabalhadas no periodo"
617:               icon="hero-bookmark"
618:               color="violet"
619:               disabled={true}
620:             />
621:             <!-- Detailed Report -->
622:             <.report_card
623:               title="Relatorio Detalhado"
624:               description="Todas as aulas e analises do periodo com detalhes completos"
625:               icon="hero-document-text"
626:               color="emerald"
627:               disabled={true}
628:             />
629:           </div>
630:         </div>
631:       </div>
632:     </div>
633:     """
634:   end
635: 
636:   # ============================================
637:   # Components
638:   # ============================================
639: 
640:   attr :label, :string, required: true
641:   attr :value, :any, required: true
642:   attr :suffix, :string, default: ""
643:   attr :icon, :string, required: true
644:   attr :color, :string, default: "slate"
645: 
646:   defp reports_stat_card(assigns) do
647:     ~H"""
648:     <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-5">
649:       <div class="flex items-start justify-between">
650:         <div>
651:           <p class="text-sm text-slate-500 dark:text-slate-400"><%= @label %></p>
652:           <p class="mt-1 text-2xl font-bold text-slate-900 dark:text-white">
653:             <%= @value %><span class="text-base font-normal text-slate-400"><%= @suffix %></span>
654:           </p>
655:         </div>
656:         <div class={[
657:           "p-2.5 rounded-xl",
658:           icon_bg(@color)
659:         ]}>
660:           <.icon name={@icon} class={"h-5 w-5 #{icon_color(@color)}"} />
661:         </div>
662:       </div>
663:     </div>
664:     """
665:   end
666: 
667:   attr :label, :string, required: true
668:   attr :value, :any, required: true
669:   attr :color, :string, default: nil
670: 
671:   defp mini_stat(assigns) do
672:     ~H"""
673:     <div class="bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 px-4 py-3 flex items-center justify-between">
674:       <span class="text-sm text-slate-500 dark:text-slate-400"><%= @label %></span>
675:       <span class={[
676:         "text-lg font-semibold",
677:         @color == "red" && "text-red-600 dark:text-red-400",
678:         @color != "red" && "text-slate-900 dark:text-white"
679:       ]}>
680:         <%= @value %>
681:       </span>
682:     </div>
683:     """
684:   end
685: 
686:   attr :title, :string, required: true
687:   attr :description, :string, required: true
688:   attr :icon, :string, required: true
689:   attr :color, :string, default: "slate"
690:   attr :href, :string, default: nil
691:   attr :disabled, :boolean, default: false
692: 
693:   defp report_card(assigns) do
694:     ~H"""
695:     <%= if @disabled do %>
696:       <div class="p-5 rounded-xl border-2 border-dashed border-slate-200 dark:border-slate-700 opacity-60">
697:         <div class="flex items-start gap-4">
698:           <div class={["p-2.5 rounded-xl", icon_bg(@color)]}>
699:             <.icon name={@icon} class={"h-5 w-5 #{icon_color(@color)}"} />
700:           </div>
701:           <div>
702:             <h4 class="font-medium text-slate-900 dark:text-white">
703:               <%= @title %>
704:               <span class="ml-2 text-xs font-normal text-slate-400">Em breve</span>
705:             </h4>
706:             <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">
707:               <%= @description %>
708:             </p>
709:           </div>
710:         </div>
711:       </div>
712:     <% else %>
713:       <a
714:         href={@href}
715:         target="_blank"
716:         class="group p-5 rounded-xl border border-slate-200 dark:border-slate-700 hover:border-teal-300 dark:hover:border-teal-600 hover:shadow-md transition-all"
717:       >
718:         <div class="flex items-start gap-4">
719:           <div class={[
720:             "p-2.5 rounded-xl transition-colors",
721:             icon_bg(@color),
722:             "group-hover:scale-105 transition-transform"
723:           ]}>
724:             <.icon name={@icon} class={"h-5 w-5 #{icon_color(@color)}"} />
725:           </div>
726:           <div>
727:             <h4 class="font-medium text-slate-900 dark:text-white group-hover:text-teal-600 dark:group-hover:text-teal-400 transition-colors">
728:               <%= @title %>
729:             </h4>
730:             <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">
731:               <%= @description %>
732:             </p>
733:           </div>
734:         </div>
735:         <div class="mt-4 flex items-center gap-2 text-sm font-medium text-teal-600 dark:text-teal-400">
736:           <.icon name="hero-document-arrow-down" class="h-4 w-4" /> Baixar PDF
737:         </div>
738:       </a>
739:     <% end %>
740:     """
741:   end
742: 
743:   # ============================================
744:   # Helpers
745:   # ============================================
746: 
747:   defp icon_bg("teal"), do: "bg-teal-100 dark:bg-teal-900/30"
748:   defp icon_bg("violet"), do: "bg-violet-100 dark:bg-violet-900/30"
749:   defp icon_bg("amber"), do: "bg-amber-100 dark:bg-amber-900/30"
750:   defp icon_bg("emerald"), do: "bg-emerald-100 dark:bg-emerald-900/30"
751:   defp icon_bg(_), do: "bg-slate-100 dark:bg-slate-700"
752: 
753:   defp icon_color("teal"), do: "text-teal-600 dark:text-teal-400"
754:   defp icon_color("violet"), do: "text-violet-600 dark:text-violet-400"
755:   defp icon_color("amber"), do: "text-amber-600 dark:text-amber-400"
756:   defp icon_color("emerald"), do: "text-emerald-600 dark:text-emerald-400"
757:   defp icon_color(_), do: "text-slate-600 dark:text-slate-400"
758: 
759:   defp score_color(score) when score >= 8, do: "bg-emerald-500"
760:   defp score_color(score) when score >= 6, do: "bg-amber-500"
761:   defp score_color(_), do: "bg-red-500"
762: 
763:   defp score_text_color(score) when score >= 8, do: "text-emerald-600 dark:text-emerald-400"
764:   defp score_text_color(score) when score >= 6, do: "text-amber-600 dark:text-amber-400"
765:   defp score_text_color(_), do: "text-red-600 dark:text-red-400"
766: 
767:   defp score_badge_class(score) when score >= 8,
768:     do: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400"
769: 
770:   defp score_badge_class(score) when score >= 6,
771:     do: "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400"
772: 
773:   defp score_badge_class(_),
774:     do: "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400"
775: 
776:   defp status_bg("completed"), do: "bg-emerald-50 dark:bg-emerald-900/20"
777:   defp status_bg("analyzing"), do: "bg-cyan-50 dark:bg-cyan-900/20"
778:   defp status_bg("transcribing"), do: "bg-blue-50 dark:bg-blue-900/20"
779:   defp status_bg("pending"), do: "bg-amber-50 dark:bg-amber-900/20"
780:   defp status_bg("failed"), do: "bg-red-50 dark:bg-red-900/20"
781:   defp status_bg(_), do: "bg-slate-50 dark:bg-slate-900/20"
782: 
783:   defp status_icon_bg("completed"), do: "bg-emerald-500"
784:   defp status_icon_bg("analyzing"), do: "bg-cyan-500"
785:   defp status_icon_bg("transcribing"), do: "bg-blue-500"
786:   defp status_icon_bg("pending"), do: "bg-amber-500"
787:   defp status_icon_bg("failed"), do: "bg-red-500"
788:   defp status_icon_bg(_), do: "bg-slate-500"
789: 
790:   defp status_badge_class("completed"),
791:     do: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400"
792: 
793:   defp status_badge_class("analyzing"),
794:     do: "bg-cyan-100 text-cyan-700 dark:bg-cyan-900/30 dark:text-cyan-400"
795: 
796:   defp status_badge_class("transcribing"),
797:     do: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400"
798: 
799:   defp status_badge_class("pending"),
800:     do: "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400"
801: 
802:   defp status_badge_class("failed"),
803:     do: "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400"
804: 
805:   defp status_badge_class(_),
806:     do: "bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300"
807: 
808:   defp get_status_label("completed"), do: "Concluida"
809:   defp get_status_label("analyzing"), do: "Analisando"
810:   defp get_status_label("transcribing"), do: "Transcrevendo"
811:   defp get_status_label("transcribed"), do: "Transcrita"
812:   defp get_status_label("pending"), do: "Pendente"
813:   defp get_status_label("failed"), do: "Falhou"
814:   defp get_status_label(other), do: other || "Desconhecido"
815: 
816:   defp truncate(nil, _max), do: ""
817:   defp truncate(string, max) when byte_size(string) <= max, do: string
818:   defp truncate(string, max), do: String.slice(string, 0, max) <> "..."
819: 
820:   defp fmt_date(%DateTime{} = dt) do
821:     Calendar.strftime(dt, "%d/%m")
822:   end
823: 
824:   defp fmt_date(_), do: "-"
825: 
826:   defp fmt_datetime(%DateTime{} = dt) do
827:     Calendar.strftime(dt, "%d/%m/%Y as %H:%M")
828:   end
829: 
830:   defp fmt_datetime(_), do: "-"
831: end
````

## File: lib/hellen_web/live/achievements_live.ex
````elixir
  1: defmodule HellenWeb.AchievementsLive do
  2:   @moduledoc """
  3:   LiveView for displaying user achievements and progress.
  4:   """
  5:   use HellenWeb, :live_view
  6: 
  7:   alias Hellen.Gamification
  8: 
  9:   @impl true
 10:   def mount(_params, _session, socket) do
 11:     user = socket.assigns.current_user
 12:     achievements = Gamification.get_user_achievement_progress(user.id)
 13:     level_progress = Gamification.get_level_progress(user)
 14:     unlocked_count = Gamification.count_user_achievements(user.id)
 15:     total_count = Gamification.total_achievements_count()
 16: 
 17:     {:ok,
 18:      socket
 19:      |> assign(page_title: "Conquistas")
 20:      |> assign(achievements: achievements)
 21:      |> assign(level_progress: level_progress)
 22:      |> assign(unlocked_count: unlocked_count)
 23:      |> assign(total_count: total_count)}
 24:   end
 25: 
 26:   @impl true
 27:   def render(assigns) do
 28:     ~H"""
 29:     <div class="space-y-6 lg:space-y-8">
 30:       <!-- Header with Level Progress -->
 31:       <div class="bg-gradient-to-br from-violet-600 via-purple-600 to-indigo-600 rounded-2xl p-6 sm:p-8 text-white relative overflow-hidden">
 32:         <!-- Background decoration -->
 33:         <div class="absolute inset-0 opacity-10">
 34:           <div class="absolute top-0 right-0 w-64 h-64 bg-white rounded-full blur-3xl"></div>
 35:           <div class="absolute bottom-0 left-0 w-48 h-48 bg-white rounded-full blur-2xl"></div>
 36:         </div>
 37: 
 38:         <div class="relative flex flex-col lg:flex-row items-start lg:items-center justify-between gap-6">
 39:           <div class="flex-1">
 40:             <div class="flex items-center gap-4 mb-4">
 41:               <div class="w-16 h-16 rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center">
 42:                 <span class="text-3xl font-bold"><%= @level_progress.level %></span>
 43:               </div>
 44:               <div>
 45:                 <p class="text-white/80 text-sm">Seu nivel</p>
 46:                 <h1 class="text-2xl font-bold">
 47:                   <%= level_title(@level_progress.level) %>
 48:                 </h1>
 49:               </div>
 50:             </div>
 51:             <!-- XP Progress Bar -->
 52:             <div class="max-w-md">
 53:               <div class="flex items-center justify-between mb-2 text-sm">
 54:                 <span class="text-white/80">Experiencia</span>
 55:                 <span class="font-medium">
 56:                   <%= @level_progress.current_xp %>/<%= @level_progress.xp_for_next_level %> XP
 57:                 </span>
 58:               </div>
 59:               <div class="h-3 bg-white/20 rounded-full overflow-hidden">
 60:                 <div
 61:                   class="h-full bg-gradient-to-r from-amber-400 to-orange-500 rounded-full transition-all duration-500"
 62:                   style={"width: #{@level_progress.progress_percent}%"}
 63:                 >
 64:                 </div>
 65:               </div>
 66:               <p class="text-xs text-white/60 mt-2">
 67:                 Faltam <%= @level_progress.xp_for_next_level - @level_progress.current_xp %> XP para o proximo nivel
 68:               </p>
 69:             </div>
 70:           </div>
 71:           <!-- Achievement Stats -->
 72:           <div class="flex items-center gap-6">
 73:             <div class="text-center">
 74:               <div class="text-4xl font-bold"><%= @unlocked_count %></div>
 75:               <p class="text-white/80 text-sm">Conquistas</p>
 76:             </div>
 77:             <div class="w-px h-12 bg-white/20"></div>
 78:             <div class="text-center">
 79:               <div class="text-4xl font-bold"><%= @total_count %></div>
 80:               <p class="text-white/80 text-sm">Total</p>
 81:             </div>
 82:           </div>
 83:         </div>
 84:       </div>
 85:       <!-- Achievement Grid -->
 86:       <div>
 87:         <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
 88:           <.icon name="hero-trophy" class="h-6 w-6 text-amber-500" /> Todas as Conquistas
 89:         </h2>
 90: 
 91:         <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
 92:           <.achievement_card :for={achievement <- @achievements} achievement={achievement} />
 93:         </div>
 94:       </div>
 95:     </div>
 96:     """
 97:   end
 98: 
 99:   defp achievement_card(assigns) do
100:     ~H"""
101:     <div class={[
102:       "relative rounded-2xl border p-5 transition-all duration-300",
103:       if(@achievement.unlocked,
104:         do: "bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700",
105:         else:
106:           "bg-slate-50 dark:bg-slate-800/50 border-slate-200/50 dark:border-slate-700/50 opacity-60"
107:       )
108:     ]}>
109:       <!-- Unlocked badge -->
110:       <div
111:         :if={@achievement.unlocked}
112:         class="absolute -top-2 -right-2 w-8 h-8 bg-emerald-500 rounded-full flex items-center justify-center shadow-lg"
113:       >
114:         <.icon name="hero-check" class="h-5 w-5 text-white" />
115:       </div>
116: 
117:       <div class="flex items-start gap-4">
118:         <!-- Icon -->
119:         <div class={[
120:           "w-14 h-14 rounded-xl flex items-center justify-center flex-shrink-0",
121:           achievement_bg(@achievement.definition.color),
122:           if(!@achievement.unlocked, do: "grayscale")
123:         ]}>
124:           <.icon
125:             name={@achievement.definition.icon}
126:             class={"h-7 w-7 #{achievement_text(@achievement.definition.color)}"}
127:           />
128:         </div>
129: 
130:         <div class="flex-1 min-w-0">
131:           <h3 class={[
132:             "font-semibold mb-1",
133:             if(@achievement.unlocked,
134:               do: "text-slate-900 dark:text-white",
135:               else: "text-slate-500 dark:text-slate-400"
136:             )
137:           ]}>
138:             <%= @achievement.definition.name %>
139:           </h3>
140:           <p class="text-sm text-slate-500 dark:text-slate-400 mb-2">
141:             <%= @achievement.definition.description %>
142:           </p>
143:           <!-- Progress bar for locked achievements -->
144:           <div :if={!@achievement.unlocked and @achievement.progress > 0} class="mt-3">
145:             <div class="flex items-center justify-between mb-1 text-xs text-slate-500 dark:text-slate-400">
146:               <span>Progresso</span>
147:               <span><%= @achievement.progress %>%</span>
148:             </div>
149:             <div class="h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
150:               <div
151:                 class="h-full bg-gradient-to-r from-teal-500 to-emerald-500 rounded-full"
152:                 style={"width: #{@achievement.progress}%"}
153:               >
154:               </div>
155:             </div>
156:           </div>
157:           <!-- XP reward -->
158:           <div class="flex items-center gap-1 mt-2 text-xs">
159:             <.icon name="hero-bolt" class="h-4 w-4 text-amber-500" />
160:             <span class="text-slate-500 dark:text-slate-400">
161:               +<%= @achievement.definition.xp %> XP
162:             </span>
163:           </div>
164:         </div>
165:       </div>
166:     </div>
167:     """
168:   end
169: 
170:   defp level_title(level) when level <= 2, do: "Iniciante"
171:   defp level_title(level) when level <= 5, do: "Professor Dedicado"
172:   defp level_title(level) when level <= 10, do: "Expert Pedagogico"
173:   defp level_title(level) when level <= 15, do: "Mestre Educador"
174:   defp level_title(_level), do: "Lenda da Educacao"
175: 
176:   defp achievement_bg("teal"), do: "bg-teal-100 dark:bg-teal-900/30"
177:   defp achievement_bg("emerald"), do: "bg-emerald-100 dark:bg-emerald-900/30"
178:   defp achievement_bg("amber"), do: "bg-amber-100 dark:bg-amber-900/30"
179:   defp achievement_bg("violet"), do: "bg-violet-100 dark:bg-violet-900/30"
180:   defp achievement_bg("purple"), do: "bg-purple-100 dark:bg-purple-900/30"
181:   defp achievement_bg("cyan"), do: "bg-cyan-100 dark:bg-cyan-900/30"
182:   defp achievement_bg("blue"), do: "bg-blue-100 dark:bg-blue-900/30"
183:   defp achievement_bg("orange"), do: "bg-orange-100 dark:bg-orange-900/30"
184:   defp achievement_bg("red"), do: "bg-red-100 dark:bg-red-900/30"
185:   defp achievement_bg(_), do: "bg-slate-100 dark:bg-slate-700"
186: 
187:   defp achievement_text("teal"), do: "text-teal-600 dark:text-teal-400"
188:   defp achievement_text("emerald"), do: "text-emerald-600 dark:text-emerald-400"
189:   defp achievement_text("amber"), do: "text-amber-600 dark:text-amber-400"
190:   defp achievement_text("violet"), do: "text-violet-600 dark:text-violet-400"
191:   defp achievement_text("purple"), do: "text-purple-600 dark:text-purple-400"
192:   defp achievement_text("cyan"), do: "text-cyan-600 dark:text-cyan-400"
193:   defp achievement_text("blue"), do: "text-blue-600 dark:text-blue-400"
194:   defp achievement_text("orange"), do: "text-orange-600 dark:text-orange-400"
195:   defp achievement_text("red"), do: "text-red-600 dark:text-red-400"
196:   defp achievement_text(_), do: "text-slate-600 dark:text-slate-400"
197: end
````

## File: lib/hellen_web/live/notification_bell_live.ex
````elixir
  1: defmodule HellenWeb.NotificationBellLive do
  2:   @moduledoc """
  3:   LiveView component for the notification bell in the sidebar.
  4:   Shows unread notification count and a dropdown with recent notifications.
  5:   Subscribes to PubSub for real-time updates.
  6:   """
  7:   use HellenWeb, :live_component
  8: 
  9:   alias Hellen.Notifications
 10: 
 11:   @impl true
 12:   def mount(socket) do
 13:     {:ok, assign(socket, open: false, notifications: [], unread_count: 0)}
 14:   end
 15: 
 16:   @impl true
 17:   def update(%{current_user: user} = assigns, socket) do
 18:     if connected?(socket) && user do
 19:       # Subscribe to user's notification channel
 20:       Phoenix.PubSub.subscribe(Hellen.PubSub, "user:#{user.id}:notifications")
 21: 
 22:       # Load initial data
 23:       notifications = Notifications.list_user_notifications(user.id, limit: 5)
 24:       unread_count = Notifications.count_unread(user.id)
 25: 
 26:       {:ok,
 27:        socket
 28:        |> assign(assigns)
 29:        |> assign(notifications: notifications)
 30:        |> assign(unread_count: unread_count)}
 31:     else
 32:       {:ok, assign(socket, assigns)}
 33:     end
 34:   end
 35: 
 36:   @impl true
 37:   def handle_event("toggle", _params, socket) do
 38:     {:noreply, assign(socket, open: !socket.assigns.open)}
 39:   end
 40: 
 41:   @impl true
 42:   def handle_event("close", _params, socket) do
 43:     {:noreply, assign(socket, open: false)}
 44:   end
 45: 
 46:   @impl true
 47:   def handle_event("mark_read", %{"id" => id}, socket) do
 48:     Notifications.mark_as_read(id)
 49: 
 50:     notifications =
 51:       Enum.map(socket.assigns.notifications, fn n ->
 52:         if n.id == id, do: %{n | read_at: DateTime.utc_now()}, else: n
 53:       end)
 54: 
 55:     unread_count = max(socket.assigns.unread_count - 1, 0)
 56: 
 57:     {:noreply,
 58:      socket
 59:      |> assign(notifications: notifications)
 60:      |> assign(unread_count: unread_count)}
 61:   end
 62: 
 63:   @impl true
 64:   def handle_event("mark_all_read", _params, socket) do
 65:     user = socket.assigns.current_user
 66:     Notifications.mark_all_as_read(user.id)
 67: 
 68:     notifications =
 69:       Enum.map(socket.assigns.notifications, fn n ->
 70:         %{n | read_at: DateTime.utc_now()}
 71:       end)
 72: 
 73:     {:noreply,
 74:      socket
 75:      |> assign(notifications: notifications)
 76:      |> assign(unread_count: 0)}
 77:   end
 78: 
 79:   # Handle new notification from PubSub
 80:   def handle_info({:new_notification, notification}, socket) do
 81:     notifications = [notification | Enum.take(socket.assigns.notifications, 4)]
 82:     unread_count = socket.assigns.unread_count + 1
 83: 
 84:     {:noreply,
 85:      socket
 86:      |> assign(notifications: notifications)
 87:      |> assign(unread_count: unread_count)}
 88:   end
 89: 
 90:   @impl true
 91:   def render(assigns) do
 92:     ~H"""
 93:     <div class="relative" id={"notification-bell-#{@id}"} phx-click-away="close" phx-target={@myself}>
 94:       <button
 95:         type="button"
 96:         phx-click="toggle"
 97:         phx-target={@myself}
 98:         class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors relative"
 99:         title="Notificacoes"
100:       >
101:         <.icon name="hero-bell" class="h-5 w-5 text-gray-500 dark:text-gray-400" />
102:         <span
103:           :if={@unread_count > 0}
104:           class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-white text-xs font-bold flex items-center justify-center"
105:         >
106:           <%= if @unread_count > 9, do: "9+", else: @unread_count %>
107:         </span>
108:       </button>
109: 
110:       <div
111:         :if={@open}
112:         class="absolute bottom-full left-0 mb-2 w-80 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-gray-200 dark:border-slate-700 overflow-hidden z-50"
113:       >
114:         <div class="flex items-center justify-between px-4 py-3 border-b border-gray-100 dark:border-slate-700">
115:           <h3 class="font-semibold text-gray-900 dark:text-white">Notificacoes</h3>
116:           <button
117:             :if={@unread_count > 0}
118:             type="button"
119:             phx-click="mark_all_read"
120:             phx-target={@myself}
121:             class="text-xs text-indigo-600 dark:text-indigo-400 hover:underline"
122:           >
123:             Marcar todas como lidas
124:           </button>
125:         </div>
126: 
127:         <div class="max-h-80 overflow-y-auto">
128:           <%= if Enum.empty?(@notifications) do %>
129:             <div class="p-6 text-center text-gray-500 dark:text-gray-400">
130:               <.icon name="hero-bell-slash" class="h-8 w-8 mx-auto mb-2 opacity-50" />
131:               <p class="text-sm">Nenhuma notificacao</p>
132:             </div>
133:           <% else %>
134:             <div class="divide-y divide-gray-100 dark:divide-slate-700">
135:               <%= for notification <- @notifications do %>
136:                 <.notification_item notification={notification} myself={@myself} />
137:               <% end %>
138:             </div>
139:           <% end %>
140:         </div>
141:       </div>
142:     </div>
143:     """
144:   end
145: 
146:   defp notification_item(assigns) do
147:     ~H"""
148:     <div
149:       class={[
150:         "px-4 py-3 hover:bg-gray-50 dark:hover:bg-slate-700/50 cursor-pointer transition-colors",
151:         is_nil(@notification.read_at) && "bg-indigo-50/50 dark:bg-indigo-900/20"
152:       ]}
153:       phx-click="mark_read"
154:       phx-value-id={@notification.id}
155:       phx-target={@myself}
156:     >
157:       <div class="flex items-start gap-3">
158:         <div class={[
159:           "w-2 h-2 rounded-full mt-2 flex-shrink-0",
160:           notification_dot_color(@notification.type),
161:           !is_nil(@notification.read_at) && "opacity-30"
162:         ]}>
163:         </div>
164:         <div class="flex-1 min-w-0">
165:           <p class={[
166:             "text-sm font-medium truncate",
167:             is_nil(@notification.read_at) && "text-gray-900 dark:text-white",
168:             !is_nil(@notification.read_at) && "text-gray-500 dark:text-gray-400"
169:           ]}>
170:             <%= @notification.title %>
171:           </p>
172:           <p class="text-xs text-gray-500 dark:text-gray-400 line-clamp-2">
173:             <%= @notification.message %>
174:           </p>
175:           <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
176:             <%= relative_time(@notification.inserted_at) %>
177:           </p>
178:         </div>
179:       </div>
180:     </div>
181:     """
182:   end
183: 
184:   defp notification_dot_color("alert_critical"), do: "bg-red-500"
185:   defp notification_dot_color("alert_high"), do: "bg-orange-500"
186:   defp notification_dot_color("alert_medium"), do: "bg-yellow-500"
187:   defp notification_dot_color("alert_low"), do: "bg-gray-500"
188:   defp notification_dot_color("analysis_complete"), do: "bg-green-500"
189:   defp notification_dot_color(_), do: "bg-indigo-500"
190: 
191:   defp relative_time(datetime) do
192:     now = DateTime.utc_now()
193:     diff = DateTime.diff(now, datetime, :second)
194: 
195:     cond do
196:       diff < 60 -> "agora"
197:       diff < 3600 -> "ha #{div(diff, 60)} min"
198:       diff < 86_400 -> "ha #{div(diff, 3600)} h"
199:       diff < 604_800 -> "ha #{div(diff, 86_400)} d"
200:       true -> Calendar.strftime(datetime, "%d/%m")
201:     end
202:   end
203: end
````

## File: lib/hellen_web/live/onboarding_live.ex
````elixir
  1: defmodule HellenWeb.OnboardingLive do
  2:   @moduledoc """
  3:   Onboarding wizard for new users.
  4:   Multi-step wizard to collect user preferences and introduce the platform.
  5:   """
  6:   use HellenWeb, :live_view
  7: 
  8:   alias Hellen.Accounts
  9: 
 10:   @subjects [
 11:     {"Portugues", "portugues"},
 12:     {"Matematica", "matematica"},
 13:     {"Historia", "historia"},
 14:     {"Geografia", "geografia"},
 15:     {"Ciencias", "ciencias"},
 16:     {"Biologia", "biologia"},
 17:     {"Fisica", "fisica"},
 18:     {"Quimica", "quimica"},
 19:     {"Ingles", "ingles"},
 20:     {"Artes", "artes"},
 21:     {"Educacao Fisica", "educacao_fisica"},
 22:     {"Filosofia", "filosofia"},
 23:     {"Sociologia", "sociologia"},
 24:     {"Outra", "outra"}
 25:   ]
 26: 
 27:   @grade_levels [
 28:     {"Educacao Infantil", "infantil"},
 29:     {"1o ao 5o ano (Fund. I)", "fundamental_1"},
 30:     {"6o ao 9o ano (Fund. II)", "fundamental_2"},
 31:     {"Ensino Medio", "medio"},
 32:     {"EJA", "eja"},
 33:     {"Ensino Superior", "superior"}
 34:   ]
 35: 
 36:   @impl true
 37:   def mount(_params, _session, socket) do
 38:     user = socket.assigns.current_user
 39: 
 40:     # If onboarding is already completed, redirect to dashboard
 41:     if user.onboarding_completed do
 42:       {:ok, push_navigate(socket, to: ~p"/dashboard")}
 43:     else
 44:       {:ok,
 45:        socket
 46:        |> assign(page_title: "Bem-vindo ao Hellen AI")
 47:        |> assign(step: user.onboarding_step || 0)
 48:        |> assign(subjects: @subjects)
 49:        |> assign(grade_levels: @grade_levels)
 50:        |> assign(selected_subject: user.subject)
 51:        |> assign(selected_grade: user.grade_level)
 52:        |> assign(saving: false)}
 53:     end
 54:   end
 55: 
 56:   @impl true
 57:   def handle_event("next_step", _params, socket) do
 58:     new_step = min(socket.assigns.step + 1, 3)
 59:     save_step(socket, new_step)
 60:   end
 61: 
 62:   def handle_event("prev_step", _params, socket) do
 63:     new_step = max(socket.assigns.step - 1, 0)
 64:     {:noreply, assign(socket, step: new_step)}
 65:   end
 66: 
 67:   def handle_event("select_subject", %{"subject" => subject}, socket) do
 68:     {:noreply, assign(socket, selected_subject: subject)}
 69:   end
 70: 
 71:   def handle_event("select_grade", %{"grade" => grade}, socket) do
 72:     {:noreply, assign(socket, selected_grade: grade)}
 73:   end
 74: 
 75:   def handle_event("complete_onboarding", _params, socket) do
 76:     user = socket.assigns.current_user
 77: 
 78:     attrs = %{
 79:       onboarding_completed: true,
 80:       onboarding_step: 3,
 81:       subject: socket.assigns.selected_subject,
 82:       grade_level: socket.assigns.selected_grade
 83:     }
 84: 
 85:     case Accounts.update_user_onboarding(user, attrs) do
 86:       {:ok, _user} ->
 87:         {:noreply,
 88:          socket
 89:          |> put_flash(:info, "Bem-vindo ao Hellen AI! Sua conta esta pronta.")
 90:          |> push_navigate(to: ~p"/dashboard")}
 91: 
 92:       {:error, _changeset} ->
 93:         {:noreply, put_flash(socket, :error, "Erro ao salvar. Tente novamente.")}
 94:     end
 95:   end
 96: 
 97:   def handle_event("skip_onboarding", _params, socket) do
 98:     user = socket.assigns.current_user
 99: 
100:     case Accounts.update_user_onboarding(user, %{onboarding_completed: true}) do
101:       {:ok, _user} ->
102:         {:noreply, push_navigate(socket, to: ~p"/dashboard")}
103: 
104:       {:error, _changeset} ->
105:         {:noreply, put_flash(socket, :error, "Erro ao salvar. Tente novamente.")}
106:     end
107:   end
108: 
109:   defp save_step(socket, new_step) do
110:     user = socket.assigns.current_user
111: 
112:     attrs =
113:       %{onboarding_step: new_step}
114:       |> maybe_add_subject(socket.assigns.selected_subject)
115:       |> maybe_add_grade(socket.assigns.selected_grade)
116: 
117:     case Accounts.update_user_onboarding(user, attrs) do
118:       {:ok, _user} ->
119:         {:noreply, assign(socket, step: new_step)}
120: 
121:       {:error, _changeset} ->
122:         {:noreply, assign(socket, step: new_step)}
123:     end
124:   end
125: 
126:   defp maybe_add_subject(attrs, nil), do: attrs
127:   defp maybe_add_subject(attrs, subject), do: Map.put(attrs, :subject, subject)
128: 
129:   defp maybe_add_grade(attrs, nil), do: attrs
130:   defp maybe_add_grade(attrs, grade), do: Map.put(attrs, :grade_level, grade)
131: 
132:   @impl true
133:   def render(assigns) do
134:     ~H"""
135:     <div class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-teal-50/30 dark:from-slate-900 dark:via-slate-900 dark:to-slate-800 flex items-center justify-center p-4">
136:       <div class="w-full max-w-2xl">
137:         <!-- Progress Bar -->
138:         <div class="mb-8">
139:           <div class="flex items-center justify-between mb-2">
140:             <span class="text-sm font-medium text-slate-600 dark:text-slate-400">
141:               Passo <%= @step + 1 %> de 4
142:             </span>
143:             <button
144:               phx-click="skip_onboarding"
145:               class="text-sm text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 transition-colors"
146:             >
147:               Pular configuracao
148:             </button>
149:           </div>
150:           <div class="h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
151:             <div
152:               class="h-full bg-gradient-to-r from-teal-500 to-emerald-500 rounded-full transition-all duration-500 ease-out"
153:               style={"width: #{(@step + 1) * 25}%"}
154:             >
155:             </div>
156:           </div>
157:         </div>
158:         <!-- Card Container -->
159:         <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-xl border border-slate-200/50 dark:border-slate-700/50 overflow-hidden">
160:           <!-- Step Content -->
161:           <div class="p-8 sm:p-10">
162:             <%= case @step do %>
163:               <% 0 -> %>
164:                 <.step_welcome name={@current_user.name} />
165:               <% 1 -> %>
166:                 <.step_subject subjects={@subjects} selected={@selected_subject} />
167:               <% 2 -> %>
168:                 <.step_grade grade_levels={@grade_levels} selected={@selected_grade} />
169:               <% 3 -> %>
170:                 <.step_tutorial />
171:             <% end %>
172:           </div>
173:           <!-- Navigation -->
174:           <div class="px-8 sm:px-10 pb-8 sm:pb-10 flex items-center justify-between">
175:             <button
176:               :if={@step > 0}
177:               phx-click="prev_step"
178:               class="inline-flex items-center gap-2 px-5 py-2.5 text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors"
179:             >
180:               <.icon name="hero-arrow-left" class="h-5 w-5" /> Voltar
181:             </button>
182:             <div :if={@step == 0}></div>
183: 
184:             <%= if @step < 3 do %>
185:               <button
186:                 phx-click="next_step"
187:                 class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-teal-600 to-emerald-600 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl hover:from-teal-500 hover:to-emerald-500 transition-all duration-200"
188:               >
189:                 Continuar <.icon name="hero-arrow-right" class="h-5 w-5" />
190:               </button>
191:             <% else %>
192:               <button
193:                 phx-click="complete_onboarding"
194:                 class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-teal-600 to-emerald-600 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl hover:from-teal-500 hover:to-emerald-500 transition-all duration-200"
195:               >
196:                 Comecar a usar <.icon name="hero-rocket-launch" class="h-5 w-5" />
197:               </button>
198:             <% end %>
199:           </div>
200:         </div>
201:       </div>
202:     </div>
203:     """
204:   end
205: 
206:   # Step Components
207: 
208:   defp step_welcome(assigns) do
209:     ~H"""
210:     <div class="text-center">
211:       <!-- Animated Icon -->
212:       <div class="relative mx-auto w-24 h-24 mb-8">
213:         <div class="absolute inset-0 bg-gradient-to-br from-teal-400 to-emerald-500 rounded-3xl rotate-6 opacity-20">
214:         </div>
215:         <div class="relative w-full h-full bg-gradient-to-br from-teal-500 to-emerald-600 rounded-3xl flex items-center justify-center shadow-xl">
216:           <.icon name="hero-sparkles" class="h-12 w-12 text-white" />
217:         </div>
218:       </div>
219: 
220:       <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 dark:text-white mb-4">
221:         Ola, <%= @name || "Professor" %>!
222:       </h1>
223:       <p class="text-lg text-slate-600 dark:text-slate-400 mb-8 max-w-md mx-auto">
224:         Bem-vindo ao <span class="font-semibold text-teal-600 dark:text-teal-400">Hellen AI</span>,
225:         sua assistente pedagogica com inteligencia artificial.
226:       </p>
227:       <!-- Features Preview -->
228:       <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-left">
229:         <div class="p-4 rounded-2xl bg-slate-50 dark:bg-slate-700/50">
230:           <div class="w-10 h-10 rounded-xl bg-teal-100 dark:bg-teal-900/50 flex items-center justify-center mb-3">
231:             <.icon name="hero-microphone" class="h-5 w-5 text-teal-600 dark:text-teal-400" />
232:           </div>
233:           <h3 class="font-semibold text-slate-900 dark:text-white text-sm mb-1">
234:             Transcricao Automatica
235:           </h3>
236:           <p class="text-xs text-slate-500 dark:text-slate-400">
237:             Converta audio em texto em minutos
238:           </p>
239:         </div>
240:         <div class="p-4 rounded-2xl bg-slate-50 dark:bg-slate-700/50">
241:           <div class="w-10 h-10 rounded-xl bg-emerald-100 dark:bg-emerald-900/50 flex items-center justify-center mb-3">
242:             <.icon name="hero-document-check" class="h-5 w-5 text-emerald-600 dark:text-emerald-400" />
243:           </div>
244:           <h3 class="font-semibold text-slate-900 dark:text-white text-sm mb-1">
245:             Analise BNCC
246:           </h3>
247:           <p class="text-xs text-slate-500 dark:text-slate-400">
248:             Alinhamento automatico com competencias
249:           </p>
250:         </div>
251:         <div class="p-4 rounded-2xl bg-slate-50 dark:bg-slate-700/50">
252:           <div class="w-10 h-10 rounded-xl bg-violet-100 dark:bg-violet-900/50 flex items-center justify-center mb-3">
253:             <.icon name="hero-shield-check" class="h-5 w-5 text-violet-600 dark:text-violet-400" />
254:           </div>
255:           <h3 class="font-semibold text-slate-900 dark:text-white text-sm mb-1">
256:             Deteccao de Bullying
257:           </h3>
258:           <p class="text-xs text-slate-500 dark:text-slate-400">
259:             Ambiente escolar mais seguro
260:           </p>
261:         </div>
262:       </div>
263:     </div>
264:     """
265:   end
266: 
267:   defp step_subject(assigns) do
268:     ~H"""
269:     <div>
270:       <div class="text-center mb-8">
271:         <div class="w-16 h-16 mx-auto rounded-2xl bg-gradient-to-br from-teal-100 to-emerald-100 dark:from-teal-900/30 dark:to-emerald-900/30 flex items-center justify-center mb-4">
272:           <.icon name="hero-academic-cap" class="h-8 w-8 text-teal-600 dark:text-teal-400" />
273:         </div>
274:         <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-2">
275:           Qual e sua disciplina principal?
276:         </h2>
277:         <p class="text-slate-600 dark:text-slate-400">
278:           Isso nos ajuda a personalizar suas analises
279:         </p>
280:       </div>
281: 
282:       <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
283:         <button
284:           :for={{label, value} <- @subjects}
285:           phx-click="select_subject"
286:           phx-value-subject={value}
287:           class={[
288:             "p-4 rounded-xl border-2 text-left transition-all duration-200",
289:             if(@selected == value,
290:               do: "border-teal-500 bg-teal-50 dark:bg-teal-900/30 ring-2 ring-teal-500/20",
291:               else:
292:                 "border-slate-200 dark:border-slate-600 hover:border-slate-300 dark:hover:border-slate-500 hover:bg-slate-50 dark:hover:bg-slate-700/50"
293:             )
294:           ]}
295:         >
296:           <span class={[
297:             "font-medium text-sm",
298:             if(@selected == value,
299:               do: "text-teal-700 dark:text-teal-300",
300:               else: "text-slate-700 dark:text-slate-300"
301:             )
302:           ]}>
303:             <%= label %>
304:           </span>
305:         </button>
306:       </div>
307:     </div>
308:     """
309:   end
310: 
311:   defp step_grade(assigns) do
312:     ~H"""
313:     <div>
314:       <div class="text-center mb-8">
315:         <div class="w-16 h-16 mx-auto rounded-2xl bg-gradient-to-br from-emerald-100 to-cyan-100 dark:from-emerald-900/30 dark:to-cyan-900/30 flex items-center justify-center mb-4">
316:           <.icon name="hero-user-group" class="h-8 w-8 text-emerald-600 dark:text-emerald-400" />
317:         </div>
318:         <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-2">
319:           Para qual nivel voce leciona?
320:         </h2>
321:         <p class="text-slate-600 dark:text-slate-400">
322:           Ajustamos a analise para sua realidade
323:         </p>
324:       </div>
325: 
326:       <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
327:         <button
328:           :for={{label, value} <- @grade_levels}
329:           phx-click="select_grade"
330:           phx-value-grade={value}
331:           class={[
332:             "p-5 rounded-xl border-2 text-left transition-all duration-200",
333:             if(@selected == value,
334:               do:
335:                 "border-emerald-500 bg-emerald-50 dark:bg-emerald-900/30 ring-2 ring-emerald-500/20",
336:               else:
337:                 "border-slate-200 dark:border-slate-600 hover:border-slate-300 dark:hover:border-slate-500 hover:bg-slate-50 dark:hover:bg-slate-700/50"
338:             )
339:           ]}
340:         >
341:           <span class={[
342:             "font-medium",
343:             if(@selected == value,
344:               do: "text-emerald-700 dark:text-emerald-300",
345:               else: "text-slate-700 dark:text-slate-300"
346:             )
347:           ]}>
348:             <%= label %>
349:           </span>
350:         </button>
351:       </div>
352:     </div>
353:     """
354:   end
355: 
356:   defp step_tutorial(assigns) do
357:     ~H"""
358:     <div>
359:       <div class="text-center mb-8">
360:         <div class="w-16 h-16 mx-auto rounded-2xl bg-gradient-to-br from-violet-100 to-purple-100 dark:from-violet-900/30 dark:to-purple-900/30 flex items-center justify-center mb-4">
361:           <.icon name="hero-rocket-launch" class="h-8 w-8 text-violet-600 dark:text-violet-400" />
362:         </div>
363:         <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-2">
364:           Tudo pronto!
365:         </h2>
366:         <p class="text-slate-600 dark:text-slate-400">
367:           Veja como e facil usar o Hellen AI
368:         </p>
369:       </div>
370:       <!-- Quick Tutorial Steps -->
371:       <div class="space-y-4">
372:         <div class="flex items-start gap-4 p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50">
373:           <div class="w-8 h-8 rounded-full bg-teal-600 text-white flex items-center justify-center flex-shrink-0 font-bold text-sm">
374:             1
375:           </div>
376:           <div>
377:             <h3 class="font-semibold text-slate-900 dark:text-white mb-1">
378:               Envie sua aula
379:             </h3>
380:             <p class="text-sm text-slate-600 dark:text-slate-400">
381:               Faca upload de um arquivo de audio (MP3, WAV, M4A) ou grave diretamente.
382:             </p>
383:           </div>
384:         </div>
385: 
386:         <div class="flex items-start gap-4 p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50">
387:           <div class="w-8 h-8 rounded-full bg-emerald-600 text-white flex items-center justify-center flex-shrink-0 font-bold text-sm">
388:             2
389:           </div>
390:           <div>
391:             <h3 class="font-semibold text-slate-900 dark:text-white mb-1">
392:               Aguarde a analise
393:             </h3>
394:             <p class="text-sm text-slate-600 dark:text-slate-400">
395:               Nossa IA transcreve e analisa sua aula em poucos minutos.
396:             </p>
397:           </div>
398:         </div>
399: 
400:         <div class="flex items-start gap-4 p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50">
401:           <div class="w-8 h-8 rounded-full bg-violet-600 text-white flex items-center justify-center flex-shrink-0 font-bold text-sm">
402:             3
403:           </div>
404:           <div>
405:             <h3 class="font-semibold text-slate-900 dark:text-white mb-1">
406:               Receba insights
407:             </h3>
408:             <p class="text-sm text-slate-600 dark:text-slate-400">
409:               Veja competencias BNCC, alertas de bullying e recomendacoes pedagogicas.
410:             </p>
411:           </div>
412:         </div>
413:       </div>
414:       <!-- Bonus -->
415:       <div class="mt-6 p-4 rounded-xl bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 border border-amber-200/50 dark:border-amber-800/50">
416:         <div class="flex items-center gap-3">
417:           <div class="w-10 h-10 rounded-xl bg-amber-100 dark:bg-amber-900/50 flex items-center justify-center flex-shrink-0">
418:             <.icon name="hero-gift" class="h-5 w-5 text-amber-600 dark:text-amber-400" />
419:           </div>
420:           <div>
421:             <p class="font-semibold text-amber-800 dark:text-amber-200">
422:               Voce ganhou 2 creditos de boas-vindas!
423:             </p>
424:             <p class="text-sm text-amber-700 dark:text-amber-300">
425:               Use para analisar suas primeiras aulas gratuitamente.
426:             </p>
427:           </div>
428:         </div>
429:       </div>
430:     </div>
431:     """
432:   end
433: end
````

## File: lib/hellen_web/plugs/authorize.ex
````elixir
 1: defmodule HellenWeb.Plugs.Authorize do
 2:   @moduledoc """
 3:   Authorization plugs for role-based access control.
 4:   """
 5:   import Plug.Conn
 6:   import Phoenix.Controller
 7: 
 8:   @doc """
 9:   Requires the current user to have coordinator or admin role.
10:   Returns 403 Forbidden if not authorized.
11:   """
12:   def require_coordinator(conn, _opts) do
13:     case conn.assigns[:current_user] do
14:       %{role: role} when role in ["coordinator", "admin"] ->
15:         conn
16: 
17:       _ ->
18:         conn
19:         |> put_status(:forbidden)
20:         |> json(%{error: "Forbidden", message: "Coordinator access required"})
21:         |> halt()
22:     end
23:   end
24: 
25:   @doc """
26:   Requires the current user to have admin role.
27:   Returns 403 Forbidden if not authorized.
28:   """
29:   def require_admin(conn, _opts) do
30:     case conn.assigns[:current_user] do
31:       %{role: "admin"} ->
32:         conn
33: 
34:       _ ->
35:         conn
36:         |> put_status(:forbidden)
37:         |> json(%{error: "Forbidden", message: "Admin access required"})
38:         |> halt()
39:     end
40:   end
41: 
42:   @doc """
43:   Verifies that the current user belongs to the specified institution.
44:   Expects :institution_id to be in conn.params or conn.path_params.
45:   """
46:   def verify_institution(conn, _opts) do
47:     user = conn.assigns[:current_user]
48:     institution_id = conn.params["institution_id"] || conn.path_params["institution_id"]
49: 
50:     cond do
51:       is_nil(user) ->
52:         conn
53:         |> put_status(:unauthorized)
54:         |> json(%{error: "Unauthorized"})
55:         |> halt()
56: 
57:       is_nil(institution_id) ->
58:         conn
59: 
60:       user.institution_id == institution_id ->
61:         conn
62: 
63:       user.role == "admin" ->
64:         # Admins can access any institution
65:         conn
66: 
67:       true ->
68:         conn
69:         |> put_status(:forbidden)
70:         |> json(%{error: "Forbidden", message: "Access denied to this institution"})
71:         |> halt()
72:     end
73:   end
74: end
````

## File: lib/hellen_web/plugs/stripe_webhook_plug.ex
````elixir
 1: defmodule HellenWeb.Plugs.StripeWebhookPlug do
 2:   @moduledoc """
 3:   Plug to capture raw request body for Stripe webhook signature verification.
 4:   """
 5: 
 6:   import Plug.Conn
 7: 
 8:   @behaviour Plug
 9: 
10:   @impl true
11:   def init(opts), do: opts
12: 
13:   @impl true
14:   def call(conn, _opts) do
15:     case read_body(conn) do
16:       {:ok, body, conn} ->
17:         assign(conn, :raw_body, body)
18: 
19:       {:more, _partial, conn} ->
20:         assign(conn, :raw_body, "")
21: 
22:       {:error, _reason} ->
23:         assign(conn, :raw_body, "")
24:     end
25:   end
26: end
````

## File: lib/hellen_web/plugs/tenant.ex
````elixir
 1: defmodule HellenWeb.Plugs.Tenant do
 2:   @moduledoc """
 3:   Plug that extracts and assigns the current institution from the authenticated user.
 4:   This enables multi-tenancy by scoping data access to the user's institution.
 5:   """
 6:   import Plug.Conn
 7: 
 8:   def init(opts), do: opts
 9: 
10:   def call(conn, _opts) do
11:     case conn.assigns[:current_user] do
12:       %{institution_id: institution_id} when not is_nil(institution_id) ->
13:         conn
14:         |> assign(:current_institution_id, institution_id)
15:         |> put_private(:institution_id, institution_id)
16: 
17:       _ ->
18:         conn
19:     end
20:   end
21: end
````

## File: lib/hellen_web/gettext.ex
````elixir
1: defmodule HellenWeb.Gettext do
2:   @moduledoc """
3:   A module providing Internationalization with a gettext-based API.
4:   """
5:   use Gettext.Backend, otp_app: :hellen
6: end
````

## File: lib/hellen.ex
````elixir
1: defmodule Hellen do
2:   @moduledoc """
3:   Hellen - AI-powered lesson analysis platform.
4: 
5:   Transcribes recorded lessons and provides pedagogical feedback
6:   based on BNCC and Lei 13.185 (Anti-bullying).
7:   """
8: end
````

## File: priv/repo/migrations/20241201000000_add_oban_jobs_table.exs
````elixir
 1: defmodule Hellen.Repo.Migrations.AddObanJobsTable do
 2:   use Ecto.Migration
 3: 
 4:   def up do
 5:     Oban.Migration.up(version: 12)
 6:   end
 7: 
 8:   def down do
 9:     Oban.Migration.down(version: 1)
10:   end
11: end
````

## File: priv/repo/migrations/20241201000001_create_institutions.exs
````elixir
 1: defmodule Hellen.Repo.Migrations.CreateInstitutions do
 2:   use Ecto.Migration
 3: 
 4:   def change do
 5:     create table(:institutions, primary_key: false) do
 6:       add :id, :binary_id, primary_key: true
 7:       add :name, :string, null: false
 8:       add :plan, :string, default: "free"
 9:       add :settings, :map, default: %{}
10: 
11:       timestamps(type: :utc_datetime)
12:     end
13: 
14:     create index(:institutions, [:plan])
15:   end
16: end
````

## File: priv/repo/migrations/20241201000002_create_users.exs
````elixir
 1: defmodule Hellen.Repo.Migrations.CreateUsers do
 2:   use Ecto.Migration
 3: 
 4:   def change do
 5:     create table(:users, primary_key: false) do
 6:       add :id, :binary_id, primary_key: true
 7:       add :email, :string, null: false
 8:       add :name, :string, null: false
 9:       add :password_hash, :string
10:       add :role, :string, default: "teacher"
11:       add :credits, :integer, default: 2
12:       add :plan, :string, default: "free"
13:       add :institution_id, references(:institutions, on_delete: :nilify_all, type: :binary_id)
14: 
15:       timestamps(type: :utc_datetime)
16:     end
17: 
18:     create unique_index(:users, [:email])
19:     create index(:users, [:institution_id])
20:     create index(:users, [:role])
21:     create index(:users, [:plan])
22:   end
23: end
````

## File: priv/repo/migrations/20241201000003_create_lessons.exs
````elixir
 1: defmodule Hellen.Repo.Migrations.CreateLessons do
 2:   use Ecto.Migration
 3: 
 4:   def change do
 5:     create table(:lessons, primary_key: false) do
 6:       add :id, :binary_id, primary_key: true
 7:       add :title, :string, null: false
 8:       add :description, :text
 9:       add :video_url, :string
10:       add :audio_url, :string
11:       add :duration_seconds, :integer
12:       add :grade_level, :string
13:       add :subject, :string
14:       add :status, :string, default: "pending"
15:       add :metadata, :map, default: %{}
16:       add :user_id, references(:users, on_delete: :delete_all, type: :binary_id), null: false
17: 
18:       timestamps(type: :utc_datetime)
19:     end
20: 
21:     create index(:lessons, [:user_id])
22:     create index(:lessons, [:status])
23:     create index(:lessons, [:subject])
24:     create index(:lessons, [:inserted_at])
25:   end
26: end
````

## File: priv/repo/migrations/20241201000004_create_transcriptions.exs
````elixir
 1: defmodule Hellen.Repo.Migrations.CreateTranscriptions do
 2:   use Ecto.Migration
 3: 
 4:   def change do
 5:     create table(:transcriptions, primary_key: false) do
 6:       add :id, :binary_id, primary_key: true
 7:       add :full_text, :text
 8:       add :language, :string, default: "pt-BR"
 9:       add :confidence_score, :float
10:       add :word_count, :integer
11:       add :segments, {:array, :map}, default: []
12:       add :lesson_id, references(:lessons, on_delete: :delete_all, type: :binary_id), null: false
13: 
14:       timestamps(type: :utc_datetime, updated_at: false)
15:     end
16: 
17:     create unique_index(:transcriptions, [:lesson_id])
18:   end
19: end
````

## File: priv/repo/migrations/20241201000005_create_analyses.exs
````elixir
 1: defmodule Hellen.Repo.Migrations.CreateAnalyses do
 2:   use Ecto.Migration
 3: 
 4:   def change do
 5:     create table(:analyses, primary_key: false) do
 6:       add :id, :binary_id, primary_key: true
 7:       add :analysis_type, :string, null: false
 8:       add :model_used, :string
 9:       add :raw_response, :map
10:       add :result, :map
11:       add :overall_score, :float
12:       add :processing_time_ms, :integer
13:       add :tokens_used, :integer
14:       add :lesson_id, references(:lessons, on_delete: :delete_all, type: :binary_id), null: false
15: 
16:       timestamps(type: :utc_datetime, updated_at: false)
17:     end
18: 
19:     create index(:analyses, [:lesson_id])
20:     create index(:analyses, [:analysis_type])
21:     create index(:analyses, [:inserted_at])
22:   end
23: end
````

## File: priv/repo/migrations/20241201000006_create_bncc_matches.exs
````elixir
 1: defmodule Hellen.Repo.Migrations.CreateBnccMatches do
 2:   use Ecto.Migration
 3: 
 4:   def change do
 5:     create table(:bncc_matches, primary_key: false) do
 6:       add :id, :binary_id, primary_key: true
 7:       add :competencia_code, :string, null: false
 8:       add :competencia_name, :string
 9:       add :match_score, :float
10:       add :evidence_text, :text
11:       add :evidence_timestamp_start, :float
12:       add :evidence_timestamp_end, :float
13:       add :analysis_id, references(:analyses, on_delete: :delete_all, type: :binary_id), null: false
14: 
15:       timestamps(type: :utc_datetime, updated_at: false)
16:     end
17: 
18:     create index(:bncc_matches, [:analysis_id])
19:     create index(:bncc_matches, [:competencia_code])
20:   end
21: end
````

## File: priv/repo/migrations/20241201000007_create_bullying_alerts.exs
````elixir
 1: defmodule Hellen.Repo.Migrations.CreateBullyingAlerts do
 2:   use Ecto.Migration
 3: 
 4:   def change do
 5:     create table(:bullying_alerts, primary_key: false) do
 6:       add :id, :binary_id, primary_key: true
 7:       add :severity, :string, null: false
 8:       add :alert_type, :string, null: false
 9:       add :description, :text
10:       add :evidence_text, :text
11:       add :timestamp_start, :float
12:       add :timestamp_end, :float
13:       add :reviewed, :boolean, default: false
14:       add :reviewed_at, :utc_datetime
15:       add :analysis_id, references(:analyses, on_delete: :delete_all, type: :binary_id), null: false
16:       add :reviewed_by_id, references(:users, on_delete: :nilify_all, type: :binary_id)
17: 
18:       timestamps(type: :utc_datetime, updated_at: false)
19:     end
20: 
21:     create index(:bullying_alerts, [:analysis_id])
22:     create index(:bullying_alerts, [:severity])
23:     create index(:bullying_alerts, [:reviewed])
24:   end
25: end
````

## File: priv/repo/migrations/20241201000008_create_credit_transactions.exs
````elixir
 1: defmodule Hellen.Repo.Migrations.CreateCreditTransactions do
 2:   use Ecto.Migration
 3: 
 4:   def change do
 5:     create table(:credit_transactions, primary_key: false) do
 6:       add :id, :binary_id, primary_key: true
 7:       add :amount, :integer, null: false
 8:       add :balance_after, :integer, null: false
 9:       add :reason, :string, null: false
10:       add :metadata, :map, default: %{}
11:       add :user_id, references(:users, on_delete: :delete_all, type: :binary_id), null: false
12:       add :lesson_id, references(:lessons, on_delete: :nilify_all, type: :binary_id)
13: 
14:       timestamps(type: :utc_datetime, updated_at: false)
15:     end
16: 
17:     create index(:credit_transactions, [:user_id])
18:     create index(:credit_transactions, [:reason])
19:     create index(:credit_transactions, [:inserted_at])
20:   end
21: end
````

## File: priv/repo/migrations/20241202000001_add_firebase_fields_to_users.exs
````elixir
 1: defmodule Hellen.Repo.Migrations.AddFirebaseFieldsToUsers do
 2:   use Ecto.Migration
 3: 
 4:   def change do
 5:     alter table(:users) do
 6:       add :firebase_uid, :string
 7:       add :email_verified, :boolean, default: false
 8:     end
 9: 
10:     create unique_index(:users, [:firebase_uid])
11:   end
12: end
````

## File: priv/repo/migrations/20251204000001_add_institution_to_lessons.exs
````elixir
 1: defmodule Hellen.Repo.Migrations.AddInstitutionToLessons do
 2:   use Ecto.Migration
 3: 
 4:   def change do
 5:     alter table(:lessons) do
 6:       add :institution_id, references(:institutions, type: :binary_id, on_delete: :delete_all)
 7:     end
 8: 
 9:     create index(:lessons, [:institution_id])
10:     create index(:lessons, [:institution_id, :user_id])
11:     create index(:lessons, [:institution_id, :status])
12:     create index(:lessons, [:institution_id, :subject])
13: 
14:     # Backfill existing lessons with institution_id from user
15:     execute(
16:       """
17:       UPDATE lessons l
18:       SET institution_id = u.institution_id
19:       FROM users u
20:       WHERE l.user_id = u.id AND u.institution_id IS NOT NULL
21:       """,
22:       # Rollback: no-op
23:       "SELECT 1"
24:     )
25:   end
26: end
````

## File: priv/repo/migrations/20251204000002_add_institution_to_analyses.exs
````elixir
 1: defmodule Hellen.Repo.Migrations.AddInstitutionToAnalyses do
 2:   use Ecto.Migration
 3: 
 4:   def change do
 5:     alter table(:analyses) do
 6:       add :institution_id, references(:institutions, type: :binary_id, on_delete: :delete_all)
 7:     end
 8: 
 9:     create index(:analyses, [:institution_id])
10:     create index(:analyses, [:institution_id, :lesson_id])
11: 
12:     # Backfill existing analyses with institution_id from lesson
13:     execute(
14:       """
15:       UPDATE analyses a
16:       SET institution_id = l.institution_id
17:       FROM lessons l
18:       WHERE a.lesson_id = l.id AND l.institution_id IS NOT NULL
19:       """,
20:       # Rollback: no-op
21:       "SELECT 1"
22:     )
23:   end
24: end
````

## File: priv/repo/migrations/20251204144700_convert_maps_to_jsonb.exs
````elixir
 1: defmodule Hellen.Repo.Migrations.ConvertMapsToJsonb do
 2:   @moduledoc """
 3:   Converts :map columns to :jsonb for better performance and querying.
 4:   Adds GIN indexes for efficient JSON path queries.
 5: 
 6:   Note: segments column is {:array, :map} which is already jsonb[] and doesn't need conversion.
 7:   """
 8:   use Ecto.Migration
 9: 
10:   def up do
11:     # Analysis - raw_response and result (large JSON objects)
12:     execute "ALTER TABLE analyses ALTER COLUMN raw_response TYPE jsonb USING raw_response::jsonb"
13:     execute "ALTER TABLE analyses ALTER COLUMN result TYPE jsonb USING result::jsonb"
14:     execute "CREATE INDEX IF NOT EXISTS analyses_result_gin ON analyses USING GIN (result)"
15: 
16:     # Transcription - segments is already jsonb[] (array), add GIN index for array containment
17:     execute "CREATE INDEX IF NOT EXISTS transcriptions_segments_gin ON transcriptions USING GIN (segments)"
18: 
19:     # Lesson - metadata
20:     execute "ALTER TABLE lessons ALTER COLUMN metadata TYPE jsonb USING metadata::jsonb"
21: 
22:     # Institution - settings
23:     execute "ALTER TABLE institutions ALTER COLUMN settings TYPE jsonb USING settings::jsonb"
24: 
25:     # Credit transaction - metadata
26:     execute "ALTER TABLE credit_transactions ALTER COLUMN metadata TYPE jsonb USING metadata::jsonb"
27:   end
28: 
29:   def down do
30:     # Revert to json type (not :map, as PostgreSQL doesn't have a map type)
31:     execute "DROP INDEX IF EXISTS analyses_result_gin"
32:     execute "ALTER TABLE analyses ALTER COLUMN raw_response TYPE json USING raw_response::json"
33:     execute "ALTER TABLE analyses ALTER COLUMN result TYPE json USING result::json"
34: 
35:     execute "DROP INDEX IF EXISTS transcriptions_segments_gin"
36: 
37:     execute "ALTER TABLE lessons ALTER COLUMN metadata TYPE json USING metadata::json"
38:     execute "ALTER TABLE institutions ALTER COLUMN settings TYPE json USING settings::json"
39:     execute "ALTER TABLE credit_transactions ALTER COLUMN metadata TYPE json USING metadata::json"
40:   end
41: end
````

## File: priv/repo/migrations/20251204144701_add_missing_indexes.exs
````elixir
 1: defmodule Hellen.Repo.Migrations.AddMissingIndexes do
 2:   @moduledoc """
 3:   Adds missing indexes for common query patterns.
 4:   Improves performance for multi-tenant queries and reporting.
 5:   """
 6:   use Ecto.Migration
 7: 
 8:   def change do
 9:     # Credit transactions - composite index for user history queries
10:     create_if_not_exists index(:credit_transactions, [:user_id, :inserted_at])
11: 
12:     # Note: credit_transactions doesn't have institution_id column
13:     # Multi-tenancy is achieved through user_id -> user.institution_id join
14: 
15:     # Bullying alerts - institution + reviewed for coordinator filtering
16:     create_if_not_exists index(:bullying_alerts, [:severity])
17: 
18:     # Analyses - institution + inserted_at for time-based queries
19:     create_if_not_exists index(:analyses, [:institution_id, :inserted_at])
20: 
21:     # Analyses - overall_score for performance rankings
22:     create_if_not_exists index(:analyses, [:overall_score])
23:   end
24: end
````

## File: priv/repo/migrations/20251204182909_create_notifications.exs
````elixir
 1: defmodule Hellen.Repo.Migrations.CreateNotifications do
 2:   use Ecto.Migration
 3: 
 4:   def change do
 5:     create table(:notifications, primary_key: false) do
 6:       add :id, :binary_id, primary_key: true
 7:       add :type, :string, null: false
 8:       add :title, :string, null: false
 9:       add :message, :text, null: false
10:       add :data, :map, default: %{}
11:       add :read_at, :utc_datetime
12:       add :email_sent_at, :utc_datetime
13:       add :user_id, references(:users, type: :binary_id, on_delete: :delete_all), null: false
14: 
15:       add :institution_id,
16:           references(:institutions, type: :binary_id, on_delete: :delete_all)
17: 
18:       timestamps()
19:     end
20: 
21:     create index(:notifications, [:user_id])
22:     create index(:notifications, [:user_id, :read_at])
23:     create index(:notifications, [:institution_id])
24:     create index(:notifications, [:type])
25:     create index(:notifications, [:inserted_at])
26: 
27:     create table(:notification_preferences, primary_key: false) do
28:       add :id, :binary_id, primary_key: true
29:       add :email_critical_alerts, :boolean, default: true
30:       add :email_high_alerts, :boolean, default: true
31:       add :email_analysis_complete, :boolean, default: false
32:       add :email_daily_summary, :boolean, default: false
33:       add :email_weekly_summary, :boolean, default: true
34:       add :inapp_all_alerts, :boolean, default: true
35:       add :inapp_analysis_complete, :boolean, default: true
36:       add :user_id, references(:users, type: :binary_id, on_delete: :delete_all), null: false
37: 
38:       timestamps()
39:     end
40: 
41:     create unique_index(:notification_preferences, [:user_id])
42:   end
43: end
````

## File: priv/repo/migrations/20251204190117_create_invitations.exs
````elixir
 1: defmodule Hellen.Repo.Migrations.CreateInvitations do
 2:   use Ecto.Migration
 3: 
 4:   def change do
 5:     create table(:invitations, primary_key: false) do
 6:       add :id, :binary_id, primary_key: true
 7:       add :email, :string, null: false
 8:       add :name, :string
 9:       add :token, :string, null: false
10:       add :expires_at, :utc_datetime, null: false
11:       add :accepted_at, :utc_datetime
12:       add :revoked_at, :utc_datetime
13:       add :role, :string, default: "teacher"
14:       add :invited_by_id, references(:users, type: :binary_id, on_delete: :nilify_all)
15:       add :institution_id, references(:institutions, type: :binary_id, on_delete: :delete_all), null: false
16:       add :user_id, references(:users, type: :binary_id, on_delete: :nilify_all)
17: 
18:       timestamps(type: :utc_datetime)
19:     end
20: 
21:     create unique_index(:invitations, [:token])
22:     create index(:invitations, [:institution_id, :email])
23:     create index(:invitations, [:invited_by_id])
24:   end
25: end
````

## File: priv/repo/migrations/20251204192834_add_stripe_fields.exs
````elixir
 1: defmodule Hellen.Repo.Migrations.AddStripeFields do
 2:   use Ecto.Migration
 3: 
 4:   def change do
 5:     alter table(:users) do
 6:       add :stripe_customer_id, :string
 7:     end
 8: 
 9:     create unique_index(:users, [:stripe_customer_id])
10: 
11:     alter table(:credit_transactions) do
12:       add :stripe_payment_intent_id, :string
13:     end
14:   end
15: end
````

## File: priv/repo/migrations/20251206000001_create_plannings.exs
````elixir
 1: defmodule Hellen.Repo.Migrations.CreatePlannings do
 2:   use Ecto.Migration
 3: 
 4:   def change do
 5:     create table(:plannings, primary_key: false) do
 6:       add :id, :binary_id, primary_key: true
 7:       add :title, :string, null: false
 8:       add :description, :text
 9:       add :subject, :string, null: false
10:       add :grade_level, :string, null: false
11:       add :duration_minutes, :integer
12:       add :objectives, {:array, :string}, default: []
13:       add :bncc_codes, {:array, :string}, default: []
14:       add :content, :jsonb, default: fragment("'{}'::jsonb")
15:       add :materials, {:array, :string}, default: []
16:       add :methodology, :text
17:       add :assessment_criteria, :text
18:       add :status, :string, default: "draft"
19:       add :generated_by_ai, :boolean, default: false
20:       add :embeddings_indexed, :boolean, default: false
21:       add :metadata, :jsonb, default: fragment("'{}'::jsonb")
22: 
23:       add :user_id, references(:users, on_delete: :delete_all, type: :binary_id), null: false
24:       add :institution_id, references(:institutions, on_delete: :nilify_all, type: :binary_id)
25:       add :source_lesson_id, references(:lessons, on_delete: :nilify_all, type: :binary_id)
26: 
27:       timestamps(type: :utc_datetime)
28:     end
29: 
30:     create index(:plannings, [:user_id])
31:     create index(:plannings, [:institution_id])
32:     create index(:plannings, [:source_lesson_id])
33:     create index(:plannings, [:status])
34:     create index(:plannings, [:subject])
35:     create index(:plannings, [:grade_level])
36:     create index(:plannings, [:inserted_at])
37:     create index(:plannings, [:bncc_codes], using: :gin)
38:   end
39: end
````

## File: priv/repo/migrations/20251206000002_create_assessments.exs
````elixir
 1: defmodule Hellen.Repo.Migrations.CreateAssessments do
 2:   use Ecto.Migration
 3: 
 4:   def change do
 5:     create table(:assessments, primary_key: false) do
 6:       add :id, :binary_id, primary_key: true
 7:       add :title, :string, null: false
 8:       add :description, :text
 9:       add :subject, :string, null: false
10:       add :grade_level, :string, null: false
11:       add :assessment_type, :string, default: "prova"
12:       add :difficulty_level, :string, default: "medio"
13:       add :duration_minutes, :integer
14:       add :total_points, :decimal, precision: 10, scale: 2
15:       add :instructions, :text
16:       add :bncc_codes, {:array, :string}, default: []
17:       add :questions, :jsonb, default: fragment("'[]'::jsonb")
18:       add :answer_key, :jsonb, default: fragment("'{}'::jsonb")
19:       add :rubrics, :jsonb, default: fragment("'{}'::jsonb")
20:       add :status, :string, default: "draft"
21:       add :generated_by_ai, :boolean, default: false
22:       add :embeddings_indexed, :boolean, default: false
23:       add :metadata, :jsonb, default: fragment("'{}'::jsonb")
24: 
25:       add :user_id, references(:users, on_delete: :delete_all, type: :binary_id), null: false
26:       add :institution_id, references(:institutions, on_delete: :nilify_all, type: :binary_id)
27:       add :source_planning_id, references(:plannings, on_delete: :nilify_all, type: :binary_id)
28: 
29:       timestamps(type: :utc_datetime)
30:     end
31: 
32:     create index(:assessments, [:user_id])
33:     create index(:assessments, [:institution_id])
34:     create index(:assessments, [:source_planning_id])
35:     create index(:assessments, [:status])
36:     create index(:assessments, [:subject])
37:     create index(:assessments, [:grade_level])
38:     create index(:assessments, [:assessment_type])
39:     create index(:assessments, [:difficulty_level])
40:     create index(:assessments, [:inserted_at])
41:     create index(:assessments, [:bncc_codes], using: :gin)
42:   end
43: end
````

## File: priv/repo/migrations/20251207015959_add_onboarding_to_users.exs
````elixir
 1: defmodule Hellen.Repo.Migrations.AddOnboardingToUsers do
 2:   use Ecto.Migration
 3: 
 4:   def change do
 5:     alter table(:users) do
 6:       add :onboarding_completed, :boolean, default: false, null: false
 7:       add :onboarding_step, :integer, default: 0, null: false
 8:       add :subject, :string
 9:       add :grade_level, :string
10:     end
11:   end
12: end
````

## File: priv/repo/migrations/20251207020414_set_existing_users_onboarding_completed.exs
````elixir
 1: defmodule Hellen.Repo.Migrations.SetExistingUsersOnboardingCompleted do
 2:   use Ecto.Migration
 3: 
 4:   def up do
 5:     # Mark all existing users as having completed onboarding
 6:     # This prevents them from being forced through the wizard
 7:     execute "UPDATE users SET onboarding_completed = true WHERE onboarding_completed = false"
 8:   end
 9: 
10:   def down do
11:     # No-op: we don't want to reset onboarding status
12:     :ok
13:   end
14: end
````

## File: priv/repo/migrations/20251207020447_create_achievements.exs
````elixir
 1: defmodule Hellen.Repo.Migrations.CreateAchievements do
 2:   use Ecto.Migration
 3: 
 4:   def change do
 5:     # User achievements (unlocked badges)
 6:     create table(:user_achievements, primary_key: false) do
 7:       add :id, :binary_id, primary_key: true
 8:       add :user_id, references(:users, on_delete: :delete_all, type: :binary_id), null: false
 9:       add :achievement_key, :string, null: false
10:       add :unlocked_at, :utc_datetime, null: false
11: 
12:       timestamps(type: :utc_datetime)
13:     end
14: 
15:     create index(:user_achievements, [:user_id])
16:     create unique_index(:user_achievements, [:user_id, :achievement_key])
17: 
18:     # Add level and experience points to users for gamification
19:     alter table(:users) do
20:       add :level, :integer, default: 1, null: false
21:       add :experience_points, :integer, default: 0, null: false
22:     end
23:   end
24: end
````

## File: priv/repo/seeds.exs
````elixir
 1: # Script for populating the database. You can run it as:
 2: #
 3: #     mix run priv/repo/seeds.exs
 4: #
 5: # Inside the script, you can read and write to any of your
 6: # repositories directly:
 7: #
 8: #     Hellen.Repo.insert!(%Hellen.SomeSchema{})
 9: #
10: # We recommend using the bang functions (`insert!`, `update!`
11: # and so on) as they will fail if something goes wrong.
12: 
13: alias Hellen.Accounts
14: 
15: # Create a demo institution
16: {:ok, institution} =
17:   Accounts.create_institution(%{
18:     name: "Escola Demo",
19:     plan: "pro"
20:   })
21: 
22: # Create a demo user
23: {:ok, _user} =
24:   Accounts.register_user(%{
25:     email: "demo@hellen.ai",
26:     name: "Professor Demo",
27:     password: "demo123456",
28:     role: "teacher",
29:     institution_id: institution.id
30:   })
31: 
32: IO.puts("Seeds completed!")
33: IO.puts("Demo user: demo@hellen.ai / demo123456")
````

## File: test/hellen/accounts_test.exs
````elixir
  1: defmodule Hellen.AccountsTest do
  2:   use Hellen.DataCase, async: true
  3: 
  4:   alias Hellen.Accounts
  5:   alias Hellen.Accounts.{User, Invitation}
  6: 
  7:   describe "users" do
  8:     test "get_user/1 returns user by id" do
  9:       user = insert(:user)
 10:       result = Accounts.get_user(user.id)
 11:       assert result.id == user.id
 12:       assert result.email == user.email
 13:     end
 14: 
 15:     test "get_user/1 returns nil for non-existent user" do
 16:       assert Accounts.get_user(Ecto.UUID.generate()) == nil
 17:     end
 18: 
 19:     test "get_user!/1 returns user by id" do
 20:       user = insert(:user)
 21:       result = Accounts.get_user!(user.id)
 22:       assert result.id == user.id
 23:     end
 24: 
 25:     test "get_user!/1 raises for non-existent user" do
 26:       assert_raise Ecto.NoResultsError, fn ->
 27:         Accounts.get_user!(Ecto.UUID.generate())
 28:       end
 29:     end
 30: 
 31:     test "get_user_by_email/1 returns user by email" do
 32:       user = insert(:user, email: "test@example.com")
 33:       assert Accounts.get_user_by_email("test@example.com").id == user.id
 34:     end
 35: 
 36:     test "get_user_by_email/1 returns nil for non-existent email" do
 37:       assert Accounts.get_user_by_email("nonexistent@example.com") == nil
 38:     end
 39: 
 40:     test "get_user_by_firebase_uid/1 returns user by firebase_uid" do
 41:       user = insert(:user, firebase_uid: "firebase123")
 42:       assert Accounts.get_user_by_firebase_uid("firebase123").id == user.id
 43:     end
 44: 
 45:     test "get_user_by_firebase_uid/1 returns nil for non-existent firebase_uid" do
 46:       assert Accounts.get_user_by_firebase_uid("nonexistent") == nil
 47:     end
 48:   end
 49: 
 50:   describe "register_user/1" do
 51:     test "creates user with valid data" do
 52:       institution = insert(:institution)
 53: 
 54:       attrs = %{
 55:         name: "Test User",
 56:         email: "newuser@example.com",
 57:         password: "password123",
 58:         institution_id: institution.id
 59:       }
 60: 
 61:       assert {:ok, user} = Accounts.register_user(attrs)
 62:       assert user.name == "Test User"
 63:       assert user.email == "newuser@example.com"
 64:       assert user.role == "teacher"
 65:       # signup bonus
 66:       assert user.credits == 2
 67:     end
 68: 
 69:     test "returns error for invalid email format" do
 70:       attrs = %{name: "Test", email: "invalid-email", password: "password123"}
 71:       assert {:error, changeset} = Accounts.register_user(attrs)
 72:       assert "must have the @ sign and no spaces" in errors_on(changeset).email
 73:     end
 74: 
 75:     test "returns error for short password" do
 76:       attrs = %{name: "Test", email: "test@example.com", password: "short"}
 77:       assert {:error, changeset} = Accounts.register_user(attrs)
 78:       assert "should be at least 8 character(s)" in errors_on(changeset).password
 79:     end
 80: 
 81:     test "returns error for duplicate email" do
 82:       insert(:user, email: "existing@example.com")
 83:       attrs = %{name: "Test", email: "existing@example.com", password: "password123"}
 84:       assert {:error, changeset} = Accounts.register_user(attrs)
 85:       assert "has already been taken" in errors_on(changeset).email
 86:     end
 87: 
 88:     test "returns error for missing required fields" do
 89:       assert {:error, changeset} = Accounts.register_user(%{})
 90:       assert "can't be blank" in errors_on(changeset).email
 91:       assert "can't be blank" in errors_on(changeset).name
 92:     end
 93:   end
 94: 
 95:   describe "authenticate_user/2" do
 96:     test "returns user with valid credentials" do
 97:       user = insert(:user, email: "auth@example.com")
 98: 
 99:       assert {:ok, authenticated_user} =
100:                Accounts.authenticate_user("auth@example.com", "password123")
101: 
102:       assert authenticated_user.id == user.id
103:     end
104: 
105:     test "returns error with invalid password" do
106:       insert(:user, email: "auth@example.com")
107: 
108:       assert {:error, :invalid_password} =
109:                Accounts.authenticate_user("auth@example.com", "wrongpassword")
110:     end
111: 
112:     test "returns error with non-existent email" do
113:       assert {:error, :user_not_found} =
114:                Accounts.authenticate_user("nonexistent@example.com", "password123")
115:     end
116:   end
117: 
118:   describe "update_user/2" do
119:     test "updates user with valid data" do
120:       user = insert(:user)
121:       assert {:ok, updated} = Accounts.update_user(user, %{name: "New Name"})
122:       assert updated.name == "New Name"
123:     end
124: 
125:     test "returns error with invalid data" do
126:       user = insert(:user)
127:       assert {:error, changeset} = Accounts.update_user(user, %{email: "invalid"})
128:       assert "must have the @ sign and no spaces" in errors_on(changeset).email
129:     end
130:   end
131: 
132:   describe "update_user_profile/2" do
133:     test "updates name and email" do
134:       user = insert(:user)
135: 
136:       assert {:ok, updated} =
137:                Accounts.update_user_profile(user, %{name: "New Name", email: "new@example.com"})
138: 
139:       assert updated.name == "New Name"
140:       assert updated.email == "new@example.com"
141:     end
142: 
143:     test "validates email format" do
144:       user = insert(:user)
145: 
146:       assert {:error, changeset} =
147:                Accounts.update_user_profile(user, %{name: "Name", email: "invalid"})
148: 
149:       assert "must have the @ sign and no spaces" in errors_on(changeset).email
150:     end
151:   end
152: 
153:   describe "change_user_password/3" do
154:     test "changes password with valid current password" do
155:       user = insert(:user, email: "pass@example.com")
156:       assert {:ok, updated} = Accounts.change_user_password(user, "password123", "newpassword123")
157:       assert User.valid_password?(updated, "newpassword123")
158:     end
159: 
160:     test "returns error with invalid current password" do
161:       user = insert(:user)
162: 
163:       assert {:error, :invalid_password} =
164:                Accounts.change_user_password(user, "wrongpassword", "newpassword123")
165:     end
166: 
167:     test "returns error with short new password" do
168:       user = insert(:user)
169:       assert {:error, changeset} = Accounts.change_user_password(user, "password123", "short")
170:       assert "should be at least 8 character(s)" in errors_on(changeset).password
171:     end
172:   end
173: 
174:   describe "update_stripe_customer_id/2" do
175:     test "updates stripe customer id" do
176:       user = insert(:user)
177:       assert {:ok, updated} = Accounts.update_stripe_customer_id(user, "cus_123456")
178:       assert updated.stripe_customer_id == "cus_123456"
179:     end
180:   end
181: 
182:   describe "list_users_by_institution/1" do
183:     test "returns users in institution" do
184:       institution = insert(:institution)
185:       user1 = insert(:user, institution: institution)
186:       user2 = insert(:user, institution: institution)
187:       _other_user = insert(:user)
188: 
189:       users = Accounts.list_users_by_institution(institution.id)
190:       user_ids = Enum.map(users, & &1.id)
191: 
192:       assert length(users) == 2
193:       assert user1.id in user_ids
194:       assert user2.id in user_ids
195:     end
196: 
197:     test "returns empty list for institution with no users" do
198:       institution = insert(:institution)
199:       assert Accounts.list_users_by_institution(institution.id) == []
200:     end
201:   end
202: 
203:   describe "find_or_create_from_firebase/1" do
204:     test "creates new user when none exists" do
205:       firebase_info = %{
206:         firebase_uid: "fb_uid_123",
207:         email: "firebase@example.com",
208:         name: "Firebase User",
209:         email_verified: true
210:       }
211: 
212:       assert {:ok, user} = Accounts.find_or_create_from_firebase(firebase_info)
213:       assert user.firebase_uid == "fb_uid_123"
214:       assert user.email == "firebase@example.com"
215:       assert user.name == "Firebase User"
216:       assert user.email_verified == true
217:     end
218: 
219:     test "returns existing user by firebase_uid" do
220:       existing_user = insert(:user, firebase_uid: "fb_existing")
221:       firebase_info = %{firebase_uid: "fb_existing", email: "other@example.com"}
222: 
223:       assert {:ok, user} = Accounts.find_or_create_from_firebase(firebase_info)
224:       assert user.id == existing_user.id
225:     end
226: 
227:     test "links existing user by email to firebase" do
228:       existing_user = insert(:user, email: "link@example.com", firebase_uid: nil)
229:       firebase_info = %{firebase_uid: "fb_link", email: "link@example.com", email_verified: true}
230: 
231:       assert {:ok, user} = Accounts.find_or_create_from_firebase(firebase_info)
232:       assert user.id == existing_user.id
233:       assert user.firebase_uid == "fb_link"
234:     end
235:   end
236: 
237:   describe "institutions" do
238:     test "get_institution!/1 returns institution" do
239:       institution = insert(:institution)
240:       assert Accounts.get_institution!(institution.id).id == institution.id
241:     end
242: 
243:     test "get_institution!/1 raises for non-existent institution" do
244:       assert_raise Ecto.NoResultsError, fn ->
245:         Accounts.get_institution!(Ecto.UUID.generate())
246:       end
247:     end
248: 
249:     test "create_institution/1 with valid data" do
250:       attrs = %{name: "Test School", plan: "pro"}
251:       assert {:ok, institution} = Accounts.create_institution(attrs)
252:       assert institution.name == "Test School"
253:       assert institution.plan == "pro"
254:     end
255: 
256:     test "create_institution/1 with invalid plan" do
257:       attrs = %{name: "Test", plan: "invalid"}
258:       assert {:error, changeset} = Accounts.create_institution(attrs)
259:       assert "is invalid" in errors_on(changeset).plan
260:     end
261: 
262:     test "update_institution/2 updates institution" do
263:       institution = insert(:institution)
264:       assert {:ok, updated} = Accounts.update_institution(institution, %{name: "Updated Name"})
265:       assert updated.name == "Updated Name"
266:     end
267: 
268:     test "list_institutions/0 returns all institutions" do
269:       inst1 = insert(:institution)
270:       inst2 = insert(:institution)
271: 
272:       institutions = Accounts.list_institutions()
273:       ids = Enum.map(institutions, & &1.id)
274: 
275:       assert inst1.id in ids
276:       assert inst2.id in ids
277:     end
278:   end
279: 
280:   describe "coordinator functions" do
281:     test "get_institution_stats/1 returns comprehensive statistics" do
282:       institution = insert(:institution)
283:       user = insert(:user, institution: institution)
284:       lesson = insert(:lesson, user: user, institution: institution, status: "completed")
285:       analysis = insert(:analysis, lesson: lesson, institution: institution, overall_score: 0.8)
286:       insert(:bullying_alert, analysis: analysis, reviewed: false)
287: 
288:       stats = Accounts.get_institution_stats(institution.id)
289: 
290:       assert stats.teachers == 1
291:       assert stats.lessons == 1
292:       assert stats.analyses == 1
293:       assert stats.alerts == 1
294:       assert stats.avg_score == 0.8
295:     end
296: 
297:     test "list_teachers_with_stats/1 returns teachers with statistics" do
298:       institution = insert(:institution)
299:       user = insert(:user, institution: institution)
300:       lesson = insert(:lesson, user: user, institution: institution)
301:       _analysis = insert(:analysis, lesson: lesson, institution: institution, overall_score: 0.85)
302: 
303:       [teacher_stats] = Accounts.list_teachers_with_stats(institution.id)
304: 
305:       assert teacher_stats.user.id == user.id
306:       assert teacher_stats.lessons_count == 1
307:       assert teacher_stats.analyses_count == 1
308:       # Float.round(0.85, 1) truncates to 0.8
309:       assert teacher_stats.avg_score == 0.8
310:     end
311: 
312:     test "get_lessons_per_teacher/1 returns lessons count per teacher" do
313:       institution = insert(:institution)
314:       user1 = insert(:user, institution: institution, name: "Teacher A")
315:       user2 = insert(:user, institution: institution, name: "Teacher B")
316:       insert(:lesson, user: user1, institution: institution)
317:       insert(:lesson, user: user1, institution: institution)
318:       insert(:lesson, user: user2, institution: institution)
319: 
320:       results = Accounts.get_lessons_per_teacher(institution.id)
321: 
322:       teacher_a = Enum.find(results, &(&1.name == "Teacher A"))
323:       teacher_b = Enum.find(results, &(&1.name == "Teacher B"))
324: 
325:       assert teacher_a.lessons == 2
326:       assert teacher_b.lessons == 1
327:     end
328: 
329:     test "list_recent_institution_lessons/2 returns recent lessons" do
330:       institution = insert(:institution)
331:       user = insert(:user, institution: institution)
332:       lesson1 = insert(:lesson, user: user, institution: institution)
333:       lesson2 = insert(:lesson, user: user, institution: institution)
334: 
335:       lessons = Accounts.list_recent_institution_lessons(institution.id, limit: 10)
336: 
337:       assert length(lessons) == 2
338:       assert Enum.any?(lessons, &(&1.id == lesson1.id))
339:       assert Enum.any?(lessons, &(&1.id == lesson2.id))
340:     end
341: 
342:     test "invite_teacher_to_institution/2 creates teacher user" do
343:       institution = insert(:institution)
344: 
345:       attrs = %{name: "New Teacher", email: "newteacher@example.com"}
346:       assert {:ok, user} = Accounts.invite_teacher_to_institution(institution.id, attrs)
347: 
348:       assert user.name == "New Teacher"
349:       assert user.email == "newteacher@example.com"
350:       assert user.role == "teacher"
351:       assert user.institution_id == institution.id
352:     end
353: 
354:     test "remove_teacher_from_institution/1 removes institution association" do
355:       institution = insert(:institution)
356:       user = insert(:user, institution: institution)
357: 
358:       assert {:ok, updated} = Accounts.remove_teacher_from_institution(user)
359:       assert updated.institution_id == nil
360:     end
361: 
362:     test "update_user_role/2 changes teacher to coordinator" do
363:       user = insert(:user, role: "teacher")
364:       assert {:ok, updated} = Accounts.update_user_role(user, "coordinator")
365:       assert updated.role == "coordinator"
366:     end
367: 
368:     test "update_user_role/2 returns error for invalid role" do
369:       user = insert(:user)
370:       assert {:error, :invalid_role} = Accounts.update_user_role(user, "admin")
371:     end
372:   end
373: 
374:   describe "admin functions" do
375:     test "get_system_stats/0 returns system-wide statistics" do
376:       insert(:institution)
377:       insert(:user)
378:       insert(:lesson)
379: 
380:       stats = Accounts.get_system_stats()
381: 
382:       assert stats.institutions >= 1
383:       assert stats.users >= 1
384:       assert stats.lessons >= 1
385:       assert is_map(stats.users_by_role)
386:       assert is_map(stats.users_by_plan)
387:     end
388: 
389:     test "list_institutions_with_stats/0 returns institutions with statistics" do
390:       institution = insert(:institution)
391:       user = insert(:user, institution: institution)
392:       insert(:lesson, user: user, institution: institution)
393: 
394:       results = Accounts.list_institutions_with_stats()
395: 
396:       inst_result = Enum.find(results, &(&1.institution.id == institution.id))
397:       assert inst_result.users_count == 1
398:       assert inst_result.lessons_count == 1
399:     end
400: 
401:     test "list_all_users/1 returns paginated users" do
402:       insert(:user, role: "teacher")
403:       insert(:user, role: "coordinator")
404:       insert(:user, role: "admin")
405: 
406:       {users, total} = Accounts.list_all_users()
407: 
408:       assert total >= 3
409:       assert length(users) >= 3
410:     end
411: 
412:     test "list_all_users/1 filters by role" do
413:       insert(:user, role: "teacher")
414:       insert(:user, role: "coordinator")
415: 
416:       {users, _total} = Accounts.list_all_users(role: "teacher")
417: 
418:       assert Enum.all?(users, &(&1.role == "teacher"))
419:     end
420: 
421:     test "list_all_users/1 filters by search term" do
422:       insert(:user, name: "John Doe", email: "john@example.com")
423:       insert(:user, name: "Jane Smith", email: "jane@example.com")
424: 
425:       {users, _total} = Accounts.list_all_users(search: "John")
426: 
427:       refute Enum.empty?(users)
428:       assert Enum.any?(users, &(&1.name == "John Doe"))
429:     end
430: 
431:     test "admin_update_user_role/2 allows setting admin role" do
432:       user = insert(:user, role: "teacher")
433:       assert {:ok, updated} = Accounts.admin_update_user_role(user, "admin")
434:       assert updated.role == "admin"
435:     end
436: 
437:     test "admin_assign_user_to_institution/2 assigns user to institution" do
438:       user = insert(:user, institution_id: nil)
439:       institution = insert(:institution)
440: 
441:       assert {:ok, updated} = Accounts.admin_assign_user_to_institution(user, institution.id)
442:       assert updated.institution_id == institution.id
443:     end
444: 
445:     test "admin_assign_user_to_institution/2 removes user from institution with nil" do
446:       institution = insert(:institution)
447:       user = insert(:user, institution: institution)
448: 
449:       assert {:ok, updated} = Accounts.admin_assign_user_to_institution(user, nil)
450:       assert updated.institution_id == nil
451:     end
452: 
453:     test "admin_update_user_plan/2 updates user plan" do
454:       user = insert(:user, plan: "free")
455:       assert {:ok, updated} = Accounts.admin_update_user_plan(user, "pro")
456:       assert updated.plan == "pro"
457:     end
458: 
459:     test "admin_update_user_plan/2 returns error for invalid plan" do
460:       user = insert(:user)
461:       assert {:error, :invalid_plan} = Accounts.admin_update_user_plan(user, "invalid")
462:     end
463: 
464:     test "admin_add_user_credits/3 adds credits to user" do
465:       user = insert(:user, credits: 10)
466:       assert {:ok, updated} = Accounts.admin_add_user_credits(user, 5, "gift")
467:       assert updated.credits == 15
468:     end
469: 
470:     test "get_daily_registrations/1 returns registration counts" do
471:       insert(:user)
472:       insert(:user)
473: 
474:       results = Accounts.get_daily_registrations(30)
475: 
476:       assert is_list(results)
477:       # At least today's registrations should appear
478:       assert Enum.any?(results, &(&1.count >= 2))
479:     end
480: 
481:     test "get_recent_platform_activity/1 returns recent activity" do
482:       user = insert(:user)
483:       lesson = insert(:lesson, user: user)
484:       analysis = insert(:analysis, lesson: lesson)
485:       insert(:bullying_alert, analysis: analysis, reviewed: false)
486: 
487:       activity = Accounts.get_recent_platform_activity(10)
488: 
489:       refute Enum.empty?(activity.lessons)
490:       refute Enum.empty?(activity.analyses)
491:       refute Enum.empty?(activity.alerts)
492:     end
493:   end
494: 
495:   describe "invitations" do
496:     test "create_invitation/3 creates invitation with token" do
497:       institution = insert(:institution)
498:       coordinator = insert(:user, institution: institution, role: "coordinator")
499: 
500:       attrs = %{email: "invite@example.com", name: "Invited User", role: "teacher"}
501:       assert {:ok, invitation} = Accounts.create_invitation(institution.id, attrs, coordinator)
502: 
503:       assert invitation.email == "invite@example.com"
504:       assert invitation.name == "Invited User"
505:       assert invitation.role == "teacher"
506:       assert invitation.institution_id == institution.id
507:       assert invitation.invited_by_id == coordinator.id
508:       assert invitation.token != nil
509:       assert invitation.expires_at != nil
510:     end
511: 
512:     test "get_invitation_by_token/1 returns invitation" do
513:       invitation = insert(:invitation)
514:       found = Accounts.get_invitation_by_token(invitation.token)
515: 
516:       assert found.id == invitation.id
517:       assert found.institution != nil
518:     end
519: 
520:     test "get_invitation_by_token/1 returns nil for invalid token" do
521:       assert Accounts.get_invitation_by_token("invalid_token") == nil
522:     end
523: 
524:     test "list_pending_invitations/1 returns pending invitations" do
525:       institution = insert(:institution)
526:       coordinator = insert(:user, institution: institution, role: "coordinator")
527: 
528:       pending = insert(:invitation, institution: institution, invited_by: coordinator)
529: 
530:       _accepted =
531:         insert(:invitation,
532:           institution: institution,
533:           invited_by: coordinator,
534:           accepted_at: DateTime.utc_now()
535:         )
536: 
537:       invitations = Accounts.list_pending_invitations(institution.id)
538: 
539:       assert length(invitations) == 1
540:       assert hd(invitations).id == pending.id
541:     end
542: 
543:     test "accept_invitation/2 creates user and marks accepted" do
544:       invitation = insert(:invitation)
545: 
546:       user_attrs = %{
547:         name: "Accepted User",
548:         password: "password123"
549:       }
550: 
551:       assert {:ok, user} = Accounts.accept_invitation(invitation.token, user_attrs)
552: 
553:       assert user.email == invitation.email
554:       assert user.institution_id == invitation.institution_id
555:       assert user.role == invitation.role
556: 
557:       # Verify invitation is marked accepted
558:       updated_invitation = Accounts.get_invitation_by_token(invitation.token)
559:       assert updated_invitation.accepted_at != nil
560:       assert updated_invitation.user_id == user.id
561:     end
562: 
563:     test "accept_invitation/2 returns error for already accepted invitation" do
564:       invitation = insert(:invitation, accepted_at: DateTime.utc_now())
565:       assert {:error, :already_accepted} = Accounts.accept_invitation(invitation.token, %{})
566:     end
567: 
568:     test "accept_invitation/2 returns error for revoked invitation" do
569:       invitation = insert(:invitation, revoked_at: DateTime.utc_now())
570:       assert {:error, :revoked} = Accounts.accept_invitation(invitation.token, %{})
571:     end
572: 
573:     test "accept_invitation/2 returns error for expired invitation" do
574:       invitation =
575:         insert(:invitation,
576:           expires_at: DateTime.add(DateTime.utc_now(), -1, :day) |> DateTime.truncate(:second)
577:         )
578: 
579:       assert {:error, :expired} = Accounts.accept_invitation(invitation.token, %{})
580:     end
581: 
582:     test "accept_invitation/2 returns error for invalid token" do
583:       assert {:error, :not_found} = Accounts.accept_invitation("invalid", %{})
584:     end
585: 
586:     test "accept_invitation/2 links existing user by email" do
587:       existing_user = insert(:user, email: "existing@example.com", institution_id: nil)
588:       invitation = insert(:invitation, email: "existing@example.com")
589: 
590:       assert {:ok, user} = Accounts.accept_invitation(invitation.token, %{})
591: 
592:       assert user.id == existing_user.id
593:       assert user.institution_id == invitation.institution_id
594:     end
595: 
596:     test "revoke_invitation/1 marks invitation as revoked" do
597:       invitation = insert(:invitation)
598:       assert {:ok, revoked} = Accounts.revoke_invitation(invitation.id)
599:       assert revoked.revoked_at != nil
600:     end
601: 
602:     test "revoke_invitation/1 returns error for non-existent invitation" do
603:       assert {:error, :not_found} = Accounts.revoke_invitation(Ecto.UUID.generate())
604:     end
605: 
606:     test "resend_invitation/1 creates new invitation and revokes old" do
607:       invitation = insert(:invitation)
608: 
609:       assert {:ok, new_invitation} = Accounts.resend_invitation(invitation.id)
610: 
611:       assert new_invitation.id != invitation.id
612:       assert new_invitation.email == invitation.email
613:       assert new_invitation.token != invitation.token
614: 
615:       # Old invitation should be revoked
616:       old_invitation = Repo.get!(Invitation, invitation.id)
617:       assert old_invitation.revoked_at != nil
618:     end
619: 
620:     test "resend_invitation/1 returns error for non-existent invitation" do
621:       assert {:error, :not_found} = Accounts.resend_invitation(Ecto.UUID.generate())
622:     end
623:   end
624: end
````

## File: test/hellen/analysis_test.exs
````elixir
  1: defmodule Hellen.AnalysisTest do
  2:   use Hellen.DataCase, async: true
  3: 
  4:   alias Hellen.Analysis
  5: 
  6:   describe "analyses" do
  7:     test "get_analysis!/2 returns analysis by id scoped to institution" do
  8:       institution = insert(:institution)
  9:       user = insert(:user, institution: institution)
 10:       lesson = insert(:lesson, user: user, institution: institution)
 11:       analysis = insert(:analysis, lesson: lesson, institution: institution)
 12: 
 13:       result = Analysis.get_analysis!(analysis.id, institution.id)
 14:       assert result.id == analysis.id
 15:     end
 16: 
 17:     test "get_analysis!/2 raises for non-existent analysis" do
 18:       institution = insert(:institution)
 19: 
 20:       assert_raise Ecto.NoResultsError, fn ->
 21:         Analysis.get_analysis!(Ecto.UUID.generate(), institution.id)
 22:       end
 23:     end
 24: 
 25:     test "get_analysis!/2 raises when institution doesn't match" do
 26:       institution1 = insert(:institution)
 27:       institution2 = insert(:institution)
 28:       user = insert(:user, institution: institution1)
 29:       lesson = insert(:lesson, user: user, institution: institution1)
 30:       analysis = insert(:analysis, lesson: lesson, institution: institution1)
 31: 
 32:       assert_raise Ecto.NoResultsError, fn ->
 33:         Analysis.get_analysis!(analysis.id, institution2.id)
 34:       end
 35:     end
 36: 
 37:     test "get_analysis_with_details!/2 returns analysis with associations" do
 38:       institution = insert(:institution)
 39:       user = insert(:user, institution: institution)
 40:       lesson = insert(:lesson, user: user, institution: institution)
 41:       analysis = insert(:analysis, lesson: lesson, institution: institution)
 42:       insert(:bncc_match, analysis: analysis)
 43:       insert(:bullying_alert, analysis: analysis)
 44: 
 45:       result = Analysis.get_analysis_with_details!(analysis.id, institution.id)
 46:       assert result.id == analysis.id
 47:       assert length(result.bncc_matches) == 1
 48:       assert length(result.bullying_alerts) == 1
 49:     end
 50: 
 51:     test "list_analyses_by_lesson/2 returns analyses for lesson" do
 52:       institution = insert(:institution)
 53:       user = insert(:user, institution: institution)
 54:       lesson = insert(:lesson, user: user, institution: institution)
 55:       analysis1 = insert(:analysis, lesson: lesson, institution: institution)
 56:       analysis2 = insert(:analysis, lesson: lesson, institution: institution)
 57:       _other = insert(:analysis)
 58: 
 59:       analyses = Analysis.list_analyses_by_lesson(lesson.id, institution.id)
 60:       analysis_ids = Enum.map(analyses, & &1.id)
 61: 
 62:       assert length(analyses) == 2
 63:       assert analysis1.id in analysis_ids
 64:       assert analysis2.id in analysis_ids
 65:     end
 66: 
 67:     test "create_analysis/1 creates analysis with valid data" do
 68:       institution = insert(:institution)
 69:       user = insert(:user, institution: institution)
 70:       lesson = insert(:lesson, user: user, institution: institution)
 71: 
 72:       attrs = %{
 73:         lesson_id: lesson.id,
 74:         institution_id: institution.id,
 75:         analysis_type: "full",
 76:         model_used: "qwen3-8b",
 77:         raw_response: %{},
 78:         result: %{"summary" => "Test"},
 79:         overall_score: 0.85
 80:       }
 81: 
 82:       assert {:ok, analysis} = Analysis.create_analysis(attrs)
 83:       assert analysis.analysis_type == "full"
 84:       assert analysis.overall_score == 0.85
 85:     end
 86: 
 87:     test "create_full_analysis/2 creates analysis with BNCC matches and alerts" do
 88:       institution = insert(:institution)
 89:       user = insert(:user, institution: institution)
 90:       lesson = insert(:lesson, user: user, institution: institution)
 91: 
 92:       analysis_result = %{
 93:         model: "qwen3-8b",
 94:         raw: %{},
 95:         structured: %{"summary" => "Test"},
 96:         overall_score: 0.85,
 97:         processing_time_ms: 1500,
 98:         tokens_used: 500,
 99:         bncc_matches: [
100:           %{
101:             competencia_code: "EF05MA01",
102:             competencia_name: "Test competency",
103:             match_score: 0.9,
104:             evidence_text: "Evidence"
105:           }
106:         ],
107:         bullying_alerts: [
108:           %{
109:             severity: "medium",
110:             alert_type: "verbal_aggression",
111:             description: "Test alert",
112:             evidence_text: "Evidence"
113:           }
114:         ]
115:       }
116: 
117:       assert {:ok, analysis} = Analysis.create_full_analysis(lesson.id, analysis_result)
118:       assert analysis.overall_score == 0.85
119: 
120:       # Verify related records
121:       bncc_matches = Analysis.list_bncc_matches_by_analysis(analysis.id)
122:       assert length(bncc_matches) == 1
123:       assert hd(bncc_matches).competencia_code == "EF05MA01"
124: 
125:       alerts = Analysis.list_bullying_alerts_by_analysis(analysis.id)
126:       assert length(alerts) == 1
127:       assert hd(alerts).severity == "medium"
128:     end
129:   end
130: 
131:   describe "bncc_matches" do
132:     test "create_bncc_match/1 creates match" do
133:       analysis = insert(:analysis)
134: 
135:       attrs = %{
136:         analysis_id: analysis.id,
137:         competencia_code: "EF05MA02",
138:         competencia_name: "Test competency",
139:         match_score: 0.85,
140:         evidence_text: "Evidence text"
141:       }
142: 
143:       assert {:ok, match} = Analysis.create_bncc_match(attrs)
144:       assert match.competencia_code == "EF05MA02"
145:       assert match.match_score == 0.85
146:     end
147: 
148:     test "list_bncc_matches_by_analysis/1 returns matches ordered by score" do
149:       analysis = insert(:analysis)
150:       insert(:bncc_match, analysis: analysis, match_score: 0.7)
151:       insert(:bncc_match, analysis: analysis, match_score: 0.9)
152:       insert(:bncc_match, analysis: analysis, match_score: 0.8)
153: 
154:       matches = Analysis.list_bncc_matches_by_analysis(analysis.id)
155: 
156:       assert length(matches) == 3
157:       scores = Enum.map(matches, & &1.match_score)
158:       assert scores == Enum.sort(scores, :desc)
159:     end
160:   end
161: 
162:   describe "bullying_alerts" do
163:     test "create_bullying_alert/1 creates alert" do
164:       analysis = insert(:analysis)
165: 
166:       attrs = %{
167:         analysis_id: analysis.id,
168:         severity: "high",
169:         alert_type: "verbal_aggression",
170:         description: "Test alert",
171:         evidence_text: "Evidence"
172:       }
173: 
174:       assert {:ok, alert} = Analysis.create_bullying_alert(attrs)
175:       assert alert.severity == "high"
176:       assert alert.reviewed == false
177:     end
178: 
179:     test "list_bullying_alerts_by_analysis/1 returns alerts" do
180:       analysis = insert(:analysis)
181:       insert(:bullying_alert, analysis: analysis, severity: "low")
182:       insert(:bullying_alert, analysis: analysis, severity: "high")
183:       insert(:bullying_alert, analysis: analysis, severity: "medium")
184: 
185:       alerts = Analysis.list_bullying_alerts_by_analysis(analysis.id)
186:       assert length(alerts) == 3
187:     end
188: 
189:     test "review_bullying_alert/2 marks alert as reviewed" do
190:       analysis = insert(:analysis)
191:       alert = insert(:bullying_alert, analysis: analysis, reviewed: false)
192:       reviewer = insert(:user)
193: 
194:       assert {:ok, reviewed} = Analysis.review_bullying_alert(alert.id, reviewer.id)
195:       assert reviewed.reviewed == true
196:       assert reviewed.reviewed_by_id == reviewer.id
197:       assert reviewed.reviewed_at != nil
198:     end
199: 
200:     test "list_unreviewed_alerts/1 returns only unreviewed alerts" do
201:       analysis = insert(:analysis)
202:       insert(:bullying_alert, analysis: analysis, reviewed: false)
203:       insert(:bullying_alert, analysis: analysis, reviewed: false)
204:       insert(:bullying_alert, analysis: analysis, reviewed: true, reviewed_by: insert(:user))
205: 
206:       alerts = Analysis.list_unreviewed_alerts()
207:       assert length(alerts) == 2
208:       assert Enum.all?(alerts, &(&1.reviewed == false))
209:     end
210: 
211:     test "list_unreviewed_alerts/1 respects limit" do
212:       analysis = insert(:analysis)
213:       for _ <- 1..5, do: insert(:bullying_alert, analysis: analysis, reviewed: false)
214: 
215:       alerts = Analysis.list_unreviewed_alerts(limit: 3)
216:       assert length(alerts) == 3
217:     end
218:   end
219: 
220:   describe "statistics" do
221:     test "get_user_score_history/2 returns score history for user" do
222:       user = insert(:user)
223:       lesson1 = insert(:lesson, user: user, title: "Lesson 1")
224:       lesson2 = insert(:lesson, user: user, title: "Lesson 2")
225:       insert(:analysis, lesson: lesson1, overall_score: 0.8)
226:       insert(:analysis, lesson: lesson2, overall_score: 0.9)
227: 
228:       history = Analysis.get_user_score_history(user.id)
229:       assert length(history) == 2
230:       assert Enum.any?(history, &(&1.lesson_title == "Lesson 1"))
231:       assert Enum.any?(history, &(&1.lesson_title == "Lesson 2"))
232:     end
233: 
234:     test "get_discipline_average/2 returns average score for subject" do
235:       institution = insert(:institution)
236:       user = insert(:user, institution: institution)
237:       lesson1 = insert(:lesson, user: user, institution: institution, subject: "Matematica")
238:       lesson2 = insert(:lesson, user: user, institution: institution, subject: "Matematica")
239:       lesson3 = insert(:lesson, user: user, institution: institution, subject: "Portugues")
240: 
241:       insert(:analysis, lesson: lesson1, institution: institution, overall_score: 0.8)
242:       insert(:analysis, lesson: lesson2, institution: institution, overall_score: 0.9)
243:       insert(:analysis, lesson: lesson3, institution: institution, overall_score: 0.7)
244: 
245:       avg = Analysis.get_discipline_average("Matematica", institution.id)
246:       assert_in_delta avg, 0.85, 0.01
247:     end
248: 
249:     test "get_user_trend/1 returns stable with single analysis" do
250:       user = insert(:user)
251:       lesson = insert(:lesson, user: user)
252:       insert(:analysis, lesson: lesson, overall_score: 0.8)
253: 
254:       {trend, change} = Analysis.get_user_trend(user.id)
255:       assert trend == :stable
256:       assert change == 0.0
257:     end
258: 
259:     test "get_user_trend/1 returns stable with no analyses" do
260:       user = insert(:user)
261: 
262:       {trend, change} = Analysis.get_user_trend(user.id)
263:       assert trend == :stable
264:       assert change == 0.0
265:     end
266: 
267:     test "get_bncc_coverage/2 returns aggregated BNCC competencies" do
268:       user = insert(:user)
269:       lesson = insert(:lesson, user: user)
270:       analysis = insert(:analysis, lesson: lesson)
271: 
272:       insert(:bncc_match, analysis: analysis, competencia_code: "EF05MA01", match_score: 0.8)
273:       insert(:bncc_match, analysis: analysis, competencia_code: "EF05MA01", match_score: 0.9)
274:       insert(:bncc_match, analysis: analysis, competencia_code: "EF05LP01", match_score: 0.7)
275: 
276:       coverage = Analysis.get_bncc_coverage(user.id)
277: 
278:       ma_coverage = Enum.find(coverage, &(&1.code == "EF05MA01"))
279:       assert ma_coverage.count == 2
280:     end
281:   end
282: 
283:   describe "alerts by institution" do
284:     test "list_alerts_by_institution/2 returns alerts for institution" do
285:       institution = insert(:institution)
286:       user = insert(:user, institution: institution)
287:       lesson = insert(:lesson, user: user, institution: institution)
288:       analysis = insert(:analysis, lesson: lesson, institution: institution)
289:       insert(:bullying_alert, analysis: analysis)
290:       insert(:bullying_alert, analysis: analysis)
291: 
292:       # Different institution
293:       other_analysis = insert(:analysis)
294:       insert(:bullying_alert, analysis: other_analysis)
295: 
296:       alerts = Analysis.list_alerts_by_institution(institution.id)
297:       assert length(alerts) == 2
298:     end
299: 
300:     test "list_alerts_by_institution/2 filters by status" do
301:       institution = insert(:institution)
302:       user = insert(:user, institution: institution)
303:       lesson = insert(:lesson, user: user, institution: institution)
304:       analysis = insert(:analysis, lesson: lesson, institution: institution)
305:       insert(:bullying_alert, analysis: analysis, reviewed: false)
306:       insert(:bullying_alert, analysis: analysis, reviewed: true, reviewed_by: insert(:user))
307: 
308:       unreviewed = Analysis.list_alerts_by_institution(institution.id, status: :unreviewed)
309:       assert length(unreviewed) == 1
310: 
311:       reviewed = Analysis.list_alerts_by_institution(institution.id, status: :reviewed)
312:       assert length(reviewed) == 1
313:     end
314: 
315:     test "get_alert_stats/1 returns alert statistics" do
316:       institution = insert(:institution)
317:       user = insert(:user, institution: institution)
318:       lesson = insert(:lesson, user: user, institution: institution)
319:       analysis = insert(:analysis, lesson: lesson, institution: institution)
320:       insert(:bullying_alert, analysis: analysis, severity: "high", reviewed: false)
321: 
322:       insert(:bullying_alert,
323:         analysis: analysis,
324:         severity: "medium",
325:         reviewed: true,
326:         reviewed_by: insert(:user)
327:       )
328: 
329:       insert(:bullying_alert, analysis: analysis, severity: "high", reviewed: false)
330: 
331:       stats = Analysis.get_alert_stats(institution.id)
332:       assert stats.total == 3
333:       assert stats.unreviewed == 2
334:       assert stats.reviewed == 1
335:       assert stats.by_severity["high"] == 2
336:       assert stats.by_severity["medium"] == 1
337:     end
338:   end
339: 
340:   describe "advanced analytics" do
341:     test "get_score_comparison/2 returns period comparison" do
342:       user = insert(:user)
343: 
344:       comparison = Analysis.get_score_comparison(user.id, days: 30)
345: 
346:       assert Map.has_key?(comparison, :current_avg)
347:       assert Map.has_key?(comparison, :previous_avg)
348:       assert Map.has_key?(comparison, :change_percent)
349:       assert Map.has_key?(comparison, :trend)
350:       assert comparison.trend in [:improving, :stable, :declining]
351:     end
352: 
353:     test "get_institution_comparison/2 returns institution vs platform comparison" do
354:       institution = insert(:institution)
355:       user = insert(:user, institution: institution)
356:       lesson = insert(:lesson, user: user, institution: institution)
357:       insert(:analysis, lesson: lesson, institution: institution, overall_score: 0.85)
358: 
359:       comparison = Analysis.get_institution_comparison(institution.id)
360: 
361:       assert Map.has_key?(comparison, :institution_avg)
362:       assert Map.has_key?(comparison, :platform_avg)
363:       assert Map.has_key?(comparison, :rank)
364:       assert Map.has_key?(comparison, :percentile)
365:     end
366: 
367:     test "get_daily_scores/2 returns daily score breakdown" do
368:       user = insert(:user)
369:       lesson = insert(:lesson, user: user)
370:       insert(:analysis, lesson: lesson, overall_score: 0.85)
371: 
372:       scores = Analysis.get_daily_scores(user.id, days: 7)
373: 
374:       # Should have at least today's entry
375:       assert is_list(scores)
376:     end
377: 
378:     test "get_bncc_coverage_detailed/2 includes category" do
379:       user = insert(:user)
380:       lesson = insert(:lesson, user: user)
381:       analysis = insert(:analysis, lesson: lesson)
382:       insert(:bncc_match, analysis: analysis, competencia_code: "EF05LP01")
383: 
384:       coverage = Analysis.get_bncc_coverage_detailed(user.id)
385: 
386:       # The extract_bncc_category function extracts first 2 uppercase letters (EF)
387:       refute Enum.empty?(coverage)
388:       assert hd(coverage).category == "EF"
389:     end
390: 
391:     test "list_analyses_for_export/2 returns analyses with all associations" do
392:       user = insert(:user)
393:       lesson = insert(:lesson, user: user)
394:       analysis = insert(:analysis, lesson: lesson)
395:       insert(:bncc_match, analysis: analysis)
396:       insert(:bullying_alert, analysis: analysis)
397: 
398:       analyses = Analysis.list_analyses_for_export(user.id)
399: 
400:       assert length(analyses) == 1
401:       exported = hd(analyses)
402:       assert exported.lesson != nil
403:       assert length(exported.bncc_matches) >= 0
404:     end
405:   end
406: end
````

## File: test/hellen/billing_test.exs
````elixir
  1: defmodule Hellen.BillingTest do
  2:   use Hellen.DataCase, async: true
  3: 
  4:   alias Hellen.Billing
  5: 
  6:   describe "credits" do
  7:     test "get_balance/1 returns user credits" do
  8:       user = insert(:user, credits: 50)
  9:       assert Billing.get_balance(user) == 50
 10:     end
 11: 
 12:     test "check_credits/1 returns :ok with sufficient credits" do
 13:       user = insert(:user, credits: 10)
 14:       assert Billing.check_credits(user) == :ok
 15:     end
 16: 
 17:     test "check_credits/1 returns error with insufficient credits" do
 18:       user = insert(:user, credits: 0)
 19:       assert Billing.check_credits(user) == {:error, :insufficient_credits}
 20:     end
 21: 
 22:     test "add_credits/4 adds credits to user" do
 23:       user = insert(:user, credits: 10)
 24:       assert {:ok, updated} = Billing.add_credits(user, 5, "gift")
 25:       assert updated.credits == 15
 26:     end
 27: 
 28:     test "add_credits/4 creates transaction record" do
 29:       user = insert(:user, credits: 10)
 30:       {:ok, _updated} = Billing.add_credits(user, 5, "purchase")
 31: 
 32:       transactions = Billing.list_transactions(user.id)
 33:       assert length(transactions) == 1
 34: 
 35:       transaction = hd(transactions)
 36:       assert transaction.amount == 5
 37:       assert transaction.balance_after == 15
 38:       assert transaction.reason == "purchase"
 39:     end
 40: 
 41:     test "deduct_credits/4 deducts credits from user" do
 42:       user = insert(:user, credits: 10)
 43:       assert {:ok, updated} = Billing.deduct_credits(user, 3, "lesson_analysis")
 44:       assert updated.credits == 7
 45:     end
 46: 
 47:     test "deduct_credits/4 returns error with insufficient credits" do
 48:       user = insert(:user, credits: 2)
 49:       assert {:error, :insufficient_credits} = Billing.deduct_credits(user, 5, "lesson_analysis")
 50:     end
 51: 
 52:     test "deduct_credits/4 creates transaction record" do
 53:       user = insert(:user, credits: 10)
 54:       {:ok, _updated} = Billing.deduct_credits(user, 3, "lesson_analysis")
 55: 
 56:       transactions = Billing.list_transactions(user.id)
 57:       transaction = hd(transactions)
 58: 
 59:       assert transaction.amount == -3
 60:       assert transaction.balance_after == 7
 61:       assert transaction.reason == "lesson_analysis"
 62:     end
 63: 
 64:     test "use_credit/2 deducts one credit for lesson" do
 65:       user = insert(:user, credits: 5)
 66:       lesson = insert(:lesson, user: user)
 67: 
 68:       assert {:ok, updated} = Billing.use_credit(user, lesson.id)
 69:       assert updated.credits == 4
 70:     end
 71: 
 72:     test "use_credit/2 returns error with zero credits" do
 73:       user = insert(:user, credits: 0)
 74:       lesson = insert(:lesson, user: user)
 75: 
 76:       assert {:error, :insufficient_credits} = Billing.use_credit(user, lesson.id)
 77:     end
 78: 
 79:     test "refund_credit/2 adds back one credit" do
 80:       user = insert(:user, credits: 5)
 81:       lesson = insert(:lesson, user: user)
 82: 
 83:       assert {:ok, updated} = Billing.refund_credit(user, lesson.id)
 84:       assert updated.credits == 6
 85:     end
 86: 
 87:     test "grant_signup_bonus/1 adds signup bonus credits" do
 88:       user = insert(:user, credits: 0)
 89:       assert {:ok, updated} = Billing.grant_signup_bonus(user)
 90:       assert updated.credits == 2
 91:     end
 92:   end
 93: 
 94:   describe "transactions" do
 95:     test "list_transactions/2 returns user transactions" do
 96:       user = insert(:user, credits: 20)
 97:       Billing.add_credits(user, 5, "gift")
 98:       Billing.add_credits(user, 10, "purchase")
 99: 
100:       transactions = Billing.list_transactions(user.id)
101:       assert length(transactions) == 2
102:     end
103: 
104:     test "list_transactions/2 orders by inserted_at desc" do
105:       user = insert(:user, credits: 20)
106:       Billing.add_credits(user, 5, "gift")
107:       # Sleep 1+ second since inserted_at is truncated to seconds
108:       :timer.sleep(1100)
109:       Billing.add_credits(user, 10, "purchase")
110: 
111:       [first, second] = Billing.list_transactions(user.id)
112:       # Most recent
113:       assert first.amount == 10
114:       assert second.amount == 5
115:     end
116: 
117:     test "list_transactions/2 respects limit" do
118:       user = insert(:user, credits: 50)
119:       for _ <- 1..5, do: Billing.add_credits(user, 1, "gift")
120: 
121:       transactions = Billing.list_transactions(user.id, limit: 3)
122:       assert length(transactions) == 3
123:     end
124: 
125:     test "list_transactions_filtered/2 filters by reason" do
126:       user = insert(:user, credits: 20)
127:       Billing.add_credits(user, 5, "gift")
128:       Billing.add_credits(user, 10, "purchase")
129: 
130:       {transactions, total} = Billing.list_transactions_filtered(user.id, reason: "gift")
131:       assert length(transactions) == 1
132:       assert total == 1
133:       assert hd(transactions).reason == "gift"
134:     end
135: 
136:     test "list_transactions_filtered/2 returns total count" do
137:       user = insert(:user, credits: 50)
138:       for _ <- 1..5, do: Billing.add_credits(user, 1, "gift")
139: 
140:       {transactions, total} = Billing.list_transactions_filtered(user.id, limit: 2)
141:       assert length(transactions) == 2
142:       assert total == 5
143:     end
144:   end
145: 
146:   describe "usage statistics" do
147:     test "get_usage_stats/2 returns usage statistics" do
148:       user = insert(:user, credits: 50)
149:       Billing.add_credits(user, 10, "purchase")
150:       user = Repo.get!(Hellen.Accounts.User, user.id)
151:       Billing.deduct_credits(user, 3, "lesson_analysis")
152: 
153:       stats = Billing.get_usage_stats(user.id, 30)
154: 
155:       assert stats.total_added == 10
156:       assert stats.total_used == 3
157:       assert stats.transaction_count == 2
158:       assert is_map(stats.by_reason)
159:     end
160: 
161:     test "get_daily_usage/2 returns daily breakdown" do
162:       user = insert(:user, credits: 20)
163:       Billing.add_credits(user, 5, "purchase")
164: 
165:       daily = Billing.get_daily_usage(user.id, 7)
166: 
167:       # Today + 7 previous days
168:       assert length(daily) == 8
169:       today = Date.utc_today()
170:       today_data = Enum.find(daily, &(&1.date == today))
171:       assert today_data.added == 5
172:     end
173: 
174:     test "get_analyses_count/1 returns lesson analysis count" do
175:       user = insert(:user, credits: 20)
176:       lesson1 = insert(:lesson, user: user)
177:       lesson2 = insert(:lesson, user: user)
178:       Billing.use_credit(user, lesson1.id)
179:       user = Repo.get!(Hellen.Accounts.User, user.id)
180:       Billing.use_credit(user, lesson2.id)
181: 
182:       count = Billing.get_analyses_count(user.id)
183:       assert count == 2
184:     end
185:   end
186: 
187:   describe "packages" do
188:     test "credit_packages/0 returns available packages" do
189:       packages = Billing.credit_packages()
190: 
191:       assert length(packages) == 3
192:       assert Enum.find(packages, &(&1.id == "basic"))
193:       assert Enum.find(packages, &(&1.id == "standard"))
194:       assert Enum.find(packages, &(&1.id == "pro"))
195:     end
196: 
197:     test "credit_packages/0 includes price information" do
198:       [basic | _] = Billing.credit_packages()
199: 
200:       assert basic.credits == 10
201:       assert basic.price == 2990
202:       assert basic.price_display == "R$ 29,90"
203:     end
204: 
205:     test "add_credits_with_stripe/4 adds credits with payment tracking" do
206:       user = insert(:user, credits: 10)
207:       {:ok, updated} = Billing.add_credits_with_stripe(user, 10, "basic", "pi_123456")
208:       assert updated.credits == 20
209: 
210:       [transaction] = Billing.list_transactions(user.id)
211:       assert transaction.reason == "purchase"
212:       assert transaction.stripe_payment_intent_id == "pi_123456"
213:     end
214:   end
215: end
````

## File: test/hellen/lessons_test.exs
````elixir
  1: defmodule Hellen.LessonsTest do
  2:   use Hellen.DataCase, async: true
  3: 
  4:   alias Hellen.Lessons
  5: 
  6:   describe "lessons" do
  7:     test "get_lesson!/1 returns lesson by id" do
  8:       lesson = insert(:lesson)
  9:       result = Lessons.get_lesson!(lesson.id)
 10:       assert result.id == lesson.id
 11:     end
 12: 
 13:     test "get_lesson!/1 raises for non-existent lesson" do
 14:       assert_raise Ecto.NoResultsError, fn ->
 15:         Lessons.get_lesson!(Ecto.UUID.generate())
 16:       end
 17:     end
 18: 
 19:     test "get_lesson!/2 returns lesson scoped to institution" do
 20:       institution = insert(:institution)
 21:       user = insert(:user, institution: institution)
 22:       lesson = insert(:lesson, user: user, institution: institution)
 23: 
 24:       result = Lessons.get_lesson!(lesson.id, institution.id)
 25:       assert result.id == lesson.id
 26:     end
 27: 
 28:     test "get_lesson!/2 raises when institution doesn't match" do
 29:       institution1 = insert(:institution)
 30:       institution2 = insert(:institution)
 31:       user = insert(:user, institution: institution1)
 32:       lesson = insert(:lesson, user: user, institution: institution1)
 33: 
 34:       assert_raise Ecto.NoResultsError, fn ->
 35:         Lessons.get_lesson!(lesson.id, institution2.id)
 36:       end
 37:     end
 38: 
 39:     test "get_lesson_with_transcription!/1 returns lesson with transcription" do
 40:       lesson = insert(:lesson)
 41:       insert(:transcription, lesson: lesson)
 42: 
 43:       result = Lessons.get_lesson_with_transcription!(lesson.id)
 44:       assert result.id == lesson.id
 45:       assert result.transcription != nil
 46:     end
 47: 
 48:     test "list_lessons_by_user/2 returns paginated lessons" do
 49:       user = insert(:user)
 50:       lesson1 = insert(:lesson, user: user)
 51:       lesson2 = insert(:lesson, user: user)
 52:       _other_lesson = insert(:lesson)
 53: 
 54:       lessons = Lessons.list_lessons_by_user(user.id)
 55:       lesson_ids = Enum.map(lessons, & &1.id)
 56: 
 57:       assert length(lessons) == 2
 58:       assert lesson1.id in lesson_ids
 59:       assert lesson2.id in lesson_ids
 60:     end
 61: 
 62:     test "list_lessons_by_user/2 respects limit and offset" do
 63:       user = insert(:user)
 64:       insert(:lesson, user: user)
 65:       insert(:lesson, user: user)
 66:       insert(:lesson, user: user)
 67: 
 68:       lessons = Lessons.list_lessons_by_user(user.id, limit: 2, offset: 1)
 69:       assert length(lessons) == 2
 70:     end
 71: 
 72:     test "list_lessons_by_institution/2 returns lessons for institution" do
 73:       institution = insert(:institution)
 74:       user = insert(:user, institution: institution)
 75:       lesson1 = insert(:lesson, user: user, institution: institution)
 76:       lesson2 = insert(:lesson, user: user, institution: institution)
 77: 
 78:       lessons = Lessons.list_lessons_by_institution(institution.id)
 79:       lesson_ids = Enum.map(lessons, & &1.id)
 80: 
 81:       assert length(lessons) == 2
 82:       assert lesson1.id in lesson_ids
 83:       assert lesson2.id in lesson_ids
 84:     end
 85: 
 86:     test "list_lessons_by_institution/2 filters by status" do
 87:       institution = insert(:institution)
 88:       user = insert(:user, institution: institution)
 89:       insert(:lesson, user: user, institution: institution, status: "pending")
 90:       insert(:lesson, user: user, institution: institution, status: "completed")
 91: 
 92:       pending = Lessons.list_lessons_by_institution(institution.id, status: "pending")
 93:       assert length(pending) == 1
 94:       assert hd(pending).status == "pending"
 95:     end
 96: 
 97:     test "list_lessons_by_institution/2 filters by subject" do
 98:       institution = insert(:institution)
 99:       user = insert(:user, institution: institution)
100:       insert(:lesson, user: user, institution: institution, subject: "Matematica")
101:       insert(:lesson, user: user, institution: institution, subject: "Portugues")
102: 
103:       math = Lessons.list_lessons_by_institution(institution.id, subject: "Matematica")
104:       assert length(math) == 1
105:       assert hd(math).subject == "Matematica"
106:     end
107: 
108:     test "create_lesson/2 creates lesson with valid data" do
109:       user = insert(:user, credits: 10)
110: 
111:       attrs = %{
112:         "title" => "Test Lesson",
113:         "subject" => "Matematica",
114:         "grade_level" => "5o ano"
115:       }
116: 
117:       assert {:ok, lesson} = Lessons.create_lesson(user, attrs)
118:       assert lesson.title == "Test Lesson"
119:       assert lesson.user_id == user.id
120:       assert lesson.institution_id == user.institution_id
121:     end
122: 
123:     test "create_lesson/2 returns error with insufficient credits" do
124:       user = insert(:user, credits: 0)
125:       attrs = %{"title" => "Test"}
126: 
127:       assert {:error, :insufficient_credits} = Lessons.create_lesson(user, attrs)
128:     end
129: 
130:     test "create_lesson/2 returns error without title" do
131:       user = insert(:user, credits: 10)
132:       attrs = %{"subject" => "Matematica"}
133: 
134:       assert {:error, changeset} = Lessons.create_lesson(user, attrs)
135:       assert "can't be blank" in errors_on(changeset).title
136:     end
137: 
138:     test "update_lesson/2 updates lesson with valid data" do
139:       lesson = insert(:lesson)
140:       assert {:ok, updated} = Lessons.update_lesson(lesson, %{title: "Updated Title"})
141:       assert updated.title == "Updated Title"
142:     end
143: 
144:     test "update_lesson_status/2 updates status" do
145:       lesson = insert(:lesson, status: "pending")
146:       assert {:ok, updated} = Lessons.update_lesson_status(lesson, "transcribing")
147:       assert updated.status == "transcribing"
148:     end
149: 
150:     test "update_lesson_status/2 rejects invalid status" do
151:       lesson = insert(:lesson)
152:       assert {:error, changeset} = Lessons.update_lesson_status(lesson, "invalid")
153:       assert "is invalid" in errors_on(changeset).status
154:     end
155: 
156:     test "delete_lesson/1 deletes lesson" do
157:       lesson = insert(:lesson)
158:       assert {:ok, _deleted} = Lessons.delete_lesson(lesson)
159:       assert_raise Ecto.NoResultsError, fn -> Lessons.get_lesson!(lesson.id) end
160:     end
161:   end
162: 
163:   describe "transcriptions" do
164:     test "get_transcription_by_lesson/1 returns transcription" do
165:       lesson = insert(:lesson)
166:       transcription = insert(:transcription, lesson: lesson)
167: 
168:       result = Lessons.get_transcription_by_lesson(lesson.id)
169:       assert result.id == transcription.id
170:     end
171: 
172:     test "get_transcription_by_lesson/1 returns nil if not found" do
173:       lesson = insert(:lesson)
174:       assert Lessons.get_transcription_by_lesson(lesson.id) == nil
175:     end
176: 
177:     test "create_transcription/2 creates transcription" do
178:       lesson = insert(:lesson)
179: 
180:       attrs = %{
181:         full_text: "Test transcription content",
182:         language: "pt-BR",
183:         confidence_score: 0.95
184:       }
185: 
186:       assert {:ok, transcription} = Lessons.create_transcription(lesson.id, attrs)
187:       assert transcription.full_text == "Test transcription content"
188:       assert transcription.lesson_id == lesson.id
189:       assert transcription.word_count == 3
190:     end
191: 
192:     test "create_transcription/2 computes word count" do
193:       lesson = insert(:lesson)
194: 
195:       attrs = %{
196:         full_text: "One two three four five six seven",
197:         language: "pt-BR"
198:       }
199: 
200:       assert {:ok, transcription} = Lessons.create_transcription(lesson.id, attrs)
201:       assert transcription.word_count == 7
202:     end
203:   end
204: 
205:   describe "statistics" do
206:     test "get_institution_stats/1 returns lesson statistics" do
207:       institution = insert(:institution)
208:       user = insert(:user, institution: institution)
209: 
210:       insert(:lesson,
211:         user: user,
212:         institution: institution,
213:         status: "pending",
214:         subject: "Ciencias"
215:       )
216: 
217:       insert(:lesson,
218:         user: user,
219:         institution: institution,
220:         status: "completed",
221:         subject: "Matematica"
222:       )
223: 
224:       insert(:lesson,
225:         user: user,
226:         institution: institution,
227:         status: "completed",
228:         subject: "Portugues"
229:       )
230: 
231:       stats = Lessons.get_institution_stats(institution.id)
232: 
233:       assert stats.total == 3
234:       assert stats.pending == 1
235:       assert stats.completed == 2
236:       assert stats.by_status["pending"] == 1
237:       assert stats.by_status["completed"] == 2
238:       assert stats.by_subject["Matematica"] == 1
239:       assert stats.by_subject["Portugues"] == 1
240:     end
241: 
242:     test "list_subjects/1 returns distinct subjects" do
243:       institution = insert(:institution)
244:       user = insert(:user, institution: institution)
245:       insert(:lesson, user: user, institution: institution, subject: "Matematica")
246:       insert(:lesson, user: user, institution: institution, subject: "Matematica")
247:       insert(:lesson, user: user, institution: institution, subject: "Portugues")
248: 
249:       subjects = Lessons.list_subjects(institution.id)
250: 
251:       assert length(subjects) == 2
252:       assert "Matematica" in subjects
253:       assert "Portugues" in subjects
254:     end
255:   end
256: end
````

## File: test/hellen/notifications_test.exs
````elixir
  1: defmodule Hellen.NotificationsTest do
  2:   use Hellen.DataCase, async: true
  3: 
  4:   alias Hellen.Notifications
  5: 
  6:   describe "notification CRUD" do
  7:     test "get_notification!/1 returns notification by id" do
  8:       notification = insert(:notification)
  9:       result = Notifications.get_notification!(notification.id)
 10:       assert result.id == notification.id
 11:     end
 12: 
 13:     test "get_notification!/1 raises for non-existent notification" do
 14:       assert_raise Ecto.NoResultsError, fn ->
 15:         Notifications.get_notification!(Ecto.UUID.generate())
 16:       end
 17:     end
 18: 
 19:     test "get_notification_with_user!/1 returns notification with user preloaded" do
 20:       notification = insert(:notification)
 21:       result = Notifications.get_notification_with_user!(notification.id)
 22:       assert result.id == notification.id
 23:       assert result.user != nil
 24:     end
 25: 
 26:     test "list_user_notifications/2 returns notifications for user" do
 27:       user = insert(:user)
 28:       insert(:notification, user: user)
 29:       insert(:notification, user: user)
 30:       # Different user
 31:       insert(:notification)
 32: 
 33:       notifications = Notifications.list_user_notifications(user.id)
 34:       assert length(notifications) == 2
 35:     end
 36: 
 37:     test "list_user_notifications/2 orders by inserted_at desc" do
 38:       user = insert(:user)
 39:       insert(:notification, user: user, title: "First")
 40:       # Need to sleep at least 1 second since inserted_at is truncated to seconds
 41:       :timer.sleep(1100)
 42:       insert(:notification, user: user, title: "Second")
 43: 
 44:       [first, second] = Notifications.list_user_notifications(user.id)
 45:       assert first.title == "Second"
 46:       assert second.title == "First"
 47:     end
 48: 
 49:     test "list_user_notifications/2 respects limit and offset" do
 50:       user = insert(:user)
 51:       for i <- 1..5, do: insert(:notification, user: user, title: "Notification #{i}")
 52: 
 53:       notifications = Notifications.list_user_notifications(user.id, limit: 2, offset: 1)
 54:       assert length(notifications) == 2
 55:     end
 56: 
 57:     test "list_user_notifications/2 can filter to unread only" do
 58:       user = insert(:user)
 59:       insert(:notification, user: user, read_at: nil)
 60:       insert(:notification, user: user, read_at: nil)
 61:       insert(:notification, user: user, read_at: DateTime.utc_now())
 62: 
 63:       unread = Notifications.list_user_notifications(user.id, unread_only: true)
 64:       assert length(unread) == 2
 65:     end
 66: 
 67:     test "count_unread/1 returns count of unread notifications" do
 68:       user = insert(:user)
 69:       insert(:notification, user: user, read_at: nil)
 70:       insert(:notification, user: user, read_at: nil)
 71:       insert(:notification, user: user, read_at: DateTime.utc_now())
 72: 
 73:       assert Notifications.count_unread(user.id) == 2
 74:     end
 75: 
 76:     test "mark_as_read/1 marks notification as read" do
 77:       notification = insert(:notification, read_at: nil)
 78:       assert {:ok, read_notification} = Notifications.mark_as_read(notification.id)
 79:       assert read_notification.read_at != nil
 80:     end
 81: 
 82:     test "mark_all_as_read/1 marks all notifications as read for user" do
 83:       user = insert(:user)
 84:       insert(:notification, user: user, read_at: nil)
 85:       insert(:notification, user: user, read_at: nil)
 86:       insert(:notification, user: user, read_at: nil)
 87: 
 88:       {count, _} = Notifications.mark_all_as_read(user.id)
 89:       assert count == 3
 90: 
 91:       assert Notifications.count_unread(user.id) == 0
 92:     end
 93: 
 94:     test "create_notification/1 creates notification with valid data" do
 95:       user = insert(:user)
 96:       institution = user.institution
 97: 
 98:       attrs = %{
 99:         user_id: user.id,
100:         institution_id: institution.id,
101:         type: "analysis_complete",
102:         title: "Test Notification",
103:         message: "Test message",
104:         data: %{"lesson_id" => Ecto.UUID.generate()}
105:       }
106: 
107:       assert {:ok, notification} = Notifications.create_notification(attrs)
108:       assert notification.title == "Test Notification"
109:       assert notification.type == "analysis_complete"
110:     end
111:   end
112: 
113:   describe "preferences" do
114:     test "get_or_create_preferences/1 creates preferences if not exists" do
115:       user = insert(:user)
116: 
117:       assert {:ok, preference} = Notifications.get_or_create_preferences(user.id)
118:       assert preference.user_id == user.id
119:       # Check default values
120:       assert preference.email_critical_alerts == true
121:     end
122: 
123:     test "get_or_create_preferences/1 returns existing preferences" do
124:       preference = insert(:notification_preference)
125: 
126:       assert {:ok, result} = Notifications.get_or_create_preferences(preference.user_id)
127:       assert result.id == preference.id
128:     end
129: 
130:     test "update_preferences/2 updates preferences" do
131:       preference = insert(:notification_preference, email_analysis_complete: false)
132: 
133:       assert {:ok, updated} =
134:                Notifications.update_preferences(
135:                  preference.user_id,
136:                  %{email_analysis_complete: true}
137:                )
138: 
139:       assert updated.email_analysis_complete == true
140:     end
141: 
142:     test "should_send_email?/2 checks preference for notification type" do
143:       preference =
144:         insert(:notification_preference,
145:           email_critical_alerts: true,
146:           email_analysis_complete: false
147:         )
148: 
149:       assert Notifications.should_send_email?(preference.user_id, "alert_critical") == true
150:       assert Notifications.should_send_email?(preference.user_id, "analysis_complete") == false
151:     end
152:   end
153: 
154:   describe "email" do
155:     test "mark_email_sent/1 marks notification email as sent" do
156:       notification = insert(:notification, email_sent_at: nil)
157: 
158:       assert {:ok, updated} = Notifications.mark_email_sent(notification)
159:       assert updated.email_sent_at != nil
160:     end
161:   end
162: end
````

## File: test/hellen_web/controllers/api/analysis_controller_test.exs
````elixir
 1: defmodule HellenWeb.API.AnalysisControllerTest do
 2:   use HellenWeb.ConnCase, async: true
 3: 
 4:   describe "GET /api/lessons/:lesson_id/analyses" do
 5:     setup :register_and_log_in_user
 6: 
 7:     test "returns analyses for a lesson", %{conn: conn, user: user} do
 8:       lesson = insert(:lesson, user: user, institution: user.institution)
 9:       insert(:analysis, lesson: lesson, institution: user.institution)
10:       insert(:analysis, lesson: lesson, institution: user.institution)
11: 
12:       conn = get(conn, ~p"/api/lessons/#{lesson.id}/analyses")
13:       response = json_response(conn, 200)
14: 
15:       assert length(response["data"]) == 2
16:     end
17: 
18:     test "returns empty list for lesson without analyses", %{conn: conn, user: user} do
19:       lesson = insert(:lesson, user: user, institution: user.institution)
20: 
21:       conn = get(conn, ~p"/api/lessons/#{lesson.id}/analyses")
22:       response = json_response(conn, 200)
23: 
24:       assert response["data"] == []
25:     end
26: 
27:     test "returns empty list for other user's lesson", %{conn: conn} do
28:       other_lesson = insert(:lesson)
29:       insert(:analysis, lesson: other_lesson, institution: other_lesson.institution)
30: 
31:       conn = get(conn, ~p"/api/lessons/#{other_lesson.id}/analyses")
32:       response = json_response(conn, 200)
33: 
34:       # Returns empty because institution doesn't match
35:       assert response["data"] == []
36:     end
37: 
38:     test "returns 401 without auth", %{conn: _conn} do
39:       lesson = insert(:lesson)
40:       conn = build_conn()
41:       conn = get(conn, ~p"/api/lessons/#{lesson.id}/analyses")
42:       assert json_response(conn, 401)
43:     end
44:   end
45: 
46:   describe "GET /api/analyses/:id" do
47:     setup :register_and_log_in_user
48: 
49:     test "returns analysis with BNCC matches and alerts", %{conn: conn, user: user} do
50:       lesson = insert(:lesson, user: user, institution: user.institution)
51:       analysis = insert(:analysis, lesson: lesson, institution: user.institution)
52:       insert(:bncc_match, analysis: analysis)
53:       insert(:bullying_alert, analysis: analysis)
54: 
55:       conn = get(conn, ~p"/api/analyses/#{analysis.id}")
56:       response = json_response(conn, 200)
57: 
58:       assert response["data"]["id"] == analysis.id
59:       assert length(response["data"]["bncc_matches"]) == 1
60:       assert length(response["data"]["bullying_alerts"]) == 1
61:     end
62: 
63:     test "returns 404 for non-existent analysis", %{conn: conn} do
64:       conn = get(conn, ~p"/api/analyses/#{Ecto.UUID.generate()}")
65:       assert json_response(conn, 404)
66:     end
67: 
68:     test "returns 404 for other user's analysis", %{conn: conn} do
69:       other_analysis = insert(:analysis)
70: 
71:       conn = get(conn, ~p"/api/analyses/#{other_analysis.id}")
72:       assert json_response(conn, 404)
73:     end
74: 
75:     test "returns 401 without auth", %{conn: _conn} do
76:       analysis = insert(:analysis)
77:       conn = build_conn()
78:       conn = get(conn, ~p"/api/analyses/#{analysis.id}")
79:       assert json_response(conn, 401)
80:     end
81:   end
82: end
````

## File: test/hellen_web/controllers/api/auth_controller_test.exs
````elixir
  1: defmodule HellenWeb.API.AuthControllerTest do
  2:   use HellenWeb.ConnCase, async: true
  3: 
  4:   describe "POST /api/auth/register" do
  5:     test "creates user with valid data", %{conn: conn} do
  6:       institution = insert(:institution)
  7: 
  8:       params = %{
  9:         "email" => "test@example.com",
 10:         "password" => "password123",
 11:         "name" => "Test User",
 12:         "institution_id" => institution.id
 13:       }
 14: 
 15:       conn = post(conn, ~p"/api/auth/register", params)
 16:       response = json_response(conn, 201)
 17: 
 18:       assert response["data"]["user"]["email"] == "test@example.com"
 19:       assert response["data"]["user"]["name"] == "Test User"
 20:       assert response["data"]["access_token"]
 21:       assert response["data"]["refresh_token"]
 22:     end
 23: 
 24:     test "returns error with invalid email", %{conn: conn} do
 25:       params = %{
 26:         "email" => "invalid-email",
 27:         "password" => "password123",
 28:         "name" => "Test User"
 29:       }
 30: 
 31:       conn = post(conn, ~p"/api/auth/register", params)
 32:       assert json_response(conn, 422)
 33:     end
 34: 
 35:     test "returns error with short password", %{conn: conn} do
 36:       params = %{
 37:         "email" => "test@example.com",
 38:         "password" => "short",
 39:         "name" => "Test User"
 40:       }
 41: 
 42:       conn = post(conn, ~p"/api/auth/register", params)
 43:       assert json_response(conn, 422)
 44:     end
 45: 
 46:     test "returns error with duplicate email", %{conn: conn} do
 47:       existing_user = insert(:user)
 48: 
 49:       params = %{
 50:         "email" => existing_user.email,
 51:         "password" => "password123",
 52:         "name" => "Test User"
 53:       }
 54: 
 55:       conn = post(conn, ~p"/api/auth/register", params)
 56:       assert json_response(conn, 422)
 57:     end
 58: 
 59:     test "returns error with missing required fields", %{conn: conn} do
 60:       conn = post(conn, ~p"/api/auth/register", %{})
 61:       response = json_response(conn, 400)
 62:       assert response["error"] =~ "Missing required fields"
 63:     end
 64:   end
 65: 
 66:   describe "POST /api/auth/login" do
 67:     test "returns token with valid credentials", %{conn: conn} do
 68:       user = insert(:user)
 69: 
 70:       params = %{
 71:         "email" => user.email,
 72:         "password" => "password123"
 73:       }
 74: 
 75:       conn = post(conn, ~p"/api/auth/login", params)
 76:       response = json_response(conn, 200)
 77: 
 78:       assert response["data"]["user"]["id"] == user.id
 79:       assert response["data"]["access_token"]
 80:       assert response["data"]["refresh_token"]
 81:     end
 82: 
 83:     test "returns error with invalid password", %{conn: conn} do
 84:       user = insert(:user)
 85: 
 86:       params = %{
 87:         "email" => user.email,
 88:         "password" => "wrong_password"
 89:       }
 90: 
 91:       conn = post(conn, ~p"/api/auth/login", params)
 92:       assert json_response(conn, 401)
 93:     end
 94: 
 95:     test "returns error with unknown email", %{conn: conn} do
 96:       params = %{
 97:         "email" => "nonexistent@example.com",
 98:         "password" => "password123"
 99:       }
100: 
101:       conn = post(conn, ~p"/api/auth/login", params)
102:       assert json_response(conn, 401)
103:     end
104: 
105:     test "returns error with missing credentials", %{conn: conn} do
106:       conn = post(conn, ~p"/api/auth/login", %{})
107:       response = json_response(conn, 400)
108:       assert response["error"] =~ "Missing email or password"
109:     end
110:   end
111: 
112:   describe "POST /api/auth/refresh" do
113:     test "returns new access token with valid refresh token", %{conn: conn} do
114:       user = insert(:user)
115:       {:ok, tokens} = Hellen.Auth.Guardian.generate_tokens(user)
116: 
117:       params = %{"refresh_token" => tokens.refresh_token}
118:       conn = post(conn, ~p"/api/auth/refresh", params)
119:       response = json_response(conn, 200)
120: 
121:       assert response["data"]["access_token"]
122:     end
123: 
124:     test "returns error with invalid refresh token", %{conn: conn} do
125:       params = %{"refresh_token" => "invalid_token"}
126:       conn = post(conn, ~p"/api/auth/refresh", params)
127:       assert json_response(conn, 401)
128:     end
129: 
130:     test "returns error without refresh token", %{conn: conn} do
131:       conn = post(conn, ~p"/api/auth/refresh", %{})
132:       response = json_response(conn, 400)
133:       assert response["error"] =~ "Missing refresh_token"
134:     end
135:   end
136: 
137:   describe "GET /api/auth/me" do
138:     setup :register_and_log_in_user
139: 
140:     test "returns current user with valid token", %{conn: conn, user: user} do
141:       conn = get(conn, ~p"/api/auth/me")
142:       response = json_response(conn, 200)
143: 
144:       assert response["data"]["user"]["id"] == user.id
145:       assert response["data"]["user"]["email"] == user.email
146:     end
147: 
148:     test "returns 401 without token", %{conn: _conn} do
149:       conn = build_conn()
150:       conn = get(conn, ~p"/api/auth/me")
151:       assert json_response(conn, 401)
152:     end
153:   end
154: 
155:   describe "POST /api/auth/firebase" do
156:     test "returns error without id_token", %{conn: conn} do
157:       conn = post(conn, ~p"/api/auth/firebase", %{})
158:       response = json_response(conn, 400)
159:       assert response["error"] =~ "Missing id_token"
160:     end
161:   end
162: end
````

## File: test/hellen_web/controllers/api/credit_controller_test.exs
````elixir
 1: defmodule HellenWeb.API.CreditControllerTest do
 2:   use HellenWeb.ConnCase, async: true
 3: 
 4:   alias Hellen.Billing
 5: 
 6:   describe "GET /api/credits" do
 7:     setup :register_and_log_in_user
 8: 
 9:     test "returns current credit balance", %{conn: conn, user: user} do
10:       conn = get(conn, ~p"/api/credits")
11:       response = json_response(conn, 200)
12: 
13:       assert response["data"]["credits"] == user.credits
14:     end
15: 
16:     test "returns updated balance after credit change", %{conn: conn, user: user} do
17:       # Add credits
18:       {:ok, _} = Billing.add_credits(user, 50, "gift")
19: 
20:       conn = get(conn, ~p"/api/credits")
21:       response = json_response(conn, 200)
22: 
23:       assert response["data"]["credits"] == user.credits + 50
24:     end
25: 
26:     test "returns 401 without auth", %{conn: _conn} do
27:       conn = build_conn()
28:       conn = get(conn, ~p"/api/credits")
29:       assert json_response(conn, 401)
30:     end
31:   end
32: 
33:   describe "GET /api/credits/history" do
34:     setup :register_and_log_in_user
35: 
36:     test "returns paginated transaction history", %{conn: conn, user: user} do
37:       Billing.add_credits(user, 10, "gift")
38:       Billing.add_credits(user, 20, "purchase")
39: 
40:       conn = get(conn, ~p"/api/credits/history")
41:       response = json_response(conn, 200)
42: 
43:       assert length(response["data"]) == 2
44:     end
45: 
46:     test "returns empty list for user without transactions", %{conn: conn} do
47:       conn = get(conn, ~p"/api/credits/history")
48:       response = json_response(conn, 200)
49: 
50:       assert response["data"] == []
51:     end
52: 
53:     test "respects limit parameter", %{conn: conn, user: user} do
54:       for _ <- 1..5, do: Billing.add_credits(user, 1, "gift")
55: 
56:       conn = get(conn, ~p"/api/credits/history?limit=3")
57:       response = json_response(conn, 200)
58: 
59:       assert length(response["data"]) == 3
60:     end
61: 
62:     test "returns 401 without auth", %{conn: _conn} do
63:       conn = build_conn()
64:       conn = get(conn, ~p"/api/credits/history")
65:       assert json_response(conn, 401)
66:     end
67:   end
68: end
````

## File: test/hellen_web/controllers/api/lesson_controller_test.exs
````elixir
  1: defmodule HellenWeb.API.LessonControllerTest do
  2:   use HellenWeb.ConnCase, async: true
  3: 
  4:   describe "GET /api/lessons" do
  5:     setup :register_and_log_in_user
  6: 
  7:     test "returns paginated lessons for authenticated user", %{conn: conn, user: user} do
  8:       insert(:lesson, user: user, institution: user.institution)
  9:       insert(:lesson, user: user, institution: user.institution)
 10: 
 11:       conn = get(conn, ~p"/api/lessons")
 12:       response = json_response(conn, 200)
 13: 
 14:       assert length(response["data"]) == 2
 15:     end
 16: 
 17:     test "only returns user's own lessons", %{conn: conn, user: user} do
 18:       insert(:lesson, user: user, institution: user.institution)
 19:       # Different user
 20:       insert(:lesson)
 21: 
 22:       conn = get(conn, ~p"/api/lessons")
 23:       response = json_response(conn, 200)
 24: 
 25:       assert length(response["data"]) == 1
 26:     end
 27: 
 28:     test "returns 401 without auth", %{conn: _conn} do
 29:       conn = build_conn()
 30:       conn = get(conn, ~p"/api/lessons")
 31:       assert json_response(conn, 401)
 32:     end
 33:   end
 34: 
 35:   describe "POST /api/lessons" do
 36:     setup :register_and_log_in_user
 37: 
 38:     test "creates lesson with valid data", %{conn: conn} do
 39:       params = %{
 40:         "lesson" => %{
 41:           "title" => "Test Lesson",
 42:           "subject" => "Matematica",
 43:           "grade_level" => "5o ano"
 44:         }
 45:       }
 46: 
 47:       conn = post(conn, ~p"/api/lessons", params)
 48:       response = json_response(conn, 201)
 49: 
 50:       assert response["data"]["title"] == "Test Lesson"
 51:       assert response["data"]["subject"] == "Matematica"
 52:     end
 53: 
 54:     test "returns error with missing required fields", %{conn: conn} do
 55:       params = %{
 56:         "lesson" => %{
 57:           "subject" => "Matematica"
 58:         }
 59:       }
 60: 
 61:       conn = post(conn, ~p"/api/lessons", params)
 62:       assert json_response(conn, 422)
 63:     end
 64: 
 65:     test "returns error with insufficient credits", %{conn: conn, user: user} do
 66:       # Update user to have 0 credits
 67:       Hellen.Repo.update!(Ecto.Changeset.change(user, credits: 0))
 68: 
 69:       params = %{
 70:         "lesson" => %{
 71:           "title" => "Test Lesson",
 72:           "subject" => "Matematica"
 73:         }
 74:       }
 75: 
 76:       conn = post(conn, ~p"/api/lessons", params)
 77:       # 402 Payment Required for insufficient credits
 78:       assert json_response(conn, 402)
 79:     end
 80: 
 81:     test "returns 401 without auth", %{conn: _conn} do
 82:       conn = build_conn()
 83:       conn = post(conn, ~p"/api/lessons", %{"lesson" => %{"title" => "Test"}})
 84:       assert json_response(conn, 401)
 85:     end
 86:   end
 87: 
 88:   describe "GET /api/lessons/:id" do
 89:     setup :register_and_log_in_user
 90: 
 91:     test "returns lesson with associations", %{conn: conn, user: user} do
 92:       lesson = insert(:lesson, user: user, institution: user.institution)
 93: 
 94:       conn = get(conn, ~p"/api/lessons/#{lesson.id}")
 95:       response = json_response(conn, 200)
 96: 
 97:       assert response["data"]["id"] == lesson.id
 98:       assert response["data"]["title"] == lesson.title
 99:     end
100: 
101:     test "returns 404 for non-existent lesson", %{conn: conn} do
102:       conn = get(conn, ~p"/api/lessons/#{Ecto.UUID.generate()}")
103:       assert json_response(conn, 404)
104:     end
105: 
106:     test "returns 404 for other user's lesson", %{conn: conn} do
107:       other_lesson = insert(:lesson)
108: 
109:       conn = get(conn, ~p"/api/lessons/#{other_lesson.id}")
110:       assert json_response(conn, 404)
111:     end
112:   end
113: 
114:   describe "PATCH /api/lessons/:id" do
115:     setup :register_and_log_in_user
116: 
117:     test "updates lesson with valid data", %{conn: conn, user: user} do
118:       lesson = insert(:lesson, user: user, institution: user.institution)
119: 
120:       params = %{
121:         "lesson" => %{
122:           "title" => "Updated Title"
123:         }
124:       }
125: 
126:       conn = patch(conn, ~p"/api/lessons/#{lesson.id}", params)
127:       response = json_response(conn, 200)
128: 
129:       assert response["data"]["title"] == "Updated Title"
130:     end
131: 
132:     test "returns 404 for other user's lesson", %{conn: conn} do
133:       other_lesson = insert(:lesson)
134: 
135:       params = %{
136:         "lesson" => %{
137:           "title" => "Updated Title"
138:         }
139:       }
140: 
141:       conn = patch(conn, ~p"/api/lessons/#{other_lesson.id}", params)
142:       assert json_response(conn, 404)
143:     end
144:   end
145: 
146:   describe "DELETE /api/lessons/:id" do
147:     setup :register_and_log_in_user
148: 
149:     test "deletes lesson", %{conn: conn, user: user} do
150:       lesson = insert(:lesson, user: user, institution: user.institution)
151: 
152:       conn = delete(conn, ~p"/api/lessons/#{lesson.id}")
153:       assert response(conn, 204)
154: 
155:       assert_raise Ecto.NoResultsError, fn ->
156:         Hellen.Lessons.get_lesson!(lesson.id)
157:       end
158:     end
159: 
160:     test "returns 404 for other user's lesson", %{conn: conn} do
161:       other_lesson = insert(:lesson)
162: 
163:       conn = delete(conn, ~p"/api/lessons/#{other_lesson.id}")
164:       assert json_response(conn, 404)
165:     end
166:   end
167: 
168:   describe "POST /api/lessons/:id/analyze" do
169:     setup :register_and_log_in_user
170: 
171:     test "returns 404 for other user's lesson", %{conn: conn} do
172:       other_lesson = insert(:lesson)
173: 
174:       conn = post(conn, ~p"/api/lessons/#{other_lesson.id}/analyze")
175:       assert json_response(conn, 404)
176:     end
177: 
178:     test "returns 401 without auth", %{conn: _conn} do
179:       lesson = insert(:lesson)
180:       conn = build_conn()
181:       conn = post(conn, ~p"/api/lessons/#{lesson.id}/analyze")
182:       assert json_response(conn, 401)
183:     end
184:   end
185: end
````

## File: test/test_helper.exs
````elixir
1: ExUnit.start()
2: Ecto.Adapters.SQL.Sandbox.mode(Hellen.Repo, :manual)
3: 
4: # Define mocks for behaviours
5: Mox.defmock(Hellen.AI.ClientMock, for: Hellen.AI.ClientBehaviour)
6: Mox.defmock(Hellen.Storage.Mock, for: Hellen.Storage.Behaviour)
````

## File: .env.example
````
 1: # Database
 2: DATABASE_URL=ecto://hellen:hellen_dev@localhost:5432/hellen_dev
 3: 
 4: # Redis
 5: REDIS_URL=redis://localhost:6379
 6: 
 7: # Qdrant
 8: QDRANT_URL=http://localhost:6333
 9: 
10: # NVIDIA NIM API
11: NVIDIA_API_KEY=nvapi-your-key-here
12: 
13: # Cloudflare R2
14: R2_ACCESS_KEY_ID=your-access-key
15: R2_SECRET_ACCESS_KEY=your-secret-key
16: R2_ENDPOINT=your-account-id.r2.cloudflarestorage.com
17: R2_BUCKET=hellen-uploads
18: 
19: # Phoenix
20: SECRET_KEY_BASE=generate-with-mix-phx-gen-secret
21: PHX_HOST=localhost
22: PORT=4000
````

## File: .formatter.exs
````elixir
1: [
2:   import_deps: [:ecto, :ecto_sql, :phoenix],
3:   subdirectories: ["priv/*/migrations"],
4:   plugins: [Phoenix.LiveView.HTMLFormatter],
5:   inputs: ["*.{heex,ex,exs}", "{config,lib,test}/**/*.{heex,ex,exs}", "priv/*/seeds.exs"]
6: ]
````

## File: CLAUDE.md
````markdown
  1: # CLAUDE.md
  2: 
  3: This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.
  4: 
  5: ## Build & Development Commands
  6: 
  7: ```bash
  8: # Start infrastructure (TimescaleDB, Redis, Qdrant)
  9: docker-compose up -d
 10: 
 11: # Install dependencies
 12: mix deps.get
 13: 
 14: # Setup database (create + migrate + seed)
 15: mix ecto.setup
 16: 
 17: # Start dev server (http://localhost:4000)
 18: mix phx.server
 19: 
 20: # Run tests
 21: mix test
 22: 
 23: # Run single test file
 24: mix test test/hellen/analysis_test.exs
 25: 
 26: # Run specific test by line
 27: mix test test/hellen/analysis_test.exs:42
 28: 
 29: # Format code
 30: mix format
 31: 
 32: # Check code quality
 33: mix credo
 34: 
 35: # Reset database
 36: mix ecto.reset
 37: 
 38: # Build assets
 39: mix assets.build
 40: ```
 41: 
 42: ## Architecture Overview
 43: 
 44: Hellen AI is a lesson analysis platform that transcribes audio recordings and provides pedagogical feedback based on Brazilian education standards (BNCC) and anti-bullying law (Lei 13.185).
 45: 
 46: ### Processing Pipeline
 47: 
 48: ```
 49: Audio Upload → Transcription Job → Analysis Job → Results
 50:      ↓              ↓                   ↓            ↓
 51:   R2 Storage    NVIDIA Parakeet     NVIDIA Qwen3   WebSocket
 52:                  (Whisper ASR)      (pedagogy AI)  broadcast
 53: ```
 54: 
 55: ### Core Contexts (lib/hellen/)
 56: 
 57: | Context | Purpose |
 58: |---------|---------|
 59: | `Accounts` | Users, institutions, Guardian JWT auth |
 60: | `Lessons` | Lessons, transcriptions, file management |
 61: | `Analysis` | Analyses, BNCC matches, bullying alerts |
 62: | `Billing` | Credit transactions (1 credit = 1 analysis) |
 63: 
 64: ### Background Jobs (Oban)
 65: 
 66: Jobs are in `lib/hellen/workers/` using queues configured in `config/config.exs`:
 67: - `transcription` queue (2 workers): `TranscriptionJob` - audio → text via NVIDIA Parakeet
 68: - `analysis` queue (3 workers): `AnalysisJob` - transcription → pedagogical feedback via Qwen3
 69: 
 70: Jobs broadcast progress to `lesson:#{lesson_id}` PubSub topic. Failed jobs auto-refund credits.
 71: 
 72: ### AI Integration
 73: 
 74: `Hellen.AI.NvidiaClient` wraps NVIDIA NIM API:
 75: - `transcribe/2` - Portuguese ASR using Parakeet
 76: - `analyze_pedagogy/2` - Structured JSON analysis with BNCC matching and bullying detection
 77: 
 78: ### API Structure
 79: 
 80: All API routes under `/api` (see `lib/hellen_web/router.ex`):
 81: - JSON views use `HellenWeb.API.*JSON` modules
 82: - Error handling via `FallbackController`
 83: - WebSocket channels in `lib/hellen_web/channels/` for real-time updates
 84: 
 85: ### Key Patterns
 86: 
 87: - Binary UUIDs for all primary keys (configured in `mix.exs`)
 88: - `with` chains for multi-step operations with error handling
 89: - PubSub broadcasts from workers: `Phoenix.PubSub.broadcast(Hellen.PubSub, topic, message)`
 90: - Preload associations explicitly: `Repo.preload(record, [:association])`
 91: 
 92: ## Environment
 93: 
 94: Required env vars (see `.env.example`):
 95: - `NVIDIA_API_KEY` - NVIDIA NIM API access
 96: - `DATABASE_URL` - TimescaleDB connection
 97: - `REDIS_URL` - Redis for caching
 98: - `R2_*` - Cloudflare R2 storage credentials
 99: 
100: ## AI Team Configuration (autogenerated by team-configurator, 2025-12-02)
101: 
102: **Important: YOU MUST USE subagents when available for the task.**
103: 
104: ### Detected Stack
105: 
106: - **Backend Framework**: Elixir 1.14+ with Phoenix 1.7.14
107: - **Database**: TimescaleDB (PostgreSQL 17) with Ecto 3.11
108: - **Frontend Build**: Tailwind CSS 3.4.3 + esbuild 0.17.11
109: - **Background Jobs**: Oban 2.17
110: - **Authentication**: Guardian 2.3 (JWT) + bcrypt
111: - **HTTP Client**: Req 0.5
112: - **Caching**: Redis (Redix 1.3)
113: - **Storage**: AWS S3-compatible (ExAws, targeting Cloudflare R2)
114: - **Vector DB**: Qdrant v1.12.3
115: - **PDF Generation**: ChromicPDF 1.15
116: - **Server**: Bandit 1.5
117: - **Real-time**: Phoenix Channels + PubSub
118: 
119: ### AI Team Assignments
120: 
121: | Task | Agent | Notes |
122: |------|-------|-------|
123: | Backend feature development | `backend-developer` | Phoenix/Elixir context-based architecture, Ecto schemas, business logic |
124: | API design & contracts | `api-architect` | REST endpoint design, JSON API structure, versioning |
125: | Code reviews & quality | `code-reviewer` | Security, maintainability, Elixir best practices |
126: | Performance optimization | `performance-optimizer` | Ecto query tuning, Oban job optimization, caching strategies |
127: | Codebase exploration | `code-archaeologist` | Understanding existing contexts, dependencies, patterns |
128: | Documentation updates | `documentation-specialist` | README, API docs, architecture guides |
129: | UI/UX styling | `tailwind-frontend-expert` | Tailwind utility classes, responsive design, LiveView components |
130: 
131: ### Usage Examples
132: 
133: ```bash
134: # Backend development
135: @backend-developer "Add credit refund logic to the Billing context"
136: 
137: # API design
138: @api-architect "Design a new endpoint for lesson filtering and pagination"
139: 
140: # Code review
141: @code-reviewer "Review the TranscriptionJob worker for security and error handling"
142: 
143: # Performance
144: @performance-optimizer "Analyze and optimize the lesson analysis pipeline"
145: 
146: # Explore codebase
147: @code-archaeologist "Map the authentication flow and identify security patterns"
148: 
149: # Documentation
150: @documentation-specialist "Update API documentation for the Analysis endpoints"
151: 
152: # Frontend styling
153: @tailwind-frontend-expert "Create a responsive lesson card component"
154: ```
````

## File: docker-compose.yml
````yaml
 1: services:
 2:   timescaledb:
 3:     image: timescale/timescaledb-ha:pg17
 4:     container_name: hellen-timescaledb
 5:     environment:
 6:       POSTGRES_USER: hellen
 7:       POSTGRES_PASSWORD: hellen_dev
 8:       POSTGRES_DB: hellen_dev
 9:     ports:
10:       - "5432:5432"
11:     volumes:
12:       - timescale_data:/home/postgres/pgdata/data
13:     healthcheck:
14:       test: ["CMD-SHELL", "pg_isready -U hellen -d hellen_dev"]
15:       interval: 10s
16:       timeout: 5s
17:       retries: 5
18: 
19:   redis:
20:     image: redis:latest
21:     container_name: hellen-redis
22:     ports:
23:       - "6379:6379"
24:     volumes:
25:       - redis_data:/data
26:     command: redis-server --appendonly yes
27:     healthcheck:
28:       test: ["CMD", "redis-cli", "ping"]
29:       interval: 10s
30:       timeout: 5s
31:       retries: 5
32: 
33:   qdrant:
34:     image: qdrant/qdrant:v1.12.3
35:     container_name: hellen-qdrant
36:     ports:
37:       - "6333:6333"
38:       - "6334:6334"
39:     volumes:
40:       - qdrant_data:/qdrant/storage
41:     environment:
42:       QDRANT__SERVICE__GRPC_PORT: 6334
43:     healthcheck:
44:       test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
45:       interval: 10s
46:       timeout: 5s
47:       retries: 5
48: 
49: volumes:
50:   timescale_data:
51:   redis_data:
52:   qdrant_data:
````

## File: README.md
````markdown
  1: # Hellen AI
  2: 
  3: AI-powered lesson analysis platform. Transcribes recorded lessons and provides pedagogical feedback based on BNCC and Lei 13.185 (Anti-bullying).
  4: 
  5: ## Features
  6: 
  7: - **Automatic Transcription**: Uses NVIDIA Whisper/Parakeet for accurate Portuguese transcription
  8: - **Pedagogical Analysis**: AI-powered analysis based on BNCC competencies
  9: - **Bullying Detection**: Identifies inappropriate behavior based on Lei 13.185
 10: - **Credit System**: Free users start with 2 credits, 1 credit = 1 lesson analysis
 11: - **Real-time Progress**: WebSocket updates during processing
 12: 
 13: ## Tech Stack
 14: 
 15: - **Backend**: Elixir/Phoenix 1.7
 16: - **Database**: TimescaleDB (PostgreSQL with time-series extensions)
 17: - **Cache**: Redis
 18: - **Vector DB**: Qdrant (for semantic search)
 19: - **AI**: NVIDIA NIM (Whisper, Qwen3)
 20: - **Job Queue**: Oban
 21: 
 22: ## Getting Started
 23: 
 24: ### Prerequisites
 25: 
 26: - Elixir 1.14+
 27: - Docker and Docker Compose
 28: - NVIDIA API key
 29: 
 30: ### Setup
 31: 
 32: 1. Clone and setup:
 33: ```bash
 34: cd hellen
 35: cp .env.example .env
 36: # Edit .env with your NVIDIA_API_KEY
 37: ```
 38: 
 39: 2. Start infrastructure:
 40: ```bash
 41: docker-compose up -d
 42: ```
 43: 
 44: 3. Install dependencies and setup database:
 45: ```bash
 46: mix deps.get
 47: mix ecto.setup
 48: ```
 49: 
 50: 4. Start the server:
 51: ```bash
 52: mix phx.server
 53: ```
 54: 
 55: Visit [`localhost:4000`](http://localhost:4000) to see the API.
 56: 
 57: ## API Endpoints
 58: 
 59: ### Auth
 60: - `POST /api/auth/register` - Register new user
 61: - `POST /api/auth/login` - Login
 62: - `GET /api/auth/me` - Get current user
 63: 
 64: ### Lessons
 65: - `GET /api/lessons` - List user's lessons
 66: - `POST /api/lessons` - Create new lesson
 67: - `GET /api/lessons/:id` - Get lesson details
 68: - `POST /api/lessons/:id/analyze` - Start analysis (uses 1 credit)
 69: 
 70: ### Analysis
 71: - `GET /api/lessons/:lesson_id/analyses` - List analyses for lesson
 72: - `GET /api/analyses/:id` - Get analysis details
 73: 
 74: ### Credits
 75: - `GET /api/credits` - Get credit balance
 76: - `GET /api/credits/history` - Get transaction history
 77: 
 78: ## Credit System
 79: 
 80: - Free users start with **2 credits**
 81: - Each lesson analysis costs **1 credit**
 82: - Credits never expire
 83: - Failed analyses are automatically refunded
 84: 
 85: ## Development
 86: 
 87: ```bash
 88: # Run tests
 89: mix test
 90: 
 91: # Format code
 92: mix format
 93: 
 94: # Check code quality
 95: mix credo
 96: ```
 97: 
 98: ## License
 99: 
100: MIT
````

## File: assets/js/hooks/scroll_animation.js
````javascript
 1: /**
 2:  * Scroll Animation Hook
 3:  * Animates elements as they enter the viewport using Intersection Observer
 4:  */
 5: export const ScrollAnimation = {
 6:   mounted() {
 7:     const observer = new IntersectionObserver(
 8:       (entries) => {
 9:         entries.forEach((entry) => {
10:           if (entry.isIntersecting) {
11:             entry.target.classList.add('animate-fade-in-up');
12:             entry.target.classList.remove('opacity-0', 'translate-y-8');
13:           }
14:         });
15:       },
16:       {
17:         threshold: 0.1,
18:         rootMargin: '0px 0px -50px 0px'
19:       }
20:     );
21: 
22:     // Find all elements with data-animate attribute
23:     this.el.querySelectorAll('[data-animate]').forEach((el) => {
24:       el.classList.add('opacity-0', 'translate-y-8', 'transition-all', 'duration-700');
25:       observer.observe(el);
26:     });
27: 
28:     this.observer = observer;
29:   },
30: 
31:   destroyed() {
32:     if (this.observer) {
33:       this.observer.disconnect();
34:     }
35:   }
36: };
37: 
38: /**
39:  * Theme Hook
40:  * Only initializes theme from localStorage - NO click handler
41:  * This hook should be placed on the page wrapper
42:  */
43: export const ThemeHook = {
44:   mounted() {
45:     // Initialize theme from localStorage or system preference
46:     const savedTheme = localStorage.getItem('theme');
47:     const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
48: 
49:     if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
50:       document.documentElement.classList.add('dark');
51:     } else {
52:       document.documentElement.classList.remove('dark');
53:     }
54:   }
55: };
56: 
57: /**
58:  * Theme Toggle Hook
59:  * Handles click to toggle theme - use this on the toggle button
60:  */
61: export const ThemeToggle = {
62:   mounted() {
63:     this.el.addEventListener('click', (e) => {
64:       e.preventDefault();
65:       e.stopPropagation();
66: 
67:       const html = document.documentElement;
68:       const isDark = html.classList.contains('dark');
69: 
70:       if (isDark) {
71:         html.classList.remove('dark');
72:         localStorage.setItem('theme', 'light');
73:       } else {
74:         html.classList.add('dark');
75:         localStorage.setItem('theme', 'dark');
76:       }
77:     });
78:   }
79: };
````

## File: assets/js/hooks/sidebar.js
````javascript
  1: /**
  2:  * Sidebar Hook
  3:  * Handles sidebar functionality:
  4:  * - Collapse/expand state persistence
  5:  * - Mobile drawer behavior with swipe gestures
  6:  * - Keyboard shortcuts
  7:  * - Smooth animations
  8:  */
  9: export const SidebarHook = {
 10:   mounted() {
 11:     this.sidebar = this.el
 12:     this.overlay = document.getElementById('sidebar-overlay')
 13:     this.collapsed = localStorage.getItem('sidebar-collapsed') === 'true'
 14:     this.isMobile = window.innerWidth < 1024
 15:     this.isOpen = false
 16: 
 17:     // Touch tracking for swipe gestures
 18:     this.touchStartX = 0
 19:     this.touchStartY = 0
 20:     this.touchCurrentX = 0
 21:     this.isDragging = false
 22:     this.swipeThreshold = 100 // Minimum distance to trigger swipe
 23: 
 24:     // Apply saved state
 25:     if (this.collapsed && !this.isMobile) {
 26:       this.collapse()
 27:     }
 28: 
 29:     // Handle resize events for responsive behavior
 30:     this.handleResize = this.handleResize.bind(this)
 31:     window.addEventListener('resize', this.handleResize)
 32: 
 33:     // Handle escape key to close mobile sidebar
 34:     this.handleKeydown = this.handleKeydown.bind(this)
 35:     document.addEventListener('keydown', this.handleKeydown)
 36: 
 37:     // Setup swipe gestures for mobile
 38:     this.setupSwipeGestures()
 39:   },
 40: 
 41:   destroyed() {
 42:     window.removeEventListener('resize', this.handleResize)
 43:     document.removeEventListener('keydown', this.handleKeydown)
 44:     this.removeSwipeGestures()
 45:   },
 46: 
 47:   setupSwipeGestures() {
 48:     // Swipe from left edge to open sidebar
 49:     this.handleTouchStart = this.handleTouchStart.bind(this)
 50:     this.handleTouchMove = this.handleTouchMove.bind(this)
 51:     this.handleTouchEnd = this.handleTouchEnd.bind(this)
 52: 
 53:     document.addEventListener('touchstart', this.handleTouchStart, { passive: true })
 54:     document.addEventListener('touchmove', this.handleTouchMove, { passive: false })
 55:     document.addEventListener('touchend', this.handleTouchEnd, { passive: true })
 56: 
 57:     // Also handle swipe on sidebar itself to close
 58:     this.sidebar.addEventListener('touchstart', this.handleSidebarTouchStart.bind(this), { passive: true })
 59:     this.sidebar.addEventListener('touchmove', this.handleSidebarTouchMove.bind(this), { passive: false })
 60:     this.sidebar.addEventListener('touchend', this.handleSidebarTouchEnd.bind(this), { passive: true })
 61:   },
 62: 
 63:   removeSwipeGestures() {
 64:     document.removeEventListener('touchstart', this.handleTouchStart)
 65:     document.removeEventListener('touchmove', this.handleTouchMove)
 66:     document.removeEventListener('touchend', this.handleTouchEnd)
 67:   },
 68: 
 69:   handleTouchStart(e) {
 70:     if (!this.isMobile) return
 71: 
 72:     const touch = e.touches[0]
 73:     this.touchStartX = touch.clientX
 74:     this.touchStartY = touch.clientY
 75: 
 76:     // Only trigger if starting from left edge (within 30px)
 77:     if (touch.clientX <= 30 && !this.isOpen) {
 78:       this.isDragging = true
 79:       this.sidebar.style.transition = 'none'
 80:     }
 81:   },
 82: 
 83:   handleTouchMove(e) {
 84:     if (!this.isDragging || !this.isMobile) return
 85: 
 86:     const touch = e.touches[0]
 87:     this.touchCurrentX = touch.clientX
 88:     const deltaX = this.touchCurrentX - this.touchStartX
 89:     const deltaY = Math.abs(touch.clientY - this.touchStartY)
 90: 
 91:     // Only handle horizontal swipes
 92:     if (deltaY > Math.abs(deltaX)) {
 93:       this.isDragging = false
 94:       return
 95:     }
 96: 
 97:     e.preventDefault()
 98: 
 99:     // Calculate sidebar position (clamped between -256px and 0)
100:     const sidebarWidth = 256
101:     const translateX = Math.min(0, Math.max(-sidebarWidth, deltaX - sidebarWidth))
102: 
103:     this.sidebar.style.transform = `translateX(${translateX}px)`
104: 
105:     // Show overlay proportionally
106:     const progress = (translateX + sidebarWidth) / sidebarWidth
107:     if (this.overlay) {
108:       this.overlay.classList.remove('hidden')
109:       this.overlay.style.opacity = progress * 0.6
110:     }
111:   },
112: 
113:   handleTouchEnd(e) {
114:     if (!this.isDragging || !this.isMobile) return
115: 
116:     this.sidebar.style.transition = ''
117:     const deltaX = this.touchCurrentX - this.touchStartX
118: 
119:     if (deltaX >= this.swipeThreshold) {
120:       this.openMobile()
121:     } else {
122:       this.closeMobile()
123:     }
124: 
125:     this.isDragging = false
126:     this.sidebar.style.transform = ''
127:   },
128: 
129:   handleSidebarTouchStart(e) {
130:     if (!this.isMobile || !this.isOpen) return
131: 
132:     const touch = e.touches[0]
133:     this.sidebarTouchStartX = touch.clientX
134:   },
135: 
136:   handleSidebarTouchMove(e) {
137:     if (!this.isMobile || !this.isOpen) return
138: 
139:     const touch = e.touches[0]
140:     const deltaX = this.sidebarTouchStartX - touch.clientX
141: 
142:     if (deltaX > 0) {
143:       e.preventDefault()
144:       const sidebarWidth = 256
145:       const translateX = Math.max(-sidebarWidth, -deltaX)
146:       this.sidebar.style.transition = 'none'
147:       this.sidebar.style.transform = `translateX(${translateX}px)`
148: 
149:       // Fade overlay
150:       const progress = 1 - Math.abs(translateX) / sidebarWidth
151:       if (this.overlay) {
152:         this.overlay.style.opacity = progress * 0.6
153:       }
154:     }
155:   },
156: 
157:   handleSidebarTouchEnd(e) {
158:     if (!this.isMobile || !this.isOpen) return
159: 
160:     this.sidebar.style.transition = ''
161:     const rect = this.sidebar.getBoundingClientRect()
162: 
163:     if (rect.left < -100) {
164:       this.closeMobile()
165:     } else {
166:       this.sidebar.style.transform = ''
167:       if (this.overlay) {
168:         this.overlay.style.opacity = ''
169:       }
170:     }
171:   },
172: 
173:   openMobile() {
174:     this.sidebar.classList.remove('-translate-x-full')
175:     if (this.overlay) {
176:       this.overlay.classList.remove('hidden')
177:       this.overlay.style.opacity = ''
178:     }
179:     this.isOpen = true
180:     document.body.style.overflow = 'hidden'
181:   },
182: 
183:   closeMobile() {
184:     this.sidebar.classList.add('-translate-x-full')
185:     if (this.overlay) {
186:       this.overlay.classList.add('hidden')
187:       this.overlay.style.opacity = ''
188:     }
189:     this.isOpen = false
190:     document.body.style.overflow = ''
191:     this.sidebar.style.transform = ''
192:   },
193: 
194:   collapse() {
195:     this.sidebar.classList.add('sidebar-collapsed')
196:     document.body.classList.add('sidebar-collapsed')
197:     localStorage.setItem('sidebar-collapsed', 'true')
198:     this.collapsed = true
199:   },
200: 
201:   expand() {
202:     this.sidebar.classList.remove('sidebar-collapsed')
203:     document.body.classList.remove('sidebar-collapsed')
204:     localStorage.setItem('sidebar-collapsed', 'false')
205:     this.collapsed = false
206:   },
207: 
208:   toggle() {
209:     if (this.collapsed) {
210:       this.expand()
211:     } else {
212:       this.collapse()
213:     }
214:   },
215: 
216:   handleResize() {
217:     const wasMobile = this.isMobile
218:     this.isMobile = window.innerWidth < 1024
219: 
220:     // Transitioning from mobile to desktop
221:     if (wasMobile && !this.isMobile && this.isOpen) {
222:       this.closeMobile()
223:     }
224: 
225:     // Auto-collapse on tablet sizes
226:     if (window.innerWidth < 1024 && window.innerWidth >= 768) {
227:       if (!this.collapsed) {
228:         this.collapse()
229:       }
230:     }
231:   },
232: 
233:   handleKeydown(e) {
234:     // Escape key closes mobile sidebar
235:     if (e.key === 'Escape' && this.isOpen) {
236:       this.closeMobile()
237:     }
238:   }
239: }
240: 
241: /**
242:  * Search Modal Hook
243:  * Handles global search functionality:
244:  * - Cmd+K / Ctrl+K shortcut
245:  * - Escape to close
246:  * - Focus management
247:  * - Search as you type
248:  */
249: export const SearchModal = {
250:   mounted() {
251:     this.modal = this.el
252:     this.input = document.getElementById('search-input')
253:     this.results = document.getElementById('search-results')
254:     this.isOpen = false
255:     this.searchTimeout = null
256: 
257:     // Keyboard shortcut for opening search
258:     this.handleKeydown = this.handleKeydown.bind(this)
259:     document.addEventListener('keydown', this.handleKeydown)
260: 
261:     // Custom event for opening search from sidebar button
262:     this.handleOpenSearch = this.handleOpenSearch.bind(this)
263:     window.addEventListener('open-search', this.handleOpenSearch)
264: 
265:     // Input handling
266:     if (this.input) {
267:       this.input.addEventListener('input', (e) => this.handleSearch(e.target.value))
268:     }
269: 
270:     // Close on overlay click
271:     const overlay = this.modal.querySelector('[aria-hidden="true"]')
272:     if (overlay) {
273:       overlay.addEventListener('click', () => this.close())
274:     }
275:   },
276: 
277:   destroyed() {
278:     document.removeEventListener('keydown', this.handleKeydown)
279:     window.removeEventListener('open-search', this.handleOpenSearch)
280:   },
281: 
282:   handleKeydown(e) {
283:     // Cmd+K or Ctrl+K to open search
284:     if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
285:       e.preventDefault()
286:       this.toggle()
287:     }
288: 
289:     // Escape to close
290:     if (e.key === 'Escape' && this.isOpen) {
291:       e.preventDefault()
292:       this.close()
293:     }
294:   },
295: 
296:   handleOpenSearch() {
297:     this.open()
298:   },
299: 
300:   toggle() {
301:     if (this.isOpen) {
302:       this.close()
303:     } else {
304:       this.open()
305:     }
306:   },
307: 
308:   open() {
309:     this.modal.classList.remove('hidden')
310:     this.isOpen = true
311: 
312:     // Focus input after animation
313:     setTimeout(() => {
314:       if (this.input) {
315:         this.input.focus()
316:         this.input.select()
317:       }
318:     }, 100)
319: 
320:     // Add animation class
321:     this.modal.classList.add('animate-fade-in')
322: 
323:     // Prevent body scroll
324:     document.body.style.overflow = 'hidden'
325:   },
326: 
327:   close() {
328:     this.modal.classList.add('hidden')
329:     this.modal.classList.remove('animate-fade-in')
330:     this.isOpen = false
331: 
332:     // Clear input
333:     if (this.input) {
334:       this.input.value = ''
335:     }
336: 
337:     // Reset results
338:     this.resetResults()
339: 
340:     // Restore body scroll
341:     document.body.style.overflow = ''
342:   },
343: 
344:   handleSearch(query) {
345:     // Debounce search
346:     clearTimeout(this.searchTimeout)
347: 
348:     if (!query || query.length < 2) {
349:       this.resetResults()
350:       return
351:     }
352: 
353:     this.searchTimeout = setTimeout(() => {
354:       // Show loading state
355:       this.showLoading()
356: 
357:       // Push event to LiveView for server-side search
358:       this.pushEvent('global_search', { query }, (reply) => {
359:         this.renderResults(reply.results || [])
360:       })
361:     }, 300)
362:   },
363: 
364:   showLoading() {
365:     if (this.results) {
366:       this.results.innerHTML = `
367:         <div class="px-3 py-8 text-center">
368:           <div class="inline-flex items-center gap-2 text-slate-400">
369:             <svg class="h-5 w-5 animate-spin" fill="none" viewBox="0 0 24 24">
370:               <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
371:               <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
372:             </svg>
373:             <span class="text-sm">Buscando...</span>
374:           </div>
375:         </div>
376:       `
377:     }
378:   },
379: 
380:   resetResults() {
381:     if (this.results) {
382:       this.results.innerHTML = `
383:         <div class="px-3 py-8 text-center text-slate-400">
384:           <svg class="h-12 w-12 mx-auto mb-3 text-slate-300 dark:text-slate-600" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor">
385:             <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
386:           </svg>
387:           <p class="text-sm">Digite para buscar...</p>
388:         </div>
389:       `
390:     }
391:   },
392: 
393:   renderResults(results) {
394:     if (!this.results) return
395: 
396:     if (results.length === 0) {
397:       this.results.innerHTML = `
398:         <div class="px-3 py-8 text-center text-slate-400">
399:           <svg class="h-12 w-12 mx-auto mb-3 text-slate-300 dark:text-slate-600" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor">
400:             <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
401:           </svg>
402:           <p class="text-sm">Nenhum resultado encontrado</p>
403:         </div>
404:       `
405:       return
406:     }
407: 
408:     const html = results.map(result => `
409:       <a
410:         href="${result.url}"
411:         class="flex items-center gap-3 px-3 py-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors group"
412:       >
413:         <div class="flex-shrink-0 w-10 h-10 rounded-lg ${this.getTypeColor(result.type)} flex items-center justify-center">
414:           ${this.getTypeIcon(result.type)}
415:         </div>
416:         <div class="flex-1 min-w-0">
417:           <p class="text-sm font-medium text-slate-900 dark:text-white truncate group-hover:text-teal-600 dark:group-hover:text-teal-400 transition-colors">
418:             ${result.title}
419:           </p>
420:           <p class="text-xs text-slate-500 dark:text-slate-400 truncate">
421:             ${result.subtitle || ''}
422:           </p>
423:         </div>
424:         <svg class="h-4 w-4 text-slate-400 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
425:           <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
426:         </svg>
427:       </a>
428:     `).join('')
429: 
430:     this.results.innerHTML = html
431:   },
432: 
433:   getTypeColor(type) {
434:     const colors = {
435:       lesson: 'bg-teal-500/10 dark:bg-teal-500/20',
436:       analysis: 'bg-sage-500/10 dark:bg-sage-500/20',
437:       alert: 'bg-violet-500/10 dark:bg-violet-500/20',
438:       user: 'bg-ochre-500/10 dark:bg-ochre-500/20'
439:     }
440:     return colors[type] || 'bg-slate-100 dark:bg-slate-800'
441:   },
442: 
443:   getTypeIcon(type) {
444:     const icons = {
445:       lesson: `<svg class="h-5 w-5 text-teal-600 dark:text-teal-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
446:         <path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.436 60.436 0 00-.491 6.347A48.627 48.627 0 0112 20.904a48.627 48.627 0 018.232-4.41 60.46 60.46 0 00-.491-6.347m-15.482 0a50.57 50.57 0 00-2.658-.813A59.905 59.905 0 0112 3.493a59.902 59.902 0 0110.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0112 13.489a50.702 50.702 0 017.74-3.342M6.75 15a.75.75 0 100-1.5.75.75 0 000 1.5zm0 0v-3.675A55.378 55.378 0 0112 8.443m-7.007 11.55A5.981 5.981 0 006.75 15.75v-1.5" />
447:       </svg>`,
448:       analysis: `<svg class="h-5 w-5 text-sage-600 dark:text-sage-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
449:         <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 3m8.5-3l1 3m0 0l.5 1.5m-.5-1.5h-9.5m0 0l-.5 1.5M9 11.25v1.5M12 9v3.75m3-6v6" />
450:       </svg>`,
451:       alert: `<svg class="h-5 w-5 text-violet-600 dark:text-violet-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
452:         <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" />
453:       </svg>`,
454:       user: `<svg class="h-5 w-5 text-ochre-600 dark:text-ochre-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
455:         <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
456:       </svg>`
457:     }
458:     return icons[type] || icons.lesson
459:   }
460: }
````

## File: config/prod.exs
````elixir
 1: import Config
 2: 
 3: # Note we also include the path to a cache manifest
 4: # containing the digested version of static files. This
 5: # manifest is generated by the `mix assets.deploy` task,
 6: # which you should run after static files are built and
 7: # before starting your production server.
 8: config :hellen, HellenWeb.Endpoint, cache_static_manifest: "priv/static/cache_manifest.json"
 9: 
10: # Database connection pool tuning for production
11: # These are defaults that can be overridden via DATABASE_URL or runtime.exs
12: config :hellen, Hellen.Repo,
13:   pool_size: 20,
14:   queue_target: 500,
15:   queue_interval: 1000
16: 
17: # Configures Swoosh API Client
18: config :swoosh, api_client: Swoosh.ApiClient.Finch, finch_name: Hellen.Finch
19: 
20: # Disable Swoosh Local Memory Storage
21: config :swoosh, local: false
22: 
23: # Do not print debug messages in production
24: config :logger, level: :info
25: 
26: # Runtime production configuration, including reading
27: # of environment variables, is done on config/runtime.exs.
````

## File: lib/hellen/analysis/analysis.ex
````elixir
 1: defmodule Hellen.Analysis.Analysis do
 2:   @moduledoc """
 3:   Schema for pedagogical analyses with overall score, BNCC matches, and bullying alerts.
 4:   """
 5:   use Ecto.Schema
 6:   import Ecto.Changeset
 7: 
 8:   @primary_key {:id, :binary_id, autogenerate: true}
 9:   @foreign_key_type :binary_id
10: 
11:   schema "analyses" do
12:     field :analysis_type, :string
13:     field :model_used, :string
14:     field :raw_response, :map
15:     field :result, :map
16:     field :overall_score, :float
17:     field :processing_time_ms, :integer
18:     field :tokens_used, :integer
19: 
20:     belongs_to :lesson, Hellen.Lessons.Lesson
21:     belongs_to :institution, Hellen.Accounts.Institution
22:     has_many :bncc_matches, Hellen.Analysis.BnccMatch
23:     has_many :bullying_alerts, Hellen.Analysis.BullyingAlert
24: 
25:     timestamps(type: :utc_datetime, updated_at: false)
26:   end
27: 
28:   @analysis_types ["full", "bncc", "bullying", "engagement", "time_management"]
29: 
30:   @doc false
31:   def changeset(analysis, attrs) do
32:     analysis
33:     |> cast(attrs, [
34:       :analysis_type,
35:       :model_used,
36:       :raw_response,
37:       :result,
38:       :overall_score,
39:       :processing_time_ms,
40:       :tokens_used,
41:       :lesson_id,
42:       :institution_id
43:     ])
44:     |> validate_required([:analysis_type, :lesson_id])
45:     |> validate_inclusion(:analysis_type, @analysis_types)
46:     |> validate_number(:overall_score, greater_than_or_equal_to: 0, less_than_or_equal_to: 1)
47:     |> foreign_key_constraint(:lesson_id)
48:     |> foreign_key_constraint(:institution_id)
49:   end
50: end
````

## File: lib/hellen/analysis/bullying_alert.ex
````elixir
 1: defmodule Hellen.Analysis.BullyingAlert do
 2:   @moduledoc """
 3:   Schema for bullying alerts detected during lesson analysis (Lei 13.185/2015).
 4:   """
 5:   use Ecto.Schema
 6:   import Ecto.Changeset
 7: 
 8:   @primary_key {:id, :binary_id, autogenerate: true}
 9:   @foreign_key_type :binary_id
10: 
11:   schema "bullying_alerts" do
12:     field :severity, :string
13:     field :alert_type, :string
14:     field :description, :string
15:     field :evidence_text, :string
16:     field :timestamp_start, :float
17:     field :timestamp_end, :float
18:     field :reviewed, :boolean, default: false
19:     field :reviewed_at, :utc_datetime
20: 
21:     belongs_to :analysis, Hellen.Analysis.Analysis
22:     belongs_to :reviewed_by, Hellen.Accounts.User
23: 
24:     timestamps(type: :utc_datetime, updated_at: false)
25:   end
26: 
27:   @severities ["low", "medium", "high", "critical"]
28:   @alert_types [
29:     "verbal_aggression",
30:     "exclusion",
31:     "intimidation",
32:     "mockery",
33:     "discrimination",
34:     "threat",
35:     "inappropriate_language",
36:     "other"
37:   ]
38: 
39:   @doc false
40:   def changeset(bullying_alert, attrs) do
41:     bullying_alert
42:     |> cast(attrs, [
43:       :severity,
44:       :alert_type,
45:       :description,
46:       :evidence_text,
47:       :timestamp_start,
48:       :timestamp_end,
49:       :reviewed,
50:       :reviewed_at,
51:       :analysis_id,
52:       :reviewed_by_id
53:     ])
54:     |> validate_required([:severity, :alert_type, :analysis_id])
55:     |> validate_inclusion(:severity, @severities)
56:     |> validate_inclusion(:alert_type, @alert_types)
57:     |> foreign_key_constraint(:analysis_id)
58:   end
59: 
60:   def review_changeset(alert, reviewer_id) do
61:     alert
62:     |> change(
63:       reviewed: true,
64:       reviewed_at: DateTime.utc_now() |> DateTime.truncate(:second),
65:       reviewed_by_id: reviewer_id
66:     )
67:   end
68: end
````

## File: lib/hellen/auth/guardian.ex
````elixir
 1: defmodule Hellen.Auth.Guardian do
 2:   @moduledoc """
 3:   Guardian implementation for JWT token management.
 4: 
 5:   Used to generate and verify local JWT tokens after Firebase authentication.
 6:   """
 7: 
 8:   use Guardian, otp_app: :hellen
 9: 
10:   alias Hellen.Accounts
11:   alias Hellen.Accounts.User
12: 
13:   @doc """
14:   Returns the subject for the token (user ID).
15:   """
16:   def subject_for_token(%User{id: id}, _claims) do
17:     {:ok, to_string(id)}
18:   end
19: 
20:   def subject_for_token(_, _) do
21:     {:error, :invalid_resource}
22:   end
23: 
24:   @doc """
25:   Retrieves the user from the token claims.
26:   """
27:   def resource_from_claims(%{"sub" => id}) do
28:     case Accounts.get_user(id) do
29:       nil -> {:error, :user_not_found}
30:       user -> {:ok, user}
31:     end
32:   end
33: 
34:   def resource_from_claims(_claims) do
35:     {:error, :invalid_claims}
36:   end
37: 
38:   @doc """
39:   Generates access and refresh tokens for a user.
40:   """
41:   def generate_tokens(user) do
42:     with {:ok, access_token, _claims} <-
43:            encode_and_sign(user, %{}, token_type: "access", ttl: {1, :hour}),
44:          {:ok, refresh_token, _claims} <-
45:            encode_and_sign(user, %{}, token_type: "refresh", ttl: {7, :day}) do
46:       {:ok, %{access_token: access_token, refresh_token: refresh_token}}
47:     end
48:   end
49: 
50:   @doc """
51:   Refreshes an access token using a refresh token.
52:   """
53:   def refresh_access_token(refresh_token) do
54:     with {:ok, claims} <- decode_and_verify(refresh_token),
55:          {:ok, user} <- resource_from_claims(claims) do
56:       encode_and_sign(user, %{}, token_type: "access", ttl: {1, :hour})
57:     end
58:   end
59: end
````

## File: lib/hellen/billing/credit_transaction.ex
````elixir
 1: defmodule Hellen.Billing.CreditTransaction do
 2:   @moduledoc """
 3:   Schema for credit transactions tracking usage and purchases.
 4:   """
 5:   use Ecto.Schema
 6:   import Ecto.Changeset
 7: 
 8:   @primary_key {:id, :binary_id, autogenerate: true}
 9:   @foreign_key_type :binary_id
10: 
11:   schema "credit_transactions" do
12:     field :amount, :integer
13:     field :balance_after, :integer
14:     field :reason, :string
15:     field :metadata, :map, default: %{}
16:     field :stripe_payment_intent_id, :string
17: 
18:     belongs_to :user, Hellen.Accounts.User
19:     belongs_to :lesson, Hellen.Lessons.Lesson
20: 
21:     timestamps(type: :utc_datetime, updated_at: false)
22:   end
23: 
24:   @reasons ["signup_bonus", "lesson_analysis", "purchase", "refund", "gift", "promo"]
25: 
26:   @doc false
27:   def changeset(credit_transaction, attrs) do
28:     credit_transaction
29:     |> cast(attrs, [
30:       :amount,
31:       :balance_after,
32:       :reason,
33:       :metadata,
34:       :user_id,
35:       :lesson_id,
36:       :stripe_payment_intent_id
37:     ])
38:     |> validate_required([:amount, :balance_after, :reason, :user_id])
39:     |> validate_inclusion(:reason, @reasons)
40:     |> validate_number(:balance_after, greater_than_or_equal_to: 0)
41:     |> foreign_key_constraint(:user_id)
42:     |> foreign_key_constraint(:lesson_id)
43:   end
44: end
````

## File: lib/hellen/billing/stripe_service.ex
````elixir
  1: defmodule Hellen.Billing.StripeService do
  2:   @moduledoc """
  3:   Service module for Stripe payment integration.
  4:   Handles checkout sessions, customer management, and webhook processing.
  5:   """
  6: 
  7:   alias Hellen.Accounts
  8:   alias Hellen.Accounts.User
  9:   alias Hellen.Billing
 10: 
 11:   require Logger
 12: 
 13:   @doc """
 14:   Creates or retrieves a Stripe customer for a user.
 15:   """
 16:   @spec get_or_create_customer(User.t()) :: {:ok, String.t()} | {:error, term()}
 17:   def get_or_create_customer(%User{stripe_customer_id: customer_id} = _user)
 18:       when is_binary(customer_id) and customer_id != "" do
 19:     {:ok, customer_id}
 20:   end
 21: 
 22:   def get_or_create_customer(%User{} = user) do
 23:     case Stripe.Customer.create(%{
 24:            email: user.email,
 25:            name: user.name,
 26:            metadata: %{
 27:              user_id: user.id,
 28:              institution_id: user.institution_id || "none"
 29:            }
 30:          }) do
 31:       {:ok, %Stripe.Customer{id: customer_id}} ->
 32:         Accounts.update_stripe_customer_id(user, customer_id)
 33:         {:ok, customer_id}
 34: 
 35:       {:error, error} ->
 36:         Logger.error("Failed to create Stripe customer: #{inspect(error)}")
 37:         {:error, error}
 38:     end
 39:   end
 40: 
 41:   @doc """
 42:   Creates a Stripe Checkout session for purchasing credits.
 43:   Supports both card and PIX payment methods.
 44:   """
 45:   @spec create_checkout_session(User.t(), String.t(), String.t(), String.t()) ::
 46:           {:ok, String.t()} | {:error, term()}
 47:   def create_checkout_session(%User{} = user, package_id, base_url, payment_method \\ "card") do
 48:     with {:ok, package} <- get_package(package_id),
 49:          {:ok, customer_id} <- get_or_create_customer(user) do
 50:       stripe_config = Application.get_env(:hellen, :stripe)
 51:       success_url = "#{base_url}#{stripe_config[:success_url]}&session_id={CHECKOUT_SESSION_ID}"
 52:       cancel_url = "#{base_url}#{stripe_config[:cancel_url]}"
 53: 
 54:       # Define payment method types based on selection
 55:       payment_method_types = get_payment_method_types(payment_method)
 56: 
 57:       params = %{
 58:         customer: customer_id,
 59:         mode: "payment",
 60:         success_url: success_url,
 61:         cancel_url: cancel_url,
 62:         payment_method_types: payment_method_types,
 63:         line_items: [
 64:           %{
 65:             price_data: %{
 66:               currency: "brl",
 67:               product_data: %{
 68:                 name: "#{package.name} - #{package.credits} Creditos",
 69:                 description: "Pacote de creditos para analise de aulas no Hellen AI"
 70:               },
 71:               unit_amount: package.price
 72:             },
 73:             quantity: 1
 74:           }
 75:         ],
 76:         metadata: %{
 77:           user_id: user.id,
 78:           package_id: package_id,
 79:           credits: package.credits,
 80:           payment_method: payment_method
 81:         },
 82:         payment_intent_data: %{
 83:           metadata: %{
 84:             user_id: user.id,
 85:             package_id: package_id,
 86:             credits: package.credits
 87:           }
 88:         }
 89:       }
 90: 
 91:       # Add PIX-specific options (expires in 30 minutes)
 92:       params =
 93:         if payment_method == "pix" do
 94:           Map.put(params, :payment_method_options, %{
 95:             pix: %{
 96:               expires_after_seconds: 1800
 97:             }
 98:           })
 99:         else
100:           params
101:         end
102: 
103:       case Stripe.Checkout.Session.create(params) do
104:         {:ok, %Stripe.Checkout.Session{url: url}} ->
105:           {:ok, url}
106: 
107:         {:error, error} ->
108:           Logger.error("Failed to create checkout session: #{inspect(error)}")
109:           {:error, error}
110:       end
111:     end
112:   end
113: 
114:   defp get_payment_method_types("pix"), do: ["pix"]
115:   defp get_payment_method_types("card"), do: ["card"]
116:   defp get_payment_method_types(_), do: ["card", "pix"]
117: 
118:   @doc """
119:   Handles a completed checkout session webhook.
120:   Adds credits to the user's account.
121:   """
122:   @spec handle_checkout_completed(map()) :: {:ok, User.t()} | {:error, term()}
123:   def handle_checkout_completed(%{"metadata" => metadata, "payment_intent" => payment_intent_id}) do
124:     user_id = metadata["user_id"]
125:     credits = String.to_integer(metadata["credits"])
126:     package_id = metadata["package_id"]
127: 
128:     Logger.info(
129:       "Processing checkout completion: user=#{user_id}, credits=#{credits}, package=#{package_id}"
130:     )
131: 
132:     case Accounts.get_user(user_id) do
133:       nil ->
134:         Logger.error("User not found for checkout: #{user_id}")
135:         {:error, :user_not_found}
136: 
137:       user ->
138:         case Billing.add_credits_with_stripe(user, credits, package_id, payment_intent_id) do
139:           {:ok, updated_user} ->
140:             Logger.info("Credits added successfully: #{credits} credits for user #{user_id}")
141:             broadcast_credits_updated(user_id, updated_user.credits)
142:             {:ok, updated_user}
143: 
144:           {:error, reason} ->
145:             Logger.error("Failed to add credits: #{inspect(reason)}")
146:             {:error, reason}
147:         end
148:     end
149:   end
150: 
151:   def handle_checkout_completed(_), do: {:error, :invalid_payload}
152: 
153:   @doc """
154:   Handles a failed payment webhook.
155:   """
156:   @spec handle_payment_failed(map()) :: :ok
157:   def handle_payment_failed(%{"metadata" => metadata}) do
158:     user_id = metadata["user_id"]
159:     Logger.warning("Payment failed for user: #{user_id}")
160:     # Could notify user here
161:     :ok
162:   end
163: 
164:   def handle_payment_failed(_), do: :ok
165: 
166:   @doc """
167:   Retrieves a checkout session by ID.
168:   """
169:   @spec get_session(String.t()) :: {:ok, map()} | {:error, term()}
170:   def get_session(session_id) do
171:     Stripe.Checkout.Session.retrieve(session_id)
172:   end
173: 
174:   @doc """
175:   Creates a customer portal session for managing payment methods.
176:   """
177:   @spec create_portal_session(User.t(), String.t()) :: {:ok, String.t()} | {:error, term()}
178:   def create_portal_session(%User{stripe_customer_id: nil}, _base_url) do
179:     {:error, :no_customer}
180:   end
181: 
182:   def create_portal_session(%User{stripe_customer_id: customer_id}, base_url) do
183:     case Stripe.BillingPortal.Session.create(%{
184:            customer: customer_id,
185:            return_url: "#{base_url}/billing"
186:          }) do
187:       {:ok, %{url: url}} -> {:ok, url}
188:       {:error, error} -> {:error, error}
189:     end
190:   end
191: 
192:   # Private functions
193: 
194:   defp get_package(package_id) do
195:     case Enum.find(Billing.credit_packages(), &(&1.id == package_id)) do
196:       nil -> {:error, :package_not_found}
197:       package -> {:ok, package}
198:     end
199:   end
200: 
201:   defp broadcast_credits_updated(user_id, new_balance) do
202:     Phoenix.PubSub.broadcast(
203:       Hellen.PubSub,
204:       "user:#{user_id}",
205:       {:credits_updated, new_balance}
206:     )
207:   end
208: end
````

## File: lib/hellen/lessons/lesson.ex
````elixir
 1: defmodule Hellen.Lessons.Lesson do
 2:   @moduledoc """
 3:   Schema for recorded lessons with audio/video URLs and processing status.
 4:   """
 5:   use Ecto.Schema
 6:   import Ecto.Changeset
 7: 
 8:   @primary_key {:id, :binary_id, autogenerate: true}
 9:   @foreign_key_type :binary_id
10: 
11:   schema "lessons" do
12:     field :title, :string
13:     field :description, :string
14:     field :video_url, :string
15:     field :audio_url, :string
16:     field :duration_seconds, :integer
17:     field :grade_level, :string
18:     field :subject, :string
19:     field :status, :string, default: "pending"
20:     field :metadata, :map, default: %{}
21: 
22:     belongs_to :user, Hellen.Accounts.User
23:     belongs_to :institution, Hellen.Accounts.Institution
24:     has_one :transcription, Hellen.Lessons.Transcription
25:     has_many :analyses, Hellen.Analysis.Analysis
26: 
27:     timestamps(type: :utc_datetime)
28:   end
29: 
30:   @statuses ["pending", "uploading", "transcribing", "analyzing", "completed", "failed"]
31: 
32:   @doc false
33:   def changeset(lesson, attrs) do
34:     lesson
35:     |> cast(attrs, [
36:       :title,
37:       :description,
38:       :video_url,
39:       :audio_url,
40:       :duration_seconds,
41:       :grade_level,
42:       :subject,
43:       :status,
44:       :metadata,
45:       :user_id,
46:       :institution_id
47:     ])
48:     |> validate_required([:title, :user_id])
49:     |> validate_inclusion(:status, @statuses)
50:     |> foreign_key_constraint(:user_id)
51:     |> foreign_key_constraint(:institution_id)
52:   end
53: 
54:   def status_changeset(lesson, status) do
55:     lesson
56:     |> change(status: status)
57:     |> validate_inclusion(:status, @statuses)
58:   end
59: end
````

## File: lib/hellen/workers/transcription_job.ex
````elixir
  1: defmodule Hellen.Workers.TranscriptionJob do
  2:   @moduledoc """
  3:   Oban worker for transcribing lesson audio.
  4:   """
  5: 
  6:   use Oban.Worker,
  7:     queue: :transcription,
  8:     max_attempts: 3,
  9:     unique: [period: 300, keys: [:lesson_id]]
 10: 
 11:   alias Hellen.AI.NvidiaClient
 12:   alias Hellen.Billing
 13:   alias Hellen.Lessons
 14:   alias Hellen.Workers.AnalysisJob
 15: 
 16:   require Logger
 17: 
 18:   @impl Oban.Worker
 19:   def perform(%Oban.Job{args: %{"lesson_id" => lesson_id}}) do
 20:     Logger.info("Starting transcription for lesson #{lesson_id}")
 21: 
 22:     lesson = Lessons.get_lesson!(lesson_id)
 23: 
 24:     # Check if transcription already exists (retry scenario)
 25:     case Lessons.get_transcription_by_lesson(lesson_id) do
 26:       %Hellen.Lessons.Transcription{} = existing ->
 27:         Logger.info("Transcription already exists for lesson #{lesson_id}, skipping to analysis")
 28:         proceed_to_analysis(lesson, existing)
 29: 
 30:       nil ->
 31:         perform_transcription(lesson)
 32:     end
 33:   end
 34: 
 35:   defp perform_transcription(lesson) do
 36:     with {:ok, lesson} <- Lessons.update_lesson_status(lesson, "transcribing"),
 37:          {:ok, result} <- transcribe_audio(lesson),
 38:          {:ok, transcription} <- save_transcription(lesson, result) do
 39:       Logger.info(
 40:         "Transcription result: text=#{String.length(result.text || "")} chars, segments=#{length(result.segments || [])}"
 41:       )
 42: 
 43:       Logger.info("Transcription saved successfully")
 44:       proceed_to_analysis(lesson, transcription)
 45:     else
 46:       {:error, reason} ->
 47:         Logger.error("Transcription failed for lesson #{lesson.id}: #{inspect(reason)}")
 48:         handle_failure(lesson, reason)
 49:     end
 50:   end
 51: 
 52:   defp proceed_to_analysis(lesson, _transcription) do
 53:     with {:ok, lesson} <- Lessons.update_lesson_status(lesson, "analyzing"),
 54:          {:ok, _job} <- enqueue_analysis(lesson) do
 55:       Logger.info("Transcription completed for lesson #{lesson.id}")
 56:       broadcast_progress(lesson.id, "transcription_complete", %{})
 57:       :ok
 58:     else
 59:       {:error, reason} ->
 60:         Logger.error("Failed to proceed to analysis for lesson #{lesson.id}: #{inspect(reason)}")
 61:         handle_failure(lesson, reason)
 62:     end
 63:   end
 64: 
 65:   defp transcribe_audio(%{audio_url: nil, video_url: video_url}) when is_binary(video_url) do
 66:     # Video files are sent directly; NVIDIA API handles audio extraction
 67:     NvidiaClient.transcribe(video_url)
 68:   end
 69: 
 70:   defp transcribe_audio(%{audio_url: audio_url}) when is_binary(audio_url) do
 71:     NvidiaClient.transcribe(audio_url)
 72:   end
 73: 
 74:   defp transcribe_audio(_lesson) do
 75:     {:error, :no_audio_source}
 76:   end
 77: 
 78:   defp save_transcription(lesson, result) do
 79:     Lessons.create_transcription(lesson.id, %{
 80:       full_text: result.text,
 81:       segments: result.segments,
 82:       language: result.language,
 83:       confidence_score: nil
 84:     })
 85:   end
 86: 
 87:   defp enqueue_analysis(lesson) do
 88:     %{lesson_id: lesson.id}
 89:     |> AnalysisJob.new()
 90:     |> Oban.insert()
 91:   end
 92: 
 93:   defp handle_failure(lesson, reason) do
 94:     Lessons.update_lesson_status(lesson, "failed")
 95: 
 96:     # Refund credit on failure
 97:     user = Hellen.Accounts.get_user!(lesson.user_id)
 98:     Billing.refund_credit(user, lesson.id)
 99: 
100:     broadcast_progress(lesson.id, "transcription_failed", %{error: inspect(reason)})
101:     {:error, reason}
102:   end
103: 
104:   defp broadcast_progress(lesson_id, event, payload) do
105:     Phoenix.PubSub.broadcast(
106:       Hellen.PubSub,
107:       "lesson:#{lesson_id}",
108:       {event, Map.put(payload, :lesson_id, lesson_id)}
109:     )
110:   end
111: end
````

## File: lib/hellen/reports.ex
````elixir
  1: defmodule Hellen.Reports do
  2:   @moduledoc """
  3:   Context for generating PDF reports using ChromicPDF.
  4: 
  5:   Supports three report types:
  6:   - Monthly Institution Report: Overview of metrics, teacher rankings, alerts
  7:   - Individual Teacher Report: Performance history and statistics
  8:   - Analysis Export: Detailed export of a single analysis
  9:   """
 10: 
 11:   import Ecto.Query, warn: false
 12: 
 13:   alias Hellen.Accounts
 14:   alias Hellen.Accounts.User
 15:   alias Hellen.Analysis, as: AnalysisContext
 16:   alias Hellen.Analysis.{Analysis, BnccMatch, BullyingAlert}
 17:   alias Hellen.Lessons.Lesson
 18:   alias Hellen.Repo
 19: 
 20:   @templates_path "lib/hellen/reports/templates"
 21: 
 22:   # ============================================
 23:   # Monthly Institution Report
 24:   # ============================================
 25: 
 26:   @doc """
 27:   Generate a monthly report PDF for an institution.
 28: 
 29:   Options:
 30:     - month: Integer (1-12), defaults to current month
 31:     - year: Integer, defaults to current year
 32: 
 33:   Returns {:ok, pdf_binary} or {:error, reason}
 34:   """
 35:   @spec generate_monthly_report(binary(), keyword()) :: {:ok, binary()} | {:error, term()}
 36:   def generate_monthly_report(institution_id, opts \\ []) do
 37:     {month, year} = get_period(opts)
 38:     institution = Accounts.get_institution!(institution_id)
 39: 
 40:     data = %{
 41:       institution: institution,
 42:       period: format_period(month, year),
 43:       generated_at: DateTime.utc_now(),
 44:       stats: get_monthly_stats(institution_id, month, year),
 45:       teachers_ranking: get_teachers_ranking(institution_id, month, year),
 46:       alerts_summary: get_alerts_summary(institution_id, month, year),
 47:       bncc_coverage: get_institution_bncc_coverage(institution_id, month, year)
 48:     }
 49: 
 50:     render_pdf("monthly_report.html.eex", data)
 51:   end
 52: 
 53:   defp get_monthly_stats(institution_id, month, year) do
 54:     {start_date, end_date} = month_range(month, year)
 55: 
 56:     teachers_count =
 57:       User
 58:       |> where([u], u.institution_id == ^institution_id)
 59:       |> Repo.aggregate(:count)
 60: 
 61:     lessons_count =
 62:       Lesson
 63:       |> where([l], l.institution_id == ^institution_id)
 64:       |> where([l], l.inserted_at >= ^start_date and l.inserted_at < ^end_date)
 65:       |> Repo.aggregate(:count)
 66: 
 67:     analyses_count =
 68:       Analysis
 69:       |> where([a], a.institution_id == ^institution_id)
 70:       |> where([a], a.inserted_at >= ^start_date and a.inserted_at < ^end_date)
 71:       |> Repo.aggregate(:count)
 72: 
 73:     alerts_count =
 74:       BullyingAlert
 75:       |> join(:inner, [b], a in assoc(b, :analysis))
 76:       |> where([b, a], a.institution_id == ^institution_id)
 77:       |> where([b], b.inserted_at >= ^start_date and b.inserted_at < ^end_date)
 78:       |> Repo.aggregate(:count)
 79: 
 80:     avg_score =
 81:       Analysis
 82:       |> where([a], a.institution_id == ^institution_id)
 83:       |> where([a], a.inserted_at >= ^start_date and a.inserted_at < ^end_date)
 84:       |> where([a], not is_nil(a.overall_score))
 85:       |> Repo.aggregate(:avg, :overall_score)
 86: 
 87:     %{
 88:       teachers: teachers_count,
 89:       lessons: lessons_count,
 90:       analyses: analyses_count,
 91:       alerts: alerts_count,
 92:       avg_score: avg_score && Float.round(avg_score, 1)
 93:     }
 94:   end
 95: 
 96:   defp get_teachers_ranking(institution_id, month, year) do
 97:     {start_date, end_date} = month_range(month, year)
 98: 
 99:     User
100:     |> where([u], u.institution_id == ^institution_id)
101:     |> join(:left, [u], l in Lesson,
102:       on: l.user_id == u.id and l.inserted_at >= ^start_date and l.inserted_at < ^end_date
103:     )
104:     |> join(:left, [u, l], a in Analysis, on: a.lesson_id == l.id)
105:     |> group_by([u, l, a], [u.id, u.name])
106:     |> select([u, l, a], %{
107:       name: u.name,
108:       lessons: count(l.id, :distinct),
109:       analyses: count(a.id),
110:       avg_score: avg(a.overall_score)
111:     })
112:     |> order_by([u, l, a], desc: count(l.id, :distinct))
113:     |> limit(10)
114:     |> Repo.all()
115:     |> Enum.map(fn row ->
116:       %{row | avg_score: row.avg_score && Float.round(row.avg_score, 1)}
117:     end)
118:   end
119: 
120:   defp get_alerts_summary(institution_id, month, year) do
121:     {start_date, end_date} = month_range(month, year)
122: 
123:     query =
124:       BullyingAlert
125:       |> join(:inner, [b], a in assoc(b, :analysis))
126:       |> where([b, a], a.institution_id == ^institution_id)
127:       |> where([b], b.inserted_at >= ^start_date and b.inserted_at < ^end_date)
128: 
129:     by_severity =
130:       query
131:       |> group_by([b], b.severity)
132:       |> select([b], {b.severity, count(b.id)})
133:       |> Repo.all()
134:       |> Map.new()
135: 
136:     by_type =
137:       query
138:       |> group_by([b], b.alert_type)
139:       |> select([b], {b.alert_type, count(b.id)})
140:       |> Repo.all()
141:       |> Map.new()
142: 
143:     %{by_severity: by_severity, by_type: by_type}
144:   end
145: 
146:   defp get_institution_bncc_coverage(institution_id, month, year) do
147:     {start_date, end_date} = month_range(month, year)
148: 
149:     BnccMatch
150:     |> join(:inner, [m], a in assoc(m, :analysis))
151:     |> where([m, a], a.institution_id == ^institution_id)
152:     |> where([m, a], a.inserted_at >= ^start_date and a.inserted_at < ^end_date)
153:     |> group_by([m], [m.competencia_code, m.competencia_name])
154:     |> select([m], %{
155:       code: m.competencia_code,
156:       name: m.competencia_name,
157:       count: count(m.id)
158:     })
159:     |> order_by([m], desc: count(m.id))
160:     |> limit(15)
161:     |> Repo.all()
162:   end
163: 
164:   # ============================================
165:   # Teacher Report
166:   # ============================================
167: 
168:   @doc """
169:   Generate a performance report PDF for an individual teacher.
170: 
171:   Options:
172:     - month: Integer (1-12), defaults to current month
173:     - year: Integer, defaults to current year
174: 
175:   Returns {:ok, pdf_binary} or {:error, reason}
176:   """
177:   @spec generate_teacher_report(binary(), keyword()) :: {:ok, binary()} | {:error, term()}
178:   def generate_teacher_report(user_id, opts \\ []) do
179:     {month, year} = get_period(opts)
180:     user = Accounts.get_user!(user_id)
181: 
182:     institution =
183:       if user.institution_id do
184:         Accounts.get_institution!(user.institution_id)
185:       else
186:         nil
187:       end
188: 
189:     data = %{
190:       teacher: user,
191:       institution: institution,
192:       period: format_period(month, year),
193:       generated_at: DateTime.utc_now(),
194:       stats: get_teacher_stats(user_id, month, year),
195:       score_history: get_teacher_score_history(user_id, month, year),
196:       bncc_coverage: get_teacher_bncc_coverage(user_id, month, year),
197:       recent_lessons: get_teacher_recent_lessons(user_id, month, year)
198:     }
199: 
200:     render_pdf("teacher_report.html.eex", data)
201:   end
202: 
203:   defp get_teacher_stats(user_id, month, year) do
204:     {start_date, end_date} = month_range(month, year)
205: 
206:     lessons_count =
207:       Lesson
208:       |> where([l], l.user_id == ^user_id)
209:       |> where([l], l.inserted_at >= ^start_date and l.inserted_at < ^end_date)
210:       |> Repo.aggregate(:count)
211: 
212:     analyses_count =
213:       Analysis
214:       |> join(:inner, [a], l in assoc(a, :lesson))
215:       |> where([a, l], l.user_id == ^user_id)
216:       |> where([a], a.inserted_at >= ^start_date and a.inserted_at < ^end_date)
217:       |> Repo.aggregate(:count)
218: 
219:     avg_score =
220:       Analysis
221:       |> join(:inner, [a], l in assoc(a, :lesson))
222:       |> where([a, l], l.user_id == ^user_id)
223:       |> where([a], a.inserted_at >= ^start_date and a.inserted_at < ^end_date)
224:       |> where([a], not is_nil(a.overall_score))
225:       |> Repo.aggregate(:avg, :overall_score)
226: 
227:     {trend, _change} = AnalysisContext.get_user_trend(user_id)
228: 
229:     %{
230:       lessons: lessons_count,
231:       analyses: analyses_count,
232:       avg_score: avg_score && Float.round(avg_score, 1),
233:       trend: trend
234:     }
235:   end
236: 
237:   defp get_teacher_score_history(user_id, month, year) do
238:     {start_date, end_date} = month_range(month, year)
239: 
240:     Analysis
241:     |> join(:inner, [a], l in assoc(a, :lesson))
242:     |> where([a, l], l.user_id == ^user_id)
243:     |> where([a], a.inserted_at >= ^start_date and a.inserted_at < ^end_date)
244:     |> where([a], not is_nil(a.overall_score))
245:     |> order_by([a], asc: a.inserted_at)
246:     |> select([a, l], %{
247:       date: a.inserted_at,
248:       score: a.overall_score,
249:       lesson_title: l.title
250:     })
251:     |> Repo.all()
252:   end
253: 
254:   defp get_teacher_bncc_coverage(user_id, month, year) do
255:     {start_date, end_date} = month_range(month, year)
256: 
257:     BnccMatch
258:     |> join(:inner, [m], a in assoc(m, :analysis))
259:     |> join(:inner, [m, a], l in assoc(a, :lesson))
260:     |> where([m, a, l], l.user_id == ^user_id)
261:     |> where([m, a], a.inserted_at >= ^start_date and a.inserted_at < ^end_date)
262:     |> group_by([m], [m.competencia_code, m.competencia_name])
263:     |> select([m], %{
264:       code: m.competencia_code,
265:       name: m.competencia_name,
266:       count: count(m.id),
267:       avg_score: avg(m.match_score)
268:     })
269:     |> order_by([m], desc: count(m.id))
270:     |> limit(10)
271:     |> Repo.all()
272:     |> Enum.map(fn row ->
273:       %{row | avg_score: row.avg_score && Float.round(row.avg_score, 1)}
274:     end)
275:   end
276: 
277:   defp get_teacher_recent_lessons(user_id, month, year) do
278:     {start_date, end_date} = month_range(month, year)
279: 
280:     Lesson
281:     |> where([l], l.user_id == ^user_id)
282:     |> where([l], l.inserted_at >= ^start_date and l.inserted_at < ^end_date)
283:     |> order_by([l], desc: l.inserted_at)
284:     |> limit(10)
285:     |> preload(:analyses)
286:     |> Repo.all()
287:     |> Enum.map(fn lesson ->
288:       latest_analysis = Enum.max_by(lesson.analyses, & &1.inserted_at, fn -> nil end)
289: 
290:       %{
291:         title: lesson.title || "Aula sem titulo",
292:         date: lesson.inserted_at,
293:         status: lesson.status,
294:         score: latest_analysis && latest_analysis.overall_score
295:       }
296:     end)
297:   end
298: 
299:   # ============================================
300:   # Analysis Export
301:   # ============================================
302: 
303:   @doc """
304:   Generate a PDF export for a single analysis.
305:   Includes full analysis details, BNCC matches, and bullying alerts.
306: 
307:   Returns {:ok, pdf_binary} or {:error, reason}
308:   """
309:   @spec generate_analysis_export(binary()) :: {:ok, binary()} | {:error, term()}
310:   def generate_analysis_export(analysis_id) do
311:     analysis =
312:       Analysis
313:       |> Repo.get!(analysis_id)
314:       |> Repo.preload([:bncc_matches, :bullying_alerts, lesson: :user])
315: 
316:     data = %{
317:       analysis: analysis,
318:       lesson: analysis.lesson,
319:       teacher: analysis.lesson.user,
320:       generated_at: DateTime.utc_now(),
321:       bncc_matches: analysis.bncc_matches,
322:       bullying_alerts: analysis.bullying_alerts,
323:       result: analysis.result
324:     }
325: 
326:     render_pdf("analysis_export.html.eex", data)
327:   end
328: 
329:   # ============================================
330:   # PDF Rendering
331:   # ============================================
332: 
333:   defp render_pdf(template, data) do
334:     html = render_template(template, data)
335: 
336:     case ChromicPDF.print_to_pdf({:html, html}, pdf_options()) do
337:       {:ok, pdf_binary} -> {:ok, pdf_binary}
338:       {:error, reason} -> {:error, reason}
339:     end
340:   end
341: 
342:   defp render_template(template, data) do
343:     template_path = Path.join([@templates_path, template])
344:     styles = render_styles()
345: 
346:     assigns =
347:       data
348:       |> Map.put(:styles, styles)
349:       |> Map.put(:h, Hellen.Reports.Helpers)
350:       |> Enum.into([])
351: 
352:     EEx.eval_file(template_path, assigns: assigns)
353:   end
354: 
355:   defp render_styles do
356:     styles_path = Path.join([@templates_path, "_styles.html.eex"])
357: 
358:     if File.exists?(styles_path) do
359:       EEx.eval_file(styles_path, [])
360:     else
361:       default_styles()
362:     end
363:   end
364: 
365:   defp pdf_options do
366:     [
367:       print_to_pdf: %{
368:         paperWidth: 8.27,
369:         paperHeight: 11.69,
370:         marginTop: 0.4,
371:         marginBottom: 0.4,
372:         marginLeft: 0.4,
373:         marginRight: 0.4,
374:         printBackground: true
375:       }
376:     ]
377:   end
378: 
379:   # ============================================
380:   # Helpers
381:   # ============================================
382: 
383:   defp get_period(opts) do
384:     now = Date.utc_today()
385:     month = Keyword.get(opts, :month, now.month)
386:     year = Keyword.get(opts, :year, now.year)
387:     {month, year}
388:   end
389: 
390:   defp month_range(month, year) do
391:     start_date = Date.new!(year, month, 1) |> DateTime.new!(~T[00:00:00], "Etc/UTC")
392: 
393:     end_date =
394:       start_date
395:       |> DateTime.to_date()
396:       |> Date.end_of_month()
397:       |> Date.add(1)
398:       |> DateTime.new!(~T[00:00:00], "Etc/UTC")
399: 
400:     {start_date, end_date}
401:   end
402: 
403:   defp format_period(month, year) do
404:     months = [
405:       "Janeiro",
406:       "Fevereiro",
407:       "Marco",
408:       "Abril",
409:       "Maio",
410:       "Junho",
411:       "Julho",
412:       "Agosto",
413:       "Setembro",
414:       "Outubro",
415:       "Novembro",
416:       "Dezembro"
417:     ]
418: 
419:     "#{Enum.at(months, month - 1)} #{year}"
420:   end
421: 
422:   defp default_styles do
423:     """
424:     <style>
425:       * { margin: 0; padding: 0; box-sizing: border-box; }
426:       body { font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 12px; color: #1f2937; line-height: 1.5; }
427:       .header { background: #4f46e5; color: white; padding: 24px; margin-bottom: 24px; }
428:       .header h1 { font-size: 24px; margin-bottom: 4px; }
429:       .header p { opacity: 0.9; }
430:       .section { margin-bottom: 24px; page-break-inside: avoid; }
431:       .section-title { font-size: 16px; font-weight: 600; color: #111827; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #e5e7eb; }
432:       .stats-grid { display: flex; gap: 16px; flex-wrap: wrap; }
433:       .stat-card { background: #f9fafb; padding: 16px; border-radius: 8px; flex: 1; min-width: 120px; }
434:       .stat-card h3 { font-size: 24px; color: #111827; }
435:       .stat-card p { font-size: 12px; color: #6b7280; }
436:       table { width: 100%; border-collapse: collapse; margin-top: 8px; }
437:       th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
438:       th { background: #f9fafb; font-weight: 600; color: #374151; }
439:       .badge { display: inline-block; padding: 2px 8px; border-radius: 9999px; font-size: 10px; font-weight: 500; }
440:       .badge-success { background: #d1fae5; color: #065f46; }
441:       .badge-warning { background: #fef3c7; color: #92400e; }
442:       .badge-error { background: #fee2e2; color: #991b1b; }
443:       .footer { margin-top: 32px; padding-top: 16px; border-top: 1px solid #e5e7eb; font-size: 10px; color: #9ca3af; text-align: center; }
444:     </style>
445:     """
446:   end
447: end
448: 
449: defmodule Hellen.Reports.Helpers do
450:   @moduledoc """
451:   Template helper functions for PDF report generation.
452:   """
453: 
454:   def score_class(nil), do: ""
455:   def score_class(score) when score >= 8, do: "score-good"
456:   def score_class(score) when score >= 6, do: "score-average"
457:   def score_class(_), do: "score-poor"
458: 
459:   # Medal colors for ranking
460:   def medal_color(1), do: "#f59e0b"
461:   def medal_color(2), do: "#94a3b8"
462:   def medal_color(3), do: "#b45309"
463:   def medal_color(_), do: "#64748b"
464: 
465:   # Calculate analysis rate percentage
466:   def analysis_rate(%{lessons: lessons, analyses: analyses}) when lessons > 0 do
467:     min(100, round(analyses / lessons * 100))
468:   end
469: 
470:   def analysis_rate(_), do: 0
471: 
472:   def severity_order("high"), do: 1
473:   def severity_order("medium"), do: 2
474:   def severity_order("low"), do: 3
475:   def severity_order(_), do: 4
476: 
477:   def severity_badge_class("high"), do: "badge-error"
478:   def severity_badge_class("medium"), do: "badge-warning"
479:   def severity_badge_class("low"), do: "badge-success"
480:   def severity_badge_class(_), do: "badge-default"
481: 
482:   def severity_label("high"), do: "Alta"
483:   def severity_label("medium"), do: "Media"
484:   def severity_label("low"), do: "Baixa"
485:   def severity_label(other), do: other || "Desconhecido"
486: 
487:   def alert_type_label("verbal_aggression"), do: "Agressao Verbal"
488:   def alert_type_label("exclusion"), do: "Exclusao"
489:   def alert_type_label("intimidation"), do: "Intimidacao"
490:   def alert_type_label("cyberbullying"), do: "Cyberbullying"
491:   def alert_type_label(other), do: String.capitalize(other || "Outro")
492: 
493:   def status_badge_class("completed"), do: "badge-success"
494:   def status_badge_class("analyzing"), do: "badge-info"
495:   def status_badge_class("transcribing"), do: "badge-info"
496:   def status_badge_class("pending"), do: "badge-warning"
497:   def status_badge_class("failed"), do: "badge-error"
498:   def status_badge_class(_), do: "badge-default"
499: 
500:   def status_label("completed"), do: "Concluida"
501:   def status_label("analyzing"), do: "Analisando"
502:   def status_label("transcribing"), do: "Transcrevendo"
503:   def status_label("transcribed"), do: "Transcrita"
504:   def status_label("pending"), do: "Pendente"
505:   def status_label("failed"), do: "Falhou"
506:   def status_label(_), do: "Desconhecido"
507: 
508:   def trend_class(:improving), do: "trend-up"
509:   def trend_class(:declining), do: "trend-down"
510:   def trend_class(_), do: "trend-stable"
511: 
512:   def trend_label(:improving), do: "Em alta"
513:   def trend_label(:declining), do: "Em baixa"
514:   def trend_label(_), do: "Estavel"
515: 
516:   def truncate(nil, _), do: ""
517:   def truncate(string, max) when byte_size(string) <= max, do: string
518:   def truncate(string, max), do: String.slice(string, 0, max) <> "..."
519: 
520:   def format_date(nil), do: "-"
521: 
522:   def format_date(%DateTime{} = dt) do
523:     Calendar.strftime(dt, "%d/%m/%Y")
524:   end
525: 
526:   def format_date(%Date{} = d) do
527:     Calendar.strftime(d, "%d/%m/%Y")
528:   end
529: 
530:   def format_datetime(nil), do: "-"
531: 
532:   def format_datetime(%DateTime{} = dt) do
533:     Calendar.strftime(dt, "%d/%m/%Y as %H:%M")
534:   end
535: 
536:   def sort_by_severity(items) do
537:     Enum.sort_by(items, fn {k, _v} -> severity_order(k) end)
538:   end
539: end
````

## File: lib/hellen_web/components/layouts/landing.html.heex
````
1: <div class="min-h-screen bg-white dark:bg-slate-950 transition-colors duration-200">
2:   <%= @inner_content %>
3: </div>
````

## File: lib/hellen_web/controllers/api/auth_controller.ex
````elixir
  1: defmodule HellenWeb.API.AuthController do
  2:   @moduledoc """
  3:   Authentication controller for Firebase and local auth.
  4: 
  5:   ## Endpoints
  6: 
  7:   * `POST /api/auth/firebase` - Login with Firebase ID token
  8:   * `POST /api/auth/login` - Login with email/password
  9:   * `POST /api/auth/register` - Register new user
 10:   * `POST /api/auth/refresh` - Refresh access token
 11:   * `GET /api/auth/me` - Get current user info
 12:   """
 13: 
 14:   use HellenWeb, :api_controller
 15: 
 16:   alias Hellen.Accounts
 17:   alias Hellen.Auth.Firebase
 18:   alias Hellen.Auth.Guardian
 19: 
 20:   action_fallback HellenWeb.FallbackController
 21: 
 22:   @doc """
 23:   Authenticate with Firebase ID token.
 24: 
 25:   ## Request body
 26:   ```json
 27:   {
 28:     "id_token": "firebase_id_token_from_frontend"
 29:   }
 30:   ```
 31: 
 32:   ## Response
 33:   ```json
 34:   {
 35:     "data": {
 36:       "user": { ... },
 37:       "access_token": "jwt_token",
 38:       "refresh_token": "jwt_refresh_token"
 39:     }
 40:   }
 41:   ```
 42:   """
 43:   def firebase(conn, %{"id_token" => id_token}) do
 44:     with {:ok, claims} <- Firebase.verify_id_token(id_token),
 45:          user_info <- Firebase.extract_user_info(claims),
 46:          {:ok, user} <- Accounts.find_or_create_from_firebase(user_info),
 47:          {:ok, tokens} <- Guardian.generate_tokens(user) do
 48:       conn
 49:       |> put_status(:ok)
 50:       |> json(%{
 51:         data: %{
 52:           user: user_json(user),
 53:           access_token: tokens.access_token,
 54:           refresh_token: tokens.refresh_token
 55:         }
 56:       })
 57:     else
 58:       {:error, :invalid_token_format} ->
 59:         {:error, :bad_request, "Invalid token format"}
 60: 
 61:       {:error, :certs_fetch_failed} ->
 62:         {:error, :service_unavailable, "Failed to verify token"}
 63: 
 64:       {:error, :unknown_key_id} ->
 65:         {:error, :unauthorized, "Unknown signing key"}
 66: 
 67:       {:error, :invalid_signature} ->
 68:         {:error, :unauthorized, "Invalid token signature"}
 69: 
 70:       {:error, :token_expired} ->
 71:         {:error, :unauthorized, "Token expired"}
 72: 
 73:       {:error, :invalid_issuer} ->
 74:         {:error, :unauthorized, "Invalid token issuer"}
 75: 
 76:       {:error, :invalid_audience} ->
 77:         {:error, :unauthorized, "Invalid token audience"}
 78: 
 79:       {:error, reason} ->
 80:         {:error, :unauthorized, "Authentication failed: #{inspect(reason)}"}
 81:     end
 82:   end
 83: 
 84:   def firebase(conn, _params) do
 85:     conn
 86:     |> put_status(:bad_request)
 87:     |> json(%{error: "Missing id_token parameter"})
 88:   end
 89: 
 90:   @doc """
 91:   Traditional login with email and password.
 92:   """
 93:   def login(conn, %{"email" => email, "password" => password}) do
 94:     with {:ok, user} <- Accounts.authenticate_user(email, password),
 95:          {:ok, tokens} <- Guardian.generate_tokens(user) do
 96:       conn
 97:       |> put_status(:ok)
 98:       |> json(%{
 99:         data: %{
100:           user: user_json(user),
101:           access_token: tokens.access_token,
102:           refresh_token: tokens.refresh_token
103:         }
104:       })
105:     else
106:       {:error, :user_not_found} ->
107:         {:error, :unauthorized, "Invalid email or password"}
108: 
109:       {:error, :invalid_password} ->
110:         {:error, :unauthorized, "Invalid email or password"}
111: 
112:       {:error, reason} ->
113:         {:error, :unauthorized, "Authentication failed: #{inspect(reason)}"}
114:     end
115:   end
116: 
117:   def login(conn, _params) do
118:     conn
119:     |> put_status(:bad_request)
120:     |> json(%{error: "Missing email or password"})
121:   end
122: 
123:   @doc """
124:   Register a new user with email and password.
125:   """
126:   def register(conn, %{"email" => email, "password" => password, "name" => name} = params) do
127:     attrs = %{
128:       email: email,
129:       password: password,
130:       name: name,
131:       role: "teacher",
132:       plan: "free",
133:       institution_id: params["institution_id"]
134:     }
135: 
136:     with {:ok, user} <- Accounts.register_user(attrs),
137:          {:ok, tokens} <- Guardian.generate_tokens(user) do
138:       conn
139:       |> put_status(:created)
140:       |> json(%{
141:         data: %{
142:           user: user_json(user),
143:           access_token: tokens.access_token,
144:           refresh_token: tokens.refresh_token
145:         }
146:       })
147:     else
148:       {:error, %Ecto.Changeset{} = changeset} ->
149:         {:error, changeset}
150: 
151:       {:error, reason} ->
152:         {:error, :unprocessable_entity, "Registration failed: #{inspect(reason)}"}
153:     end
154:   end
155: 
156:   def register(conn, _params) do
157:     conn
158:     |> put_status(:bad_request)
159:     |> json(%{error: "Missing required fields: email, password, name"})
160:   end
161: 
162:   @doc """
163:   Refresh access token using refresh token.
164:   """
165:   def refresh(conn, %{"refresh_token" => refresh_token}) do
166:     case Guardian.refresh_access_token(refresh_token) do
167:       {:ok, new_access_token, _claims} ->
168:         conn
169:         |> put_status(:ok)
170:         |> json(%{data: %{access_token: new_access_token}})
171: 
172:       {:error, reason} ->
173:         {:error, :unauthorized, "Failed to refresh token: #{inspect(reason)}"}
174:     end
175:   end
176: 
177:   def refresh(conn, _params) do
178:     conn
179:     |> put_status(:bad_request)
180:     |> json(%{error: "Missing refresh_token parameter"})
181:   end
182: 
183:   @doc """
184:   Get current authenticated user info.
185:   Requires Authorization header with Bearer token.
186:   """
187:   def me(conn, _params) do
188:     case conn.assigns[:current_user] do
189:       nil ->
190:         conn
191:         |> put_status(:unauthorized)
192:         |> json(%{error: "Not authenticated"})
193: 
194:       user ->
195:         conn
196:         |> put_status(:ok)
197:         |> json(%{data: %{user: user_json(user)}})
198:     end
199:   end
200: 
201:   # Private helpers
202: 
203:   defp user_json(user) do
204:     %{
205:       id: user.id,
206:       email: user.email,
207:       name: user.name,
208:       role: user.role,
209:       credits: user.credits,
210:       plan: user.plan,
211:       email_verified: user.email_verified,
212:       institution_id: user.institution_id,
213:       inserted_at: user.inserted_at
214:     }
215:   end
216: end
````

## File: lib/hellen_web/controllers/api/credit_controller.ex
````elixir
 1: defmodule HellenWeb.API.CreditController do
 2:   use HellenWeb, :api_controller
 3: 
 4:   alias Hellen.Billing
 5: 
 6:   action_fallback HellenWeb.FallbackController
 7: 
 8:   def index(conn, _params) do
 9:     user = conn.assigns.current_user
10:     balance = Billing.get_balance(user)
11: 
12:     render(conn, :balance, balance: balance)
13:   end
14: 
15:   def history(conn, params) do
16:     user = conn.assigns.current_user
17:     limit = Map.get(params, "limit", "50") |> String.to_integer()
18: 
19:     transactions = Billing.list_transactions(user.id, limit: limit)
20:     render(conn, :history, transactions: transactions)
21:   end
22: end
````

## File: lib/hellen_web/controllers/fallback_controller.ex
````elixir
 1: defmodule HellenWeb.FallbackController do
 2:   @moduledoc """
 3:   Translates controller action results into valid `Plug.Conn` responses.
 4:   """
 5:   use HellenWeb, :controller
 6: 
 7:   # Handle Ecto.NoResultsError (raised by get! functions)
 8:   def call(conn, {:error, :user_not_found}) do
 9:     conn
10:     |> put_status(:unauthorized)
11:     |> put_view(json: HellenWeb.ErrorJSON)
12:     |> render(:"401")
13:   end
14: 
15:   def call(conn, {:error, :invalid_password}) do
16:     conn
17:     |> put_status(:unauthorized)
18:     |> put_view(json: HellenWeb.ErrorJSON)
19:     |> render(:"401")
20:   end
21: 
22:   def call(conn, {:error, status, message}) when is_atom(status) and is_binary(message) do
23:     conn
24:     |> put_status(status)
25:     |> json(%{error: message})
26:   end
27: 
28:   def call(conn, {:error, %Ecto.Changeset{} = changeset}) do
29:     conn
30:     |> put_status(:unprocessable_entity)
31:     |> put_view(json: HellenWeb.ChangesetJSON)
32:     |> render(:error, changeset: changeset)
33:   end
34: 
35:   def call(conn, {:error, :not_found}) do
36:     conn
37:     |> put_status(:not_found)
38:     |> put_view(json: HellenWeb.ErrorJSON)
39:     |> render(:"404")
40:   end
41: 
42:   def call(conn, {:error, :unauthorized}) do
43:     conn
44:     |> put_status(:unauthorized)
45:     |> put_view(json: HellenWeb.ErrorJSON)
46:     |> render(:"401")
47:   end
48: 
49:   def call(conn, {:error, :insufficient_credits}) do
50:     conn
51:     |> put_status(:payment_required)
52:     |> put_view(json: HellenWeb.ErrorJSON)
53:     |> render(:insufficient_credits)
54:   end
55: end
````

## File: lib/hellen_web/controllers/health_controller.ex
````elixir
 1: defmodule HellenWeb.HealthController do
 2:   use HellenWeb, :controller
 3: 
 4:   alias Ecto.Adapters.SQL
 5: 
 6:   def index(conn, _params) do
 7:     # Check database connection
 8:     db_status =
 9:       try do
10:         SQL.query!(Hellen.Repo, "SELECT 1")
11:         :ok
12:       rescue
13:         _ -> :error
14:       end
15: 
16:     status = if db_status == :ok, do: :ok, else: :service_unavailable
17:     http_status = if db_status == :ok, do: 200, else: 503
18: 
19:     conn
20:     |> put_status(http_status)
21:     |> json(%{
22:       status: status,
23:       timestamp: DateTime.utc_now() |> DateTime.to_iso8601(),
24:       services: %{
25:         database: db_status,
26:         application: :ok
27:       }
28:     })
29:   end
30: end
````

## File: lib/hellen_web/controllers/report_controller.ex
````elixir
  1: defmodule HellenWeb.ReportController do
  2:   @moduledoc """
  3:   Controller for generating and downloading PDF reports.
  4:   """
  5:   use HellenWeb, :controller
  6: 
  7:   alias Hellen.Reports
  8: 
  9:   plug :require_coordinator
 10: 
 11:   @doc """
 12:   Download monthly institution report.
 13:   """
 14:   def monthly(conn, params) do
 15:     user = conn.assigns.current_user
 16:     institution_id = user.institution_id
 17: 
 18:     if institution_id do
 19:       month = parse_int(params["month"], Date.utc_today().month)
 20:       year = parse_int(params["year"], Date.utc_today().year)
 21: 
 22:       case Reports.generate_monthly_report(institution_id, month: month, year: year) do
 23:         {:ok, pdf_binary} ->
 24:           filename = "relatorio-mensal-#{month}-#{year}.pdf"
 25:           send_pdf(conn, pdf_binary, filename)
 26: 
 27:         {:error, reason} ->
 28:           conn
 29:           |> put_flash(:error, "Erro ao gerar relatorio: #{inspect(reason)}")
 30:           |> redirect(to: ~p"/institution/reports")
 31:       end
 32:     else
 33:       conn
 34:       |> put_flash(:error, "Instituicao nao encontrada")
 35:       |> redirect(to: ~p"/institution/reports")
 36:     end
 37:   end
 38: 
 39:   @doc """
 40:   Download teacher report.
 41:   """
 42:   def teacher(conn, %{"id" => teacher_id} = params) do
 43:     user = conn.assigns.current_user
 44:     institution_id = user.institution_id
 45: 
 46:     # Verify the teacher belongs to the same institution
 47:     teacher = Hellen.Accounts.get_user(teacher_id)
 48: 
 49:     if teacher && teacher.institution_id == institution_id do
 50:       month = parse_int(params["month"], Date.utc_today().month)
 51:       year = parse_int(params["year"], Date.utc_today().year)
 52: 
 53:       case Reports.generate_teacher_report(teacher_id, month: month, year: year) do
 54:         {:ok, pdf_binary} ->
 55:           teacher_name =
 56:             String.replace(teacher.name || "professor", " ", "-") |> String.downcase()
 57: 
 58:           filename = "relatorio-#{teacher_name}-#{month}-#{year}.pdf"
 59:           send_pdf(conn, pdf_binary, filename)
 60: 
 61:         {:error, reason} ->
 62:           conn
 63:           |> put_flash(:error, "Erro ao gerar relatorio: #{inspect(reason)}")
 64:           |> redirect(to: ~p"/institution/reports")
 65:       end
 66:     else
 67:       conn
 68:       |> put_flash(:error, "Professor nao encontrado")
 69:       |> redirect(to: ~p"/institution/reports")
 70:     end
 71:   end
 72: 
 73:   @doc """
 74:   Download analysis export.
 75:   """
 76:   def analysis(conn, %{"id" => analysis_id}) do
 77:     user = conn.assigns.current_user
 78:     institution_id = user.institution_id
 79: 
 80:     # Verify the analysis belongs to the same institution
 81:     try do
 82:       analysis = Hellen.Analysis.get_analysis!(analysis_id, institution_id)
 83: 
 84:       case Reports.generate_analysis_export(analysis.id) do
 85:         {:ok, pdf_binary} ->
 86:           filename = "analise-#{String.slice(analysis_id, 0, 8)}.pdf"
 87:           send_pdf(conn, pdf_binary, filename)
 88: 
 89:         {:error, reason} ->
 90:           conn
 91:           |> put_flash(:error, "Erro ao gerar relatorio: #{inspect(reason)}")
 92:           |> redirect(to: ~p"/institution/reports")
 93:       end
 94:     rescue
 95:       Ecto.NoResultsError ->
 96:         conn
 97:         |> put_flash(:error, "Analise nao encontrada")
 98:         |> redirect(to: ~p"/institution/reports")
 99:     end
100:   end
101: 
102:   # Helpers
103: 
104:   defp send_pdf(conn, pdf_binary, filename) do
105:     conn
106:     |> put_resp_content_type("application/pdf")
107:     |> put_resp_header("content-disposition", "attachment; filename=\"#{filename}\"")
108:     |> send_resp(200, pdf_binary)
109:   end
110: 
111:   defp parse_int(nil, default), do: default
112:   defp parse_int("", default), do: default
113: 
114:   defp parse_int(value, default) when is_binary(value) do
115:     case Integer.parse(value) do
116:       {int, _} -> int
117:       :error -> default
118:     end
119:   end
120: 
121:   defp parse_int(value, _default) when is_integer(value), do: value
122: 
123:   defp require_coordinator(conn, _opts) do
124:     user = conn.assigns[:current_user]
125: 
126:     if user && user.role in ["coordinator", "admin"] do
127:       conn
128:     else
129:       conn
130:       |> put_flash(:error, "Acesso negado")
131:       |> redirect(to: ~p"/dashboard")
132:       |> halt()
133:     end
134:   end
135: end
````

## File: lib/hellen_web/live/admin_live/health.ex
````elixir
  1: defmodule HellenWeb.AdminLive.Health do
  2:   @moduledoc """
  3:   Admin System Health - Monitor system status and health metrics.
  4:   """
  5:   use HellenWeb, :live_view
  6: 
  7:   @impl true
  8:   def mount(_params, _session, socket) do
  9:     if connected?(socket) do
 10:       :timer.send_interval(30_000, self(), :refresh_health)
 11:     end
 12: 
 13:     {:ok,
 14:      socket
 15:      |> assign(page_title: "Sistema - Admin")
 16:      |> assign_health_data()}
 17:   end
 18: 
 19:   @impl true
 20:   def handle_info(:refresh_health, socket) do
 21:     {:noreply, assign_health_data(socket)}
 22:   end
 23: 
 24:   defp assign_health_data(socket) do
 25:     socket
 26:     |> assign(beam_info: get_beam_info())
 27:     |> assign(database_info: get_database_info())
 28:     |> assign(oban_info: get_oban_info())
 29:     |> assign(redis_info: get_redis_info())
 30:   end
 31: 
 32:   defp get_beam_info do
 33:     memory = :erlang.memory()
 34: 
 35:     %{
 36:       uptime: get_uptime(),
 37:       process_count: :erlang.system_info(:process_count),
 38:       process_limit: :erlang.system_info(:process_limit),
 39:       total_memory_mb: div(memory[:total], 1024 * 1024),
 40:       processes_memory_mb: div(memory[:processes], 1024 * 1024),
 41:       atom_count: :erlang.system_info(:atom_count),
 42:       atom_limit: :erlang.system_info(:atom_limit),
 43:       schedulers: :erlang.system_info(:schedulers_online),
 44:       otp_release: :erlang.system_info(:otp_release) |> to_string(),
 45:       elixir_version: System.version()
 46:     }
 47:   end
 48: 
 49:   defp get_uptime do
 50:     {uptime_ms, _} = :erlang.statistics(:wall_clock)
 51:     uptime_seconds = div(uptime_ms, 1000)
 52:     days = div(uptime_seconds, 86_400)
 53:     hours = div(rem(uptime_seconds, 86_400), 3600)
 54:     minutes = div(rem(uptime_seconds, 3600), 60)
 55: 
 56:     cond do
 57:       days > 0 -> "#{days}d #{hours}h #{minutes}m"
 58:       hours > 0 -> "#{hours}h #{minutes}m"
 59:       true -> "#{minutes}m"
 60:     end
 61:   end
 62: 
 63:   defp get_database_info do
 64:     pool_size = Application.get_env(:hellen, Hellen.Repo)[:pool_size] || 10
 65:     %{status: :ok, pool_size: pool_size}
 66:   rescue
 67:     _ -> %{status: :error, message: "Database unavailable"}
 68:   end
 69: 
 70:   defp get_oban_info do
 71:     queues = Application.get_env(:hellen, Oban)[:queues] || []
 72: 
 73:     %{
 74:       status: :ok,
 75:       queues:
 76:         Enum.map(queues, fn {name, limit} ->
 77:           %{name: name, limit: limit}
 78:         end)
 79:     }
 80:   rescue
 81:     _ -> %{status: :error, message: "Oban unavailable"}
 82:   end
 83: 
 84:   defp get_redis_info do
 85:     redis_url = Application.get_env(:hellen, :redis_url)
 86: 
 87:     if redis_url do
 88:       %{status: :ok}
 89:     else
 90:       %{status: :error, message: "Redis not configured"}
 91:     end
 92:   end
 93: 
 94:   @impl true
 95:   def render(assigns) do
 96:     ~H"""
 97:     <div class="space-y-6">
 98:       <!-- Header -->
 99:       <div class="flex items-center justify-between">
100:         <div>
101:           <div class="flex items-center gap-2">
102:             <.link
103:               navigate={~p"/admin"}
104:               class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"
105:             >
106:               <.icon name="hero-arrow-left" class="h-5 w-5" />
107:             </.link>
108:             <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Saude do Sistema</h1>
109:           </div>
110:           <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
111:             Metricas e status dos servicos
112:           </p>
113:         </div>
114:         <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
115:           <.icon name="hero-arrow-path" class="h-4 w-4" /> Atualizado a cada 30s
116:         </div>
117:       </div>
118:       <!-- Service Status Grid -->
119:       <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
120:         <.service_card
121:           name="Aplicacao"
122:           icon="hero-server"
123:           status={:ok}
124:           details={"Uptime: #{@beam_info.uptime}"}
125:         />
126:         <.service_card
127:           name="Database"
128:           icon="hero-circle-stack"
129:           status={@database_info.status}
130:           details={"Pool: #{@database_info[:pool_size] || "N/A"}"}
131:         />
132:         <.service_card
133:           name="Oban Jobs"
134:           icon="hero-queue-list"
135:           status={@oban_info.status}
136:           details={"#{length(@oban_info[:queues] || [])} filas"}
137:         />
138:         <.service_card
139:           name="Redis Cache"
140:           icon="hero-bolt"
141:           status={@redis_info.status}
142:           details={if @redis_info.status == :ok, do: "Conectado", else: @redis_info[:message]}
143:         />
144:       </div>
145:       <!-- BEAM/Erlang Info -->
146:       <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
147:         <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">BEAM Virtual Machine</h3>
148:         <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
149:           <.metric_item label="Uptime" value={@beam_info.uptime} />
150:           <.metric_item label="OTP Release" value={@beam_info.otp_release} />
151:           <.metric_item label="Elixir" value={@beam_info.elixir_version} />
152:           <.metric_item label="Schedulers" value={@beam_info.schedulers} />
153:         </div>
154:       </div>
155:       <!-- Memory & Processes -->
156:       <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
157:         <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
158:           <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Memoria</h3>
159:           <div class="space-y-4">
160:             <.metric_bar
161:               label="Total"
162:               value={"#{@beam_info.total_memory_mb} MB"}
163:               percentage={min(@beam_info.total_memory_mb / 10, 100)}
164:               color="bg-indigo-500"
165:             />
166:             <.metric_bar
167:               label="Processos"
168:               value={"#{@beam_info.processes_memory_mb} MB"}
169:               percentage={@beam_info.processes_memory_mb / @beam_info.total_memory_mb * 100}
170:               color="bg-purple-500"
171:             />
172:           </div>
173:         </div>
174: 
175:         <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
176:           <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Processos & Atoms</h3>
177:           <div class="space-y-4">
178:             <.metric_bar
179:               label="Processos"
180:               value={"#{@beam_info.process_count} / #{@beam_info.process_limit}"}
181:               percentage={@beam_info.process_count / @beam_info.process_limit * 100}
182:               color="bg-emerald-500"
183:             />
184:             <.metric_bar
185:               label="Atoms"
186:               value={"#{@beam_info.atom_count} / #{@beam_info.atom_limit}"}
187:               percentage={@beam_info.atom_count / @beam_info.atom_limit * 100}
188:               color="bg-amber-500"
189:             />
190:           </div>
191:         </div>
192:       </div>
193:       <!-- Oban Queues -->
194:       <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
195:         <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
196:           Filas de Processamento (Oban)
197:         </h3>
198:         <div :if={@oban_info.status == :ok} class="grid grid-cols-2 md:grid-cols-4 gap-4">
199:           <div
200:             :for={queue <- @oban_info.queues}
201:             class="p-4 rounded-lg bg-gray-50 dark:bg-slate-900/50"
202:           >
203:             <p class="text-sm font-medium text-gray-900 dark:text-white capitalize">
204:               <%= queue.name %>
205:             </p>
206:             <p class="text-xs text-gray-500 dark:text-gray-400">Limite: <%= queue.limit %> workers</p>
207:           </div>
208:         </div>
209:         <div :if={@oban_info.status != :ok} class="text-red-600 dark:text-red-400">
210:           <%= @oban_info[:message] || "Erro ao carregar filas" %>
211:         </div>
212:       </div>
213:       <!-- Environment Info -->
214:       <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
215:         <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Ambiente</h3>
216:         <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
217:           <.metric_item
218:             label="Mix Env"
219:             value={Application.get_env(:hellen, :environment, :prod) |> to_string()}
220:           />
221:           <.metric_item label="Node" value={Node.self() |> to_string() |> String.slice(0..20)} />
222:           <.metric_item label="Phoenix" value={Application.spec(:phoenix, :vsn) |> to_string()} />
223:           <.metric_item
224:             label="LiveView"
225:             value={Application.spec(:phoenix_live_view, :vsn) |> to_string()}
226:           />
227:         </div>
228:       </div>
229:     </div>
230:     """
231:   end
232: 
233:   defp service_card(assigns) do
234:     ~H"""
235:     <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-4">
236:       <div class="flex items-center gap-3">
237:         <div class={[
238:           "w-10 h-10 rounded-lg flex items-center justify-center",
239:           if(@status == :ok,
240:             do: "bg-emerald-100 dark:bg-emerald-900/30",
241:             else: "bg-red-100 dark:bg-red-900/30"
242:           )
243:         ]}>
244:           <.icon
245:             name={@icon}
246:             class={"h-5 w-5 " <> if(@status == :ok, do: "text-emerald-600 dark:text-emerald-400", else: "text-red-600 dark:text-red-400")}
247:           />
248:         </div>
249:         <div class="flex-1">
250:           <div class="flex items-center gap-2">
251:             <p class="text-sm font-medium text-gray-900 dark:text-white"><%= @name %></p>
252:             <span class={[
253:               "w-2 h-2 rounded-full",
254:               if(@status == :ok, do: "bg-emerald-500", else: "bg-red-500")
255:             ]}>
256:             </span>
257:           </div>
258:           <p class="text-xs text-gray-500 dark:text-gray-400"><%= @details %></p>
259:         </div>
260:       </div>
261:     </div>
262:     """
263:   end
264: 
265:   defp metric_item(assigns) do
266:     ~H"""
267:     <div>
268:       <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider"><%= @label %></p>
269:       <p class="text-lg font-semibold text-gray-900 dark:text-white mt-1"><%= @value %></p>
270:     </div>
271:     """
272:   end
273: 
274:   defp metric_bar(assigns) do
275:     ~H"""
276:     <div>
277:       <div class="flex items-center justify-between mb-1">
278:         <span class="text-sm text-gray-700 dark:text-gray-300"><%= @label %></span>
279:         <span class="text-sm font-medium text-gray-900 dark:text-white"><%= @value %></span>
280:       </div>
281:       <div class="w-full h-2 bg-gray-200 dark:bg-slate-700 rounded-full overflow-hidden">
282:         <div
283:           class={[@color, "h-full rounded-full transition-all"]}
284:           style={"width: #{min(@percentage, 100)}%"}
285:         >
286:         </div>
287:       </div>
288:     </div>
289:     """
290:   end
291: end
````

## File: lib/hellen_web/live/analytics_live/index.ex
````elixir
  1: defmodule HellenWeb.AnalyticsLive.Index do
  2:   @moduledoc """
  3:   Advanced analytics page with trend comparisons, BNCC coverage, and data exports.
  4:   """
  5:   use HellenWeb, :live_view
  6: 
  7:   alias Hellen.Analysis
  8:   alias Hellen.Exports
  9: 
 10:   @impl true
 11:   def mount(_params, _session, socket) do
 12:     user = socket.assigns.current_user
 13: 
 14:     {:ok,
 15:      socket
 16:      |> assign(page_title: "Analytics")
 17:      |> assign(period: 30)
 18:      |> assign(active_tab: :overview)
 19:      |> load_analytics_data(user)}
 20:   end
 21: 
 22:   defp load_analytics_data(socket, user) do
 23:     period = socket.assigns.period
 24: 
 25:     socket
 26:     |> assign(score_comparison: Analysis.get_score_comparison(user.id, days: period))
 27:     |> assign(daily_scores: Analysis.get_daily_scores(user.id, days: period))
 28:     |> assign(bncc_coverage: Analysis.get_bncc_coverage_detailed(user.id, days: period * 3))
 29:     |> assign(score_history: Analysis.get_user_score_history(user.id, limit: 20))
 30:     |> maybe_load_institution_data(user)
 31:   end
 32: 
 33:   defp maybe_load_institution_data(socket, user) do
 34:     if user.institution_id do
 35:       socket
 36:       |> assign(
 37:         institution_comparison:
 38:           Analysis.get_institution_comparison(user.institution_id, days: socket.assigns.period)
 39:       )
 40:       |> assign(
 41:         alert_timeline:
 42:           Analysis.get_alert_timeline(user.institution_id, days: socket.assigns.period)
 43:       )
 44:     else
 45:       socket
 46:       |> assign(institution_comparison: nil)
 47:       |> assign(alert_timeline: [])
 48:     end
 49:   end
 50: 
 51:   # PWA OfflineIndicator hook events - ignore silently
 52:   @impl true
 53:   def handle_event("online", _params, socket), do: {:noreply, socket}
 54:   def handle_event("offline", _params, socket), do: {:noreply, socket}
 55: 
 56:   @impl true
 57:   def handle_event("change_period", %{"period" => period}, socket) do
 58:     period = String.to_integer(period)
 59: 
 60:     {:noreply,
 61:      socket
 62:      |> assign(period: period)
 63:      |> load_analytics_data(socket.assigns.current_user)}
 64:   end
 65: 
 66:   def handle_event("change_tab", %{"tab" => tab}, socket) do
 67:     {:noreply, assign(socket, active_tab: String.to_existing_atom(tab))}
 68:   end
 69: 
 70:   def handle_event("export_csv", %{"type" => type}, socket) do
 71:     user = socket.assigns.current_user
 72:     period = socket.assigns.period
 73: 
 74:     {filename, csv_content} =
 75:       case type do
 76:         "scores" ->
 77:           {"scores_#{Date.to_string(Date.utc_today())}.csv",
 78:            Exports.generate_csv(:score_history, user.id, days: period * 3)}
 79: 
 80:         "bncc" ->
 81:           {"bncc_coverage_#{Date.to_string(Date.utc_today())}.csv",
 82:            Exports.generate_csv(:bncc_coverage, user.id, days: period * 3)}
 83: 
 84:         "daily" ->
 85:           {"daily_scores_#{Date.to_string(Date.utc_today())}.csv",
 86:            Exports.generate_csv(:daily_scores, user.id, days: period)}
 87: 
 88:         _ ->
 89:           {"export.csv", ""}
 90:       end
 91: 
 92:     {:noreply,
 93:      socket
 94:      |> push_event("download_csv", %{filename: filename, content: csv_content})}
 95:   end
 96: 
 97:   @impl true
 98:   def render(assigns) do
 99:     ~H"""
100:     <div class="space-y-6">
101:       <!-- Header -->
102:       <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
103:         <div>
104:           <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Analytics</h1>
105:           <p class="text-sm text-gray-500 dark:text-gray-400">
106:             Tendencias, comparativos e insights detalhados
107:           </p>
108:         </div>
109: 
110:         <div class="flex items-center gap-4">
111:           <!-- Period Selector -->
112:           <div class="flex items-center gap-2">
113:             <span class="text-sm text-gray-500 dark:text-gray-400">Periodo:</span>
114:             <select
115:               phx-change="change_period"
116:               name="period"
117:               class="rounded-lg border-gray-300 dark:border-slate-600 dark:bg-slate-700 text-sm"
118:             >
119:               <option value="7" selected={@period == 7}>7 dias</option>
120:               <option value="30" selected={@period == 30}>30 dias</option>
121:               <option value="90" selected={@period == 90}>90 dias</option>
122:               <option value="365" selected={@period == 365}>12 meses</option>
123:             </select>
124:           </div>
125:           <!-- Export Dropdown -->
126:           <div class="relative" phx-click-away="close_export_menu">
127:             <button
128:               type="button"
129:               phx-click={JS.toggle(to: "#export-menu")}
130:               class="inline-flex items-center px-4 py-2 bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-slate-600"
131:             >
132:               <.icon name="hero-arrow-down-tray" class="h-4 w-4 mr-2" /> Exportar
133:             </button>
134:             <div
135:               id="export-menu"
136:               class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-lg shadow-lg border border-gray-200 dark:border-slate-700 py-1 z-10"
137:             >
138:               <button
139:                 phx-click="export_csv"
140:                 phx-value-type="scores"
141:                 class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-700"
142:               >
143:                 Historico de Scores (CSV)
144:               </button>
145:               <button
146:                 phx-click="export_csv"
147:                 phx-value-type="bncc"
148:                 class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-700"
149:               >
150:                 Cobertura BNCC (CSV)
151:               </button>
152:               <button
153:                 phx-click="export_csv"
154:                 phx-value-type="daily"
155:                 class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-700"
156:               >
157:                 Scores Diarios (CSV)
158:               </button>
159:             </div>
160:           </div>
161:         </div>
162:       </div>
163:       <!-- Tabs -->
164:       <div class="border-b border-gray-200 dark:border-slate-700">
165:         <nav class="-mb-px flex space-x-8">
166:           <.tab_button active={@active_tab == :overview} tab="overview" label="Visao Geral" />
167:           <.tab_button active={@active_tab == :bncc} tab="bncc" label="Cobertura BNCC" />
168:           <.tab_button active={@active_tab == :trends} tab="trends" label="Tendencias" />
169:           <.tab_button
170:             :if={@institution_comparison}
171:             active={@active_tab == :comparison}
172:             tab="comparison"
173:             label="Comparativo"
174:           />
175:         </nav>
176:       </div>
177:       <!-- Tab Content -->
178:       <div class="space-y-6">
179:         <!-- Overview Tab -->
180:         <div :if={@active_tab == :overview}>
181:           <!-- Score Comparison Cards -->
182:           <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
183:             <.comparison_card
184:               title="Score Atual"
185:               value={Float.round(@score_comparison.current_avg, 1)}
186:               previous={Float.round(@score_comparison.previous_avg, 1)}
187:               change={@score_comparison.change_percent}
188:               trend={@score_comparison.trend}
189:               suffix="/100"
190:             />
191:             <.comparison_card
192:               :if={@institution_comparison}
193:               title="vs. Instituicao"
194:               value={@institution_comparison.institution_avg}
195:               suffix="/100"
196:               subtext={"Media plataforma: #{@institution_comparison.platform_avg}"}
197:             />
198:             <.comparison_card
199:               :if={@institution_comparison}
200:               title="Ranking"
201:               value={@institution_comparison.rank}
202:               suffix={"/ #{@institution_comparison.total_institutions}"}
203:               subtext={"Percentil #{@institution_comparison.percentile}%"}
204:             />
205:           </div>
206:           <!-- Score History Chart -->
207:           <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
208:             <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
209:               Evolucao de Scores
210:             </h3>
211:             <div
212:               id="score-chart"
213:               phx-hook="AnalyticsChart"
214:               data-type="line"
215:               data-chart={Jason.encode!(build_score_chart_data(@daily_scores))}
216:               class="h-64"
217:             >
218:               <div class="flex items-center justify-center h-full text-gray-500">
219:                 <.icon name="hero-chart-bar" class="h-8 w-8 mr-2" /> Carregando grafico...
220:               </div>
221:             </div>
222:           </div>
223:           <!-- Recent Analyses -->
224:           <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
225:             <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
226:               Analises Recentes
227:             </h3>
228:             <div class="overflow-x-auto">
229:               <table class="min-w-full divide-y divide-gray-200 dark:divide-slate-700">
230:                 <thead>
231:                   <tr>
232:                     <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
233:                       Data
234:                     </th>
235:                     <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
236:                       Aula
237:                     </th>
238:                     <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
239:                       Score
240:                     </th>
241:                   </tr>
242:                 </thead>
243:                 <tbody class="divide-y divide-gray-200 dark:divide-slate-700">
244:                   <tr
245:                     :for={item <- @score_history}
246:                     class="hover:bg-gray-50 dark:hover:bg-slate-700/50"
247:                   >
248:                     <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">
249:                       <%= Calendar.strftime(item.date, "%d/%m/%Y") %>
250:                     </td>
251:                     <td class="px-4 py-3">
252:                       <.link
253:                         navigate={~p"/lessons/#{item.lesson_id}"}
254:                         class="text-sm font-medium text-indigo-600 dark:text-indigo-400 hover:underline"
255:                       >
256:                         <%= item.lesson_title %>
257:                       </.link>
258:                     </td>
259:                     <td class="px-4 py-3 text-right">
260:                       <span class={"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium #{score_color(item.score)}"}>
261:                         <%= Float.round(item.score, 1) %>
262:                       </span>
263:                     </td>
264:                   </tr>
265:                   <tr :if={@score_history == []}>
266:                     <td colspan="3" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
267:                       Nenhuma analise encontrada no periodo.
268:                     </td>
269:                   </tr>
270:                 </tbody>
271:               </table>
272:             </div>
273:           </div>
274:         </div>
275:         <!-- BNCC Tab -->
276:         <div :if={@active_tab == :bncc}>
277:           <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
278:             <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
279:               Competencias BNCC Trabalhadas
280:             </h3>
281:             <!-- Category Summary -->
282:             <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-6">
283:               <.bncc_category_card
284:                 :for={{category, items} <- group_by_category(@bncc_coverage)}
285:                 category={category}
286:                 count={length(items)}
287:               />
288:             </div>
289:             <!-- Detailed Table -->
290:             <div class="overflow-x-auto">
291:               <table class="min-w-full divide-y divide-gray-200 dark:divide-slate-700">
292:                 <thead>
293:                   <tr>
294:                     <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
295:                       Codigo
296:                     </th>
297:                     <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
298:                       Competencia
299:                     </th>
300:                     <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
301:                       Categoria
302:                     </th>
303:                     <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
304:                       Vezes
305:                     </th>
306:                     <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
307:                       Score Medio
308:                     </th>
309:                   </tr>
310:                 </thead>
311:                 <tbody class="divide-y divide-gray-200 dark:divide-slate-700">
312:                   <tr
313:                     :for={item <- @bncc_coverage}
314:                     class="hover:bg-gray-50 dark:hover:bg-slate-700/50"
315:                   >
316:                     <td class="px-4 py-3 text-sm font-mono text-gray-900 dark:text-white">
317:                       <%= item.code || "N/A" %>
318:                     </td>
319:                     <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300 max-w-md truncate">
320:                       <%= item.name || "Sem descricao" %>
321:                     </td>
322:                     <td class="px-4 py-3 text-center">
323:                       <span class={"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium #{category_color(item.category)}"}>
324:                         <%= item.category %>
325:                       </span>
326:                     </td>
327:                     <td class="px-4 py-3 text-center text-sm text-gray-900 dark:text-white">
328:                       <%= item.count %>
329:                     </td>
330:                     <td class="px-4 py-3 text-center">
331:                       <span class={"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium #{score_color(item.avg_score)}"}>
332:                         <%= format_decimal(item.avg_score) %>
333:                       </span>
334:                     </td>
335:                   </tr>
336:                   <tr :if={@bncc_coverage == []}>
337:                     <td colspan="5" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
338:                       Nenhuma competencia BNCC registrada no periodo.
339:                     </td>
340:                   </tr>
341:                 </tbody>
342:               </table>
343:             </div>
344:           </div>
345:         </div>
346:         <!-- Trends Tab -->
347:         <div :if={@active_tab == :trends}>
348:           <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
349:             <!-- Trend Indicator -->
350:             <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
351:               <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
352:                 Tendencia de Performance
353:               </h3>
354:               <div class="flex items-center justify-center py-8">
355:                 <div class="text-center">
356:                   <div class={"w-24 h-24 mx-auto rounded-full flex items-center justify-center #{trend_bg(@score_comparison.trend)}"}>
357:                     <.icon
358:                       name={trend_icon(@score_comparison.trend)}
359:                       class={"h-12 w-12 #{trend_color(@score_comparison.trend)}"}
360:                     />
361:                   </div>
362:                   <p class={"mt-4 text-2xl font-bold #{trend_color(@score_comparison.trend)}"}>
363:                     <%= trend_label(@score_comparison.trend) %>
364:                   </p>
365:                   <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
366:                     <%= if @score_comparison.change_percent != 0 do %>
367:                       <%= if @score_comparison.change_percent > 0, do: "+", else: "" %><%= @score_comparison.change_percent %>% vs. periodo anterior
368:                     <% else %>
369:                       Sem variacao significativa
370:                     <% end %>
371:                   </p>
372:                 </div>
373:               </div>
374:             </div>
375:             <!-- Period Comparison -->
376:             <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
377:               <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
378:                 Comparativo de Periodos
379:               </h3>
380:               <div class="space-y-6 py-4">
381:                 <div>
382:                   <div class="flex justify-between text-sm mb-2">
383:                     <span class="text-gray-600 dark:text-gray-400">
384:                       Periodo Atual (<%= @period %> dias)
385:                     </span>
386:                     <span class="font-medium text-gray-900 dark:text-white">
387:                       <%= Float.round(@score_comparison.current_avg, 1) %>
388:                     </span>
389:                   </div>
390:                   <div class="h-3 bg-gray-200 dark:bg-slate-700 rounded-full overflow-hidden">
391:                     <div
392:                       class="h-full bg-indigo-600 rounded-full transition-all duration-500"
393:                       style={"width: #{@score_comparison.current_avg}%"}
394:                     />
395:                   </div>
396:                 </div>
397:                 <div>
398:                   <div class="flex justify-between text-sm mb-2">
399:                     <span class="text-gray-600 dark:text-gray-400">Periodo Anterior</span>
400:                     <span class="font-medium text-gray-900 dark:text-white">
401:                       <%= Float.round(@score_comparison.previous_avg, 1) %>
402:                     </span>
403:                   </div>
404:                   <div class="h-3 bg-gray-200 dark:bg-slate-700 rounded-full overflow-hidden">
405:                     <div
406:                       class="h-full bg-gray-400 dark:bg-slate-500 rounded-full transition-all duration-500"
407:                       style={"width: #{@score_comparison.previous_avg}%"}
408:                     />
409:                   </div>
410:                 </div>
411:               </div>
412:             </div>
413:           </div>
414:           <!-- Alert Timeline (Coordinators only) -->
415:           <div
416:             :if={@alert_timeline != []}
417:             class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6 mt-6"
418:           >
419:             <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
420:               Timeline de Alertas
421:             </h3>
422:             <div
423:               id="alert-chart"
424:               phx-hook="AnalyticsChart"
425:               data-type="bar"
426:               data-chart={Jason.encode!(build_alert_chart_data(@alert_timeline))}
427:               class="h-64"
428:             >
429:               <div class="flex items-center justify-center h-full text-gray-500">
430:                 <.icon name="hero-chart-bar" class="h-8 w-8 mr-2" /> Carregando grafico...
431:               </div>
432:             </div>
433:           </div>
434:         </div>
435:         <!-- Comparison Tab -->
436:         <div :if={@active_tab == :comparison && @institution_comparison}>
437:           <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
438:             <!-- Institution vs Platform -->
439:             <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
440:               <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
441:                 Sua Instituicao vs. Plataforma
442:               </h3>
443:               <div class="space-y-6 py-4">
444:                 <div>
445:                   <div class="flex justify-between text-sm mb-2">
446:                     <span class="text-gray-600 dark:text-gray-400">Sua Instituicao</span>
447:                     <span class="font-medium text-indigo-600 dark:text-indigo-400">
448:                       <%= @institution_comparison.institution_avg %>
449:                     </span>
450:                   </div>
451:                   <div class="h-4 bg-gray-200 dark:bg-slate-700 rounded-full overflow-hidden">
452:                     <div
453:                       class="h-full bg-indigo-600 rounded-full transition-all duration-500"
454:                       style={"width: #{@institution_comparison.institution_avg}%"}
455:                     />
456:                   </div>
457:                 </div>
458:                 <div>
459:                   <div class="flex justify-between text-sm mb-2">
460:                     <span class="text-gray-600 dark:text-gray-400">Media da Plataforma</span>
461:                     <span class="font-medium text-gray-600 dark:text-gray-400">
462:                       <%= @institution_comparison.platform_avg %>
463:                     </span>
464:                   </div>
465:                   <div class="h-4 bg-gray-200 dark:bg-slate-700 rounded-full overflow-hidden">
466:                     <div
467:                       class="h-full bg-gray-400 dark:bg-slate-500 rounded-full transition-all duration-500"
468:                       style={"width: #{@institution_comparison.platform_avg}%"}
469:                     />
470:                   </div>
471:                 </div>
472:               </div>
473:             </div>
474:             <!-- Ranking Card -->
475:             <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
476:               <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
477:                 Posicao no Ranking
478:               </h3>
479:               <div class="flex items-center justify-center py-8">
480:                 <div class="text-center">
481:                   <div class="w-32 h-32 mx-auto rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
482:                     <div class="text-white">
483:                       <span class="text-4xl font-bold"><%= @institution_comparison.rank %></span>
484:                       <span class="text-lg">/ <%= @institution_comparison.total_institutions %></span>
485:                     </div>
486:                   </div>
487:                   <p class="mt-4 text-lg font-medium text-gray-900 dark:text-white">
488:                     Top <%= 100 - @institution_comparison.percentile %>%
489:                   </p>
490:                   <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
491:                     Percentil <%= @institution_comparison.percentile %>
492:                   </p>
493:                 </div>
494:               </div>
495:             </div>
496:           </div>
497:         </div>
498:       </div>
499:     </div>
500: 
501:     <script>
502:       window.addEventListener("phx:download_csv", (e) => {
503:         const { filename, content } = e.detail;
504:         const blob = new Blob([content], { type: "text/csv;charset=utf-8;" });
505:         const link = document.createElement("a");
506:         link.href = URL.createObjectURL(blob);
507:         link.download = filename;
508:         link.click();
509:         URL.revokeObjectURL(link.href);
510:       });
511:     </script>
512:     """
513:   end
514: 
515:   # Components
516: 
517:   defp tab_button(assigns) do
518:     ~H"""
519:     <button
520:       phx-click="change_tab"
521:       phx-value-tab={@tab}
522:       class={"py-4 px-1 border-b-2 font-medium text-sm transition-colors " <>
523:         if @active do
524:           "border-indigo-500 text-indigo-600 dark:text-indigo-400"
525:         else
526:           "border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300"
527:         end}
528:     >
529:       <%= @label %>
530:     </button>
531:     """
532:   end
533: 
534:   defp comparison_card(assigns) do
535:     assigns =
536:       assigns
537:       |> assign_new(:previous, fn -> nil end)
538:       |> assign_new(:change, fn -> nil end)
539:       |> assign_new(:trend, fn -> nil end)
540:       |> assign_new(:suffix, fn -> "" end)
541:       |> assign_new(:subtext, fn -> nil end)
542: 
543:     ~H"""
544:     <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6">
545:       <p class="text-sm font-medium text-gray-500 dark:text-gray-400"><%= @title %></p>
546:       <div class="mt-2 flex items-baseline">
547:         <p class="text-3xl font-bold text-gray-900 dark:text-white">
548:           <%= @value %>
549:         </p>
550:         <span :if={@suffix} class="ml-1 text-lg text-gray-500 dark:text-gray-400">
551:           <%= @suffix %>
552:         </span>
553:       </div>
554:       <div :if={@previous} class="mt-2 flex items-center text-sm">
555:         <span :if={@trend} class={"flex items-center " <> trend_color(@trend)}>
556:           <.icon name={trend_icon(@trend)} class="h-4 w-4 mr-1" />
557:           <%= if @change && @change != 0, do: "#{if @change > 0, do: "+", else: ""}#{@change}%" %>
558:         </span>
559:         <span class="ml-2 text-gray-500 dark:text-gray-400">vs. <%= @previous %></span>
560:       </div>
561:       <p :if={@subtext} class="mt-2 text-sm text-gray-500 dark:text-gray-400"><%= @subtext %></p>
562:     </div>
563:     """
564:   end
565: 
566:   defp bncc_category_card(assigns) do
567:     ~H"""
568:     <div class={"rounded-lg p-4 text-center " <> category_bg(@category)}>
569:       <p class="text-2xl font-bold text-gray-900 dark:text-white"><%= @count %></p>
570:       <p class="text-sm font-medium text-gray-600 dark:text-gray-400">
571:         <%= category_label(@category) %>
572:       </p>
573:     </div>
574:     """
575:   end
576: 
577:   # Helper functions
578: 
579:   defp build_score_chart_data(daily_scores) do
580:     %{
581:       labels: Enum.map(daily_scores, fn d -> Date.to_string(d.date) end),
582:       datasets: [
583:         %{
584:           label: "Score Medio",
585:           data: Enum.map(daily_scores, fn d -> format_decimal(d.avg_score) end),
586:           borderColor: "#6366f1",
587:           backgroundColor: "rgba(99, 102, 241, 0.1)",
588:           fill: true,
589:           tension: 0.3
590:         }
591:       ]
592:     }
593:   end
594: 
595:   defp build_alert_chart_data(alert_timeline) do
596:     %{
597:       labels: Enum.map(alert_timeline, fn d -> format_period(d.period) end),
598:       datasets: [
599:         %{
600:           label: "Alta",
601:           data: Enum.map(alert_timeline, & &1.high),
602:           backgroundColor: "#ef4444"
603:         },
604:         %{
605:           label: "Media",
606:           data: Enum.map(alert_timeline, & &1.medium),
607:           backgroundColor: "#f59e0b"
608:         },
609:         %{
610:           label: "Baixa",
611:           data: Enum.map(alert_timeline, & &1.low),
612:           backgroundColor: "#10b981"
613:         }
614:       ]
615:     }
616:   end
617: 
618:   defp format_period(%Date{} = date), do: Calendar.strftime(date, "%d/%m")
619:   defp format_period(%DateTime{} = dt), do: Calendar.strftime(dt, "%d/%m")
620:   defp format_period(%NaiveDateTime{} = dt), do: Calendar.strftime(dt, "%d/%m")
621:   defp format_period(other), do: to_string(other)
622: 
623:   defp format_decimal(nil), do: 0
624:   defp format_decimal(%Decimal{} = d), do: Decimal.to_float(d) |> Float.round(1)
625:   defp format_decimal(f) when is_float(f), do: Float.round(f, 1)
626:   defp format_decimal(n), do: n
627: 
628:   defp group_by_category(coverage) do
629:     coverage
630:     |> Enum.group_by(& &1.category)
631:     |> Enum.sort_by(fn {_k, v} -> -length(v) end)
632:   end
633: 
634:   defp score_color(score) when is_nil(score),
635:     do: "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"
636: 
637:   defp score_color(%Decimal{} = score), do: score |> Decimal.to_float() |> score_color()
638: 
639:   defp score_color(score) when is_number(score) do
640:     cond do
641:       score >= 80 ->
642:         "bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400"
643: 
644:       score >= 60 ->
645:         "bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400"
646: 
647:       true ->
648:         "bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400"
649:     end
650:   end
651: 
652:   defp category_color("LP"),
653:     do: "bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400"
654: 
655:   defp category_color("MA"),
656:     do: "bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400"
657: 
658:   defp category_color("CN"),
659:     do: "bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400"
660: 
661:   defp category_color("CH"),
662:     do: "bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400"
663: 
664:   defp category_color("AR"),
665:     do: "bg-pink-100 text-pink-800 dark:bg-pink-900/30 dark:text-pink-400"
666: 
667:   defp category_color("EF"),
668:     do: "bg-cyan-100 text-cyan-800 dark:bg-cyan-900/30 dark:text-cyan-400"
669: 
670:   defp category_color("ER"),
671:     do: "bg-indigo-100 text-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-400"
672: 
673:   defp category_color(_), do: "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"
674: 
675:   defp category_bg("LP"), do: "bg-blue-50 dark:bg-blue-900/20"
676:   defp category_bg("MA"), do: "bg-purple-50 dark:bg-purple-900/20"
677:   defp category_bg("CN"), do: "bg-emerald-50 dark:bg-emerald-900/20"
678:   defp category_bg("CH"), do: "bg-amber-50 dark:bg-amber-900/20"
679:   defp category_bg("AR"), do: "bg-pink-50 dark:bg-pink-900/20"
680:   defp category_bg("EF"), do: "bg-cyan-50 dark:bg-cyan-900/20"
681:   defp category_bg("ER"), do: "bg-indigo-50 dark:bg-indigo-900/20"
682:   defp category_bg(_), do: "bg-gray-50 dark:bg-gray-900/20"
683: 
684:   defp category_label("LP"), do: "Lingua Portuguesa"
685:   defp category_label("MA"), do: "Matematica"
686:   defp category_label("CN"), do: "Ciencias"
687:   defp category_label("CH"), do: "Ciencias Humanas"
688:   defp category_label("AR"), do: "Arte"
689:   defp category_label("EF"), do: "Ed. Fisica"
690:   defp category_label("ER"), do: "Ensino Religioso"
691:   defp category_label(cat), do: cat
692: 
693:   defp trend_icon(:improving), do: "hero-arrow-trending-up"
694:   defp trend_icon(:declining), do: "hero-arrow-trending-down"
695:   defp trend_icon(:stable), do: "hero-minus"
696: 
697:   defp trend_color(:improving), do: "text-emerald-600 dark:text-emerald-400"
698:   defp trend_color(:declining), do: "text-red-600 dark:text-red-400"
699:   defp trend_color(:stable), do: "text-gray-600 dark:text-gray-400"
700: 
701:   defp trend_bg(:improving), do: "bg-emerald-100 dark:bg-emerald-900/30"
702:   defp trend_bg(:declining), do: "bg-red-100 dark:bg-red-900/30"
703:   defp trend_bg(:stable), do: "bg-gray-100 dark:bg-gray-900/30"
704: 
705:   defp trend_label(:improving), do: "Em Alta"
706:   defp trend_label(:declining), do: "Em Baixa"
707:   defp trend_label(:stable), do: "Estavel"
708: end
````

## File: lib/hellen_web/live/auth_live/invite.ex
````elixir
  1: defmodule HellenWeb.AuthLive.Invite do
  2:   @moduledoc """
  3:   Invitation acceptance page - allows users to accept team invitations.
  4:   """
  5:   use HellenWeb, :live_view
  6: 
  7:   alias Hellen.Accounts
  8:   alias Hellen.Accounts.Invitation
  9: 
 10:   @impl true
 11:   def mount(%{"token" => token}, _session, socket) do
 12:     invitation = Accounts.get_invitation_by_token(token)
 13: 
 14:     cond do
 15:       is_nil(invitation) ->
 16:         {:ok,
 17:          socket
 18:          |> assign(page_title: "Convite Invalido")
 19:          |> assign(status: :not_found)
 20:          |> assign(invitation: nil)}
 21: 
 22:       invitation.accepted_at ->
 23:         {:ok,
 24:          socket
 25:          |> assign(page_title: "Convite ja Aceito")
 26:          |> assign(status: :already_accepted)
 27:          |> assign(invitation: invitation)}
 28: 
 29:       invitation.revoked_at ->
 30:         {:ok,
 31:          socket
 32:          |> assign(page_title: "Convite Revogado")
 33:          |> assign(status: :revoked)
 34:          |> assign(invitation: invitation)}
 35: 
 36:       Invitation.expired?(invitation) ->
 37:         {:ok,
 38:          socket
 39:          |> assign(page_title: "Convite Expirado")
 40:          |> assign(status: :expired)
 41:          |> assign(invitation: invitation)}
 42: 
 43:       true ->
 44:         {:ok,
 45:          socket
 46:          |> assign(page_title: "Aceitar Convite")
 47:          |> assign(status: :valid)
 48:          |> assign(invitation: invitation)
 49:          |> assign(token: token)
 50:          |> assign(form: to_form(%{"name" => invitation.name || "", "password" => ""}))}
 51:     end
 52:   end
 53: 
 54:   @impl true
 55:   def handle_event("accept_invitation", params, socket) do
 56:     user_attrs = %{
 57:       name: params["name"],
 58:       email: socket.assigns.invitation.email,
 59:       password: params["password"]
 60:     }
 61: 
 62:     case Accounts.accept_invitation(socket.assigns.token, user_attrs) do
 63:       {:ok, _user} ->
 64:         {:noreply,
 65:          socket
 66:          |> put_flash(:info, "Convite aceito! Faca login para continuar.")
 67:          |> redirect(to: ~p"/login")}
 68: 
 69:       {:error, :already_accepted} ->
 70:         {:noreply,
 71:          socket
 72:          |> assign(status: :already_accepted)
 73:          |> put_flash(:error, "Este convite ja foi aceito.")}
 74: 
 75:       {:error, changeset} when is_struct(changeset, Ecto.Changeset) ->
 76:         {:noreply, put_flash(socket, :error, "Erro ao criar conta. Verifique os dados.")}
 77: 
 78:       {:error, _reason} ->
 79:         {:noreply, put_flash(socket, :error, "Erro ao aceitar convite.")}
 80:     end
 81:   end
 82: 
 83:   @impl true
 84:   def render(assigns) do
 85:     ~H"""
 86:     <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 px-4">
 87:       <div class="w-full max-w-md">
 88:         <!-- Invalid/Not Found -->
 89:         <div
 90:           :if={@status == :not_found}
 91:           class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-8 text-center"
 92:         >
 93:           <div class="w-16 h-16 mx-auto rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center mb-4">
 94:             <.icon name="hero-x-circle" class="h-8 w-8 text-red-600 dark:text-red-400" />
 95:           </div>
 96:           <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
 97:             Convite nao encontrado
 98:           </h1>
 99:           <p class="text-gray-500 dark:text-gray-400 mb-6">
100:             Este link de convite e invalido ou nao existe.
101:           </p>
102:           <.link
103:             navigate={~p"/login"}
104:             class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
105:           >
106:             Ir para Login
107:           </.link>
108:         </div>
109:         <!-- Already Accepted -->
110:         <div
111:           :if={@status == :already_accepted}
112:           class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-8 text-center"
113:         >
114:           <div class="w-16 h-16 mx-auto rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center mb-4">
115:             <.icon name="hero-check-circle" class="h-8 w-8 text-emerald-600 dark:text-emerald-400" />
116:           </div>
117:           <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Convite ja aceito</h1>
118:           <p class="text-gray-500 dark:text-gray-400 mb-6">
119:             Este convite ja foi aceito. Faca login para acessar sua conta.
120:           </p>
121:           <.link
122:             navigate={~p"/login"}
123:             class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
124:           >
125:             Ir para Login
126:           </.link>
127:         </div>
128:         <!-- Revoked -->
129:         <div
130:           :if={@status == :revoked}
131:           class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-8 text-center"
132:         >
133:           <div class="w-16 h-16 mx-auto rounded-full bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center mb-4">
134:             <.icon name="hero-no-symbol" class="h-8 w-8 text-amber-600 dark:text-amber-400" />
135:           </div>
136:           <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Convite revogado</h1>
137:           <p class="text-gray-500 dark:text-gray-400 mb-6">
138:             Este convite foi cancelado pelo coordenador.
139:           </p>
140:           <.link
141:             navigate={~p"/login"}
142:             class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
143:           >
144:             Ir para Login
145:           </.link>
146:         </div>
147:         <!-- Expired -->
148:         <div
149:           :if={@status == :expired}
150:           class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-8 text-center"
151:         >
152:           <div class="w-16 h-16 mx-auto rounded-full bg-gray-100 dark:bg-gray-900/30 flex items-center justify-center mb-4">
153:             <.icon name="hero-clock" class="h-8 w-8 text-gray-600 dark:text-gray-400" />
154:           </div>
155:           <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Convite expirado</h1>
156:           <p class="text-gray-500 dark:text-gray-400 mb-6">
157:             Este convite expirou. Entre em contato com o coordenador para um novo convite.
158:           </p>
159:           <.link
160:             navigate={~p"/login"}
161:             class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
162:           >
163:             Ir para Login
164:           </.link>
165:         </div>
166:         <!-- Valid Invitation -->
167:         <div :if={@status == :valid} class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-8">
168:           <div class="text-center mb-6">
169:             <div class="w-16 h-16 mx-auto rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center mb-4">
170:               <.icon name="hero-envelope-open" class="h-8 w-8 text-indigo-600 dark:text-indigo-400" />
171:             </div>
172:             <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Voce foi convidado!</h1>
173:             <p class="text-gray-500 dark:text-gray-400">
174:               <%= (@invitation.invited_by && @invitation.invited_by.name) || "Um coordenador" %> convidou voce para participar de
175:             </p>
176:             <p class="text-lg font-semibold text-indigo-600 dark:text-indigo-400 mt-1">
177:               <%= @invitation.institution.name %>
178:             </p>
179:           </div>
180: 
181:           <div class="bg-gray-50 dark:bg-slate-900/50 rounded-lg p-4 mb-6">
182:             <div class="flex items-center justify-between text-sm">
183:               <span class="text-gray-500 dark:text-gray-400">Email</span>
184:               <span class="font-medium text-gray-900 dark:text-white"><%= @invitation.email %></span>
185:             </div>
186:             <div class="flex items-center justify-between text-sm mt-2">
187:               <span class="text-gray-500 dark:text-gray-400">Cargo</span>
188:               <span class="font-medium text-gray-900 dark:text-white">
189:                 <%= role_label(@invitation.role) %>
190:               </span>
191:             </div>
192:             <div class="flex items-center justify-between text-sm mt-2">
193:               <span class="text-gray-500 dark:text-gray-400">Expira em</span>
194:               <span class="font-medium text-gray-900 dark:text-white">
195:                 <%= format_expires(@invitation.expires_at) %>
196:               </span>
197:             </div>
198:           </div>
199: 
200:           <form phx-submit="accept_invitation" class="space-y-4">
201:             <div>
202:               <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
203:                 Seu nome
204:               </label>
205:               <input
206:                 type="text"
207:                 name="name"
208:                 required
209:                 value={@invitation.name || ""}
210:                 class="w-full rounded-lg border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-indigo-500 focus:border-indigo-500"
211:                 placeholder="Nome completo"
212:               />
213:             </div>
214: 
215:             <div>
216:               <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
217:                 Criar senha
218:               </label>
219:               <input
220:                 type="password"
221:                 name="password"
222:                 required
223:                 minlength="8"
224:                 class="w-full rounded-lg border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-indigo-500 focus:border-indigo-500"
225:                 placeholder="Minimo 8 caracteres"
226:               />
227:             </div>
228: 
229:             <button
230:               type="submit"
231:               class="w-full py-3 px-4 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-colors"
232:             >
233:               Aceitar Convite e Criar Conta
234:             </button>
235:           </form>
236: 
237:           <p class="mt-4 text-center text-sm text-gray-500 dark:text-gray-400">
238:             Ja tem uma conta?
239:             <.link navigate={~p"/login"} class="text-indigo-600 dark:text-indigo-400 hover:underline">
240:               Faca login
241:             </.link>
242:           </p>
243:         </div>
244:       </div>
245:     </div>
246:     """
247:   end
248: 
249:   defp role_label("teacher"), do: "Professor"
250:   defp role_label("coordinator"), do: "Coordenador"
251:   defp role_label(_), do: "Usuario"
252: 
253:   defp format_expires(datetime) do
254:     diff = DateTime.diff(datetime, DateTime.utc_now(), :day)
255: 
256:     cond do
257:       diff <= 0 -> "Hoje"
258:       diff == 1 -> "Amanha"
259:       true -> "#{diff} dias"
260:     end
261:   end
262: end
````

## File: lib/hellen_web/live/auth_live/register.ex
````elixir
  1: defmodule HellenWeb.AuthLive.Register do
  2:   use HellenWeb, :live_view
  3: 
  4:   @impl true
  5:   def mount(_params, _session, socket) do
  6:     # Redirect if already logged in
  7:     if socket.assigns[:current_user] do
  8:       {:ok, push_navigate(socket, to: ~p"/")}
  9:     else
 10:       {:ok,
 11:        assign(socket,
 12:          page_title: "Criar Conta",
 13:          page_subtitle: "Comece sua jornada com a Hellen AI"
 14:        )}
 15:     end
 16:   end
 17: 
 18:   @impl true
 19:   def render(assigns) do
 20:     ~H"""
 21:     <form action={~p"/session/register"} method="post" class="space-y-5">
 22:       <input type="hidden" name="_csrf_token" value={Phoenix.Controller.get_csrf_token()} />
 23: 
 24:       <div>
 25:         <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">
 26:           Nome completo
 27:         </label>
 28:         <div class="relative">
 29:           <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none">
 30:             <svg
 31:               xmlns="http://www.w3.org/2000/svg"
 32:               class="h-5 w-5 text-gray-400 dark:text-gray-500"
 33:               fill="none"
 34:               viewBox="0 0 24 24"
 35:               stroke="currentColor"
 36:               stroke-width="1.5"
 37:             >
 38:               <path
 39:                 stroke-linecap="round"
 40:                 stroke-linejoin="round"
 41:                 d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"
 42:               />
 43:             </svg>
 44:           </div>
 45:           <input
 46:             type="text"
 47:             name="name"
 48:             id="name"
 49:             placeholder="Seu nome"
 50:             required
 51:             autocomplete="name"
 52:             class="block w-full pl-11 pr-4 py-3 rounded-xl border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700/50 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 focus:border-transparent transition-all duration-200 sm:text-sm"
 53:           />
 54:         </div>
 55:       </div>
 56: 
 57:       <div>
 58:         <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">
 59:           Email
 60:         </label>
 61:         <div class="relative">
 62:           <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none">
 63:             <svg
 64:               xmlns="http://www.w3.org/2000/svg"
 65:               class="h-5 w-5 text-gray-400 dark:text-gray-500"
 66:               fill="none"
 67:               viewBox="0 0 24 24"
 68:               stroke="currentColor"
 69:               stroke-width="1.5"
 70:             >
 71:               <path
 72:                 stroke-linecap="round"
 73:                 stroke-linejoin="round"
 74:                 d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"
 75:               />
 76:             </svg>
 77:           </div>
 78:           <input
 79:             type="email"
 80:             name="email"
 81:             id="email"
 82:             placeholder="seu@email.com"
 83:             required
 84:             autocomplete="email"
 85:             class="block w-full pl-11 pr-4 py-3 rounded-xl border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700/50 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 focus:border-transparent transition-all duration-200 sm:text-sm"
 86:           />
 87:         </div>
 88:       </div>
 89: 
 90:       <div>
 91:         <label
 92:           for="password"
 93:           class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5"
 94:         >
 95:           Senha
 96:         </label>
 97:         <div class="relative">
 98:           <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none">
 99:             <svg
100:               xmlns="http://www.w3.org/2000/svg"
101:               class="h-5 w-5 text-gray-400 dark:text-gray-500"
102:               fill="none"
103:               viewBox="0 0 24 24"
104:               stroke="currentColor"
105:               stroke-width="1.5"
106:             >
107:               <path
108:                 stroke-linecap="round"
109:                 stroke-linejoin="round"
110:                 d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z"
111:               />
112:             </svg>
113:           </div>
114:           <input
115:             type="password"
116:             name="password"
117:             id="password"
118:             placeholder="Mínimo 8 caracteres"
119:             required
120:             minlength="8"
121:             autocomplete="new-password"
122:             class="block w-full pl-11 pr-4 py-3 rounded-xl border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700/50 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 focus:border-transparent transition-all duration-200 sm:text-sm"
123:           />
124:         </div>
125:         <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
126:           Use pelo menos 8 caracteres com letras e números
127:         </p>
128:       </div>
129: 
130:       <div class="pt-2">
131:         <button
132:           type="submit"
133:           class="w-full flex justify-center items-center gap-2 py-3 px-4 rounded-xl text-sm font-semibold text-white bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-slate-800 shadow-lg shadow-indigo-500/25 hover:shadow-indigo-500/40 transition-all duration-200"
134:         >
135:           <svg
136:             xmlns="http://www.w3.org/2000/svg"
137:             class="h-5 w-5"
138:             fill="none"
139:             viewBox="0 0 24 24"
140:             stroke="currentColor"
141:             stroke-width="2"
142:           >
143:             <path
144:               stroke-linecap="round"
145:               stroke-linejoin="round"
146:               d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"
147:             />
148:           </svg>
149:           Criar minha conta
150:         </button>
151:       </div>
152: 
153:       <p class="text-xs text-center text-gray-500 dark:text-gray-400">
154:         Ao criar uma conta, você concorda com nossos
155:         <a href="#" class="text-indigo-600 dark:text-indigo-400 hover:underline">Termos de Uso</a>
156:         e
157:         <a href="#" class="text-indigo-600 dark:text-indigo-400 hover:underline">
158:           Política de Privacidade
159:         </a>
160:       </p>
161:     </form>
162: 
163:     <div class="mt-8">
164:       <div class="relative">
165:         <div class="absolute inset-0 flex items-center">
166:           <div class="w-full border-t border-gray-200 dark:border-slate-700"></div>
167:         </div>
168:         <div class="relative flex justify-center text-sm">
169:           <span class="px-4 bg-white/80 dark:bg-slate-800/80 text-gray-500 dark:text-gray-400">
170:             Já tem uma conta?
171:           </span>
172:         </div>
173:       </div>
174: 
175:       <div class="mt-6">
176:         <.link
177:           navigate={~p"/login"}
178:           class="w-full flex justify-center items-center gap-2 py-3 px-4 rounded-xl text-sm font-semibold text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-500/10 hover:bg-indigo-100 dark:hover:bg-indigo-500/20 border border-indigo-200 dark:border-indigo-500/30 transition-all duration-200"
179:         >
180:           <svg
181:             xmlns="http://www.w3.org/2000/svg"
182:             class="h-5 w-5"
183:             fill="none"
184:             viewBox="0 0 24 24"
185:             stroke="currentColor"
186:             stroke-width="2"
187:           >
188:             <path
189:               stroke-linecap="round"
190:               stroke-linejoin="round"
191:               d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"
192:             />
193:           </svg>
194:           Fazer login
195:         </.link>
196:       </div>
197:     </div>
198:     """
199:   end
200: end
````

## File: lib/hellen_web/live/institution_live/index.ex
````elixir
  1: defmodule HellenWeb.InstitutionLive.Index do
  2:   @moduledoc """
  3:   Coordinator Dashboard - Overview of institution statistics.
  4:   Uses assign_async for non-blocking data loading and streams for activity feed.
  5:   """
  6:   use HellenWeb, :live_view
  7: 
  8:   alias Hellen.Accounts
  9: 
 10:   @impl true
 11:   def mount(_params, _session, socket) do
 12:     user = socket.assigns.current_user
 13:     institution_id = user.institution_id
 14: 
 15:     if institution_id do
 16:       institution = Accounts.get_institution!(institution_id)
 17: 
 18:       {:ok,
 19:        socket
 20:        |> assign(page_title: "Dashboard")
 21:        |> assign(institution: institution)
 22:        |> stream(:recent_activity, [])
 23:        |> assign_async(:stats, fn -> load_stats(institution_id) end)
 24:        |> assign_async(:chart_data, fn -> load_chart_data(institution_id) end)
 25:        |> load_activity_async(institution_id)}
 26:     else
 27:       {:ok,
 28:        socket
 29:        |> assign(page_title: "Dashboard")
 30:        |> assign(institution: nil)
 31:        |> put_flash(:error, "Voce nao esta associado a nenhuma instituicao")}
 32:     end
 33:   end
 34: 
 35:   defp load_stats(institution_id) do
 36:     stats = Accounts.get_institution_stats(institution_id)
 37:     {:ok, %{stats: stats}}
 38:   end
 39: 
 40:   defp load_chart_data(institution_id) do
 41:     lessons_per_teacher = Accounts.get_lessons_per_teacher(institution_id)
 42:     {:ok, %{lessons_per_teacher: lessons_per_teacher}}
 43:   end
 44: 
 45:   defp load_activity_async(socket, institution_id) do
 46:     if connected?(socket) do
 47:       start_async(socket, :load_activity, fn ->
 48:         Accounts.list_recent_institution_lessons(institution_id, limit: 10)
 49:       end)
 50:     else
 51:       socket
 52:     end
 53:   end
 54: 
 55:   @impl true
 56:   def handle_async(:load_activity, {:ok, lessons}, socket) do
 57:     {:noreply, stream(socket, :recent_activity, lessons)}
 58:   end
 59: 
 60:   def handle_async(:load_activity, {:exit, _reason}, socket) do
 61:     {:noreply, put_flash(socket, :error, "Erro ao carregar atividade recente")}
 62:   end
 63: 
 64:   @impl true
 65:   def render(assigns) do
 66:     ~H"""
 67:     <div class="space-y-6">
 68:       <%= if @institution do %>
 69:         <!-- Header -->
 70:         <.page_header title={@institution.name} description="Painel de acompanhamento da instituicao">
 71:           <:actions>
 72:             <.badge variant={plan_variant(@institution.plan)}>
 73:               Plano <%= String.capitalize(@institution.plan || "free") %>
 74:             </.badge>
 75:           </:actions>
 76:         </.page_header>
 77:         <!-- Stats Cards -->
 78:         <.async_result :let={data} assign={@stats}>
 79:           <:loading>
 80:             <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
 81:               <.stat_skeleton :for={_ <- 1..4} />
 82:             </div>
 83:           </:loading>
 84:           <:failed>
 85:             <.alert variant="error">Erro ao carregar estatisticas</.alert>
 86:           </:failed>
 87: 
 88:           <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
 89:             <.stat_card
 90:               title="Professores"
 91:               value={data.stats.teachers}
 92:               icon="hero-users"
 93:               variant="default"
 94:             />
 95:             <.stat_card
 96:               title="Aulas"
 97:               value={data.stats.lessons}
 98:               icon="hero-academic-cap"
 99:               variant="default"
100:             />
101:             <.stat_card
102:               title="Analises"
103:               value={data.stats.analyses}
104:               icon="hero-chart-bar"
105:               variant="success"
106:             />
107:             <.stat_card
108:               title="Alertas Pendentes"
109:               value={data.stats.alerts}
110:               icon="hero-bell-alert"
111:               variant={if data.stats.alerts > 0, do: "error", else: "default"}
112:             />
113:           </div>
114:           <!-- Score Overview -->
115:           <div :if={data.stats.avg_score} class="mt-4">
116:             <.card>
117:               <div class="flex items-center justify-between">
118:                 <div>
119:                   <p class="text-sm text-gray-500 dark:text-gray-400">Score Medio da Instituicao</p>
120:                   <p class="text-3xl font-bold text-gray-900 dark:text-white">
121:                     <%= data.stats.avg_score %><span class="text-lg text-gray-500">/10</span>
122:                   </p>
123:                 </div>
124:                 <div class={[
125:                   "p-3 rounded-full",
126:                   score_color_class(data.stats.avg_score)
127:                 ]}>
128:                   <.icon name="hero-star" class="h-8 w-8 text-white" />
129:                 </div>
130:               </div>
131:             </.card>
132:           </div>
133:         </.async_result>
134:         <!-- Charts Row -->
135:         <div class="grid gap-6 lg:grid-cols-2">
136:           <!-- Lessons per Teacher Chart -->
137:           <.card>
138:             <:header>
139:               <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
140:                 Aulas por Professor
141:               </h2>
142:             </:header>
143:             <.async_result :let={data} assign={@chart_data}>
144:               <:loading>
145:                 <div class="h-72 animate-pulse bg-gray-100 dark:bg-slate-700 rounded-lg"></div>
146:               </:loading>
147:               <:failed>
148:                 <p class="text-gray-500 text-center py-8">Erro ao carregar grafico</p>
149:               </:failed>
150: 
151:               <div
152:                 id="lessons-chart"
153:                 phx-hook="CoordinatorBarChart"
154:                 phx-update="ignore"
155:                 data-chart-data={Jason.encode!(data.lessons_per_teacher)}
156:                 class="h-72"
157:               >
158:               </div>
159:             </.async_result>
160:           </.card>
161:           <!-- Quick Actions -->
162:           <.card>
163:             <:header>
164:               <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
165:                 Acoes Rapidas
166:               </h2>
167:             </:header>
168:             <div class="space-y-3">
169:               <.link
170:                 navigate={~p"/institution/teachers"}
171:                 class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors"
172:               >
173:                 <div class="p-2 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg">
174:                   <.icon name="hero-user-plus" class="h-5 w-5 text-indigo-600 dark:text-indigo-400" />
175:                 </div>
176:                 <div>
177:                   <p class="font-medium text-gray-900 dark:text-white">Gerenciar Equipe</p>
178:                   <p class="text-sm text-gray-500 dark:text-gray-400">
179:                     Convidar professores e gerenciar permissoes
180:                   </p>
181:                 </div>
182:                 <.icon name="hero-chevron-right" class="h-5 w-5 text-gray-400 ml-auto" />
183:               </.link>
184: 
185:               <.link
186:                 navigate={~p"/alerts"}
187:                 class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors"
188:               >
189:                 <div class="p-2 bg-orange-100 dark:bg-orange-900/30 rounded-lg">
190:                   <.icon name="hero-bell-alert" class="h-5 w-5 text-orange-600 dark:text-orange-400" />
191:                 </div>
192:                 <div>
193:                   <p class="font-medium text-gray-900 dark:text-white">Ver Alertas</p>
194:                   <p class="text-sm text-gray-500 dark:text-gray-400">
195:                     Monitorar alertas de bullying e conformidade
196:                   </p>
197:                 </div>
198:                 <.icon name="hero-chevron-right" class="h-5 w-5 text-gray-400 ml-auto" />
199:               </.link>
200: 
201:               <.link
202:                 navigate={~p"/institution/reports"}
203:                 class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors"
204:               >
205:                 <div class="p-2 bg-green-100 dark:bg-green-900/30 rounded-lg">
206:                   <.icon
207:                     name="hero-document-chart-bar"
208:                     class="h-5 w-5 text-green-600 dark:text-green-400"
209:                   />
210:                 </div>
211:                 <div>
212:                   <p class="font-medium text-gray-900 dark:text-white">Relatorios</p>
213:                   <p class="text-sm text-gray-500 dark:text-gray-400">
214:                     Gerar relatorios consolidados
215:                   </p>
216:                 </div>
217:                 <.icon name="hero-chevron-right" class="h-5 w-5 text-gray-400 ml-auto" />
218:               </.link>
219:             </div>
220:           </.card>
221:         </div>
222:         <!-- Recent Activity -->
223:         <.card>
224:           <:header>
225:             <div class="flex items-center justify-between">
226:               <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
227:                 Atividade Recente
228:               </h2>
229:               <.link
230:                 navigate={~p"/institution/teachers"}
231:                 class="text-sm text-indigo-600 dark:text-indigo-400 hover:underline"
232:               >
233:                 Ver todas
234:               </.link>
235:             </div>
236:           </:header>
237: 
238:           <div
239:             id="recent-activity"
240:             phx-update="stream"
241:             class="divide-y divide-gray-100 dark:divide-slate-700"
242:           >
243:             <div
244:               :for={{dom_id, lesson} <- @streams.recent_activity}
245:               id={dom_id}
246:               class="py-3 first:pt-0 last:pb-0"
247:             >
248:               <.activity_item lesson={lesson} />
249:             </div>
250:           </div>
251: 
252:           <.empty_state
253:             :if={Enum.empty?(@streams.recent_activity |> elem(1))}
254:             icon="hero-clipboard-document-list"
255:             title="Nenhuma atividade recente"
256:             description="As aulas dos professores aparecerao aqui."
257:           />
258:         </.card>
259:       <% else %>
260:         <!-- No Institution -->
261:         <.empty_state
262:           icon="hero-building-office"
263:           title="Sem instituicao vinculada"
264:           description="Voce precisa estar vinculado a uma instituicao para acessar o painel de coordenacao."
265:         />
266:       <% end %>
267:     </div>
268:     """
269:   end
270: 
271:   defp activity_item(assigns) do
272:     ~H"""
273:     <div class="flex items-center gap-4">
274:       <div class="flex-shrink-0">
275:         <div class="w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center">
276:           <span class="text-sm font-medium text-indigo-600 dark:text-indigo-400">
277:             <%= String.first(@lesson.user.name || "?") |> String.upcase() %>
278:           </span>
279:         </div>
280:       </div>
281:       <div class="flex-1 min-w-0">
282:         <p class="text-sm font-medium text-gray-900 dark:text-white truncate">
283:           <%= @lesson.title || "Aula sem titulo" %>
284:         </p>
285:         <p class="text-sm text-gray-500 dark:text-gray-400">
286:           <%= @lesson.user.name || "Professor" %> - <%= format_relative_time(@lesson.inserted_at) %>
287:         </p>
288:       </div>
289:       <div class="flex-shrink-0">
290:         <.status_badge status={@lesson.status} />
291:       </div>
292:     </div>
293:     """
294:   end
295: 
296:   defp status_badge(assigns) do
297:     ~H"""
298:     <span class={[
299:       "px-2 py-1 text-xs font-medium rounded-full",
300:       lesson_status_class(@status)
301:     ]}>
302:       <%= lesson_status_text(@status) %>
303:     </span>
304:     """
305:   end
306: 
307:   defp lesson_status_class("completed"),
308:     do: "bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400"
309: 
310:   defp lesson_status_class("analyzing"),
311:     do: "bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400"
312: 
313:   defp lesson_status_class("transcribing"),
314:     do: "bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400"
315: 
316:   defp lesson_status_class("transcribed"),
317:     do: "bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400"
318: 
319:   defp lesson_status_class("pending"),
320:     do: "bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400"
321: 
322:   defp lesson_status_class("failed"),
323:     do: "bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400"
324: 
325:   defp lesson_status_class(_), do: "bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-400"
326: 
327:   defp lesson_status_text("completed"), do: "Concluida"
328:   defp lesson_status_text("analyzing"), do: "Analisando"
329:   defp lesson_status_text("transcribing"), do: "Transcrevendo"
330:   defp lesson_status_text("transcribed"), do: "Transcrita"
331:   defp lesson_status_text("pending"), do: "Pendente"
332:   defp lesson_status_text("failed"), do: "Falhou"
333:   defp lesson_status_text(_), do: "Desconhecido"
334: 
335:   defp plan_variant("enterprise"), do: "success"
336:   defp plan_variant("pro"), do: "processing"
337:   defp plan_variant(_), do: "default"
338: 
339:   defp score_color_class(score) when score >= 8, do: "bg-green-500"
340:   defp score_color_class(score) when score >= 6, do: "bg-yellow-500"
341:   defp score_color_class(_), do: "bg-red-500"
342: 
343:   defp stat_skeleton(assigns) do
344:     ~H"""
345:     <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-200 dark:border-slate-700 p-6 animate-pulse">
346:       <div class="flex items-center justify-between">
347:         <div class="space-y-2">
348:           <div class="h-4 w-20 bg-gray-200 dark:bg-slate-700 rounded"></div>
349:           <div class="h-8 w-12 bg-gray-200 dark:bg-slate-700 rounded"></div>
350:         </div>
351:         <div class="h-12 w-12 bg-gray-200 dark:bg-slate-700 rounded-full"></div>
352:       </div>
353:     </div>
354:     """
355:   end
356: 
357:   defp format_relative_time(datetime) do
358:     now = DateTime.utc_now()
359:     diff = DateTime.diff(now, datetime, :second)
360: 
361:     cond do
362:       diff < 60 -> "agora"
363:       diff < 3600 -> "ha #{div(diff, 60)} min"
364:       diff < 86_400 -> "ha #{div(diff, 3600)} h"
365:       diff < 604_800 -> "ha #{div(diff, 86_400)} d"
366:       true -> Calendar.strftime(datetime, "%d/%m/%Y")
367:     end
368:   end
369: end
````

## File: lib/hellen_web/live/institution_live/teachers.ex
````elixir
  1: defmodule HellenWeb.InstitutionLive.Teachers do
  2:   @moduledoc """
  3:   Teacher management for coordinators.
  4:   List teachers with stats, invite new teachers, and manage roles.
  5:   """
  6:   use HellenWeb, :live_view
  7: 
  8:   alias Hellen.Accounts
  9: 
 10:   @impl true
 11:   def mount(_params, _session, socket) do
 12:     user = socket.assigns.current_user
 13:     institution_id = user.institution_id
 14: 
 15:     if institution_id do
 16:       {:ok,
 17:        socket
 18:        |> assign(page_title: "Equipe")
 19:        |> assign(institution_id: institution_id)
 20:        |> assign(filter_role: "all")
 21:        |> assign(show_invite_modal: false)
 22:        |> assign(show_remove_modal: false)
 23:        |> assign(selected_teacher: nil)
 24:        |> assign(invite_form: to_form(%{"name" => "", "email" => ""}))
 25:        |> load_teachers_async(institution_id)}
 26:     else
 27:       {:ok,
 28:        socket
 29:        |> assign(page_title: "Equipe")
 30:        |> assign(teachers: [])
 31:        |> put_flash(:error, "Voce nao esta associado a nenhuma instituicao")}
 32:     end
 33:   end
 34: 
 35:   defp load_teachers_async(socket, institution_id) do
 36:     if connected?(socket) do
 37:       start_async(socket, :load_teachers, fn ->
 38:         Accounts.list_teachers_with_stats(institution_id)
 39:       end)
 40:     else
 41:       assign(socket, teachers: [])
 42:     end
 43:   end
 44: 
 45:   @impl true
 46:   def handle_async(:load_teachers, {:ok, teachers}, socket) do
 47:     {:noreply, assign(socket, teachers: teachers)}
 48:   end
 49: 
 50:   def handle_async(:load_teachers, {:exit, _reason}, socket) do
 51:     {:noreply,
 52:      socket
 53:      |> assign(teachers: [])
 54:      |> put_flash(:error, "Erro ao carregar professores")}
 55:   end
 56: 
 57:   @impl true
 58:   def handle_event("filter_role", %{"role" => role}, socket) do
 59:     {:noreply, assign(socket, filter_role: role)}
 60:   end
 61: 
 62:   def handle_event("open_invite_modal", _params, socket) do
 63:     {:noreply, assign(socket, show_invite_modal: true)}
 64:   end
 65: 
 66:   def handle_event("close_invite_modal", _params, socket) do
 67:     {:noreply,
 68:      socket
 69:      |> assign(show_invite_modal: false)
 70:      |> assign(invite_form: to_form(%{"name" => "", "email" => ""}))}
 71:   end
 72: 
 73:   def handle_event("invite_teacher", %{"name" => name, "email" => email}, socket) do
 74:     institution_id = socket.assigns.institution_id
 75: 
 76:     case Accounts.invite_teacher_to_institution(institution_id, %{name: name, email: email}) do
 77:       {:ok, _user} ->
 78:         {:noreply,
 79:          socket
 80:          |> assign(show_invite_modal: false)
 81:          |> assign(invite_form: to_form(%{"name" => "", "email" => ""}))
 82:          |> put_flash(:info, "Professor convidado com sucesso!")
 83:          |> load_teachers_async(institution_id)}
 84: 
 85:       {:error, changeset} ->
 86:         errors = format_errors(changeset)
 87: 
 88:         {:noreply,
 89:          socket
 90:          |> put_flash(:error, "Erro ao convidar: #{errors}")}
 91:     end
 92:   end
 93: 
 94:   def handle_event("toggle_role", %{"id" => teacher_id}, socket) do
 95:     teacher_data = Enum.find(socket.assigns.teachers, &(&1.user.id == teacher_id))
 96: 
 97:     if teacher_data do
 98:       new_role = if teacher_data.user.role == "teacher", do: "coordinator", else: "teacher"
 99: 
100:       case Accounts.update_user_role(teacher_data.user, new_role) do
101:         {:ok, _user} ->
102:           {:noreply,
103:            socket
104:            |> put_flash(:info, "Permissao alterada com sucesso!")
105:            |> load_teachers_async(socket.assigns.institution_id)}
106: 
107:         {:error, _} ->
108:           {:noreply, put_flash(socket, :error, "Erro ao alterar permissao")}
109:       end
110:     else
111:       {:noreply, socket}
112:     end
113:   end
114: 
115:   def handle_event("open_remove_modal", %{"id" => teacher_id}, socket) do
116:     teacher_data = Enum.find(socket.assigns.teachers, &(&1.user.id == teacher_id))
117: 
118:     {:noreply,
119:      socket
120:      |> assign(show_remove_modal: true)
121:      |> assign(selected_teacher: teacher_data)}
122:   end
123: 
124:   def handle_event("close_remove_modal", _params, socket) do
125:     {:noreply,
126:      socket
127:      |> assign(show_remove_modal: false)
128:      |> assign(selected_teacher: nil)}
129:   end
130: 
131:   def handle_event("confirm_remove", _params, socket) do
132:     teacher_data = socket.assigns.selected_teacher
133: 
134:     if teacher_data do
135:       case Accounts.remove_teacher_from_institution(teacher_data.user) do
136:         {:ok, _user} ->
137:           {:noreply,
138:            socket
139:            |> assign(show_remove_modal: false)
140:            |> assign(selected_teacher: nil)
141:            |> put_flash(:info, "Professor removido da instituicao")
142:            |> load_teachers_async(socket.assigns.institution_id)}
143: 
144:         {:error, _} ->
145:           {:noreply, put_flash(socket, :error, "Erro ao remover professor")}
146:       end
147:     else
148:       {:noreply, socket}
149:     end
150:   end
151: 
152:   defp format_errors(changeset) do
153:     changeset
154:     |> Ecto.Changeset.traverse_errors(fn {msg, _opts} -> msg end)
155:     |> Enum.map_join("; ", fn {field, errors} -> "#{field}: #{Enum.join(errors, ", ")}" end)
156:   end
157: 
158:   defp filtered_teachers(teachers, "all"), do: teachers
159:   defp filtered_teachers(teachers, role), do: Enum.filter(teachers, &(&1.user.role == role))
160: 
161:   @impl true
162:   def render(assigns) do
163:     filtered = filtered_teachers(assigns[:teachers] || [], assigns.filter_role)
164:     assigns = assign(assigns, :filtered_teachers, filtered)
165: 
166:     ~H"""
167:     <div class="space-y-6">
168:       <.page_header title="Equipe" description="Gerencie os professores da sua instituicao">
169:         <:actions>
170:           <.button phx-click="open_invite_modal">
171:             <.icon name="hero-plus" class="h-4 w-4 mr-2" /> Convidar Professor
172:           </.button>
173:         </:actions>
174:       </.page_header>
175:       <!-- Filters -->
176:       <div class="flex items-center gap-2">
177:         <span class="text-sm text-gray-500 dark:text-gray-400">Filtrar por:</span>
178:         <button
179:           :for={
180:             {value, label} <- [
181:               {"all", "Todos"},
182:               {"teacher", "Professores"},
183:               {"coordinator", "Coordenadores"}
184:             ]
185:           }
186:           type="button"
187:           phx-click="filter_role"
188:           phx-value-role={value}
189:           class={[
190:             "px-3 py-1.5 text-sm rounded-lg transition-colors",
191:             @filter_role == value &&
192:               "bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 font-medium",
193:             @filter_role != value &&
194:               "bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-slate-600"
195:           ]}
196:         >
197:           <%= label %>
198:         </button>
199:       </div>
200:       <!-- Teachers List -->
201:       <div class="space-y-4">
202:         <.teacher_card
203:           :for={teacher <- @filtered_teachers}
204:           teacher={teacher}
205:           current_user={@current_user}
206:         />
207: 
208:         <.empty_state
209:           :if={length(@filtered_teachers) == 0 && length(@teachers) > 0}
210:           icon="hero-funnel"
211:           title="Nenhum resultado"
212:           description="Nenhum professor corresponde ao filtro selecionado."
213:         />
214: 
215:         <.empty_state
216:           :if={length(@teachers) == 0}
217:           icon="hero-users"
218:           title="Nenhum professor"
219:           description="Convide professores para sua instituicao."
220:         >
221:           <.button phx-click="open_invite_modal">
222:             <.icon name="hero-plus" class="h-4 w-4 mr-2" /> Convidar Professor
223:           </.button>
224:         </.empty_state>
225:       </div>
226:       <!-- Invite Modal -->
227:       <.modal
228:         :if={@show_invite_modal}
229:         id="invite-modal"
230:         show
231:         on_cancel={JS.push("close_invite_modal")}
232:       >
233:         <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
234:           Convidar Professor
235:         </h2>
236: 
237:         <.form for={@invite_form} phx-submit="invite_teacher" class="space-y-4">
238:           <.input field={@invite_form[:name]} type="text" label="Nome" required />
239:           <.input field={@invite_form[:email]} type="email" label="Email" required />
240: 
241:           <p class="text-sm text-gray-500 dark:text-gray-400">
242:             O professor recebera um convite para criar sua conta na plataforma.
243:           </p>
244: 
245:           <div class="flex justify-end gap-3 pt-4">
246:             <.button type="button" variant="ghost" phx-click="close_invite_modal">
247:               Cancelar
248:             </.button>
249:             <.button type="submit">
250:               Enviar Convite
251:             </.button>
252:           </div>
253:         </.form>
254:       </.modal>
255:       <!-- Remove Confirmation Modal -->
256:       <.modal
257:         :if={@show_remove_modal}
258:         id="remove-modal"
259:         show
260:         on_cancel={JS.push("close_remove_modal")}
261:       >
262:         <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
263:           Remover Professor
264:         </h2>
265: 
266:         <div class="space-y-4">
267:           <p class="text-gray-600 dark:text-gray-400">
268:             Tem certeza que deseja remover
269:             <span class="font-semibold text-gray-900 dark:text-white">
270:               <%= @selected_teacher && @selected_teacher.user.name %>
271:             </span>
272:             da instituicao?
273:           </p>
274:           <p class="text-sm text-gray-500 dark:text-gray-400">
275:             O professor perdera acesso aos recursos da instituicao, mas suas aulas serao mantidas.
276:           </p>
277: 
278:           <div class="flex justify-end gap-3 pt-4">
279:             <.button type="button" variant="ghost" phx-click="close_remove_modal">
280:               Cancelar
281:             </.button>
282:             <.button type="button" variant="danger" phx-click="confirm_remove">
283:               Remover
284:             </.button>
285:           </div>
286:         </div>
287:       </.modal>
288:     </div>
289:     """
290:   end
291: 
292:   defp teacher_card(assigns) do
293:     ~H"""
294:     <div class="bg-white dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-700 p-4">
295:       <div class="flex items-start gap-4">
296:         <!-- Avatar -->
297:         <div class="flex-shrink-0">
298:           <div class="w-12 h-12 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center">
299:             <span class="text-lg font-medium text-indigo-600 dark:text-indigo-400">
300:               <%= String.first(@teacher.user.name || "?") |> String.upcase() %>
301:             </span>
302:           </div>
303:         </div>
304:         <!-- Info -->
305:         <div class="flex-1 min-w-0">
306:           <div class="flex items-center gap-2 flex-wrap">
307:             <h3 class="font-semibold text-gray-900 dark:text-white truncate">
308:               <%= @teacher.user.name || "Sem nome" %>
309:             </h3>
310:             <.role_badge role={@teacher.user.role} />
311:           </div>
312:           <p class="text-sm text-gray-500 dark:text-gray-400 truncate">
313:             <%= @teacher.user.email %>
314:           </p>
315:           <!-- Stats -->
316:           <div class="mt-2 flex items-center gap-4 text-sm text-gray-500 dark:text-gray-400">
317:             <span class="flex items-center gap-1">
318:               <.icon name="hero-academic-cap" class="h-4 w-4" />
319:               <%= @teacher.lessons_count %> aulas
320:             </span>
321:             <span class="flex items-center gap-1">
322:               <.icon name="hero-chart-bar" class="h-4 w-4" />
323:               <%= @teacher.analyses_count %> analises
324:             </span>
325:             <span :if={@teacher.avg_score} class="flex items-center gap-1">
326:               <.icon name="hero-star" class="h-4 w-4" /> Score: <%= @teacher.avg_score %>
327:             </span>
328:           </div>
329:           <!-- Last Activity -->
330:           <p :if={@teacher.last_activity} class="mt-1 text-xs text-gray-400 dark:text-gray-500">
331:             Ultima atividade: <%= format_relative_time(@teacher.last_activity) %>
332:           </p>
333:         </div>
334:         <!-- Actions -->
335:         <div :if={@teacher.user.id != @current_user.id} class="flex-shrink-0 flex items-center gap-2">
336:           <button
337:             type="button"
338:             phx-click="toggle_role"
339:             phx-value-id={@teacher.user.id}
340:             class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 text-gray-500 dark:text-gray-400"
341:             title={
342:               if @teacher.user.role == "teacher", do: "Tornar coordenador", else: "Tornar professor"
343:             }
344:           >
345:             <.icon name="hero-arrow-path" class="h-5 w-5" />
346:           </button>
347:           <button
348:             type="button"
349:             phx-click="open_remove_modal"
350:             phx-value-id={@teacher.user.id}
351:             class="p-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400"
352:             title="Remover da instituicao"
353:           >
354:             <.icon name="hero-user-minus" class="h-5 w-5" />
355:           </button>
356:         </div>
357:         <!-- Self indicator -->
358:         <div :if={@teacher.user.id == @current_user.id} class="flex-shrink-0">
359:           <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400">
360:             Voce
361:           </span>
362:         </div>
363:       </div>
364:     </div>
365:     """
366:   end
367: 
368:   defp role_badge(assigns) do
369:     ~H"""
370:     <span class={[
371:       "px-2 py-0.5 text-xs font-medium rounded-full",
372:       @role == "coordinator" &&
373:         "bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400",
374:       @role == "teacher" && "bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400",
375:       @role == "admin" && "bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400"
376:     ]}>
377:       <%= role_label(@role) %>
378:     </span>
379:     """
380:   end
381: 
382:   defp role_label("coordinator"), do: "Coordenador"
383:   defp role_label("teacher"), do: "Professor"
384:   defp role_label("admin"), do: "Admin"
385:   defp role_label(_), do: "Desconhecido"
386: 
387:   defp format_relative_time(datetime) do
388:     now = DateTime.utc_now()
389:     diff = DateTime.diff(now, datetime, :second)
390: 
391:     cond do
392:       diff < 60 -> "agora"
393:       diff < 3600 -> "ha #{div(diff, 60)} min"
394:       diff < 86_400 -> "ha #{div(diff, 3600)} h"
395:       diff < 604_800 -> "ha #{div(diff, 86_400)} d"
396:       true -> Calendar.strftime(datetime, "%d/%m/%Y")
397:     end
398:   end
399: end
````

## File: lib/hellen_web/live/landing_live.ex
````elixir
 1: defmodule HellenWeb.LandingLive do
 2:   @moduledoc """
 3:   Landing page LiveView for Hellen AI.
 4:   Displays marketing content and converts visitors to users.
 5:   """
 6:   use HellenWeb, :live_view
 7: 
 8:   import HellenWeb.LandingComponents
 9: 
10:   @impl true
11:   def mount(_params, _session, socket) do
12:     {:ok, socket, layout: {HellenWeb.Layouts, :landing}}
13:   end
14: 
15:   @impl true
16:   def render(assigns) do
17:     ~H"""
18:     <div class="min-h-screen" phx-hook="ScrollAnimation" id="landing-scroll">
19:       <.landing_navbar />
20: 
21:       <main>
22:         <.hero_section />
23:         <.impact_metrics />
24:         <.how_it_works />
25:         <.features_section />
26:         <.pricing_section />
27:         <.testimonials_section />
28:         <.faq_section />
29:         <.cta_section />
30:       </main>
31: 
32:       <.landing_footer />
33:     </div>
34:     """
35:   end
36: end
````

## File: lib/hellen_web/endpoint.ex
````elixir
 1: defmodule HellenWeb.Endpoint do
 2:   use Phoenix.Endpoint, otp_app: :hellen
 3: 
 4:   @session_options [
 5:     store: :cookie,
 6:     key: "_hellen_key",
 7:     signing_salt: "hellen_sign",
 8:     same_site: "Lax"
 9:   ]
10: 
11:   socket "/live", Phoenix.LiveView.Socket,
12:     websocket: [
13:       connect_info: [session: @session_options],
14:       # 100MB max frame size for large file uploads
15:       max_frame_size: 100 * 1024 * 1024
16:     ],
17:     longpoll: [connect_info: [session: @session_options]]
18: 
19:   socket "/socket", HellenWeb.UserSocket,
20:     websocket: true,
21:     longpoll: false
22: 
23:   plug Plug.Static,
24:     at: "/",
25:     from: :hellen,
26:     gzip: false,
27:     only: HellenWeb.static_paths()
28: 
29:   if code_reloading? do
30:     socket "/phoenix/live_reload/socket", Phoenix.LiveReloader.Socket
31:     plug Phoenix.LiveReloader
32:     plug Phoenix.CodeReloader
33:     plug Phoenix.Ecto.CheckRepoStatus, otp_app: :hellen
34:   end
35: 
36:   plug Plug.RequestId
37:   plug Plug.Telemetry, event_prefix: [:phoenix, :endpoint]
38: 
39:   plug Plug.Parsers,
40:     parsers: [:urlencoded, :multipart, :json],
41:     pass: ["*/*"],
42:     json_decoder: Phoenix.json_library()
43: 
44:   plug Plug.MethodOverride
45:   plug Plug.Head
46:   plug Plug.Session, @session_options
47:   plug HellenWeb.Router
48: end
````

## File: lib/hellen_web/telemetry.ex
````elixir
  1: defmodule HellenWeb.Telemetry do
  2:   @moduledoc """
  3:   Telemetry supervisor for application metrics.
  4:   Includes Phoenix, Ecto, Oban, and custom business metrics.
  5:   """
  6:   use Supervisor
  7:   import Telemetry.Metrics
  8: 
  9:   def start_link(arg) do
 10:     Supervisor.start_link(__MODULE__, arg, name: __MODULE__)
 11:   end
 12: 
 13:   @impl true
 14:   def init(_arg) do
 15:     children = [
 16:       {:telemetry_poller, measurements: periodic_measurements(), period: 10_000}
 17:     ]
 18: 
 19:     Supervisor.init(children, strategy: :one_for_one)
 20:   end
 21: 
 22:   def metrics do
 23:     [
 24:       # Phoenix Metrics
 25:       summary("phoenix.endpoint.start.system_time",
 26:         unit: {:native, :millisecond}
 27:       ),
 28:       summary("phoenix.endpoint.stop.duration",
 29:         unit: {:native, :millisecond}
 30:       ),
 31:       summary("phoenix.router_dispatch.stop.duration",
 32:         tags: [:route],
 33:         unit: {:native, :millisecond}
 34:       ),
 35: 
 36:       # Database Metrics
 37:       summary("hellen.repo.query.total_time",
 38:         unit: {:native, :millisecond},
 39:         description: "The sum of the other measurements"
 40:       ),
 41:       summary("hellen.repo.query.decode_time",
 42:         unit: {:native, :millisecond},
 43:         description: "The time spent decoding the data received from the database"
 44:       ),
 45:       summary("hellen.repo.query.query_time",
 46:         unit: {:native, :millisecond},
 47:         description: "The time spent executing the query"
 48:       ),
 49:       summary("hellen.repo.query.queue_time",
 50:         unit: {:native, :millisecond},
 51:         description: "The time spent waiting for a database connection"
 52:       ),
 53:       summary("hellen.repo.query.idle_time",
 54:         unit: {:native, :millisecond},
 55:         description:
 56:           "The time the connection spent waiting before being checked out for the query"
 57:       ),
 58: 
 59:       # Oban Metrics
 60:       counter("oban.job.start.count", tags: [:queue, :worker]),
 61:       counter("oban.job.stop.count", tags: [:queue, :worker]),
 62:       counter("oban.job.exception.count", tags: [:queue, :worker]),
 63:       summary("oban.job.stop.duration", tags: [:queue, :worker], unit: {:native, :millisecond}),
 64: 
 65:       # Business Metrics - Analysis
 66:       summary("hellen.analysis.duration.milliseconds",
 67:         tags: [:type],
 68:         unit: :millisecond,
 69:         description: "Time taken to complete an analysis"
 70:       ),
 71:       counter("hellen.analysis.completed.total",
 72:         tags: [:type],
 73:         description: "Total number of completed analyses"
 74:       ),
 75:       counter("hellen.analysis.failed.total",
 76:         tags: [:type, :reason],
 77:         description: "Total number of failed analyses"
 78:       ),
 79: 
 80:       # Business Metrics - Transcription
 81:       summary("hellen.transcription.duration.milliseconds",
 82:         unit: :millisecond,
 83:         description: "Time taken to complete a transcription"
 84:       ),
 85:       counter("hellen.transcription.completed.total",
 86:         description: "Total number of completed transcriptions"
 87:       ),
 88: 
 89:       # Business Metrics - Credits
 90:       counter("hellen.credits.consumed.total",
 91:         tags: [:reason],
 92:         description: "Total credits consumed by operation type"
 93:       ),
 94:       counter("hellen.credits.refunded.total",
 95:         description: "Total credits refunded"
 96:       ),
 97: 
 98:       # VM Metrics
 99:       last_value("vm.memory.total", unit: :byte),
100:       last_value("vm.memory.processes", unit: :byte),
101:       last_value("vm.memory.binary", unit: :byte),
102:       last_value("vm.total_run_queue_lengths.total"),
103:       last_value("vm.total_run_queue_lengths.cpu"),
104:       last_value("vm.total_run_queue_lengths.io")
105:     ]
106:   end
107: 
108:   defp periodic_measurements do
109:     [
110:       # Dispatch VM memory stats periodically
111:       {__MODULE__, :dispatch_vm_stats, []}
112:     ]
113:   end
114: 
115:   @doc """
116:   Dispatches VM memory statistics to telemetry.
117:   Called periodically by telemetry_poller.
118:   """
119:   def dispatch_vm_stats do
120:     memory = :erlang.memory()
121: 
122:     :telemetry.execute(
123:       [:vm, :memory],
124:       %{
125:         total: memory[:total],
126:         processes: memory[:processes],
127:         binary: memory[:binary]
128:       },
129:       %{}
130:     )
131:   end
132: end
````

## File: lib/hellen/ai/nvidia_client.ex
````elixir
  1: defmodule Hellen.AI.NvidiaClient do
  2:   @moduledoc """
  3:   Client for AI APIs.
  4:   - Transcription: Groq Whisper (fast, OpenAI-compatible REST API)
  5:   - Analysis: NVIDIA NIM Qwen3 (pedagogical feedback)
  6: 
  7:   Uses optimized audio extraction for video files (10x faster with FFmpeg stream copy).
  8:   """
  9: 
 10:   require Logger
 11: 
 12:   alias Hellen.AI.AudioExtractor
 13: 
 14:   # Groq for transcription (OpenAI-compatible REST API)
 15:   @transcription_base_url "https://api.groq.com/openai/v1"
 16:   @transcription_model "whisper-large-v3-turbo"
 17: 
 18:   # NVIDIA for LLM analysis
 19:   @analysis_base_url "https://integrate.api.nvidia.com/v1"
 20:   @analysis_model "qwen/qwen3-next-80b-a3b-instruct"
 21: 
 22:   # Video extensions that need audio extraction
 23:   @video_extensions ~w(.mp4 .mkv .avi .mov .webm .flv .wmv .m4v)
 24: 
 25:   @doc """
 26:   Transcribes audio using Groq Whisper.
 27: 
 28:   The audio_url should be a publicly accessible URL to the audio file.
 29:   This function downloads the file, extracts audio if needed (using FFmpeg),
 30:   and sends it as multipart/form-data.
 31: 
 32:   For video files, uses optimized FFmpeg extraction:
 33:   - Stream copy when codec is compatible (10x faster)
 34:   - Re-encode to MP3 16kHz mono when needed (optimized for ASR)
 35:   """
 36:   def transcribe(audio_url, opts \\ []) do
 37:     language = Keyword.get(opts, :language, "pt")
 38: 
 39:     Logger.info("Starting transcription for URL: #{audio_url}")
 40: 
 41:     start_time = System.monotonic_time(:millisecond)
 42: 
 43:     # Download and process the file (extract audio if video)
 44:     with {:ok, audio_binary, content_type} <- download_and_process(audio_url),
 45:          {:ok, response} <- send_transcription_request(audio_binary, content_type, language) do
 46:       processing_time = System.monotonic_time(:millisecond) - start_time
 47:       Logger.info("Transcription completed in #{processing_time}ms")
 48: 
 49:       {:ok,
 50:        %{
 51:          text: response["text"],
 52:          segments: parse_segments(response["segments"] || []),
 53:          language: response["language"] || language,
 54:          duration: response["duration"],
 55:          processing_time_ms: processing_time
 56:        }}
 57:     else
 58:       {:error, reason} = error ->
 59:         Logger.error("Transcription failed: #{inspect(reason)}")
 60:         error
 61:     end
 62:   end
 63: 
 64:   # Downloads file and extracts audio if it's a video
 65:   defp download_and_process(url) do
 66:     Logger.info("Downloading media from: #{url}")
 67: 
 68:     filename = extract_filename(url)
 69:     ext = Path.extname(filename) |> String.downcase()
 70:     is_video = ext in @video_extensions
 71: 
 72:     case Req.get(url, receive_timeout: 300_000) do
 73:       {:ok, %{status: 200, body: body, headers: headers}} ->
 74:         Logger.info("Downloaded #{format_bytes(byte_size(body))}, file: #{filename}")
 75:         process_downloaded_media(body, headers, url, filename, is_video)
 76: 
 77:       {:ok, %{status: status}} ->
 78:         {:error, {:download_failed, status}}
 79: 
 80:       {:error, reason} ->
 81:         {:error, {:download_error, reason}}
 82:     end
 83:   end
 84: 
 85:   # Process downloaded media - extract audio if video, return as-is if audio
 86:   defp process_downloaded_media(body, _headers, _url, filename, true = _is_video) do
 87:     Logger.info("Video detected - extracting audio with FFmpeg...")
 88:     original_size = byte_size(body)
 89:     extraction_start = System.monotonic_time(:millisecond)
 90: 
 91:     case AudioExtractor.process_for_transcription(body, filename) do
 92:       {:ok, audio_binary, content_type} ->
 93:         log_extraction_result(extraction_start, original_size, byte_size(audio_binary))
 94:         {:ok, audio_binary, content_type}
 95: 
 96:       {:error, reason} ->
 97:         Logger.error("Audio extraction failed: #{inspect(reason)}")
 98:         {:error, {:extraction_failed, reason}}
 99:     end
100:   end
101: 
102:   defp process_downloaded_media(body, headers, url, _filename, false = _is_video) do
103:     content_type = get_content_type(headers, url)
104:     Logger.info("Audio file - using directly (#{content_type})")
105:     {:ok, body, content_type}
106:   end
107: 
108:   defp log_extraction_result(start_time, original_size, audio_size) do
109:     extraction_time = System.monotonic_time(:millisecond) - start_time
110:     reduction = Float.round((1 - audio_size / original_size) * 100, 1)
111: 
112:     Logger.info("""
113:     Audio extraction complete:
114:       - Time: #{extraction_time}ms
115:       - Original: #{format_bytes(original_size)}
116:       - Audio: #{format_bytes(audio_size)}
117:       - Size reduction: #{reduction}%
118:     """)
119:   end
120: 
121:   defp get_content_type(headers, url) do
122:     headers
123:     |> Enum.find(fn {k, _v} -> String.downcase(k) == "content-type" end)
124:     |> case do
125:       {_, ct} -> ct
126:       nil -> guess_content_type(url)
127:     end
128:   end
129: 
130:   defp extract_filename(url) do
131:     url
132:     |> URI.parse()
133:     |> Map.get(:path, "")
134:     |> Path.basename()
135:     |> URI.decode()
136:   end
137: 
138:   defp format_bytes(bytes) when bytes < 1024, do: "#{bytes} B"
139:   defp format_bytes(bytes) when bytes < 1_048_576, do: "#{Float.round(bytes / 1024, 1)} KB"
140:   defp format_bytes(bytes), do: "#{Float.round(bytes / 1_048_576, 1)} MB"
141: 
142:   defp send_transcription_request(audio_binary, content_type, language) do
143:     filename = "audio.#{content_type_to_extension(content_type)}"
144: 
145:     Logger.info(
146:       "Sending transcription request with filename: #{filename}, size: #{byte_size(audio_binary)} bytes"
147:     )
148: 
149:     "#{@transcription_base_url}/audio/transcriptions"
150:     |> Req.post(
151:       form_multipart: [
152:         file: {audio_binary, filename: filename, content_type: content_type},
153:         model: @transcription_model,
154:         language: language,
155:         response_format: "verbose_json"
156:       ],
157:       headers: groq_auth_headers(),
158:       receive_timeout: 300_000
159:     )
160:     |> handle_transcription_response()
161:   end
162: 
163:   @content_type_extensions %{
164:     "audio/mpeg" => "mp3",
165:     "audio/mp3" => "mp3",
166:     "audio/wav" => "wav",
167:     "audio/x-wav" => "wav",
168:     "audio/mp4" => "m4a",
169:     "audio/m4a" => "m4a",
170:     "video/mp4" => "mp4",
171:     "audio/ogg" => "ogg",
172:     "audio/flac" => "flac",
173:     "video/webm" => "webm"
174:   }
175: 
176:   defp content_type_to_extension(content_type) do
177:     Map.get(@content_type_extensions, content_type, "mp3")
178:   end
179: 
180:   defp handle_transcription_response({:ok, %{status: 200, body: body}}) do
181:     Logger.info("Transcription API returned success")
182:     {:ok, body}
183:   end
184: 
185:   defp handle_transcription_response({:ok, %{status: status, body: body}}) do
186:     error_msg = if is_map(body), do: body["error"] || body, else: body
187:     Logger.error("Transcription API error #{status}: #{inspect(error_msg)}")
188:     {:error, %{status: status, message: error_msg}}
189:   end
190: 
191:   defp handle_transcription_response({:error, reason}) do
192:     Logger.error("Transcription request failed: #{inspect(reason)}")
193:     {:error, reason}
194:   end
195: 
196:   defp guess_content_type(url) do
197:     ext = url |> URI.parse() |> Map.get(:path, "") |> Path.extname() |> String.downcase()
198: 
199:     case ext do
200:       ".mp3" -> "audio/mpeg"
201:       ".wav" -> "audio/wav"
202:       ".m4a" -> "audio/mp4"
203:       ".mp4" -> "video/mp4"
204:       ".ogg" -> "audio/ogg"
205:       ".flac" -> "audio/flac"
206:       ".webm" -> "video/webm"
207:       _ -> "audio/mpeg"
208:     end
209:   end
210: 
211:   defp groq_auth_headers do
212:     api_key = Application.get_env(:hellen, :groq_api_key)
213: 
214:     [
215:       {"Authorization", "Bearer #{api_key}"}
216:     ]
217:   end
218: 
219:   @doc """
220:   Analyzes transcription using Qwen3 for pedagogical feedback.
221:   """
222:   def analyze_pedagogy(transcription, context \\ %{}) do
223:     system_prompt = build_pedagogical_prompt(context)
224: 
225:     start_time = System.monotonic_time(:millisecond)
226: 
227:     result =
228:       Req.post("#{@analysis_base_url}/chat/completions",
229:         json: %{
230:           model: @analysis_model,
231:           messages: [
232:             %{role: "system", content: system_prompt},
233:             %{role: "user", content: build_analysis_request(transcription, context)}
234:           ],
235:           temperature: 0.3,
236:           max_tokens: 4096,
237:           response_format: %{type: "json_object"}
238:         },
239:         headers: nvidia_auth_headers(),
240:         receive_timeout: 120_000
241:       )
242: 
243:     processing_time = System.monotonic_time(:millisecond) - start_time
244: 
245:     case result do
246:       {:ok, %{status: 200, body: body}} ->
247:         message = get_in(body, ["choices", Access.at(0), "message", "content"])
248:         usage = body["usage"]
249: 
250:         {:ok,
251:          %{
252:            raw: message,
253:            structured: parse_analysis_response(message),
254:            model: @analysis_model,
255:            tokens_used: (usage["prompt_tokens"] || 0) + (usage["completion_tokens"] || 0),
256:            processing_time_ms: processing_time
257:          }}
258: 
259:       {:ok, %{status: status, body: body}} ->
260:         {:error, %{status: status, message: body["error"] || "Unknown error"}}
261: 
262:       {:error, reason} ->
263:         {:error, reason}
264:     end
265:   end
266: 
267:   @doc """
268:   Generates a structured pedagogical feedback using the Sandwich Method.
269:   """
270:   def analyze_feedback(transcription, context \\ %{}) do
271:     system_prompt = build_feedback_prompt(context)
272: 
273:     start_time = System.monotonic_time(:millisecond)
274: 
275:     result =
276:       Req.post("#{@analysis_base_url}/chat/completions",
277:         json: %{
278:           model: @analysis_model,
279:           messages: [
280:             %{role: "system", content: system_prompt},
281:             %{role: "user", content: build_feedback_request(transcription)}
282:           ],
283:           temperature: 0.4,
284:           max_tokens: 4096,
285:           response_format: %{type: "json_object"}
286:         },
287:         headers: nvidia_auth_headers(),
288:         receive_timeout: 120_000
289:       )
290: 
291:     processing_time = System.monotonic_time(:millisecond) - start_time
292: 
293:     case result do
294:       {:ok, %{status: 200, body: body}} ->
295:         message = get_in(body, ["choices", Access.at(0), "message", "content"])
296:         usage = body["usage"]
297: 
298:         {:ok,
299:          %{
300:            raw: message,
301:            structured: parse_analysis_response(message),
302:            model: @analysis_model,
303:            tokens_used: (usage["prompt_tokens"] || 0) + (usage["completion_tokens"] || 0),
304:            processing_time_ms: processing_time
305:          }}
306: 
307:       {:ok, %{status: status, body: body}} ->
308:         {:error, %{status: status, message: body["error"] || "Unknown error"}}
309: 
310:       {:error, reason} ->
311:         {:error, reason}
312:     end
313:   end
314: 
315:   # Private functions
316: 
317:   defp nvidia_auth_headers do
318:     api_key = Application.get_env(:hellen, :nvidia_api_key)
319: 
320:     [
321:       {"Authorization", "Bearer #{api_key}"},
322:       {"Content-Type", "application/json"}
323:     ]
324:   end
325: 
326:   defp parse_segments(segments) do
327:     Enum.map(segments, fn seg ->
328:       %{
329:         start: seg["start"],
330:         end: seg["end"],
331:         text: seg["text"]
332:       }
333:     end)
334:   end
335: 
336:   defp build_pedagogical_prompt(context) do
337:     """
338:     Você é um especialista em pedagogia e análise de aulas, com profundo conhecimento em:
339:     - BNCC (Base Nacional Comum Curricular)
340:     - Lei 13.185/2015 (Lei Anti-bullying)
341:     - Metodologias ativas de ensino
342:     - Gestão de sala de aula
343: 
344:     Analise a transcrição da aula e forneça feedback estruturado em JSON com:
345:     1. overall_score: float de 0.0 a 1.0
346:     2. bncc_matches: array de competências BNCC identificadas
347:     3. bullying_alerts: array de alertas de comportamento inadequado
348:     4. strengths: pontos fortes da aula
349:     5. improvements: oportunidades de melhoria
350:     6. time_management: análise da gestão do tempo
351:     7. engagement: nível de engajamento dos alunos
352: 
353:     Contexto da aula:
354:     - Disciplina: #{context[:subject] || "Não especificada"}
355:     - Nível: #{context[:grade_level] || "Não especificado"}
356:     """
357:   end
358: 
359:   defp build_feedback_prompt(context) do
360:     """
361:     Você é um Coordenador Pedagógico Sênior especialista em formação de professores.
362:     Seu objetivo é criar um ROTEIRO DE FEEDBACK estruturado e acolhedor para o professor, baseado na transcrição da aula.
363: 
364:     METODOLOGIA: TÉCNICA SANDUÍCHE
365:     1. Abertura Positiva (Acolhimento + Pontos Fortes)
366:     2. Recheio Construtivo (Oportunidades de Melhoria com Evidências)
367:     3. Fechamento Motivador (Plano de Ação + Encorajamento)
368: 
369:     Contexto da aula:
370:     - Disciplina: #{context[:subject] || "Não especificada"}
371:     - Nível: #{context[:grade_level] || "Não especificado"}
372: 
373:     Retorne APENAS um JSON com a seguinte estrutura:
374:     {
375:       "opening": "Texto de abertura acolhedor e empático",
376:       "strengths": [
377:         {
378:           "title": "Título do ponto forte",
379:           "description": "Descrição detalhada",
380:           "evidence": "Citação ou momento específico da transcrição que comprova"
381:         }
382:       ],
383:       "improvements": [
384:         {
385:           "title": "Título da oportunidade de melhoria",
386:           "observation": "O que foi observado (evidência/citação)",
387:           "suggestion": "Sugestão prática e acionável de como melhorar (cite técnicas pedagógicas se aplicável)"
388:         }
389:       ],
390:       "action_plan": [
391:         "Passo 1 do plano de ação",
392:         "Passo 2 do plano de ação",
393:         "Passo 3 do plano de ação"
394:       ],
395:       "closing": "Texto de encerramento motivador e parceiro"
396:     }
397:     """
398:   end
399: 
400:   defp build_analysis_request(transcription, _context) do
401:     """
402:     Analise a seguinte transcrição de aula e forneça seu feedback pedagógico:
403: 
404:     TRANSCRIÇÃO:
405:     #{transcription}
406: 
407:     Responda APENAS em formato JSON válido.
408:     """
409:   end
410: 
411:   defp build_feedback_request(transcription) do
412:     """
413:     Gere o Roteiro de Feedback Pedagógico baseado nesta transcrição:
414: 
415:     TRANSCRIÇÃO:
416:     #{transcription}
417: 
418:     Responda APENAS o JSON estruturado.
419:     """
420:   end
421: 
422:   defp parse_analysis_response(json_string) when is_binary(json_string) do
423:     case Jason.decode(json_string) do
424:       {:ok, parsed} -> parsed
425:       {:error, _} -> %{"error" => "Failed to parse response", "raw" => json_string}
426:     end
427:   end
428: 
429:   defp parse_analysis_response(other), do: other
430: end
````

## File: lib/hellen/workers/analysis_job.ex
````elixir
  1: defmodule Hellen.Workers.AnalysisJob do
  2:   @moduledoc """
  3:   Oban worker for analyzing lesson transcriptions.
  4:   """
  5: 
  6:   use Oban.Worker,
  7:     queue: :analysis,
  8:     max_attempts: 3,
  9:     unique: [period: 300, keys: [:lesson_id]]
 10: 
 11:   alias Hellen.AI.NvidiaClient
 12:   alias Hellen.Analysis
 13:   alias Hellen.Lessons
 14:   alias Hellen.Notifications
 15: 
 16:   require Logger
 17: 
 18:   @impl Oban.Worker
 19:   def perform(%Oban.Job{args: %{"lesson_id" => lesson_id}}) do
 20:     Logger.info("Starting analysis for lesson #{lesson_id}")
 21: 
 22:     lesson = Lessons.get_lesson_with_transcription!(lesson_id)
 23: 
 24:     with {:ok, transcription} <- get_transcription(lesson),
 25:          {:ok, result} <- analyze_transcription(lesson, transcription),
 26:          {:ok, analysis} <- save_analysis(lesson, result),
 27:          {:ok, _lesson} <- Lessons.update_lesson_status(lesson, "completed") do
 28:       Logger.info("Analysis completed for lesson #{lesson_id}")
 29:       broadcast_progress(lesson_id, "analysis_complete", %{analysis_id: analysis.id})
 30: 
 31:       # Send notifications asynchronously
 32:       send_notifications(analysis)
 33: 
 34:       :ok
 35:     else
 36:       {:error, reason} ->
 37:         Logger.error("Analysis failed for lesson #{lesson_id}: #{inspect(reason)}")
 38:         handle_failure(lesson, reason)
 39:     end
 40:   end
 41: 
 42:   defp get_transcription(%{transcription: nil}) do
 43:     {:error, :no_transcription}
 44:   end
 45: 
 46:   defp get_transcription(%{transcription: transcription}) do
 47:     {:ok, transcription.full_text}
 48:   end
 49: 
 50:   defp analyze_transcription(lesson, transcription) do
 51:     context = %{
 52:       subject: lesson.subject,
 53:       grade_level: lesson.grade_level
 54:     }
 55: 
 56:     case NvidiaClient.analyze_pedagogy(transcription, context) do
 57:       {:ok, result} ->
 58:         {:ok, build_analysis_result(result)}
 59: 
 60:       {:error, _} = error ->
 61:         error
 62:     end
 63:   end
 64: 
 65:   defp build_analysis_result(nvidia_result) do
 66:     structured = nvidia_result.structured
 67: 
 68:     %{
 69:       model: nvidia_result.model,
 70:       # Wrap raw string in a map to match the :map field type in Analysis schema
 71:       raw: %{"content" => nvidia_result.raw},
 72:       structured: structured,
 73:       overall_score: parse_float(structured["overall_score"]),
 74:       processing_time_ms: nvidia_result.processing_time_ms,
 75:       tokens_used: nvidia_result.tokens_used,
 76:       bncc_matches: parse_bncc_matches(structured["bncc_matches"]),
 77:       bullying_alerts: parse_bullying_alerts(structured["bullying_alerts"])
 78:     }
 79:   end
 80: 
 81:   defp parse_bncc_matches(nil), do: []
 82: 
 83:   defp parse_bncc_matches(matches) when is_list(matches) do
 84:     Enum.map(matches, fn match ->
 85:       %{
 86:         competencia_code: match["code"] || match["competencia_code"],
 87:         competencia_name: match["name"] || match["competencia_name"],
 88:         match_score: parse_float(match["score"] || match["match_score"]),
 89:         evidence_text: match["evidence"] || match["evidence_text"]
 90:       }
 91:     end)
 92:   end
 93: 
 94:   defp parse_bullying_alerts(nil), do: []
 95: 
 96:   defp parse_bullying_alerts(alerts) when is_list(alerts) do
 97:     Enum.map(alerts, fn alert ->
 98:       %{
 99:         severity: alert["severity"] || "low",
100:         alert_type: alert["type"] || alert["alert_type"] || "other",
101:         description: alert["description"],
102:         evidence_text: alert["evidence"] || alert["evidence_text"],
103:         timestamp_start: parse_float(alert["start"]),
104:         timestamp_end: parse_float(alert["end"])
105:       }
106:     end)
107:   end
108: 
109:   defp parse_float(nil), do: nil
110:   defp parse_float(value) when is_float(value), do: value
111:   defp parse_float(value) when is_integer(value), do: value / 1.0
112: 
113:   defp parse_float(value) when is_binary(value) do
114:     case Float.parse(value) do
115:       {float, _} -> float
116:       :error -> nil
117:     end
118:   end
119: 
120:   defp save_analysis(lesson, result) do
121:     Analysis.create_full_analysis(lesson.id, result)
122:   end
123: 
124:   defp handle_failure(lesson, reason) do
125:     Lessons.update_lesson_status(lesson, "failed")
126:     broadcast_progress(lesson.id, "analysis_failed", %{error: inspect(reason)})
127:     {:error, reason}
128:   end
129: 
130:   defp broadcast_progress(lesson_id, event, payload) do
131:     Phoenix.PubSub.broadcast(
132:       Hellen.PubSub,
133:       "lesson:#{lesson_id}",
134:       {event, Map.put(payload, :lesson_id, lesson_id)}
135:     )
136:   end
137: 
138:   defp send_notifications(analysis) do
139:     # Preload required associations
140:     analysis = Hellen.Repo.preload(analysis, [:bullying_alerts, lesson: [:user, :institution]])
141: 
142:     # Notify about analysis completion
143:     Task.start(fn ->
144:       try do
145:         Notifications.notify_analysis_complete(analysis)
146:       rescue
147:         e -> Logger.warning("Failed to send analysis notification: #{inspect(e)}")
148:       end
149:     end)
150: 
151:     # Notify about each bullying alert
152:     Enum.each(analysis.bullying_alerts, fn alert ->
153:       Task.start(fn ->
154:         try do
155:           Notifications.notify_alert(alert)
156:         rescue
157:           e -> Logger.warning("Failed to send alert notification: #{inspect(e)}")
158:         end
159:       end)
160:     end)
161:   end
162: end
````

## File: lib/hellen/application.ex
````elixir
 1: defmodule Hellen.Application do
 2:   @moduledoc false
 3: 
 4:   use Application
 5: 
 6:   @impl true
 7:   def start(_type, _args) do
 8:     children = [
 9:       HellenWeb.Telemetry,
10:       Hellen.Repo,
11:       {DNSCluster, query: Application.get_env(:hellen, :dns_cluster_query) || :ignore},
12:       {Phoenix.PubSub, name: Hellen.PubSub},
13:       # Start Oban
14:       {Oban, Application.fetch_env!(:hellen, Oban)},
15:       # Start Redis connection
16:       {Redix,
17:        {Application.get_env(:hellen, :redis_url, "redis://localhost:6379"), [name: :redix]}},
18:       # Start ChromicPDF for PDF generation
19:       {ChromicPDF, Application.get_env(:hellen, :chromic_pdf, [])},
20:       # Start Finch for HTTP client (Swoosh API)
21:       {Finch, name: Hellen.Finch},
22:       # Start the Endpoint (http/https)
23:       HellenWeb.Endpoint
24:     ]
25: 
26:     opts = [strategy: :one_for_one, name: Hellen.Supervisor]
27:     Supervisor.start_link(children, opts)
28:   end
29: 
30:   @impl true
31:   def config_change(changed, _new, removed) do
32:     HellenWeb.Endpoint.config_change(changed, removed)
33:     :ok
34:   end
35: end
````

## File: lib/hellen/storage.ex
````elixir
  1: defmodule Hellen.Storage do
  2:   @moduledoc """
  3:   Storage module for Cloudflare R2.
  4: 
  5:   Handles file uploads, downloads, and URL generation for
  6:   lesson audio/video files.
  7:   """
  8: 
  9:   @doc """
 10:   Uploads a file to R2 storage.
 11: 
 12:   ## Options
 13:     * `:content_type` - MIME type of the file (auto-detected if not provided)
 14:     * `:acl` - Access control (default: :public_read)
 15: 
 16:   ## Examples
 17: 
 18:       iex> Storage.upload("lessons/uuid/audio.mp3", binary_data)
 19:       {:ok, "https://pub-xxx.r2.dev/lessons/uuid/audio.mp3"}
 20: 
 21:       iex> Storage.upload("lessons/uuid/video.mp4", binary_data, content_type: "video/mp4")
 22:       {:ok, "https://pub-xxx.r2.dev/lessons/uuid/video.mp4"}
 23:   """
 24:   def upload(key, binary, opts \\ []) do
 25:     bucket = get_bucket()
 26:     content_type = opts[:content_type] || guess_content_type(key)
 27: 
 28:     request =
 29:       ExAws.S3.put_object(bucket, key, binary,
 30:         content_type: content_type,
 31:         acl: opts[:acl] || :public_read
 32:       )
 33: 
 34:     case ExAws.request(request) do
 35:       {:ok, _response} ->
 36:         {:ok, public_url(key)}
 37: 
 38:       {:error, reason} ->
 39:         {:error, reason}
 40:     end
 41:   end
 42: 
 43:   @doc """
 44:   Uploads a file from a local path to R2 storage.
 45: 
 46:   ## Examples
 47: 
 48:       iex> Storage.upload_file("lessons/uuid/audio.mp3", "/tmp/upload.mp3")
 49:       {:ok, "https://pub-xxx.r2.dev/lessons/uuid/audio.mp3"}
 50:   """
 51:   def upload_file(key, local_path, opts \\ []) do
 52:     case File.read(local_path) do
 53:       {:ok, binary} ->
 54:         upload(key, binary, opts)
 55: 
 56:       {:error, reason} ->
 57:         {:error, {:file_read_error, reason}}
 58:     end
 59:   end
 60: 
 61:   @doc """
 62:   Uploads a file from a Phoenix LiveView upload entry.
 63: 
 64:   ## Examples
 65: 
 66:       iex> Storage.upload_entry(socket, entry, "lessons/uuid")
 67:       {:ok, "https://pub-xxx.r2.dev/lessons/uuid/filename.mp3"}
 68:   """
 69:   def upload_entry(socket, entry, key_prefix) do
 70:     key = "#{key_prefix}/#{entry.client_name}"
 71:     content_type = entry.client_type
 72: 
 73:     Phoenix.LiveView.consume_uploaded_entry(socket, entry, fn %{path: path} ->
 74:       case File.read(path) do
 75:         {:ok, binary} ->
 76:           upload(key, binary, content_type: content_type)
 77: 
 78:         {:error, reason} ->
 79:           {:error, {:file_read_error, reason}}
 80:       end
 81:     end)
 82:   end
 83: 
 84:   @doc """
 85:   Deletes a file from R2 storage.
 86: 
 87:   ## Examples
 88: 
 89:       iex> Storage.delete("lessons/uuid/audio.mp3")
 90:       :ok
 91:   """
 92:   def delete(key) do
 93:     bucket = get_bucket()
 94:     request = ExAws.S3.delete_object(bucket, key)
 95: 
 96:     case ExAws.request(request) do
 97:       {:ok, _response} -> :ok
 98:       {:error, reason} -> {:error, reason}
 99:     end
100:   end
101: 
102:   @doc """
103:   Returns the public URL for a stored file.
104: 
105:   ## Examples
106: 
107:       iex> Storage.public_url("lessons/uuid/audio.mp3")
108:       "https://pub-xxx.r2.dev/lessons/uuid/audio.mp3"
109:   """
110:   def public_url(key) do
111:     base_url = get_public_url()
112:     "#{base_url}/#{key}"
113:   end
114: 
115:   @doc """
116:   Generates a unique key for a lesson file.
117: 
118:   ## Examples
119: 
120:       iex> Storage.lesson_key(lesson_id, "audio.mp3")
121:       "lessons/abc123/audio.mp3"
122:   """
123:   def lesson_key(lesson_id, filename) do
124:     sanitized = sanitize_filename(filename)
125:     "lessons/#{lesson_id}/#{sanitized}"
126:   end
127: 
128:   @doc """
129:   Checks if the storage is properly configured.
130:   """
131:   def configured? do
132:     config = Application.get_env(:hellen, :r2, [])
133:     config[:bucket] != nil && config[:public_url] != nil
134:   end
135: 
136:   @doc """
137:   Generates a presigned URL for direct browser upload to R2.
138: 
139:   This enables External Uploads in Phoenix LiveView, allowing the browser
140:   to upload directly to R2 without going through the Phoenix server.
141: 
142:   ## Options
143:     * `:content_type` - MIME type of the file (default: "application/octet-stream")
144:     * `:expires_in` - URL expiration in seconds (default: 3600)
145: 
146:   ## Examples
147: 
148:       iex> Storage.presigned_put_url("lessons/uuid/audio.mp3", content_type: "audio/mpeg")
149:       {:ok, "https://...r2.cloudflarestorage.com/...?X-Amz-Signature=..."}
150:   """
151:   def presigned_put_url(key, opts \\ []) do
152:     bucket = get_bucket()
153:     content_type = opts[:content_type] || "application/octet-stream"
154:     expires_in = opts[:expires_in] || 3600
155: 
156:     config = ExAws.Config.new(:s3)
157: 
158:     ExAws.S3.presigned_url(config, :put, bucket, key,
159:       expires_in: expires_in,
160:       query_params: [{"Content-Type", content_type}]
161:     )
162:   end
163: 
164:   # Private functions
165: 
166:   defp get_bucket do
167:     config = Application.get_env(:hellen, :r2, [])
168:     config[:bucket] || raise "R2 bucket not configured"
169:   end
170: 
171:   defp get_public_url do
172:     config = Application.get_env(:hellen, :r2, [])
173:     config[:public_url] || raise "R2 public URL not configured"
174:   end
175: 
176:   defp sanitize_filename(filename) do
177:     filename
178:     |> String.replace(~r/[^\w\.\-]/, "_")
179:     |> String.downcase()
180:   end
181: 
182:   @content_types %{
183:     ".mp3" => "audio/mpeg",
184:     ".mp4" => "video/mp4",
185:     ".m4a" => "audio/mp4",
186:     ".wav" => "audio/wav",
187:     ".webm" => "video/webm",
188:     ".ogg" => "audio/ogg",
189:     ".flac" => "audio/flac",
190:     ".mov" => "video/quicktime",
191:     ".avi" => "video/x-msvideo",
192:     ".mkv" => "video/x-matroska"
193:   }
194: 
195:   defp guess_content_type(key) do
196:     Map.get(@content_types, Path.extname(key), "application/octet-stream")
197:   end
198: end
````

## File: lib/hellen_web/channels/user_socket.ex
````elixir
 1: defmodule HellenWeb.UserSocket do
 2:   use Phoenix.Socket
 3: 
 4:   alias Hellen.Auth.Guardian
 5: 
 6:   channel "lesson:*", HellenWeb.LessonChannel
 7: 
 8:   @impl true
 9:   def connect(%{"token" => token}, socket, _connect_info) do
10:     # Verify JWT token and assign user_id to socket
11:     case verify_token(token) do
12:       {:ok, user_id} ->
13:         {:ok, assign(socket, :user_id, user_id)}
14: 
15:       {:error, _reason} ->
16:         :error
17:     end
18:   end
19: 
20:   def connect(_params, _socket, _connect_info) do
21:     :error
22:   end
23: 
24:   @impl true
25:   def id(socket), do: "user_socket:#{socket.assigns.user_id}"
26: 
27:   # Verify JWT token using Guardian
28:   defp verify_token(token) do
29:     case Guardian.resource_from_token(token) do
30:       {:ok, user, _claims} ->
31:         {:ok, user.id}
32: 
33:       {:error, reason} ->
34:         {:error, reason}
35:     end
36:   end
37: end
````

## File: lib/hellen_web/components/layouts/auth.html.heex
````
 1: <div class="min-h-screen flex flex-col justify-center py-12 px-4 sm:px-6 lg:px-8 bg-gradient-to-br from-slate-50 via-white to-indigo-50 dark:from-slate-950 dark:via-slate-900 dark:to-indigo-950 transition-colors duration-300">
 2:   <!-- Animated background elements -->
 3:   <div class="fixed inset-0 overflow-hidden pointer-events-none">
 4:     <div class="absolute -top-40 -right-40 w-80 h-80 bg-gradient-to-br from-indigo-400/20 to-purple-400/20 dark:from-indigo-600/10 dark:to-purple-600/10 rounded-full blur-3xl animate-pulse">
 5:     </div>
 6:     <div
 7:       class="absolute -bottom-40 -left-40 w-80 h-80 bg-gradient-to-br from-purple-400/20 to-pink-400/20 dark:from-purple-600/10 dark:to-pink-600/10 rounded-full blur-3xl animate-pulse"
 8:       style="animation-delay: 1s;"
 9:     >
10:     </div>
11:     <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-gradient-to-br from-indigo-300/10 to-purple-300/10 dark:from-indigo-500/5 dark:to-purple-500/5 rounded-full blur-3xl">
12:     </div>
13:   </div>
14: 
15:   <div class="relative z-10 sm:mx-auto sm:w-full sm:max-w-md">
16:     <!-- Logo -->
17:     <div class="flex justify-center">
18:       <a href="/" class="flex items-center group">
19:         <span class="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400 bg-clip-text text-transparent transition-all duration-300 group-hover:from-indigo-500 group-hover:to-purple-500">
20:           Hellen
21:         </span>
22:         <span class="ml-1.5 text-sm font-medium text-gray-500 dark:text-gray-400 transition-colors">
23:           AI
24:         </span>
25:       </a>
26:     </div>
27:     <!-- Title -->
28:     <h2
29:       :if={assigns[:page_title]}
30:       class="mt-8 text-center text-3xl font-bold tracking-tight text-gray-900 dark:text-white transition-colors"
31:     >
32:       <%= assigns[:page_title] %>
33:     </h2>
34:     <p
35:       :if={assigns[:page_subtitle]}
36:       class="mt-3 text-center text-base text-gray-600 dark:text-gray-400 transition-colors"
37:     >
38:       <%= assigns[:page_subtitle] %>
39:     </p>
40:   </div>
41: 
42:   <div class="relative z-10 mt-8 sm:mx-auto sm:w-full sm:max-w-md">
43:     <!-- Card with glass effect -->
44:     <div class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl py-8 px-6 shadow-xl shadow-indigo-500/5 dark:shadow-indigo-500/10 rounded-2xl sm:px-10 border border-gray-200/50 dark:border-slate-700/50 transition-all duration-300">
45:       <.flash_group flash={@flash} />
46:       <%= @inner_content %>
47:     </div>
48:     <!-- Back to home link -->
49:     <p class="mt-8 text-center text-sm text-gray-500 dark:text-gray-400 transition-colors">
50:       <a
51:         href="/"
52:         class="inline-flex items-center gap-1.5 font-medium text-indigo-600 dark:text-indigo-400 hover:text-indigo-500 dark:hover:text-indigo-300 transition-colors"
53:       >
54:         <svg
55:           xmlns="http://www.w3.org/2000/svg"
56:           class="h-4 w-4"
57:           fill="none"
58:           viewBox="0 0 24 24"
59:           stroke="currentColor"
60:           stroke-width="2"
61:         >
62:           <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
63:         </svg>
64:         Voltar para home
65:       </a>
66:     </p>
67:   </div>
68: </div>
````

## File: lib/hellen_web/controllers/api/analysis_controller.ex
````elixir
 1: defmodule HellenWeb.API.AnalysisController do
 2:   @moduledoc """
 3:   API controller for analysis management.
 4:   All actions are scoped to the user's institution for security.
 5:   """
 6:   use HellenWeb, :api_controller
 7: 
 8:   alias Hellen.Analysis
 9: 
10:   action_fallback HellenWeb.FallbackController
11: 
12:   def index(conn, %{"lesson_id" => lesson_id}) do
13:     user = conn.assigns.current_user
14:     analyses = Analysis.list_analyses_by_lesson(lesson_id, user.institution_id)
15:     render(conn, :index, analyses: analyses)
16:   end
17: 
18:   def show(conn, %{"id" => id}) do
19:     user = conn.assigns.current_user
20:     analysis = Analysis.get_analysis_with_details!(id, user.institution_id)
21:     render(conn, :show, analysis: analysis)
22:   end
23: end
````

## File: lib/hellen_web/controllers/api/lesson_controller.ex
````elixir
 1: defmodule HellenWeb.API.LessonController do
 2:   @moduledoc """
 3:   API controller for lesson management.
 4:   All actions are scoped to the user's institution for security.
 5:   """
 6:   use HellenWeb, :api_controller
 7: 
 8:   alias Hellen.Lessons
 9:   alias Hellen.Lessons.Lesson
10: 
11:   action_fallback HellenWeb.FallbackController
12: 
13:   def index(conn, _params) do
14:     user = conn.assigns.current_user
15:     lessons = Lessons.list_lessons_by_user(user.id)
16:     render(conn, :index, lessons: lessons)
17:   end
18: 
19:   def create(conn, %{"lesson" => lesson_params}) do
20:     user = conn.assigns.current_user
21: 
22:     with {:ok, %Lesson{} = lesson} <- Lessons.create_lesson(user, lesson_params) do
23:       conn
24:       |> put_status(:created)
25:       |> render(:show, lesson: lesson)
26:     end
27:   end
28: 
29:   def show(conn, %{"id" => id}) do
30:     user = conn.assigns.current_user
31:     lesson = Lessons.get_lesson_with_transcription!(id, user.institution_id)
32:     render(conn, :show, lesson: lesson)
33:   end
34: 
35:   def update(conn, %{"id" => id, "lesson" => lesson_params}) do
36:     user = conn.assigns.current_user
37:     lesson = Lessons.get_lesson!(id, user.institution_id)
38: 
39:     with {:ok, %Lesson{} = lesson} <- Lessons.update_lesson(lesson, lesson_params) do
40:       render(conn, :show, lesson: lesson)
41:     end
42:   end
43: 
44:   def delete(conn, %{"id" => id}) do
45:     user = conn.assigns.current_user
46:     lesson = Lessons.get_lesson!(id, user.institution_id)
47: 
48:     with {:ok, %Lesson{}} <- Lessons.delete_lesson(lesson) do
49:       send_resp(conn, :no_content, "")
50:     end
51:   end
52: 
53:   def analyze(conn, %{"id" => id}) do
54:     user = conn.assigns.current_user
55:     lesson = Lessons.get_lesson!(id, user.institution_id)
56: 
57:     with {:ok, lesson} <- Lessons.start_processing(lesson, user) do
58:       conn
59:       |> put_status(:accepted)
60:       |> render(:show, lesson: lesson)
61:     end
62:   end
63: end
````

## File: lib/hellen_web/live/auth_live/login.ex
````elixir
  1: defmodule HellenWeb.AuthLive.Login do
  2:   use HellenWeb, :live_view
  3: 
  4:   @impl true
  5:   def mount(_params, _session, socket) do
  6:     # Redirect if already logged in
  7:     if socket.assigns[:current_user] do
  8:       {:ok, push_navigate(socket, to: ~p"/")}
  9:     else
 10:       {:ok,
 11:        assign(socket, page_title: "Entrar", page_subtitle: "Acesse sua conta para continuar")}
 12:     end
 13:   end
 14: 
 15:   @impl true
 16:   def handle_event("firebase_error", %{"message" => message}, socket) do
 17:     {:noreply, put_flash(socket, :error, message)}
 18:   end
 19: 
 20:   @impl true
 21:   def render(assigns) do
 22:     ~H"""
 23:     <!-- Google Sign In Button -->
 24:     <div class="mb-6">
 25:       <button
 26:         type="button"
 27:         id="google-signin-btn"
 28:         phx-hook="GoogleSignIn"
 29:         class="w-full flex justify-center items-center gap-3 py-3 px-4 rounded-xl text-sm font-semibold text-gray-700 dark:text-gray-200 bg-white dark:bg-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600 border border-gray-300 dark:border-slate-600 shadow-sm hover:shadow transition-all duration-200"
 30:       >
 31:         <svg class="w-5 h-5" viewBox="0 0 24 24">
 32:           <path
 33:             fill="#4285F4"
 34:             d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
 35:           />
 36:           <path
 37:             fill="#34A853"
 38:             d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
 39:           />
 40:           <path
 41:             fill="#FBBC05"
 42:             d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
 43:           />
 44:           <path
 45:             fill="#EA4335"
 46:             d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
 47:           />
 48:         </svg>
 49:         Entrar com Google
 50:       </button>
 51:     </div>
 52: 
 53:     <div class="relative mb-6">
 54:       <div class="absolute inset-0 flex items-center">
 55:         <div class="w-full border-t border-gray-200 dark:border-slate-700"></div>
 56:       </div>
 57:       <div class="relative flex justify-center text-sm">
 58:         <span class="px-4 bg-white/80 dark:bg-slate-800/80 text-gray-500 dark:text-gray-400">
 59:           ou entre com email
 60:         </span>
 61:       </div>
 62:     </div>
 63: 
 64:     <form action={~p"/session/login"} method="post" class="space-y-5">
 65:       <input type="hidden" name="_csrf_token" value={Phoenix.Controller.get_csrf_token()} />
 66: 
 67:       <div>
 68:         <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">
 69:           Email
 70:         </label>
 71:         <div class="relative">
 72:           <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none">
 73:             <svg
 74:               xmlns="http://www.w3.org/2000/svg"
 75:               class="h-5 w-5 text-gray-400 dark:text-gray-500"
 76:               fill="none"
 77:               viewBox="0 0 24 24"
 78:               stroke="currentColor"
 79:               stroke-width="1.5"
 80:             >
 81:               <path
 82:                 stroke-linecap="round"
 83:                 stroke-linejoin="round"
 84:                 d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"
 85:               />
 86:             </svg>
 87:           </div>
 88:           <input
 89:             type="email"
 90:             name="email"
 91:             id="email"
 92:             placeholder="seu@email.com"
 93:             required
 94:             autocomplete="email"
 95:             class="block w-full pl-11 pr-4 py-3 rounded-xl border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700/50 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 focus:border-transparent transition-all duration-200 sm:text-sm"
 96:           />
 97:         </div>
 98:       </div>
 99: 
100:       <div>
101:         <div class="flex items-center justify-between mb-1.5">
102:           <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
103:             Senha
104:           </label>
105:           <a
106:             href="#"
107:             class="text-sm font-medium text-indigo-600 dark:text-indigo-400 hover:text-indigo-500 dark:hover:text-indigo-300 transition-colors"
108:           >
109:             Esqueceu a senha?
110:           </a>
111:         </div>
112:         <div class="relative">
113:           <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none">
114:             <svg
115:               xmlns="http://www.w3.org/2000/svg"
116:               class="h-5 w-5 text-gray-400 dark:text-gray-500"
117:               fill="none"
118:               viewBox="0 0 24 24"
119:               stroke="currentColor"
120:               stroke-width="1.5"
121:             >
122:               <path
123:                 stroke-linecap="round"
124:                 stroke-linejoin="round"
125:                 d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z"
126:               />
127:             </svg>
128:           </div>
129:           <input
130:             type="password"
131:             name="password"
132:             id="password"
133:             placeholder="Digite sua senha"
134:             required
135:             autocomplete="current-password"
136:             class="block w-full pl-11 pr-4 py-3 rounded-xl border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700/50 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 focus:border-transparent transition-all duration-200 sm:text-sm"
137:           />
138:         </div>
139:       </div>
140: 
141:       <div class="pt-2">
142:         <button
143:           type="submit"
144:           class="w-full flex justify-center items-center gap-2 py-3 px-4 rounded-xl text-sm font-semibold text-white bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-slate-800 shadow-lg shadow-indigo-500/25 hover:shadow-indigo-500/40 transition-all duration-200"
145:         >
146:           <svg
147:             xmlns="http://www.w3.org/2000/svg"
148:             class="h-5 w-5"
149:             fill="none"
150:             viewBox="0 0 24 24"
151:             stroke="currentColor"
152:             stroke-width="2"
153:           >
154:             <path
155:               stroke-linecap="round"
156:               stroke-linejoin="round"
157:               d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"
158:             />
159:           </svg>
160:           Entrar
161:         </button>
162:       </div>
163:     </form>
164: 
165:     <div class="mt-8">
166:       <div class="relative">
167:         <div class="absolute inset-0 flex items-center">
168:           <div class="w-full border-t border-gray-200 dark:border-slate-700"></div>
169:         </div>
170:         <div class="relative flex justify-center text-sm">
171:           <span class="px-4 bg-white/80 dark:bg-slate-800/80 text-gray-500 dark:text-gray-400">
172:             Novo por aqui?
173:           </span>
174:         </div>
175:       </div>
176: 
177:       <div class="mt-6">
178:         <.link
179:           navigate={~p"/register"}
180:           class="w-full flex justify-center items-center gap-2 py-3 px-4 rounded-xl text-sm font-semibold text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-500/10 hover:bg-indigo-100 dark:hover:bg-indigo-500/20 border border-indigo-200 dark:border-indigo-500/30 transition-all duration-200"
181:         >
182:           <svg
183:             xmlns="http://www.w3.org/2000/svg"
184:             class="h-5 w-5"
185:             fill="none"
186:             viewBox="0 0 24 24"
187:             stroke="currentColor"
188:             stroke-width="2"
189:           >
190:             <path
191:               stroke-linecap="round"
192:               stroke-linejoin="round"
193:               d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"
194:             />
195:           </svg>
196:           Criar conta gratuita
197:         </.link>
198:       </div>
199:     </div>
200:     """
201:   end
202: end
````

## File: lib/hellen_web/live/institution_live/reports.ex
````elixir
  1: defmodule HellenWeb.InstitutionLive.Reports do
  2:   @moduledoc """
  3:   Reports page for coordinator - generates PDF reports.
  4:   Supports monthly institution reports, teacher reports, and analysis exports.
  5:   """
  6:   use HellenWeb, :live_view
  7: 
  8:   alias Hellen.Accounts
  9: 
 10:   @impl true
 11:   def mount(_params, _session, socket) do
 12:     user = socket.assigns.current_user
 13:     institution_id = user.institution_id
 14: 
 15:     if institution_id do
 16:       teachers = Accounts.list_users_by_institution(institution_id)
 17:       current_date = Date.utc_today()
 18: 
 19:       {:ok,
 20:        socket
 21:        |> assign(page_title: "Relatorios")
 22:        |> assign(institution_id: institution_id)
 23:        |> assign(teachers: teachers)
 24:        |> assign(selected_type: nil)
 25:        |> assign(selected_month: current_date.month)
 26:        |> assign(selected_year: current_date.year)
 27:        |> assign(selected_teacher_id: nil)
 28:        |> assign(generating: false)}
 29:     else
 30:       {:ok,
 31:        socket
 32:        |> assign(page_title: "Relatorios")
 33:        |> assign(teachers: [])
 34:        |> put_flash(:error, "Voce nao esta associado a nenhuma instituicao")}
 35:     end
 36:   end
 37: 
 38:   @impl true
 39:   def handle_event("select_type", %{"type" => type}, socket) do
 40:     {:noreply, assign(socket, selected_type: type)}
 41:   end
 42: 
 43:   def handle_event("update_month", %{"month" => month}, socket) do
 44:     {:noreply, assign(socket, selected_month: String.to_integer(month))}
 45:   end
 46: 
 47:   def handle_event("update_year", %{"year" => year}, socket) do
 48:     {:noreply, assign(socket, selected_year: String.to_integer(year))}
 49:   end
 50: 
 51:   def handle_event("update_teacher", %{"teacher_id" => teacher_id}, socket) do
 52:     {:noreply, assign(socket, selected_teacher_id: teacher_id)}
 53:   end
 54: 
 55:   def handle_event("clear_selection", _params, socket) do
 56:     {:noreply,
 57:      socket
 58:      |> assign(selected_type: nil)
 59:      |> assign(selected_teacher_id: nil)}
 60:   end
 61: 
 62:   @impl true
 63:   def render(assigns) do
 64:     ~H"""
 65:     <div class="space-y-6">
 66:       <.page_header title="Relatorios" description="Gere relatorios consolidados da sua instituicao" />
 67: 
 68:       <%= if @selected_type do %>
 69:         <!-- Report Configuration -->
 70:         <.card>
 71:           <div class="space-y-6">
 72:             <!-- Back button -->
 73:             <button
 74:               type="button"
 75:               phx-click="clear_selection"
 76:               class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"
 77:             >
 78:               <.icon name="hero-arrow-left" class="h-4 w-4" /> Voltar
 79:             </button>
 80: 
 81:             <div class="flex items-center gap-4">
 82:               <div class={[
 83:                 "p-3 rounded-xl",
 84:                 report_icon_bg(@selected_type)
 85:               ]}>
 86:                 <.icon name={report_icon(@selected_type)} class="h-6 w-6 text-white" />
 87:               </div>
 88:               <div>
 89:                 <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
 90:                   <%= report_title(@selected_type) %>
 91:                 </h2>
 92:                 <p class="text-sm text-gray-500 dark:text-gray-400">
 93:                   <%= report_description(@selected_type) %>
 94:                 </p>
 95:               </div>
 96:             </div>
 97:             <!-- Configuration Form -->
 98:             <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
 99:               <!-- Month Selection -->
100:               <div>
101:                 <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
102:                   Mes
103:                 </label>
104:                 <select
105:                   phx-change="update_month"
106:                   name="month"
107:                   class="w-full rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-gray-900 dark:text-white"
108:                 >
109:                   <%= for {name, num} <- months() do %>
110:                     <option value={num} selected={@selected_month == num}><%= name %></option>
111:                   <% end %>
112:                 </select>
113:               </div>
114:               <!-- Year Selection -->
115:               <div>
116:                 <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
117:                   Ano
118:                 </label>
119:                 <select
120:                   phx-change="update_year"
121:                   name="year"
122:                   class="w-full rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-gray-900 dark:text-white"
123:                 >
124:                   <%= for year <- years() do %>
125:                     <option value={year} selected={@selected_year == year}><%= year %></option>
126:                   <% end %>
127:                 </select>
128:               </div>
129:               <!-- Teacher Selection (for teacher report) -->
130:               <%= if @selected_type == "teacher" do %>
131:                 <div>
132:                   <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
133:                     Professor
134:                   </label>
135:                   <select
136:                     phx-change="update_teacher"
137:                     name="teacher_id"
138:                     class="w-full rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-gray-900 dark:text-white"
139:                   >
140:                     <option value="">Selecione um professor</option>
141:                     <%= for teacher <- @teachers do %>
142:                       <option value={teacher.id} selected={@selected_teacher_id == teacher.id}>
143:                         <%= teacher.name || teacher.email %>
144:                       </option>
145:                     <% end %>
146:                   </select>
147:                 </div>
148:               <% end %>
149:             </div>
150:             <!-- Generate Button -->
151:             <div class="flex justify-end pt-4 border-t border-gray-100 dark:border-slate-700">
152:               <.link
153:                 href={download_url(@selected_type, assigns)}
154:                 target="_blank"
155:                 class={[
156:                   "inline-flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-colors",
157:                   can_generate?(@selected_type, assigns) &&
158:                     "bg-indigo-600 hover:bg-indigo-700 text-white",
159:                   !can_generate?(@selected_type, assigns) &&
160:                     "bg-gray-200 dark:bg-slate-600 text-gray-400 dark:text-gray-500 cursor-not-allowed pointer-events-none"
161:                 ]}
162:               >
163:                 <.icon name="hero-document-arrow-down" class="h-5 w-5" /> Gerar PDF
164:               </.link>
165:             </div>
166:           </div>
167:         </.card>
168:       <% else %>
169:         <!-- Report Type Selection -->
170:         <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
171:           <!-- Monthly Report -->
172:           <button
173:             type="button"
174:             phx-click="select_type"
175:             phx-value-type="monthly"
176:             class="group bg-white dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-700 p-6 text-left hover:border-indigo-300 dark:hover:border-indigo-600 hover:shadow-md transition-all"
177:           >
178:             <div class="flex items-start gap-4">
179:               <div class="p-3 bg-indigo-100 dark:bg-indigo-900/30 rounded-xl group-hover:bg-indigo-200 dark:group-hover:bg-indigo-900/50 transition-colors">
180:                 <.icon name="hero-chart-bar" class="h-6 w-6 text-indigo-600 dark:text-indigo-400" />
181:               </div>
182:               <div>
183:                 <h3 class="font-semibold text-gray-900 dark:text-white">Relatorio Mensal</h3>
184:                 <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
185:                   Visao geral da instituicao com metricas, ranking de professores e alertas.
186:                 </p>
187:               </div>
188:             </div>
189:           </button>
190:           <!-- Teacher Report -->
191:           <button
192:             type="button"
193:             phx-click="select_type"
194:             phx-value-type="teacher"
195:             class="group bg-white dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-700 p-6 text-left hover:border-green-300 dark:hover:border-green-600 hover:shadow-md transition-all"
196:           >
197:             <div class="flex items-start gap-4">
198:               <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-xl group-hover:bg-green-200 dark:group-hover:bg-green-900/50 transition-colors">
199:                 <.icon name="hero-user" class="h-6 w-6 text-green-600 dark:text-green-400" />
200:               </div>
201:               <div>
202:                 <h3 class="font-semibold text-gray-900 dark:text-white">Relatorio do Professor</h3>
203:                 <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
204:                   Performance individual com historico de scores e competencias.
205:                 </p>
206:               </div>
207:             </div>
208:           </button>
209:           <!-- Analysis Export (Coming Soon) -->
210:           <div class="bg-white dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-700 p-6 opacity-60">
211:             <div class="flex items-start gap-4">
212:               <div class="p-3 bg-purple-100 dark:bg-purple-900/30 rounded-xl">
213:                 <.icon name="hero-document-text" class="h-6 w-6 text-purple-600 dark:text-purple-400" />
214:               </div>
215:               <div>
216:                 <h3 class="font-semibold text-gray-900 dark:text-white">
217:                   Export de Analise
218:                   <span class="ml-2 text-xs font-normal text-gray-400">(via aula)</span>
219:                 </h3>
220:                 <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
221:                   Acesse a pagina da aula para exportar uma analise especifica em PDF.
222:                 </p>
223:               </div>
224:             </div>
225:           </div>
226:         </div>
227:         <!-- Info Card -->
228:         <.card>
229:           <div class="flex items-start gap-4">
230:             <div class="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg">
231:               <.icon name="hero-information-circle" class="h-5 w-5 text-blue-600 dark:text-blue-400" />
232:             </div>
233:             <div>
234:               <h3 class="font-medium text-gray-900 dark:text-white">Sobre os Relatorios</h3>
235:               <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
236:                 Os relatorios sao gerados em formato PDF e incluem dados do periodo selecionado.
237:                 Voce pode utiliza-los para apresentacoes, prestacao de contas e acompanhamento pedagogico.
238:               </p>
239:               <ul class="mt-3 space-y-1 text-sm text-gray-500 dark:text-gray-400">
240:                 <li class="flex items-center gap-2">
241:                   <.icon name="hero-check" class="h-4 w-4 text-green-500" />
242:                   Metricas consolidadas da instituicao
243:                 </li>
244:                 <li class="flex items-center gap-2">
245:                   <.icon name="hero-check" class="h-4 w-4 text-green-500" />
246:                   Ranking de performance dos professores
247:                 </li>
248:                 <li class="flex items-center gap-2">
249:                   <.icon name="hero-check" class="h-4 w-4 text-green-500" />
250:                   Cobertura de competencias BNCC
251:                 </li>
252:                 <li class="flex items-center gap-2">
253:                   <.icon name="hero-check" class="h-4 w-4 text-green-500" />
254:                   Resumo de alertas de conformidade
255:                 </li>
256:               </ul>
257:             </div>
258:           </div>
259:         </.card>
260:       <% end %>
261:     </div>
262:     """
263:   end
264: 
265:   # Helpers
266: 
267:   defp months do
268:     [
269:       {"Janeiro", 1},
270:       {"Fevereiro", 2},
271:       {"Marco", 3},
272:       {"Abril", 4},
273:       {"Maio", 5},
274:       {"Junho", 6},
275:       {"Julho", 7},
276:       {"Agosto", 8},
277:       {"Setembro", 9},
278:       {"Outubro", 10},
279:       {"Novembro", 11},
280:       {"Dezembro", 12}
281:     ]
282:   end
283: 
284:   defp years do
285:     current_year = Date.utc_today().year
286:     Enum.to_list((current_year - 2)..current_year)
287:   end
288: 
289:   defp report_title("monthly"), do: "Relatorio Mensal da Instituicao"
290:   defp report_title("teacher"), do: "Relatorio Individual do Professor"
291:   defp report_title(_), do: "Relatorio"
292: 
293:   defp report_description("monthly"),
294:     do: "Estatisticas gerais, ranking de professores e alertas do periodo."
295: 
296:   defp report_description("teacher"),
297:     do: "Performance, historico de scores e competencias BNCC do professor."
298: 
299:   defp report_description(_), do: ""
300: 
301:   defp report_icon("monthly"), do: "hero-chart-bar"
302:   defp report_icon("teacher"), do: "hero-user"
303:   defp report_icon(_), do: "hero-document"
304: 
305:   defp report_icon_bg("monthly"), do: "bg-indigo-600"
306:   defp report_icon_bg("teacher"), do: "bg-green-600"
307:   defp report_icon_bg(_), do: "bg-gray-600"
308: 
309:   defp can_generate?("teacher", assigns) do
310:     assigns.selected_teacher_id != nil && assigns.selected_teacher_id != ""
311:   end
312: 
313:   defp can_generate?(_, _), do: true
314: 
315:   defp download_url("monthly", assigns) do
316:     ~p"/reports/download/monthly?month=#{assigns.selected_month}&year=#{assigns.selected_year}"
317:   end
318: 
319:   defp download_url("teacher", assigns) do
320:     if assigns.selected_teacher_id do
321:       ~p"/reports/download/teacher/#{assigns.selected_teacher_id}?month=#{assigns.selected_month}&year=#{assigns.selected_year}"
322:     else
323:       "#"
324:     end
325:   end
326: 
327:   defp download_url(_, _), do: "#"
328: end
````

## File: lib/hellen_web/plugs/auth.ex
````elixir
 1: defmodule HellenWeb.Plugs.Auth do
 2:   @moduledoc """
 3:   Authentication plugs for the API.
 4: 
 5:   Supports two authentication methods:
 6:   1. Firebase ID Token - For initial login from frontend
 7:   2. Guardian JWT - For subsequent API calls
 8:   """
 9: 
10:   import Plug.Conn
11:   import Phoenix.Controller
12: 
13:   alias Hellen.Auth.Guardian
14: 
15:   @doc """
16:   Plug to require authentication via Guardian JWT.
17:   Expects Authorization header: "Bearer <token>"
18:   """
19:   def require_auth(conn, _opts) do
20:     with token when not is_nil(token) <- get_token_from_header(conn),
21:          {:ok, claims} <- Guardian.decode_and_verify(token),
22:          {:ok, user} <- Guardian.resource_from_claims(claims) do
23:       conn
24:       |> assign(:current_user, user)
25:       |> assign(:claims, claims)
26:     else
27:       nil ->
28:         unauthorized(conn, "Missing authorization header")
29: 
30:       {:error, :user_not_found} ->
31:         unauthorized(conn, "User not found")
32: 
33:       {:error, reason} ->
34:         unauthorized(conn, "Invalid token: #{inspect(reason)}")
35:     end
36:   end
37: 
38:   @doc """
39:   Plug to optionally load user if token is present.
40:   Does not halt if no token is provided.
41:   """
42:   def load_user(conn, _opts) do
43:     with token when not is_nil(token) <- get_token_from_header(conn),
44:          {:ok, claims} <- Guardian.decode_and_verify(token),
45:          {:ok, user} <- Guardian.resource_from_claims(claims) do
46:       conn
47:       |> assign(:current_user, user)
48:       |> assign(:claims, claims)
49:     else
50:       _ -> conn
51:     end
52:   end
53: 
54:   defp get_token_from_header(conn) do
55:     case get_req_header(conn, "authorization") do
56:       ["Bearer " <> token] -> token
57:       _ -> nil
58:     end
59:   end
60: 
61:   defp unauthorized(conn, message) do
62:     conn
63:     |> put_status(:unauthorized)
64:     |> json(%{error: message})
65:     |> halt()
66:   end
67: 
68:   @doc """
69:   Plug to fetch current user from session for browser routes.
70:   Uses the same session token as LiveAuth.
71:   """
72:   def fetch_current_user(conn, _opts) do
73:     token = get_session(conn, "user_token")
74: 
75:     case token do
76:       nil ->
77:         assign(conn, :current_user, nil)
78: 
79:       token ->
80:         case Guardian.resource_from_token(token) do
81:           {:ok, user, _claims} ->
82:             user = Hellen.Accounts.get_user(user.id) || user
83:             assign(conn, :current_user, user)
84: 
85:           {:error, _reason} ->
86:             assign(conn, :current_user, nil)
87:         end
88:     end
89:   end
90: end
````

## File: config/runtime.exs
````elixir
  1: import Config
  2: 
  3: # config/runtime.exs is executed for all environments, including
  4: # during releases. It is executed after compilation and before the
  5: # temporary config.exs is removed.
  6: 
  7: if System.get_env("PHX_SERVER") do
  8:   config :hellen, HellenWeb.Endpoint, server: true
  9: end
 10: 
 11: # Cloudflare R2 - configured for all environments
 12: if r2_access_key = System.get_env("R2_ACCESS_KEY_ID") do
 13:   config :ex_aws,
 14:     access_key_id: r2_access_key,
 15:     secret_access_key: System.get_env("R2_SECRET_ACCESS_KEY"),
 16:     region: "auto"
 17: 
 18:   r2_endpoint = System.get_env("R2_ENDPOINT")
 19: 
 20:   config :ex_aws, :s3,
 21:     scheme: "https://",
 22:     host: r2_endpoint,
 23:     region: "auto"
 24: 
 25:   config :hellen, :r2,
 26:     bucket: System.get_env("R2_BUCKET") || "hellen-r2",
 27:     public_url: System.get_env("R2_PUBLIC_URL"),
 28:     endpoint: r2_endpoint
 29: end
 30: 
 31: # Guardian secret - can be set in dev via .env
 32: if guardian_secret = System.get_env("GUARDIAN_SECRET_KEY") do
 33:   config :hellen, Hellen.Auth.Guardian, secret_key: guardian_secret
 34: end
 35: 
 36: # NVIDIA API - for dev/test with .env (used for LLM analysis)
 37: if nvidia_key = System.get_env("NVIDIA_API_KEY") do
 38:   config :hellen, :nvidia_api_key, nvidia_key
 39: end
 40: 
 41: # Groq API - for dev/test with .env (used for transcription)
 42: if groq_key = System.get_env("GROQ_API_KEY") do
 43:   config :hellen, :groq_api_key, groq_key
 44: end
 45: 
 46: if config_env() == :prod do
 47:   database_url =
 48:     System.get_env("DATABASE_URL") ||
 49:       raise """
 50:       environment variable DATABASE_URL is missing.
 51:       For example: ecto://USER:PASS@HOST/DATABASE
 52:       """
 53: 
 54:   maybe_ipv6 = if System.get_env("ECTO_IPV6") in ~w(true 1), do: [:inet6], else: []
 55: 
 56:   config :hellen, Hellen.Repo,
 57:     url: database_url,
 58:     pool_size: String.to_integer(System.get_env("POOL_SIZE") || "10"),
 59:     socket_options: maybe_ipv6
 60: 
 61:   secret_key_base =
 62:     System.get_env("SECRET_KEY_BASE") ||
 63:       raise """
 64:       environment variable SECRET_KEY_BASE is missing.
 65:       You can generate one by calling: mix phx.gen.secret
 66:       """
 67: 
 68:   host = System.get_env("PHX_HOST") || "example.com"
 69:   port = String.to_integer(System.get_env("PORT") || "4000")
 70: 
 71:   config :hellen, :dns_cluster_query, System.get_env("DNS_CLUSTER_QUERY")
 72: 
 73:   config :hellen, HellenWeb.Endpoint,
 74:     url: [host: host, port: 443, scheme: "https"],
 75:     http: [
 76:       ip: {0, 0, 0, 0, 0, 0, 0, 0},
 77:       port: port
 78:     ],
 79:     secret_key_base: secret_key_base
 80: 
 81:   # Redis
 82:   config :hellen, :redis_url, System.get_env("REDIS_URL") || "redis://localhost:6379"
 83: 
 84:   # Qdrant
 85:   config :hellen, :qdrant_url, System.get_env("QDRANT_URL") || "http://localhost:6333"
 86: 
 87:   # NVIDIA NIM API (required in prod)
 88:   unless System.get_env("NVIDIA_API_KEY") do
 89:     raise "environment variable NVIDIA_API_KEY is missing."
 90:   end
 91: 
 92:   # R2 is configured at the top for all environments
 93: 
 94:   # Email configuration (Mailgun in production)
 95:   if mailgun_api_key = System.get_env("MAILGUN_API_KEY") do
 96:     config :hellen, Hellen.Notifications.Mailer,
 97:       adapter: Swoosh.Adapters.Mailgun,
 98:       api_key: mailgun_api_key,
 99:       domain: System.get_env("MAILGUN_DOMAIN") || "hellen.ai"
100:   end
101: end
````

## File: lib/hellen/lessons.ex
````elixir
  1: defmodule Hellen.Lessons do
  2:   @moduledoc """
  3:   The Lessons context - manages lessons and transcriptions.
  4:   """
  5: 
  6:   import Ecto.Query, warn: false
  7: 
  8:   alias Hellen.Billing
  9:   alias Hellen.Lessons.{Lesson, Transcription}
 10:   alias Hellen.Repo
 11:   alias Hellen.Workers.TranscriptionJob
 12: 
 13:   ## Lesson
 14: 
 15:   def get_lesson!(id), do: Repo.get!(Lesson, id)
 16: 
 17:   @doc """
 18:   Gets a lesson and verifies it belongs to the given institution.
 19:   Raises if not found or institution doesn't match.
 20:   """
 21:   def get_lesson!(id, institution_id) do
 22:     Lesson
 23:     |> where([l], l.id == ^id and l.institution_id == ^institution_id)
 24:     |> Repo.one!()
 25:   end
 26: 
 27:   def get_lesson_with_transcription!(id) do
 28:     Lesson
 29:     |> Repo.get!(id)
 30:     |> Repo.preload(:transcription)
 31:   end
 32: 
 33:   @doc """
 34:   Gets a lesson with transcription, scoped to institution.
 35:   """
 36:   def get_lesson_with_transcription!(id, institution_id) do
 37:     Lesson
 38:     |> where([l], l.id == ^id and l.institution_id == ^institution_id)
 39:     |> Repo.one!()
 40:     |> Repo.preload(:transcription)
 41:   end
 42: 
 43:   def list_lessons_by_user(user_id, opts \\ []) do
 44:     limit = Keyword.get(opts, :limit, 20)
 45:     offset = Keyword.get(opts, :offset, 0)
 46: 
 47:     Lesson
 48:     |> where([l], l.user_id == ^user_id)
 49:     |> order_by([l], desc: l.inserted_at)
 50:     |> limit(^limit)
 51:     |> offset(^offset)
 52:     |> Repo.all()
 53:   end
 54: 
 55:   @doc """
 56:   Counts total lessons for a user.
 57:   """
 58:   def count_lessons_by_user(user_id) do
 59:     Lesson
 60:     |> where([l], l.user_id == ^user_id)
 61:     |> Repo.aggregate(:count)
 62:   end
 63: 
 64:   @doc """
 65:   Lists all lessons for an institution with optional filters.
 66:   """
 67:   def list_lessons_by_institution(institution_id, opts \\ []) do
 68:     limit = Keyword.get(opts, :limit, 50)
 69:     offset = Keyword.get(opts, :offset, 0)
 70:     status = Keyword.get(opts, :status)
 71:     subject = Keyword.get(opts, :subject)
 72:     user_id = Keyword.get(opts, :user_id)
 73: 
 74:     Lesson
 75:     |> where([l], l.institution_id == ^institution_id)
 76:     |> maybe_filter_by_status(status)
 77:     |> maybe_filter_by_subject(subject)
 78:     |> maybe_filter_by_user(user_id)
 79:     |> order_by([l], desc: l.inserted_at)
 80:     |> limit(^limit)
 81:     |> offset(^offset)
 82:     |> Repo.all()
 83:   end
 84: 
 85:   defp maybe_filter_by_status(query, nil), do: query
 86:   defp maybe_filter_by_status(query, status), do: where(query, [l], l.status == ^status)
 87: 
 88:   defp maybe_filter_by_subject(query, nil), do: query
 89:   defp maybe_filter_by_subject(query, subject), do: where(query, [l], l.subject == ^subject)
 90: 
 91:   defp maybe_filter_by_user(query, nil), do: query
 92:   defp maybe_filter_by_user(query, user_id), do: where(query, [l], l.user_id == ^user_id)
 93: 
 94:   def create_lesson(user, attrs \\ %{}) do
 95:     # Check credits first
 96:     case Billing.check_credits(user) do
 97:       :ok ->
 98:         attrs_with_ids =
 99:           attrs
100:           |> Map.put("user_id", user.id)
101:           |> Map.put("institution_id", user.institution_id)
102: 
103:         %Lesson{}
104:         |> Lesson.changeset(attrs_with_ids)
105:         |> Repo.insert()
106: 
107:       {:error, :insufficient_credits} = error ->
108:         error
109:     end
110:   end
111: 
112:   def update_lesson(%Lesson{} = lesson, attrs) do
113:     lesson
114:     |> Lesson.changeset(attrs)
115:     |> Repo.update()
116:   end
117: 
118:   def update_lesson_status(%Lesson{} = lesson, status) do
119:     lesson
120:     |> Lesson.status_changeset(status)
121:     |> Repo.update()
122:   end
123: 
124:   def delete_lesson(%Lesson{} = lesson) do
125:     Repo.delete(lesson)
126:   end
127: 
128:   def start_processing(%Lesson{} = lesson, user) do
129:     # Deduct credit and start processing
130:     with {:ok, _} <- Billing.use_credit(user, lesson.id),
131:          {:ok, lesson} <- update_lesson_status(lesson, "transcribing"),
132:          {:ok, _job} <- enqueue_transcription(lesson) do
133:       {:ok, lesson}
134:     end
135:   end
136: 
137:   defp enqueue_transcription(lesson) do
138:     %{lesson_id: lesson.id}
139:     |> TranscriptionJob.new()
140:     |> Oban.insert()
141:   end
142: 
143:   ## Transcription
144: 
145:   def get_transcription_by_lesson(lesson_id) do
146:     Repo.get_by(Transcription, lesson_id: lesson_id)
147:   end
148: 
149:   def create_transcription(lesson_id, attrs) do
150:     %Transcription{}
151:     |> Transcription.changeset(Map.put(attrs, :lesson_id, lesson_id))
152:     |> Repo.insert()
153:   end
154: 
155:   ## Statistics
156: 
157:   @doc """
158:   Gets lesson statistics for an institution.
159:   """
160:   def get_institution_stats(institution_id) do
161:     total =
162:       Lesson
163:       |> where([l], l.institution_id == ^institution_id)
164:       |> Repo.aggregate(:count)
165: 
166:     by_status =
167:       Lesson
168:       |> where([l], l.institution_id == ^institution_id)
169:       |> group_by([l], l.status)
170:       |> select([l], {l.status, count(l.id)})
171:       |> Repo.all()
172:       |> Map.new()
173: 
174:     by_subject =
175:       Lesson
176:       |> where([l], l.institution_id == ^institution_id and not is_nil(l.subject))
177:       |> group_by([l], l.subject)
178:       |> select([l], {l.subject, count(l.id)})
179:       |> Repo.all()
180:       |> Map.new()
181: 
182:     %{
183:       total: total,
184:       by_status: by_status,
185:       by_subject: by_subject,
186:       pending: Map.get(by_status, "pending", 0),
187:       completed: Map.get(by_status, "completed", 0),
188:       analyzing: Map.get(by_status, "analyzing", 0) + Map.get(by_status, "transcribing", 0)
189:     }
190:   end
191: 
192:   @doc """
193:   Gets distinct subjects used by an institution.
194:   """
195:   def list_subjects(institution_id) do
196:     Lesson
197:     |> where([l], l.institution_id == ^institution_id and not is_nil(l.subject))
198:     |> distinct([l], l.subject)
199:     |> select([l], l.subject)
200:     |> order_by([l], l.subject)
201:     |> Repo.all()
202:   end
203: end
````

## File: lib/hellen_web/controllers/session_controller.ex
````elixir
  1: defmodule HellenWeb.SessionController do
  2:   use HellenWeb, :controller
  3: 
  4:   alias Hellen.Accounts
  5:   alias Hellen.Auth.Firebase
  6:   alias Hellen.Auth.Guardian
  7: 
  8:   require Logger
  9: 
 10:   @doc """
 11:   Handles login form submission.
 12:   Sets the session token and redirects to dashboard.
 13:   """
 14:   def create(conn, %{"email" => email, "password" => password}) do
 15:     case Accounts.authenticate_user(email, password) do
 16:       {:ok, user} ->
 17:         case Guardian.generate_tokens(user) do
 18:           {:ok, %{access_token: token}} ->
 19:             conn
 20:             |> put_session(:user_token, token)
 21:             |> put_flash(:info, "Bem-vindo de volta, #{user.name || user.email}!")
 22:             |> redirect(to: ~p"/dashboard")
 23: 
 24:           {:error, _reason} ->
 25:             conn
 26:             |> put_flash(:error, "Erro ao criar sessão. Tente novamente.")
 27:             |> redirect(to: ~p"/login")
 28:         end
 29: 
 30:       {:error, _reason} ->
 31:         conn
 32:         |> put_flash(:error, "Email ou senha inválidos")
 33:         |> redirect(to: ~p"/login")
 34:     end
 35:   end
 36: 
 37:   @doc """
 38:   Handles registration form submission.
 39:   Creates a new user, sets the session token and redirects to dashboard.
 40:   """
 41:   def register(conn, %{"name" => name, "email" => email, "password" => password}) do
 42:     case Accounts.register_user(%{name: name, email: email, password: password}) do
 43:       {:ok, user} ->
 44:         case Guardian.generate_tokens(user) do
 45:           {:ok, %{access_token: token}} ->
 46:             conn
 47:             |> put_session(:user_token, token)
 48:             |> put_flash(
 49:               :info,
 50:               "Conta criada com sucesso! Bem-vindo, #{user.name || user.email}!"
 51:             )
 52:             |> redirect(to: ~p"/dashboard")
 53: 
 54:           {:error, _reason} ->
 55:             conn
 56:             |> put_flash(:error, "Conta criada, mas houve erro ao iniciar sessão. Faça login.")
 57:             |> redirect(to: ~p"/login")
 58:         end
 59: 
 60:       {:error, changeset} ->
 61:         errors = format_changeset_errors(changeset)
 62: 
 63:         conn
 64:         |> put_flash(:error, "Erro ao criar conta: #{errors}")
 65:         |> redirect(to: ~p"/register")
 66:     end
 67:   end
 68: 
 69:   @doc """
 70:   Handles Firebase login (Google Sign-In).
 71:   Receives Firebase ID token, verifies it, and creates session.
 72:   """
 73:   def firebase_login(conn, %{"id_token" => id_token}) do
 74:     with {:ok, claims} <- Firebase.verify_id_token(id_token),
 75:          user_info <- Firebase.extract_user_info(claims),
 76:          {:ok, user} <- Accounts.find_or_create_from_firebase(user_info),
 77:          {:ok, %{access_token: token}} <- Guardian.generate_tokens(user) do
 78:       Logger.info("Firebase login successful for user: #{user.email}")
 79: 
 80:       conn
 81:       |> put_session(:user_token, token)
 82:       |> put_status(:ok)
 83:       |> json(%{redirect: ~p"/dashboard"})
 84:     else
 85:       {:error, :invalid_token_format} ->
 86:         json_error(conn, "Token invalido")
 87: 
 88:       {:error, :token_expired} ->
 89:         json_error(conn, "Token expirado. Tente novamente.")
 90: 
 91:       {:error, :invalid_signature} ->
 92:         json_error(conn, "Assinatura do token invalida")
 93: 
 94:       {:error, reason} ->
 95:         Logger.warning("Firebase login failed: #{inspect(reason)}")
 96:         json_error(conn, "Erro ao autenticar com Google")
 97:     end
 98:   end
 99: 
100:   def firebase_login(conn, _params) do
101:     json_error(conn, "Token nao fornecido")
102:   end
103: 
104:   defp json_error(conn, message) do
105:     conn
106:     |> put_status(:unauthorized)
107:     |> json(%{error: message})
108:   end
109: 
110:   @doc """
111:   Logs the user out by clearing the session.
112:   """
113:   def logout(conn, _params) do
114:     conn
115:     |> clear_session()
116:     |> put_flash(:info, "Logout realizado com sucesso")
117:     |> redirect(to: ~p"/login")
118:   end
119: 
120:   defp format_changeset_errors(changeset) do
121:     Ecto.Changeset.traverse_errors(changeset, fn {msg, opts} ->
122:       Enum.reduce(opts, msg, fn {key, value}, acc ->
123:         String.replace(acc, "%{#{key}}", to_string(value))
124:       end)
125:     end)
126:     |> Enum.map_join("; ", fn {field, errors} -> "#{field}: #{Enum.join(errors, ", ")}" end)
127:   end
128: end
````

## File: lib/hellen_web/live/lessons_live/index.ex
````elixir
  1: defmodule HellenWeb.LessonsLive.Index do
  2:   @moduledoc """
  3:   Lessons list LiveView with filters.
  4:   Allows filtering by status, subject, and search.
  5:   """
  6:   use HellenWeb, :live_view
  7: 
  8:   alias Hellen.Lessons
  9: 
 10:   @statuses [
 11:     {"all", "Todos"},
 12:     {"pending", "Pendentes"},
 13:     {"transcribing", "Transcrevendo"},
 14:     {"analyzing", "Analisando"},
 15:     {"completed", "Concluidas"},
 16:     {"failed", "Com Erro"}
 17:   ]
 18: 
 19:   @impl true
 20:   def mount(_params, _session, socket) do
 21:     user = socket.assigns.current_user
 22: 
 23:     {:ok,
 24:      socket
 25:      |> assign(page_title: "Minhas Aulas")
 26:      |> assign(statuses: @statuses)
 27:      |> assign(filters: %{status: "all", subject: "all", search: ""})
 28:      |> assign(subjects: [])
 29:      |> assign(lessons_count: nil)
 30:      |> stream(:lessons, [])
 31:      |> load_subjects_async(user)
 32:      |> load_lessons_async(user)}
 33:   end
 34: 
 35:   defp load_subjects_async(socket, user) do
 36:     if connected?(socket) and user.institution_id do
 37:       start_async(socket, :load_subjects, fn ->
 38:         Lessons.list_subjects(user.institution_id)
 39:       end)
 40:     else
 41:       socket
 42:     end
 43:   end
 44: 
 45:   defp load_lessons_async(socket, user, filters \\ %{}) do
 46:     if connected?(socket) do
 47:       start_async(socket, :load_lessons, fn ->
 48:         opts = build_filter_opts(filters, user)
 49:         Lessons.list_lessons_by_user(user.id, opts)
 50:       end)
 51:     else
 52:       socket
 53:     end
 54:   end
 55: 
 56:   defp build_filter_opts(filters, _user) do
 57:     opts = [limit: 100]
 58: 
 59:     opts =
 60:       case filters[:status] do
 61:         nil -> opts
 62:         "all" -> opts
 63:         status -> Keyword.put(opts, :status, status)
 64:       end
 65: 
 66:     case filters[:subject] do
 67:       nil -> opts
 68:       "all" -> opts
 69:       subject -> Keyword.put(opts, :subject, subject)
 70:     end
 71:   end
 72: 
 73:   @impl true
 74:   def handle_async(:load_lessons, {:ok, lessons}, socket) do
 75:     # Apply client-side search filter
 76:     search = socket.assigns.filters[:search] || ""
 77: 
 78:     filtered =
 79:       if search != "" do
 80:         search_lower = String.downcase(search)
 81: 
 82:         Enum.filter(lessons, fn l ->
 83:           String.contains?(String.downcase(l.title || ""), search_lower) or
 84:             String.contains?(String.downcase(l.subject || ""), search_lower)
 85:         end)
 86:       else
 87:         lessons
 88:       end
 89: 
 90:     {:noreply,
 91:      socket
 92:      |> assign(:lessons_count, length(filtered))
 93:      |> stream(:lessons, filtered, reset: true)}
 94:   end
 95: 
 96:   def handle_async(:load_lessons, {:exit, _reason}, socket) do
 97:     {:noreply, put_flash(socket, :error, "Erro ao carregar aulas")}
 98:   end
 99: 
100:   def handle_async(:load_subjects, {:ok, subjects}, socket) do
101:     {:noreply, assign(socket, :subjects, subjects)}
102:   end
103: 
104:   def handle_async(:load_subjects, {:exit, _reason}, socket) do
105:     {:noreply, socket}
106:   end
107: 
108:   # PWA OfflineIndicator hook events - ignore silently
109:   @impl true
110:   def handle_event("online", _params, socket), do: {:noreply, socket}
111:   def handle_event("offline", _params, socket), do: {:noreply, socket}
112: 
113:   @impl true
114:   def handle_event("filter", %{"status" => status}, socket) do
115:     user = socket.assigns.current_user
116:     filters = Map.put(socket.assigns.filters, :status, status)
117: 
118:     {:noreply,
119:      socket
120:      |> assign(filters: filters)
121:      |> load_lessons_async(user, filters)}
122:   end
123: 
124:   def handle_event("filter_subject", %{"subject" => subject}, socket) do
125:     user = socket.assigns.current_user
126:     filters = Map.put(socket.assigns.filters, :subject, subject)
127: 
128:     {:noreply,
129:      socket
130:      |> assign(filters: filters)
131:      |> load_lessons_async(user, filters)}
132:   end
133: 
134:   def handle_event("search", %{"search" => search}, socket) do
135:     user = socket.assigns.current_user
136:     filters = Map.put(socket.assigns.filters, :search, search)
137: 
138:     {:noreply,
139:      socket
140:      |> assign(filters: filters)
141:      |> load_lessons_async(user, filters)}
142:   end
143: 
144:   @impl true
145:   def render(assigns) do
146:     ~H"""
147:     <div class="space-y-6 animate-fade-in">
148:       <!-- Page Header -->
149:       <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
150:         <div>
151:           <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-white tracking-tight">
152:             Minhas Aulas
153:           </h1>
154:           <p class="mt-1 text-slate-500 dark:text-slate-400">
155:             Todas as suas aulas e analises pedagogicas
156:           </p>
157:         </div>
158:         <.link navigate={~p"/lessons/new"}>
159:           <.button icon="hero-plus">
160:             Nova Aula
161:           </.button>
162:         </.link>
163:       </div>
164:       <!-- Stats Summary -->
165:       <div
166:         :if={@lessons_count}
167:         class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400"
168:       >
169:         <.icon name="hero-document-text" class="h-4 w-4" />
170:         <span>
171:           <%= @lessons_count %> aula<%= if @lessons_count != 1, do: "s" %> encontrada<%= if @lessons_count !=
172:                                                                                               1,
173:                                                                                             do: "s" %>
174:         </span>
175:       </div>
176:       <!-- Filters Card -->
177:       <div class="bg-white dark:bg-slate-800 rounded-xl shadow-card border border-slate-200/50 dark:border-slate-700/50 p-5">
178:         <div class="flex flex-wrap gap-4 items-center">
179:           <!-- Search -->
180:           <div class="flex-1 min-w-[200px]">
181:             <form phx-change="search" phx-submit="search">
182:               <div class="relative">
183:                 <.icon
184:                   name="hero-magnifying-glass"
185:                   class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400"
186:                 />
187:                 <input
188:                   type="text"
189:                   name="search"
190:                   value={@filters[:search]}
191:                   placeholder="Buscar por titulo ou disciplina..."
192:                   phx-debounce="300"
193:                   class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700/50 text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-slate-500 focus:ring-2 focus:ring-teal-500/20 focus:border-teal-500 transition-all duration-200"
194:                 />
195:               </div>
196:             </form>
197:           </div>
198:           <!-- Status Filter -->
199:           <div class="flex items-center gap-3">
200:             <span class="text-sm font-medium text-slate-500 dark:text-slate-400">Status:</span>
201:             <div class="flex gap-1.5 flex-wrap">
202:               <button
203:                 :for={{value, label} <- @statuses}
204:                 type="button"
205:                 phx-click="filter"
206:                 phx-value-status={value}
207:                 class={[
208:                   "px-3 py-1.5 text-sm rounded-lg transition-all duration-200",
209:                   @filters[:status] == value &&
210:                     "bg-teal-500 text-white shadow-sm",
211:                   @filters[:status] != value &&
212:                     "bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600"
213:                 ]}
214:               >
215:                 <%= label %>
216:               </button>
217:             </div>
218:           </div>
219:           <!-- Subject Filter (if subjects exist) -->
220:           <div :if={@subjects != []} class="flex items-center gap-3">
221:             <span class="text-sm font-medium text-slate-500 dark:text-slate-400">Disciplina:</span>
222:             <select
223:               phx-change="filter_subject"
224:               name="subject"
225:               class="rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700/50 text-slate-900 dark:text-white text-sm py-2 px-3 focus:ring-2 focus:ring-teal-500/20 focus:border-teal-500 transition-all duration-200"
226:             >
227:               <option value="all" selected={@filters[:subject] == "all"}>Todas</option>
228:               <option
229:                 :for={subject <- @subjects}
230:                 value={subject}
231:                 selected={@filters[:subject] == subject}
232:               >
233:                 <%= subject %>
234:               </option>
235:             </select>
236:           </div>
237:         </div>
238:       </div>
239:       <!-- Lessons Grid -->
240:       <div id="lessons-container" phx-update="stream" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
241:         <div :for={{dom_id, lesson} <- @streams.lessons} id={dom_id} class="animate-fade-in-up">
242:           <.lesson_card lesson={lesson} />
243:         </div>
244:       </div>
245:       <!-- Empty State -->
246:       <.empty_state
247:         :if={@lessons_count == 0}
248:         icon="hero-document-text"
249:         title="Nenhuma aula encontrada"
250:         description={empty_state_description(@filters)}
251:       >
252:         <.link navigate={~p"/lessons/new"}>
253:           <.button icon="hero-plus">
254:             Nova Aula
255:           </.button>
256:         </.link>
257:       </.empty_state>
258:     </div>
259:     """
260:   end
261: 
262:   defp empty_state_description(filters) do
263:     if filters[:search] != "" or filters[:status] != "all" do
264:       "Tente ajustar os filtros ou buscar por outro termo."
265:     else
266:       "Comece enviando sua primeira aula para analise pedagogica com IA."
267:     end
268:   end
269: end
````

## File: lib/hellen_web/live/settings_live/index.ex
````elixir
  1: defmodule HellenWeb.SettingsLive.Index do
  2:   @moduledoc """
  3:   Settings LiveView - Profile, notification preferences, and security settings.
  4:   """
  5:   use HellenWeb, :live_view
  6: 
  7:   alias Hellen.Accounts
  8:   alias Hellen.Accounts.User
  9:   alias Hellen.Notifications
 10: 
 11:   @impl true
 12:   def mount(_params, _session, socket) do
 13:     user = socket.assigns.current_user
 14:     {:ok, preferences} = Notifications.get_or_create_preferences(user.id)
 15: 
 16:     {:ok,
 17:      socket
 18:      |> assign(page_title: "Configuracoes")
 19:      |> assign(active_tab: "profile")
 20:      |> assign(preferences: preferences)
 21:      |> assign_profile_form(user)
 22:      |> assign_password_form()
 23:      |> assign_preferences_form(preferences)}
 24:   end
 25: 
 26:   defp assign_profile_form(socket, user) do
 27:     changeset = User.profile_changeset(user, %{})
 28:     assign(socket, profile_form: to_form(changeset))
 29:   end
 30: 
 31:   defp assign_password_form(socket) do
 32:     assign(socket,
 33:       password_form:
 34:         to_form(%{"current_password" => "", "new_password" => "", "confirm_password" => ""})
 35:     )
 36:   end
 37: 
 38:   defp assign_preferences_form(socket, preferences) do
 39:     changeset = Notifications.Preference.changeset(preferences, %{})
 40:     assign(socket, preferences_form: to_form(changeset))
 41:   end
 42: 
 43:   # PWA OfflineIndicator hook events - ignore silently
 44:   @impl true
 45:   def handle_event("online", _params, socket), do: {:noreply, socket}
 46:   def handle_event("offline", _params, socket), do: {:noreply, socket}
 47: 
 48:   @impl true
 49:   def handle_event("change_tab", %{"tab" => tab}, socket) do
 50:     {:noreply, assign(socket, active_tab: tab)}
 51:   end
 52: 
 53:   def handle_event("validate_profile", %{"user" => params}, socket) do
 54:     changeset =
 55:       socket.assigns.current_user
 56:       |> User.profile_changeset(params)
 57:       |> Map.put(:action, :validate)
 58: 
 59:     {:noreply, assign(socket, profile_form: to_form(changeset))}
 60:   end
 61: 
 62:   def handle_event("save_profile", %{"user" => params}, socket) do
 63:     case Accounts.update_user_profile(socket.assigns.current_user, params) do
 64:       {:ok, user} ->
 65:         {:noreply,
 66:          socket
 67:          |> assign(current_user: user)
 68:          |> assign_profile_form(user)
 69:          |> put_flash(:info, "Perfil atualizado com sucesso!")}
 70: 
 71:       {:error, changeset} ->
 72:         {:noreply, assign(socket, profile_form: to_form(changeset))}
 73:     end
 74:   end
 75: 
 76:   def handle_event("save_password", params, socket) do
 77:     %{
 78:       "current_password" => current,
 79:       "new_password" => new_password,
 80:       "confirm_password" => confirm
 81:     } = params
 82: 
 83:     cond do
 84:       new_password != confirm ->
 85:         {:noreply, put_flash(socket, :error, "As senhas nao coincidem")}
 86: 
 87:       String.length(new_password) < 8 ->
 88:         {:noreply, put_flash(socket, :error, "A nova senha deve ter pelo menos 8 caracteres")}
 89: 
 90:       true ->
 91:         case Accounts.change_user_password(socket.assigns.current_user, current, new_password) do
 92:           {:ok, _user} ->
 93:             {:noreply,
 94:              socket
 95:              |> assign_password_form()
 96:              |> put_flash(:info, "Senha alterada com sucesso!")}
 97: 
 98:           {:error, :invalid_password} ->
 99:             {:noreply, put_flash(socket, :error, "Senha atual incorreta")}
100: 
101:           {:error, _changeset} ->
102:             {:noreply, put_flash(socket, :error, "Erro ao alterar senha")}
103:         end
104:     end
105:   end
106: 
107:   def handle_event("save_preferences", %{"preference" => params}, socket) do
108:     case Notifications.update_preferences(socket.assigns.current_user.id, params) do
109:       {:ok, preferences} ->
110:         {:noreply,
111:          socket
112:          |> assign(preferences: preferences)
113:          |> assign_preferences_form(preferences)
114:          |> put_flash(:info, "Preferencias atualizadas!")}
115: 
116:       {:error, changeset} ->
117:         {:noreply, assign(socket, preferences_form: to_form(changeset))}
118:     end
119:   end
120: 
121:   @impl true
122:   def render(assigns) do
123:     ~H"""
124:     <div class="max-w-4xl mx-auto space-y-6 animate-fade-in">
125:       <!-- Header -->
126:       <div class="flex items-start gap-4">
127:         <div class="flex-shrink-0 w-12 h-12 rounded-xl bg-teal-500/10 dark:bg-teal-500/20 flex items-center justify-center">
128:           <.icon name="hero-cog-6-tooth" class="h-6 w-6 text-teal-600 dark:text-teal-400" />
129:         </div>
130:         <div>
131:           <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-white tracking-tight">
132:             Configuracoes
133:           </h1>
134:           <p class="mt-1 text-slate-500 dark:text-slate-400">
135:             Gerencie seu perfil, preferencias e seguranca
136:           </p>
137:         </div>
138:       </div>
139:       <!-- Tabs -->
140:       <div class="bg-white dark:bg-slate-800 rounded-xl shadow-card border border-slate-200/50 dark:border-slate-700/50 p-1.5">
141:         <nav class="flex gap-1">
142:           <.tab_button active={@active_tab == "profile"} tab="profile" icon="hero-user">
143:             Perfil
144:           </.tab_button>
145:           <.tab_button active={@active_tab == "notifications"} tab="notifications" icon="hero-bell">
146:             Notificacoes
147:           </.tab_button>
148:           <.tab_button active={@active_tab == "security"} tab="security" icon="hero-shield-check">
149:             Seguranca
150:           </.tab_button>
151:         </nav>
152:       </div>
153:       <!-- Tab Content -->
154:       <div class="bg-white dark:bg-slate-800 rounded-xl shadow-card border border-slate-200/50 dark:border-slate-700/50 p-6 animate-fade-in-up">
155:         <!-- Profile Tab -->
156:         <div :if={@active_tab == "profile"} class="space-y-6">
157:           <div class="flex items-center gap-5 pb-6 border-b border-slate-200 dark:border-slate-700">
158:             <div class="relative group">
159:               <div class="h-20 w-20 rounded-2xl bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center text-white text-2xl font-bold shadow-lg group-hover:shadow-teal-500/25 transition-all duration-300">
160:                 <%= String.first(@current_user.name || "U") |> String.upcase() %>
161:               </div>
162:               <div class="absolute -bottom-1 -right-1 w-6 h-6 rounded-lg bg-emerald-500 flex items-center justify-center">
163:                 <.icon name="hero-check-mini" class="h-4 w-4 text-white" />
164:               </div>
165:             </div>
166:             <div>
167:               <h3 class="text-xl font-bold text-slate-900 dark:text-white">
168:                 <%= @current_user.name %>
169:               </h3>
170:               <p class="text-sm text-slate-500 dark:text-slate-400 mb-2">
171:                 <%= @current_user.email %>
172:               </p>
173:               <div class="flex items-center gap-2">
174:                 <.badge variant={role_variant(@current_user.role)}>
175:                   <%= role_label(@current_user.role) %>
176:                 </.badge>
177:                 <.badge variant="default"><%= plan_label(@current_user.plan) %></.badge>
178:               </div>
179:             </div>
180:           </div>
181: 
182:           <.form
183:             for={@profile_form}
184:             phx-change="validate_profile"
185:             phx-submit="save_profile"
186:             class="space-y-5"
187:           >
188:             <div class="grid sm:grid-cols-2 gap-4">
189:               <.input field={@profile_form[:name]} type="text" label="Nome" required />
190:               <.input field={@profile_form[:email]} type="email" label="Email" required />
191:             </div>
192: 
193:             <div class="pt-4 flex justify-end">
194:               <.button type="submit" icon="hero-check" phx-disable-with="Salvando...">
195:                 Salvar Alteracoes
196:               </.button>
197:             </div>
198:           </.form>
199:         </div>
200:         <!-- Notifications Tab -->
201:         <div :if={@active_tab == "notifications"} class="space-y-6">
202:           <div class="flex items-center gap-3 pb-4 border-b border-slate-200 dark:border-slate-700">
203:             <div class="w-10 h-10 rounded-xl bg-violet-100 dark:bg-violet-900/30 flex items-center justify-center">
204:               <.icon name="hero-envelope" class="h-5 w-5 text-violet-600 dark:text-violet-400" />
205:             </div>
206:             <div>
207:               <h3 class="text-lg font-semibold text-slate-900 dark:text-white">
208:                 Preferencias de Email
209:               </h3>
210:               <p class="text-sm text-slate-500 dark:text-slate-400">
211:                 Escolha quais notificacoes deseja receber por email
212:               </p>
213:             </div>
214:           </div>
215: 
216:           <.form for={@preferences_form} phx-submit="save_preferences" class="space-y-2">
217:             <.preference_toggle
218:               field={@preferences_form[:email_critical_alerts]}
219:               label="Alertas Criticos"
220:               description="Receba emails imediatos para alertas de alta severidade"
221:               color="red"
222:             />
223:             <.preference_toggle
224:               field={@preferences_form[:email_high_alerts]}
225:               label="Alertas de Alta Severidade"
226:               description="Notificacoes de alertas importantes"
227:               color="amber"
228:             />
229:             <.preference_toggle
230:               field={@preferences_form[:email_analysis_complete]}
231:               label="Analise Concluida"
232:               description="Receba um email quando sua aula for analisada"
233:               color="emerald"
234:             />
235:             <.preference_toggle
236:               field={@preferences_form[:email_weekly_summary]}
237:               label="Resumo Semanal"
238:               description="Receba um resumo semanal das suas aulas"
239:               color="teal"
240:             />
241: 
242:             <div class="!mt-8 pt-6 border-t border-slate-200 dark:border-slate-700">
243:               <div class="flex items-center gap-3 mb-4">
244:                 <div class="w-10 h-10 rounded-xl bg-cyan-100 dark:bg-cyan-900/30 flex items-center justify-center">
245:                   <.icon name="hero-bell-alert" class="h-5 w-5 text-cyan-600 dark:text-cyan-400" />
246:                 </div>
247:                 <h3 class="text-lg font-semibold text-slate-900 dark:text-white">
248:                   Notificacoes In-App
249:                 </h3>
250:               </div>
251:               <.preference_toggle
252:                 field={@preferences_form[:inapp_all_alerts]}
253:                 label="Todos os Alertas"
254:                 description="Mostrar notificacoes de alertas na interface"
255:                 color="violet"
256:               />
257:               <.preference_toggle
258:                 field={@preferences_form[:inapp_analysis_complete]}
259:                 label="Analise Concluida"
260:                 description="Notificar quando uma analise terminar"
261:                 color="teal"
262:               />
263:             </div>
264: 
265:             <div class="!mt-6 pt-4 flex justify-end">
266:               <.button type="submit" icon="hero-check" phx-disable-with="Salvando...">
267:                 Salvar Preferencias
268:               </.button>
269:             </div>
270:           </.form>
271:         </div>
272:         <!-- Security Tab -->
273:         <div :if={@active_tab == "security"} class="space-y-6">
274:           <div class="flex items-center gap-3 pb-4 border-b border-slate-200 dark:border-slate-700">
275:             <div class="w-10 h-10 rounded-xl bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center">
276:               <.icon name="hero-key" class="h-5 w-5 text-amber-600 dark:text-amber-400" />
277:             </div>
278:             <div>
279:               <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Alterar Senha</h3>
280:               <p class="text-sm text-slate-500 dark:text-slate-400">
281:                 Atualize sua senha regularmente para manter sua conta segura
282:               </p>
283:             </div>
284:           </div>
285: 
286:           <form phx-submit="save_password" class="space-y-5">
287:             <div>
288:               <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
289:                 Senha Atual
290:               </label>
291:               <input
292:                 type="password"
293:                 name="current_password"
294:                 required
295:                 class="w-full rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700/50 text-slate-900 dark:text-white px-4 py-3 focus:ring-2 focus:ring-teal-500/20 focus:border-teal-500 transition-all duration-200"
296:               />
297:             </div>
298: 
299:             <div class="grid sm:grid-cols-2 gap-4">
300:               <div>
301:                 <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
302:                   Nova Senha
303:                 </label>
304:                 <input
305:                   type="password"
306:                   name="new_password"
307:                   required
308:                   minlength="8"
309:                   class="w-full rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700/50 text-slate-900 dark:text-white px-4 py-3 focus:ring-2 focus:ring-teal-500/20 focus:border-teal-500 transition-all duration-200"
310:                 />
311:                 <p class="mt-2 text-xs text-slate-500 dark:text-slate-400 flex items-center gap-1">
312:                   <.icon name="hero-information-circle-mini" class="h-4 w-4" /> Minimo de 8 caracteres
313:                 </p>
314:               </div>
315: 
316:               <div>
317:                 <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
318:                   Confirmar Nova Senha
319:                 </label>
320:                 <input
321:                   type="password"
322:                   name="confirm_password"
323:                   required
324:                   class="w-full rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700/50 text-slate-900 dark:text-white px-4 py-3 focus:ring-2 focus:ring-teal-500/20 focus:border-teal-500 transition-all duration-200"
325:                 />
326:               </div>
327:             </div>
328: 
329:             <div class="pt-4 flex justify-end">
330:               <.button type="submit" icon="hero-lock-closed" phx-disable-with="Alterando...">
331:                 Alterar Senha
332:               </.button>
333:             </div>
334:           </form>
335:           <!-- Security Info -->
336:           <div class="mt-8 p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600">
337:             <div class="flex items-start gap-3">
338:               <div class="flex-shrink-0 w-8 h-8 rounded-lg bg-teal-100 dark:bg-teal-900/30 flex items-center justify-center">
339:                 <.icon name="hero-shield-check" class="h-4 w-4 text-teal-600 dark:text-teal-400" />
340:               </div>
341:               <div>
342:                 <h4 class="text-sm font-semibold text-slate-900 dark:text-white">
343:                   Dicas de Seguranca
344:                 </h4>
345:                 <ul class="mt-2 text-xs text-slate-500 dark:text-slate-400 space-y-1">
346:                   <li class="flex items-center gap-1.5">
347:                     <.icon name="hero-check-mini" class="h-3 w-3 text-emerald-500" />
348:                     Use uma combinacao de letras, numeros e simbolos
349:                   </li>
350:                   <li class="flex items-center gap-1.5">
351:                     <.icon name="hero-check-mini" class="h-3 w-3 text-emerald-500" />
352:                     Evite informacoes pessoais faceis de adivinhar
353:                   </li>
354:                   <li class="flex items-center gap-1.5">
355:                     <.icon name="hero-check-mini" class="h-3 w-3 text-emerald-500" />
356:                     Nao reutilize senhas de outros sites
357:                   </li>
358:                 </ul>
359:               </div>
360:             </div>
361:           </div>
362:         </div>
363:       </div>
364:     </div>
365:     """
366:   end
367: 
368:   # Component helpers
369: 
370:   attr :active, :boolean, required: true
371:   attr :tab, :string, required: true
372:   attr :icon, :string, required: true
373:   slot :inner_block, required: true
374: 
375:   defp tab_button(assigns) do
376:     ~H"""
377:     <button
378:       type="button"
379:       phx-click="change_tab"
380:       phx-value-tab={@tab}
381:       class={[
382:         "flex-1 flex items-center justify-center gap-2 py-3 px-4 rounded-lg font-medium text-sm transition-all duration-200",
383:         if(@active,
384:           do: "bg-teal-500 text-white shadow-sm",
385:           else: "text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700"
386:         )
387:       ]}
388:     >
389:       <.icon name={@icon} class="h-5 w-5" />
390:       <span class="hidden sm:inline"><%= render_slot(@inner_block) %></span>
391:     </button>
392:     """
393:   end
394: 
395:   attr :field, Phoenix.HTML.FormField, required: true
396:   attr :label, :string, required: true
397:   attr :description, :string, required: true
398:   attr :color, :string, default: "teal"
399: 
400:   defp preference_toggle(assigns) do
401:     ~H"""
402:     <div class="flex items-center justify-between py-4 px-4 -mx-4 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors group">
403:       <div class="flex items-center gap-3">
404:         <div class={["w-2 h-2 rounded-full", toggle_dot_color(@color)]}></div>
405:         <div>
406:           <label class="font-medium text-slate-900 dark:text-white cursor-pointer">
407:             <%= @label %>
408:           </label>
409:           <p class="text-sm text-slate-500 dark:text-slate-400"><%= @description %></p>
410:         </div>
411:       </div>
412:       <label class="relative inline-flex items-center cursor-pointer flex-shrink-0">
413:         <input
414:           type="checkbox"
415:           name={@field.name}
416:           value="true"
417:           checked={Phoenix.HTML.Form.normalize_value("checkbox", @field.value)}
418:           class="sr-only peer"
419:         />
420:         <input type="hidden" name={@field.name} value="false" />
421:         <div class={[
422:           "w-12 h-7 rounded-full peer transition-colors duration-200",
423:           "bg-slate-200 dark:bg-slate-600",
424:           "peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-teal-500/20",
425:           "peer-checked:after:translate-x-5 peer-checked:after:border-white",
426:           "after:content-[''] after:absolute after:top-[2px] after:left-[2px]",
427:           "after:bg-white after:rounded-full after:h-6 after:w-6 after:shadow-sm",
428:           "after:transition-all after:duration-200",
429:           toggle_checked_color(@color)
430:         ]}>
431:         </div>
432:       </label>
433:     </div>
434:     """
435:   end
436: 
437:   defp toggle_dot_color("red"), do: "bg-red-500"
438:   defp toggle_dot_color("amber"), do: "bg-amber-500"
439:   defp toggle_dot_color("emerald"), do: "bg-emerald-500"
440:   defp toggle_dot_color("violet"), do: "bg-violet-500"
441:   defp toggle_dot_color("cyan"), do: "bg-cyan-500"
442:   defp toggle_dot_color(_), do: "bg-teal-500"
443: 
444:   defp toggle_checked_color("red"), do: "peer-checked:bg-red-500"
445:   defp toggle_checked_color("amber"), do: "peer-checked:bg-amber-500"
446:   defp toggle_checked_color("emerald"), do: "peer-checked:bg-emerald-500"
447:   defp toggle_checked_color("violet"), do: "peer-checked:bg-violet-500"
448:   defp toggle_checked_color("cyan"), do: "peer-checked:bg-cyan-500"
449:   defp toggle_checked_color(_), do: "peer-checked:bg-teal-500"
450: 
451:   defp role_label("teacher"), do: "Professor"
452:   defp role_label("coordinator"), do: "Coordenador"
453:   defp role_label("admin"), do: "Administrador"
454:   defp role_label(_), do: "Usuario"
455: 
456:   defp role_variant("coordinator"), do: "warning"
457:   defp role_variant("admin"), do: "error"
458:   defp role_variant(_), do: "default"
459: 
460:   defp plan_label("free"), do: "Plano Free"
461:   defp plan_label("pro"), do: "Plano Pro"
462:   defp plan_label("enterprise"), do: "Enterprise"
463:   defp plan_label(_), do: "Plano"
464: end
````

## File: assets/js/hooks/charts.js
````javascript
  1: // ApexCharts Hooks for LiveView
  2: // 2025 Color Palette: teal, sage, mint, ochre, violet, cyan
  3: 
  4: // Color palette constants
  5: const COLORS = {
  6:   teal: '#0d9488',      // teal-600
  7:   tealLight: '#14b8a6', // teal-500
  8:   sage: '#87a878',      // sage-500
  9:   sageLight: '#a8c99b', // sage-light
 10:   mint: '#98d4bb',      // mint-300
 11:   ochre: '#d4a574',     // ochre-400
 12:   violet: '#7c3aed',    // violet-600
 13:   cyan: '#06b6d4',      // cyan-500
 14:   emerald: '#10b981',   // emerald-500
 15:   amber: '#f59e0b',     // amber-500
 16:   red: '#ef4444',       // red-500
 17:   slate: '#64748b'      // slate-500
 18: }
 19: 
 20: // Chart palette for multiple series
 21: const CHART_PALETTE = [COLORS.teal, COLORS.sage, COLORS.violet, COLORS.ochre, COLORS.cyan, COLORS.mint]
 22: 
 23: export const ScoreChart = {
 24:   mounted() {
 25:     this.chart = null
 26:     this.renderChart()
 27:   },
 28: 
 29:   updated() {
 30:     this.renderChart()
 31:   },
 32: 
 33:   destroyed() {
 34:     if (this.chart) {
 35:       this.chart.destroy()
 36:     }
 37:   },
 38: 
 39:   renderChart() {
 40:     const data = JSON.parse(this.el.dataset.chartData || '[]')
 41:     const average = parseFloat(this.el.dataset.average || '0')
 42: 
 43:     if (data.length === 0) {
 44:       this.el.innerHTML = '<p class="text-slate-500 dark:text-slate-400 text-center py-8">Sem dados suficientes para exibir o grafico</p>'
 45:       return
 46:     }
 47: 
 48:     const isDark = document.documentElement.classList.contains('dark')
 49: 
 50:     const options = {
 51:       series: [{
 52:         name: 'Pontuacao',
 53:         data: data.map(d => ({
 54:           x: new Date(d.date).getTime(),
 55:           y: Math.round(d.score * 100)
 56:         }))
 57:       }],
 58:       chart: {
 59:         type: 'area',
 60:         height: 280,
 61:         fontFamily: 'Inter var, Inter, system-ui, sans-serif',
 62:         toolbar: { show: false },
 63:         zoom: { enabled: false },
 64:         background: 'transparent',
 65:         animations: {
 66:           enabled: true,
 67:           easing: 'easeinout',
 68:           speed: 800
 69:         }
 70:       },
 71:       colors: [COLORS.teal],
 72:       fill: {
 73:         type: 'gradient',
 74:         gradient: {
 75:           shadeIntensity: 1,
 76:           opacityFrom: 0.5,
 77:           opacityTo: 0.05,
 78:           stops: [0, 90, 100],
 79:           colorStops: [
 80:             {
 81:               offset: 0,
 82:               color: COLORS.teal,
 83:               opacity: 0.4
 84:             },
 85:             {
 86:               offset: 100,
 87:               color: COLORS.mint,
 88:               opacity: 0.05
 89:             }
 90:           ]
 91:         }
 92:       },
 93:       stroke: {
 94:         curve: 'smooth',
 95:         width: 3
 96:       },
 97:       dataLabels: { enabled: false },
 98:       xaxis: {
 99:         type: 'datetime',
100:         labels: {
101:           style: {
102:             colors: isDark ? '#94a3b8' : '#64748b',
103:             fontSize: '12px',
104:             fontFamily: 'Inter var, Inter, system-ui, sans-serif'
105:           },
106:           datetimeFormatter: {
107:             day: 'dd/MM'
108:           }
109:         },
110:         axisBorder: { show: false },
111:         axisTicks: { show: false }
112:       },
113:       yaxis: {
114:         min: 0,
115:         max: 100,
116:         labels: {
117:           style: {
118:             colors: isDark ? '#94a3b8' : '#64748b',
119:             fontSize: '12px',
120:             fontFamily: 'Inter var, Inter, system-ui, sans-serif'
121:           },
122:           formatter: (val) => `${val}%`
123:         }
124:       },
125:       grid: {
126:         borderColor: isDark ? '#334155' : '#e2e8f0',
127:         strokeDashArray: 4,
128:         padding: {
129:           left: 10,
130:           right: 10
131:         }
132:       },
133:       tooltip: {
134:         theme: isDark ? 'dark' : 'light',
135:         x: { format: 'dd/MM/yyyy' },
136:         y: {
137:           formatter: (val) => `${val}%`
138:         },
139:         style: {
140:           fontFamily: 'Inter var, Inter, system-ui, sans-serif'
141:         }
142:       },
143:       annotations: average > 0 ? {
144:         yaxis: [{
145:           y: Math.round(average * 100),
146:           borderColor: COLORS.ochre,
147:           borderWidth: 2,
148:           strokeDashArray: 5,
149:           label: {
150:             borderColor: COLORS.ochre,
151:             style: {
152:               color: '#fff',
153:               background: COLORS.ochre,
154:               fontFamily: 'Inter var, Inter, system-ui, sans-serif'
155:             },
156:             text: `Media da disciplina: ${Math.round(average * 100)}%`
157:           }
158:         }]
159:       } : {}
160:     }
161: 
162:     if (this.chart) {
163:       this.chart.updateOptions(options)
164:     } else {
165:       this.chart = new ApexCharts(this.el, options)
166:       this.chart.render()
167:     }
168:   }
169: }
170: 
171: export const BnccHeatmap = {
172:   mounted() {
173:     this.chart = null
174:     this.renderChart()
175:   },
176: 
177:   updated() {
178:     this.renderChart()
179:   },
180: 
181:   destroyed() {
182:     if (this.chart) {
183:       this.chart.destroy()
184:     }
185:   },
186: 
187:   renderChart() {
188:     const data = JSON.parse(this.el.dataset.chartData || '[]')
189: 
190:     if (data.length === 0) {
191:       this.el.innerHTML = '<p class="text-slate-500 dark:text-slate-400 text-center py-8">Nenhuma competencia BNCC registrada ainda</p>'
192:       return
193:     }
194: 
195:     const isDark = document.documentElement.classList.contains('dark')
196: 
197:     // Group by category (first part of code)
198:     const categories = {}
199:     data.forEach(item => {
200:       const category = item.code.split('.')[0] || 'Outros'
201:       if (!categories[category]) categories[category] = []
202:       categories[category].push({
203:         x: item.code,
204:         y: item.count
205:       })
206:     })
207: 
208:     const series = Object.entries(categories).map(([name, data]) => ({
209:       name,
210:       data
211:     }))
212: 
213:     const options = {
214:       series,
215:       chart: {
216:         type: 'treemap',
217:         height: 350,
218:         fontFamily: 'Inter var, Inter, system-ui, sans-serif',
219:         toolbar: { show: false },
220:         background: 'transparent'
221:       },
222:       colors: [COLORS.teal, COLORS.sage, COLORS.violet, COLORS.ochre, COLORS.cyan],
223:       plotOptions: {
224:         treemap: {
225:           distributed: true,
226:           enableShades: true,
227:           shadeIntensity: 0.5
228:         }
229:       },
230:       dataLabels: {
231:         enabled: true,
232:         style: {
233:           fontSize: '12px',
234:           fontFamily: 'Inter var, Inter, system-ui, sans-serif'
235:         },
236:         formatter: function(text, op) {
237:           return [text, op.value]
238:         },
239:         offsetY: -4
240:       },
241:       tooltip: {
242:         theme: isDark ? 'dark' : 'light',
243:         style: {
244:           fontFamily: 'Inter var, Inter, system-ui, sans-serif'
245:         }
246:       }
247:     }
248: 
249:     if (this.chart) {
250:       this.chart.updateOptions(options)
251:     } else {
252:       this.chart = new ApexCharts(this.el, options)
253:       this.chart.render()
254:     }
255:   }
256: }
257: 
258: export const CoordinatorBarChart = {
259:   mounted() {
260:     this.chart = null
261:     this.renderChart()
262:   },
263: 
264:   updated() {
265:     this.renderChart()
266:   },
267: 
268:   destroyed() {
269:     if (this.chart) {
270:       this.chart.destroy()
271:     }
272:   },
273: 
274:   renderChart() {
275:     const data = JSON.parse(this.el.dataset.chartData || '[]')
276: 
277:     if (data.length === 0) {
278:       this.el.innerHTML = '<p class="text-slate-500 dark:text-slate-400 text-center py-8">Sem dados suficientes para exibir o grafico</p>'
279:       return
280:     }
281: 
282:     const isDark = document.documentElement.classList.contains('dark')
283: 
284:     const options = {
285:       series: [{
286:         name: 'Aulas',
287:         data: data.map(d => d.lessons)
288:       }],
289:       chart: {
290:         type: 'bar',
291:         height: 280,
292:         fontFamily: 'Inter var, Inter, system-ui, sans-serif',
293:         toolbar: { show: false },
294:         background: 'transparent'
295:       },
296:       colors: [COLORS.teal],
297:       fill: {
298:         type: 'gradient',
299:         gradient: {
300:           shade: 'light',
301:           type: 'horizontal',
302:           shadeIntensity: 0.25,
303:           gradientToColors: [COLORS.sage],
304:           inverseColors: false,
305:           opacityFrom: 1,
306:           opacityTo: 1,
307:           stops: [0, 100]
308:         }
309:       },
310:       plotOptions: {
311:         bar: {
312:           horizontal: true,
313:           borderRadius: 6,
314:           barHeight: '60%'
315:         }
316:       },
317:       dataLabels: {
318:         enabled: true,
319:         style: {
320:           colors: ['#fff'],
321:           fontFamily: 'Inter var, Inter, system-ui, sans-serif'
322:         }
323:       },
324:       xaxis: {
325:         categories: data.map(d => d.name),
326:         labels: {
327:           style: {
328:             colors: isDark ? '#94a3b8' : '#64748b',
329:             fontSize: '12px',
330:             fontFamily: 'Inter var, Inter, system-ui, sans-serif'
331:           }
332:         },
333:         axisBorder: { show: false },
334:         axisTicks: { show: false }
335:       },
336:       yaxis: {
337:         labels: {
338:           style: {
339:             colors: isDark ? '#94a3b8' : '#64748b',
340:             fontSize: '12px',
341:             fontFamily: 'Inter var, Inter, system-ui, sans-serif'
342:           }
343:         }
344:       },
345:       grid: {
346:         borderColor: isDark ? '#334155' : '#e2e8f0',
347:         strokeDashArray: 4
348:       },
349:       tooltip: {
350:         theme: isDark ? 'dark' : 'light',
351:         style: {
352:           fontFamily: 'Inter var, Inter, system-ui, sans-serif'
353:         }
354:       }
355:     }
356: 
357:     if (this.chart) {
358:       this.chart.updateOptions(options)
359:     } else {
360:       this.chart = new ApexCharts(this.el, options)
361:       this.chart.render()
362:     }
363:   }
364: }
365: 
366: export const AlertsChart = {
367:   mounted() {
368:     this.chart = null
369:     this.renderChart()
370:   },
371: 
372:   updated() {
373:     this.renderChart()
374:   },
375: 
376:   destroyed() {
377:     if (this.chart) {
378:       this.chart.destroy()
379:     }
380:   },
381: 
382:   renderChart() {
383:     const data = JSON.parse(this.el.dataset.chartData || '{}')
384:     const chartType = this.el.dataset.chartType || 'severity'
385: 
386:     const isDark = document.documentElement.classList.contains('dark')
387: 
388:     let series, labels, colors
389: 
390:     if (chartType === 'severity') {
391:       const severityData = data.by_severity || {}
392:       labels = ['Baixo', 'Medio', 'Alto', 'Critico']
393:       series = [
394:         severityData.low || 0,
395:         severityData.medium || 0,
396:         severityData.high || 0,
397:         severityData.critical || 0
398:       ]
399:       colors = [COLORS.emerald, COLORS.amber, COLORS.red, '#991b1b']
400:     } else {
401:       const typeData = data.by_type || {}
402:       labels = Object.keys(typeData).map(key => {
403:         const typeLabels = {
404:           'verbal_aggression': 'Agressao Verbal',
405:           'exclusion': 'Exclusao',
406:           'intimidation': 'Intimidacao',
407:           'mockery': 'Zombaria',
408:           'discrimination': 'Discriminacao',
409:           'threat': 'Ameaca',
410:           'inappropriate_language': 'Linguagem Impropria',
411:           'other': 'Outros'
412:         }
413:         return typeLabels[key] || key
414:       })
415:       series = Object.values(typeData)
416:       colors = CHART_PALETTE
417:     }
418: 
419:     if (series.every(v => v === 0)) {
420:       this.el.innerHTML = '<p class="text-slate-500 dark:text-slate-400 text-center py-8">Nenhum alerta registrado</p>'
421:       return
422:     }
423: 
424:     const options = {
425:       series,
426:       labels,
427:       colors,
428:       chart: {
429:         type: 'donut',
430:         height: 300,
431:         fontFamily: 'Inter var, Inter, system-ui, sans-serif',
432:         background: 'transparent'
433:       },
434:       plotOptions: {
435:         pie: {
436:           donut: {
437:             size: '65%',
438:             labels: {
439:               show: true,
440:               name: {
441:                 show: true,
442:                 fontSize: '14px',
443:                 fontFamily: 'Inter var, Inter, system-ui, sans-serif',
444:                 color: isDark ? '#e2e8f0' : '#1e293b'
445:               },
446:               value: {
447:                 show: true,
448:                 fontSize: '24px',
449:                 fontFamily: 'Inter var, Inter, system-ui, sans-serif',
450:                 fontWeight: 600,
451:                 color: isDark ? '#e2e8f0' : '#1e293b'
452:               },
453:               total: {
454:                 show: true,
455:                 label: 'Total',
456:                 fontSize: '14px',
457:                 fontFamily: 'Inter var, Inter, system-ui, sans-serif',
458:                 color: isDark ? '#94a3b8' : '#64748b'
459:               }
460:             }
461:           }
462:         }
463:       },
464:       dataLabels: {
465:         enabled: false
466:       },
467:       legend: {
468:         position: 'bottom',
469:         fontFamily: 'Inter var, Inter, system-ui, sans-serif',
470:         labels: {
471:           colors: isDark ? '#94a3b8' : '#64748b'
472:         }
473:       },
474:       tooltip: {
475:         theme: isDark ? 'dark' : 'light',
476:         style: {
477:           fontFamily: 'Inter var, Inter, system-ui, sans-serif'
478:         }
479:       },
480:       stroke: {
481:         width: 2,
482:         colors: [isDark ? '#1e293b' : '#ffffff']
483:       }
484:     }
485: 
486:     if (this.chart) {
487:       this.chart.updateOptions(options)
488:     } else {
489:       this.chart = new ApexCharts(this.el, options)
490:       this.chart.render()
491:     }
492:   }
493: }
494: 
495: // Generic Analytics Chart - supports line, bar, and stacked bar
496: export const AnalyticsChart = {
497:   mounted() {
498:     this.chart = null
499:     this.renderChart()
500:   },
501: 
502:   updated() {
503:     this.renderChart()
504:   },
505: 
506:   destroyed() {
507:     if (this.chart) {
508:       this.chart.destroy()
509:     }
510:   },
511: 
512:   renderChart() {
513:     const chartData = JSON.parse(this.el.dataset.chart || '{}')
514:     const chartType = this.el.dataset.type || 'line'
515: 
516:     if (!chartData.labels || chartData.labels.length === 0) {
517:       this.el.innerHTML = '<p class="text-slate-500 dark:text-slate-400 text-center py-8">Sem dados suficientes para exibir o grafico</p>'
518:       return
519:     }
520: 
521:     const isDark = document.documentElement.classList.contains('dark')
522: 
523:     let options = {
524:       chart: {
525:         type: chartType,
526:         height: '100%',
527:         fontFamily: 'Inter var, Inter, system-ui, sans-serif',
528:         toolbar: { show: false },
529:         background: 'transparent',
530:         stacked: chartType === 'bar' && chartData.datasets.length > 1
531:       },
532:       xaxis: {
533:         categories: chartData.labels,
534:         labels: {
535:           style: {
536:             colors: isDark ? '#94a3b8' : '#64748b',
537:             fontSize: '12px',
538:             fontFamily: 'Inter var, Inter, system-ui, sans-serif'
539:           }
540:         },
541:         axisBorder: { show: false },
542:         axisTicks: { show: false }
543:       },
544:       yaxis: {
545:         labels: {
546:           style: {
547:             colors: isDark ? '#94a3b8' : '#64748b',
548:             fontSize: '12px',
549:             fontFamily: 'Inter var, Inter, system-ui, sans-serif'
550:           }
551:         }
552:       },
553:       grid: {
554:         borderColor: isDark ? '#334155' : '#e2e8f0',
555:         strokeDashArray: 4,
556:         padding: {
557:           left: 10,
558:           right: 10
559:         }
560:       },
561:       tooltip: {
562:         theme: isDark ? 'dark' : 'light',
563:         style: {
564:           fontFamily: 'Inter var, Inter, system-ui, sans-serif'
565:         }
566:       },
567:       legend: {
568:         position: 'top',
569:         horizontalAlign: 'right',
570:         fontFamily: 'Inter var, Inter, system-ui, sans-serif',
571:         labels: {
572:           colors: isDark ? '#94a3b8' : '#64748b'
573:         }
574:       }
575:     }
576: 
577:     // Build series from datasets
578:     options.series = chartData.datasets.map(ds => ({
579:       name: ds.label,
580:       data: ds.data
581:     }))
582: 
583:     // Chart type specific options
584:     if (chartType === 'line') {
585:       options.stroke = {
586:         curve: 'smooth',
587:         width: 3
588:       }
589:       options.fill = {
590:         type: 'gradient',
591:         gradient: {
592:           shadeIntensity: 1,
593:           opacityFrom: 0.4,
594:           opacityTo: 0.05,
595:           stops: [0, 90, 100]
596:         }
597:       }
598:       options.colors = chartData.datasets.map((ds, i) => ds.borderColor || CHART_PALETTE[i % CHART_PALETTE.length])
599:     } else if (chartType === 'bar') {
600:       options.plotOptions = {
601:         bar: {
602:           borderRadius: 6,
603:           columnWidth: '60%'
604:         }
605:       }
606:       options.colors = chartData.datasets.map((ds, i) => ds.backgroundColor || CHART_PALETTE[i % CHART_PALETTE.length])
607:       options.dataLabels = { enabled: false }
608:     }
609: 
610:     if (this.chart) {
611:       this.chart.updateOptions(options)
612:     } else {
613:       this.chart = new ApexCharts(this.el, options)
614:       this.chart.render()
615:     }
616:   }
617: }
618: 
619: // Billing Usage Chart - Daily credit usage over 30 days
620: export const BillingUsageChart = {
621:   mounted() {
622:     this.chart = null
623:     this.renderChart()
624:   },
625: 
626:   updated() {
627:     this.renderChart()
628:   },
629: 
630:   destroyed() {
631:     if (this.chart) {
632:       this.chart.destroy()
633:     }
634:   },
635: 
636:   renderChart() {
637:     const data = JSON.parse(this.el.dataset.usage || '[]')
638: 
639:     if (data.length === 0) {
640:       this.el.innerHTML = '<p class="text-slate-500 dark:text-slate-400 text-center py-8">Sem dados de uso para exibir</p>'
641:       return
642:     }
643: 
644:     const isDark = document.documentElement.classList.contains('dark')
645: 
646:     const options = {
647:       series: [{
648:         name: 'Creditos Usados',
649:         data: data.map(d => ({
650:           x: new Date(d.date).getTime(),
651:           y: d.credits
652:         }))
653:       }],
654:       chart: {
655:         type: 'bar',
656:         height: '100%',
657:         fontFamily: 'Inter var, Inter, system-ui, sans-serif',
658:         toolbar: { show: false },
659:         background: 'transparent',
660:         animations: {
661:           enabled: true,
662:           easing: 'easeinout',
663:           speed: 600
664:         }
665:       },
666:       colors: [COLORS.teal],
667:       fill: {
668:         type: 'gradient',
669:         gradient: {
670:           shade: 'light',
671:           type: 'vertical',
672:           shadeIntensity: 0.25,
673:           gradientToColors: [COLORS.sage],
674:           inverseColors: false,
675:           opacityFrom: 1,
676:           opacityTo: 0.85,
677:           stops: [0, 100]
678:         }
679:       },
680:       plotOptions: {
681:         bar: {
682:           borderRadius: 4,
683:           columnWidth: '70%'
684:         }
685:       },
686:       dataLabels: { enabled: false },
687:       xaxis: {
688:         type: 'datetime',
689:         labels: {
690:           style: {
691:             colors: isDark ? '#94a3b8' : '#64748b',
692:             fontSize: '11px',
693:             fontFamily: 'Inter var, Inter, system-ui, sans-serif'
694:           },
695:           datetimeFormatter: {
696:             day: 'dd/MM'
697:           }
698:         },
699:         axisBorder: { show: false },
700:         axisTicks: { show: false }
701:       },
702:       yaxis: {
703:         labels: {
704:           style: {
705:             colors: isDark ? '#94a3b8' : '#64748b',
706:             fontSize: '11px',
707:             fontFamily: 'Inter var, Inter, system-ui, sans-serif'
708:           },
709:           formatter: (val) => Math.round(val)
710:         }
711:       },
712:       grid: {
713:         borderColor: isDark ? '#334155' : '#e2e8f0',
714:         strokeDashArray: 4,
715:         padding: {
716:           left: 10,
717:           right: 10
718:         }
719:       },
720:       tooltip: {
721:         theme: isDark ? 'dark' : 'light',
722:         x: { format: 'dd/MM/yyyy' },
723:         y: {
724:           formatter: (val) => `${val} credito${val !== 1 ? 's' : ''}`
725:         },
726:         style: {
727:           fontFamily: 'Inter var, Inter, system-ui, sans-serif'
728:         }
729:       }
730:     }
731: 
732:     if (this.chart) {
733:       this.chart.updateOptions(options)
734:     } else {
735:       this.chart = new ApexCharts(this.el, options)
736:       this.chart.render()
737:     }
738:   }
739: }
740: 
741: // Score Gauge - Circular progress for score display
742: export const ScoreGauge = {
743:   mounted() {
744:     this.chart = null
745:     this.renderChart()
746:   },
747: 
748:   updated() {
749:     this.renderChart()
750:   },
751: 
752:   destroyed() {
753:     if (this.chart) {
754:       this.chart.destroy()
755:     }
756:   },
757: 
758:   renderChart() {
759:     const score = parseFloat(this.el.dataset.score || '0') * 100
760:     const isDark = document.documentElement.classList.contains('dark')
761: 
762:     // Color based on score
763:     let color = COLORS.red
764:     if (score >= 80) color = COLORS.teal
765:     else if (score >= 60) color = COLORS.sage
766:     else if (score >= 40) color = COLORS.ochre
767: 
768:     const options = {
769:       series: [Math.round(score)],
770:       chart: {
771:         type: 'radialBar',
772:         height: 200,
773:         fontFamily: 'Inter var, Inter, system-ui, sans-serif',
774:         background: 'transparent',
775:         sparkline: {
776:           enabled: true
777:         }
778:       },
779:       colors: [color],
780:       plotOptions: {
781:         radialBar: {
782:           startAngle: -135,
783:           endAngle: 135,
784:           hollow: {
785:             size: '70%'
786:           },
787:           track: {
788:             background: isDark ? '#334155' : '#e2e8f0',
789:             strokeWidth: '100%',
790:             margin: 0
791:           },
792:           dataLabels: {
793:             name: {
794:               show: false
795:             },
796:             value: {
797:               fontSize: '32px',
798:               fontWeight: 700,
799:               fontFamily: 'Inter var, Inter, system-ui, sans-serif',
800:               color: isDark ? '#e2e8f0' : '#1e293b',
801:               offsetY: 10,
802:               formatter: (val) => `${val}%`
803:             }
804:           }
805:         }
806:       },
807:       stroke: {
808:         lineCap: 'round'
809:       }
810:     }
811: 
812:     if (this.chart) {
813:       this.chart.updateOptions(options)
814:     } else {
815:       this.chart = new ApexCharts(this.el, options)
816:       this.chart.render()
817:     }
818:   }
819: }
````

## File: lib/hellen/billing.ex
````elixir
  1: defmodule Hellen.Billing do
  2:   @moduledoc """
  3:   The Billing context - manages credits and transactions.
  4:   """
  5: 
  6:   import Ecto.Query, warn: false
  7: 
  8:   alias Hellen.Accounts.User
  9:   alias Hellen.Billing.CreditTransaction
 10:   alias Hellen.Repo
 11: 
 12:   @signup_bonus 2
 13: 
 14:   @doc """
 15:   Grants signup bonus credits to a new user.
 16:   """
 17:   def grant_signup_bonus(%User{} = user) do
 18:     add_credits(user, @signup_bonus, "signup_bonus")
 19:   end
 20: 
 21:   @doc """
 22:   Checks if user has enough credits.
 23:   """
 24:   def check_credits(%User{credits: credits}) when credits >= 1, do: :ok
 25:   def check_credits(_user), do: {:error, :insufficient_credits}
 26: 
 27:   @doc """
 28:   Uses one credit for lesson analysis.
 29:   """
 30:   def use_credit(%User{} = user, lesson_id) do
 31:     if user.credits >= 1 do
 32:       deduct_credits(user, 1, "lesson_analysis", lesson_id)
 33:     else
 34:       {:error, :insufficient_credits}
 35:     end
 36:   end
 37: 
 38:   @doc """
 39:   Adds credits to user account.
 40:   Uses Ecto.Multi for transactional consistency.
 41:   """
 42:   @spec add_credits(User.t(), pos_integer(), String.t(), binary() | nil) ::
 43:           {:ok, User.t()} | {:error, term()}
 44:   def add_credits(%User{} = user, amount, reason, lesson_id \\ nil) when amount > 0 do
 45:     add_credits_internal(user, amount, reason, lesson_id, nil)
 46:   end
 47: 
 48:   @doc """
 49:   Adds credits with Stripe payment tracking.
 50:   """
 51:   @spec add_credits_with_stripe(User.t(), pos_integer(), String.t(), String.t()) ::
 52:           {:ok, User.t()} | {:error, term()}
 53:   def add_credits_with_stripe(%User{} = user, amount, package_id, payment_intent_id)
 54:       when amount > 0 do
 55:     add_credits_internal(user, amount, "purchase", nil, payment_intent_id, %{
 56:       package_id: package_id
 57:     })
 58:   end
 59: 
 60:   defp add_credits_internal(
 61:          user,
 62:          amount,
 63:          reason,
 64:          lesson_id,
 65:          stripe_payment_intent_id,
 66:          metadata \\ %{}
 67:        ) do
 68:     new_balance = user.credits + amount
 69: 
 70:     Ecto.Multi.new()
 71:     |> Ecto.Multi.update(:user, User.changeset(user, %{credits: new_balance}))
 72:     |> Ecto.Multi.insert(
 73:       :transaction,
 74:       build_transaction_changeset(
 75:         user,
 76:         amount,
 77:         new_balance,
 78:         reason,
 79:         lesson_id,
 80:         stripe_payment_intent_id,
 81:         metadata
 82:       )
 83:     )
 84:     |> Repo.transaction()
 85:     |> case do
 86:       {:ok, %{user: updated_user}} -> {:ok, updated_user}
 87:       {:error, _op, changeset, _changes} -> {:error, changeset}
 88:     end
 89:   end
 90: 
 91:   @doc """
 92:   Deducts credits from user account.
 93:   Uses Ecto.Multi for transactional consistency.
 94:   """
 95:   @spec deduct_credits(User.t(), pos_integer(), String.t(), binary() | nil) ::
 96:           {:ok, User.t()} | {:error, :insufficient_credits | term()}
 97:   def deduct_credits(%User{} = user, amount, reason, lesson_id \\ nil) when amount > 0 do
 98:     new_balance = user.credits - amount
 99: 
100:     if new_balance >= 0 do
101:       Ecto.Multi.new()
102:       |> Ecto.Multi.update(:user, User.changeset(user, %{credits: new_balance}))
103:       |> Ecto.Multi.insert(
104:         :transaction,
105:         build_transaction_changeset(user, -amount, new_balance, reason, lesson_id, nil, %{})
106:       )
107:       |> Repo.transaction()
108:       |> case do
109:         {:ok, %{user: updated_user}} -> {:ok, updated_user}
110:         {:error, _op, changeset, _changes} -> {:error, changeset}
111:       end
112:     else
113:       {:error, :insufficient_credits}
114:     end
115:   end
116: 
117:   defp build_transaction_changeset(
118:          user,
119:          amount,
120:          balance_after,
121:          reason,
122:          lesson_id,
123:          stripe_payment_intent_id,
124:          metadata
125:        ) do
126:     %CreditTransaction{}
127:     |> CreditTransaction.changeset(%{
128:       user_id: user.id,
129:       amount: amount,
130:       balance_after: balance_after,
131:       reason: reason,
132:       lesson_id: lesson_id,
133:       stripe_payment_intent_id: stripe_payment_intent_id,
134:       metadata: metadata
135:     })
136:   end
137: 
138:   @doc """
139:   Gets credit balance for a user.
140:   """
141:   def get_balance(%User{credits: credits}), do: credits
142: 
143:   @doc """
144:   Gets a transaction by its Stripe payment intent ID.
145:   Returns nil if not found.
146:   """
147:   def get_transaction_by_payment_intent(nil), do: nil
148: 
149:   def get_transaction_by_payment_intent(payment_intent_id) do
150:     CreditTransaction
151:     |> where([t], t.stripe_payment_intent_id == ^payment_intent_id)
152:     |> limit(1)
153:     |> Repo.one()
154:   end
155: 
156:   @doc """
157:   Lists credit transactions for a user.
158:   """
159:   def list_transactions(user_id, opts \\ []) do
160:     limit = Keyword.get(opts, :limit, 50)
161: 
162:     CreditTransaction
163:     |> where([t], t.user_id == ^user_id)
164:     |> order_by([t], desc: t.inserted_at)
165:     |> limit(^limit)
166:     |> Repo.all()
167:   end
168: 
169:   @doc """
170:   Refunds a credit for a failed analysis.
171:   """
172:   def refund_credit(%User{} = user, lesson_id) do
173:     add_credits(user, 1, "refund", lesson_id)
174:   end
175: 
176:   @doc """
177:   Lists credit transactions with filters.
178:   Supports: reason, start_date, end_date, limit, offset.
179:   """
180:   @spec list_transactions_filtered(binary(), keyword()) :: {[CreditTransaction.t()], integer()}
181:   def list_transactions_filtered(user_id, opts \\ []) do
182:     reason = Keyword.get(opts, :reason)
183:     start_date = Keyword.get(opts, :start_date)
184:     end_date = Keyword.get(opts, :end_date)
185:     limit = Keyword.get(opts, :limit, 20)
186:     offset = Keyword.get(opts, :offset, 0)
187: 
188:     query =
189:       CreditTransaction
190:       |> where([t], t.user_id == ^user_id)
191:       |> order_by([t], desc: t.inserted_at)
192: 
193:     query =
194:       if reason && reason != "" do
195:         where(query, [t], t.reason == ^reason)
196:       else
197:         query
198:       end
199: 
200:     query =
201:       if start_date do
202:         where(query, [t], t.inserted_at >= ^start_date)
203:       else
204:         query
205:       end
206: 
207:     query =
208:       if end_date do
209:         where(query, [t], t.inserted_at <= ^end_date)
210:       else
211:         query
212:       end
213: 
214:     total = Repo.aggregate(query, :count)
215: 
216:     transactions =
217:       query
218:       |> limit(^limit)
219:       |> offset(^offset)
220:       |> preload(:lesson)
221:       |> Repo.all()
222: 
223:     {transactions, total}
224:   end
225: 
226:   @doc """
227:   Get usage statistics for a user over a period.
228:   Returns total used, total added, breakdown by reason, and transaction count.
229:   """
230:   @spec get_usage_stats(binary(), integer()) :: map()
231:   def get_usage_stats(user_id, days \\ 30) do
232:     start_date = DateTime.utc_now() |> DateTime.add(-days, :day)
233: 
234:     transactions =
235:       CreditTransaction
236:       |> where([t], t.user_id == ^user_id and t.inserted_at >= ^start_date)
237:       |> Repo.all()
238: 
239:     total_used =
240:       transactions
241:       |> Enum.filter(&(&1.amount < 0))
242:       |> Enum.map(& &1.amount)
243:       |> Enum.sum()
244:       |> abs()
245: 
246:     total_added =
247:       transactions
248:       |> Enum.filter(&(&1.amount > 0))
249:       |> Enum.map(& &1.amount)
250:       |> Enum.sum()
251: 
252:     by_reason =
253:       transactions
254:       |> Enum.group_by(& &1.reason)
255:       |> Enum.map(fn {reason, txs} ->
256:         {reason, %{count: length(txs), amount: Enum.sum(Enum.map(txs, & &1.amount))}}
257:       end)
258:       |> Map.new()
259: 
260:     %{
261:       total_used: total_used,
262:       total_added: total_added,
263:       transaction_count: length(transactions),
264:       by_reason: by_reason,
265:       period_days: days
266:     }
267:   end
268: 
269:   @doc """
270:   Get daily usage data for charts.
271:   Returns list of %{date, used, added} for each day.
272:   """
273:   @spec get_daily_usage(binary(), integer()) :: [map()]
274:   def get_daily_usage(user_id, days \\ 30) do
275:     start_date = Date.utc_today() |> Date.add(-days)
276: 
277:     transactions =
278:       CreditTransaction
279:       |> where([t], t.user_id == ^user_id and fragment("?::date", t.inserted_at) >= ^start_date)
280:       |> Repo.all()
281: 
282:     # Group by date
283:     by_date =
284:       transactions
285:       |> Enum.group_by(fn t -> DateTime.to_date(t.inserted_at) end)
286: 
287:     # Generate all dates in range
288:     start_date
289:     |> Date.range(Date.utc_today())
290:     |> Enum.map(fn date ->
291:       day_transactions = Map.get(by_date, date, [])
292: 
293:       used =
294:         day_transactions
295:         |> Enum.filter(&(&1.amount < 0))
296:         |> Enum.map(& &1.amount)
297:         |> Enum.sum()
298:         |> abs()
299: 
300:       added =
301:         day_transactions
302:         |> Enum.filter(&(&1.amount > 0))
303:         |> Enum.map(& &1.amount)
304:         |> Enum.sum()
305: 
306:       %{date: date, used: used, added: added}
307:     end)
308:   end
309: 
310:   @doc """
311:   Returns available credit packages for purchase.
312:   Stripe-ready structure with price in centavos.
313:   """
314:   @spec credit_packages() :: [map()]
315:   def credit_packages do
316:     [
317:       %{id: "basic", name: "Basico", credits: 10, price: 2990, price_display: "R$ 29,90"},
318:       %{
319:         id: "standard",
320:         name: "Padrao",
321:         credits: 30,
322:         price: 7990,
323:         price_display: "R$ 79,90",
324:         popular: true
325:       },
326:       %{id: "pro", name: "Profissional", credits: 100, price: 19_990, price_display: "R$ 199,90"}
327:     ]
328:   end
329: 
330:   @doc """
331:   Get count of analyses (lessons analyzed) for a user.
332:   """
333:   @spec get_analyses_count(binary()) :: integer()
334:   def get_analyses_count(user_id) do
335:     CreditTransaction
336:     |> where([t], t.user_id == ^user_id and t.reason == "lesson_analysis")
337:     |> Repo.aggregate(:count)
338:   end
339: end
````

## File: lib/hellen_web/components/landing_components.ex
````elixir
   1: defmodule HellenWeb.LandingComponents do
   2:   @moduledoc """
   3:   Landing page components for Hellen AI.
   4: 
   5:   Includes:
   6:   - Navbar for landing page
   7:   - Hero section with animated background
   8:   - How it works section
   9:   - Feature cards and sections
  10:   - Pricing cards and section
  11:   - Testimonials
  12:   - CTA section
  13:   - Footer
  14:   """
  15:   use Phoenix.Component
  16: 
  17:   alias Phoenix.LiveView.JS
  18: 
  19:   import HellenWeb.CoreComponents, only: [icon: 1]
  20: 
  21:   # ============================================================================
  22:   # NAVBAR
  23:   # ============================================================================
  24: 
  25:   @doc """
  26:   Renders the landing page navbar.
  27: 
  28:   ## Examples
  29: 
  30:       <.landing_navbar />
  31:   """
  32:   attr :class, :string, default: nil
  33: 
  34:   def landing_navbar(assigns) do
  35:     ~H"""
  36:     <nav class={[
  37:       "fixed top-0 left-0 right-0 z-50",
  38:       "bg-white/80 dark:bg-slate-900/80 backdrop-blur-md",
  39:       "border-b border-slate-200/50 dark:border-slate-700/50",
  40:       "transition-all duration-300",
  41:       @class
  42:     ]}>
  43:       <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
  44:         <div class="flex justify-between items-center h-16">
  45:           <!-- Logo -->
  46:           <div class="flex items-center">
  47:             <a href="/" class="flex items-center group">
  48:               <span class="text-2xl font-bold bg-gradient-to-r from-teal-600 to-cyan-500 dark:from-teal-400 dark:to-cyan-400 bg-clip-text text-transparent">
  49:                 Hellen
  50:               </span>
  51:               <span class="ml-1.5 text-xs font-semibold text-slate-500 dark:text-slate-400 group-hover:text-teal-600 dark:group-hover:text-teal-400 transition-colors">
  52:                 AI
  53:               </span>
  54:             </a>
  55:           </div>
  56:           <!-- Navigation Links (Desktop) -->
  57:           <div class="hidden md:flex items-center gap-8">
  58:             <a
  59:               href="#features"
  60:               class="text-sm font-medium text-slate-700 dark:text-slate-300 hover:text-teal-600 dark:hover:text-teal-400 transition-colors"
  61:             >
  62:               Recursos
  63:             </a>
  64:             <a
  65:               href="#pricing"
  66:               class="text-sm font-medium text-slate-700 dark:text-slate-300 hover:text-teal-600 dark:hover:text-teal-400 transition-colors"
  67:             >
  68:               Preços
  69:             </a>
  70:             <a
  71:               href="#testimonials"
  72:               class="text-sm font-medium text-slate-700 dark:text-slate-300 hover:text-teal-600 dark:hover:text-teal-400 transition-colors"
  73:             >
  74:               Depoimentos
  75:             </a>
  76:             <a
  77:               href="#contact"
  78:               class="text-sm font-medium text-slate-700 dark:text-slate-300 hover:text-teal-600 dark:hover:text-teal-400 transition-colors"
  79:             >
  80:               Contato
  81:             </a>
  82:           </div>
  83:           <!-- Actions -->
  84:           <div class="flex items-center gap-2 sm:gap-3">
  85:             <button
  86:               id="theme-toggle"
  87:               phx-hook="ThemeToggle"
  88:               class="p-2 text-slate-400 dark:text-slate-300 hover:text-slate-600 dark:hover:text-white rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
  89:               title="Alternar tema"
  90:             >
  91:               <.icon name="hero-sun" class="h-5 w-5 dark:hidden" />
  92:               <.icon name="hero-moon" class="h-5 w-5 hidden dark:block" />
  93:             </button>
  94: 
  95:             <a
  96:               href="/login"
  97:               class="hidden md:block text-sm font-medium text-slate-700 dark:text-slate-300 hover:text-teal-600 dark:hover:text-teal-400 transition-colors px-3 py-2"
  98:             >
  99:               Entrar
 100:             </a>
 101: 
 102:             <a
 103:               href="/register"
 104:               class="hidden sm:inline-flex items-center justify-center px-4 py-2 text-sm font-semibold text-white bg-teal-600 hover:bg-teal-700 rounded-xl transition-all duration-200 shadow-sm hover:shadow-md hover:shadow-teal-500/25"
 105:             >
 106:               Criar Conta
 107:             </a>
 108:             <!-- Mobile menu button -->
 109:             <button
 110:               type="button"
 111:               class="md:hidden p-2 text-slate-400 dark:text-slate-300 hover:text-slate-600 dark:hover:text-white rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
 112:               phx-click={JS.toggle(to: "#mobile-menu", in: "fade-in-scale", out: "fade-out-scale")}
 113:               aria-expanded="false"
 114:               aria-controls="mobile-menu"
 115:             >
 116:               <span class="sr-only">Abrir menu</span>
 117:               <.icon name="hero-bars-3" class="h-6 w-6" />
 118:             </button>
 119:           </div>
 120:         </div>
 121:       </div>
 122:       <!-- Mobile menu -->
 123:       <div
 124:         id="mobile-menu"
 125:         class="hidden md:hidden bg-white/95 dark:bg-slate-900/95 backdrop-blur-md border-t border-slate-200/50 dark:border-slate-700/50"
 126:       >
 127:         <div class="px-4 py-4 space-y-3">
 128:           <a
 129:             href="#features"
 130:             class="block px-3 py-2 text-base font-medium text-slate-700 dark:text-slate-300 hover:text-teal-600 dark:hover:text-teal-400 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg transition-colors"
 131:             phx-click={JS.hide(to: "#mobile-menu")}
 132:           >
 133:             Recursos
 134:           </a>
 135:           <a
 136:             href="#pricing"
 137:             class="block px-3 py-2 text-base font-medium text-slate-700 dark:text-slate-300 hover:text-teal-600 dark:hover:text-teal-400 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg transition-colors"
 138:             phx-click={JS.hide(to: "#mobile-menu")}
 139:           >
 140:             Preços
 141:           </a>
 142:           <a
 143:             href="#testimonials"
 144:             class="block px-3 py-2 text-base font-medium text-slate-700 dark:text-slate-300 hover:text-teal-600 dark:hover:text-teal-400 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg transition-colors"
 145:             phx-click={JS.hide(to: "#mobile-menu")}
 146:           >
 147:             Depoimentos
 148:           </a>
 149:           <a
 150:             href="#contact"
 151:             class="block px-3 py-2 text-base font-medium text-slate-700 dark:text-slate-300 hover:text-teal-600 dark:hover:text-teal-400 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg transition-colors"
 152:             phx-click={JS.hide(to: "#mobile-menu")}
 153:           >
 154:             Contato
 155:           </a>
 156: 
 157:           <div class="pt-3 border-t border-slate-200 dark:border-slate-700 space-y-3">
 158:             <a
 159:               href="/login"
 160:               class="block px-3 py-2 text-base font-medium text-slate-700 dark:text-slate-300 hover:text-teal-600 dark:hover:text-teal-400 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg transition-colors"
 161:             >
 162:               Entrar
 163:             </a>
 164:             <a
 165:               href="/register"
 166:               class="block w-full text-center px-4 py-2.5 text-base font-semibold text-white bg-teal-600 hover:bg-teal-700 rounded-xl transition-colors duration-200"
 167:             >
 168:               Criar Conta Gratuita
 169:             </a>
 170:           </div>
 171:         </div>
 172:       </div>
 173:     </nav>
 174:     """
 175:   end
 176: 
 177:   # ============================================================================
 178:   # HERO SECTION
 179:   # ============================================================================
 180: 
 181:   @doc """
 182:   Renders the hero section with animated background.
 183: 
 184:   ## Examples
 185: 
 186:       <.hero_section />
 187:   """
 188:   attr :class, :string, default: nil
 189: 
 190:   def hero_section(assigns) do
 191:     ~H"""
 192:     <section class={[
 193:       "relative min-h-screen flex items-center justify-center overflow-hidden",
 194:       "bg-gradient-to-br from-slate-50 via-teal-50/30 to-cyan-50/20",
 195:       "dark:from-slate-900 dark:via-teal-950/30 dark:to-cyan-950/20",
 196:       "pt-16",
 197:       @class
 198:     ]}>
 199:       <!-- Animated background orbs -->
 200:       <div class="absolute inset-0 overflow-hidden pointer-events-none">
 201:         <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-teal-400/20 dark:bg-teal-500/10 rounded-full blur-3xl animate-float" />
 202:         <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-cyan-400/20 dark:bg-cyan-500/10 rounded-full blur-3xl animate-float-delayed" />
 203:         <div class="absolute top-1/2 left-1/2 w-96 h-96 bg-emerald-400/10 dark:bg-emerald-500/5 rounded-full blur-3xl animate-pulse-glow" />
 204:       </div>
 205:       <!-- Grid pattern -->
 206:       <div class="absolute inset-0 bg-[linear-gradient(to_right,#8882_1px,transparent_1px),linear-gradient(to_bottom,#8882_1px,transparent_1px)] bg-[size:4rem_4rem] [mask-image:radial-gradient(ellipse_60%_50%_at_50%_0%,#000_70%,transparent_110%)] dark:opacity-20" />
 207: 
 208:       <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 sm:py-24 lg:py-32">
 209:         <div class="text-center max-w-4xl mx-auto">
 210:           <!-- Badge -->
 211:           <div class="inline-flex items-center gap-2 px-3 sm:px-4 py-1.5 rounded-full bg-teal-100/80 dark:bg-teal-900/30 backdrop-blur-sm mb-6 sm:mb-8 animate-fade-in-up border border-teal-200/50 dark:border-teal-700/50">
 212:             <span class="relative flex h-2 w-2">
 213:               <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-teal-400 opacity-75">
 214:               </span>
 215:               <span class="relative inline-flex rounded-full h-2 w-2 bg-teal-500"></span>
 216:             </span>
 217:             <span class="text-xs sm:text-sm font-semibold text-teal-700 dark:text-teal-300">
 218:               Feedback pedagógico com IA
 219:             </span>
 220:           </div>
 221:           <!-- Headline -->
 222:           <h1 class="text-3xl sm:text-5xl lg:text-6xl xl:text-7xl font-bold text-slate-900 dark:text-white mb-4 sm:mb-6 animate-fade-in-up leading-tight tracking-tight">
 223:             Transforme suas aulas com
 224:             <span class="bg-gradient-to-r from-teal-600 to-cyan-500 dark:from-teal-400 dark:to-cyan-400 bg-clip-text text-transparent">
 225:               feedback inteligente
 226:             </span>
 227:           </h1>
 228:           <!-- Subtitle -->
 229:           <p class="text-base sm:text-xl lg:text-2xl text-slate-600 dark:text-slate-300 mb-8 sm:mb-12 max-w-3xl mx-auto animate-fade-in-up leading-relaxed px-2">
 230:             Analise gravações de aulas automaticamente com base na
 231:             <strong class="text-teal-600 dark:text-teal-400">BNCC</strong>
 232:             e <strong class="text-teal-600 dark:text-teal-400">Lei 13.185</strong>. Receba insights pedagógicos em minutos.
 233:           </p>
 234:           <!-- CTAs -->
 235:           <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center items-center mb-10 sm:mb-16 animate-fade-in-up px-4 sm:px-0">
 236:             <a
 237:               href="/register"
 238:               class="group inline-flex items-center justify-center px-6 sm:px-8 py-3.5 sm:py-4 text-base font-semibold text-white bg-teal-600 hover:bg-teal-700 rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl hover:shadow-teal-500/25 hover:scale-105 w-full sm:w-auto"
 239:             >
 240:               Comece Grátis
 241:               <.icon
 242:                 name="hero-arrow-right"
 243:                 class="ml-2 h-5 w-5 group-hover:translate-x-1 transition-transform"
 244:               />
 245:             </a>
 246: 
 247:             <a
 248:               href="#features"
 249:               class="inline-flex items-center justify-center px-6 sm:px-8 py-3.5 sm:py-4 text-base font-semibold text-teal-600 dark:text-teal-400 bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 border-2 border-teal-200 dark:border-teal-800 rounded-xl transition-all duration-200 w-full sm:w-auto shadow-sm"
 250:             >
 251:               <.icon name="hero-sparkles" class="mr-2 h-5 w-5" /> Ver Recursos
 252:             </a>
 253:           </div>
 254:           <!-- Social Proof Enhanced -->
 255:           <div class="flex flex-col sm:flex-row items-center justify-center gap-4 sm:gap-6 animate-fade-in-up">
 256:             <div class="flex items-center gap-3">
 257:               <div class="flex -space-x-2">
 258:                 <div class="w-8 h-8 rounded-full bg-gradient-to-br from-teal-400 to-teal-500 border-2 border-white dark:border-slate-900 flex items-center justify-center text-white text-xs font-bold">
 259:                   M
 260:                 </div>
 261:                 <div class="w-8 h-8 rounded-full bg-gradient-to-br from-cyan-400 to-cyan-500 border-2 border-white dark:border-slate-900 flex items-center justify-center text-white text-xs font-bold">
 262:                   J
 263:                 </div>
 264:                 <div class="w-8 h-8 rounded-full bg-gradient-to-br from-emerald-400 to-emerald-500 border-2 border-white dark:border-slate-900 flex items-center justify-center text-white text-xs font-bold">
 265:                   A
 266:                 </div>
 267:                 <div class="w-8 h-8 rounded-full bg-gradient-to-br from-amber-400 to-amber-500 border-2 border-white dark:border-slate-900 flex items-center justify-center text-white text-xs font-bold">
 268:                   R
 269:                 </div>
 270:                 <div class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-700 border-2 border-white dark:border-slate-900 flex items-center justify-center text-slate-600 dark:text-slate-300 text-xs font-bold">
 271:                   +
 272:                 </div>
 273:               </div>
 274:               <div class="text-sm text-slate-600 dark:text-slate-400">
 275:                 <strong class="text-slate-900 dark:text-white">847</strong> professores ativos
 276:               </div>
 277:             </div>
 278:             <div class="hidden sm:block w-px h-6 bg-slate-300 dark:bg-slate-700"></div>
 279:             <div class="flex items-center gap-2">
 280:               <div class="flex items-center gap-0.5 text-amber-400">
 281:                 <.icon name="hero-star-solid" class="h-4 w-4" />
 282:                 <.icon name="hero-star-solid" class="h-4 w-4" />
 283:                 <.icon name="hero-star-solid" class="h-4 w-4" />
 284:                 <.icon name="hero-star-solid" class="h-4 w-4" />
 285:                 <.icon name="hero-star-solid" class="h-4 w-4" />
 286:               </div>
 287:               <span class="text-sm text-slate-600 dark:text-slate-400">
 288:                 <strong class="text-slate-900 dark:text-white">4.9</strong>/5 (312 avaliações)
 289:               </span>
 290:             </div>
 291:           </div>
 292:           <!-- Trust Badges -->
 293:           <div class="mt-8 flex flex-wrap items-center justify-center gap-4 sm:gap-8 text-xs text-slate-500 dark:text-slate-400 animate-fade-in-up">
 294:             <div class="flex items-center gap-2">
 295:               <.icon name="hero-shield-check" class="h-5 w-5 text-emerald-500" />
 296:               <span>Dados Criptografados</span>
 297:             </div>
 298:             <div class="flex items-center gap-2">
 299:               <.icon name="hero-academic-cap" class="h-5 w-5 text-teal-500" />
 300:               <span>Alinhado à BNCC</span>
 301:             </div>
 302:             <div class="flex items-center gap-2">
 303:               <.icon name="hero-clock" class="h-5 w-5 text-cyan-500" />
 304:               <span>Análise em &lt;5 min</span>
 305:             </div>
 306:           </div>
 307:         </div>
 308:       </div>
 309:       <!-- Scroll indicator -->
 310:       <div class="absolute bottom-8 left-1/2 -translate-x-1/2 animate-bounce">
 311:         <.icon name="hero-chevron-down" class="h-6 w-6 text-slate-400" />
 312:       </div>
 313:     </section>
 314:     """
 315:   end
 316: 
 317:   # ============================================================================
 318:   # IMPACT METRICS SECTION
 319:   # ============================================================================
 320: 
 321:   @doc """
 322:   Renders the impact metrics section.
 323: 
 324:   ## Examples
 325: 
 326:       <.impact_metrics />
 327:   """
 328:   attr :class, :string, default: nil
 329: 
 330:   def impact_metrics(assigns) do
 331:     ~H"""
 332:     <section class={[
 333:       "py-16 bg-gradient-to-r from-teal-600 to-cyan-600 dark:from-teal-800 dark:to-cyan-800",
 334:       @class
 335:     ]}>
 336:       <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
 337:         <div class="grid grid-cols-2 md:grid-cols-4 gap-8 text-center text-white">
 338:           <div data-animate>
 339:             <div class="text-4xl sm:text-5xl font-bold mb-2">12.847</div>
 340:             <div class="text-teal-100 text-sm sm:text-base">Aulas Analisadas</div>
 341:           </div>
 342:           <div data-animate>
 343:             <div class="text-4xl sm:text-5xl font-bold mb-2">847</div>
 344:             <div class="text-teal-100 text-sm sm:text-base">Professores Ativos</div>
 345:           </div>
 346:           <div data-animate>
 347:             <div class="text-4xl sm:text-5xl font-bold mb-2">98.7%</div>
 348:             <div class="text-teal-100 text-sm sm:text-base">Satisfação</div>
 349:           </div>
 350:           <div data-animate>
 351:             <div class="text-4xl sm:text-5xl font-bold mb-2">&lt;5min</div>
 352:             <div class="text-teal-100 text-sm sm:text-base">Tempo Médio</div>
 353:           </div>
 354:         </div>
 355:       </div>
 356:     </section>
 357:     """
 358:   end
 359: 
 360:   # ============================================================================
 361:   # HOW IT WORKS SECTION
 362:   # ============================================================================
 363: 
 364:   @doc """
 365:   Renders the how it works section.
 366: 
 367:   ## Examples
 368: 
 369:       <.how_it_works />
 370:   """
 371:   attr :class, :string, default: nil
 372: 
 373:   def how_it_works(assigns) do
 374:     ~H"""
 375:     <section
 376:       class={[
 377:         "py-24 bg-white dark:bg-slate-900",
 378:         @class
 379:       ]}
 380:       data-animate
 381:     >
 382:       <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
 383:         <div class="text-center mb-16">
 384:           <div class="inline-flex items-center px-3 py-1 rounded-full bg-teal-100 dark:bg-teal-900/30 text-teal-700 dark:text-teal-300 text-sm font-medium mb-4">
 385:             Processo Simples
 386:           </div>
 387:           <h2 class="text-4xl sm:text-5xl font-bold text-slate-900 dark:text-white mb-4 tracking-tight">
 388:             Como funciona
 389:           </h2>
 390:           <p class="text-xl text-slate-600 dark:text-slate-400 max-w-2xl mx-auto">
 391:             Análise pedagógica em 4 passos simples
 392:           </p>
 393:         </div>
 394: 
 395:         <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
 396:           <!-- Step 1 -->
 397:           <div class="relative group" data-animate>
 398:             <div class="text-center">
 399:               <div class="relative inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-teal-100 dark:bg-teal-900/30 text-teal-600 dark:text-teal-400 mb-4 group-hover:scale-110 group-hover:shadow-lg group-hover:shadow-teal-500/25 transition-all duration-300">
 400:                 <.icon name="hero-cloud-arrow-up" class="h-8 w-8" />
 401:                 <span class="absolute -top-2 -right-2 w-6 h-6 bg-teal-600 text-white text-xs font-bold rounded-full flex items-center justify-center">
 402:                   1
 403:                 </span>
 404:               </div>
 405:               <div class="absolute top-8 left-full w-full h-0.5 bg-gradient-to-r from-teal-300 to-transparent dark:from-teal-700 hidden lg:block" />
 406:               <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-2">
 407:                 Upload
 408:               </h3>
 409:               <p class="text-slate-600 dark:text-slate-400 text-sm">
 410:                 Envie sua gravação de áudio ou vídeo
 411:               </p>
 412:             </div>
 413:           </div>
 414:           <!-- Step 2 -->
 415:           <div class="relative group" data-animate>
 416:             <div class="text-center">
 417:               <div class="relative inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-cyan-100 dark:bg-cyan-900/30 text-cyan-600 dark:text-cyan-400 mb-4 group-hover:scale-110 group-hover:shadow-lg group-hover:shadow-cyan-500/25 transition-all duration-300">
 418:                 <.icon name="hero-document-text" class="h-8 w-8" />
 419:                 <span class="absolute -top-2 -right-2 w-6 h-6 bg-cyan-600 text-white text-xs font-bold rounded-full flex items-center justify-center">
 420:                   2
 421:                 </span>
 422:               </div>
 423:               <div class="absolute top-8 left-full w-full h-0.5 bg-gradient-to-r from-cyan-300 to-transparent dark:from-cyan-700 hidden lg:block" />
 424:               <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-2">
 425:                 Transcrição
 426:               </h3>
 427:               <p class="text-slate-600 dark:text-slate-400 text-sm">
 428:                 IA transcreve automaticamente o conteúdo
 429:               </p>
 430:             </div>
 431:           </div>
 432:           <!-- Step 3 -->
 433:           <div class="relative group" data-animate>
 434:             <div class="text-center">
 435:               <div class="relative inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 mb-4 group-hover:scale-110 group-hover:shadow-lg group-hover:shadow-emerald-500/25 transition-all duration-300">
 436:                 <.icon name="hero-academic-cap" class="h-8 w-8" />
 437:                 <span class="absolute -top-2 -right-2 w-6 h-6 bg-emerald-600 text-white text-xs font-bold rounded-full flex items-center justify-center">
 438:                   3
 439:                 </span>
 440:               </div>
 441:               <div class="absolute top-8 left-full w-full h-0.5 bg-gradient-to-r from-emerald-300 to-transparent dark:from-emerald-700 hidden lg:block" />
 442:               <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-2">
 443:                 Análise
 444:               </h3>
 445:               <p class="text-slate-600 dark:text-slate-400 text-sm">
 446:                 Avaliação pedagógica baseada na BNCC
 447:               </p>
 448:             </div>
 449:           </div>
 450:           <!-- Step 4 -->
 451:           <div class="relative group" data-animate>
 452:             <div class="text-center">
 453:               <div class="relative inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 mb-4 group-hover:scale-110 group-hover:shadow-lg group-hover:shadow-amber-500/25 transition-all duration-300">
 454:                 <.icon name="hero-light-bulb" class="h-8 w-8" />
 455:                 <span class="absolute -top-2 -right-2 w-6 h-6 bg-amber-600 text-white text-xs font-bold rounded-full flex items-center justify-center">
 456:                   4
 457:                 </span>
 458:               </div>
 459:               <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-2">
 460:                 Plano de Ação
 461:               </h3>
 462:               <p class="text-slate-600 dark:text-slate-400 text-sm">
 463:                 Receba sugestões de melhorias personalizadas
 464:               </p>
 465:             </div>
 466:           </div>
 467:         </div>
 468:       </div>
 469:     </section>
 470:     """
 471:   end
 472: 
 473:   # ============================================================================
 474:   # FEATURE CARD
 475:   # ============================================================================
 476: 
 477:   @doc """
 478:   Renders a feature card.
 479: 
 480:   ## Examples
 481: 
 482:       <.feature_card
 483:         icon="hero-bolt"
 484:         title="Rápido"
 485:         description="Análise em minutos"
 486:         stat="99%"
 487:         stat_label="Precisão"
 488:         color="blue"
 489:       />
 490:   """
 491:   attr :icon, :string, required: true
 492:   attr :title, :string, required: true
 493:   attr :description, :string, required: true
 494:   attr :stat, :string, default: nil
 495:   attr :stat_label, :string, default: nil
 496:   attr :color, :string, default: "blue", values: ~w(blue green yellow red purple)
 497:   attr :class, :string, default: nil
 498: 
 499:   def feature_card(assigns) do
 500:     ~H"""
 501:     <div
 502:       class={[
 503:         "group relative bg-white dark:bg-slate-800 rounded-xl sm:rounded-2xl p-5 sm:p-8",
 504:         "border border-slate-200/50 dark:border-slate-700/50",
 505:         "hover:border-transparent hover:shadow-xl hover:shadow-slate-200/50 dark:hover:shadow-slate-900/50",
 506:         "transition-all duration-300",
 507:         "overflow-hidden",
 508:         @class
 509:       ]}
 510:       data-animate
 511:     >
 512:       <!-- Colored bottom border on hover -->
 513:       <div class={[
 514:         "absolute bottom-0 left-0 right-0 h-1 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300",
 515:         feature_color_border(@color)
 516:       ]} />
 517:       <!-- Icon -->
 518:       <div class={[
 519:         "inline-flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 rounded-xl mb-4 sm:mb-6 group-hover:scale-110 transition-transform duration-300",
 520:         feature_color_bg(@color)
 521:       ]}>
 522:         <.icon name={@icon} class={"h-6 w-6 sm:h-7 sm:w-7 #{feature_color_text(@color)}"} />
 523:       </div>
 524:       <!-- Content -->
 525:       <h3 class="text-lg sm:text-xl font-semibold text-slate-900 dark:text-white mb-2 sm:mb-3">
 526:         <%= @title %>
 527:       </h3>
 528:       <p class="text-sm sm:text-base text-slate-600 dark:text-slate-400 mb-4 sm:mb-6">
 529:         <%= @description %>
 530:       </p>
 531:       <!-- Stats -->
 532:       <div :if={@stat} class="pt-4 sm:pt-6 border-t border-slate-200 dark:border-slate-700">
 533:         <div class={["text-2xl sm:text-3xl font-bold mb-1", feature_color_text(@color)]}>
 534:           <%= @stat %>
 535:         </div>
 536:         <div class="text-xs sm:text-sm text-slate-500 dark:text-slate-400">
 537:           <%= @stat_label %>
 538:         </div>
 539:       </div>
 540:     </div>
 541:     """
 542:   end
 543: 
 544:   defp feature_color_bg("blue"), do: "bg-teal-100 dark:bg-teal-900/30"
 545:   defp feature_color_bg("green"), do: "bg-emerald-100 dark:bg-emerald-900/30"
 546:   defp feature_color_bg("yellow"), do: "bg-amber-100 dark:bg-amber-900/30"
 547:   defp feature_color_bg("red"), do: "bg-red-100 dark:bg-red-900/30"
 548:   defp feature_color_bg("purple"), do: "bg-violet-100 dark:bg-violet-900/30"
 549:   defp feature_color_bg("teal"), do: "bg-teal-100 dark:bg-teal-900/30"
 550:   defp feature_color_bg("cyan"), do: "bg-cyan-100 dark:bg-cyan-900/30"
 551:   defp feature_color_bg(_), do: "bg-teal-100 dark:bg-teal-900/30"
 552: 
 553:   defp feature_color_text("blue"), do: "text-teal-600 dark:text-teal-400"
 554:   defp feature_color_text("green"), do: "text-emerald-600 dark:text-emerald-400"
 555:   defp feature_color_text("yellow"), do: "text-amber-600 dark:text-amber-400"
 556:   defp feature_color_text("red"), do: "text-red-600 dark:text-red-400"
 557:   defp feature_color_text("purple"), do: "text-violet-600 dark:text-violet-400"
 558:   defp feature_color_text("teal"), do: "text-teal-600 dark:text-teal-400"
 559:   defp feature_color_text("cyan"), do: "text-cyan-600 dark:text-cyan-400"
 560:   defp feature_color_text(_), do: "text-teal-600 dark:text-teal-400"
 561: 
 562:   defp feature_color_border("blue"), do: "bg-gradient-to-r from-teal-500 to-cyan-500"
 563:   defp feature_color_border("green"), do: "bg-gradient-to-r from-emerald-500 to-teal-500"
 564:   defp feature_color_border("yellow"), do: "bg-gradient-to-r from-amber-500 to-amber-600"
 565:   defp feature_color_border("red"), do: "bg-gradient-to-r from-red-500 to-red-600"
 566:   defp feature_color_border("purple"), do: "bg-gradient-to-r from-violet-500 to-violet-600"
 567:   defp feature_color_border("teal"), do: "bg-gradient-to-r from-teal-500 to-cyan-500"
 568:   defp feature_color_border("cyan"), do: "bg-gradient-to-r from-cyan-500 to-teal-500"
 569:   defp feature_color_border(_), do: "bg-gradient-to-r from-teal-500 to-cyan-500"
 570: 
 571:   # ============================================================================
 572:   # FEATURES SECTION
 573:   # ============================================================================
 574: 
 575:   @doc """
 576:   Renders the features section with feature cards.
 577: 
 578:   ## Examples
 579: 
 580:       <.features_section />
 581:   """
 582:   attr :class, :string, default: nil
 583: 
 584:   def features_section(assigns) do
 585:     ~H"""
 586:     <section
 587:       id="features"
 588:       class={[
 589:         "py-16 sm:py-24 bg-gray-50 dark:bg-slate-950",
 590:         @class
 591:       ]}
 592:     >
 593:       <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
 594:         <div class="text-center mb-10 sm:mb-16">
 595:           <h2 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-gray-900 dark:text-white mb-3 sm:mb-4">
 596:             Recursos Poderosos
 597:           </h2>
 598:           <p class="text-base sm:text-xl text-gray-600 dark:text-gray-400 max-w-2xl mx-auto px-2">
 599:             Tudo que você precisa para melhorar suas aulas
 600:           </p>
 601:         </div>
 602: 
 603:         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-8">
 604:           <.feature_card
 605:             icon="hero-microphone"
 606:             title="Transcrição Automática"
 607:             description="IA de última geração transforma áudio em texto com alta precisão, suportando diversos formatos de arquivo."
 608:             stat="99%"
 609:             stat_label="Precisão"
 610:             color="blue"
 611:           />
 612: 
 613:           <.feature_card
 614:             icon="hero-academic-cap"
 615:             title="Feedback BNCC"
 616:             description="Análise pedagógica alinhada à Base Nacional Comum Curricular, identificando competências e habilidades."
 617:             stat="100%"
 618:             stat_label="Alinhado BNCC"
 619:             color="green"
 620:           />
 621: 
 622:           <.feature_card
 623:             icon="hero-shield-check"
 624:             title="Lei 13.185 Anti-Bullying"
 625:             description="Detecção automática de comportamentos inadequados e situações de bullying, garantindo ambiente seguro."
 626:             stat="98%"
 627:             stat_label="Detecção"
 628:             color="red"
 629:           />
 630: 
 631:           <.feature_card
 632:             icon="hero-light-bulb"
 633:             title="Plano de Ação"
 634:             description="Sugestões práticas e personalizadas de melhorias pedagógicas com base na análise da sua aula."
 635:             stat="100%"
 636:             stat_label="Personalizado"
 637:             color="yellow"
 638:           />
 639:         </div>
 640:       </div>
 641:     </section>
 642:     """
 643:   end
 644: 
 645:   # ============================================================================
 646:   # PRICING CARD
 647:   # ============================================================================
 648: 
 649:   @doc """
 650:   Renders a pricing card.
 651: 
 652:   ## Examples
 653: 
 654:       <.pricing_card
 655:         name="Pro"
 656:         price="R$ 49"
 657:         period="/mês"
 658:         description="Para professores individuais"
 659:         features={["20 análises/mês", "Suporte prioritário"]}
 660:         popular={true}
 661:         cta_text="Começar"
 662:         cta_link="/register"
 663:       />
 664:   """
 665:   attr :name, :string, required: true
 666:   attr :price, :string, required: true
 667:   attr :period, :string, default: ""
 668:   attr :description, :string, required: true
 669:   attr :features, :list, required: true
 670:   attr :popular, :boolean, default: false
 671:   attr :cta_text, :string, default: "Começar"
 672:   attr :cta_link, :string, default: "/register"
 673:   attr :class, :string, default: nil
 674: 
 675:   def pricing_card(assigns) do
 676:     ~H"""
 677:     <div
 678:       class={[
 679:         "relative bg-white dark:bg-slate-800 rounded-2xl p-8",
 680:         "border-2",
 681:         @popular && "border-teal-500 shadow-xl shadow-teal-500/10 scale-105",
 682:         !@popular && "border-slate-200 dark:border-slate-700",
 683:         "transition-all duration-300 hover:shadow-lg",
 684:         @class
 685:       ]}
 686:       data-animate
 687:     >
 688:       <!-- Popular badge -->
 689:       <div :if={@popular} class="absolute -top-4 left-1/2 -translate-x-1/2">
 690:         <span class="inline-flex items-center gap-1.5 px-4 py-1.5 rounded-full bg-gradient-to-r from-teal-600 to-cyan-500 text-white text-sm font-semibold shadow-lg">
 691:           <.icon name="hero-star-solid" class="h-4 w-4" /> Mais Popular
 692:         </span>
 693:       </div>
 694:       <!-- Plan name -->
 695:       <h3 class="text-2xl font-bold text-slate-900 dark:text-white mb-2">
 696:         <%= @name %>
 697:       </h3>
 698:       <!-- Description -->
 699:       <p class="text-slate-600 dark:text-slate-400 mb-6">
 700:         <%= @description %>
 701:       </p>
 702:       <!-- Price -->
 703:       <div class="mb-8">
 704:         <div class="flex items-baseline">
 705:           <span class="text-5xl font-bold text-slate-900 dark:text-white">
 706:             <%= @price %>
 707:           </span>
 708:           <span class="ml-2 text-slate-600 dark:text-slate-400">
 709:             <%= @period %>
 710:           </span>
 711:         </div>
 712:       </div>
 713:       <!-- Features -->
 714:       <ul class="space-y-4 mb-8">
 715:         <li :for={feature <- @features} class="flex items-start">
 716:           <.icon
 717:             name="hero-check-circle"
 718:             class="h-6 w-6 text-emerald-500 dark:text-emerald-400 mr-3 flex-shrink-0"
 719:           />
 720:           <span class="text-slate-700 dark:text-slate-300">
 721:             <%= feature %>
 722:           </span>
 723:         </li>
 724:       </ul>
 725:       <!-- CTA -->
 726:       <a
 727:         href={@cta_link}
 728:         class={[
 729:           "block w-full text-center px-6 py-3 rounded-xl font-semibold transition-all duration-200",
 730:           @popular &&
 731:             "bg-teal-600 text-white hover:bg-teal-700 shadow-lg hover:shadow-xl hover:shadow-teal-500/25",
 732:           !@popular &&
 733:             "bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white hover:bg-slate-200 dark:hover:bg-slate-600"
 734:         ]}
 735:       >
 736:         <%= @cta_text %>
 737:       </a>
 738:     </div>
 739:     """
 740:   end
 741: 
 742:   # ============================================================================
 743:   # PRICING SECTION
 744:   # ============================================================================
 745: 
 746:   @doc """
 747:   Renders the pricing section with pricing cards.
 748: 
 749:   ## Examples
 750: 
 751:       <.pricing_section />
 752:   """
 753:   attr :class, :string, default: nil
 754: 
 755:   def pricing_section(assigns) do
 756:     ~H"""
 757:     <section
 758:       id="pricing"
 759:       class={[
 760:         "py-24 bg-white dark:bg-slate-900",
 761:         @class
 762:       ]}
 763:     >
 764:       <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
 765:         <div class="text-center mb-16">
 766:           <!-- Urgency Badge -->
 767:           <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 text-sm font-medium mb-4 animate-pulse">
 768:             <.icon name="hero-fire" class="h-4 w-4" />
 769:             <span>Oferta de Lançamento - 3 créditos grátis!</span>
 770:           </div>
 771:           <h2 class="text-4xl sm:text-5xl font-bold text-gray-900 dark:text-white mb-4">
 772:             Planos e Preços
 773:           </h2>
 774:           <p class="text-xl text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
 775:             Escolha o plano ideal para suas necessidades
 776:           </p>
 777:         </div>
 778: 
 779:         <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
 780:           <.pricing_card
 781:             name="Gratuito"
 782:             price="R$ 0"
 783:             period=""
 784:             description="Para conhecer a plataforma"
 785:             features={[
 786:               "3 creditos gratis ao cadastrar",
 787:               "Transcricao automatica de audio",
 788:               "Analise pedagogica BNCC",
 789:               "Deteccao anti-bullying",
 790:               "Historico de aulas"
 791:             ]}
 792:             cta_text="Comecar Gratis"
 793:             cta_link="/register"
 794:           />
 795: 
 796:           <.pricing_card
 797:             name="Creditos"
 798:             price="R$ 4,90"
 799:             period="/credito"
 800:             description="Pague apenas pelo que usar"
 801:             features={[
 802:               "Compre creditos avulsos",
 803:               "1 credito = 1 analise completa",
 804:               "Sem mensalidade",
 805:               "Creditos nao expiram",
 806:               "Todas as funcionalidades",
 807:               "Suporte por email"
 808:             ]}
 809:             popular={true}
 810:             cta_text="Comprar Creditos"
 811:             cta_link="/register"
 812:           />
 813: 
 814:           <.pricing_card
 815:             name="Escola"
 816:             price="Sob consulta"
 817:             period=""
 818:             description="Para instituicoes de ensino"
 819:             features={[
 820:               "Creditos em volume",
 821:               "Dashboard de coordenacao",
 822:               "Multiplos professores",
 823:               "Relatorios institucionais",
 824:               "Alertas anti-bullying",
 825:               "Suporte dedicado",
 826:               "Treinamento incluso"
 827:             ]}
 828:             cta_text="Falar com Vendas"
 829:             cta_link="mailto:contato@hellen.ai"
 830:           />
 831:         </div>
 832:         <!-- Money Back Guarantee -->
 833:         <div class="mt-12 text-center">
 834:           <div class="inline-flex items-center gap-3 px-6 py-3 rounded-2xl bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800">
 835:             <.icon name="hero-shield-check" class="h-6 w-6 text-emerald-600 dark:text-emerald-400" />
 836:             <span class="text-emerald-700 dark:text-emerald-300 font-medium">
 837:               Garantia de satisfação - Se não gostar, devolvemos seus créditos
 838:             </span>
 839:           </div>
 840:         </div>
 841:       </div>
 842:     </section>
 843:     """
 844:   end
 845: 
 846:   # ============================================================================
 847:   # TESTIMONIAL CARD
 848:   # ============================================================================
 849: 
 850:   @doc """
 851:   Renders a testimonial card.
 852: 
 853:   ## Examples
 854: 
 855:       <.testimonial_card
 856:         quote="Incrível ferramenta!"
 857:         author="Maria Silva"
 858:         role="Professora de Matemática"
 859:       />
 860:   """
 861:   attr :quote, :string, required: true
 862:   attr :author, :string, required: true
 863:   attr :role, :string, required: true
 864:   attr :avatar, :string, default: nil
 865:   attr :class, :string, default: nil
 866: 
 867:   def testimonial_card(assigns) do
 868:     ~H"""
 869:     <div
 870:       class={[
 871:         "bg-white dark:bg-slate-800 rounded-2xl p-8",
 872:         "border border-slate-200/50 dark:border-slate-700/50",
 873:         "hover:shadow-xl hover:shadow-slate-200/50 dark:hover:shadow-slate-900/50 transition-all duration-300",
 874:         @class
 875:       ]}
 876:       data-animate
 877:     >
 878:       <!-- Quote icon -->
 879:       <div class="mb-6">
 880:         <.icon name="hero-chat-bubble-left-right" class="h-10 w-10 text-teal-600 dark:text-teal-400" />
 881:       </div>
 882:       <!-- Stars -->
 883:       <div class="flex items-center gap-0.5 mb-4 text-amber-400">
 884:         <.icon name="hero-star-solid" class="h-5 w-5" />
 885:         <.icon name="hero-star-solid" class="h-5 w-5" />
 886:         <.icon name="hero-star-solid" class="h-5 w-5" />
 887:         <.icon name="hero-star-solid" class="h-5 w-5" />
 888:         <.icon name="hero-star-solid" class="h-5 w-5" />
 889:       </div>
 890:       <!-- Quote -->
 891:       <blockquote class="text-lg text-slate-700 dark:text-slate-300 mb-6 leading-relaxed">
 892:         "<%= @quote %>"
 893:       </blockquote>
 894:       <!-- Author -->
 895:       <div class="flex items-center">
 896:         <div
 897:           :if={@avatar}
 898:           class="w-12 h-12 rounded-full bg-gradient-to-br from-teal-400 to-cyan-400 mr-4"
 899:         />
 900:         <div
 901:           :if={!@avatar}
 902:           class="w-12 h-12 rounded-xl bg-gradient-to-br from-teal-500 to-cyan-500 flex items-center justify-center text-white font-bold text-lg mr-4 shadow-lg"
 903:         >
 904:           <%= String.first(@author) %>
 905:         </div>
 906:         <div>
 907:           <div class="font-semibold text-slate-900 dark:text-white">
 908:             <%= @author %>
 909:           </div>
 910:           <div class="text-sm text-slate-600 dark:text-slate-400">
 911:             <%= @role %>
 912:           </div>
 913:         </div>
 914:       </div>
 915:     </div>
 916:     """
 917:   end
 918: 
 919:   # ============================================================================
 920:   # TESTIMONIALS SECTION
 921:   # ============================================================================
 922: 
 923:   @doc """
 924:   Renders the testimonials section.
 925: 
 926:   ## Examples
 927: 
 928:       <.testimonials_section />
 929:   """
 930:   attr :class, :string, default: nil
 931: 
 932:   def testimonials_section(assigns) do
 933:     ~H"""
 934:     <section
 935:       id="testimonials"
 936:       class={[
 937:         "py-24 bg-gray-50 dark:bg-slate-950",
 938:         @class
 939:       ]}
 940:     >
 941:       <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
 942:         <div class="text-center mb-16">
 943:           <h2 class="text-4xl sm:text-5xl font-bold text-gray-900 dark:text-white mb-4">
 944:             O que dizem os professores
 945:           </h2>
 946:           <p class="text-xl text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
 947:             Depoimentos de educadores que transformaram suas aulas
 948:           </p>
 949:         </div>
 950: 
 951:         <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
 952:           <.testimonial_card
 953:             quote="A Hellen AI revolucionou minha forma de ensinar. Agora consigo identificar pontos de melhoria que antes passavam despercebidos. Recomendo para todos os colegas!"
 954:             author="Maria Silva"
 955:             role="Professora de Matemática - 5º ano"
 956:           />
 957: 
 958:           <.testimonial_card
 959:             quote="A análise baseada na BNCC me ajuda a garantir que estou cumprindo todos os objetivos de aprendizagem. O feedback é preciso e muito útil para meu planejamento."
 960:             author="João Santos"
 961:             role="Professor de Ciências - 8º ano"
 962:           />
 963: 
 964:           <.testimonial_card
 965:             quote="Como coordenadora, consigo acompanhar o desenvolvimento dos professores e oferecer suporte direcionado. A plataforma é intuitiva e os relatórios são excelentes."
 966:             author="Ana Paula Costa"
 967:             role="Coordenadora Pedagógica"
 968:           />
 969:         </div>
 970:       </div>
 971:     </section>
 972:     """
 973:   end
 974: 
 975:   # ============================================================================
 976:   # FAQ SECTION
 977:   # ============================================================================
 978: 
 979:   @doc """
 980:   Renders the FAQ section.
 981: 
 982:   ## Examples
 983: 
 984:       <.faq_section />
 985:   """
 986:   attr :class, :string, default: nil
 987: 
 988:   def faq_section(assigns) do
 989:     faqs = [
 990:       %{
 991:         question: "Como funciona a análise de aulas?",
 992:         answer:
 993:           "Você envia um áudio ou vídeo da sua aula, nossa IA transcreve automaticamente e analisa o conteúdo com base na BNCC e Lei 13.185. Em menos de 5 minutos você recebe um relatório completo com pontuação, pontos fortes, sugestões de melhoria e competências identificadas."
 994:       },
 995:       %{
 996:         question: "Preciso pagar mensalidade?",
 997:         answer:
 998:           "Não! Trabalhamos com sistema de créditos. Você compra créditos quando precisar e eles nunca expiram. 1 crédito = 1 análise completa. Ao se cadastrar você ganha 3 créditos grátis para experimentar."
 999:       },
1000:       %{
1001:         question: "Meus dados estão seguros?",
1002:         answer:
1003:           "Sim! Utilizamos criptografia de ponta a ponta e seguimos rigorosamente a LGPD. Seus áudios são processados e depois automaticamente excluídos. Apenas os relatórios ficam salvos na sua conta."
1004:       },
1005:       %{
1006:         question: "Funciona com qualquer disciplina?",
1007:         answer:
1008:           "Sim! A Hellen AI funciona com todas as disciplinas e níveis de ensino. Nossa IA foi treinada com base na BNCC completa, abrangendo desde a Educação Infantil até o Ensino Médio."
1009:       },
1010:       %{
1011:         question: "Posso usar em reuniões pedagógicas?",
1012:         answer:
1013:           "Com certeza! Muitos coordenadores usam para analisar aulas observadas. O plano Escola inclui dashboard de coordenação com visão consolidada de todos os professores."
1014:       },
1015:       %{
1016:         question: "E se eu não gostar do serviço?",
1017:         answer:
1018:           "Oferecemos garantia de satisfação. Se você não ficar satisfeito com a análise, devolvemos seus créditos. Simples assim."
1019:       }
1020:     ]
1021: 
1022:     assigns = assign(assigns, :faqs, faqs)
1023: 
1024:     ~H"""
1025:     <section
1026:       id="faq"
1027:       class={[
1028:         "py-24 bg-slate-50 dark:bg-slate-950",
1029:         @class
1030:       ]}
1031:     >
1032:       <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
1033:         <div class="text-center mb-16">
1034:           <div class="inline-flex items-center px-3 py-1 rounded-full bg-teal-100 dark:bg-teal-900/30 text-teal-700 dark:text-teal-300 text-sm font-medium mb-4">
1035:             Dúvidas Frequentes
1036:           </div>
1037:           <h2 class="text-4xl sm:text-5xl font-bold text-slate-900 dark:text-white mb-4 tracking-tight">
1038:             Perguntas Frequentes
1039:           </h2>
1040:           <p class="text-xl text-slate-600 dark:text-slate-400">
1041:             Tire suas dúvidas sobre a plataforma
1042:           </p>
1043:         </div>
1044: 
1045:         <div class="space-y-4">
1046:           <%= for faq <- @faqs do %>
1047:             <div
1048:               class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 overflow-hidden"
1049:               data-animate
1050:             >
1051:               <details class="group">
1052:                 <summary class="flex items-center justify-between p-6 cursor-pointer list-none">
1053:                   <h3 class="text-lg font-semibold text-slate-900 dark:text-white pr-4">
1054:                     <%= faq.question %>
1055:                   </h3>
1056:                   <div class="flex-shrink-0 w-8 h-8 rounded-full bg-teal-100 dark:bg-teal-900/30 flex items-center justify-center text-teal-600 dark:text-teal-400 group-open:rotate-180 transition-transform duration-200">
1057:                     <.icon name="hero-chevron-down" class="h-5 w-5" />
1058:                   </div>
1059:                 </summary>
1060:                 <div class="px-6 pb-6 pt-0">
1061:                   <p class="text-slate-600 dark:text-slate-400 leading-relaxed">
1062:                     <%= faq.answer %>
1063:                   </p>
1064:                 </div>
1065:               </details>
1066:             </div>
1067:           <% end %>
1068:         </div>
1069: 
1070:         <div class="mt-12 text-center">
1071:           <p class="text-slate-600 dark:text-slate-400 mb-4">
1072:             Ainda tem dúvidas?
1073:           </p>
1074:           <a
1075:             href="https://wa.me/5515997701743"
1076:             target="_blank"
1077:             rel="noopener noreferrer"
1078:             class="inline-flex items-center gap-2 px-6 py-3 text-white bg-green-600 hover:bg-green-700 rounded-xl font-semibold transition-all duration-200 shadow-lg hover:shadow-xl"
1079:           >
1080:             <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
1081:               <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z" />
1082:             </svg>
1083:             Falar pelo WhatsApp
1084:           </a>
1085:         </div>
1086:       </div>
1087:     </section>
1088:     """
1089:   end
1090: 
1091:   # ============================================================================
1092:   # CTA SECTION
1093:   # ============================================================================
1094: 
1095:   @doc """
1096:   Renders the final call-to-action section.
1097: 
1098:   ## Examples
1099: 
1100:       <.cta_section />
1101:   """
1102:   attr :class, :string, default: nil
1103: 
1104:   def cta_section(assigns) do
1105:     ~H"""
1106:     <section class={[
1107:       "py-24 bg-gradient-to-br from-teal-600 to-cyan-600 dark:from-teal-900 dark:to-cyan-900 relative overflow-hidden",
1108:       @class
1109:     ]}>
1110:       <!-- Background pattern -->
1111:       <div class="absolute inset-0 opacity-10">
1112:         <div class="absolute top-0 left-0 w-96 h-96 bg-white rounded-full blur-3xl" />
1113:         <div class="absolute bottom-0 right-0 w-96 h-96 bg-white rounded-full blur-3xl" />
1114:       </div>
1115:       <!-- Grid pattern -->
1116:       <div class="absolute inset-0 bg-[linear-gradient(to_right,#fff1_1px,transparent_1px),linear-gradient(to_bottom,#fff1_1px,transparent_1px)] bg-[size:4rem_4rem]" />
1117: 
1118:       <div class="relative max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
1119:         <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/20 backdrop-blur-sm mb-6">
1120:           <span class="relative flex h-2 w-2">
1121:             <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-75">
1122:             </span>
1123:             <span class="relative inline-flex rounded-full h-2 w-2 bg-white"></span>
1124:           </span>
1125:           <span class="text-sm font-medium text-white">Comece agora, é grátis!</span>
1126:         </div>
1127: 
1128:         <h2 class="text-4xl sm:text-5xl font-bold text-white mb-6 tracking-tight">
1129:           Pronto para transformar suas aulas?
1130:         </h2>
1131:         <p class="text-xl text-teal-100 mb-10 max-w-2xl mx-auto">
1132:           Junte-se a centenas de professores que já estão melhorando suas práticas pedagógicas com a Hellen AI.
1133:         </p>
1134: 
1135:         <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
1136:           <a
1137:             href="/register"
1138:             class="group inline-flex items-center justify-center px-8 py-4 text-lg font-semibold text-teal-600 bg-white hover:bg-slate-50 rounded-xl transition-all duration-200 shadow-xl hover:shadow-2xl hover:scale-105 w-full sm:w-auto"
1139:           >
1140:             Criar Conta Gratuita
1141:             <.icon
1142:               name="hero-arrow-right"
1143:               class="ml-2 h-5 w-5 group-hover:translate-x-1 transition-transform"
1144:             />
1145:           </a>
1146: 
1147:           <a
1148:             href="#contact"
1149:             class="inline-flex items-center justify-center px-8 py-4 text-lg font-semibold text-white bg-white/10 hover:bg-white/20 backdrop-blur-sm border-2 border-white/30 rounded-xl transition-all duration-200 w-full sm:w-auto"
1150:           >
1151:             <.icon name="hero-chat-bubble-left-right" class="mr-2 h-5 w-5" /> Falar com Vendas
1152:           </a>
1153:         </div>
1154: 
1155:         <div class="mt-8 flex flex-wrap justify-center gap-4 text-sm text-teal-100">
1156:           <span class="flex items-center gap-1.5">
1157:             <.icon name="hero-check-circle" class="h-5 w-5 text-white" /> Sem cartão de crédito
1158:           </span>
1159:           <span class="flex items-center gap-1.5">
1160:             <.icon name="hero-check-circle" class="h-5 w-5 text-white" /> 3 créditos grátis
1161:           </span>
1162:           <span class="flex items-center gap-1.5">
1163:             <.icon name="hero-check-circle" class="h-5 w-5 text-white" /> Pague apenas pelo que usar
1164:           </span>
1165:         </div>
1166:       </div>
1167:     </section>
1168:     """
1169:   end
1170: 
1171:   # ============================================================================
1172:   # FOOTER
1173:   # ============================================================================
1174: 
1175:   @doc """
1176:   Renders the landing page footer.
1177: 
1178:   ## Examples
1179: 
1180:       <.landing_footer />
1181:   """
1182:   attr :class, :string, default: nil
1183: 
1184:   def landing_footer(assigns) do
1185:     ~H"""
1186:     <footer
1187:       id="contact"
1188:       class={[
1189:         "bg-slate-900 dark:bg-slate-950 text-slate-300 py-10 sm:py-12",
1190:         @class
1191:       ]}
1192:     >
1193:       <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
1194:         <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 gap-8 mb-8">
1195:           <!-- Logo & Description -->
1196:           <div class="col-span-2">
1197:             <div class="flex items-center mb-4">
1198:               <span class="text-xl sm:text-2xl font-bold bg-gradient-to-r from-teal-400 to-cyan-400 bg-clip-text text-transparent">
1199:                 Hellen
1200:               </span>
1201:               <span class="ml-1.5 text-xs font-semibold text-slate-400">
1202:                 AI
1203:               </span>
1204:             </div>
1205:             <p class="text-sm sm:text-base text-slate-400 max-w-md mb-6">
1206:               Análise pedagógica inteligente para professores que buscam excelência. Baseado na BNCC e Lei 13.185.
1207:             </p>
1208:             <div class="flex gap-4">
1209:               <a
1210:                 href="mailto:contato@hellen.ai"
1211:                 class="w-10 h-10 rounded-xl bg-slate-800 hover:bg-teal-600 flex items-center justify-center text-slate-400 hover:text-white transition-all duration-200"
1212:                 title="Email"
1213:               >
1214:                 <.icon name="hero-envelope" class="h-5 w-5" />
1215:               </a>
1216:             </div>
1217:           </div>
1218:           <!-- Links -->
1219:           <div>
1220:             <h3 class="text-white font-semibold mb-3 sm:mb-4 text-sm sm:text-base">Plataforma</h3>
1221:             <ul class="space-y-1.5 sm:space-y-2">
1222:               <li>
1223:                 <a
1224:                   href="#features"
1225:                   class="text-sm text-slate-400 hover:text-teal-400 transition-colors"
1226:                 >
1227:                   Recursos
1228:                 </a>
1229:               </li>
1230:               <li>
1231:                 <a
1232:                   href="#pricing"
1233:                   class="text-sm text-slate-400 hover:text-teal-400 transition-colors"
1234:                 >
1235:                   Precos
1236:                 </a>
1237:               </li>
1238:               <li>
1239:                 <a
1240:                   href="#testimonials"
1241:                   class="text-sm text-slate-400 hover:text-teal-400 transition-colors"
1242:                 >
1243:                   Depoimentos
1244:                 </a>
1245:               </li>
1246:               <li>
1247:                 <a
1248:                   href="/register"
1249:                   class="text-sm text-slate-400 hover:text-teal-400 transition-colors"
1250:                 >
1251:                   Criar Conta
1252:                 </a>
1253:               </li>
1254:             </ul>
1255:           </div>
1256:           <!-- Contato -->
1257:           <div>
1258:             <h3 class="text-white font-semibold mb-3 sm:mb-4 text-sm sm:text-base">Contato</h3>
1259:             <ul class="space-y-1.5 sm:space-y-2">
1260:               <li>
1261:                 <a
1262:                   href="/support"
1263:                   class="text-sm text-slate-400 hover:text-teal-400 transition-colors"
1264:                 >
1265:                   Suporte
1266:                 </a>
1267:               </li>
1268:               <li>
1269:                 <a
1270:                   href="mailto:contato@hellen.ai"
1271:                   class="text-sm text-slate-400 hover:text-teal-400 transition-colors"
1272:                 >
1273:                   contato@hellen.ai
1274:                 </a>
1275:               </li>
1276:               <li>
1277:                 <a
1278:                   href="https://wa.me/5515997701743"
1279:                   target="_blank"
1280:                   rel="noopener noreferrer"
1281:                   class="text-sm text-slate-400 hover:text-green-400 transition-colors flex items-center gap-1.5"
1282:                 >
1283:                   <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
1284:                     <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z" />
1285:                   </svg>
1286:                   WhatsApp
1287:                 </a>
1288:               </li>
1289:             </ul>
1290:           </div>
1291:         </div>
1292:         <!-- Bottom bar -->
1293:         <div class="pt-6 sm:pt-8 border-t border-slate-800">
1294:           <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
1295:             <p class="text-xs sm:text-sm text-slate-400 text-center sm:text-left">
1296:               © 2025 Hellen AI. Todos os direitos reservados.
1297:             </p>
1298:             <div class="flex items-center gap-4 text-xs sm:text-sm">
1299:               <a href="/terms" class="text-slate-400 hover:text-teal-400 transition-colors">
1300:                 Termos de Uso
1301:               </a>
1302:               <a href="/privacy" class="text-slate-400 hover:text-teal-400 transition-colors">
1303:                 Privacidade
1304:               </a>
1305:               <a href="/support" class="text-slate-400 hover:text-teal-400 transition-colors">
1306:                 Suporte
1307:               </a>
1308:             </div>
1309:           </div>
1310:         </div>
1311:       </div>
1312:     </footer>
1313:     """
1314:   end
1315: end
````

## File: lib/hellen_web/components/ui_components.ex
````elixir
  1: defmodule HellenWeb.UIComponents do
  2:   @moduledoc """
  3:   UI components using LiveView 1.1 patterns.
  4:   2025 Design System with teal/sage/mint palette.
  5: 
  6:   Includes:
  7:   - lesson_card - Lesson display card
  8:   - page_header - Page title with actions
  9:   - score_display - Circular score indicator
 10:   - analysis_section - Analysis content section
 11:   - quick_action_card - Dashboard quick action buttons
 12:   """
 13:   use Phoenix.Component
 14: 
 15:   import HellenWeb.CoreComponents
 16: 
 17:   use Phoenix.VerifiedRoutes,
 18:     endpoint: HellenWeb.Endpoint,
 19:     router: HellenWeb.Router,
 20:     statics: HellenWeb.static_paths()
 21: 
 22:   # ============================================================================
 23:   # LESSON CARD (2025 Design)
 24:   # ============================================================================
 25: 
 26:   @doc """
 27:   Renders a modern lesson card for lists.
 28: 
 29:   ## Examples
 30: 
 31:       <.lesson_card lesson={@lesson} />
 32:   """
 33:   attr :lesson, :map, required: true
 34: 
 35:   def lesson_card(assigns) do
 36:     ~H"""
 37:     <.link navigate={~p"/lessons/#{@lesson.id}"} class="block group">
 38:       <div class="bg-white dark:bg-slate-800 rounded-xl shadow-card border border-slate-200/50 dark:border-slate-700/50 p-5 hover:shadow-elevated hover:border-teal-300/50 dark:hover:border-teal-600/50 transition-all duration-300">
 39:         <div class="flex justify-between items-start gap-4">
 40:           <div class="flex-1 min-w-0">
 41:             <div class="flex items-center gap-2 mb-1">
 42:               <.badge variant={status_variant(@lesson.status)}>
 43:                 <%= status_label(@lesson.status) %>
 44:               </.badge>
 45:             </div>
 46:             <h3 class="text-base font-semibold text-slate-900 dark:text-white truncate group-hover:text-teal-600 dark:group-hover:text-teal-400 transition-colors">
 47:               <%= @lesson.title || "Aula sem titulo" %>
 48:             </h3>
 49:             <p class="mt-1 text-sm text-slate-500 dark:text-slate-400 truncate">
 50:               <%= @lesson.subject || "Disciplina nao informada" %>
 51:               <%= if @lesson.grade, do: " · #{@lesson.grade}" %>
 52:             </p>
 53:           </div>
 54: 
 55:           <div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
 56:             <div class="w-8 h-8 rounded-lg bg-teal-500/10 dark:bg-teal-500/20 flex items-center justify-center">
 57:               <.icon name="hero-arrow-right" class="h-4 w-4 text-teal-600 dark:text-teal-400" />
 58:             </div>
 59:           </div>
 60:         </div>
 61: 
 62:         <div class="mt-4 flex items-center gap-4 text-xs text-slate-500 dark:text-slate-400">
 63:           <span class="flex items-center gap-1.5">
 64:             <.icon name="hero-calendar" class="h-3.5 w-3.5" />
 65:             <%= format_date(@lesson.inserted_at) %>
 66:           </span>
 67: 
 68:           <span :if={@lesson.duration_seconds} class="flex items-center gap-1.5">
 69:             <.icon name="hero-clock" class="h-3.5 w-3.5" />
 70:             <%= format_duration(@lesson.duration_seconds) %>
 71:           </span>
 72: 
 73:           <span
 74:             :if={@lesson.overall_score}
 75:             class="flex items-center gap-1.5 text-teal-600 dark:text-teal-400 font-medium"
 76:           >
 77:             <.icon name="hero-chart-bar" class="h-3.5 w-3.5" />
 78:             <%= round(@lesson.overall_score * 100) %>%
 79:           </span>
 80:         </div>
 81:       </div>
 82:     </.link>
 83:     """
 84:   end
 85: 
 86:   # Helper functions used in HEEx templates (public to avoid compiler warnings)
 87:   @doc false
 88:   def status_variant("pending"), do: "pending"
 89:   def status_variant("transcribing"), do: "processing"
 90:   def status_variant("transcribed"), do: "processing"
 91:   def status_variant("analyzing"), do: "processing"
 92:   def status_variant("completed"), do: "completed"
 93:   def status_variant("failed"), do: "failed"
 94:   def status_variant(_), do: "default"
 95: 
 96:   @doc false
 97:   def status_label("pending"), do: "Pendente"
 98:   def status_label("transcribing"), do: "Transcrevendo"
 99:   def status_label("transcribed"), do: "Analisando"
100:   def status_label("analyzing"), do: "Analisando"
101:   def status_label("completed"), do: "Concluido"
102:   def status_label("failed"), do: "Falhou"
103:   def status_label(_), do: "Desconhecido"
104: 
105:   @doc false
106:   def format_date(datetime) do
107:     Calendar.strftime(datetime, "%d/%m/%Y")
108:   end
109: 
110:   @doc false
111:   def format_datetime(datetime) do
112:     Calendar.strftime(datetime, "%d/%m/%Y as %H:%M")
113:   end
114: 
115:   @doc false
116:   def format_duration(seconds) when is_integer(seconds) do
117:     minutes = div(seconds, 60)
118:     secs = rem(seconds, 60)
119:     if minutes > 0, do: "#{minutes}min #{secs}s", else: "#{secs}s"
120:   end
121: 
122:   def format_duration(_), do: "-"
123: 
124:   # ============================================================================
125:   # PAGE HEADER
126:   # ============================================================================
127: 
128:   @doc """
129:   Renders a page header with title, description and optional actions.
130: 
131:   ## Examples
132: 
133:       <.page_header title="Dashboard" description="Suas aulas e analises">
134:         <:actions>
135:           <.button>Nova Aula</.button>
136:         </:actions>
137:       </.page_header>
138:   """
139:   attr :title, :string, required: true
140:   attr :description, :string, default: nil
141:   attr :icon, :string, default: nil
142: 
143:   slot :actions
144: 
145:   def page_header(assigns) do
146:     ~H"""
147:     <div class="flex flex-col sm:flex-row justify-between items-start gap-4 mb-8">
148:       <div class="flex items-start gap-4">
149:         <div
150:           :if={@icon}
151:           class="flex-shrink-0 w-12 h-12 rounded-xl bg-teal-500/10 dark:bg-teal-500/20 flex items-center justify-center"
152:         >
153:           <.icon name={@icon} class="h-6 w-6 text-teal-600 dark:text-teal-400" />
154:         </div>
155:         <div>
156:           <h1 class="text-2xl font-bold text-slate-900 dark:text-white tracking-tight">
157:             <%= @title %>
158:           </h1>
159:           <p :if={@description} class="mt-1 text-sm text-slate-500 dark:text-slate-400">
160:             <%= @description %>
161:           </p>
162:         </div>
163:       </div>
164:       <div :if={@actions != []} class="flex items-center gap-3 flex-shrink-0">
165:         <%= render_slot(@actions) %>
166:       </div>
167:     </div>
168:     """
169:   end
170: 
171:   # ============================================================================
172:   # SCORE DISPLAY (2025 Design)
173:   # ============================================================================
174: 
175:   @doc """
176:   Renders a score display with circular progress indicator.
177: 
178:   ## Examples
179: 
180:       <.score_display score={85} label="Pontuacao Geral" />
181:   """
182:   attr :score, :integer, required: true
183:   attr :label, :string, default: nil
184:   attr :size, :string, default: "lg", values: ~w(sm md lg)
185: 
186:   def score_display(assigns) do
187:     ~H"""
188:     <div class="text-center">
189:       <div class={["relative inline-flex items-center justify-center", score_size(@size)]}>
190:         <svg class="transform -rotate-90" viewBox="0 0 36 36">
191:           <path
192:             class="text-slate-200 dark:text-slate-700"
193:             stroke="currentColor"
194:             stroke-width="3"
195:             fill="none"
196:             d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
197:           />
198:           <path
199:             class={score_color(@score)}
200:             stroke="currentColor"
201:             stroke-width="3"
202:             stroke-linecap="round"
203:             fill="none"
204:             stroke-dasharray={"#{@score}, 100"}
205:             d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
206:           />
207:         </svg>
208:         <span class={["absolute font-bold", score_text_size(@size), score_color(@score)]}>
209:           <%= @score %>%
210:         </span>
211:       </div>
212:       <p :if={@label} class="mt-2 text-sm text-slate-500 dark:text-slate-400"><%= @label %></p>
213:     </div>
214:     """
215:   end
216: 
217:   defp score_size("sm"), do: "w-16 h-16"
218:   defp score_size("md"), do: "w-24 h-24"
219:   defp score_size("lg"), do: "w-32 h-32"
220: 
221:   defp score_text_size("sm"), do: "text-sm"
222:   defp score_text_size("md"), do: "text-xl"
223:   defp score_text_size("lg"), do: "text-2xl"
224: 
225:   defp score_color(score) when score >= 80, do: "text-teal-500"
226:   defp score_color(score) when score >= 60, do: "text-sage-500"
227:   defp score_color(score) when score >= 40, do: "text-ochre-500"
228:   defp score_color(_), do: "text-red-500"
229: 
230:   # ============================================================================
231:   # ANALYSIS SECTION
232:   # ============================================================================
233: 
234:   @doc """
235:   Renders an analysis section with icon and title.
236: 
237:   ## Examples
238: 
239:       <.analysis_section title="Pontos Fortes" icon="hero-check-circle">
240:         Content here
241:       </.analysis_section>
242:   """
243:   attr :title, :string, required: true
244:   attr :icon, :string, required: true
245:   attr :class, :string, default: nil
246:   attr :variant, :string, default: "default", values: ~w(default success warning error info)
247: 
248:   slot :inner_block, required: true
249: 
250:   def analysis_section(assigns) do
251:     ~H"""
252:     <div class={[
253:       "rounded-xl p-5 border",
254:       analysis_section_bg(@variant),
255:       @class
256:     ]}>
257:       <div class="flex items-center gap-2 mb-3">
258:         <.icon name={@icon} class={"h-5 w-5 #{analysis_section_icon(@variant)}"} />
259:         <h4 class="font-semibold text-slate-900 dark:text-white"><%= @title %></h4>
260:       </div>
261:       <div class="text-sm text-slate-700 dark:text-slate-300">
262:         <%= render_slot(@inner_block) %>
263:       </div>
264:     </div>
265:     """
266:   end
267: 
268:   defp analysis_section_bg("success"),
269:     do: "bg-emerald-50 dark:bg-emerald-900/20 border-emerald-200 dark:border-emerald-800/50"
270: 
271:   defp analysis_section_bg("warning"),
272:     do: "bg-amber-50 dark:bg-amber-900/20 border-amber-200 dark:border-amber-800/50"
273: 
274:   defp analysis_section_bg("error"),
275:     do: "bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800/50"
276: 
277:   defp analysis_section_bg("info"),
278:     do: "bg-cyan-50 dark:bg-cyan-900/20 border-cyan-200 dark:border-cyan-800/50"
279: 
280:   defp analysis_section_bg(_),
281:     do: "bg-slate-50 dark:bg-slate-800/50 border-slate-200 dark:border-slate-700/50"
282: 
283:   defp analysis_section_icon("success"), do: "text-emerald-600 dark:text-emerald-400"
284:   defp analysis_section_icon("warning"), do: "text-amber-600 dark:text-amber-400"
285:   defp analysis_section_icon("error"), do: "text-red-600 dark:text-red-400"
286:   defp analysis_section_icon("info"), do: "text-cyan-600 dark:text-cyan-400"
287:   defp analysis_section_icon(_), do: "text-teal-600 dark:text-teal-400"
288: 
289:   # ============================================================================
290:   # QUICK ACTION CARD
291:   # ============================================================================
292: 
293:   @doc """
294:   Renders a quick action card for dashboards.
295: 
296:   ## Examples
297: 
298:       <.quick_action_card
299:         title="Nova Aula"
300:         description="Enviar gravacao para analise"
301:         icon="hero-plus-circle"
302:         href={~p"/lessons/new"}
303:         variant="primary"
304:       />
305:   """
306:   attr :title, :string, required: true
307:   attr :description, :string, default: nil
308:   attr :icon, :string, required: true
309:   attr :href, :string, required: true
310:   attr :variant, :string, default: "default", values: ~w(primary default highlight)
311: 
312:   def quick_action_card(assigns) do
313:     ~H"""
314:     <.link navigate={@href} class="block group">
315:       <div class={[
316:         "rounded-xl p-6 transition-all duration-300",
317:         quick_action_variant(@variant)
318:       ]}>
319:         <div class="flex items-center gap-4">
320:           <div class={[
321:             "flex-shrink-0 p-3 rounded-xl transition-transform duration-300 group-hover:scale-110",
322:             quick_action_icon_bg(@variant)
323:           ]}>
324:             <.icon name={@icon} class={"h-7 w-7 #{quick_action_icon_color(@variant)}"} />
325:           </div>
326:           <div class="flex-1 min-w-0">
327:             <h3 class={["font-semibold text-lg", quick_action_title(@variant)]}>
328:               <%= @title %>
329:             </h3>
330:             <p :if={@description} class={["text-sm", quick_action_desc(@variant)]}>
331:               <%= @description %>
332:             </p>
333:           </div>
334:           <.icon
335:             name="hero-chevron-right"
336:             class={"h-5 w-5 #{quick_action_icon_color(@variant)} opacity-0 group-hover:opacity-100 transition-opacity"}
337:           />
338:         </div>
339:       </div>
340:     </.link>
341:     """
342:   end
343: 
344:   defp quick_action_variant("primary"),
345:     do:
346:       "bg-gradient-to-br from-teal-500 to-teal-600 shadow-lg hover:shadow-xl hover:shadow-teal-500/25"
347: 
348:   defp quick_action_variant("highlight"),
349:     do:
350:       "bg-white dark:bg-slate-800 border-2 border-amber-300 dark:border-amber-600 hover:shadow-lg"
351: 
352:   defp quick_action_variant(_),
353:     do:
354:       "bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:border-teal-300 dark:hover:border-teal-600 hover:shadow-lg"
355: 
356:   defp quick_action_icon_bg("primary"), do: "bg-white/20"
357:   defp quick_action_icon_bg("highlight"), do: "bg-amber-100 dark:bg-amber-900/30"
358:   defp quick_action_icon_bg(_), do: "bg-teal-100 dark:bg-teal-900/30"
359: 
360:   defp quick_action_icon_color("primary"), do: "text-white"
361:   defp quick_action_icon_color("highlight"), do: "text-amber-600 dark:text-amber-400"
362:   defp quick_action_icon_color(_), do: "text-teal-600 dark:text-teal-400"
363: 
364:   defp quick_action_title("primary"), do: "text-white"
365:   defp quick_action_title(_), do: "text-slate-900 dark:text-white"
366: 
367:   defp quick_action_desc("primary"), do: "text-white/80"
368:   defp quick_action_desc(_), do: "text-slate-500 dark:text-slate-400"
369: end
````

## File: assets/css/app.css
````css
  1: @import "tailwindcss/base";
  2: @import "tailwindcss/components";
  3: @import "tailwindcss/utilities";
  4: 
  5: /* ============================================
  6:    CSS Variables - Metronic-Inspired Theme System
  7:    ============================================ */
  8: 
  9: @layer base {
 10:   :root {
 11:     /* Layout Variables */
 12:     --sidebar-width: 280px;
 13:     --sidebar-width-collapse: 80px;
 14:     --header-height: 70px;
 15:     --sidebar-transition-duration: 0.3s;
 16:     --sidebar-transition-timing: ease;
 17: 
 18:     /* Base Colors - Light Mode */
 19:     --background: 255 255 255;
 20:     --foreground: 9 9 11;
 21: 
 22:     --card: 255 255 255;
 23:     --card-foreground: 9 9 11;
 24: 
 25:     --popover: 255 255 255;
 26:     --popover-foreground: 9 9 11;
 27: 
 28:     --primary: 13 148 136;
 29:     --primary-foreground: 255 255 255;
 30: 
 31:     --secondary: 244 244 245;
 32:     --secondary-foreground: 24 24 27;
 33: 
 34:     --muted: 244 244 245;
 35:     --muted-foreground: 113 113 122;
 36: 
 37:     --accent: 244 244 245;
 38:     --accent-foreground: 24 24 27;
 39: 
 40:     --destructive: 239 68 68;
 41:     --destructive-foreground: 255 255 255;
 42: 
 43:     --border: 228 228 231;
 44:     --input: 228 228 231;
 45:     --ring: 161 161 170;
 46: 
 47:     /* Sidebar Colors - Light Mode */
 48:     --sidebar-bg: 255 255 255;
 49:     --sidebar-foreground: 9 9 11;
 50:     --sidebar-border: 228 228 231;
 51:     --sidebar-muted: 113 113 122;
 52:     --sidebar-accent: 244 244 245;
 53:     --sidebar-accent-foreground: 24 24 27;
 54: 
 55:     /* Semantic Colors */
 56:     --success: 16 185 129;
 57:     --warning: 245 158 11;
 58:     --danger: 239 68 68;
 59:     --info: 14 165 233;
 60: 
 61:     /* Radius */
 62:     --radius: 0.5rem;
 63:   }
 64: 
 65:   .dark {
 66:     /* Base Colors - Dark Mode */
 67:     --background: 9 9 11;
 68:     --foreground: 250 250 250;
 69: 
 70:     --card: 24 24 27;
 71:     --card-foreground: 250 250 250;
 72: 
 73:     --popover: 24 24 27;
 74:     --popover-foreground: 250 250 250;
 75: 
 76:     --primary: 20 184 166;
 77:     --primary-foreground: 255 255 255;
 78: 
 79:     --secondary: 39 39 42;
 80:     --secondary-foreground: 250 250 250;
 81: 
 82:     --muted: 39 39 42;
 83:     --muted-foreground: 161 161 170;
 84: 
 85:     --accent: 39 39 42;
 86:     --accent-foreground: 250 250 250;
 87: 
 88:     --destructive: 239 68 68;
 89:     --destructive-foreground: 255 255 255;
 90: 
 91:     --border: 39 39 42;
 92:     --input: 39 39 42;
 93:     --ring: 63 63 70;
 94: 
 95:     /* Sidebar Colors - Dark Mode */
 96:     --sidebar-bg: 9 9 11;
 97:     --sidebar-foreground: 250 250 250;
 98:     --sidebar-border: 39 39 42;
 99:     --sidebar-muted: 161 161 170;
100:     --sidebar-accent: 39 39 42;
101:     --sidebar-accent-foreground: 250 250 250;
102:   }
103: 
104:   /* Base styles */
105:   * {
106:     border-color: rgb(var(--border));
107:   }
108: 
109:   body {
110:     background-color: rgb(var(--background));
111:     color: rgb(var(--foreground));
112:     font-feature-settings: "cv02", "cv03", "cv04", "cv11";
113:     @apply antialiased;
114:   }
115: 
116:   /* Smooth scrolling */
117:   html {
118:     scroll-behavior: smooth;
119:   }
120: }
121: 
122: /* ============================================
123:    Layout System - Metronic Style
124:    ============================================ */
125: 
126: @layer components {
127:   /* Main Wrapper */
128:   .kt-wrapper {
129:     padding-left: 0;
130:     transition: padding-left var(--sidebar-transition-duration) var(--sidebar-transition-timing);
131:   }
132: 
133:   @media (min-width: 1024px) {
134:     .kt-wrapper {
135:       padding-left: var(--sidebar-width);
136:     }
137: 
138:     .kt-sidebar-collapse .kt-wrapper {
139:       padding-left: var(--sidebar-width-collapse);
140:     }
141:   }
142: 
143:   /* Header */
144:   .kt-header {
145:     height: var(--header-height);
146:     left: 0;
147:     transition: left var(--sidebar-transition-duration) var(--sidebar-transition-timing);
148:   }
149: 
150:   @media (min-width: 1024px) {
151:     .kt-header {
152:       left: var(--sidebar-width);
153:     }
154: 
155:     .kt-sidebar-collapse .kt-header {
156:       left: var(--sidebar-width-collapse);
157:     }
158:   }
159: 
160:   /* Sidebar */
161:   .kt-sidebar {
162:     width: var(--sidebar-width);
163:     transition: width var(--sidebar-transition-duration) var(--sidebar-transition-timing);
164:   }
165: 
166:   .kt-sidebar-header {
167:     height: var(--header-height);
168:   }
169: 
170:   @media (min-width: 1024px) {
171:     .kt-sidebar-collapse .kt-sidebar {
172:       width: var(--sidebar-width-collapse);
173:     }
174: 
175:     .kt-sidebar-collapse .kt-sidebar:hover {
176:       width: var(--sidebar-width);
177:     }
178: 
179:     /* Hide text when collapsed */
180:     .kt-sidebar-collapse .kt-sidebar:not(:hover) .kt-sidebar-text {
181:       display: none;
182:     }
183: 
184:     .kt-sidebar-collapse .kt-sidebar:not(:hover) .kt-sidebar-logo-full {
185:       display: none;
186:     }
187: 
188:     .kt-sidebar-collapse .kt-sidebar:not(:hover) .kt-sidebar-logo-mini {
189:       display: flex;
190:     }
191: 
192:     .kt-sidebar-collapse .kt-sidebar:not(:hover) .kt-menu-heading {
193:       visibility: hidden;
194:       position: relative;
195:     }
196: 
197:     .kt-sidebar-collapse .kt-sidebar:not(:hover) .kt-menu-heading::before {
198:       content: "...";
199:       visibility: visible;
200:       position: absolute;
201:       left: 0.5rem;
202:       bottom: 50%;
203:       transform: translateY(50%);
204:       color: currentColor;
205:       font-size: 0.75rem;
206:     }
207: 
208:     .kt-sidebar-collapse .kt-sidebar:not(:hover) .kt-menu-arrow,
209:     .kt-sidebar-collapse .kt-sidebar:not(:hover) .kt-menu-badge {
210:       display: none;
211:     }
212: 
213:     .kt-sidebar-collapse .kt-sidebar:not(:hover) .kt-sidebar-footer {
214:       padding: 1rem 0.5rem;
215:       justify-content: center;
216:     }
217: 
218:     .kt-sidebar-collapse .kt-sidebar:not(:hover) .kt-sidebar-footer-content {
219:       display: none;
220:     }
221: 
222:     .kt-sidebar-collapse .kt-sidebar:not(:hover) .kt-sidebar-footer-actions {
223:       flex-direction: column;
224:       gap: 0.5rem;
225:     }
226:   }
227: }
228: 
229: /* ============================================
230:    Menu System - Metronic Style
231:    ============================================ */
232: 
233: @layer components {
234:   .kt-menu {
235:     display: flex;
236:     flex-direction: column;
237:     gap: 0.125rem;
238:   }
239: 
240:   .kt-menu-item {
241:     display: flex;
242:     flex-direction: column;
243:   }
244: 
245:   .kt-menu-link {
246:     display: flex;
247:     align-items: center;
248:     gap: 0.625rem;
249:     padding: 0.5rem 0.625rem;
250:     margin: 0 0.5rem;
251:     border-radius: 0.5rem;
252:     font-size: 0.875rem;
253:     font-weight: 500;
254:     color: rgb(var(--sidebar-foreground));
255:     transition: all 0.2s ease;
256:     cursor: pointer;
257:     border: 1px solid transparent;
258:   }
259: 
260:   .kt-menu-link:hover {
261:     background-color: rgb(var(--sidebar-accent));
262:     color: rgb(var(--primary));
263:   }
264: 
265:   .kt-menu-item.active > .kt-menu-link {
266:     background-color: rgb(var(--primary) / 0.1);
267:     color: rgb(var(--primary));
268:     border-color: rgb(var(--primary) / 0.2);
269:   }
270: 
271:   .kt-menu-icon {
272:     display: flex;
273:     align-items: center;
274:     justify-content: center;
275:     width: 1.25rem;
276:     flex-shrink: 0;
277:     color: rgb(var(--sidebar-muted));
278:   }
279: 
280:   .kt-menu-link:hover .kt-menu-icon,
281:   .kt-menu-item.active > .kt-menu-link .kt-menu-icon {
282:     color: rgb(var(--primary));
283:   }
284: 
285:   .kt-menu-title {
286:     flex: 1;
287:     white-space: nowrap;
288:     overflow: hidden;
289:     text-overflow: ellipsis;
290:   }
291: 
292:   .kt-menu-arrow {
293:     display: flex;
294:     align-items: center;
295:     justify-content: center;
296:     width: 1.25rem;
297:     margin-left: auto;
298:     color: rgb(var(--sidebar-muted));
299:     transition: transform 0.2s ease;
300:   }
301: 
302:   .kt-menu-item.show > .kt-menu-link .kt-menu-arrow {
303:     transform: rotate(90deg);
304:   }
305: 
306:   .kt-menu-badge {
307:     margin-left: auto;
308:   }
309: 
310:   .kt-menu-heading {
311:     padding: 1.25rem 0.625rem 0.5rem;
312:     margin: 0 0.5rem;
313:     font-size: 0.6875rem;
314:     font-weight: 600;
315:     text-transform: uppercase;
316:     letter-spacing: 0.05em;
317:     color: rgb(var(--sidebar-muted));
318:   }
319: 
320:   .kt-menu-accordion {
321:     display: none;
322:     flex-direction: column;
323:     padding-left: 1.25rem;
324:     margin-left: 0.625rem;
325:     border-left: 1px solid rgb(var(--sidebar-border));
326:     gap: 0.125rem;
327:     overflow: hidden;
328:     transition: height 0.3s ease;
329:   }
330: 
331:   .kt-menu-item.show > .kt-menu-accordion {
332:     display: flex;
333:   }
334: 
335:   .kt-menu-bullet {
336:     display: flex;
337:     align-items: center;
338:     justify-content: center;
339:     width: 0.375rem;
340:     height: 0.375rem;
341:     border-radius: 50%;
342:     background-color: rgb(var(--sidebar-muted));
343:     margin-right: 0.75rem;
344:     flex-shrink: 0;
345:   }
346: 
347:   .kt-menu-item.active .kt-menu-bullet {
348:     background-color: rgb(var(--primary));
349:   }
350: 
351:   .kt-menu-separator {
352:     border-bottom: 1px solid rgb(var(--sidebar-border));
353:     margin: 0.5rem 1rem;
354:   }
355: }
356: 
357: /* ============================================
358:    LiveView Loading States
359:    ============================================ */
360: 
361: .phx-loading {
362:   @apply opacity-50 pointer-events-none;
363: }
364: 
365: .phx-click-loading {
366:   @apply opacity-75 cursor-wait;
367: }
368: 
369: .phx-submit-loading {
370:   @apply opacity-75 cursor-wait;
371: }
372: 
373: /* ============================================
374:    Custom Utility Classes
375:    ============================================ */
376: 
377: @layer utilities {
378:   /* Glass morphism */
379:   .glass {
380:     background-color: rgb(var(--background) / 0.8);
381:     backdrop-filter: blur(12px);
382:     -webkit-backdrop-filter: blur(12px);
383:   }
384: 
385:   .glass-strong {
386:     background-color: rgb(var(--background) / 0.9);
387:     backdrop-filter: blur(16px);
388:     -webkit-backdrop-filter: blur(16px);
389:   }
390: 
391:   /* Gradient backgrounds */
392:   .gradient-primary {
393:     @apply bg-gradient-to-r from-teal-600 to-teal-500;
394:   }
395: 
396:   .gradient-cool {
397:     @apply bg-gradient-to-r from-cyan-500 to-teal-500;
398:   }
399: 
400:   /* Text gradients */
401:   .text-gradient-primary {
402:     @apply bg-gradient-to-r from-teal-600 to-cyan-500 bg-clip-text text-transparent;
403:   }
404: 
405:   /* Hover lift effect */
406:   .hover-lift {
407:     @apply transition-all duration-200 ease-out;
408:   }
409: 
410:   .hover-lift:hover {
411:     transform: translateY(-2px);
412:     box-shadow: 0 10px 40px -15px rgba(0, 0, 0, 0.1);
413:   }
414: 
415:   /* Focus ring */
416:   .focus-ring {
417:     @apply focus:outline-none focus:ring-2 focus:ring-offset-2;
418:     --tw-ring-color: rgb(var(--primary));
419:     --tw-ring-offset-color: rgb(var(--background));
420:   }
421: 
422:   /* Scrollbar styling */
423:   .scrollbar-thin {
424:     scrollbar-width: thin;
425:     scrollbar-color: rgb(var(--muted-foreground)) transparent;
426:   }
427: 
428:   .scrollbar-thin::-webkit-scrollbar {
429:     width: 6px;
430:     height: 6px;
431:   }
432: 
433:   .scrollbar-thin::-webkit-scrollbar-track {
434:     background: transparent;
435:   }
436: 
437:   .scrollbar-thin::-webkit-scrollbar-thumb {
438:     background-color: rgb(var(--muted-foreground) / 0.3);
439:     border-radius: 9999px;
440:   }
441: 
442:   .scrollbar-thin::-webkit-scrollbar-thumb:hover {
443:     background-color: rgb(var(--muted-foreground) / 0.5);
444:   }
445: 
446:   /* Hide scrollbar but keep functionality */
447:   .scrollbar-none {
448:     -ms-overflow-style: none;
449:     scrollbar-width: none;
450:   }
451: 
452:   .scrollbar-none::-webkit-scrollbar {
453:     display: none;
454:   }
455: 
456:   /* Skeleton loading */
457:   .skeleton {
458:     background: linear-gradient(
459:       90deg,
460:       rgb(var(--muted)) 0%,
461:       rgb(var(--muted-foreground) / 0.1) 50%,
462:       rgb(var(--muted)) 100%
463:     );
464:     background-size: 200% 100%;
465:     animation: shimmer 1.5s ease-in-out infinite;
466:     border-radius: var(--radius);
467:   }
468: 
469:   /* Line clamp utilities */
470:   .line-clamp-1 {
471:     display: -webkit-box;
472:     -webkit-line-clamp: 1;
473:     -webkit-box-orient: vertical;
474:     overflow: hidden;
475:   }
476: 
477:   .line-clamp-2 {
478:     display: -webkit-box;
479:     -webkit-line-clamp: 2;
480:     -webkit-box-orient: vertical;
481:     overflow: hidden;
482:   }
483: 
484:   .line-clamp-3 {
485:     display: -webkit-box;
486:     -webkit-line-clamp: 3;
487:     -webkit-box-orient: vertical;
488:     overflow: hidden;
489:   }
490: }
491: 
492: /* ============================================
493:    Component Styles
494:    ============================================ */
495: 
496: @layer components {
497:   /* Button base */
498:   .btn {
499:     @apply inline-flex items-center justify-center gap-2 rounded-lg font-medium
500:            transition-all duration-200 ease-out
501:            focus:outline-none focus:ring-2 focus:ring-offset-2
502:            disabled:opacity-50 disabled:pointer-events-none;
503:     --tw-ring-offset-color: rgb(var(--background));
504:   }
505: 
506:   .btn-sm {
507:     @apply px-3 py-1.5 text-sm;
508:   }
509: 
510:   .btn-md {
511:     @apply px-4 py-2 text-sm;
512:   }
513: 
514:   .btn-lg {
515:     @apply px-6 py-3 text-base;
516:   }
517: 
518:   .btn-primary {
519:     background-color: rgb(var(--primary));
520:     color: rgb(var(--primary-foreground));
521:     --tw-ring-color: rgb(var(--primary));
522:     @apply shadow-sm hover:shadow-md;
523:   }
524: 
525:   .btn-primary:hover {
526:     background-color: rgb(var(--primary) / 0.9);
527:   }
528: 
529:   .btn-secondary {
530:     background-color: rgb(var(--secondary));
531:     color: rgb(var(--secondary-foreground));
532:     --tw-ring-color: rgb(var(--secondary));
533:   }
534: 
535:   .btn-secondary:hover {
536:     background-color: rgb(var(--secondary) / 0.8);
537:   }
538: 
539:   .btn-outline {
540:     background-color: transparent;
541:     border: 2px solid rgb(var(--primary));
542:     color: rgb(var(--primary));
543:     --tw-ring-color: rgb(var(--primary));
544:   }
545: 
546:   .btn-outline:hover {
547:     background-color: rgb(var(--primary));
548:     color: rgb(var(--primary-foreground));
549:   }
550: 
551:   .btn-ghost {
552:     background-color: transparent;
553:     color: rgb(var(--foreground));
554:   }
555: 
556:   .btn-ghost:hover {
557:     background-color: rgb(var(--muted));
558:   }
559: 
560:   .btn-danger {
561:     background-color: rgb(var(--destructive));
562:     color: rgb(var(--destructive-foreground));
563:     --tw-ring-color: rgb(var(--destructive));
564:     @apply shadow-sm hover:shadow-md;
565:   }
566: 
567:   .btn-danger:hover {
568:     background-color: rgb(var(--destructive) / 0.9);
569:   }
570: 
571:   /* Card styles */
572:   .card {
573:     background-color: rgb(var(--card));
574:     color: rgb(var(--card-foreground));
575:     border: 1px solid rgb(var(--border));
576:     border-radius: calc(var(--radius) * 1.5);
577:   }
578: 
579:   .card-elevated {
580:     background-color: rgb(var(--card));
581:     color: rgb(var(--card-foreground));
582:     border-radius: calc(var(--radius) * 1.5);
583:     box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
584:     transition: box-shadow 0.2s ease;
585:   }
586: 
587:   .card-elevated:hover {
588:     box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
589:   }
590: 
591:   .card-glass {
592:     @apply glass border border-white/20 dark:border-zinc-700/50;
593:     border-radius: calc(var(--radius) * 1.5);
594:   }
595: 
596:   /* Input styles */
597:   .input {
598:     @apply w-full px-4 py-2.5 text-sm rounded-lg transition-colors duration-200;
599:     background-color: rgb(var(--background));
600:     border: 1px solid rgb(var(--input));
601:     color: rgb(var(--foreground));
602:   }
603: 
604:   .input::placeholder {
605:     color: rgb(var(--muted-foreground));
606:   }
607: 
608:   .input:focus {
609:     outline: none;
610:     border-color: rgb(var(--primary));
611:     box-shadow: 0 0 0 3px rgb(var(--primary) / 0.1);
612:   }
613: 
614:   .input-error {
615:     border-color: rgb(var(--destructive));
616:   }
617: 
618:   .input-error:focus {
619:     border-color: rgb(var(--destructive));
620:     box-shadow: 0 0 0 3px rgb(var(--destructive) / 0.1);
621:   }
622: 
623:   /* Badge styles */
624:   .badge {
625:     @apply inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-xs font-medium;
626:   }
627: 
628:   .badge-default {
629:     background-color: rgb(var(--muted));
630:     color: rgb(var(--muted-foreground));
631:   }
632: 
633:   .badge-primary {
634:     background-color: rgb(var(--primary) / 0.1);
635:     color: rgb(var(--primary));
636:   }
637: 
638:   .badge-success {
639:     background-color: rgb(var(--success) / 0.1);
640:     color: rgb(var(--success));
641:   }
642: 
643:   .badge-warning {
644:     background-color: rgb(var(--warning) / 0.1);
645:     color: rgb(var(--warning));
646:   }
647: 
648:   .badge-danger {
649:     background-color: rgb(var(--destructive) / 0.1);
650:     color: rgb(var(--destructive));
651:   }
652: 
653:   .badge-info {
654:     background-color: rgb(var(--info) / 0.1);
655:     color: rgb(var(--info));
656:   }
657: 
658:   /* Stat card - Metronic style */
659:   .stat-card {
660:     @apply card-elevated p-5 flex items-start gap-4;
661:   }
662: 
663:   .stat-icon {
664:     @apply flex-shrink-0 w-12 h-12 rounded-xl flex items-center justify-center;
665:   }
666: 
667:   .stat-value {
668:     @apply text-2xl font-bold;
669:     color: rgb(var(--foreground));
670:   }
671: 
672:   .stat-label {
673:     @apply text-sm;
674:     color: rgb(var(--muted-foreground));
675:   }
676: 
677:   .stat-trend {
678:     @apply inline-flex items-center gap-1 text-xs font-medium;
679:   }
680: 
681:   .stat-trend-up {
682:     color: rgb(var(--success));
683:   }
684: 
685:   .stat-trend-down {
686:     color: rgb(var(--destructive));
687:   }
688: 
689:   /* Table styles */
690:   .table-container {
691:     @apply overflow-x-auto rounded-xl;
692:     border: 1px solid rgb(var(--border));
693:   }
694: 
695:   .table {
696:     @apply w-full text-sm;
697:   }
698: 
699:   .table thead {
700:     background-color: rgb(var(--muted) / 0.5);
701:   }
702: 
703:   .table th {
704:     @apply px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider;
705:     color: rgb(var(--muted-foreground));
706:   }
707: 
708:   .table td {
709:     @apply px-4 py-3;
710:     border-top: 1px solid rgb(var(--border));
711:   }
712: 
713:   .table tbody tr {
714:     @apply transition-colors;
715:   }
716: 
717:   .table tbody tr:hover {
718:     background-color: rgb(var(--muted) / 0.5);
719:   }
720: 
721:   /* Progress bar */
722:   .progress {
723:     @apply h-2 w-full rounded-full overflow-hidden;
724:     background-color: rgb(var(--muted));
725:   }
726: 
727:   .progress-bar {
728:     @apply h-full rounded-full transition-all duration-500 ease-out;
729:   }
730: 
731:   .progress-primary {
732:     background-color: rgb(var(--primary));
733:   }
734: 
735:   .progress-success {
736:     background-color: rgb(var(--success));
737:   }
738: 
739:   .progress-warning {
740:     background-color: rgb(var(--warning));
741:   }
742: 
743:   .progress-danger {
744:     background-color: rgb(var(--destructive));
745:   }
746: 
747:   /* Empty state */
748:   .empty-state {
749:     @apply flex flex-col items-center justify-center py-12 px-4 text-center;
750:   }
751: 
752:   .empty-state-icon {
753:     @apply w-16 h-16 mb-4;
754:     color: rgb(var(--muted-foreground) / 0.5);
755:   }
756: 
757:   .empty-state-title {
758:     @apply text-lg font-semibold mb-2;
759:     color: rgb(var(--foreground));
760:   }
761: 
762:   .empty-state-description {
763:     @apply text-sm max-w-sm;
764:     color: rgb(var(--muted-foreground));
765:   }
766: 
767:   /* Tabs */
768:   .tabs {
769:     @apply flex gap-1;
770:     border-bottom: 1px solid rgb(var(--border));
771:   }
772: 
773:   .tab {
774:     @apply px-4 py-2.5 text-sm font-medium -mb-px transition-colors;
775:     color: rgb(var(--muted-foreground));
776:     border-bottom: 2px solid transparent;
777:   }
778: 
779:   .tab:hover {
780:     color: rgb(var(--foreground));
781:   }
782: 
783:   .tab-active {
784:     color: rgb(var(--primary));
785:     border-bottom-color: rgb(var(--primary));
786:   }
787: 
788:   /* Avatar */
789:   .avatar {
790:     @apply relative inline-flex items-center justify-center rounded-full font-medium overflow-hidden;
791:     background-color: rgb(var(--primary) / 0.1);
792:     color: rgb(var(--primary));
793:   }
794: 
795:   .avatar-sm {
796:     @apply w-8 h-8 text-xs;
797:   }
798: 
799:   .avatar-md {
800:     @apply w-10 h-10 text-sm;
801:   }
802: 
803:   .avatar-lg {
804:     @apply w-12 h-12 text-base;
805:   }
806: 
807:   /* Tooltip */
808:   .tooltip {
809:     @apply absolute z-50 px-2 py-1 text-xs font-medium rounded shadow-lg whitespace-nowrap;
810:     background-color: rgb(var(--foreground));
811:     color: rgb(var(--background));
812:     animation: fade-in 0.15s ease-out;
813:   }
814: 
815:   /* Dropdown menu */
816:   .dropdown-menu {
817:     @apply absolute z-50 min-w-[180px] rounded-lg py-1;
818:     background-color: rgb(var(--popover));
819:     border: 1px solid rgb(var(--border));
820:     box-shadow: 0 10px 40px -15px rgba(0, 0, 0, 0.15);
821:     animation: fade-in-down 0.15s ease-out;
822:   }
823: 
824:   .dropdown-item {
825:     @apply flex items-center gap-2 px-3 py-2 text-sm cursor-pointer transition-colors;
826:     color: rgb(var(--popover-foreground));
827:   }
828: 
829:   .dropdown-item:hover {
830:     background-color: rgb(var(--accent));
831:   }
832: }
833: 
834: /* ============================================
835:    Animations
836:    ============================================ */
837: 
838: @keyframes fade-in {
839:   from { opacity: 0; }
840:   to { opacity: 1; }
841: }
842: 
843: @keyframes fade-in-up {
844:   from {
845:     opacity: 0;
846:     transform: translateY(1rem);
847:   }
848:   to {
849:     opacity: 1;
850:     transform: translateY(0);
851:   }
852: }
853: 
854: @keyframes fade-in-down {
855:   from {
856:     opacity: 0;
857:     transform: translateY(-0.5rem);
858:   }
859:   to {
860:     opacity: 1;
861:     transform: translateY(0);
862:   }
863: }
864: 
865: @keyframes fade-in-scale {
866:   from {
867:     opacity: 0;
868:     transform: scale(0.95);
869:   }
870:   to {
871:     opacity: 1;
872:     transform: scale(1);
873:   }
874: }
875: 
876: @keyframes slide-in-right {
877:   from {
878:     opacity: 0;
879:     transform: translateX(1rem);
880:   }
881:   to {
882:     opacity: 1;
883:     transform: translateX(0);
884:   }
885: }
886: 
887: @keyframes slide-in-left {
888:   from {
889:     opacity: 0;
890:     transform: translateX(-1rem);
891:   }
892:   to {
893:     opacity: 1;
894:     transform: translateX(0);
895:   }
896: }
897: 
898: @keyframes shimmer {
899:   0% { background-position: -200% 0; }
900:   100% { background-position: 200% 0; }
901: }
902: 
903: @keyframes pulse-glow {
904:   0%, 100% {
905:     opacity: 0.5;
906:     transform: scale(1);
907:   }
908:   50% {
909:     opacity: 0.8;
910:     transform: scale(1.05);
911:   }
912: }
913: 
914: @keyframes bounce-subtle {
915:   0%, 100% { transform: translateY(0); }
916:   50% { transform: translateY(-3px); }
917: }
918: 
919: @keyframes float {
920:   0%, 100% { transform: translateY(0px); }
921:   50% { transform: translateY(-10px); }
922: }
923: 
924: @keyframes spin-slow {
925:   from { transform: rotate(0deg); }
926:   to { transform: rotate(360deg); }
927: }
928: 
929: .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
930: .animate-fade-in-up { animation: fade-in-up 0.5s ease-out forwards; }
931: .animate-fade-in-down { animation: fade-in-down 0.3s ease-out forwards; }
932: .animate-fade-in-scale { animation: fade-in-scale 0.2s ease-out forwards; }
933: .animate-slide-in-right { animation: slide-in-right 0.3s ease-out forwards; }
934: .animate-slide-in-left { animation: slide-in-left 0.3s ease-out forwards; }
935: .animate-pulse-glow { animation: pulse-glow 4s ease-in-out infinite; }
936: .animate-bounce-subtle { animation: bounce-subtle 2s ease-in-out infinite; }
937: .animate-float { animation: float 3s ease-in-out infinite; }
938: .animate-spin-slow { animation: spin-slow 3s linear infinite; }
939: 
940: /* Staggered animation delays */
941: .stagger-1 { animation-delay: 0.05s; }
942: .stagger-2 { animation-delay: 0.1s; }
943: .stagger-3 { animation-delay: 0.15s; }
944: .stagger-4 { animation-delay: 0.2s; }
945: .stagger-5 { animation-delay: 0.25s; }
946: .stagger-6 { animation-delay: 0.3s; }
947: 
948: /* ============================================
949:    Print Styles
950:    ============================================ */
951: 
952: @media print {
953:   .kt-sidebar,
954:   .kt-header,
955:   .no-print {
956:     display: none !important;
957:   }
958: 
959:   .kt-wrapper {
960:     padding-left: 0 !important;
961:   }
962: 
963:   .card {
964:     box-shadow: none !important;
965:     border: 1px solid #e2e8f0 !important;
966:   }
967: }
````

## File: config/dev.exs
````elixir
 1: import Config
 2: 
 3: # Configure your database
 4: config :hellen, Hellen.Repo,
 5:   username: "hellen",
 6:   password: "hellen_dev",
 7:   hostname: "localhost",
 8:   database: "hellen_dev",
 9:   stacktrace: true,
10:   show_sensitive_data_on_connection_error: true,
11:   pool_size: 10
12: 
13: # For development, we disable any cache and enable
14: # debugging and code reloading.
15: config :hellen, HellenWeb.Endpoint,
16:   http: [ip: {127, 0, 0, 1}, port: 4000],
17:   check_origin: false,
18:   code_reloader: true,
19:   debug_errors: true,
20:   secret_key_base:
21:     "dev_secret_key_base_hellen_ai_2024_change_in_production_and_make_it_very_long_indeed_to_satisfy_the_requirement",
22:   watchers: [
23:     esbuild: {Esbuild, :install_and_run, [:hellen, ~w(--sourcemap=inline --watch)]},
24:     tailwind: {Tailwind, :install_and_run, [:hellen, ~w(--watch)]}
25:   ]
26: 
27: # Watch static and templates for browser reloading.
28: config :hellen, HellenWeb.Endpoint,
29:   live_reload: [
30:     patterns: [
31:       ~r"priv/static/(?!uploads/).*(js|css|png|jpeg|jpg|gif|svg)$",
32:       ~r"priv/gettext/.*(po)$",
33:       ~r"lib/hellen_web/(controllers|live|components)/.*(ex|heex)$"
34:     ]
35:   ]
36: 
37: # Enable dev routes for dashboard and mailbox
38: config :hellen, dev_routes: true
39: 
40: # Do not include metadata nor timestamps in development logs
41: config :logger, :console, format: "[$level] $message\n"
42: 
43: # Set a higher stacktrace during development.
44: config :phoenix, :stacktrace_depth, 20
45: 
46: # Initialize plugs at runtime for faster development compilation
47: config :phoenix, :plug_init_mode, :runtime
48: 
49: config :phoenix_live_view,
50:   debug_heex_annotations: true,
51:   enable_expensive_runtime_checks: true
52: 
53: # Configure Redis
54: config :hellen, :redis_url, "redis://localhost:6379"
55: 
56: # Configure Qdrant
57: config :hellen, :qdrant_url, "http://localhost:6333"
58: 
59: # NVIDIA NIM API (use env var in production)
60: config :hellen, :nvidia_api_key, System.get_env("NVIDIA_API_KEY")
61: 
62: # R2 Storage configuration for development
63: config :ex_aws,
64:   access_key_id: "62c911de26cc59e22b31b153920d35ca",
65:   secret_access_key: "693ce5ae9fa33925bd7601ebbf7bdfcf7610ec4fe9b398bfb4d72623ada3944a",
66:   region: "auto"
67: 
68: config :ex_aws, :s3,
69:   scheme: "https://",
70:   host: "5e169ace5c37c07688d84589e2ee87b0.r2.cloudflarestorage.com",
71:   region: "auto"
72: 
73: config :hellen, :r2,
74:   bucket: "hellen-r2",
75:   public_url: "https://pub-0914ea82354f49a6a09816c8d7044329.r2.dev"
76: 
77: # Swoosh local mailbox (dev only)
78: config :swoosh, :api_client, false
79: 
80: # Stripe test keys (development)
81: config :stripity_stripe,
82:   api_key:
83:     "sk_test_51Sahg4Ge6PyigxRcP5MGjlJRWazTecpTul2utjt7GLZdRFkSMytATPJmKgPkHw6TY9Je3GIZsRmSCcr42hn7AbbQ00cmngXgul",
84:   webhook_secret: "whsec_f0113e8b5b1aaf135582c55745c7886131506f8230c1e6a1b2aef9d35a448a95"
85: 
86: config :hellen, :stripe,
87:   publishable_key:
88:     "pk_test_51Sahg4Ge6PyigxRcjONule4vS8EUOyIOXdRi5lQXOtmsXnu5cwCPHBXsEeOlngRA1RCExge6JpiP3hZ01QA6ohUs00rc1RwPZc"
````

## File: lib/hellen/accounts/user.ex
````elixir
  1: defmodule Hellen.Accounts.User do
  2:   @moduledoc """
  3:   Schema for users (teachers, coordinators, admins) with authentication and credits.
  4:   """
  5:   use Ecto.Schema
  6:   import Ecto.Changeset
  7: 
  8:   @primary_key {:id, :binary_id, autogenerate: true}
  9:   @foreign_key_type :binary_id
 10: 
 11:   @signup_bonus 2
 12: 
 13:   schema "users" do
 14:     field :email, :string
 15:     field :name, :string
 16:     field :password, :string, virtual: true, redact: true
 17:     field :password_hash, :string, redact: true
 18:     field :role, :string, default: "teacher"
 19:     field :credits, :integer, default: @signup_bonus
 20:     field :plan, :string, default: "free"
 21: 
 22:     # Firebase Auth fields
 23:     field :firebase_uid, :string
 24:     field :email_verified, :boolean, default: false
 25: 
 26:     # Stripe fields
 27:     field :stripe_customer_id, :string
 28: 
 29:     # Onboarding fields
 30:     field :onboarding_completed, :boolean, default: false
 31:     field :onboarding_step, :integer, default: 0
 32:     field :subject, :string
 33:     field :grade_level, :string
 34: 
 35:     # Gamification fields
 36:     field :level, :integer, default: 1
 37:     field :experience_points, :integer, default: 0
 38: 
 39:     belongs_to :institution, Hellen.Accounts.Institution
 40:     has_many :lessons, Hellen.Lessons.Lesson
 41:     has_many :credit_transactions, Hellen.Billing.CreditTransaction
 42:     has_many :achievements, Hellen.Gamification.UserAchievement
 43: 
 44:     timestamps(type: :utc_datetime)
 45:   end
 46: 
 47:   @doc false
 48:   def changeset(user, attrs) do
 49:     user
 50:     |> cast(attrs, [
 51:       :email,
 52:       :name,
 53:       :role,
 54:       :credits,
 55:       :plan,
 56:       :institution_id,
 57:       :firebase_uid,
 58:       :email_verified,
 59:       :stripe_customer_id,
 60:       :onboarding_completed,
 61:       :onboarding_step,
 62:       :subject,
 63:       :grade_level
 64:     ])
 65:     |> validate_required([:email, :name])
 66:     |> validate_format(:email, ~r/^[^\s]+@[^\s]+$/, message: "must have the @ sign and no spaces")
 67:     |> validate_length(:email, max: 160)
 68:     |> unique_constraint(:email)
 69:     |> unique_constraint(:firebase_uid)
 70:     |> validate_inclusion(:role, ["teacher", "coordinator", "admin"])
 71:     |> validate_inclusion(:plan, ["free", "pro", "enterprise"])
 72:     |> validate_number(:credits, greater_than_or_equal_to: 0)
 73:   end
 74: 
 75:   @doc false
 76:   def registration_changeset(user, attrs) do
 77:     user
 78:     |> changeset(attrs)
 79:     |> cast(attrs, [:password])
 80:     |> validate_required([:password])
 81:     |> validate_length(:password, min: 8, max: 72)
 82:     |> hash_password()
 83:   end
 84: 
 85:   defp hash_password(changeset) do
 86:     case get_change(changeset, :password) do
 87:       nil -> changeset
 88:       password -> put_change(changeset, :password_hash, Bcrypt.hash_pwd_salt(password))
 89:     end
 90:   end
 91: 
 92:   @doc "Changeset for updating user password"
 93:   def password_changeset(user, attrs) do
 94:     user
 95:     |> cast(attrs, [:password])
 96:     |> validate_required([:password])
 97:     |> validate_length(:password, min: 8, max: 72)
 98:     |> hash_password()
 99:   end
100: 
101:   @doc "Changeset for updating profile (name, email only)"
102:   def profile_changeset(user, attrs) do
103:     user
104:     |> cast(attrs, [:name, :email])
105:     |> validate_required([:name, :email])
106:     |> validate_format(:email, ~r/^[^\s]+@[^\s]+$/, message: "must have the @ sign and no spaces")
107:     |> validate_length(:email, max: 160)
108:     |> unique_constraint(:email)
109:   end
110: 
111:   @doc "Changeset for onboarding"
112:   def onboarding_changeset(user, attrs) do
113:     user
114:     |> cast(attrs, [:onboarding_completed, :onboarding_step, :subject, :grade_level])
115:   end
116: 
117:   def valid_password?(%__MODULE__{password_hash: hashed_password}, password)
118:       when is_binary(hashed_password) and byte_size(password) > 0 do
119:     Bcrypt.verify_pass(password, hashed_password)
120:   end
121: 
122:   def valid_password?(_, _) do
123:     Bcrypt.no_user_verify()
124:     false
125:   end
126: end
````

## File: lib/hellen/analysis.ex
````elixir
  1: defmodule Hellen.Analysis do
  2:   @moduledoc """
  3:   The Analysis context - manages pedagogical analyses.
  4:   """
  5: 
  6:   import Ecto.Query, warn: false
  7: 
  8:   alias Hellen.Analysis.{Analysis, BnccMatch, BullyingAlert}
  9:   alias Hellen.Repo
 10: 
 11:   ## Analysis
 12: 
 13:   @doc """
 14:   Gets an analysis by ID, scoped to institution.
 15:   Raises if not found or institution doesn't match.
 16:   """
 17:   @spec get_analysis!(binary(), binary()) :: Analysis.t()
 18:   def get_analysis!(id, institution_id) do
 19:     Analysis
 20:     |> where([a], a.id == ^id and a.institution_id == ^institution_id)
 21:     |> Repo.one!()
 22:   end
 23: 
 24:   @doc """
 25:   Gets an analysis with details, scoped to institution.
 26:   """
 27:   @spec get_analysis_with_details!(binary(), binary()) :: Analysis.t()
 28:   def get_analysis_with_details!(id, institution_id) do
 29:     Analysis
 30:     |> where([a], a.id == ^id and a.institution_id == ^institution_id)
 31:     |> Repo.one!()
 32:     |> Repo.preload([:bncc_matches, :bullying_alerts])
 33:   end
 34: 
 35:   @doc """
 36:   Lists analyses for a lesson, verifying institution ownership.
 37:   """
 38:   @spec list_analyses_by_lesson(binary(), binary()) :: [Analysis.t()]
 39:   def list_analyses_by_lesson(lesson_id, institution_id) do
 40:     Analysis
 41:     |> where([a], a.lesson_id == ^lesson_id and a.institution_id == ^institution_id)
 42:     |> order_by([a], desc: a.inserted_at)
 43:     |> Repo.all()
 44:   end
 45: 
 46:   def create_analysis(attrs \\ %{}) do
 47:     %Analysis{}
 48:     |> Analysis.changeset(attrs)
 49:     |> Repo.insert()
 50:   end
 51: 
 52:   @doc """
 53:   Creates a full analysis with related BNCC matches and bullying alerts.
 54:   Uses Ecto.Multi for transactional consistency.
 55:   """
 56:   @spec create_full_analysis(binary(), map()) :: {:ok, Analysis.t()} | {:error, term()}
 57:   def create_full_analysis(lesson_id, analysis_result) do
 58:     lesson = Repo.get!(Hellen.Lessons.Lesson, lesson_id)
 59: 
 60:     Ecto.Multi.new()
 61:     |> Ecto.Multi.insert(:analysis, build_analysis_changeset(lesson, analysis_result))
 62:     |> Ecto.Multi.run(:bncc_matches, fn _repo, %{analysis: analysis} ->
 63:       insert_bncc_matches(analysis, analysis_result.bncc_matches || [])
 64:     end)
 65:     |> Ecto.Multi.run(:bullying_alerts, fn _repo, %{analysis: analysis} ->
 66:       insert_bullying_alerts(analysis, analysis_result.bullying_alerts || [])
 67:     end)
 68:     |> Repo.transaction()
 69:     |> case do
 70:       {:ok, %{analysis: analysis}} -> {:ok, analysis}
 71:       {:error, _failed_op, changeset, _changes} -> {:error, changeset}
 72:     end
 73:   end
 74: 
 75:   defp build_analysis_changeset(lesson, analysis_result) do
 76:     %Analysis{}
 77:     |> Analysis.changeset(%{
 78:       lesson_id: lesson.id,
 79:       institution_id: lesson.institution_id,
 80:       analysis_type: "full",
 81:       model_used: analysis_result.model,
 82:       raw_response: analysis_result.raw,
 83:       result: analysis_result.structured,
 84:       overall_score: analysis_result.overall_score,
 85:       processing_time_ms: analysis_result.processing_time_ms,
 86:       tokens_used: analysis_result.tokens_used
 87:     })
 88:   end
 89: 
 90:   defp insert_bncc_matches(analysis, matches) do
 91:     results =
 92:       Enum.map(matches, fn match ->
 93:         %BnccMatch{}
 94:         |> BnccMatch.changeset(Map.put(match, :analysis_id, analysis.id))
 95:         |> Repo.insert()
 96:       end)
 97: 
 98:     case Enum.find(results, &match?({:error, _}, &1)) do
 99:       nil -> {:ok, Enum.map(results, fn {:ok, m} -> m end)}
100:       {:error, changeset} -> {:error, changeset}
101:     end
102:   end
103: 
104:   defp insert_bullying_alerts(analysis, alerts) do
105:     results =
106:       Enum.map(alerts, fn alert ->
107:         %BullyingAlert{}
108:         |> BullyingAlert.changeset(Map.put(alert, :analysis_id, analysis.id))
109:         |> Repo.insert()
110:       end)
111: 
112:     case Enum.find(results, &match?({:error, _}, &1)) do
113:       nil -> {:ok, Enum.map(results, fn {:ok, a} -> a end)}
114:       {:error, changeset} -> {:error, changeset}
115:     end
116:   end
117: 
118:   def create_feedback_analysis(lesson_id, analysis_result) do
119:     create_analysis(%{
120:       lesson_id: lesson_id,
121:       analysis_type: "pedagogical_feedback",
122:       model_used: analysis_result.model,
123:       raw_response: analysis_result.raw,
124:       result: analysis_result.structured,
125:       processing_time_ms: analysis_result.processing_time_ms,
126:       tokens_used: analysis_result.tokens_used
127:     })
128:   end
129: 
130:   ## BNCC Matches
131: 
132:   def create_bncc_match(attrs) do
133:     %BnccMatch{}
134:     |> BnccMatch.changeset(attrs)
135:     |> Repo.insert()
136:   end
137: 
138:   def list_bncc_matches_by_analysis(analysis_id) do
139:     BnccMatch
140:     |> where([m], m.analysis_id == ^analysis_id)
141:     |> order_by([m], desc: m.match_score)
142:     |> Repo.all()
143:   end
144: 
145:   ## Bullying Alerts
146: 
147:   def create_bullying_alert(attrs) do
148:     %BullyingAlert{}
149:     |> BullyingAlert.changeset(attrs)
150:     |> Repo.insert()
151:   end
152: 
153:   def list_bullying_alerts_by_analysis(analysis_id) do
154:     BullyingAlert
155:     |> where([a], a.analysis_id == ^analysis_id)
156:     |> order_by([a], desc: a.severity)
157:     |> Repo.all()
158:   end
159: 
160:   def review_bullying_alert(alert_id, reviewer_id) do
161:     BullyingAlert
162:     |> Repo.get!(alert_id)
163:     |> BullyingAlert.review_changeset(reviewer_id)
164:     |> Repo.update()
165:   end
166: 
167:   def list_unreviewed_alerts(opts \\ []) do
168:     limit = Keyword.get(opts, :limit, 50)
169: 
170:     BullyingAlert
171:     |> where([a], a.reviewed == false)
172:     |> order_by([a], desc: a.severity, desc: a.inserted_at)
173:     |> limit(^limit)
174:     |> preload(analysis: :lesson)
175:     |> Repo.all()
176:   end
177: 
178:   ## Statistics & History
179: 
180:   @doc """
181:   Get score history for a user's lessons over time.
182:   Returns a list of %{date: Date.t(), score: float, lesson_title: String.t()}
183:   """
184:   def get_user_score_history(user_id, opts \\ []) do
185:     limit = Keyword.get(opts, :limit, 20)
186: 
187:     Analysis
188:     |> join(:inner, [a], l in assoc(a, :lesson))
189:     |> where([a, l], l.user_id == ^user_id)
190:     |> where([a], not is_nil(a.overall_score))
191:     |> order_by([a], asc: a.inserted_at)
192:     |> limit(^limit)
193:     |> select([a, l], %{
194:       date: a.inserted_at,
195:       score: a.overall_score,
196:       lesson_title: l.title,
197:       lesson_id: l.id
198:     })
199:     |> Repo.all()
200:   end
201: 
202:   @doc """
203:   Get the average score for a discipline within an institution.
204:   """
205:   def get_discipline_average(subject, institution_id) when is_binary(subject) do
206:     Analysis
207:     |> join(:inner, [a], l in assoc(a, :lesson))
208:     |> where([a, l], l.institution_id == ^institution_id)
209:     |> where([a, l], l.subject == ^subject)
210:     |> where([a], not is_nil(a.overall_score))
211:     |> select([a], avg(a.overall_score))
212:     |> Repo.one()
213:   end
214: 
215:   def get_discipline_average(_subject, _institution_id), do: nil
216: 
217:   @doc """
218:   Calculate user's score trend based on recent analyses.
219:   Returns :improving, :stable, or :declining with the change percentage.
220:   """
221:   def get_user_trend(user_id) do
222:     history = get_user_score_history(user_id, limit: 10)
223: 
224:     case history do
225:       [] ->
226:         {:stable, 0.0}
227: 
228:       [_single] ->
229:         {:stable, 0.0}
230: 
231:       scores ->
232:         mid = div(length(scores), 2)
233:         {older, recent} = Enum.split(scores, mid)
234: 
235:         older_avg = Enum.map(older, & &1.score) |> average()
236:         recent_avg = Enum.map(recent, & &1.score) |> average()
237: 
238:         change = (recent_avg - older_avg) * 100
239: 
240:         cond do
241:           change > 5 -> {:improving, change}
242:           change < -5 -> {:declining, change}
243:           true -> {:stable, change}
244:         end
245:     end
246:   end
247: 
248:   defp average([]), do: 0.0
249:   defp average(list), do: Enum.sum(list) / length(list)
250: 
251:   @doc """
252:   Get BNCC competencies coverage for a user.
253:   Returns aggregated competencies with frequency and average score.
254:   """
255:   def get_bncc_coverage(user_id, opts \\ []) do
256:     limit = Keyword.get(opts, :limit, 50)
257: 
258:     BnccMatch
259:     |> join(:inner, [m], a in assoc(m, :analysis))
260:     |> join(:inner, [m, a], l in assoc(a, :lesson))
261:     |> where([m, a, l], l.user_id == ^user_id)
262:     |> group_by([m], [m.competencia_code, m.competencia_name])
263:     |> select([m], %{
264:       code: m.competencia_code,
265:       name: m.competencia_name,
266:       count: count(m.id),
267:       avg_score: avg(m.match_score)
268:     })
269:     |> order_by([m], desc: count(m.id))
270:     |> limit(^limit)
271:     |> Repo.all()
272:   end
273: 
274:   @doc """
275:   List all alerts for an institution with pagination.
276:   """
277:   def list_alerts_by_institution(institution_id, opts \\ []) do
278:     limit = Keyword.get(opts, :limit, 50)
279:     status = Keyword.get(opts, :status, :all)
280: 
281:     query =
282:       BullyingAlert
283:       |> join(:inner, [b], a in assoc(b, :analysis))
284:       |> where([b, a], a.institution_id == ^institution_id)
285:       |> order_by([b], desc: b.inserted_at)
286:       |> limit(^limit)
287:       |> preload([b, a], analysis: {a, :lesson})
288: 
289:     query =
290:       case status do
291:         :unreviewed -> where(query, [b], b.reviewed == false)
292:         :reviewed -> where(query, [b], b.reviewed == true)
293:         _ -> query
294:       end
295: 
296:     Repo.all(query)
297:   end
298: 
299:   @doc """
300:   Get alert statistics for an institution.
301:   """
302:   def get_alert_stats(institution_id) do
303:     query =
304:       BullyingAlert
305:       |> join(:inner, [b], a in assoc(b, :analysis))
306:       |> where([b, a], a.institution_id == ^institution_id)
307: 
308:     total = Repo.aggregate(query, :count)
309:     unreviewed = query |> where([b], b.reviewed == false) |> Repo.aggregate(:count)
310: 
311:     by_severity =
312:       query
313:       |> group_by([b], b.severity)
314:       |> select([b], {b.severity, count(b.id)})
315:       |> Repo.all()
316:       |> Map.new()
317: 
318:     by_type =
319:       query
320:       |> group_by([b], b.alert_type)
321:       |> select([b], {b.alert_type, count(b.id)})
322:       |> Repo.all()
323:       |> Map.new()
324: 
325:     %{
326:       total: total,
327:       unreviewed: unreviewed,
328:       reviewed: total - unreviewed,
329:       by_severity: by_severity,
330:       by_type: by_type
331:     }
332:   end
333: 
334:   ## Advanced Analytics
335: 
336:   @doc """
337:   Compare scores between two periods for a user.
338:   Returns current vs previous period averages with trend.
339:   """
340:   def get_score_comparison(user_id, opts \\ []) do
341:     days = Keyword.get(opts, :days, 30)
342:     now = DateTime.utc_now()
343:     current_start = DateTime.add(now, -days, :day)
344:     previous_start = DateTime.add(current_start, -days, :day)
345: 
346:     current_avg = get_period_average(user_id, current_start, now)
347:     previous_avg = get_period_average(user_id, previous_start, current_start)
348: 
349:     change_percent =
350:       if previous_avg && previous_avg > 0 do
351:         ((current_avg || 0) - previous_avg) / previous_avg * 100
352:       else
353:         0.0
354:       end
355: 
356:     trend =
357:       cond do
358:         change_percent > 5 -> :improving
359:         change_percent < -5 -> :declining
360:         true -> :stable
361:       end
362: 
363:     %{
364:       current_avg: current_avg || 0.0,
365:       previous_avg: previous_avg || 0.0,
366:       change_percent: Float.round(change_percent, 1),
367:       trend: trend,
368:       period_days: days
369:     }
370:   end
371: 
372:   defp get_period_average(user_id, start_date, end_date) do
373:     Analysis
374:     |> join(:inner, [a], l in assoc(a, :lesson))
375:     |> where([a, l], l.user_id == ^user_id)
376:     |> where([a], not is_nil(a.overall_score))
377:     |> where([a], a.inserted_at >= ^start_date and a.inserted_at < ^end_date)
378:     |> select([a], avg(a.overall_score))
379:     |> Repo.one()
380:   end
381: 
382:   @doc """
383:   Compare institution average with platform average.
384:   """
385:   def get_institution_comparison(institution_id, opts \\ []) do
386:     days = Keyword.get(opts, :days, 30)
387:     since = DateTime.add(DateTime.utc_now(), -days, :day)
388: 
389:     institution_avg =
390:       Analysis
391:       |> where([a], a.institution_id == ^institution_id)
392:       |> where([a], not is_nil(a.overall_score))
393:       |> where([a], a.inserted_at >= ^since)
394:       |> select([a], avg(a.overall_score))
395:       |> Repo.one()
396: 
397:     platform_avg =
398:       Analysis
399:       |> where([a], not is_nil(a.overall_score))
400:       |> where([a], a.inserted_at >= ^since)
401:       |> select([a], avg(a.overall_score))
402:       |> Repo.one()
403: 
404:     # Calculate rank and percentile
405:     all_institution_avgs =
406:       Analysis
407:       |> where([a], not is_nil(a.overall_score))
408:       |> where([a], a.inserted_at >= ^since)
409:       |> group_by([a], a.institution_id)
410:       |> select([a], avg(a.overall_score))
411:       |> Repo.all()
412:       |> Enum.sort(:desc)
413: 
414:     rank =
415:       all_institution_avgs
416:       |> Enum.find_index(fn avg -> avg == institution_avg end)
417:       |> case do
418:         nil -> length(all_institution_avgs)
419:         idx -> idx + 1
420:       end
421: 
422:     total_institutions = length(all_institution_avgs)
423: 
424:     percentile =
425:       if total_institutions > 0,
426:         do: ((total_institutions - rank) / total_institutions * 100) |> Float.round(0),
427:         else: 0
428: 
429:     %{
430:       institution_avg: Float.round(institution_avg || 0.0, 2),
431:       platform_avg: Float.round(platform_avg || 0.0, 2),
432:       rank: rank,
433:       total_institutions: total_institutions,
434:       percentile: percentile
435:     }
436:   end
437: 
438:   @doc """
439:   Get alert timeline grouped by day/week/month.
440:   """
441:   def get_alert_timeline(institution_id, opts \\ []) do
442:     days = Keyword.get(opts, :days, 30)
443:     group_by_period = Keyword.get(opts, :group_by, :day)
444:     since = DateTime.add(DateTime.utc_now(), -days, :day)
445: 
446:     base_query =
447:       BullyingAlert
448:       |> join(:inner, [b], a in assoc(b, :analysis))
449:       |> where([b, a], a.institution_id == ^institution_id)
450:       |> where([b], b.inserted_at >= ^since)
451: 
452:     case group_by_period do
453:       :day ->
454:         base_query
455:         |> group_by([b], fragment("DATE(?)", b.inserted_at))
456:         |> select([b], %{
457:           period: fragment("DATE(?)", b.inserted_at),
458:           count: count(b.id),
459:           high: count(fragment("CASE WHEN ? = 'high' THEN 1 END", b.severity)),
460:           medium: count(fragment("CASE WHEN ? = 'medium' THEN 1 END", b.severity)),
461:           low: count(fragment("CASE WHEN ? = 'low' THEN 1 END", b.severity))
462:         })
463:         |> order_by([b], asc: fragment("DATE(?)", b.inserted_at))
464:         |> Repo.all()
465: 
466:       :week ->
467:         base_query
468:         |> group_by([b], fragment("DATE_TRUNC('week', ?)", b.inserted_at))
469:         |> select([b], %{
470:           period: fragment("DATE_TRUNC('week', ?)", b.inserted_at),
471:           count: count(b.id),
472:           high: count(fragment("CASE WHEN ? = 'high' THEN 1 END", b.severity)),
473:           medium: count(fragment("CASE WHEN ? = 'medium' THEN 1 END", b.severity)),
474:           low: count(fragment("CASE WHEN ? = 'low' THEN 1 END", b.severity))
475:         })
476:         |> order_by([b], asc: fragment("DATE_TRUNC('week', ?)", b.inserted_at))
477:         |> Repo.all()
478: 
479:       :month ->
480:         base_query
481:         |> group_by([b], fragment("DATE_TRUNC('month', ?)", b.inserted_at))
482:         |> select([b], %{
483:           period: fragment("DATE_TRUNC('month', ?)", b.inserted_at),
484:           count: count(b.id),
485:           high: count(fragment("CASE WHEN ? = 'high' THEN 1 END", b.severity)),
486:           medium: count(fragment("CASE WHEN ? = 'medium' THEN 1 END", b.severity)),
487:           low: count(fragment("CASE WHEN ? = 'low' THEN 1 END", b.severity))
488:         })
489:         |> order_by([b], asc: fragment("DATE_TRUNC('month', ?)", b.inserted_at))
490:         |> Repo.all()
491:     end
492:   end
493: 
494:   @doc """
495:   Get detailed BNCC coverage with drill-down by category.
496:   """
497:   def get_bncc_coverage_detailed(user_id, opts \\ []) do
498:     days = Keyword.get(opts, :days, 90)
499:     since = DateTime.add(DateTime.utc_now(), -days, :day)
500: 
501:     BnccMatch
502:     |> join(:inner, [m], a in assoc(m, :analysis))
503:     |> join(:inner, [m, a], l in assoc(a, :lesson))
504:     |> where([m, a, l], l.user_id == ^user_id)
505:     |> where([m, a], a.inserted_at >= ^since)
506:     |> group_by([m], [m.competencia_code, m.competencia_name])
507:     |> select([m], %{
508:       code: m.competencia_code,
509:       name: m.competencia_name,
510:       count: count(m.id),
511:       avg_score: avg(m.match_score),
512:       min_score: min(m.match_score),
513:       max_score: max(m.match_score)
514:     })
515:     |> order_by([m], desc: count(m.id))
516:     |> Repo.all()
517:     |> Enum.map(fn item ->
518:       # Extract category from code (e.g., "EF06LP01" -> "LP" for Lingua Portuguesa)
519:       category = extract_bncc_category(item.code)
520:       Map.put(item, :category, category)
521:     end)
522:   end
523: 
524:   defp extract_bncc_category(code) when is_binary(code) do
525:     case Regex.run(~r/[A-Z]{2}/, code) do
526:       [cat] -> cat
527:       _ -> "Outros"
528:     end
529:   end
530: 
531:   defp extract_bncc_category(_), do: "Outros"
532: 
533:   @doc """
534:   Get daily score history for charts.
535:   """
536:   def get_daily_scores(user_id, opts \\ []) do
537:     days = Keyword.get(opts, :days, 30)
538:     since = DateTime.add(DateTime.utc_now(), -days, :day)
539: 
540:     Analysis
541:     |> join(:inner, [a], l in assoc(a, :lesson))
542:     |> where([a, l], l.user_id == ^user_id)
543:     |> where([a], not is_nil(a.overall_score))
544:     |> where([a], a.inserted_at >= ^since)
545:     |> group_by([a], fragment("DATE(?)", a.inserted_at))
546:     |> select([a], %{
547:       date: fragment("DATE(?)", a.inserted_at),
548:       avg_score: avg(a.overall_score),
549:       count: count(a.id)
550:     })
551:     |> order_by([a], asc: fragment("DATE(?)", a.inserted_at))
552:     |> Repo.all()
553:   end
554: 
555:   @doc """
556:   Get analyses for export with all related data.
557:   """
558:   def list_analyses_for_export(user_id, opts \\ []) do
559:     days = Keyword.get(opts, :days, 90)
560:     since = DateTime.add(DateTime.utc_now(), -days, :day)
561: 
562:     Analysis
563:     |> join(:inner, [a], l in assoc(a, :lesson))
564:     |> where([a, l], l.user_id == ^user_id)
565:     |> where([a], a.inserted_at >= ^since)
566:     |> order_by([a], desc: a.inserted_at)
567:     |> preload([:bncc_matches, :bullying_alerts, :lesson])
568:     |> Repo.all()
569:   end
570: end
````

## File: lib/hellen_web/live/billing_live/index.ex
````elixir
  1: defmodule HellenWeb.BillingLive.Index do
  2:   @moduledoc """
  3:   Billing Dashboard - Credits balance, usage stats, history, and package purchase.
  4:   """
  5:   use HellenWeb, :live_view
  6: 
  7:   alias Hellen.Billing
  8:   alias Hellen.Billing.StripeService
  9: 
 10:   @impl true
 11:   def mount(_params, _session, socket) do
 12:     user = socket.assigns.current_user
 13:     stats = Billing.get_usage_stats(user.id, 30)
 14:     {transactions, total} = Billing.list_transactions_filtered(user.id, limit: 10)
 15:     daily_usage = Billing.get_daily_usage(user.id, 30)
 16:     analyses_count = Billing.get_analyses_count(user.id)
 17:     packages = Billing.credit_packages()
 18: 
 19:     # Subscribe to credits updates
 20:     if connected?(socket) do
 21:       Phoenix.PubSub.subscribe(Hellen.PubSub, "user:#{user.id}")
 22:     end
 23: 
 24:     {:ok,
 25:      socket
 26:      |> assign(page_title: "Creditos")
 27:      |> assign(stats: stats)
 28:      |> assign(transactions: transactions)
 29:      |> assign(transactions_total: total)
 30:      |> assign(daily_usage: daily_usage)
 31:      |> assign(analyses_count: analyses_count)
 32:      |> assign(packages: packages)
 33:      |> assign(show_purchase_modal: false)
 34:      |> assign(selected_package: nil)
 35:      |> assign(filter_reason: nil)
 36:      |> assign(page: 1)
 37:      |> assign(purchasing: false)
 38:      |> assign(payment_method: "card")
 39:      |> assign(flash_success: nil)
 40:      |> assign(flash_canceled: nil)}
 41:   end
 42: 
 43:   @impl true
 44:   def handle_params(params, _url, socket) do
 45:     socket =
 46:       case params do
 47:         %{"success" => "true", "session_id" => session_id} ->
 48:           # Verify and process payment if webhook hasn't done it yet
 49:           socket = maybe_process_checkout_session(socket, session_id)
 50: 
 51:           # Reload user data after successful purchase
 52:           user = Hellen.Accounts.get_user(socket.assigns.current_user.id)
 53:           stats = Billing.get_usage_stats(user.id, 30)
 54:           {transactions, total} = Billing.list_transactions_filtered(user.id, limit: 10)
 55: 
 56:           socket
 57:           |> assign(current_user: user)
 58:           |> assign(stats: stats)
 59:           |> assign(transactions: transactions)
 60:           |> assign(transactions_total: total)
 61:           |> put_flash(:info, "Pagamento confirmado! Creditos adicionados com sucesso.")
 62: 
 63:         %{"success" => "true"} ->
 64:           # Fallback without session_id
 65:           user = Hellen.Accounts.get_user(socket.assigns.current_user.id)
 66:           stats = Billing.get_usage_stats(user.id, 30)
 67:           {transactions, total} = Billing.list_transactions_filtered(user.id, limit: 10)
 68: 
 69:           socket
 70:           |> assign(current_user: user)
 71:           |> assign(stats: stats)
 72:           |> assign(transactions: transactions)
 73:           |> assign(transactions_total: total)
 74:           |> put_flash(:info, "Pagamento confirmado! Creditos adicionados com sucesso.")
 75: 
 76:         %{"canceled" => "true"} ->
 77:           socket
 78:           |> put_flash(:error, "Pagamento cancelado.")
 79: 
 80:         _ ->
 81:           socket
 82:       end
 83: 
 84:     {:noreply, socket}
 85:   end
 86: 
 87:   # Fallback: Process checkout session if webhook hasn't processed it yet
 88:   defp maybe_process_checkout_session(socket, session_id) do
 89:     case StripeService.get_session(session_id) do
 90:       {:ok, %{payment_status: "paid", metadata: metadata} = session} ->
 91:         user_id = metadata["user_id"]
 92:         credits = String.to_integer(metadata["credits"] || "0")
 93:         package_id = metadata["package_id"]
 94:         payment_intent = session.payment_intent
 95: 
 96:         # Only process if this is for the current user
 97:         if user_id == socket.assigns.current_user.id do
 98:           # Check if already processed by looking for this payment_intent
 99:           case Billing.get_transaction_by_payment_intent(payment_intent) do
100:             nil ->
101:               # Not yet processed, add credits
102:               case Billing.add_credits_with_stripe(
103:                      socket.assigns.current_user,
104:                      credits,
105:                      package_id,
106:                      payment_intent
107:                    ) do
108:                 {:ok, _user} ->
109:                   require Logger
110:                   Logger.info("Credits added via fallback for session: #{session_id}")
111:                   socket
112: 
113:                 {:error, _reason} ->
114:                   socket
115:               end
116: 
117:             _transaction ->
118:               # Already processed via webhook
119:               socket
120:           end
121:         else
122:           socket
123:         end
124: 
125:       _ ->
126:         socket
127:     end
128:   end
129: 
130:   @impl true
131:   def handle_info({:credits_updated, new_balance}, socket) do
132:     user = %{socket.assigns.current_user | credits: new_balance}
133:     stats = Billing.get_usage_stats(user.id, 30)
134:     {transactions, total} = Billing.list_transactions_filtered(user.id, limit: 10)
135: 
136:     {:noreply,
137:      socket
138:      |> assign(current_user: user)
139:      |> assign(stats: stats)
140:      |> assign(transactions: transactions)
141:      |> assign(transactions_total: total)}
142:   end
143: 
144:   # PWA OfflineIndicator hook events - ignore silently
145:   @impl true
146:   def handle_event("online", _params, socket), do: {:noreply, socket}
147:   def handle_event("offline", _params, socket), do: {:noreply, socket}
148: 
149:   @impl true
150:   def handle_event("filter_transactions", %{"reason" => reason}, socket) do
151:     reason = if reason == "", do: nil, else: reason
152: 
153:     {transactions, total} =
154:       Billing.list_transactions_filtered(socket.assigns.current_user.id,
155:         limit: 10,
156:         reason: reason
157:       )
158: 
159:     {:noreply,
160:      socket
161:      |> assign(transactions: transactions)
162:      |> assign(transactions_total: total)
163:      |> assign(filter_reason: reason)
164:      |> assign(page: 1)}
165:   end
166: 
167:   def handle_event("load_more_transactions", _params, socket) do
168:     next_page = socket.assigns.page + 1
169: 
170:     {more_transactions, _total} =
171:       Billing.list_transactions_filtered(socket.assigns.current_user.id,
172:         limit: 10,
173:         offset: (next_page - 1) * 10,
174:         reason: socket.assigns.filter_reason
175:       )
176: 
177:     {:noreply,
178:      socket
179:      |> assign(transactions: socket.assigns.transactions ++ more_transactions)
180:      |> assign(page: next_page)}
181:   end
182: 
183:   def handle_event("show_purchase_modal", %{"package" => package_id}, socket) do
184:     package = Enum.find(socket.assigns.packages, &(&1.id == package_id))
185:     {:noreply, socket |> assign(show_purchase_modal: true) |> assign(selected_package: package)}
186:   end
187: 
188:   def handle_event("close_modal", _params, socket) do
189:     {:noreply,
190:      assign(socket,
191:        show_purchase_modal: false,
192:        selected_package: nil,
193:        purchasing: false,
194:        payment_method: "card"
195:      )}
196:   end
197: 
198:   def handle_event("select_payment_method", %{"method" => method}, socket) do
199:     {:noreply, assign(socket, payment_method: method)}
200:   end
201: 
202:   def handle_event("purchase", %{"package" => package_id}, socket) do
203:     socket = assign(socket, purchasing: true)
204:     user = socket.assigns.current_user
205:     base_url = HellenWeb.Endpoint.url()
206:     payment_method = socket.assigns.payment_method
207: 
208:     case StripeService.create_checkout_session(user, package_id, base_url, payment_method) do
209:       {:ok, checkout_url} ->
210:         {:noreply, redirect(socket, external: checkout_url)}
211: 
212:       {:error, _reason} ->
213:         {:noreply,
214:          socket
215:          |> assign(purchasing: false)
216:          |> put_flash(:error, "Erro ao criar sessao de pagamento. Tente novamente.")}
217:     end
218:   end
219: 
220:   @impl true
221:   def render(assigns) do
222:     ~H"""
223:     <div class="space-y-6 animate-fade-in">
224:       <!-- Header -->
225:       <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
226:         <div>
227:           <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-white tracking-tight">
228:             Creditos
229:           </h1>
230:           <p class="mt-1 text-slate-500 dark:text-slate-400">
231:             Gerencie seus creditos e acompanhe seu uso
232:           </p>
233:         </div>
234:       </div>
235:       <!-- Stats Cards -->
236:       <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
237:         <.billing_stat_card
238:           label="Saldo Atual"
239:           value={@current_user.credits}
240:           icon="hero-bolt"
241:           color="teal"
242:         />
243:         <.billing_stat_card
244:           label="Usados (30d)"
245:           value={@stats.total_used}
246:           icon="hero-arrow-trending-down"
247:           color="red"
248:         />
249:         <.billing_stat_card
250:           label="Adicionados (30d)"
251:           value={@stats.total_added}
252:           icon="hero-arrow-trending-up"
253:           color="emerald"
254:         />
255:         <.billing_stat_card
256:           label="Analises Totais"
257:           value={@analyses_count}
258:           icon="hero-chart-bar"
259:           color="violet"
260:         />
261:       </div>
262:       <!-- Usage Chart -->
263:       <div class="bg-white dark:bg-slate-800 rounded-xl shadow-card border border-slate-200/50 dark:border-slate-700/50 p-6">
264:         <div class="flex items-center gap-2 mb-4">
265:           <.icon name="hero-chart-bar-square" class="h-5 w-5 text-teal-600 dark:text-teal-400" />
266:           <h3 class="text-lg font-semibold text-slate-900 dark:text-white">
267:             Uso de Creditos (30 dias)
268:           </h3>
269:         </div>
270:         <div
271:           id="usage-chart"
272:           phx-hook="BillingUsageChart"
273:           data-usage={Jason.encode!(@daily_usage)}
274:           class="h-64"
275:         >
276:           <div
277:             :if={Enum.all?(@daily_usage, fn d -> d.used == 0 and d.added == 0 end)}
278:             class="flex items-center justify-center h-full text-slate-500 dark:text-slate-400"
279:           >
280:             <div class="text-center">
281:               <.icon
282:                 name="hero-chart-bar"
283:                 class="h-12 w-12 mx-auto text-slate-300 dark:text-slate-600 mb-2"
284:               />
285:               <p>Sem movimentacao no periodo</p>
286:             </div>
287:           </div>
288:         </div>
289:       </div>
290:       <!-- Credit Packages -->
291:       <div class="bg-white dark:bg-slate-800 rounded-xl shadow-card border border-slate-200/50 dark:border-slate-700/50 p-6">
292:         <div class="flex items-center gap-2 mb-6">
293:           <.icon name="hero-shopping-cart" class="h-5 w-5 text-sage-600 dark:text-sage-400" />
294:           <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Comprar Creditos</h3>
295:         </div>
296:         <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
297:           <div
298:             :for={package <- @packages}
299:             class={[
300:               "relative rounded-xl border-2 p-6 cursor-pointer transition-all duration-300 hover:shadow-lg group",
301:               if(package[:popular],
302:                 do: "border-teal-500 dark:border-teal-400 bg-teal-50/50 dark:bg-teal-900/10",
303:                 else:
304:                   "border-slate-200 dark:border-slate-700 hover:border-teal-300 dark:hover:border-teal-600"
305:               )
306:             ]}
307:             phx-click="show_purchase_modal"
308:             phx-value-package={package.id}
309:           >
310:             <div :if={package[:popular]} class="absolute -top-3 left-1/2 -translate-x-1/2">
311:               <span class="px-3 py-1 text-xs font-medium text-white bg-gradient-to-r from-teal-500 to-sage-500 rounded-full shadow-sm">
312:                 Popular
313:               </span>
314:             </div>
315:             <div class="text-center">
316:               <div class="w-14 h-14 mx-auto mb-4 rounded-xl bg-teal-100 dark:bg-teal-900/30 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
317:                 <.icon name="hero-bolt" class="h-7 w-7 text-teal-600 dark:text-teal-400" />
318:               </div>
319:               <p class="text-3xl font-bold text-slate-900 dark:text-white"><%= package.credits %></p>
320:               <p class="text-sm text-slate-500 dark:text-slate-400">creditos</p>
321:               <p class="mt-4 text-2xl font-bold text-teal-600 dark:text-teal-400">
322:                 <%= package.price_display %>
323:               </p>
324:               <p class="text-xs text-slate-500 dark:text-slate-400">
325:                 R$ <%= Float.round(package.price / 100 / package.credits, 2) %>/credito
326:               </p>
327:             </div>
328:           </div>
329:         </div>
330:         <div class="mt-6 flex items-center justify-center gap-2 text-sm text-slate-500 dark:text-slate-400">
331:           <.icon name="hero-lock-closed" class="h-4 w-4" />
332:           <span>Pagamento seguro via Stripe</span>
333:         </div>
334:       </div>
335:       <!-- Transaction History -->
336:       <div class="bg-white dark:bg-slate-800 rounded-xl shadow-card border border-slate-200/50 dark:border-slate-700/50 overflow-hidden">
337:         <div class="p-6 border-b border-slate-200 dark:border-slate-700">
338:           <div class="flex items-center justify-between">
339:             <div class="flex items-center gap-2">
340:               <.icon name="hero-clock" class="h-5 w-5 text-ochre-600 dark:text-ochre-400" />
341:               <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Historico</h3>
342:             </div>
343:             <select
344:               phx-change="filter_transactions"
345:               name="reason"
346:               class="text-sm rounded-xl border-slate-200 dark:border-slate-600 dark:bg-slate-700/50 dark:text-white focus:ring-2 focus:ring-teal-500/20 focus:border-teal-500 transition-all duration-200"
347:             >
348:               <option value="">Todos os tipos</option>
349:               <option value="lesson_analysis" selected={@filter_reason == "lesson_analysis"}>
350:                 Analise de Aula
351:               </option>
352:               <option value="purchase" selected={@filter_reason == "purchase"}>Compra</option>
353:               <option value="signup_bonus" selected={@filter_reason == "signup_bonus"}>
354:                 Bonus de Cadastro
355:               </option>
356:               <option value="refund" selected={@filter_reason == "refund"}>Reembolso</option>
357:             </select>
358:           </div>
359:         </div>
360: 
361:         <div class="divide-y divide-slate-200 dark:divide-slate-700">
362:           <div
363:             :for={transaction <- @transactions}
364:             class="p-4 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors"
365:           >
366:             <div class="flex items-center gap-3">
367:               <div class={[
368:                 "w-10 h-10 rounded-xl flex items-center justify-center",
369:                 if(transaction.amount > 0,
370:                   do: "bg-emerald-100 dark:bg-emerald-900/30",
371:                   else: "bg-red-100 dark:bg-red-900/30"
372:                 )
373:               ]}>
374:                 <.icon
375:                   name={if transaction.amount > 0, do: "hero-arrow-down", else: "hero-arrow-up"}
376:                   class={"h-5 w-5 " <> if(transaction.amount > 0, do: "text-emerald-600 dark:text-emerald-400", else: "text-red-600 dark:text-red-400")}
377:                 />
378:               </div>
379:               <div>
380:                 <p class="text-sm font-medium text-slate-900 dark:text-white">
381:                   <%= reason_label(transaction.reason) %>
382:                 </p>
383:                 <p class="text-xs text-slate-500 dark:text-slate-400">
384:                   <%= Calendar.strftime(transaction.inserted_at, "%d/%m/%Y %H:%M") %>
385:                   <%= if transaction.lesson, do: "- #{transaction.lesson.title}" %>
386:                 </p>
387:               </div>
388:             </div>
389:             <div class="text-right">
390:               <p class={[
391:                 "text-sm font-bold",
392:                 if(transaction.amount > 0,
393:                   do: "text-emerald-600 dark:text-emerald-400",
394:                   else: "text-red-600 dark:text-red-400"
395:                 )
396:               ]}>
397:                 <%= if transaction.amount > 0, do: "+", else: "" %><%= transaction.amount %>
398:               </p>
399:               <p class="text-xs text-slate-500 dark:text-slate-400">
400:                 Saldo: <%= transaction.balance_after %>
401:               </p>
402:             </div>
403:           </div>
404:         </div>
405: 
406:         <div :if={Enum.empty?(@transactions)} class="p-8 text-center">
407:           <.icon name="hero-inbox" class="h-12 w-12 mx-auto text-slate-300 dark:text-slate-600 mb-2" />
408:           <p class="text-slate-500 dark:text-slate-400">Nenhuma transacao encontrada</p>
409:         </div>
410: 
411:         <div
412:           :if={length(@transactions) < @transactions_total}
413:           class="p-4 border-t border-slate-200 dark:border-slate-700"
414:         >
415:           <button
416:             phx-click="load_more_transactions"
417:             class="w-full py-2.5 text-sm font-medium text-teal-600 dark:text-teal-400 hover:text-teal-700 dark:hover:text-teal-300 transition-colors"
418:           >
419:             Carregar mais (<%= @transactions_total - length(@transactions) %> restantes)
420:           </button>
421:         </div>
422:       </div>
423:       <!-- Purchase Modal -->
424:       <div
425:         :if={@show_purchase_modal && @selected_package}
426:         class="fixed inset-0 z-50 overflow-y-auto"
427:         aria-modal="true"
428:       >
429:         <div class="flex min-h-screen items-center justify-center p-4">
430:           <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" phx-click="close_modal"></div>
431:           <div class="relative bg-white dark:bg-slate-800 rounded-2xl shadow-xl max-w-md w-full p-6 animate-fade-in-up">
432:             <div class="flex items-center justify-between mb-4">
433:               <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Comprar Creditos</h3>
434:               <button
435:                 phx-click="close_modal"
436:                 class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors"
437:               >
438:                 <.icon name="hero-x-mark" class="h-5 w-5" />
439:               </button>
440:             </div>
441: 
442:             <div class="text-center py-6">
443:               <div class="w-20 h-20 mx-auto rounded-2xl bg-gradient-to-br from-teal-100 to-sage-100 dark:from-teal-900/30 dark:to-sage-900/30 flex items-center justify-center mb-4">
444:                 <.icon name="hero-bolt" class="h-10 w-10 text-teal-600 dark:text-teal-400" />
445:               </div>
446:               <p class="text-4xl font-bold text-slate-900 dark:text-white">
447:                 <%= @selected_package.credits %>
448:               </p>
449:               <p class="text-slate-500 dark:text-slate-400">creditos</p>
450:               <p class="mt-4 text-3xl font-bold text-teal-600 dark:text-teal-400">
451:                 <%= @selected_package.price_display %>
452:               </p>
453:             </div>
454:             <!-- Payment Method Selection -->
455:             <div class="mb-6">
456:               <p class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-3">
457:                 Forma de pagamento
458:               </p>
459:               <div class="grid grid-cols-2 gap-3">
460:                 <button
461:                   type="button"
462:                   phx-click="select_payment_method"
463:                   phx-value-method="card"
464:                   class={[
465:                     "p-4 rounded-xl border-2 transition-all duration-200 flex flex-col items-center gap-2",
466:                     if(@payment_method == "card",
467:                       do: "border-teal-500 bg-teal-50 dark:bg-teal-900/20",
468:                       else: "border-slate-200 dark:border-slate-600 hover:border-teal-300"
469:                     )
470:                   ]}
471:                 >
472:                   <.icon
473:                     name="hero-credit-card"
474:                     class={"h-8 w-8 " <> if(@payment_method == "card", do: "text-teal-600 dark:text-teal-400", else: "text-slate-400")}
475:                   />
476:                   <span class={[
477:                     "text-sm font-medium",
478:                     if(@payment_method == "card",
479:                       do: "text-teal-700 dark:text-teal-300",
480:                       else: "text-slate-600 dark:text-slate-300"
481:                     )
482:                   ]}>
483:                     Cartao
484:                   </span>
485:                 </button>
486:                 <button
487:                   type="button"
488:                   phx-click="select_payment_method"
489:                   phx-value-method="pix"
490:                   class={[
491:                     "p-4 rounded-xl border-2 transition-all duration-200 flex flex-col items-center gap-2",
492:                     if(@payment_method == "pix",
493:                       do: "border-teal-500 bg-teal-50 dark:bg-teal-900/20",
494:                       else: "border-slate-200 dark:border-slate-600 hover:border-teal-300"
495:                     )
496:                   ]}
497:                 >
498:                   <svg
499:                     class={[
500:                       "h-8 w-8",
501:                       if(@payment_method == "pix",
502:                         do: "text-teal-600 dark:text-teal-400",
503:                         else: "text-slate-400"
504:                       )
505:                     ]}
506:                     viewBox="0 0 512 512"
507:                     fill="currentColor"
508:                   >
509:                     <path d="M242.4 292.5C247.8 287.1 257.1 287.1 262.5 292.5L339.5 369.5C344.9 374.9 344.9 384.1 339.5 389.5C334.1 394.9 324.9 394.9 319.5 389.5L262.5 332.5V480C262.5 487.2 256.7 493 249.5 493C242.3 493 236.5 487.2 236.5 480V332.5L179.5 389.5C174.1 394.9 164.9 394.9 159.5 389.5C154.1 384.1 154.1 374.9 159.5 369.5L236.5 292.5C241.9 287.1 251.1 287.1 256.5 292.5H242.4zM377.9 169.9L294.1 253.8C283.7 264.2 267.3 264.2 256.9 253.8L173.1 169.9C162.7 159.5 162.7 143.1 173.1 132.7L256.9 48.9C267.3 38.5 283.7 38.5 294.1 48.9L377.9 132.7C388.3 143.1 388.3 159.5 377.9 169.9zM275.5 71.1L191.6 155C186.2 160.4 186.2 169.6 191.6 175L275.5 258.9C280.9 264.3 290.1 264.3 295.5 258.9L379.4 175C384.8 169.6 384.8 160.4 379.4 155L295.5 71.1C290.1 65.7 280.9 65.7 275.5 71.1zM425.6 219.6L341.7 303.5C336.3 308.9 336.3 318.1 341.7 323.5L425.6 407.4C431 412.8 440.2 412.8 445.6 407.4L529.5 323.5C534.9 318.1 534.9 308.9 529.5 303.5L445.6 219.6C440.2 214.2 431 214.2 425.6 219.6zM65.4 219.6L-18.5 303.5C-23.9 308.9 -23.9 318.1 -18.5 323.5L65.4 407.4C70.8 412.8 80 412.8 85.4 407.4L169.3 323.5C174.7 318.1 174.7 308.9 169.3 303.5L85.4 219.6C80 214.2 70.8 214.2 65.4 219.6z" />
510:                   </svg>
511:                   <span class={[
512:                     "text-sm font-medium",
513:                     if(@payment_method == "pix",
514:                       do: "text-teal-700 dark:text-teal-300",
515:                       else: "text-slate-600 dark:text-slate-300"
516:                     )
517:                   ]}>
518:                     PIX
519:                   </span>
520:                 </button>
521:               </div>
522:               <p
523:                 :if={@payment_method == "pix"}
524:                 class="mt-2 text-xs text-slate-500 dark:text-slate-400 text-center"
525:               >
526:                 QR Code expira em 30 minutos
527:               </p>
528:             </div>
529: 
530:             <div class="bg-slate-50 dark:bg-slate-900/50 rounded-xl p-4 mb-6">
531:               <div class="flex items-center gap-3 text-sm text-slate-600 dark:text-slate-300">
532:                 <.icon name="hero-shield-check" class="h-5 w-5 text-emerald-500" />
533:                 <span>Pagamento seguro processado pelo Stripe</span>
534:               </div>
535:             </div>
536: 
537:             <div class="flex justify-end gap-3">
538:               <button
539:                 type="button"
540:                 phx-click="close_modal"
541:                 class="px-4 py-2.5 text-sm font-medium text-slate-700 dark:text-slate-200 bg-slate-100 dark:bg-slate-700 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
542:               >
543:                 Cancelar
544:               </button>
545:               <button
546:                 type="button"
547:                 phx-click="purchase"
548:                 phx-value-package={@selected_package.id}
549:                 disabled={@purchasing}
550:                 class={[
551:                   "px-6 py-2.5 text-sm font-medium text-white rounded-xl transition-all duration-200",
552:                   if(@purchasing,
553:                     do: "bg-teal-400 cursor-not-allowed",
554:                     else: "bg-teal-600 hover:bg-teal-700 hover:shadow-lg hover:shadow-teal-500/25"
555:                   )
556:                 ]}
557:               >
558:                 <%= if @purchasing do %>
559:                   <span class="flex items-center gap-2">
560:                     <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24">
561:                       <circle
562:                         class="opacity-25"
563:                         cx="12"
564:                         cy="12"
565:                         r="10"
566:                         stroke="currentColor"
567:                         stroke-width="4"
568:                         fill="none"
569:                       />
570:                       <path
571:                         class="opacity-75"
572:                         fill="currentColor"
573:                         d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
574:                       />
575:                     </svg>
576:                     Redirecionando...
577:                   </span>
578:                 <% else %>
579:                   Pagar com <%= if @payment_method == "pix", do: "PIX", else: "Cartao" %>
580:                 <% end %>
581:               </button>
582:             </div>
583:           </div>
584:         </div>
585:       </div>
586:     </div>
587:     """
588:   end
589: 
590:   defp billing_stat_card(assigns) do
591:     ~H"""
592:     <div class="bg-white dark:bg-slate-800 rounded-xl shadow-card border border-slate-200/50 dark:border-slate-700/50 p-4 group hover:shadow-elevated transition-all duration-300">
593:       <div class="flex items-center gap-3">
594:         <div class={[
595:           "w-11 h-11 rounded-xl flex items-center justify-center transition-transform duration-300 group-hover:scale-110",
596:           billing_stat_bg(@color)
597:         ]}>
598:           <.icon name={@icon} class={"h-5 w-5 " <> billing_stat_icon_color(@color)} />
599:         </div>
600:         <div>
601:           <p class="text-2xl font-bold text-slate-900 dark:text-white tracking-tight">
602:             <%= @value %>
603:           </p>
604:           <p class="text-xs text-slate-500 dark:text-slate-400"><%= @label %></p>
605:         </div>
606:       </div>
607:     </div>
608:     """
609:   end
610: 
611:   defp billing_stat_bg("teal"), do: "bg-teal-100 dark:bg-teal-900/30"
612:   defp billing_stat_bg("red"), do: "bg-red-100 dark:bg-red-900/30"
613:   defp billing_stat_bg("emerald"), do: "bg-emerald-100 dark:bg-emerald-900/30"
614:   defp billing_stat_bg("violet"), do: "bg-violet-100 dark:bg-violet-900/30"
615:   defp billing_stat_bg(_), do: "bg-slate-100 dark:bg-slate-900/30"
616: 
617:   defp billing_stat_icon_color("teal"), do: "text-teal-600 dark:text-teal-400"
618:   defp billing_stat_icon_color("red"), do: "text-red-600 dark:text-red-400"
619:   defp billing_stat_icon_color("emerald"), do: "text-emerald-600 dark:text-emerald-400"
620:   defp billing_stat_icon_color("violet"), do: "text-violet-600 dark:text-violet-400"
621:   defp billing_stat_icon_color(_), do: "text-slate-600 dark:text-slate-400"
622: 
623:   defp reason_label("lesson_analysis"), do: "Analise de Aula"
624:   defp reason_label("signup_bonus"), do: "Bonus de Cadastro"
625:   defp reason_label("purchase"), do: "Compra de Creditos"
626:   defp reason_label("refund"), do: "Reembolso"
627:   defp reason_label(reason), do: reason
628: end
````

## File: lib/hellen_web/live_auth.ex
````elixir
  1: defmodule HellenWeb.LiveAuth do
  2:   @moduledoc """
  3:   LiveView authentication hook.
  4: 
  5:   Handles user authentication for LiveView routes via on_mount callbacks.
  6: 
  7:   ## Usage
  8: 
  9:   In your router:
 10: 
 11:       live_session :public, on_mount: [{HellenWeb.LiveAuth, :none}] do
 12:         live "/login", AuthLive.Login
 13:       end
 14: 
 15:       live_session :authenticated, on_mount: [{HellenWeb.LiveAuth, :require_auth}] do
 16:         live "/", DashboardLive.Index
 17:       end
 18: 
 19:       live_session :coordinator, on_mount: [{HellenWeb.LiveAuth, :require_coordinator}] do
 20:         live "/institution", InstitutionLive.Index
 21:       end
 22:   """
 23: 
 24:   import Phoenix.LiveView
 25:   import Phoenix.Component
 26: 
 27:   alias Hellen.Accounts
 28:   alias Hellen.Auth.Guardian
 29: 
 30:   @doc """
 31:   Called when the LiveView is mounted.
 32: 
 33:   Supports four modes:
 34:   - `:none` - No authentication required, but loads user if present
 35:   - `:require_auth` - Requires authentication, redirects to login if not authenticated
 36:   - `:require_coordinator` - Requires coordinator or admin role
 37:   - `:require_admin` - Requires admin role only
 38:   """
 39:   def on_mount(:none, _params, session, socket) do
 40:     socket =
 41:       socket
 42:       |> assign_current_user(session)
 43:       |> assign_current_path()
 44: 
 45:     {:cont, socket}
 46:   end
 47: 
 48:   def on_mount(:require_auth, _params, session, socket) do
 49:     socket =
 50:       socket
 51:       |> assign_current_user(session)
 52:       |> assign_current_path()
 53: 
 54:     cond do
 55:       is_nil(socket.assigns.current_user) ->
 56:         {:halt, redirect(socket, to: "/login")}
 57: 
 58:       # Redirect to onboarding if not completed (but not if already on onboarding page)
 59:       not socket.assigns.current_user.onboarding_completed and
 60:           socket.assigns.current_path != "/onboarding" ->
 61:         {:halt, redirect(socket, to: "/onboarding")}
 62: 
 63:       true ->
 64:         {:cont, socket}
 65:     end
 66:   end
 67: 
 68:   def on_mount(:require_coordinator, _params, session, socket) do
 69:     socket =
 70:       socket
 71:       |> assign_current_user(session)
 72:       |> assign_current_path()
 73: 
 74:     cond do
 75:       is_nil(socket.assigns.current_user) ->
 76:         {:halt, redirect(socket, to: "/login")}
 77: 
 78:       not coordinator?(socket.assigns.current_user) ->
 79:         {:halt,
 80:          socket
 81:          |> put_flash(:error, "Acesso restrito a coordenadores")
 82:          |> redirect(to: "/dashboard")}
 83: 
 84:       true ->
 85:         {:cont, socket}
 86:     end
 87:   end
 88: 
 89:   def on_mount(:require_admin, _params, session, socket) do
 90:     socket =
 91:       socket
 92:       |> assign_current_user(session)
 93:       |> assign_current_path()
 94: 
 95:     cond do
 96:       is_nil(socket.assigns.current_user) ->
 97:         {:halt, redirect(socket, to: "/login")}
 98: 
 99:       not admin?(socket.assigns.current_user) ->
100:         {:halt,
101:          socket
102:          |> put_flash(:error, "Acesso restrito a administradores")
103:          |> redirect(to: "/dashboard")}
104: 
105:       true ->
106:         {:cont, socket}
107:     end
108:   end
109: 
110:   defp coordinator?(user) do
111:     user.role in ["coordinator", "admin", :coordinator, :admin]
112:   end
113: 
114:   defp admin?(user) do
115:     user.role in ["admin", :admin]
116:   end
117: 
118:   defp assign_current_user(socket, session) do
119:     case session["user_token"] do
120:       nil ->
121:         assign(socket, :current_user, nil)
122: 
123:       token ->
124:         case Guardian.resource_from_token(token) do
125:           {:ok, user, _claims} ->
126:             # Reload user to get fresh data
127:             user = Accounts.get_user(user.id) || user
128:             assign(socket, :current_user, user)
129: 
130:           {:error, _reason} ->
131:             assign(socket, :current_user, nil)
132:         end
133:     end
134:   end
135: 
136:   defp assign_current_path(socket) do
137:     path =
138:       case socket.private[:live_view_module] do
139:         nil -> "/"
140:         _module -> socket.private[:connect_info][:request_path] || "/"
141:       end
142: 
143:     assign(socket, :current_path, path)
144:   end
145: end
````

## File: lib/hellen_web.ex
````elixir
  1: defmodule HellenWeb do
  2:   @moduledoc """
  3:   The entrypoint for defining your web interface, such
  4:   as controllers, components, channels, and so on.
  5:   """
  6: 
  7:   def static_paths,
  8:     do: ~w(assets fonts images favicon.ico robots.txt manifest.json sw.js offline.html)
  9: 
 10:   def router do
 11:     quote do
 12:       use Phoenix.Router, helpers: false
 13: 
 14:       import Plug.Conn
 15:       import Phoenix.Controller
 16:       import Phoenix.LiveView.Router
 17:     end
 18:   end
 19: 
 20:   def channel do
 21:     quote do
 22:       use Phoenix.Channel
 23:     end
 24:   end
 25: 
 26:   def controller do
 27:     quote do
 28:       use Phoenix.Controller,
 29:         formats: [:html, :json],
 30:         layouts: [html: HellenWeb.Layouts]
 31: 
 32:       import Plug.Conn
 33:       import HellenWeb.Gettext
 34: 
 35:       unquote(verified_routes())
 36:     end
 37:   end
 38: 
 39:   def api_controller do
 40:     quote do
 41:       use Phoenix.Controller,
 42:         formats: [:json]
 43: 
 44:       import Plug.Conn
 45:       import HellenWeb.Gettext
 46: 
 47:       unquote(verified_routes())
 48: 
 49:       # Handle Ecto.NoResultsError gracefully
 50:       def action(conn, _opts) do
 51:         try do
 52:           apply(__MODULE__, action_name(conn), [conn, conn.params])
 53:         rescue
 54:           Ecto.NoResultsError ->
 55:             conn
 56:             |> put_status(:not_found)
 57:             |> put_view(json: HellenWeb.ErrorJSON)
 58:             |> Phoenix.Controller.render(:"404")
 59:             |> halt()
 60:         end
 61:       end
 62:     end
 63:   end
 64: 
 65:   def live_view do
 66:     quote do
 67:       use Phoenix.LiveView,
 68:         layout: {HellenWeb.Layouts, :app}
 69: 
 70:       unquote(html_helpers())
 71:     end
 72:   end
 73: 
 74:   def live_component do
 75:     quote do
 76:       use Phoenix.LiveComponent
 77: 
 78:       unquote(html_helpers())
 79:     end
 80:   end
 81: 
 82:   def html do
 83:     quote do
 84:       use Phoenix.Component
 85: 
 86:       import Phoenix.Controller,
 87:         only: [get_csrf_token: 0, view_module: 1, view_template: 1]
 88: 
 89:       unquote(html_helpers())
 90:     end
 91:   end
 92: 
 93:   defp html_helpers do
 94:     quote do
 95:       import Phoenix.HTML
 96:       import HellenWeb.CoreComponents
 97:       import HellenWeb.UIComponents
 98:       import HellenWeb.Gettext
 99: 
100:       alias Phoenix.LiveView.JS
101: 
102:       unquote(verified_routes())
103:     end
104:   end
105: 
106:   def verified_routes do
107:     quote do
108:       use Phoenix.VerifiedRoutes,
109:         endpoint: HellenWeb.Endpoint,
110:         router: HellenWeb.Router,
111:         statics: HellenWeb.static_paths()
112:     end
113:   end
114: 
115:   @doc """
116:   When used, dispatch to the appropriate controller/live_view/etc.
117:   """
118:   defmacro __using__(which) when is_atom(which) do
119:     apply(__MODULE__, which, [])
120:   end
121: end
````

## File: mix.exs
````elixir
  1: defmodule Hellen.MixProject do
  2:   use Mix.Project
  3: 
  4:   def project do
  5:     [
  6:       app: :hellen,
  7:       version: "0.1.0",
  8:       elixir: "~> 1.14",
  9:       elixirc_paths: elixirc_paths(Mix.env()),
 10:       start_permanent: Mix.env() == :prod,
 11:       aliases: aliases(),
 12:       deps: deps()
 13:     ]
 14:   end
 15: 
 16:   def application do
 17:     [
 18:       mod: {Hellen.Application, []},
 19:       extra_applications: [:logger, :runtime_tools]
 20:     ]
 21:   end
 22: 
 23:   defp elixirc_paths(:test), do: ["lib", "test/support"]
 24:   defp elixirc_paths(_), do: ["lib"]
 25: 
 26:   defp deps do
 27:     [
 28:       {:phoenix, "~> 1.7.14"},
 29:       {:phoenix_ecto, "~> 4.5"},
 30:       {:ecto_sql, "~> 3.11"},
 31:       {:postgrex, ">= 0.0.0"},
 32:       {:phoenix_html, "~> 4.1"},
 33:       {:phoenix_live_reload, "~> 1.2", only: :dev},
 34:       {:phoenix_live_view, "~> 0.20.17"},
 35:       {:phoenix_live_dashboard, "~> 0.8"},
 36:       {:floki, ">= 0.30.0", only: :test},
 37:       {:esbuild, "~> 0.8", runtime: Mix.env() == :dev},
 38:       {:tailwind, "~> 0.2", runtime: Mix.env() == :dev},
 39:       {:heroicons,
 40:        github: "tailwindlabs/heroicons",
 41:        tag: "v2.1.1",
 42:        sparse: "optimized",
 43:        app: false,
 44:        compile: false,
 45:        depth: 1},
 46:       {:telemetry_metrics, "~> 1.0"},
 47:       {:telemetry_poller, "~> 1.0"},
 48:       {:gettext, "~> 0.20"},
 49:       {:jason, "~> 1.2"},
 50:       {:dns_cluster, "~> 0.1.1"},
 51:       {:bandit, "~> 1.5"},
 52: 
 53:       # Jobs
 54:       {:oban, "~> 2.17"},
 55: 
 56:       # HTTP Client
 57:       {:req, "~> 0.5"},
 58: 
 59:       # Redis
 60:       {:redix, "~> 1.3"},
 61: 
 62:       # Storage (R2/S3)
 63:       {:ex_aws, "~> 2.5"},
 64:       {:ex_aws_s3, "~> 2.5"},
 65:       {:sweet_xml, "~> 0.7"},
 66:       {:hackney, "~> 1.20"},
 67: 
 68:       # PDF
 69:       {:chromic_pdf, "~> 1.15"},
 70: 
 71:       # Auth
 72:       {:guardian, "~> 2.3"},
 73:       {:bcrypt_elixir, "~> 3.0"},
 74: 
 75:       # Email
 76:       {:swoosh, "~> 1.14"},
 77:       {:finch, "~> 0.16"},
 78:       {:gen_smtp, "~> 1.0"},
 79: 
 80:       # Payments
 81:       {:stripity_stripe, "~> 3.2"},
 82: 
 83:       # Code quality
 84:       {:credo, "~> 1.7", only: [:dev, :test], runtime: false},
 85: 
 86:       # Testing
 87:       {:mox, "~> 1.1", only: :test},
 88:       {:ex_machina, "~> 2.8", only: :test},
 89:       {:excoveralls, "~> 0.18", only: :test}
 90:     ]
 91:   end
 92: 
 93:   defp aliases do
 94:     [
 95:       setup: ["deps.get", "ecto.setup", "assets.setup", "assets.build"],
 96:       "ecto.setup": ["ecto.create", "ecto.migrate", "run priv/repo/seeds.exs"],
 97:       "ecto.reset": ["ecto.drop", "ecto.setup"],
 98:       test: ["ecto.create --quiet", "ecto.migrate --quiet", "test"],
 99:       "assets.setup": ["tailwind.install --if-missing", "esbuild.install --if-missing"],
100:       "assets.build": ["tailwind hellen", "esbuild hellen"],
101:       "assets.deploy": [
102:         "tailwind hellen --minify",
103:         "esbuild hellen --minify",
104:         "phx.digest"
105:       ]
106:     ]
107:   end
108: end
````

## File: lib/hellen/accounts.ex
````elixir
  1: defmodule Hellen.Accounts do
  2:   @moduledoc """
  3:   The Accounts context - manages users and institutions.
  4:   """
  5: 
  6:   import Ecto.Query, warn: false
  7: 
  8:   alias Hellen.Accounts.{Institution, Invitation, User}
  9:   alias Hellen.Billing
 10:   alias Hellen.Repo
 11: 
 12:   ## User
 13: 
 14:   def get_user(id), do: Repo.get(User, id)
 15: 
 16:   def get_user!(id), do: Repo.get!(User, id)
 17: 
 18:   def get_user_by_email(email) when is_binary(email) do
 19:     Repo.get_by(User, email: email)
 20:   end
 21: 
 22:   def get_user_by_firebase_uid(firebase_uid) when is_binary(firebase_uid) do
 23:     Repo.get_by(User, firebase_uid: firebase_uid)
 24:   end
 25: 
 26:   @doc """
 27:   Finds or creates a user from Firebase authentication.
 28:   If user exists (by firebase_uid or email), updates and returns it.
 29:   Otherwise, creates a new user.
 30:   """
 31:   def find_or_create_from_firebase(firebase_info) do
 32:     %{firebase_uid: firebase_uid, email: email} = firebase_info
 33: 
 34:     case get_user_by_firebase_uid(firebase_uid) do
 35:       %User{} = user ->
 36:         # Update user info from Firebase
 37:         update_from_firebase(user, firebase_info)
 38: 
 39:       nil ->
 40:         # Check if user exists by email
 41:         case get_user_by_email(email) do
 42:           %User{} = user ->
 43:             # Link existing user to Firebase
 44:             update_from_firebase(user, firebase_info)
 45: 
 46:           nil ->
 47:             # Create new user
 48:             create_from_firebase(firebase_info)
 49:         end
 50:     end
 51:   end
 52: 
 53:   defp update_from_firebase(user, firebase_info) do
 54:     attrs = %{
 55:       firebase_uid: firebase_info.firebase_uid,
 56:       name: firebase_info[:name] || user.name,
 57:       email_verified: firebase_info[:email_verified] || false
 58:     }
 59: 
 60:     update_user(user, attrs)
 61:   end
 62: 
 63:   defp create_from_firebase(firebase_info) do
 64:     attrs = %{
 65:       firebase_uid: firebase_info.firebase_uid,
 66:       email: firebase_info.email,
 67:       name: firebase_info[:name] || "User",
 68:       email_verified: firebase_info[:email_verified] || false,
 69:       role: "teacher",
 70:       plan: "free",
 71:       # Generate random password for Firebase-only users
 72:       password: :crypto.strong_rand_bytes(32) |> Base.encode64()
 73:     }
 74: 
 75:     register_user(attrs)
 76:   end
 77: 
 78:   def register_user(attrs \\ %{}) do
 79:     %User{}
 80:     |> User.registration_changeset(attrs)
 81:     |> Repo.insert()
 82:     |> case do
 83:       {:ok, user} ->
 84:         # Grant signup bonus
 85:         Billing.grant_signup_bonus(user)
 86:         {:ok, user}
 87: 
 88:       error ->
 89:         error
 90:     end
 91:   end
 92: 
 93:   def authenticate_user(email, password) do
 94:     user = get_user_by_email(email)
 95: 
 96:     cond do
 97:       user && User.valid_password?(user, password) ->
 98:         {:ok, user}
 99: 
100:       user ->
101:         {:error, :invalid_password}
102: 
103:       true ->
104:         {:error, :user_not_found}
105:     end
106:   end
107: 
108:   def update_user(%User{} = user, attrs) do
109:     user
110:     |> User.changeset(attrs)
111:     |> Repo.update()
112:   end
113: 
114:   @doc """
115:   Update user's Stripe customer ID.
116:   """
117:   @spec update_stripe_customer_id(User.t(), String.t()) ::
118:           {:ok, User.t()} | {:error, Ecto.Changeset.t()}
119:   def update_stripe_customer_id(%User{} = user, customer_id) do
120:     user
121:     |> User.changeset(%{stripe_customer_id: customer_id})
122:     |> Repo.update()
123:   end
124: 
125:   @doc """
126:   Update user profile (name and email only).
127:   """
128:   @spec update_user_profile(User.t(), map()) :: {:ok, User.t()} | {:error, Ecto.Changeset.t()}
129:   def update_user_profile(%User{} = user, attrs) do
130:     user
131:     |> User.profile_changeset(attrs)
132:     |> Repo.update()
133:   end
134: 
135:   @doc """
136:   Update user onboarding progress.
137:   """
138:   @spec update_user_onboarding(User.t(), map()) :: {:ok, User.t()} | {:error, Ecto.Changeset.t()}
139:   def update_user_onboarding(%User{} = user, attrs) do
140:     user
141:     |> User.onboarding_changeset(attrs)
142:     |> Repo.update()
143:   end
144: 
145:   @doc """
146:   Mark user onboarding as completed.
147:   """
148:   @spec complete_onboarding(User.t()) :: {:ok, User.t()} | {:error, Ecto.Changeset.t()}
149:   def complete_onboarding(%User{} = user) do
150:     update_user_onboarding(user, %{onboarding_completed: true})
151:   end
152: 
153:   @doc """
154:   Change user password after verifying current password.
155:   Returns {:error, :invalid_password} if current password doesn't match.
156:   """
157:   @spec change_user_password(User.t(), String.t(), String.t()) ::
158:           {:ok, User.t()} | {:error, :invalid_password | Ecto.Changeset.t()}
159:   def change_user_password(%User{} = user, current_password, new_password) do
160:     if User.valid_password?(user, current_password) do
161:       user
162:       |> User.password_changeset(%{password: new_password})
163:       |> Repo.update()
164:     else
165:       {:error, :invalid_password}
166:     end
167:   end
168: 
169:   def list_users_by_institution(institution_id) do
170:     User
171:     |> where([u], u.institution_id == ^institution_id)
172:     |> Repo.all()
173:   end
174: 
175:   ## Institution
176: 
177:   def get_institution!(id), do: Repo.get!(Institution, id)
178: 
179:   def create_institution(attrs \\ %{}) do
180:     %Institution{}
181:     |> Institution.changeset(attrs)
182:     |> Repo.insert()
183:   end
184: 
185:   def update_institution(%Institution{} = institution, attrs) do
186:     institution
187:     |> Institution.changeset(attrs)
188:     |> Repo.update()
189:   end
190: 
191:   def list_institutions do
192:     Repo.all(Institution)
193:   end
194: 
195:   ## Coordinator Functions
196: 
197:   @doc """
198:   Get comprehensive statistics for an institution.
199:   Used by the coordinator dashboard.
200:   """
201:   @spec get_institution_stats(binary()) :: map()
202:   def get_institution_stats(institution_id) do
203:     teachers_count =
204:       User
205:       |> where([u], u.institution_id == ^institution_id)
206:       |> Repo.aggregate(:count)
207: 
208:     lessons_count =
209:       Hellen.Lessons.Lesson
210:       |> where([l], l.institution_id == ^institution_id)
211:       |> Repo.aggregate(:count)
212: 
213:     analyses_count =
214:       Hellen.Analysis.Analysis
215:       |> where([a], a.institution_id == ^institution_id)
216:       |> Repo.aggregate(:count)
217: 
218:     alerts_count =
219:       Hellen.Analysis.BullyingAlert
220:       |> join(:inner, [b], a in assoc(b, :analysis))
221:       |> where([b, a], a.institution_id == ^institution_id and b.reviewed == false)
222:       |> Repo.aggregate(:count)
223: 
224:     avg_score =
225:       Hellen.Analysis.Analysis
226:       |> where([a], a.institution_id == ^institution_id and not is_nil(a.overall_score))
227:       |> Repo.aggregate(:avg, :overall_score)
228: 
229:     %{
230:       teachers: teachers_count,
231:       lessons: lessons_count,
232:       analyses: analyses_count,
233:       alerts: alerts_count,
234:       avg_score: avg_score && Float.round(avg_score, 1)
235:     }
236:   end
237: 
238:   @doc """
239:   List all teachers in an institution with their statistics.
240:   Includes lessons count, analyses count, and average score.
241:   """
242:   @spec list_teachers_with_stats(binary()) :: [map()]
243:   def list_teachers_with_stats(institution_id) do
244:     users =
245:       User
246:       |> where([u], u.institution_id == ^institution_id)
247:       |> order_by([u], desc: u.inserted_at)
248:       |> Repo.all()
249: 
250:     Enum.map(users, fn user ->
251:       lessons_query =
252:         Hellen.Lessons.Lesson
253:         |> where([l], l.user_id == ^user.id)
254: 
255:       lessons_count = Repo.aggregate(lessons_query, :count)
256: 
257:       last_lesson =
258:         lessons_query
259:         |> order_by([l], desc: l.inserted_at)
260:         |> limit(1)
261:         |> Repo.one()
262: 
263:       analyses_count =
264:         Hellen.Analysis.Analysis
265:         |> join(:inner, [a], l in assoc(a, :lesson))
266:         |> where([a, l], l.user_id == ^user.id)
267:         |> Repo.aggregate(:count)
268: 
269:       avg_score =
270:         Hellen.Analysis.Analysis
271:         |> join(:inner, [a], l in assoc(a, :lesson))
272:         |> where([a, l], l.user_id == ^user.id and not is_nil(a.overall_score))
273:         |> Repo.aggregate(:avg, :overall_score)
274: 
275:       %{
276:         user: user,
277:         lessons_count: lessons_count,
278:         analyses_count: analyses_count,
279:         avg_score: avg_score && Float.round(avg_score, 1),
280:         last_activity: last_lesson && last_lesson.inserted_at
281:       }
282:     end)
283:   end
284: 
285:   @doc """
286:   Get lessons per teacher for chart visualization.
287:   Returns list of %{name: string, lessons: integer}
288:   """
289:   @spec get_lessons_per_teacher(binary()) :: [map()]
290:   def get_lessons_per_teacher(institution_id) do
291:     User
292:     |> where([u], u.institution_id == ^institution_id)
293:     |> join(:left, [u], l in Hellen.Lessons.Lesson, on: l.user_id == u.id)
294:     |> group_by([u, l], [u.id, u.name])
295:     |> select([u, l], %{name: u.name, lessons: count(l.id)})
296:     |> order_by([u, l], desc: count(l.id))
297:     |> limit(10)
298:     |> Repo.all()
299:   end
300: 
301:   @doc """
302:   Get recent lessons for an institution.
303:   Used by coordinator dashboard activity feed.
304:   """
305:   @spec list_recent_institution_lessons(binary(), keyword()) :: [Hellen.Lessons.Lesson.t()]
306:   def list_recent_institution_lessons(institution_id, opts \\ []) do
307:     limit = Keyword.get(opts, :limit, 10)
308: 
309:     Hellen.Lessons.Lesson
310:     |> where([l], l.institution_id == ^institution_id)
311:     |> order_by([l], desc: l.inserted_at)
312:     |> limit(^limit)
313:     |> preload(:user)
314:     |> Repo.all()
315:   end
316: 
317:   @doc """
318:   Invite a teacher to an institution.
319:   Creates a new user with a temporary password.
320:   """
321:   @spec invite_teacher_to_institution(binary(), map()) :: {:ok, User.t()} | {:error, term()}
322:   def invite_teacher_to_institution(institution_id, attrs) do
323:     # Generate a secure temporary password
324:     temp_password = :crypto.strong_rand_bytes(16) |> Base.url_encode64()
325: 
326:     user_attrs =
327:       attrs
328:       |> Map.put(:institution_id, institution_id)
329:       |> Map.put(:role, "teacher")
330:       |> Map.put(:password, temp_password)
331:       |> Map.put(:plan, "free")
332: 
333:     register_user(user_attrs)
334:   end
335: 
336:   @doc """
337:   Remove a teacher from an institution.
338:   Sets their institution_id to nil.
339:   """
340:   @spec remove_teacher_from_institution(User.t()) :: {:ok, User.t()} | {:error, term()}
341:   def remove_teacher_from_institution(%User{} = user) do
342:     user
343:     |> User.changeset(%{institution_id: nil})
344:     |> Repo.update()
345:   end
346: 
347:   @doc """
348:   Update a user's role.
349:   Only allows teacher <-> coordinator transitions.
350:   """
351:   @spec update_user_role(User.t(), String.t()) :: {:ok, User.t()} | {:error, term()}
352:   def update_user_role(%User{} = user, new_role) when new_role in ["teacher", "coordinator"] do
353:     user
354:     |> User.changeset(%{role: new_role})
355:     |> Repo.update()
356:   end
357: 
358:   def update_user_role(_user, _role), do: {:error, :invalid_role}
359: 
360:   ## Admin Functions
361: 
362:   @doc """
363:   Get system-wide statistics for admin dashboard.
364:   Returns counts for institutions, users, lessons, analyses, and pending alerts.
365:   """
366:   @spec get_system_stats() :: map()
367:   def get_system_stats do
368:     institutions_count = Repo.aggregate(Institution, :count)
369:     users_count = Repo.aggregate(User, :count)
370: 
371:     lessons_count = Repo.aggregate(Hellen.Lessons.Lesson, :count)
372:     analyses_count = Repo.aggregate(Hellen.Analysis.Analysis, :count)
373: 
374:     pending_alerts =
375:       Hellen.Analysis.BullyingAlert
376:       |> where([b], b.reviewed == false)
377:       |> Repo.aggregate(:count)
378: 
379:     users_by_role =
380:       User
381:       |> group_by([u], u.role)
382:       |> select([u], {u.role, count(u.id)})
383:       |> Repo.all()
384:       |> Map.new()
385: 
386:     users_by_plan =
387:       User
388:       |> group_by([u], u.plan)
389:       |> select([u], {u.plan, count(u.id)})
390:       |> Repo.all()
391:       |> Map.new()
392: 
393:     %{
394:       institutions: institutions_count,
395:       users: users_count,
396:       lessons: lessons_count,
397:       analyses: analyses_count,
398:       pending_alerts: pending_alerts,
399:       users_by_role: users_by_role,
400:       users_by_plan: users_by_plan
401:     }
402:   end
403: 
404:   @doc """
405:   List all institutions with their statistics.
406:   """
407:   @spec list_institutions_with_stats() :: [map()]
408:   def list_institutions_with_stats do
409:     institutions = Repo.all(from i in Institution, order_by: [desc: i.inserted_at])
410: 
411:     Enum.map(institutions, fn institution ->
412:       users_count =
413:         User
414:         |> where([u], u.institution_id == ^institution.id)
415:         |> Repo.aggregate(:count)
416: 
417:       lessons_count =
418:         Hellen.Lessons.Lesson
419:         |> where([l], l.institution_id == ^institution.id)
420:         |> Repo.aggregate(:count)
421: 
422:       analyses_count =
423:         Hellen.Analysis.Analysis
424:         |> where([a], a.institution_id == ^institution.id)
425:         |> Repo.aggregate(:count)
426: 
427:       %{
428:         institution: institution,
429:         users_count: users_count,
430:         lessons_count: lessons_count,
431:         analyses_count: analyses_count
432:       }
433:     end)
434:   end
435: 
436:   @doc """
437:   List all users with optional filters.
438:   Supports: role, plan, institution_id, search (name/email), pagination.
439:   """
440:   @spec list_all_users(keyword()) :: {[User.t()], integer()}
441:   def list_all_users(opts \\ []) do
442:     role = Keyword.get(opts, :role)
443:     plan = Keyword.get(opts, :plan)
444:     institution_id = Keyword.get(opts, :institution_id)
445:     search = Keyword.get(opts, :search)
446:     page = Keyword.get(opts, :page, 1)
447:     per_page = Keyword.get(opts, :per_page, 20)
448: 
449:     query =
450:       User
451:       |> order_by([u], desc: u.inserted_at)
452: 
453:     query =
454:       if role do
455:         where(query, [u], u.role == ^role)
456:       else
457:         query
458:       end
459: 
460:     query =
461:       if plan do
462:         where(query, [u], u.plan == ^plan)
463:       else
464:         query
465:       end
466: 
467:     query =
468:       if institution_id do
469:         where(query, [u], u.institution_id == ^institution_id)
470:       else
471:         query
472:       end
473: 
474:     query =
475:       if search && search != "" do
476:         search_term = "%#{search}%"
477:         where(query, [u], ilike(u.name, ^search_term) or ilike(u.email, ^search_term))
478:       else
479:         query
480:       end
481: 
482:     total = Repo.aggregate(query, :count)
483: 
484:     users =
485:       query
486:       |> limit(^per_page)
487:       |> offset(^((page - 1) * per_page))
488:       |> preload(:institution)
489:       |> Repo.all()
490: 
491:     {users, total}
492:   end
493: 
494:   @doc """
495:   Admin function to update any user's role.
496:   Allows all role transitions including admin.
497:   """
498:   @spec admin_update_user_role(User.t(), String.t()) :: {:ok, User.t()} | {:error, term()}
499:   def admin_update_user_role(%User{} = user, new_role)
500:       when new_role in ["teacher", "coordinator", "admin"] do
501:     user
502:     |> User.changeset(%{role: new_role})
503:     |> Repo.update()
504:   end
505: 
506:   def admin_update_user_role(_user, _role), do: {:error, :invalid_role}
507: 
508:   @doc """
509:   Admin function to assign a user to an institution.
510:   Pass nil to remove from institution.
511:   """
512:   @spec admin_assign_user_to_institution(User.t(), binary() | nil) ::
513:           {:ok, User.t()} | {:error, term()}
514:   def admin_assign_user_to_institution(%User{} = user, institution_id) do
515:     user
516:     |> User.changeset(%{institution_id: institution_id})
517:     |> Repo.update()
518:   end
519: 
520:   @doc """
521:   Admin function to update a user's plan.
522:   """
523:   @spec admin_update_user_plan(User.t(), String.t()) :: {:ok, User.t()} | {:error, term()}
524:   def admin_update_user_plan(%User{} = user, new_plan)
525:       when new_plan in ["free", "pro", "enterprise"] do
526:     user
527:     |> User.changeset(%{plan: new_plan})
528:     |> Repo.update()
529:   end
530: 
531:   def admin_update_user_plan(_user, _plan), do: {:error, :invalid_plan}
532: 
533:   @doc """
534:   Admin function to add credits to a user.
535:   """
536:   @spec admin_add_user_credits(User.t(), integer(), String.t()) ::
537:           {:ok, User.t()} | {:error, term()}
538:   def admin_add_user_credits(%User{} = user, amount, reason \\ "admin_grant") when amount > 0 do
539:     Hellen.Billing.add_credits(user, amount, reason)
540:   end
541: 
542:   @doc """
543:   Get daily user registrations for the last N days.
544:   Used for admin dashboard chart.
545:   """
546:   @spec get_daily_registrations(integer()) :: [map()]
547:   def get_daily_registrations(days \\ 30) do
548:     start_date = Date.utc_today() |> Date.add(-days)
549: 
550:     User
551:     |> where([u], fragment("?::date", u.inserted_at) >= ^start_date)
552:     |> group_by([u], fragment("?::date", u.inserted_at))
553:     |> select([u], %{date: fragment("?::date", u.inserted_at), count: count(u.id)})
554:     |> order_by([u], fragment("?::date", u.inserted_at))
555:     |> Repo.all()
556:   end
557: 
558:   @doc """
559:   Get recent activity across the platform.
560:   Returns recent lessons, analyses, and alerts.
561:   """
562:   @spec get_recent_platform_activity(integer()) :: map()
563:   def get_recent_platform_activity(limit \\ 10) do
564:     recent_lessons =
565:       Hellen.Lessons.Lesson
566:       |> order_by([l], desc: l.inserted_at)
567:       |> limit(^limit)
568:       |> preload([:user, :institution])
569:       |> Repo.all()
570: 
571:     recent_analyses =
572:       Hellen.Analysis.Analysis
573:       |> order_by([a], desc: a.inserted_at)
574:       |> limit(^limit)
575:       |> preload(lesson: [:user, :institution])
576:       |> Repo.all()
577: 
578:     recent_alerts =
579:       Hellen.Analysis.BullyingAlert
580:       |> where([b], b.reviewed == false)
581:       |> order_by([b], desc: b.inserted_at)
582:       |> limit(^limit)
583:       |> preload(analysis: [lesson: [:user, :institution]])
584:       |> Repo.all()
585: 
586:     %{
587:       lessons: recent_lessons,
588:       analyses: recent_analyses,
589:       alerts: recent_alerts
590:     }
591:   end
592: 
593:   ## Invitation Functions
594: 
595:   @doc """
596:   Creates an invitation to join an institution.
597:   """
598:   @spec create_invitation(binary(), map(), User.t()) ::
599:           {:ok, Invitation.t()} | {:error, Ecto.Changeset.t()}
600:   def create_invitation(institution_id, attrs, invited_by) do
601:     attrs =
602:       attrs
603:       |> Map.put(:institution_id, institution_id)
604:       |> Map.put(:invited_by_id, invited_by.id)
605: 
606:     %Invitation{}
607:     |> Invitation.changeset(attrs)
608:     |> Repo.insert()
609:   end
610: 
611:   @doc """
612:   Gets an invitation by token.
613:   """
614:   @spec get_invitation_by_token(String.t()) :: Invitation.t() | nil
615:   def get_invitation_by_token(token) when is_binary(token) do
616:     Invitation
617:     |> where([i], i.token == ^token)
618:     |> preload([:institution, :invited_by])
619:     |> Repo.one()
620:   end
621: 
622:   @doc """
623:   Lists pending invitations for an institution.
624:   """
625:   @spec list_pending_invitations(binary()) :: [Invitation.t()]
626:   def list_pending_invitations(institution_id) do
627:     now = DateTime.utc_now()
628: 
629:     Invitation
630:     |> where([i], i.institution_id == ^institution_id)
631:     |> where([i], is_nil(i.accepted_at) and is_nil(i.revoked_at))
632:     |> where([i], i.expires_at > ^now)
633:     |> order_by([i], desc: i.inserted_at)
634:     |> preload(:invited_by)
635:     |> Repo.all()
636:   end
637: 
638:   @doc """
639:   Accepts an invitation and creates/updates the user.
640:   """
641:   @spec accept_invitation(String.t(), map()) ::
642:           {:ok, User.t()} | {:error, atom() | Ecto.Changeset.t()}
643:   def accept_invitation(token, user_attrs) do
644:     with {:ok, invitation} <- fetch_invitation_by_token(token),
645:          :ok <- validate_invitation(invitation) do
646:       do_accept_invitation(invitation, user_attrs)
647:     end
648:   end
649: 
650:   defp fetch_invitation_by_token(token) do
651:     case get_invitation_by_token(token) do
652:       nil -> {:error, :not_found}
653:       invitation -> {:ok, invitation}
654:     end
655:   end
656: 
657:   defp validate_invitation(invitation) do
658:     cond do
659:       invitation.accepted_at -> {:error, :already_accepted}
660:       invitation.revoked_at -> {:error, :revoked}
661:       Invitation.expired?(invitation) -> {:error, :expired}
662:       Invitation.valid?(invitation) -> :ok
663:       true -> {:error, :invalid}
664:     end
665:   end
666: 
667:   defp do_accept_invitation(invitation, user_attrs) do
668:     user_attrs =
669:       user_attrs
670:       |> Map.put(:institution_id, invitation.institution_id)
671:       |> Map.put(:role, invitation.role)
672:       |> Map.put_new(:name, invitation.name)
673:       |> Map.put_new(:email, invitation.email)
674: 
675:     Ecto.Multi.new()
676:     |> Ecto.Multi.run(:user, fn _repo, _changes ->
677:       case get_user_by_email(invitation.email) do
678:         nil ->
679:           register_user(user_attrs)
680: 
681:         existing_user ->
682:           update_user(existing_user, %{
683:             institution_id: invitation.institution_id,
684:             role: invitation.role
685:           })
686:       end
687:     end)
688:     |> Ecto.Multi.update(:invitation, fn %{user: user} ->
689:       Invitation.accept_changeset(invitation, %{
690:         user_id: user.id,
691:         accepted_at: DateTime.utc_now() |> DateTime.truncate(:second)
692:       })
693:     end)
694:     |> Repo.transaction()
695:     |> case do
696:       {:ok, %{user: user}} -> {:ok, user}
697:       {:error, _op, changeset, _changes} -> {:error, changeset}
698:     end
699:   end
700: 
701:   @doc """
702:   Revokes an invitation.
703:   """
704:   @spec revoke_invitation(binary()) :: {:ok, Invitation.t()} | {:error, term()}
705:   def revoke_invitation(invitation_id) do
706:     case Repo.get(Invitation, invitation_id) do
707:       nil ->
708:         {:error, :not_found}
709: 
710:       invitation ->
711:         invitation
712:         |> Invitation.revoke_changeset()
713:         |> Repo.update()
714:     end
715:   end
716: 
717:   @doc """
718:   Resends an invitation by revoking the old one and creating a new one.
719:   """
720:   @spec resend_invitation(binary()) :: {:ok, Invitation.t()} | {:error, term()}
721:   def resend_invitation(invitation_id) do
722:     case Repo.get(Invitation, invitation_id) |> Repo.preload(:invited_by) do
723:       nil ->
724:         {:error, :not_found}
725: 
726:       invitation ->
727:         Ecto.Multi.new()
728:         |> Ecto.Multi.update(:revoke, Invitation.revoke_changeset(invitation))
729:         |> Ecto.Multi.insert(:new_invitation, fn _changes ->
730:           %Invitation{}
731:           |> Invitation.changeset(%{
732:             email: invitation.email,
733:             name: invitation.name,
734:             role: invitation.role,
735:             institution_id: invitation.institution_id,
736:             invited_by_id: invitation.invited_by_id
737:           })
738:         end)
739:         |> Repo.transaction()
740:         |> case do
741:           {:ok, %{new_invitation: new_invitation}} -> {:ok, new_invitation}
742:           {:error, _op, changeset, _changes} -> {:error, changeset}
743:         end
744:     end
745:   end
746: end
````

## File: lib/hellen_web/components/layouts/root.html.heex
````
 1: <!DOCTYPE html>
 2: <html lang="pt-BR" class="h-full">
 3:   <head>
 4:     <meta charset="utf-8" />
 5:     <meta name="viewport" content="width=device-width, initial-scale=1" />
 6:     <meta name="csrf-token" content={get_csrf_token()} />
 7:     <meta
 8:       name="description"
 9:       content="Plataforma de analise pedagogica com inteligencia artificial"
10:     />
11:     <!-- PWA Meta Tags -->
12:     <meta name="theme-color" content="#0d9488" media="(prefers-color-scheme: light)" />
13:     <meta name="theme-color" content="#134e4a" media="(prefers-color-scheme: dark)" />
14:     <meta name="mobile-web-app-capable" content="yes" />
15:     <meta name="apple-mobile-web-app-capable" content="yes" />
16:     <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
17:     <meta name="apple-mobile-web-app-title" content="Hellen AI" />
18:     <link rel="manifest" href="/manifest.json" />
19:     <link rel="apple-touch-icon" href="/images/icons/icon-192x192.png" />
20:     <.live_title suffix=" · Hellen AI">
21:       <%= assigns[:page_title] || "Hellen" %>
22:     </.live_title>
23:     <script>
24:       (function() {
25:         const theme = localStorage.getItem("theme") ||
26:           (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
27:         document.documentElement.classList.toggle("dark", theme === "dark");
28:       })();
29:     </script>
30:     <link rel="preconnect" href="https://rsms.me/" />
31:     <link rel="stylesheet" href="https://rsms.me/inter/inter.css" />
32:     <link phx-track-static rel="stylesheet" href={~p"/assets/app.css"} />
33:     <script src="https://cdn.jsdelivr.net/npm/apexcharts">
34:     </script>
35:     <!-- Firebase SDK -->
36:     <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js">
37:     </script>
38:     <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js">
39:     </script>
40:     <script defer phx-track-static type="text/javascript" src={~p"/assets/app.js"}>
41:     </script>
42:   </head>
43:   <body class="h-full bg-slate-50 dark:bg-slate-900 antialiased transition-colors duration-200">
44:     <%= @inner_content %>
45:   </body>
46: </html>
````

## File: lib/hellen_web/components/sidebar.ex
````elixir
  1: defmodule HellenWeb.Sidebar do
  2:   @moduledoc """
  3:   Sidebar navigation component for the app layout.
  4:   Modern 2025 design with:
  5:   - Teal/Sage color palette
  6:   - Collapsible sidebar (desktop)
  7:   - Drawer sidebar (mobile)
  8:   - Global search shortcut (Cmd+K)
  9:   - User profile section
 10:   - Theme toggle
 11:   """
 12:   use Phoenix.Component
 13: 
 14:   alias Phoenix.LiveView.JS
 15: 
 16:   import HellenWeb.CoreComponents
 17: 
 18:   use Phoenix.VerifiedRoutes,
 19:     endpoint: HellenWeb.Endpoint,
 20:     router: HellenWeb.Router,
 21:     statics: HellenWeb.static_paths()
 22: 
 23:   attr :current_user, :map, required: true
 24:   attr :current_path, :string, default: "/"
 25:   attr :collapsed, :boolean, default: false
 26: 
 27:   slot :notification_bell
 28: 
 29:   def sidebar(assigns) do
 30:     ~H"""
 31:     <!-- Mobile Menu Button -->
 32:     <div class="lg:hidden fixed top-4 left-4 z-50">
 33:       <button
 34:         type="button"
 35:         phx-click={show_mobile_menu()}
 36:         class="p-2.5 rounded-xl bg-white dark:bg-slate-800 shadow-card border border-slate-200/50 dark:border-slate-700/50 hover:shadow-elevated transition-all duration-200"
 37:       >
 38:         <.icon name="hero-bars-3" class="h-5 w-5 text-slate-600 dark:text-slate-300" />
 39:       </button>
 40:     </div>
 41:     <!-- Mobile Overlay -->
 42:     <div
 43:       id="sidebar-overlay"
 44:       class="hidden lg:hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-40"
 45:       phx-click={hide_mobile_menu()}
 46:     >
 47:     </div>
 48:     <!-- Sidebar -->
 49:     <aside
 50:       id="sidebar"
 51:       phx-hook="SidebarHook"
 52:       class="fixed inset-y-0 left-0 z-50 w-64 bg-sidebar dark:bg-slate-900 border-r border-sidebar-border dark:border-slate-800 transform -translate-x-full lg:translate-x-0 transition-all duration-300 ease-out flex flex-col shadow-xl lg:shadow-none"
 53:     >
 54:       <!-- Logo Section -->
 55:       <div class="h-16 flex items-center justify-between px-5 border-b border-sidebar-border dark:border-slate-800">
 56:         <a href="/dashboard" class="flex items-center group">
 57:           <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center shadow-sm group-hover:shadow-glow-teal transition-shadow duration-300">
 58:             <span class="text-white font-bold text-sm">H</span>
 59:           </div>
 60:           <span class="ml-2.5 text-lg font-bold text-sidebar-foreground">
 61:             Hellen
 62:           </span>
 63:           <span class="ml-1 text-[10px] font-semibold px-1.5 py-0.5 rounded bg-teal-500/10 text-teal-600 dark:text-teal-400">
 64:             AI
 65:           </span>
 66:         </a>
 67:         <!-- Mobile close button -->
 68:         <button
 69:           type="button"
 70:           phx-click={hide_mobile_menu()}
 71:           class="lg:hidden p-1.5 rounded-lg hover:bg-sidebar-muted dark:hover:bg-slate-800 transition-colors"
 72:         >
 73:           <.icon name="hero-x-mark" class="h-5 w-5 text-sidebar-muted dark:text-slate-400" />
 74:         </button>
 75:       </div>
 76:       <!-- Search Button (Cmd+K) -->
 77:       <div class="px-4 py-3">
 78:         <button
 79:           type="button"
 80:           phx-click={JS.dispatch("open-search")}
 81:           class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl bg-sidebar-muted/50 dark:bg-slate-800/50 border border-sidebar-border dark:border-slate-700/50 text-sm text-sidebar-muted dark:text-slate-400 hover:bg-sidebar-muted dark:hover:bg-slate-800 hover:border-slate-300 dark:hover:border-slate-600 transition-all duration-200 group"
 82:         >
 83:           <.icon name="hero-magnifying-glass" class="h-4 w-4" />
 84:           <span class="flex-1 text-left">Buscar...</span>
 85:           <kbd class="hidden sm:inline-flex items-center gap-1 px-1.5 py-0.5 text-xs font-medium bg-sidebar-muted dark:bg-slate-700 rounded border border-sidebar-border dark:border-slate-600 text-sidebar-muted dark:text-slate-400 group-hover:border-slate-400 dark:group-hover:border-slate-500 transition-colors">
 86:             <span class="text-[10px]">⌘</span>K
 87:           </kbd>
 88:         </button>
 89:       </div>
 90:       <!-- Navigation -->
 91:       <nav class="flex-1 overflow-y-auto py-2 px-3 scrollbar-thin">
 92:         <!-- Main Menu -->
 93:         <div class="space-y-0.5">
 94:           <p class="px-3 py-2 text-[11px] font-semibold text-sidebar-muted dark:text-slate-500 uppercase tracking-wider">
 95:             Principal
 96:           </p>
 97:           <.nav_item
 98:             path={~p"/dashboard"}
 99:             icon="hero-squares-2x2"
100:             label="Dashboard"
101:             current_path={@current_path}
102:           />
103:           <.nav_item
104:             path={~p"/lessons/new"}
105:             icon="hero-plus-circle"
106:             label="Nova Aula"
107:             current_path={@current_path}
108:             highlight={true}
109:           />
110:           <.nav_item
111:             path={~p"/aulas"}
112:             icon="hero-academic-cap"
113:             label="Minhas Aulas"
114:             current_path={@current_path}
115:           />
116:           <.nav_item
117:             path={~p"/analytics"}
118:             icon="hero-chart-bar-square"
119:             label="Analytics"
120:             current_path={@current_path}
121:           />
122:           <.nav_item
123:             path={~p"/billing"}
124:             icon="hero-credit-card"
125:             label="Creditos"
126:             current_path={@current_path}
127:           />
128:         </div>
129:         <!-- Ferramentas Pedagogicas -->
130:         <div class="mt-6 space-y-0.5">
131:           <p class="px-3 py-2 text-[11px] font-semibold text-sidebar-muted dark:text-slate-500 uppercase tracking-wider">
132:             Ferramentas
133:           </p>
134:           <.nav_item
135:             path={~p"/plannings"}
136:             icon="hero-document-text"
137:             label="Planejamentos"
138:             current_path={@current_path}
139:           />
140:           <.nav_item
141:             path={~p"/assessments"}
142:             icon="hero-clipboard-document-list"
143:             label="Avaliacoes"
144:             current_path={@current_path}
145:           />
146:           <.nav_item
147:             path={~p"/reports"}
148:             icon="hero-chart-bar"
149:             label="Relatorios"
150:             current_path={@current_path}
151:           />
152:         </div>
153:         <!-- Coordinator Menu (conditional) -->
154:         <div :if={coordinator?(@current_user)} class="mt-6 space-y-0.5">
155:           <p class="px-3 py-2 text-[11px] font-semibold text-sidebar-muted dark:text-slate-500 uppercase tracking-wider">
156:             Coordenacao
157:           </p>
158:           <.nav_item
159:             path={~p"/institution"}
160:             icon="hero-building-office"
161:             label="Instituicao"
162:             current_path={@current_path}
163:           />
164:           <.nav_item
165:             path={~p"/institution/teachers"}
166:             icon="hero-users"
167:             label="Equipe"
168:             current_path={@current_path}
169:           />
170:           <.nav_item
171:             path={~p"/alerts"}
172:             icon="hero-bell-alert"
173:             label="Alertas"
174:             current_path={@current_path}
175:           />
176:         </div>
177:         <!-- Admin Menu (conditional) -->
178:         <div :if={admin?(@current_user)} class="mt-6 space-y-0.5">
179:           <p class="px-3 py-2 text-[11px] font-semibold text-sidebar-muted dark:text-slate-500 uppercase tracking-wider">
180:             Administracao
181:           </p>
182:           <.nav_item
183:             path={~p"/admin"}
184:             icon="hero-shield-check"
185:             label="Painel Admin"
186:             current_path={@current_path}
187:           />
188:           <.nav_item
189:             path={~p"/admin/institutions"}
190:             icon="hero-building-office-2"
191:             label="Instituicoes"
192:             current_path={@current_path}
193:           />
194:           <.nav_item
195:             path={~p"/admin/users"}
196:             icon="hero-user-group"
197:             label="Usuarios"
198:             current_path={@current_path}
199:           />
200:           <.nav_item
201:             path={~p"/admin/health"}
202:             icon="hero-server-stack"
203:             label="Sistema"
204:             current_path={@current_path}
205:           />
206:         </div>
207:       </nav>
208:       <!-- Credits Display -->
209:       <div :if={@current_user.credits} class="mx-4 mb-3">
210:         <div class="p-3 rounded-xl bg-gradient-to-br from-teal-500/10 to-sage-500/10 dark:from-teal-900/20 dark:to-sage-900/20 border border-teal-200/50 dark:border-teal-800/50">
211:           <div class="flex items-center justify-between">
212:             <div class="flex items-center gap-2">
213:               <div class="w-8 h-8 rounded-lg bg-teal-500/20 dark:bg-teal-500/10 flex items-center justify-center">
214:                 <.icon name="hero-bolt" class="h-4 w-4 text-teal-600 dark:text-teal-400" />
215:               </div>
216:               <div>
217:                 <p class="text-xs text-slate-500 dark:text-slate-400">Creditos</p>
218:                 <p class="text-sm font-bold text-slate-900 dark:text-white">
219:                   <%= @current_user.credits %>
220:                 </p>
221:               </div>
222:             </div>
223:             <a
224:               href="/billing"
225:               class="px-2.5 py-1 text-xs font-medium text-teal-600 dark:text-teal-400 hover:text-teal-700 dark:hover:text-teal-300 hover:bg-teal-500/10 rounded-lg transition-colors"
226:             >
227:               + Comprar
228:             </a>
229:           </div>
230:         </div>
231:       </div>
232:       <!-- User Section -->
233:       <div class="border-t border-sidebar-border dark:border-slate-800 p-4">
234:         <div class="flex items-center gap-3 mb-3">
235:           <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-teal-500 to-sage-500 flex items-center justify-center text-white font-semibold text-sm shadow-sm">
236:             <%= String.first(@current_user.name || @current_user.email) |> String.upcase() %>
237:           </div>
238:           <div class="flex-1 min-w-0">
239:             <p class="text-sm font-semibold text-sidebar-foreground dark:text-white truncate">
240:               <%= @current_user.name || "Usuario" %>
241:             </p>
242:             <p class="text-xs text-sidebar-muted dark:text-slate-400 truncate flex items-center gap-1">
243:               <span class={[
244:                 "w-1.5 h-1.5 rounded-full",
245:                 role_color(@current_user.role)
246:               ]}>
247:               </span>
248:               <%= role_label(@current_user.role) %>
249:             </p>
250:           </div>
251:         </div>
252: 
253:         <div class="flex items-center justify-between">
254:           <!-- Notification Bell (from slot) -->
255:           <%= render_slot(@notification_bell) %>
256:           <!-- Settings -->
257:           <a
258:             href="/settings"
259:             class="p-2 rounded-lg hover:bg-sidebar-muted dark:hover:bg-slate-800 transition-colors text-sidebar-muted dark:text-slate-400 hover:text-teal-600 dark:hover:text-teal-400"
260:             title="Configuracoes"
261:           >
262:             <.icon name="hero-cog-6-tooth" class="h-5 w-5" />
263:           </a>
264:           <!-- Theme Toggle -->
265:           <button
266:             type="button"
267:             id="sidebar-theme-toggle"
268:             phx-hook="ThemeToggle"
269:             class="p-2 rounded-lg hover:bg-sidebar-muted dark:hover:bg-slate-800 transition-colors text-sidebar-muted dark:text-slate-400 hover:text-amber-500 dark:hover:text-amber-400"
270:             title="Alternar tema"
271:           >
272:             <.icon name="hero-moon" class="h-5 w-5 dark:hidden" />
273:             <.icon name="hero-sun" class="h-5 w-5 hidden dark:block" />
274:           </button>
275:           <!-- Logout -->
276:           <a
277:             href="/logout"
278:             class="p-2 rounded-lg hover:bg-sidebar-muted dark:hover:bg-slate-800 transition-colors text-sidebar-muted dark:text-slate-400 hover:text-red-500 dark:hover:text-red-400"
279:             title="Sair"
280:           >
281:             <.icon name="hero-arrow-right-on-rectangle" class="h-5 w-5" />
282:           </a>
283:         </div>
284:       </div>
285:     </aside>
286:     """
287:   end
288: 
289:   attr :path, :string, required: true
290:   attr :icon, :string, required: true
291:   attr :label, :string, required: true
292:   attr :current_path, :string, required: true
293:   attr :badge, :integer, default: nil
294:   attr :highlight, :boolean, default: false
295: 
296:   defp nav_item(assigns) do
297:     is_active = String.starts_with?(assigns.current_path, assigns.path)
298:     assigns = assign(assigns, :is_active, is_active)
299: 
300:     ~H"""
301:     <a
302:       href={@path}
303:       class={[
304:         "flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 group",
305:         @is_active && "bg-teal-500/10 dark:bg-teal-500/15 text-teal-700 dark:text-teal-300 shadow-sm",
306:         !@is_active && !@highlight &&
307:           "text-sidebar-foreground dark:text-slate-300 hover:bg-sidebar-muted dark:hover:bg-slate-800/70 hover:text-teal-600 dark:hover:text-teal-400",
308:         !@is_active && @highlight &&
309:           "text-teal-600 dark:text-teal-400 hover:bg-teal-500/10 dark:hover:bg-teal-500/15"
310:       ]}
311:     >
312:       <span class={[
313:         "flex-shrink-0 transition-transform duration-200",
314:         @is_active && "scale-110"
315:       ]}>
316:         <.icon name={@icon} class="h-5 w-5" />
317:       </span>
318:       <span class="flex-1"><%= @label %></span>
319:       <span
320:         :if={@badge}
321:         class="px-2 py-0.5 text-xs font-semibold bg-teal-500/20 dark:bg-teal-500/30 text-teal-700 dark:text-teal-300 rounded-full"
322:       >
323:         <%= @badge %>
324:       </span>
325:       <span :if={@is_active} class="w-1 h-6 rounded-full bg-teal-500"></span>
326:     </a>
327:     """
328:   end
329: 
330:   attr :icon, :string, required: true
331:   attr :label, :string, required: true
332: 
333:   defp nav_item_disabled(assigns) do
334:     ~H"""
335:     <div class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium text-slate-400 dark:text-slate-600 cursor-not-allowed">
336:       <.icon name={@icon} class="h-5 w-5" />
337:       <span class="flex-1"><%= @label %></span>
338:       <span class="px-1.5 py-0.5 text-[10px] font-medium bg-slate-100 dark:bg-slate-800 text-slate-400 dark:text-slate-600 rounded uppercase tracking-wide">
339:         soon
340:       </span>
341:     </div>
342:     """
343:   end
344: 
345:   defp coordinator?(user) do
346:     user && user.role in ["coordinator", "admin"]
347:   end
348: 
349:   defp admin?(user) do
350:     user && user.role == "admin"
351:   end
352: 
353:   defp role_label("admin"), do: "Administrador"
354:   defp role_label("coordinator"), do: "Coordenador"
355:   defp role_label("teacher"), do: "Professor"
356:   defp role_label(_), do: "Usuario"
357: 
358:   defp role_color("admin"), do: "bg-violet-500"
359:   defp role_color("coordinator"), do: "bg-teal-500"
360:   defp role_color("teacher"), do: "bg-sage-500"
361:   defp role_color(_), do: "bg-slate-400"
362: 
363:   defp show_mobile_menu do
364:     %JS{}
365:     |> JS.remove_class("hidden", to: "#sidebar-overlay")
366:     |> JS.remove_class("-translate-x-full", to: "#sidebar")
367:   end
368: 
369:   defp hide_mobile_menu do
370:     %JS{}
371:     |> JS.add_class("hidden", to: "#sidebar-overlay")
372:     |> JS.add_class("-translate-x-full", to: "#sidebar")
373:   end
374: end
````

## File: lib/hellen_web/live/lesson_live/new.ex
````elixir
  1: defmodule HellenWeb.LessonLive.New do
  2:   use HellenWeb, :live_view
  3: 
  4:   alias Hellen.Lessons
  5:   alias Hellen.Storage
  6: 
  7:   # 500MB
  8:   @max_file_size 500 * 1024 * 1024
  9:   @accepted_types ~w(.mp3 .mp4 .m4a .wav .webm .ogg .flac .mov .avi .mkv)
 10: 
 11:   @impl true
 12:   def mount(_params, _session, socket) do
 13:     {:ok,
 14:      socket
 15:      |> assign(page_title: "Nova Aula")
 16:      |> assign(form: to_form(%{"title" => "", "subject" => ""}, as: :lesson))
 17:      |> assign(uploading: false)
 18:      |> assign(upload_state: :empty)
 19:      |> allow_upload(:media,
 20:        accept: @accepted_types,
 21:        max_entries: 1,
 22:        max_file_size: @max_file_size,
 23:        auto_upload: true
 24:      )}
 25:   end
 26: 
 27:   @impl true
 28:   def handle_event("validate", %{"lesson" => params}, socket) do
 29:     form = to_form(params, as: :lesson)
 30:     {:noreply, assign(socket, form: form)}
 31:   end
 32: 
 33:   @impl true
 34:   def handle_event("submit", %{"lesson" => params}, socket) do
 35:     user = socket.assigns.current_user
 36: 
 37:     # Start upload process
 38:     socket = assign(socket, uploading: true)
 39: 
 40:     # Upload files to R2 and create lesson
 41:     case upload_and_create_lesson(socket, user, params) do
 42:       {:ok, lesson} ->
 43:         {:noreply,
 44:          socket
 45:          |> put_flash(:info, "Aula criada com sucesso! O processamento começará em breve.")
 46:          |> push_navigate(to: ~p"/lessons/#{lesson.id}")}
 47: 
 48:       {:error, :insufficient_credits} ->
 49:         {:noreply,
 50:          socket
 51:          |> assign(uploading: false)
 52:          |> put_flash(
 53:            :error,
 54:            "Você não tem créditos suficientes. Adquira mais créditos para continuar."
 55:          )}
 56: 
 57:       {:error, reason} ->
 58:         {:noreply,
 59:          socket
 60:          |> assign(uploading: false)
 61:          |> put_flash(:error, "Erro ao criar aula: #{inspect(reason)}")}
 62:     end
 63:   end
 64: 
 65:   @impl true
 66:   def handle_event("cancel-upload", %{"ref" => ref}, socket) do
 67:     {:noreply, cancel_upload(socket, :media, ref)}
 68:   end
 69: 
 70:   @impl true
 71:   def handle_event("online", _params, socket) do
 72:     {:noreply, socket}
 73:   end
 74: 
 75:   defp upload_and_create_lesson(socket, user, params) do
 76:     # Server-side upload: consume_uploaded_entries receives the temp file path
 77:     uploaded_files =
 78:       consume_uploaded_entries(socket, :media, fn %{path: path}, entry ->
 79:         lesson_id = Ecto.UUID.generate()
 80:         key = Storage.lesson_key(lesson_id, entry.client_name)
 81: 
 82:         case Storage.upload_file(key, path, content_type: entry.client_type) do
 83:           {:ok, url} ->
 84:             {:ok,
 85:              %{
 86:                key: key,
 87:                url: url,
 88:                filename: entry.client_name,
 89:                lesson_id: lesson_id
 90:              }}
 91: 
 92:           {:error, reason} ->
 93:             {:postpone, reason}
 94:         end
 95:       end)
 96: 
 97:     case uploaded_files do
 98:       [%{url: url, key: key, filename: filename, lesson_id: lesson_id}] ->
 99:         title =
100:           case params["title"] do
101:             nil -> filename
102:             "" -> filename
103:             t -> t
104:           end
105: 
106:         lesson_attrs = %{
107:           "id" => lesson_id,
108:           "title" => title,
109:           "subject" => params["subject"],
110:           "audio_url" => url,
111:           "audio_key" => key,
112:           "original_filename" => filename,
113:           "status" => "pending"
114:         }
115: 
116:         Lessons.create_lesson(user, lesson_attrs)
117: 
118:       [] ->
119:         {:error, :no_file_uploaded}
120: 
121:       errors when is_list(errors) ->
122:         {:error, List.first(errors)}
123:     end
124:   end
125: 
126:   @impl true
127:   def render(assigns) do
128:     ~H"""
129:     <div class="space-y-8 animate-fade-in">
130:       <div class="max-w-4xl mx-auto">
131:         <%!-- Header com Design 2025 --%>
132:         <div class="mb-10 text-center">
133:           <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-teal-100/80 dark:bg-teal-900/30 mb-4">
134:             <span class="relative flex h-2 w-2">
135:               <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-teal-400 opacity-75">
136:               </span>
137:               <span class="relative inline-flex rounded-full h-2 w-2 bg-teal-500"></span>
138:             </span>
139:             <span class="text-sm font-medium text-teal-700 dark:text-teal-300">Analise com IA</span>
140:           </div>
141:           <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 dark:text-white tracking-tight mb-3">
142:             Nova Aula
143:           </h1>
144:           <p class="text-base sm:text-lg text-slate-500 dark:text-slate-400">
145:             Envie sua gravacao e deixe a IA fazer o resto
146:           </p>
147:         </div>
148: 
149:         <%!-- Main Content Area --%>
150:         <div class="relative">
151:           <%!-- Estado 1: Empty State - Drop Zone --%>
152:           <div
153:             :if={@uploads.media.entries == [] && !@uploading}
154:             class="upload-container relative w-full"
155:             phx-drop-target={@uploads.media.ref}
156:             phx-hook="DropZone"
157:             id="upload-drop-zone"
158:           >
159:             <%!-- Input Overlay (Invisible but clickable/droppable) --%>
160:             <.live_file_input
161:               upload={@uploads.media}
162:               class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20"
163:               title="Clique para selecionar ou arraste um arquivo"
164:             />
165: 
166:             <%!-- Card Visual (Background) --%>
167:             <div class="upload-card bg-white dark:bg-slate-800 rounded-2xl shadow-card border-2 border-dashed border-slate-300 dark:border-slate-600 p-10 sm:p-16 transition-all duration-300 hover:shadow-elevated hover:border-teal-400 dark:hover:border-teal-500 hover:bg-teal-50/30 dark:hover:bg-teal-900/10 relative z-10 pointer-events-none group">
168:               <%!-- Icone Central com animacao --%>
169:               <div class="flex justify-center mb-8">
170:                 <div class="relative">
171:                   <div class="absolute inset-0 bg-teal-500/20 rounded-full blur-2xl animate-pulse-glow">
172:                   </div>
173:                   <div class="relative bg-gradient-to-br from-teal-500 to-cyan-500 rounded-2xl p-6 sm:p-8 shadow-lg shadow-teal-500/30 group-hover:scale-110 transition-transform duration-300">
174:                     <.icon name="hero-cloud-arrow-up" class="h-12 w-12 sm:h-16 sm:w-16 text-white" />
175:                   </div>
176:                 </div>
177:               </div>
178: 
179:               <%!-- Texto Principal --%>
180:               <div class="text-center space-y-3">
181:                 <h2 class="text-xl sm:text-2xl font-semibold text-slate-900 dark:text-white">
182:                   Arraste seu arquivo aqui
183:                 </h2>
184:                 <p class="text-sm sm:text-base text-slate-500 dark:text-slate-400">
185:                   ou
186:                   <span class="text-teal-600 dark:text-teal-400 font-semibold cursor-pointer hover:underline">
187:                     clique para selecionar
188:                   </span>
189:                 </p>
190:               </div>
191: 
192:               <%!-- Info Cards --%>
193:               <div class="mt-10 pt-8 border-t border-slate-200/50 dark:border-slate-700/50">
194:                 <div class="flex flex-col sm:flex-row items-center justify-center gap-4 sm:gap-8">
195:                   <div class="flex items-center gap-3 px-4 py-2 rounded-xl bg-slate-100/50 dark:bg-slate-700/30">
196:                     <div class="w-8 h-8 rounded-lg bg-teal-500/10 dark:bg-teal-500/20 flex items-center justify-center">
197:                       <.icon
198:                         name="hero-musical-note"
199:                         class="h-4 w-4 text-teal-600 dark:text-teal-400"
200:                       />
201:                     </div>
202:                     <span class="text-sm text-slate-600 dark:text-slate-400">MP4, MP3, WAV, M4A</span>
203:                   </div>
204:                   <div class="flex items-center gap-3 px-4 py-2 rounded-xl bg-slate-100/50 dark:bg-slate-700/30">
205:                     <div class="w-8 h-8 rounded-lg bg-cyan-500/10 dark:bg-cyan-500/20 flex items-center justify-center">
206:                       <.icon
207:                         name="hero-arrow-up-tray"
208:                         class="h-4 w-4 text-cyan-600 dark:text-cyan-400"
209:                       />
210:                     </div>
211:                     <span class="text-sm text-slate-600 dark:text-slate-400">Ate 500MB</span>
212:                   </div>
213:                 </div>
214:               </div>
215: 
216:               <%!-- Overlay de Drag --%>
217:               <div class="upload-drag-overlay absolute inset-0 bg-gradient-to-br from-teal-500/10 to-cyan-500/10 dark:from-teal-500/20 dark:to-cyan-500/20 backdrop-blur-sm rounded-2xl opacity-0 transition-all duration-300 flex items-center justify-center border-2 border-teal-500 border-dashed z-30">
218:                 <div class="text-center animate-bounce-subtle">
219:                   <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-teal-500 flex items-center justify-center shadow-lg shadow-teal-500/30">
220:                     <.icon name="hero-arrow-down-tray" class="h-10 w-10 text-white" />
221:                   </div>
222:                   <p class="text-xl font-semibold text-teal-700 dark:text-teal-300">Solte aqui</p>
223:                 </div>
224:               </div>
225:             </div>
226: 
227:             <%!-- Erros de Upload --%>
228:             <div :if={upload_errors(@uploads.media) != []} class="mt-6 relative z-20 animate-fade-in">
229:               <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800/50 rounded-xl p-4">
230:                 <.error :for={err <- upload_errors(@uploads.media)}>
231:                   <div class="flex items-center gap-3 text-red-700 dark:text-red-400">
232:                     <.icon name="hero-exclamation-circle" class="h-5 w-5" />
233:                     <span><%= error_message(err) %></span>
234:                   </div>
235:                 </.error>
236:               </div>
237:             </div>
238:           </div>
239: 
240:           <%!-- Estado 2: File Selected + Form --%>
241:           <div :if={@uploads.media.entries != [] && !@uploading} class="space-y-6 animate-fade-in-up">
242:             <%!-- Preview do Arquivo --%>
243:             <div
244:               :for={entry <- @uploads.media.entries}
245:               class="bg-white dark:bg-slate-800 rounded-2xl shadow-card border border-slate-200/50 dark:border-slate-700/50 overflow-hidden"
246:             >
247:               <div class="p-6 sm:p-8">
248:                 <div class="flex items-start gap-4 sm:gap-6">
249:                   <%!-- Icone do Arquivo --%>
250:                   <div class="flex-shrink-0">
251:                     <div class="relative">
252:                       <div class="absolute inset-0 bg-teal-500/10 dark:bg-teal-500/20 rounded-xl blur">
253:                       </div>
254:                       <div class="relative bg-gradient-to-br from-teal-50 to-cyan-50 dark:from-teal-900/50 dark:to-cyan-900/50 rounded-xl p-4 sm:p-5 border border-teal-100 dark:border-teal-800">
255:                         <.icon
256:                           name="hero-film"
257:                           class="h-8 w-8 sm:h-10 sm:w-10 text-teal-600 dark:text-teal-400"
258:                         />
259:                       </div>
260:                     </div>
261:                   </div>
262: 
263:                   <%!-- Info do Arquivo --%>
264:                   <div class="flex-1 min-w-0">
265:                     <h3 class="text-lg sm:text-xl font-semibold text-slate-900 dark:text-white truncate mb-1">
266:                       <%= entry.client_name %>
267:                     </h3>
268:                     <p class="text-sm sm:text-base text-slate-500 dark:text-slate-400">
269:                       <%= format_filesize(entry.client_size) %>
270:                     </p>
271: 
272:                     <%!-- Progress Bar --%>
273:                     <div :if={entry.progress > 0} class="mt-4 sm:mt-6">
274:                       <div class="flex items-center justify-between mb-2">
275:                         <span class={[
276:                           "text-sm font-medium",
277:                           entry.progress < 100 && "text-teal-600 dark:text-teal-400",
278:                           entry.progress >= 100 && "text-emerald-600 dark:text-emerald-400"
279:                         ]}>
280:                           <%= if entry.progress < 100, do: "Enviando...", else: "Pronto!" %>
281:                         </span>
282:                         <span class="text-sm font-bold text-slate-700 dark:text-slate-300 tabular-nums">
283:                           <%= entry.progress %>%
284:                         </span>
285:                       </div>
286:                       <div class="h-2 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
287:                         <div
288:                           class={[
289:                             "h-full rounded-full transition-all duration-500 ease-out",
290:                             entry.progress < 100 && "bg-gradient-to-r from-teal-500 to-cyan-500",
291:                             entry.progress >= 100 && "bg-gradient-to-r from-emerald-500 to-teal-500"
292:                           ]}
293:                           style={"width: #{entry.progress}%"}
294:                         >
295:                         </div>
296:                       </div>
297:                     </div>
298: 
299:                     <%!-- Erros do Entry --%>
300:                     <div :if={upload_errors(@uploads.media, entry) != []} class="mt-4">
301:                       <.error :for={err <- upload_errors(@uploads.media, entry)}>
302:                         <div class="flex items-center gap-2 text-red-600 dark:text-red-400">
303:                           <.icon name="hero-exclamation-circle" class="h-4 w-4" />
304:                           <span class="text-sm"><%= error_message(err) %></span>
305:                         </div>
306:                       </.error>
307:                     </div>
308:                   </div>
309: 
310:                   <%!-- Botao Remover --%>
311:                   <button
312:                     type="button"
313:                     phx-click="cancel-upload"
314:                     phx-value-ref={entry.ref}
315:                     class="flex-shrink-0 p-2.5 sm:p-3 text-slate-400 dark:text-slate-500 hover:text-red-600 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition-all duration-200"
316:                     aria-label="Remover arquivo"
317:                   >
318:                     <.icon name="hero-x-mark" class="h-5 w-5 sm:h-6 sm:w-6" />
319:                   </button>
320:                 </div>
321:               </div>
322:             </div>
323: 
324:             <%!-- Formulario de Metadados --%>
325:             <form phx-submit="submit" phx-change="validate" class="space-y-6">
326:               <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-card border border-slate-200/50 dark:border-slate-700/50 p-6 sm:p-8">
327:                 <div class="flex items-center gap-3 mb-6">
328:                   <div class="w-10 h-10 rounded-xl bg-teal-500/10 dark:bg-teal-500/20 flex items-center justify-center">
329:                     <.icon name="hero-document-text" class="h-5 w-5 text-teal-600 dark:text-teal-400" />
330:                   </div>
331:                   <h3 class="text-lg font-semibold text-slate-900 dark:text-white">
332:                     Detalhes da Aula
333:                   </h3>
334:                 </div>
335: 
336:                 <div class="space-y-5">
337:                   <%!-- Titulo --%>
338:                   <div>
339:                     <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
340:                       Titulo <span class="text-slate-400">(opcional)</span>
341:                     </label>
342:                     <input
343:                       type="text"
344:                       name="lesson[title]"
345:                       value={@form[:title].value}
346:                       placeholder="Ex: Aula de Matematica - Fracoes"
347:                       class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500/20 focus:border-teal-500 transition-all duration-200 text-base text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-slate-500"
348:                     />
349:                   </div>
350: 
351:                   <%!-- Disciplina --%>
352:                   <div>
353:                     <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
354:                       Disciplina
355:                     </label>
356:                     <div class="relative">
357:                       <select
358:                         name="lesson[subject]"
359:                         class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500/20 focus:border-teal-500 transition-all duration-200 text-base text-slate-900 dark:text-white appearance-none cursor-pointer pr-10"
360:                       >
361:                         <option value="">Selecione uma disciplina</option>
362:                         <%= for {label, value} <- subject_options() do %>
363:                           <option value={value} selected={@form[:subject].value == value}>
364:                             <%= label %>
365:                           </option>
366:                         <% end %>
367:                       </select>
368:                       <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none">
369:                         <.icon name="hero-chevron-down" class="h-5 w-5 text-slate-400" />
370:                       </div>
371:                     </div>
372:                   </div>
373:                 </div>
374:               </div>
375: 
376:               <%!-- Actions --%>
377:               <div class="flex flex-col-reverse sm:flex-row items-center justify-between gap-4">
378:                 <.link
379:                   navigate={~p"/dashboard"}
380:                   class="w-full sm:w-auto text-center px-6 py-3 text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white font-medium transition-colors duration-200"
381:                 >
382:                   Cancelar
383:                 </.link>
384: 
385:                 <button
386:                   type="submit"
387:                   disabled={
388:                     @uploading || @uploads.media.entries == [] ||
389:                       Enum.any?(@uploads.media.entries, &(!&1.done?))
390:                   }
391:                   class="w-full sm:w-auto group relative px-8 py-4 bg-gradient-to-r from-teal-600 to-cyan-600 text-white font-semibold rounded-xl shadow-lg shadow-teal-500/30 hover:shadow-xl hover:shadow-teal-500/40 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:shadow-lg transition-all duration-300 hover:scale-[1.02] disabled:hover:scale-100"
392:                 >
393:                   <span class="flex items-center justify-center gap-2">
394:                     <%= cond do %>
395:                       <% @uploading -> %>
396:                         <.spinner size="sm" />
397:                         <span>Processando...</span>
398:                       <% @uploads.media.entries != [] and Enum.any?(@uploads.media.entries, &(!&1.done?)) -> %>
399:                         <.icon name="hero-arrow-up-tray" class="h-5 w-5" />
400:                         <span>Carregando <%= Enum.at(@uploads.media.entries, 0).progress %>%</span>
401:                       <% true -> %>
402:                         <.icon name="hero-sparkles" class="h-5 w-5" />
403:                         <span>Processar Aula</span>
404:                     <% end %>
405:                   </span>
406:                 </button>
407:               </div>
408:             </form>
409:           </div>
410: 
411:           <%!-- Estado 3: Uploading --%>
412:           <div :if={@uploading} class="animate-fade-in">
413:             <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-card border border-slate-200/50 dark:border-slate-700/50 p-10 sm:p-16 text-center">
414:               <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-teal-500 to-cyan-500 flex items-center justify-center animate-pulse">
415:                 <.icon name="hero-arrow-path" class="h-10 w-10 text-white animate-spin" />
416:               </div>
417:               <h3 class="text-xl font-semibold text-slate-900 dark:text-white mb-2">
418:                 Processando sua aula...
419:               </h3>
420:               <p class="text-slate-500 dark:text-slate-400">
421:                 Aguarde enquanto preparamos tudo
422:               </p>
423:             </div>
424:           </div>
425:         </div>
426:       </div>
427:     </div>
428:     """
429:   end
430: 
431:   defp subject_options do
432:     [
433:       {"Língua Portuguesa", "lingua_portuguesa"},
434:       {"Matemática", "matematica"},
435:       {"Ciências", "ciencias"},
436:       {"História", "historia"},
437:       {"Geografia", "geografia"},
438:       {"Arte", "arte"},
439:       {"Educação Física", "educacao_fisica"},
440:       {"Inglês", "ingles"},
441:       {"Outra", "outra"}
442:     ]
443:   end
444: 
445:   defp format_filesize(bytes) when is_integer(bytes) do
446:     cond do
447:       bytes >= 1_073_741_824 -> "#{Float.round(bytes / 1_073_741_824, 1)} GB"
448:       bytes >= 1_048_576 -> "#{Float.round(bytes / 1_048_576, 1)} MB"
449:       bytes >= 1024 -> "#{Float.round(bytes / 1024, 1)} KB"
450:       true -> "#{bytes} bytes"
451:     end
452:   end
453: 
454:   defp format_filesize(_), do: "0 bytes"
455: 
456:   defp error_message(:too_large), do: "Arquivo muito grande (máximo 500MB)"
457:   defp error_message(:too_many_files), do: "Apenas um arquivo por vez"
458:   defp error_message(:not_accepted), do: "Tipo de arquivo não suportado"
459:   defp error_message(err), do: "Erro: #{inspect(err)}"
460: end
````

## File: config/config.exs
````elixir
  1: # This file is responsible for configuring your application
  2: # and its dependencies with the aid of the Config module.
  3: #
  4: # This configuration file is loaded before any dependency and
  5: # is restricted to this project.
  6: 
  7: # General application configuration
  8: import Config
  9: 
 10: config :hellen,
 11:   ecto_repos: [Hellen.Repo],
 12:   generators: [timestamp_type: :utc_datetime, binary_id: true]
 13: 
 14: # Configures the endpoint
 15: config :hellen, HellenWeb.Endpoint,
 16:   url: [host: "localhost"],
 17:   adapter: Bandit.PhoenixAdapter,
 18:   render_errors: [
 19:     formats: [html: HellenWeb.ErrorHTML, json: HellenWeb.ErrorJSON],
 20:     layout: false
 21:   ],
 22:   pubsub_server: Hellen.PubSub,
 23:   live_view: [signing_salt: "hellen_salt"]
 24: 
 25: # Configure esbuild (the version is required)
 26: config :esbuild,
 27:   version: "0.17.11",
 28:   hellen: [
 29:     args:
 30:       ~w(js/app.js --bundle --target=es2017 --outdir=../priv/static/assets --external:/fonts/* --external:/images/*),
 31:     cd: Path.expand("../assets", __DIR__),
 32:     env: %{"NODE_PATH" => Path.expand("../deps", __DIR__)}
 33:   ]
 34: 
 35: # Configure tailwind (the version is required)
 36: config :tailwind,
 37:   version: "3.4.3",
 38:   hellen: [
 39:     args: ~w(
 40:       --config=tailwind.config.js
 41:       --input=css/app.css
 42:       --output=../priv/static/assets/app.css
 43:     ),
 44:     cd: Path.expand("../assets", __DIR__)
 45:   ]
 46: 
 47: # Configures Elixir's Logger
 48: config :logger, :console,
 49:   format: "$time $metadata[$level] $message\n",
 50:   metadata: [:request_id]
 51: 
 52: # Use Jason for JSON parsing in Phoenix
 53: config :phoenix, :json_library, Jason
 54: 
 55: # Configure Oban with optimized queue sizes
 56: config :hellen, Oban,
 57:   repo: Hellen.Repo,
 58:   plugins: [
 59:     Oban.Plugins.Pruner,
 60:     {Oban.Plugins.Cron,
 61:      crontab: [
 62:        # Cleanup old job records daily at 2 AM
 63:        {"0 2 * * *", Hellen.Workers.CleanupJob}
 64:      ]}
 65:   ],
 66:   queues: [
 67:     # Increased for better throughput
 68:     transcription: 3,
 69:     # Increased for parallel analysis
 70:     analysis: 5,
 71:     reports: 2,
 72:     notifications: 5,
 73:     default: 10
 74:   ]
 75: 
 76: # Configure Guardian for JWT
 77: config :hellen, Hellen.Auth.Guardian,
 78:   issuer: "hellen",
 79:   secret_key: System.get_env("GUARDIAN_SECRET_KEY") || "dev_secret_key_change_in_production"
 80: 
 81: # Configure Firebase
 82: config :hellen, :firebase, project_id: "hellen-ai"
 83: 
 84: # Configure Qdrant vector database
 85: config :hellen, :qdrant_url, System.get_env("QDRANT_URL") || "http://localhost:6333"
 86: 
 87: # Configure ChromicPDF for PDF generation
 88: config :hellen, :chromic_pdf,
 89:   session_pool: [size: 2],
 90:   no_sandbox: true,
 91:   offline: true
 92: 
 93: # Configure Swoosh for email
 94: config :hellen, Hellen.Notifications.Mailer, adapter: Swoosh.Adapters.Local
 95: 
 96: # Configure Stripe
 97: config :stripity_stripe,
 98:   api_key: System.get_env("STRIPE_SECRET_KEY"),
 99:   webhook_secret: System.get_env("STRIPE_WEBHOOK_SECRET")
100: 
101: config :hellen, :stripe,
102:   publishable_key: System.get_env("STRIPE_PUBLISHABLE_KEY"),
103:   success_url: "/billing?success=true",
104:   cancel_url: "/billing?canceled=true"
105: 
106: # Swoosh API client (uses Finch)
107: config :swoosh, :api_client, Swoosh.ApiClient.Finch
108: 
109: # Import environment specific config. This must remain at the bottom
110: # of this file so it overrides the configuration defined above.
111: import_config "#{config_env()}.exs"
112: 
113: config :mime, :types, %{
114:   "audio/mp4" => ["m4a"],
115:   "audio/ogg" => ["ogg"],
116:   "audio/flac" => ["flac"],
117:   "video/x-matroska" => ["mkv"],
118:   "video/x-msvideo" => ["avi"],
119:   "video/quicktime" => ["mov"]
120: }
````

## File: lib/hellen_web/components/core_components.ex
````elixir
   1: defmodule HellenWeb.CoreComponents do
   2:   @moduledoc """
   3:   Provides core UI components with 2025 Educational Design System.
   4: 
   5:   Components included:
   6:   - Flash messages
   7:   - Buttons (primary, secondary, outline, ghost, danger)
   8:   - Form inputs
   9:   - Cards (default, elevated, glass)
  10:   - Progress bars
  11:   - Badges
  12:   - Alerts
  13:   - Modals
  14:   - Navigation (navbar, sidebar)
  15:   - Icons (Heroicons)
  16:   - Stats cards
  17:   - Avatar
  18:   - Tabs
  19:   """
  20:   use Phoenix.Component
  21: 
  22:   alias Phoenix.LiveView.JS
  23:   import Phoenix.HTML.Form
  24: 
  25:   # ============================================================================
  26:   # ICONS
  27:   # ============================================================================
  28: 
  29:   @doc """
  30:   Renders a Heroicon.
  31: 
  32:   ## Examples
  33: 
  34:       <.icon name="hero-x-mark-solid" />
  35:       <.icon name="hero-arrow-path" class="ml-1 w-3 h-3 animate-spin" />
  36:   """
  37:   attr :name, :string, required: true
  38:   attr :class, :string, default: nil
  39: 
  40:   def icon(%{name: "hero-" <> _} = assigns) do
  41:     ~H"""
  42:     <span class={[@name, @class]} />
  43:     """
  44:   end
  45: 
  46:   # ============================================================================
  47:   # BUTTONS
  48:   # ============================================================================
  49: 
  50:   @doc """
  51:   Renders a button with modern 2025 styling.
  52: 
  53:   ## Examples
  54: 
  55:       <.button>Send!</.button>
  56:       <.button phx-click="go" variant="secondary">Send!</.button>
  57:       <.button variant="primary" size="lg" icon="hero-plus">New Item</.button>
  58:   """
  59:   attr :type, :string, default: "button"
  60:   attr :variant, :string, default: "primary", values: ~w(primary secondary outline ghost danger)
  61:   attr :size, :string, default: "md", values: ~w(sm md lg)
  62:   attr :disabled, :boolean, default: false
  63:   attr :icon, :string, default: nil
  64:   attr :icon_position, :string, default: "left", values: ~w(left right)
  65:   attr :class, :string, default: nil
  66:   attr :rest, :global, include: ~w(form name value phx-click phx-disable-with)
  67: 
  68:   slot :inner_block, required: true
  69: 
  70:   def button(assigns) do
  71:     ~H"""
  72:     <button
  73:       type={@type}
  74:       disabled={@disabled}
  75:       class={[
  76:         "inline-flex items-center justify-center gap-2 font-medium rounded-lg",
  77:         "transition-all duration-200 ease-out",
  78:         "focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-background",
  79:         "disabled:opacity-50 disabled:cursor-not-allowed disabled:pointer-events-none",
  80:         button_size(@size),
  81:         button_variant(@variant),
  82:         @class
  83:       ]}
  84:       {@rest}
  85:     >
  86:       <.icon :if={@icon && @icon_position == "left"} name={@icon} class={icon_size(@size)} />
  87:       <%= render_slot(@inner_block) %>
  88:       <.icon :if={@icon && @icon_position == "right"} name={@icon} class={icon_size(@size)} />
  89:     </button>
  90:     """
  91:   end
  92: 
  93:   defp button_size("sm"), do: "px-3 py-1.5 text-sm"
  94:   defp button_size("md"), do: "px-4 py-2 text-sm"
  95:   defp button_size("lg"), do: "px-6 py-3 text-base"
  96: 
  97:   defp icon_size("sm"), do: "h-4 w-4"
  98:   defp icon_size("md"), do: "h-4 w-4"
  99:   defp icon_size("lg"), do: "h-5 w-5"
 100: 
 101:   defp button_variant("primary") do
 102:     "bg-teal-600 text-white hover:bg-teal-700 focus:ring-teal-500 shadow-sm hover:shadow-md"
 103:   end
 104: 
 105:   defp button_variant("secondary") do
 106:     "bg-sage-500 text-white hover:bg-sage-600 focus:ring-sage-500 shadow-sm hover:shadow-md"
 107:   end
 108: 
 109:   defp button_variant("outline") do
 110:     "border-2 border-teal-600 text-teal-600 bg-transparent hover:bg-teal-600 hover:text-white focus:ring-teal-500 dark:border-teal-500 dark:text-teal-500 dark:hover:bg-teal-500"
 111:   end
 112: 
 113:   defp button_variant("ghost") do
 114:     "text-slate-600 dark:text-slate-300 bg-transparent hover:bg-slate-100 dark:hover:bg-slate-800 focus:ring-teal-500"
 115:   end
 116: 
 117:   defp button_variant("danger") do
 118:     "bg-red-600 text-white hover:bg-red-700 focus:ring-red-500 shadow-sm hover:shadow-md"
 119:   end
 120: 
 121:   # ============================================================================
 122:   # FORM INPUTS
 123:   # ============================================================================
 124: 
 125:   @doc """
 126:   Renders an input with label and error messages.
 127: 
 128:   ## Examples
 129: 
 130:       <.input field={@form[:email]} type="email" />
 131:       <.input name="my-input" errors={["oh no!"]} />
 132:   """
 133:   attr :id, :any, default: nil
 134:   attr :name, :any
 135:   attr :label, :string, default: nil
 136:   attr :value, :any
 137: 
 138:   attr :type, :string,
 139:     default: "text",
 140:     values: ~w(checkbox color date datetime-local email file hidden month number password
 141:                range search select tel text textarea time url week)
 142: 
 143:   attr :field, Phoenix.HTML.FormField,
 144:     doc: "a form field struct retrieved from the form, for example: @form[:email]"
 145: 
 146:   attr :errors, :list, default: []
 147:   attr :checked, :boolean, doc: "the checked flag for checkbox inputs"
 148:   attr :prompt, :string, default: nil, doc: "the prompt for select inputs"
 149:   attr :options, :list, doc: "the options to pass to Phoenix.HTML.Form.options_for_select/2"
 150:   attr :multiple, :boolean, default: false, doc: "the multiple flag for select inputs"
 151: 
 152:   attr :rest, :global,
 153:     include: ~w(accept autocomplete capture cols disabled form list max maxlength min minlength
 154:                 multiple pattern placeholder readonly required rows size step)
 155: 
 156:   slot :inner_block
 157: 
 158:   def input(%{field: %Phoenix.HTML.FormField{} = field} = assigns) do
 159:     assigns
 160:     |> assign(field: nil, id: assigns.id || field.id)
 161:     |> assign(:errors, Enum.map(field.errors, &translate_error(&1)))
 162:     |> assign_new(:name, fn -> if assigns.multiple, do: field.name <> "[]", else: field.name end)
 163:     |> assign_new(:value, fn -> field.value end)
 164:     |> input()
 165:   end
 166: 
 167:   def input(%{type: "checkbox"} = assigns) do
 168:     assigns =
 169:       assign_new(assigns, :checked, fn ->
 170:         normalize_value("checkbox", assigns[:value])
 171:       end)
 172: 
 173:     ~H"""
 174:     <div phx-feedback-for={@name}>
 175:       <label class="flex items-center gap-3 text-sm font-medium text-slate-700 dark:text-slate-200 cursor-pointer">
 176:         <input type="hidden" name={@name} value="false" />
 177:         <input
 178:           type="checkbox"
 179:           id={@id}
 180:           name={@name}
 181:           value="true"
 182:           checked={@checked}
 183:           class="h-4 w-4 rounded border-slate-300 dark:border-slate-600 text-teal-600 focus:ring-teal-500 dark:bg-slate-800 transition-colors"
 184:           {@rest}
 185:         />
 186:         <%= @label %>
 187:       </label>
 188:       <.error :for={msg <- @errors}><%= msg %></.error>
 189:     </div>
 190:     """
 191:   end
 192: 
 193:   def input(%{type: "select"} = assigns) do
 194:     ~H"""
 195:     <div phx-feedback-for={@name}>
 196:       <.label :if={@label} for={@id}><%= @label %></.label>
 197:       <select
 198:         id={@id}
 199:         name={@name}
 200:         class={[
 201:           "mt-1.5 block w-full rounded-lg border-slate-300 dark:border-slate-600",
 202:           "bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100",
 203:           "shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm",
 204:           "transition-colors duration-200"
 205:         ]}
 206:         multiple={@multiple}
 207:         {@rest}
 208:       >
 209:         <option :if={@prompt} value=""><%= @prompt %></option>
 210:         <%= options_for_select(@options, @value) %>
 211:       </select>
 212:       <.error :for={msg <- @errors}><%= msg %></.error>
 213:     </div>
 214:     """
 215:   end
 216: 
 217:   def input(%{type: "textarea"} = assigns) do
 218:     ~H"""
 219:     <div phx-feedback-for={@name}>
 220:       <.label :if={@label} for={@id}><%= @label %></.label>
 221:       <textarea
 222:         id={@id}
 223:         name={@name}
 224:         class={[
 225:           "mt-1.5 block w-full rounded-lg border-slate-300 dark:border-slate-600",
 226:           "bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100",
 227:           "shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm",
 228:           "transition-colors duration-200 placeholder:text-slate-400 dark:placeholder:text-slate-500",
 229:           @errors != [] &&
 230:             "border-red-500 text-red-900 dark:text-red-400 focus:border-red-500 focus:ring-red-500"
 231:         ]}
 232:         {@rest}
 233:       ><%= Phoenix.HTML.Form.normalize_value("textarea", @value) %></textarea>
 234:       <.error :for={msg <- @errors}><%= msg %></.error>
 235:     </div>
 236:     """
 237:   end
 238: 
 239:   def input(assigns) do
 240:     ~H"""
 241:     <div phx-feedback-for={@name}>
 242:       <.label :if={@label} for={@id}><%= @label %></.label>
 243:       <input
 244:         type={@type}
 245:         name={@name}
 246:         id={@id}
 247:         value={Phoenix.HTML.Form.normalize_value(@type, @value)}
 248:         class={[
 249:           "mt-1.5 block w-full rounded-lg border-slate-300 dark:border-slate-600",
 250:           "bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100",
 251:           "shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm",
 252:           "transition-colors duration-200 placeholder:text-slate-400 dark:placeholder:text-slate-500",
 253:           @errors != [] &&
 254:             "border-red-500 text-red-900 dark:text-red-400 focus:border-red-500 focus:ring-red-500"
 255:         ]}
 256:         {@rest}
 257:       />
 258:       <.error :for={msg <- @errors}><%= msg %></.error>
 259:     </div>
 260:     """
 261:   end
 262: 
 263:   @doc """
 264:   Renders a label.
 265:   """
 266:   attr :for, :string, default: nil
 267:   slot :inner_block, required: true
 268: 
 269:   def label(assigns) do
 270:     ~H"""
 271:     <label for={@for} class="block text-sm font-medium text-slate-700 dark:text-slate-200">
 272:       <%= render_slot(@inner_block) %>
 273:     </label>
 274:     """
 275:   end
 276: 
 277:   @doc """
 278:   Generates a generic error message.
 279:   """
 280:   slot :inner_block, required: true
 281: 
 282:   def error(assigns) do
 283:     ~H"""
 284:     <p class="mt-1.5 flex items-center gap-1.5 text-sm text-red-600 dark:text-red-400 phx-no-feedback:hidden">
 285:       <.icon name="hero-exclamation-circle-mini" class="h-4 w-4 flex-none" />
 286:       <%= render_slot(@inner_block) %>
 287:     </p>
 288:     """
 289:   end
 290: 
 291:   # ============================================================================
 292:   # CARDS
 293:   # ============================================================================
 294: 
 295:   @doc """
 296:   Renders a card component with multiple variants.
 297: 
 298:   ## Variants
 299:   - `:default` - Simple bordered card
 300:   - `:elevated` - Card with shadow and hover effect
 301:   - `:glass` - Glassmorphism effect
 302: 
 303:   ## Examples
 304: 
 305:       <.card>Simple card</.card>
 306:       <.card variant="elevated">
 307:         <:header>Card Title</:header>
 308:         Card content here
 309:         <:footer>Footer actions</:footer>
 310:       </.card>
 311:   """
 312:   attr :variant, :string, default: "default", values: ~w(default elevated glass)
 313:   attr :padding, :string, default: "md", values: ~w(none sm md lg)
 314:   attr :class, :string, default: nil
 315:   attr :rest, :global
 316: 
 317:   slot :header
 318:   slot :inner_block, required: true
 319:   slot :footer
 320: 
 321:   def card(assigns) do
 322:     ~H"""
 323:     <div
 324:       class={[
 325:         "rounded-xl overflow-hidden",
 326:         card_variant(@variant),
 327:         @class
 328:       ]}
 329:       {@rest}
 330:     >
 331:       <div
 332:         :if={@header != []}
 333:         class={["border-b border-slate-200 dark:border-slate-700", card_padding(@padding)]}
 334:       >
 335:         <%= render_slot(@header) %>
 336:       </div>
 337:       <div class={card_padding(@padding)}>
 338:         <%= render_slot(@inner_block) %>
 339:       </div>
 340:       <div
 341:         :if={@footer != []}
 342:         class={[
 343:           "border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50",
 344:           card_padding(@padding)
 345:         ]}
 346:       >
 347:         <%= render_slot(@footer) %>
 348:       </div>
 349:     </div>
 350:     """
 351:   end
 352: 
 353:   defp card_variant("default") do
 354:     "bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700"
 355:   end
 356: 
 357:   defp card_variant("elevated") do
 358:     "bg-white dark:bg-slate-800 shadow-card hover:shadow-card-hover transition-shadow duration-200"
 359:   end
 360: 
 361:   defp card_variant("glass") do
 362:     "bg-white/80 dark:bg-slate-800/80 backdrop-blur-md border border-white/20 dark:border-slate-700/50"
 363:   end
 364: 
 365:   defp card_padding("none"), do: ""
 366:   defp card_padding("sm"), do: "px-4 py-3"
 367:   defp card_padding("md"), do: "px-6 py-4"
 368:   defp card_padding("lg"), do: "px-8 py-6"
 369: 
 370:   # ============================================================================
 371:   # STATS CARD
 372:   # ============================================================================
 373: 
 374:   @doc """
 375:   Renders a statistics card for dashboard KPIs.
 376: 
 377:   ## Examples
 378: 
 379:       <.stat_card
 380:         title="Total Aulas"
 381:         value="127"
 382:         icon="hero-academic-cap"
 383:         color="teal"
 384:         trend={%{value: 12, direction: :up}}
 385:       />
 386:   """
 387:   attr :title, :string, required: true
 388:   attr :value, :any, required: true
 389:   attr :icon, :string, default: nil
 390: 
 391:   attr :variant, :string,
 392:     default: "default",
 393:     values: ~w(default success processing pending warning error)
 394: 
 395:   attr :color, :string, default: nil, doc: "Deprecated: use variant instead"
 396:   attr :subtitle, :string, default: nil
 397:   attr :trend, :map, default: nil, doc: "Map with :value and :direction (:up, :down, :stable)"
 398:   attr :class, :string, default: nil
 399: 
 400:   def stat_card(assigns) do
 401:     # Support both color (legacy) and variant (new) attributes
 402:     assigns =
 403:       assign_new(assigns, :effective_variant, fn ->
 404:         assigns[:color] || assigns[:variant] || "default"
 405:       end)
 406: 
 407:     ~H"""
 408:     <div class={[
 409:       "bg-white dark:bg-slate-800 rounded-xl shadow-card hover:shadow-elevated border border-slate-200/50 dark:border-slate-700/50 transition-all duration-300 p-5 group",
 410:       @class
 411:     ]}>
 412:       <div class="flex items-start justify-between">
 413:         <div class="flex-1 min-w-0">
 414:           <p class="text-sm font-medium text-slate-500 dark:text-slate-400 truncate">
 415:             <%= @title %>
 416:           </p>
 417:           <p class="mt-2 text-3xl font-bold text-slate-900 dark:text-white tracking-tight">
 418:             <%= @value %>
 419:           </p>
 420:           <div :if={@subtitle || @trend} class="mt-2 flex items-center gap-2">
 421:             <p :if={@subtitle} class="text-xs text-slate-500 dark:text-slate-400">
 422:               <%= @subtitle %>
 423:             </p>
 424:             <span
 425:               :if={@trend}
 426:               class={[
 427:                 "inline-flex items-center gap-0.5 text-xs font-medium",
 428:                 trend_color(@trend.direction)
 429:               ]}
 430:             >
 431:               <.icon name={trend_icon(@trend.direction)} class="h-3.5 w-3.5" />
 432:               <%= @trend.value %>%
 433:             </span>
 434:           </div>
 435:         </div>
 436:         <div
 437:           :if={@icon}
 438:           class={[
 439:             "flex-shrink-0 w-12 h-12 rounded-xl flex items-center justify-center transition-transform duration-300 group-hover:scale-110",
 440:             stat_icon_bg(@effective_variant)
 441:           ]}
 442:         >
 443:           <.icon name={@icon} class={"h-6 w-6 #{stat_icon_color(@effective_variant)}"} />
 444:         </div>
 445:       </div>
 446:     </div>
 447:     """
 448:   end
 449: 
 450:   defp stat_icon_bg("success"), do: "bg-emerald-100 dark:bg-emerald-900/30"
 451:   defp stat_icon_bg("processing"), do: "bg-cyan-100 dark:bg-cyan-900/30"
 452:   defp stat_icon_bg("pending"), do: "bg-amber-100 dark:bg-amber-900/30"
 453:   defp stat_icon_bg("warning"), do: "bg-ochre-100 dark:bg-ochre-900/30"
 454:   defp stat_icon_bg("error"), do: "bg-red-100 dark:bg-red-900/30"
 455:   defp stat_icon_bg("teal"), do: "bg-teal-100 dark:bg-teal-900/30"
 456:   defp stat_icon_bg("sage"), do: "bg-sage-100 dark:bg-sage-900/30"
 457:   defp stat_icon_bg("mint"), do: "bg-mint-100 dark:bg-mint-900/30"
 458:   defp stat_icon_bg("ochre"), do: "bg-ochre-100 dark:bg-ochre-900/30"
 459:   defp stat_icon_bg("violet"), do: "bg-violet-100 dark:bg-violet-900/30"
 460:   defp stat_icon_bg("cyan"), do: "bg-cyan-100 dark:bg-cyan-900/30"
 461:   defp stat_icon_bg(_), do: "bg-teal-100 dark:bg-teal-900/30"
 462: 
 463:   defp stat_icon_color("success"), do: "text-emerald-600 dark:text-emerald-400"
 464:   defp stat_icon_color("processing"), do: "text-cyan-600 dark:text-cyan-400"
 465:   defp stat_icon_color("pending"), do: "text-amber-600 dark:text-amber-400"
 466:   defp stat_icon_color("warning"), do: "text-ochre-600 dark:text-ochre-400"
 467:   defp stat_icon_color("error"), do: "text-red-600 dark:text-red-400"
 468:   defp stat_icon_color("teal"), do: "text-teal-600 dark:text-teal-400"
 469:   defp stat_icon_color("sage"), do: "text-sage-600 dark:text-sage-400"
 470:   defp stat_icon_color("mint"), do: "text-mint-600 dark:text-mint-400"
 471:   defp stat_icon_color("ochre"), do: "text-ochre-600 dark:text-ochre-400"
 472:   defp stat_icon_color("violet"), do: "text-violet-600 dark:text-violet-400"
 473:   defp stat_icon_color("cyan"), do: "text-cyan-600 dark:text-cyan-400"
 474:   defp stat_icon_color(_), do: "text-teal-600 dark:text-teal-400"
 475: 
 476:   defp trend_color(:up), do: "text-emerald-600 dark:text-emerald-400"
 477:   defp trend_color(:down), do: "text-red-600 dark:text-red-400"
 478:   defp trend_color(:stable), do: "text-slate-500 dark:text-slate-400"
 479: 
 480:   defp trend_icon(:up), do: "hero-arrow-trending-up-mini"
 481:   defp trend_icon(:down), do: "hero-arrow-trending-down-mini"
 482:   defp trend_icon(:stable), do: "hero-minus-mini"
 483: 
 484:   # ============================================================================
 485:   # PROGRESS
 486:   # ============================================================================
 487: 
 488:   @doc """
 489:   Renders a progress bar.
 490: 
 491:   ## Examples
 492: 
 493:       <.progress value={50} />
 494:       <.progress value={75} color="teal" size="lg" />
 495:   """
 496:   attr :value, :integer, default: 0
 497:   attr :max, :integer, default: 100
 498:   attr :color, :string, default: "teal", values: ~w(teal sage emerald amber red violet)
 499:   attr :size, :string, default: "md", values: ~w(sm md lg)
 500:   attr :class, :string, default: nil
 501: 
 502:   def progress(assigns) do
 503:     assigns = assign(assigns, :percentage, min(100, max(0, assigns.value / assigns.max * 100)))
 504: 
 505:     ~H"""
 506:     <div class={[
 507:       "w-full bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden",
 508:       progress_height(@size),
 509:       @class
 510:     ]}>
 511:       <div
 512:         class={[
 513:           "rounded-full transition-all duration-500 ease-out",
 514:           progress_height(@size),
 515:           progress_color(@color)
 516:         ]}
 517:         style={"width: #{@percentage}%"}
 518:       >
 519:       </div>
 520:     </div>
 521:     """
 522:   end
 523: 
 524:   defp progress_height("sm"), do: "h-1.5"
 525:   defp progress_height("md"), do: "h-2"
 526:   defp progress_height("lg"), do: "h-3"
 527: 
 528:   defp progress_color("teal"), do: "bg-teal-500"
 529:   defp progress_color("sage"), do: "bg-sage-500"
 530:   defp progress_color("emerald"), do: "bg-emerald-500"
 531:   defp progress_color("amber"), do: "bg-amber-500"
 532:   defp progress_color("red"), do: "bg-red-500"
 533:   defp progress_color("violet"), do: "bg-violet-500"
 534: 
 535:   # ============================================================================
 536:   # BADGES
 537:   # ============================================================================
 538: 
 539:   @doc """
 540:   Renders a status badge.
 541: 
 542:   ## Examples
 543: 
 544:       <.badge>Default</.badge>
 545:       <.badge variant="success">Completed</.badge>
 546:       <.badge variant="processing" dot>Em andamento</.badge>
 547:   """
 548:   attr :variant, :string,
 549:     default: "default",
 550:     values: ~w(default pending processing completed failed success warning error info alert)
 551: 
 552:   attr :dot, :boolean, default: false
 553:   attr :class, :string, default: nil
 554:   attr :rest, :global
 555: 
 556:   slot :inner_block, required: true
 557: 
 558:   def badge(assigns) do
 559:     ~H"""
 560:     <span
 561:       class={[
 562:         "inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium",
 563:         badge_variant(@variant),
 564:         @class
 565:       ]}
 566:       {@rest}
 567:     >
 568:       <span :if={@dot} class={["w-1.5 h-1.5 rounded-full", badge_dot(@variant)]}></span>
 569:       <%= render_slot(@inner_block) %>
 570:     </span>
 571:     """
 572:   end
 573: 
 574:   defp badge_variant("default"),
 575:     do: "bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-300"
 576: 
 577:   defp badge_variant("pending"),
 578:     do: "bg-ochre-100 text-ochre-700 dark:bg-ochre-900/30 dark:text-ochre-400"
 579: 
 580:   defp badge_variant("processing"),
 581:     do: "bg-cyan-100 text-cyan-700 dark:bg-cyan-900/30 dark:text-cyan-400"
 582: 
 583:   defp badge_variant("completed"),
 584:     do: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400"
 585: 
 586:   defp badge_variant("failed"), do: "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400"
 587: 
 588:   defp badge_variant("success"),
 589:     do: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400"
 590: 
 591:   defp badge_variant("warning"),
 592:     do: "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400"
 593: 
 594:   defp badge_variant("error"), do: "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400"
 595: 
 596:   defp badge_variant("info"),
 597:     do: "bg-cyan-100 text-cyan-700 dark:bg-cyan-900/30 dark:text-cyan-400"
 598: 
 599:   defp badge_variant("alert"),
 600:     do: "bg-violet-100 text-violet-700 dark:bg-violet-900/30 dark:text-violet-400"
 601: 
 602:   defp badge_dot("default"), do: "bg-slate-500"
 603:   defp badge_dot("pending"), do: "bg-ochre-500"
 604:   defp badge_dot("processing"), do: "bg-cyan-500 animate-pulse"
 605:   defp badge_dot("completed"), do: "bg-emerald-500"
 606:   defp badge_dot("failed"), do: "bg-red-500"
 607:   defp badge_dot("success"), do: "bg-emerald-500"
 608:   defp badge_dot("warning"), do: "bg-amber-500"
 609:   defp badge_dot("error"), do: "bg-red-500"
 610:   defp badge_dot("info"), do: "bg-cyan-500"
 611:   defp badge_dot("alert"), do: "bg-violet-500"
 612: 
 613:   # ============================================================================
 614:   # AVATAR
 615:   # ============================================================================
 616: 
 617:   @doc """
 618:   Renders an avatar component.
 619: 
 620:   ## Examples
 621: 
 622:       <.avatar name="John Doe" />
 623:       <.avatar name="Jane" size="lg" src="/images/avatar.jpg" />
 624:   """
 625:   attr :name, :string, required: true
 626:   attr :src, :string, default: nil
 627:   attr :size, :string, default: "md", values: ~w(xs sm md lg xl)
 628:   attr :class, :string, default: nil
 629: 
 630:   def avatar(assigns) do
 631:     assigns = assign(assigns, :initials, get_initials(assigns.name))
 632: 
 633:     ~H"""
 634:     <div class={[
 635:       "relative inline-flex items-center justify-center rounded-full font-medium overflow-hidden",
 636:       avatar_size(@size),
 637:       avatar_bg(),
 638:       @class
 639:     ]}>
 640:       <img :if={@src} src={@src} alt={@name} class="w-full h-full object-cover" />
 641:       <span :if={!@src} class={avatar_text_size(@size)}>
 642:         <%= @initials %>
 643:       </span>
 644:     </div>
 645:     """
 646:   end
 647: 
 648:   defp get_initials(name) when is_binary(name) do
 649:     name
 650:     |> String.split(" ")
 651:     |> Enum.take(2)
 652:     |> Enum.map_join("", &String.first/1)
 653:     |> String.upcase()
 654:   end
 655: 
 656:   defp get_initials(_), do: "?"
 657: 
 658:   defp avatar_size("xs"), do: "w-6 h-6"
 659:   defp avatar_size("sm"), do: "w-8 h-8"
 660:   defp avatar_size("md"), do: "w-10 h-10"
 661:   defp avatar_size("lg"), do: "w-12 h-12"
 662:   defp avatar_size("xl"), do: "w-16 h-16"
 663: 
 664:   defp avatar_text_size("xs"), do: "text-2xs"
 665:   defp avatar_text_size("sm"), do: "text-xs"
 666:   defp avatar_text_size("md"), do: "text-sm"
 667:   defp avatar_text_size("lg"), do: "text-base"
 668:   defp avatar_text_size("xl"), do: "text-lg"
 669: 
 670:   defp avatar_bg do
 671:     "bg-gradient-to-br from-teal-500 to-teal-600 text-white"
 672:   end
 673: 
 674:   # ============================================================================
 675:   # TABS
 676:   # ============================================================================
 677: 
 678:   @doc """
 679:   Renders a tab navigation.
 680: 
 681:   ## Examples
 682: 
 683:       <.tabs active="overview">
 684:         <:tab id="overview" icon="hero-home">Overview</:tab>
 685:         <:tab id="details">Details</:tab>
 686:         <:tab id="settings" icon="hero-cog-6-tooth">Settings</:tab>
 687:       </.tabs>
 688:   """
 689:   attr :active, :string, required: true
 690:   attr :class, :string, default: nil
 691: 
 692:   slot :tab, required: true do
 693:     attr :id, :string, required: true
 694:     attr :icon, :string
 695:     attr :href, :string
 696:   end
 697: 
 698:   def tabs(assigns) do
 699:     ~H"""
 700:     <div class={["flex gap-1 border-b border-slate-200 dark:border-slate-700", @class]}>
 701:       <a
 702:         :for={tab <- @tab}
 703:         href={tab[:href] || "#"}
 704:         phx-click={!tab[:href] && "tab_change"}
 705:         phx-value-tab={tab.id}
 706:         class={[
 707:           "inline-flex items-center gap-2 px-4 py-2.5 text-sm font-medium -mb-px border-b-2 transition-colors",
 708:           tab.id == @active && "text-teal-600 dark:text-teal-400 border-teal-600 dark:border-teal-400",
 709:           tab.id != @active &&
 710:             "text-slate-500 dark:text-slate-400 border-transparent hover:text-slate-700 dark:hover:text-slate-200 hover:border-slate-300"
 711:         ]}
 712:       >
 713:         <.icon :if={tab[:icon]} name={tab.icon} class="h-4 w-4" />
 714:         <%= render_slot(tab) %>
 715:       </a>
 716:     </div>
 717:     """
 718:   end
 719: 
 720:   # ============================================================================
 721:   # ALERTS
 722:   # ============================================================================
 723: 
 724:   @doc """
 725:   Renders an alert message.
 726: 
 727:   ## Examples
 728: 
 729:       <.alert variant="info">Information message</.alert>
 730:       <.alert variant="error" title="Error occurred">Something went wrong</.alert>
 731:   """
 732:   attr :variant, :string, default: "info", values: ~w(info success warning error)
 733:   attr :title, :string, default: nil
 734:   attr :dismissible, :boolean, default: false
 735:   attr :class, :string, default: nil
 736:   attr :rest, :global
 737: 
 738:   slot :inner_block, required: true
 739: 
 740:   def alert(assigns) do
 741:     ~H"""
 742:     <div
 743:       class={[
 744:         "p-4 rounded-xl mb-4",
 745:         alert_variant(@variant),
 746:         @class
 747:       ]}
 748:       role="alert"
 749:       {@rest}
 750:     >
 751:       <div class="flex">
 752:         <div class="flex-shrink-0">
 753:           <.icon name={alert_icon(@variant)} class="h-5 w-5" />
 754:         </div>
 755:         <div class="ml-3 flex-1">
 756:           <h3 :if={@title} class="text-sm font-semibold"><%= @title %></h3>
 757:           <div class={["text-sm", @title && "mt-1"]}>
 758:             <%= render_slot(@inner_block) %>
 759:           </div>
 760:         </div>
 761:         <button
 762:           :if={@dismissible}
 763:           type="button"
 764:           class="ml-auto -mx-1.5 -my-1.5 p-1.5 rounded-lg hover:bg-black/10 transition-colors"
 765:         >
 766:           <.icon name="hero-x-mark-mini" class="h-5 w-5" />
 767:         </button>
 768:       </div>
 769:     </div>
 770:     """
 771:   end
 772: 
 773:   defp alert_variant("info"),
 774:     do:
 775:       "bg-cyan-50 text-cyan-800 dark:bg-cyan-900/20 dark:text-cyan-300 border border-cyan-200 dark:border-cyan-800"
 776: 
 777:   defp alert_variant("success"),
 778:     do:
 779:       "bg-emerald-50 text-emerald-800 dark:bg-emerald-900/20 dark:text-emerald-300 border border-emerald-200 dark:border-emerald-800"
 780: 
 781:   defp alert_variant("warning"),
 782:     do:
 783:       "bg-amber-50 text-amber-800 dark:bg-amber-900/20 dark:text-amber-300 border border-amber-200 dark:border-amber-800"
 784: 
 785:   defp alert_variant("error"),
 786:     do:
 787:       "bg-red-50 text-red-800 dark:bg-red-900/20 dark:text-red-300 border border-red-200 dark:border-red-800"
 788: 
 789:   defp alert_icon("info"), do: "hero-information-circle-mini"
 790:   defp alert_icon("success"), do: "hero-check-circle-mini"
 791:   defp alert_icon("warning"), do: "hero-exclamation-triangle-mini"
 792:   defp alert_icon("error"), do: "hero-x-circle-mini"
 793: 
 794:   # ============================================================================
 795:   # EMPTY STATE
 796:   # ============================================================================
 797: 
 798:   @doc """
 799:   Renders an empty state placeholder.
 800: 
 801:   ## Examples
 802: 
 803:       <.empty_state
 804:         icon="hero-document-text"
 805:         title="Nenhuma aula encontrada"
 806:         description="Comece criando sua primeira aula"
 807:       >
 808:         <.button icon="hero-plus">Nova Aula</.button>
 809:       </.empty_state>
 810:   """
 811:   attr :icon, :string, default: nil
 812:   attr :title, :string, required: true
 813:   attr :description, :string, default: nil
 814:   attr :class, :string, default: nil
 815: 
 816:   slot :inner_block
 817: 
 818:   def empty_state(assigns) do
 819:     ~H"""
 820:     <div class={["flex flex-col items-center justify-center py-12 px-4 text-center", @class]}>
 821:       <div
 822:         :if={@icon}
 823:         class="w-16 h-16 rounded-2xl bg-slate-100 dark:bg-slate-800 flex items-center justify-center mb-4"
 824:       >
 825:         <.icon name={@icon} class="h-8 w-8 text-slate-400 dark:text-slate-500" />
 826:       </div>
 827:       <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-2">
 828:         <%= @title %>
 829:       </h3>
 830:       <p :if={@description} class="text-sm text-slate-500 dark:text-slate-400 max-w-sm mb-6">
 831:         <%= @description %>
 832:       </p>
 833:       <%= render_slot(@inner_block) %>
 834:     </div>
 835:     """
 836:   end
 837: 
 838:   # ============================================================================
 839:   # MODALS
 840:   # ============================================================================
 841: 
 842:   @doc """
 843:   Renders a modal.
 844: 
 845:   ## Examples
 846: 
 847:       <.modal id="confirm-modal">
 848:         Are you sure?
 849:       </.modal>
 850: 
 851:   JS commands may be passed to the `:on_cancel` to configure
 852:   the closing/cancel event, for example:
 853: 
 854:       <.modal id="confirm" on_cancel={JS.navigate(~p"/posts")}>
 855:         This is a modal.
 856:       </.modal>
 857:   """
 858:   attr :id, :string, required: true
 859:   attr :show, :boolean, default: false
 860:   attr :on_cancel, JS, default: %JS{}
 861:   slot :inner_block, required: true
 862: 
 863:   def modal(assigns) do
 864:     ~H"""
 865:     <div
 866:       id={@id}
 867:       phx-mounted={@show && show_modal(@id)}
 868:       phx-remove={hide_modal(@id)}
 869:       data-cancel={JS.exec(@on_cancel, "phx-remove")}
 870:       class="relative z-50 hidden"
 871:     >
 872:       <div
 873:         id={"#{@id}-bg"}
 874:         class="bg-slate-900/60 dark:bg-slate-900/80 backdrop-blur-sm fixed inset-0 transition-opacity"
 875:         aria-hidden="true"
 876:       />
 877:       <div
 878:         class="fixed inset-0 overflow-y-auto"
 879:         aria-labelledby={"#{@id}-title"}
 880:         aria-describedby={"#{@id}-description"}
 881:         role="dialog"
 882:         aria-modal="true"
 883:         tabindex="0"
 884:       >
 885:         <div class="flex min-h-full items-center justify-center p-4">
 886:           <div class="w-full max-w-lg">
 887:             <.focus_wrap
 888:               id={"#{@id}-container"}
 889:               phx-window-keydown={JS.exec("data-cancel", to: "##{@id}")}
 890:               phx-key="escape"
 891:               phx-click-away={JS.exec("data-cancel", to: "##{@id}")}
 892:               class="shadow-elevated rounded-2xl bg-white dark:bg-slate-800 p-6 transition"
 893:             >
 894:               <div class="absolute top-4 right-4">
 895:                 <button
 896:                   phx-click={JS.exec("data-cancel", to: "##{@id}")}
 897:                   type="button"
 898:                   class="flex-none p-2 text-slate-400 hover:text-slate-500 dark:hover:text-slate-300 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
 899:                   aria-label="close"
 900:                 >
 901:                   <.icon name="hero-x-mark-solid" class="h-5 w-5" />
 902:                 </button>
 903:               </div>
 904:               <div id={"#{@id}-content"}>
 905:                 <%= render_slot(@inner_block) %>
 906:               </div>
 907:             </.focus_wrap>
 908:           </div>
 909:         </div>
 910:       </div>
 911:     </div>
 912:     """
 913:   end
 914: 
 915:   # ============================================================================
 916:   # NAVIGATION
 917:   # ============================================================================
 918: 
 919:   @doc """
 920:   Renders the main navbar.
 921: 
 922:   ## Examples
 923: 
 924:       <.navbar current_user={@current_user} />
 925:   """
 926:   attr :current_user, :map, default: nil
 927: 
 928:   def navbar(assigns) do
 929:     ~H"""
 930:     <nav class="bg-white dark:bg-slate-900 shadow-sm border-b border-slate-200 dark:border-slate-700 transition-colors duration-200">
 931:       <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
 932:         <div class="flex justify-between h-16">
 933:           <div class="flex items-center">
 934:             <a href={if @current_user, do: "/dashboard", else: "/"} class="flex items-center gap-1">
 935:               <span class="text-xl font-bold text-teal-600 dark:text-teal-400">Hellen</span>
 936:               <span class="text-xs font-medium text-slate-500 dark:text-slate-400">AI</span>
 937:             </a>
 938:           </div>
 939: 
 940:           <div :if={@current_user} class="flex items-center gap-4">
 941:             <a
 942:               href="/lessons/new"
 943:               class="text-slate-600 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white text-sm font-medium transition-colors"
 944:             >
 945:               Nova Aula
 946:             </a>
 947:             <button
 948:               phx-hook="ThemeToggle"
 949:               id="navbar-theme-toggle"
 950:               class="p-2 text-slate-400 dark:text-slate-300 hover:text-slate-500 dark:hover:text-white rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
 951:               title="Alternar tema"
 952:             >
 953:               <.icon name="hero-sun" class="h-5 w-5 dark:hidden" />
 954:               <.icon name="hero-moon" class="h-5 w-5 hidden dark:block" />
 955:             </button>
 956:             <div class="flex items-center gap-2">
 957:               <.avatar name={@current_user.name || @current_user.email} size="sm" />
 958:               <a
 959:                 href="/logout"
 960:                 class="text-slate-400 dark:text-slate-300 hover:text-slate-500 dark:hover:text-white transition-colors"
 961:               >
 962:                 <.icon name="hero-arrow-right-on-rectangle" class="h-5 w-5" />
 963:               </a>
 964:             </div>
 965:           </div>
 966: 
 967:           <div :if={!@current_user} class="flex items-center gap-4">
 968:             <button
 969:               phx-hook="ThemeToggle"
 970:               id="navbar-theme-toggle-guest"
 971:               class="p-2 text-slate-400 dark:text-slate-300 hover:text-slate-500 dark:hover:text-white rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
 972:               title="Alternar tema"
 973:             >
 974:               <.icon name="hero-sun" class="h-5 w-5 dark:hidden" />
 975:               <.icon name="hero-moon" class="h-5 w-5 hidden dark:block" />
 976:             </button>
 977:             <a
 978:               href="/login"
 979:               class="text-slate-600 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white text-sm font-medium transition-colors"
 980:             >
 981:               Entrar
 982:             </a>
 983:             <a
 984:               href="/register"
 985:               class="inline-flex items-center px-4 py-2 rounded-lg text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 shadow-sm transition-colors"
 986:             >
 987:               Criar Conta
 988:             </a>
 989:           </div>
 990:         </div>
 991:       </div>
 992:     </nav>
 993:     """
 994:   end
 995: 
 996:   @doc """
 997:   Renders the app navbar with modern styling (for logged-in area).
 998: 
 999:   ## Examples
1000: 
1001:       <.app_navbar current_user={@current_user} />
1002:   """
1003:   attr :current_user, :map, default: nil
1004: 
1005:   def app_navbar(assigns) do
1006:     ~H"""
1007:     <nav class="sticky top-0 z-50 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200/50 dark:border-slate-700/50 transition-all duration-300">
1008:       <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
1009:         <div class="flex justify-between items-center h-16">
1010:           <!-- Logo -->
1011:           <div class="flex items-center">
1012:             <a href={if @current_user, do: "/dashboard", else: "/"} class="flex items-center gap-1">
1013:               <span class="text-xl font-bold text-teal-600 dark:text-teal-400">Hellen</span>
1014:               <span class="text-xs font-medium text-slate-500 dark:text-slate-400">AI</span>
1015:             </a>
1016:           </div>
1017:           <!-- Desktop Navigation (logged in) -->
1018:           <div :if={@current_user} class="hidden md:flex items-center gap-6">
1019:             <a
1020:               href="/dashboard"
1021:               class="text-slate-600 dark:text-slate-300 hover:text-teal-600 dark:hover:text-teal-400 text-sm font-medium transition-colors"
1022:             >
1023:               Dashboard
1024:             </a>
1025:             <a
1026:               href="/lessons/new"
1027:               class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold text-white bg-teal-600 hover:bg-teal-700 shadow-sm hover:shadow-md transition-all duration-200"
1028:             >
1029:               <.icon name="hero-plus" class="h-4 w-4" /> Nova Aula
1030:             </a>
1031:             <button
1032:               phx-hook="ThemeToggle"
1033:               id="app-theme-toggle"
1034:               class="p-2 text-slate-400 dark:text-slate-300 hover:text-slate-600 dark:hover:text-white rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
1035:               title="Alternar tema"
1036:             >
1037:               <.icon name="hero-sun" class="h-5 w-5 dark:hidden" />
1038:               <.icon name="hero-moon" class="h-5 w-5 hidden dark:block" />
1039:             </button>
1040:             <div class="flex items-center gap-3 pl-4 border-l border-slate-200 dark:border-slate-700">
1041:               <.avatar name={@current_user.name || @current_user.email} />
1042:               <span class="text-sm font-medium text-slate-700 dark:text-slate-200 hidden lg:block">
1043:                 <%= @current_user.name || @current_user.email %>
1044:               </span>
1045:               <a
1046:                 href="/logout"
1047:                 class="p-2 text-slate-400 dark:text-slate-300 hover:text-red-500 dark:hover:text-red-400 transition-colors"
1048:                 title="Sair"
1049:               >
1050:                 <.icon name="hero-arrow-right-on-rectangle" class="h-5 w-5" />
1051:               </a>
1052:             </div>
1053:           </div>
1054:           <!-- Mobile menu button -->
1055:           <div :if={@current_user} class="flex md:hidden items-center gap-2">
1056:             <button
1057:               phx-hook="ThemeToggle"
1058:               id="app-theme-toggle-mobile"
1059:               class="p-2 text-slate-400 dark:text-slate-300 hover:text-slate-600 dark:hover:text-white rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
1060:               title="Alternar tema"
1061:             >
1062:               <.icon name="hero-sun" class="h-5 w-5 dark:hidden" />
1063:               <.icon name="hero-moon" class="h-5 w-5 hidden dark:block" />
1064:             </button>
1065:             <button
1066:               type="button"
1067:               class="p-2 text-slate-400 dark:text-slate-300 hover:text-slate-600 dark:hover:text-white rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
1068:               phx-click={
1069:                 JS.toggle(to: "#app-mobile-menu", in: "fade-in-scale", out: "fade-out-scale")
1070:               }
1071:               aria-expanded="false"
1072:               aria-controls="app-mobile-menu"
1073:             >
1074:               <span class="sr-only">Abrir menu</span>
1075:               <.icon name="hero-bars-3" class="h-6 w-6" />
1076:             </button>
1077:           </div>
1078:           <!-- Desktop Navigation (not logged in) -->
1079:           <div :if={!@current_user} class="flex items-center gap-4">
1080:             <button
1081:               phx-hook="ThemeToggle"
1082:               id="app-theme-toggle-guest"
1083:               class="p-2 text-slate-400 dark:text-slate-300 hover:text-slate-500 dark:hover:text-white rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
1084:               title="Alternar tema"
1085:             >
1086:               <.icon name="hero-sun" class="h-5 w-5 dark:hidden" />
1087:               <.icon name="hero-moon" class="h-5 w-5 hidden dark:block" />
1088:             </button>
1089:             <a
1090:               href="/login"
1091:               class="text-slate-600 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white text-sm font-medium transition-colors"
1092:             >
1093:               Entrar
1094:             </a>
1095:             <a
1096:               href="/register"
1097:               class="inline-flex items-center px-4 py-2 rounded-lg text-sm font-semibold text-white bg-teal-600 hover:bg-teal-700 shadow-sm transition-all duration-200"
1098:             >
1099:               Criar Conta
1100:             </a>
1101:           </div>
1102:         </div>
1103:       </div>
1104:       <!-- Mobile menu (logged in) -->
1105:       <div
1106:         :if={@current_user}
1107:         id="app-mobile-menu"
1108:         class="hidden md:hidden bg-white/95 dark:bg-slate-900/95 backdrop-blur-md border-t border-slate-200/50 dark:border-slate-700/50"
1109:       >
1110:         <div class="px-4 py-4 space-y-3">
1111:           <div class="flex items-center gap-3 pb-3 border-b border-slate-200 dark:border-slate-700">
1112:             <.avatar name={@current_user.name || @current_user.email} size="lg" />
1113:             <div>
1114:               <p class="text-sm font-medium text-slate-900 dark:text-white">
1115:                 <%= @current_user.name || "Usuario" %>
1116:               </p>
1117:               <p class="text-xs text-slate-500 dark:text-slate-400"><%= @current_user.email %></p>
1118:             </div>
1119:           </div>
1120:           <a
1121:             href="/dashboard"
1122:             class="flex items-center gap-3 px-3 py-2 rounded-lg text-base font-medium text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
1123:             phx-click={JS.hide(to: "#app-mobile-menu")}
1124:           >
1125:             <.icon name="hero-home" class="h-5 w-5" /> Dashboard
1126:           </a>
1127:           <a
1128:             href="/lessons/new"
1129:             class="flex items-center gap-3 px-3 py-2 rounded-lg text-base font-medium text-teal-600 dark:text-teal-400 hover:bg-teal-50 dark:hover:bg-teal-500/10 transition-colors"
1130:             phx-click={JS.hide(to: "#app-mobile-menu")}
1131:           >
1132:             <.icon name="hero-plus-circle" class="h-5 w-5" /> Nova Aula
1133:           </a>
1134:           <a
1135:             href="/logout"
1136:             class="flex items-center gap-3 px-3 py-2 rounded-lg text-base font-medium text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-500/10 transition-colors"
1137:           >
1138:             <.icon name="hero-arrow-right-on-rectangle" class="h-5 w-5" /> Sair
1139:           </a>
1140:         </div>
1141:       </div>
1142:     </nav>
1143:     """
1144:   end
1145: 
1146:   @doc """
1147:   Renders a sidebar for coordinators.
1148: 
1149:   ## Examples
1150: 
1151:       <.sidebar current_path={@current_path}>
1152:         <:item path="/" icon="hero-home">Dashboard</:item>
1153:         <:item path="/teachers" icon="hero-users">Professores</:item>
1154:       </.sidebar>
1155:   """
1156:   attr :current_path, :string, default: "/"
1157: 
1158:   slot :item, required: true do
1159:     attr :path, :string, required: true
1160:     attr :icon, :string
1161:   end
1162: 
1163:   def sidebar(assigns) do
1164:     ~H"""
1165:     <aside class="w-64 bg-slate-900 min-h-screen flex flex-col">
1166:       <div class="p-5 border-b border-slate-800">
1167:         <span class="text-xl font-bold text-teal-400">Hellen</span>
1168:         <span class="ml-1 text-xs text-slate-500">Coordenador</span>
1169:       </div>
1170:       <nav class="flex-1 py-4 px-3 space-y-1">
1171:         <a
1172:           :for={item <- @item}
1173:           href={item.path}
1174:           class={[
1175:             "flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg transition-colors",
1176:             item.path == @current_path && "bg-teal-600/20 text-teal-400",
1177:             item.path != @current_path && "text-slate-400 hover:bg-slate-800 hover:text-white"
1178:           ]}
1179:         >
1180:           <.icon :if={item[:icon]} name={item.icon} class="h-5 w-5" />
1181:           <%= render_slot(item) %>
1182:         </a>
1183:       </nav>
1184:     </aside>
1185:     """
1186:   end
1187: 
1188:   # ============================================================================
1189:   # FILE UPLOAD
1190:   # ============================================================================
1191: 
1192:   @doc """
1193:   Renders a file upload dropzone for LiveView uploads.
1194: 
1195:   ## Examples
1196: 
1197:       <.dropzone upload={@uploads.audio} />
1198:   """
1199:   attr :upload, :map, required: true
1200:   attr :accept, :string, default: "audio/*,video/*"
1201:   attr :class, :string, default: nil
1202: 
1203:   def dropzone(assigns) do
1204:     ~H"""
1205:     <div
1206:       id={"dropzone-#{@upload.ref}"}
1207:       phx-hook="DropZone"
1208:       phx-drop-target={@upload.ref}
1209:       class={[
1210:         "border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-8",
1211:         "text-center cursor-pointer transition-all duration-200",
1212:         "hover:border-teal-400 hover:bg-teal-50 dark:hover:bg-teal-900/10",
1213:         @class
1214:       ]}
1215:     >
1216:       <.live_file_input upload={@upload} class="hidden" />
1217:       <div class="space-y-3">
1218:         <div class="w-14 h-14 mx-auto rounded-xl bg-slate-100 dark:bg-slate-800 flex items-center justify-center">
1219:           <.icon name="hero-cloud-arrow-up" class="h-7 w-7 text-slate-400" />
1220:         </div>
1221:         <div class="text-sm text-slate-600 dark:text-slate-400">
1222:           <span class="font-semibold text-teal-600 dark:text-teal-400">Clique para enviar</span>
1223:           ou arraste e solte
1224:         </div>
1225:         <p class="text-xs text-slate-500 dark:text-slate-500">
1226:           <%= @accept %>
1227:         </p>
1228:       </div>
1229: 
1230:       <div :for={entry <- @upload.entries} class="mt-6 text-left">
1231:         <div class="flex items-center justify-between text-sm mb-2">
1232:           <span class="truncate text-slate-700 dark:text-slate-300"><%= entry.client_name %></span>
1233:           <span class="text-teal-600 dark:text-teal-400 font-medium"><%= entry.progress %>%</span>
1234:         </div>
1235:         <.progress value={entry.progress} />
1236:       </div>
1237:     </div>
1238:     """
1239:   end
1240: 
1241:   # ============================================================================
1242:   # TABLES
1243:   # ============================================================================
1244: 
1245:   @doc """
1246:   Renders a table with generic styling.
1247: 
1248:   ## Examples
1249: 
1250:       <.table id="users" rows={@users}>
1251:         <:col :let={user} label="Name"><%= user.name %></:col>
1252:         <:col :let={user} label="Email"><%= user.email %></:col>
1253:       </.table>
1254:   """
1255:   attr :id, :string, required: true
1256:   attr :rows, :list, required: true
1257:   attr :row_id, :any, default: nil, doc: "the function for generating the row id"
1258:   attr :row_click, :any, default: nil, doc: "the function for handling phx-click on each row"
1259: 
1260:   attr :row_item, :any,
1261:     default: &Function.identity/1,
1262:     doc: "the function for mapping each row before calling the :col and :action slots"
1263: 
1264:   slot :col, required: true do
1265:     attr :label, :string
1266:   end
1267: 
1268:   slot :action, doc: "the slot for showing user actions in the last table column"
1269: 
1270:   def table(assigns) do
1271:     assigns =
1272:       with %{rows: %Phoenix.LiveView.LiveStream{}} <- assigns do
1273:         assign(assigns, row_id: assigns.row_id || fn {id, _item} -> id end)
1274:       end
1275: 
1276:     ~H"""
1277:     <div class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700">
1278:       <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
1279:         <thead class="bg-slate-50 dark:bg-slate-800/50">
1280:           <tr>
1281:             <th
1282:               :for={col <- @col}
1283:               class="px-4 py-3 text-left text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider"
1284:             >
1285:               <%= col[:label] %>
1286:             </th>
1287:             <th :if={@action != []} class="relative px-4 py-3">
1288:               <span class="sr-only">Actions</span>
1289:             </th>
1290:           </tr>
1291:         </thead>
1292:         <tbody
1293:           id={@id}
1294:           phx-update={match?(%Phoenix.LiveView.LiveStream{}, @rows) && "stream"}
1295:           class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700"
1296:         >
1297:           <tr
1298:             :for={row <- @rows}
1299:             id={@row_id && @row_id.(row)}
1300:             class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors"
1301:           >
1302:             <td
1303:               :for={{col, _i} <- Enum.with_index(@col)}
1304:               phx-click={@row_click && @row_click.(row)}
1305:               class={[
1306:                 "px-4 py-3 text-sm text-slate-900 dark:text-slate-100",
1307:                 @row_click && "cursor-pointer"
1308:               ]}
1309:             >
1310:               <%= render_slot(col, @row_item.(row)) %>
1311:             </td>
1312:             <td :if={@action != []} class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
1313:               <%= for action <- @action do %>
1314:                 <%= render_slot(action, @row_item.(row)) %>
1315:               <% end %>
1316:             </td>
1317:           </tr>
1318:         </tbody>
1319:       </table>
1320:     </div>
1321:     """
1322:   end
1323: 
1324:   # ============================================================================
1325:   # SIMPLE FORM
1326:   # ============================================================================
1327: 
1328:   @doc """
1329:   Renders a simple form.
1330: 
1331:   ## Examples
1332: 
1333:       <.simple_form for={@form} phx-change="validate" phx-submit="save">
1334:         <.input field={@form[:email]} label="Email"/>
1335:         <.input field={@form[:username]} label="Username" />
1336:         <:actions>
1337:           <.button>Save</.button>
1338:         </:actions>
1339:       </.simple_form>
1340:   """
1341:   attr :for, :any, required: true, doc: "the datastructure for the form"
1342:   attr :as, :any, default: nil, doc: "the server side parameter to collect all input under"
1343: 
1344:   attr :rest, :global,
1345:     include: ~w(autocomplete name rel action enctype method novalidate target multipart),
1346:     doc: "the arbitrary HTML attributes to apply to the form tag"
1347: 
1348:   slot :inner_block, required: true
1349:   slot :actions, doc: "the slot for form actions, such as a submit button"
1350: 
1351:   def simple_form(assigns) do
1352:     ~H"""
1353:     <.form :let={f} for={@for} as={@as} {@rest}>
1354:       <div class="space-y-6">
1355:         <%= render_slot(@inner_block, f) %>
1356:         <div :for={action <- @actions} class="flex items-center justify-end gap-4 pt-4">
1357:           <%= render_slot(action, f) %>
1358:         </div>
1359:       </div>
1360:     </.form>
1361:     """
1362:   end
1363: 
1364:   @doc """
1365:   Renders flash notices.
1366:   """
1367:   attr :id, :string, doc: "the optional id of flash container"
1368:   attr :flash, :map, default: %{}, doc: "the map of flash messages to display"
1369:   attr :title, :string, default: nil
1370:   attr :kind, :atom, values: [:info, :error], doc: "used for styling and flash lookup"
1371:   attr :rest, :global, doc: "the arbitrary HTML attributes to add to the flash container"
1372: 
1373:   slot :inner_block, doc: "the optional inner block that renders the flash message"
1374: 
1375:   def flash(assigns) do
1376:     assigns = assign_new(assigns, :id, fn -> "flash-#{assigns.kind}" end)
1377: 
1378:     ~H"""
1379:     <div
1380:       :if={msg = render_slot(@inner_block) || Phoenix.Flash.get(@flash, @kind)}
1381:       id={@id}
1382:       phx-click={JS.push("lv:clear-flash", value: %{key: @kind}) |> hide("##{@id}")}
1383:       role="alert"
1384:       class={[
1385:         "fixed top-4 right-4 w-80 sm:w-96 z-50 rounded-xl p-4 shadow-elevated",
1386:         @kind == :info &&
1387:           "bg-emerald-50 dark:bg-emerald-900/50 text-emerald-800 dark:text-emerald-200 ring-1 ring-emerald-500/20",
1388:         @kind == :error &&
1389:           "bg-red-50 dark:bg-red-900/50 text-red-800 dark:text-red-200 ring-1 ring-red-500/20"
1390:       ]}
1391:       {@rest}
1392:     >
1393:       <p :if={@title} class="flex items-center gap-1.5 text-sm font-semibold leading-6">
1394:         <.icon
1395:           name={if @kind == :info, do: "hero-check-circle-mini", else: "hero-x-circle-mini"}
1396:           class="h-5 w-5"
1397:         />
1398:         <%= @title %>
1399:       </p>
1400:       <p class={["text-sm leading-5", @title && "mt-1"]}><%= msg %></p>
1401:       <button
1402:         type="button"
1403:         class="absolute top-3 right-3 p-1 rounded-lg hover:bg-black/10 dark:hover:bg-white/10 transition-colors"
1404:         aria-label="close"
1405:       >
1406:         <.icon name="hero-x-mark-mini" class="h-4 w-4" />
1407:       </button>
1408:     </div>
1409:     """
1410:   end
1411: 
1412:   @doc """
1413:   Shows the flash group with standard titles and content.
1414:   """
1415:   attr :flash, :map, required: true, doc: "the map of flash messages"
1416:   attr :id, :string, default: "flash-group", doc: "the optional id of flash container"
1417: 
1418:   def flash_group(assigns) do
1419:     ~H"""
1420:     <div id={@id}>
1421:       <.flash kind={:info} title="Sucesso!" flash={@flash} />
1422:       <.flash kind={:error} title="Erro!" flash={@flash} />
1423:     </div>
1424:     """
1425:   end
1426: 
1427:   defp hide(js, selector) do
1428:     JS.hide(js,
1429:       to: selector,
1430:       time: 200,
1431:       transition:
1432:         {"transition-all transform ease-in duration-200",
1433:          "opacity-100 translate-y-0 sm:scale-100",
1434:          "opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"}
1435:     )
1436:   end
1437: 
1438:   # ============================================================================
1439:   # HELPER FUNCTIONS
1440:   # ============================================================================
1441: 
1442:   @doc """
1443:   Translates an error message using gettext.
1444:   """
1445:   def translate_error({msg, opts}) do
1446:     if count = opts[:count] do
1447:       Gettext.dngettext(HellenWeb.Gettext, "errors", msg, msg, count, opts)
1448:     else
1449:       Gettext.dgettext(HellenWeb.Gettext, "errors", msg, opts)
1450:     end
1451:   end
1452: 
1453:   @doc """
1454:   Translates the errors for a field from a keyword list of errors.
1455:   """
1456:   def translate_errors(errors, field) when is_list(errors) do
1457:     for {^field, {msg, opts}} <- errors, do: translate_error({msg, opts})
1458:   end
1459: 
1460:   @doc """
1461:   Shows a modal by ID.
1462:   """
1463:   def show_modal(id) when is_binary(id) do
1464:     JS.show(to: "##{id}")
1465:     |> JS.show(
1466:       to: "##{id}-bg",
1467:       transition: {"transition-all transform ease-out duration-300", "opacity-0", "opacity-100"}
1468:     )
1469:     |> JS.show(
1470:       to: "##{id}-container",
1471:       transition:
1472:         {"transition-all transform ease-out duration-300",
1473:          "opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95",
1474:          "opacity-100 translate-y-0 sm:scale-100"}
1475:     )
1476:     |> JS.add_class("overflow-hidden", to: "body")
1477:     |> JS.focus_first(to: "##{id}-content")
1478:   end
1479: 
1480:   @doc """
1481:   Hides a modal by ID.
1482:   """
1483:   def hide_modal(id) when is_binary(id) do
1484:     JS.hide(
1485:       to: "##{id}-bg",
1486:       transition: {"transition-all transform ease-in duration-200", "opacity-100", "opacity-0"}
1487:     )
1488:     |> JS.hide(
1489:       to: "##{id}-container",
1490:       transition:
1491:         {"transition-all transform ease-in duration-200",
1492:          "opacity-100 translate-y-0 sm:scale-100",
1493:          "opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"}
1494:     )
1495:     |> JS.hide(to: "##{id}", transition: {"block", "block", "hidden"})
1496:     |> JS.remove_class("overflow-hidden", to: "body")
1497:     |> JS.pop_focus()
1498:   end
1499: 
1500:   # ============================================================================
1501:   # LOADING SKELETONS
1502:   # ============================================================================
1503: 
1504:   @doc """
1505:   Renders a skeleton loading placeholder.
1506: 
1507:   ## Examples
1508: 
1509:       <.skeleton class="h-4 w-3/4" />
1510:       <.skeleton variant="circle" class="h-10 w-10" />
1511:       <.skeleton variant="text" lines={3} />
1512:   """
1513:   attr :variant, :string, default: "rectangle", values: ~w(rectangle circle text avatar card stat)
1514:   attr :class, :string, default: nil
1515:   attr :lines, :integer, default: 3
1516:   attr :animated, :boolean, default: true
1517: 
1518:   def skeleton(assigns) do
1519:     ~H"""
1520:     <div
1521:       :if={@variant == "rectangle"}
1522:       class={[
1523:         "rounded-lg bg-slate-200 dark:bg-slate-700",
1524:         @animated && "animate-pulse",
1525:         @class
1526:       ]}
1527:     />
1528: 
1529:     <div
1530:       :if={@variant == "circle"}
1531:       class={[
1532:         "rounded-full bg-slate-200 dark:bg-slate-700",
1533:         @animated && "animate-pulse",
1534:         @class
1535:       ]}
1536:     />
1537: 
1538:     <div :if={@variant == "text"} class={["space-y-2", @class]}>
1539:       <div
1540:         :for={i <- 1..@lines}
1541:         class={[
1542:           "h-4 rounded bg-slate-200 dark:bg-slate-700",
1543:           @animated && "animate-pulse",
1544:           i == @lines && "w-3/4"
1545:         ]}
1546:       />
1547:     </div>
1548: 
1549:     <div
1550:       :if={@variant == "avatar"}
1551:       class={[
1552:         "flex items-center gap-3",
1553:         @class
1554:       ]}
1555:     >
1556:       <div class={[
1557:         "w-10 h-10 rounded-full bg-slate-200 dark:bg-slate-700",
1558:         @animated && "animate-pulse"
1559:       ]} />
1560:       <div class="space-y-2 flex-1">
1561:         <div class={["h-4 w-1/3 rounded bg-slate-200 dark:bg-slate-700", @animated && "animate-pulse"]} />
1562:         <div class={["h-3 w-1/2 rounded bg-slate-200 dark:bg-slate-700", @animated && "animate-pulse"]} />
1563:       </div>
1564:     </div>
1565: 
1566:     <div
1567:       :if={@variant == "card"}
1568:       class={[
1569:         "bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-5 space-y-4",
1570:         @class
1571:       ]}
1572:     >
1573:       <div class="flex items-center gap-3">
1574:         <div class={[
1575:           "w-12 h-12 rounded-xl bg-slate-200 dark:bg-slate-700",
1576:           @animated && "animate-pulse"
1577:         ]} />
1578:         <div class="flex-1 space-y-2">
1579:           <div class={[
1580:             "h-4 w-1/2 rounded bg-slate-200 dark:bg-slate-700",
1581:             @animated && "animate-pulse"
1582:           ]} />
1583:           <div class={[
1584:             "h-3 w-3/4 rounded bg-slate-200 dark:bg-slate-700",
1585:             @animated && "animate-pulse"
1586:           ]} />
1587:         </div>
1588:       </div>
1589:       <div class="space-y-2">
1590:         <div class={["h-3 rounded bg-slate-200 dark:bg-slate-700", @animated && "animate-pulse"]} />
1591:         <div class={["h-3 w-5/6 rounded bg-slate-200 dark:bg-slate-700", @animated && "animate-pulse"]} />
1592:       </div>
1593:     </div>
1594: 
1595:     <div
1596:       :if={@variant == "stat"}
1597:       class={[
1598:         "bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-5",
1599:         @class
1600:       ]}
1601:     >
1602:       <div class="flex items-start justify-between">
1603:         <div class="space-y-3 flex-1">
1604:           <div class={[
1605:             "h-4 w-1/3 rounded bg-slate-200 dark:bg-slate-700",
1606:             @animated && "animate-pulse"
1607:           ]} />
1608:           <div class={[
1609:             "h-8 w-1/2 rounded bg-slate-200 dark:bg-slate-700",
1610:             @animated && "animate-pulse"
1611:           ]} />
1612:           <div class={[
1613:             "h-3 w-2/3 rounded bg-slate-200 dark:bg-slate-700",
1614:             @animated && "animate-pulse"
1615:           ]} />
1616:         </div>
1617:         <div class={[
1618:           "w-12 h-12 rounded-xl bg-slate-200 dark:bg-slate-700",
1619:           @animated && "animate-pulse"
1620:         ]} />
1621:       </div>
1622:     </div>
1623:     """
1624:   end
1625: 
1626:   @doc """
1627:   Renders a loading spinner.
1628: 
1629:   ## Examples
1630: 
1631:       <.spinner />
1632:       <.spinner size="lg" />
1633:       <.spinner variant="dots" />
1634:   """
1635:   attr :size, :string, default: "md", values: ~w(sm md lg)
1636:   attr :variant, :string, default: "spinner", values: ~w(spinner dots bars)
1637:   attr :class, :string, default: nil
1638: 
1639:   def spinner(assigns) do
1640:     ~H"""
1641:     <div
1642:       :if={@variant == "spinner"}
1643:       class={[
1644:         "inline-block border-2 border-current border-t-transparent rounded-full animate-spin",
1645:         spinner_size(@size),
1646:         "text-teal-600 dark:text-teal-400",
1647:         @class
1648:       ]}
1649:       role="status"
1650:       aria-label="Loading"
1651:     />
1652: 
1653:     <div
1654:       :if={@variant == "dots"}
1655:       class={["inline-flex items-center gap-1", @class]}
1656:       role="status"
1657:       aria-label="Loading"
1658:     >
1659:       <span
1660:         class={["rounded-full bg-teal-600 dark:bg-teal-400 animate-bounce", dots_size(@size)]}
1661:         style="animation-delay: 0ms"
1662:       />
1663:       <span
1664:         class={["rounded-full bg-teal-600 dark:bg-teal-400 animate-bounce", dots_size(@size)]}
1665:         style="animation-delay: 150ms"
1666:       />
1667:       <span
1668:         class={["rounded-full bg-teal-600 dark:bg-teal-400 animate-bounce", dots_size(@size)]}
1669:         style="animation-delay: 300ms"
1670:       />
1671:     </div>
1672: 
1673:     <div
1674:       :if={@variant == "bars"}
1675:       class={["inline-flex items-end gap-0.5", @class]}
1676:       role="status"
1677:       aria-label="Loading"
1678:     >
1679:       <span
1680:         class={["bg-teal-600 dark:bg-teal-400 animate-pulse rounded-sm", bars_size(@size)]}
1681:         style="animation-delay: 0ms"
1682:       />
1683:       <span
1684:         class={["bg-teal-600 dark:bg-teal-400 animate-pulse rounded-sm", bars_size(@size)]}
1685:         style="animation-delay: 100ms"
1686:       />
1687:       <span
1688:         class={["bg-teal-600 dark:bg-teal-400 animate-pulse rounded-sm", bars_size(@size)]}
1689:         style="animation-delay: 200ms"
1690:       />
1691:       <span
1692:         class={["bg-teal-600 dark:bg-teal-400 animate-pulse rounded-sm", bars_size(@size)]}
1693:         style="animation-delay: 300ms"
1694:       />
1695:     </div>
1696:     """
1697:   end
1698: 
1699:   defp spinner_size("sm"), do: "w-4 h-4"
1700:   defp spinner_size("md"), do: "w-6 h-6"
1701:   defp spinner_size("lg"), do: "w-8 h-8"
1702: 
1703:   defp dots_size("sm"), do: "w-1.5 h-1.5"
1704:   defp dots_size("md"), do: "w-2 h-2"
1705:   defp dots_size("lg"), do: "w-3 h-3"
1706: 
1707:   defp bars_size("sm"), do: "w-1 h-3"
1708:   defp bars_size("md"), do: "w-1.5 h-4"
1709:   defp bars_size("lg"), do: "w-2 h-5"
1710: 
1711:   @doc """
1712:   Renders a loading overlay.
1713: 
1714:   ## Examples
1715: 
1716:       <.loading_overlay />
1717:       <.loading_overlay message="Carregando dados..." />
1718:   """
1719:   attr :message, :string, default: nil
1720:   attr :class, :string, default: nil
1721: 
1722:   def loading_overlay(assigns) do
1723:     ~H"""
1724:     <div class={[
1725:       "absolute inset-0 z-10 flex flex-col items-center justify-center",
1726:       "bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm rounded-xl",
1727:       @class
1728:     ]}>
1729:       <.spinner size="lg" />
1730:       <p :if={@message} class="mt-3 text-sm text-slate-600 dark:text-slate-400"><%= @message %></p>
1731:     </div>
1732:     """
1733:   end
1734: 
1735:   # ============================================================================
1736:   # TOOLTIP
1737:   # ============================================================================
1738: 
1739:   @doc """
1740:   Renders a tooltip.
1741: 
1742:   ## Examples
1743: 
1744:       <.tooltip text="Hello world">
1745:         <button>Hover me</button>
1746:       </.tooltip>
1747:   """
1748:   attr :text, :string, required: true
1749:   attr :position, :string, default: "top", values: ~w(top bottom left right)
1750:   attr :class, :string, default: nil
1751: 
1752:   slot :inner_block, required: true
1753: 
1754:   def tooltip(assigns) do
1755:     ~H"""
1756:     <div class="relative group inline-block">
1757:       <%= render_slot(@inner_block) %>
1758:       <div class={[
1759:         "absolute z-50 px-2 py-1 text-xs font-medium whitespace-nowrap rounded shadow-lg",
1760:         "bg-slate-900 text-white dark:bg-slate-100 dark:text-slate-900",
1761:         "opacity-0 invisible group-hover:opacity-100 group-hover:visible",
1762:         "transition-all duration-200",
1763:         tooltip_position(@position),
1764:         @class
1765:       ]}>
1766:         <%= @text %>
1767:         <div class={[
1768:           "absolute w-2 h-2 rotate-45 bg-slate-900 dark:bg-slate-100",
1769:           tooltip_arrow(@position)
1770:         ]} />
1771:       </div>
1772:     </div>
1773:     """
1774:   end
1775: 
1776:   defp tooltip_position("top"), do: "bottom-full left-1/2 -translate-x-1/2 mb-2"
1777:   defp tooltip_position("bottom"), do: "top-full left-1/2 -translate-x-1/2 mt-2"
1778:   defp tooltip_position("left"), do: "right-full top-1/2 -translate-y-1/2 mr-2"
1779:   defp tooltip_position("right"), do: "left-full top-1/2 -translate-y-1/2 ml-2"
1780: 
1781:   defp tooltip_arrow("top"), do: "top-full left-1/2 -translate-x-1/2 -translate-y-1/2"
1782:   defp tooltip_arrow("bottom"), do: "bottom-full left-1/2 -translate-x-1/2 translate-y-1/2"
1783:   defp tooltip_arrow("left"), do: "left-full top-1/2 -translate-y-1/2 -translate-x-1/2"
1784:   defp tooltip_arrow("right"), do: "right-full top-1/2 -translate-y-1/2 translate-x-1/2"
1785: 
1786:   # ============================================================================
1787:   # ANIMATED COUNTER
1788:   # ============================================================================
1789: 
1790:   @doc """
1791:   Renders an animated counter that counts up to a target value.
1792:   Requires the AnimatedCounter hook to be enabled in app.js.
1793: 
1794:   ## Examples
1795: 
1796:       <.animated_counter value={1234} />
1797:       <.animated_counter value={99.5} prefix="R$" suffix="%" />
1798:   """
1799:   attr :value, :any, required: true
1800:   attr :prefix, :string, default: nil
1801:   attr :suffix, :string, default: nil
1802:   attr :duration, :integer, default: 1500
1803:   attr :class, :string, default: nil
1804: 
1805:   def animated_counter(assigns) do
1806:     ~H"""
1807:     <span
1808:       id={"counter-#{:erlang.unique_integer([:positive])}"}
1809:       phx-hook="AnimatedCounter"
1810:       data-target={@value}
1811:       data-duration={@duration}
1812:       data-prefix={@prefix || ""}
1813:       data-suffix={@suffix || ""}
1814:       class={["tabular-nums", @class]}
1815:     >
1816:       <%= @prefix %><span class="counter-value">0</span><%= @suffix %>
1817:     </span>
1818:     """
1819:   end
1820: 
1821:   # ============================================================================
1822:   # DROPDOWN MENU
1823:   # ============================================================================
1824: 
1825:   @doc """
1826:   Renders a dropdown menu.
1827: 
1828:   ## Examples
1829: 
1830:       <.dropdown id="user-menu">
1831:         <:trigger>
1832:           <button>Menu</button>
1833:         </:trigger>
1834:         <:item>Profile</:item>
1835:         <:item>Settings</:item>
1836:         <:divider />
1837:         <:item variant="danger">Logout</:item>
1838:       </.dropdown>
1839:   """
1840:   attr :id, :string, required: true
1841: 
1842:   attr :position, :string,
1843:     default: "bottom-right",
1844:     values: ~w(bottom-left bottom-right top-left top-right)
1845: 
1846:   attr :class, :string, default: nil
1847: 
1848:   slot :trigger, required: true
1849: 
1850:   slot :item do
1851:     attr :href, :string
1852:     attr :variant, :string
1853:   end
1854: 
1855:   slot :divider
1856: 
1857:   def dropdown(assigns) do
1858:     ~H"""
1859:     <div class={["relative inline-block", @class]}>
1860:       <div phx-click={
1861:         JS.toggle(to: "##{@id}-menu", in: "animate-fade-in-scale", out: "animate-fade-out-scale")
1862:       }>
1863:         <%= render_slot(@trigger) %>
1864:       </div>
1865:       <div
1866:         id={"#{@id}-menu"}
1867:         class={[
1868:           "absolute z-50 min-w-[180px] rounded-xl hidden",
1869:           "bg-white dark:bg-slate-800 shadow-elevated",
1870:           "border border-slate-200 dark:border-slate-700",
1871:           "py-1 origin-top-right",
1872:           dropdown_position(@position)
1873:         ]}
1874:         phx-click-away={JS.hide(to: "##{@id}-menu")}
1875:       >
1876:         <%= for {item, _idx} <- Enum.with_index(@item) do %>
1877:           <.link
1878:             :if={item[:href]}
1879:             navigate={item[:href]}
1880:             class={[
1881:               "flex items-center gap-2 px-4 py-2 text-sm transition-colors",
1882:               dropdown_item_variant(item[:variant])
1883:             ]}
1884:           >
1885:             <%= render_slot(item) %>
1886:           </.link>
1887:           <button
1888:             :if={!item[:href]}
1889:             type="button"
1890:             class={[
1891:               "flex items-center gap-2 px-4 py-2 text-sm w-full text-left transition-colors",
1892:               dropdown_item_variant(item[:variant])
1893:             ]}
1894:           >
1895:             <%= render_slot(item) %>
1896:           </button>
1897:         <% end %>
1898:         <div :for={_ <- @divider} class="my-1 border-t border-slate-200 dark:border-slate-700" />
1899:       </div>
1900:     </div>
1901:     """
1902:   end
1903: 
1904:   defp dropdown_position("bottom-right"), do: "right-0 mt-2"
1905:   defp dropdown_position("bottom-left"), do: "left-0 mt-2"
1906:   defp dropdown_position("top-right"), do: "right-0 bottom-full mb-2"
1907:   defp dropdown_position("top-left"), do: "left-0 bottom-full mb-2"
1908: 
1909:   defp dropdown_item_variant("danger"),
1910:     do: "text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20"
1911: 
1912:   defp dropdown_item_variant(_),
1913:     do: "text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700"
1914: end
````

## File: lib/hellen_web/components/layouts/app.html.heex
````
  1: <div
  2:   class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-teal-50/30 dark:from-slate-950 dark:via-slate-900 dark:to-teal-950/20 transition-colors duration-300"
  3:   phx-hook="ThemeHook"
  4:   id="theme-wrapper"
  5: >
  6:   <!-- Subtle background decoration -->
  7:   <div class="fixed inset-0 overflow-hidden pointer-events-none">
  8:     <div class="absolute -top-40 -right-40 w-96 h-96 bg-gradient-to-br from-teal-200/20 to-sage-200/20 dark:from-teal-600/5 dark:to-sage-600/5 rounded-full blur-3xl">
  9:     </div>
 10:     <div class="absolute -bottom-40 -left-40 w-96 h-96 bg-gradient-to-br from-sage-200/20 to-mint-200/20 dark:from-sage-600/5 dark:to-mint-600/5 rounded-full blur-3xl">
 11:     </div>
 12:     <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-gradient-to-br from-ochre-100/10 to-transparent dark:from-ochre-900/5 rounded-full blur-3xl">
 13:     </div>
 14:   </div>
 15:   <!-- Sidebar -->
 16:   <HellenWeb.Sidebar.sidebar
 17:     current_user={assigns[:current_user]}
 18:     current_path={assigns[:current_path] || "/"}
 19:   >
 20:     <:notification_bell>
 21:       <%= if assigns[:current_user] do %>
 22:         <.live_component
 23:           module={HellenWeb.NotificationBellLive}
 24:           id="notification-bell-desktop"
 25:           current_user={assigns[:current_user]}
 26:         />
 27:       <% end %>
 28:     </:notification_bell>
 29:   </HellenWeb.Sidebar.sidebar>
 30:   <!-- Main Content Area -->
 31:   <div class="lg:pl-64">
 32:     <!-- Top bar for mobile -->
 33:     <div class="lg:hidden h-16 bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border-b border-slate-200/50 dark:border-slate-700/50 sticky top-0 z-40 flex items-center justify-between px-4 shadow-sm">
 34:       <div class="w-10"></div>
 35:       <div class="flex items-center gap-2">
 36:         <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center shadow-sm">
 37:           <span class="text-white font-bold text-xs">H</span>
 38:         </div>
 39:         <span class="text-lg font-bold text-slate-900 dark:text-white">
 40:           Hellen
 41:         </span>
 42:         <span class="text-[10px] font-semibold px-1.5 py-0.5 rounded bg-teal-500/10 text-teal-600 dark:text-teal-400">
 43:           AI
 44:         </span>
 45:       </div>
 46:       <%= if assigns[:current_user] do %>
 47:         <.live_component
 48:           module={HellenWeb.NotificationBellLive}
 49:           id="notification-bell-mobile"
 50:           current_user={assigns[:current_user]}
 51:         />
 52:       <% else %>
 53:         <div class="w-10"></div>
 54:       <% end %>
 55:     </div>
 56: 
 57:     <main class="relative z-10 py-6 lg:py-8">
 58:       <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
 59:         <!-- Offline Indicator -->
 60:         <div
 61:           id="offline-indicator"
 62:           phx-hook="OfflineIndicator"
 63:           class="hidden mb-4 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800/50 rounded-xl p-4 flex items-center gap-3 shadow-sm"
 64:         >
 65:           <div class="flex-shrink-0 w-10 h-10 rounded-xl bg-amber-100 dark:bg-amber-900/40 flex items-center justify-center">
 66:             <svg
 67:               class="h-5 w-5 text-amber-600 dark:text-amber-400"
 68:               fill="none"
 69:               viewBox="0 0 24 24"
 70:               stroke-width="1.5"
 71:               stroke="currentColor"
 72:             >
 73:               <path
 74:                 stroke-linecap="round"
 75:                 stroke-linejoin="round"
 76:                 d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"
 77:               />
 78:             </svg>
 79:           </div>
 80:           <div class="flex-1">
 81:             <p class="text-sm font-semibold text-amber-800 dark:text-amber-200">
 82:               Voce esta offline
 83:             </p>
 84:             <p class="text-xs text-amber-600 dark:text-amber-400 mt-0.5">
 85:               Algumas funcionalidades podem estar limitadas.
 86:             </p>
 87:           </div>
 88:         </div>
 89:         <!-- Install PWA Banner -->
 90:         <div
 91:           id="install-prompt"
 92:           phx-hook="InstallPrompt"
 93:           class="hidden mb-4 bg-gradient-to-r from-teal-500 to-teal-600 rounded-xl p-4 items-center justify-between shadow-elevated"
 94:         >
 95:           <div class="flex items-center gap-3">
 96:             <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
 97:               <svg
 98:                 class="h-5 w-5 text-white"
 99:                 fill="none"
100:                 viewBox="0 0 24 24"
101:                 stroke-width="1.5"
102:                 stroke="currentColor"
103:               >
104:                 <path
105:                   stroke-linecap="round"
106:                   stroke-linejoin="round"
107:                   d="M10.5 1.5H8.25A2.25 2.25 0 006 3.75v16.5a2.25 2.25 0 002.25 2.25h7.5A2.25 2.25 0 0018 20.25V3.75a2.25 2.25 0 00-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3"
108:                 />
109:               </svg>
110:             </div>
111:             <div>
112:               <p class="text-white font-semibold">Instale o Hellen AI</p>
113:               <p class="text-white/80 text-sm">Acesso rapido direto do seu celular</p>
114:             </div>
115:           </div>
116:           <div class="flex items-center gap-2">
117:             <button
118:               onclick="this.closest('[phx-hook]').__view__.handleEvent('dismiss')"
119:               class="px-4 py-2 text-white/80 hover:text-white text-sm font-medium rounded-lg hover:bg-white/10 transition-colors"
120:             >
121:               Agora nao
122:             </button>
123:             <button
124:               onclick="this.closest('[phx-hook]').__view__.handleEvent('install')"
125:               class="px-4 py-2 bg-white text-teal-600 rounded-lg text-sm font-semibold hover:bg-white/90 transition-colors shadow-sm"
126:             >
127:               Instalar
128:             </button>
129:           </div>
130:         </div>
131: 
132:         <.flash_group flash={@flash} />
133:         <%= @inner_content %>
134:       </div>
135:     </main>
136:     <!-- Footer -->
137:     <footer class="relative z-10 py-6 border-t border-slate-200/50 dark:border-slate-800/50">
138:       <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
139:         <div class="flex flex-col sm:flex-row items-center justify-between gap-4 text-sm text-slate-500 dark:text-slate-400">
140:           <div class="flex items-center gap-2">
141:             <div class="w-5 h-5 rounded bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center">
142:               <span class="text-white font-bold text-[10px]">H</span>
143:             </div>
144:             <span class="font-medium">Hellen AI</span>
145:             <span class="text-slate-300 dark:text-slate-600">|</span>
146:             <span>2024-2025</span>
147:           </div>
148:           <div class="flex items-center gap-4">
149:             <a
150:               href="/terms"
151:               class="hover:text-teal-600 dark:hover:text-teal-400 transition-colors"
152:             >
153:               Termos
154:             </a>
155:             <a
156:               href="/privacy"
157:               class="hover:text-teal-600 dark:hover:text-teal-400 transition-colors"
158:             >
159:               Privacidade
160:             </a>
161:             <a
162:               href="/support"
163:               class="hover:text-teal-600 dark:hover:text-teal-400 transition-colors"
164:             >
165:               Suporte
166:             </a>
167:           </div>
168:         </div>
169:       </div>
170:     </footer>
171:   </div>
172:   <!-- Global Search Modal (Cmd+K) -->
173:   <div
174:     id="search-modal"
175:     phx-hook="SearchModal"
176:     class="hidden fixed inset-0 z-[100] overflow-y-auto"
177:     aria-labelledby="search-modal-title"
178:     role="dialog"
179:     aria-modal="true"
180:   >
181:     <div class="min-h-screen px-4 text-center">
182:       <!-- Overlay -->
183:       <div
184:         class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity"
185:         aria-hidden="true"
186:       >
187:       </div>
188:       <!-- Modal -->
189:       <div class="inline-block w-full max-w-xl my-16 text-left align-middle transition-all transform">
190:         <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-elevated border border-slate-200 dark:border-slate-700 overflow-hidden">
191:           <!-- Search Input -->
192:           <div class="flex items-center gap-3 px-4 border-b border-slate-200 dark:border-slate-700">
193:             <svg
194:               class="h-5 w-5 text-slate-400"
195:               fill="none"
196:               viewBox="0 0 24 24"
197:               stroke-width="2"
198:               stroke="currentColor"
199:             >
200:               <path
201:                 stroke-linecap="round"
202:                 stroke-linejoin="round"
203:                 d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"
204:               />
205:             </svg>
206:             <input
207:               id="search-input"
208:               type="text"
209:               placeholder="Buscar aulas, analises..."
210:               class="flex-1 py-4 bg-transparent border-0 focus:ring-0 text-slate-900 dark:text-white placeholder-slate-400 text-base"
211:             />
212:             <kbd class="px-2 py-1 text-xs font-medium bg-slate-100 dark:bg-slate-800 rounded border border-slate-200 dark:border-slate-700 text-slate-400">
213:               ESC
214:             </kbd>
215:           </div>
216:           <!-- Results -->
217:           <div id="search-results" class="max-h-96 overflow-y-auto p-2">
218:             <div class="px-3 py-8 text-center text-slate-400">
219:               <svg
220:                 class="h-12 w-12 mx-auto mb-3 text-slate-300 dark:text-slate-600"
221:                 fill="none"
222:                 viewBox="0 0 24 24"
223:                 stroke-width="1"
224:                 stroke="currentColor"
225:               >
226:                 <path
227:                   stroke-linecap="round"
228:                   stroke-linejoin="round"
229:                   d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"
230:                 />
231:               </svg>
232:               <p class="text-sm">Digite para buscar...</p>
233:             </div>
234:           </div>
235:         </div>
236:       </div>
237:     </div>
238:   </div>
239: </div>
````

## File: lib/hellen_web/live/lesson_live/show.ex
````elixir
  1: defmodule HellenWeb.LessonLive.Show do
  2:   @moduledoc """
  3:   Lesson details LiveView with analysis, score evolution chart, and trend indicators.
  4:   """
  5:   use HellenWeb, :live_view
  6: 
  7:   alias Hellen.Analysis
  8:   alias Hellen.Lessons
  9: 
 10:   @impl true
 11:   def mount(%{"id" => id}, _session, socket) do
 12:     user = socket.assigns.current_user
 13:     lesson = Lessons.get_lesson_with_transcription!(id, user.institution_id)
 14:     analyses = Analysis.list_analyses_by_lesson(id, user.institution_id)
 15:     latest_analysis = List.first(analyses)
 16: 
 17:     # Subscribe to real-time updates
 18:     if connected?(socket) do
 19:       Phoenix.PubSub.subscribe(Hellen.PubSub, "lesson:#{id}")
 20:     end
 21: 
 22:     {:ok,
 23:      socket
 24:      |> assign(page_title: lesson.title || "Detalhes da Aula")
 25:      |> assign(lesson: lesson)
 26:      |> assign(analyses: analyses)
 27:      |> assign(latest_analysis: latest_analysis)
 28:      |> assign(show_analysis: socket.assigns.live_action == :analysis)
 29:      |> load_analytics_async(user, lesson)}
 30:   end
 31: 
 32:   defp load_analytics_async(socket, user, lesson) do
 33:     if connected?(socket) do
 34:       start_async(socket, :load_analytics, fn ->
 35:         score_history = Analysis.get_user_score_history(user.id)
 36:         {trend, trend_change} = Analysis.get_user_trend(user.id)
 37: 
 38:         discipline_avg =
 39:           if lesson.subject && user.institution_id do
 40:             Analysis.get_discipline_average(lesson.subject, user.institution_id)
 41:           end
 42: 
 43:         bncc_coverage = Analysis.get_bncc_coverage(user.id, limit: 20)
 44: 
 45:         %{
 46:           score_history: score_history,
 47:           trend: trend,
 48:           trend_change: trend_change,
 49:           discipline_avg: discipline_avg,
 50:           bncc_coverage: bncc_coverage
 51:         }
 52:       end)
 53:     else
 54:       socket
 55:       |> assign(score_history: [])
 56:       |> assign(trend: :stable)
 57:       |> assign(trend_change: 0.0)
 58:       |> assign(discipline_avg: nil)
 59:       |> assign(bncc_coverage: [])
 60:     end
 61:   end
 62: 
 63:   @impl true
 64:   def handle_async(:load_analytics, {:ok, analytics}, socket) do
 65:     {:noreply,
 66:      socket
 67:      |> assign(score_history: analytics.score_history)
 68:      |> assign(trend: analytics.trend)
 69:      |> assign(trend_change: analytics.trend_change)
 70:      |> assign(discipline_avg: analytics.discipline_avg)
 71:      |> assign(bncc_coverage: analytics.bncc_coverage)}
 72:   end
 73: 
 74:   def handle_async(:load_analytics, {:exit, _reason}, socket) do
 75:     {:noreply,
 76:      socket
 77:      |> assign(score_history: [])
 78:      |> assign(trend: :stable)
 79:      |> assign(trend_change: 0.0)
 80:      |> assign(discipline_avg: nil)
 81:      |> assign(bncc_coverage: [])}
 82:   end
 83: 
 84:   @impl true
 85:   def handle_params(%{"id" => _id}, _uri, socket) do
 86:     {:noreply, assign(socket, show_analysis: socket.assigns.live_action == :analysis)}
 87:   end
 88: 
 89:   @impl true
 90:   def handle_info({"transcription_progress", %{progress: progress}}, socket) do
 91:     {:noreply, assign(socket, transcription_progress: progress)}
 92:   end
 93: 
 94:   @impl true
 95:   def handle_info({"transcription_complete", _payload}, socket) do
 96:     lesson = Lessons.get_lesson_with_transcription!(socket.assigns.lesson.id)
 97:     {:noreply, assign(socket, lesson: lesson, transcription_progress: 100)}
 98:   end
 99: 
100:   @impl true
101:   def handle_info({"analysis_progress", %{progress: progress}}, socket) do
102:     {:noreply, assign(socket, analysis_progress: progress)}
103:   end
104: 
105:   @impl true
106:   def handle_info({"analysis_complete", %{analysis: analysis}}, socket) do
107:     lesson = %{socket.assigns.lesson | status: "completed"}
108:     analyses = [analysis | socket.assigns.analyses]
109: 
110:     {:noreply,
111:      socket
112:      |> assign(lesson: lesson, analyses: analyses, latest_analysis: analysis)
113:      |> put_flash(:info, "Análise concluída!")}
114:   end
115: 
116:   @impl true
117:   def handle_info({"status_update", %{status: status}}, socket) do
118:     lesson = %{socket.assigns.lesson | status: status}
119:     {:noreply, assign(socket, lesson: lesson)}
120:   end
121: 
122:   @impl true
123:   def handle_info({"transcription_failed", %{error: error}}, socket) do
124:     lesson = %{socket.assigns.lesson | status: "failed"}
125: 
126:     {:noreply,
127:      socket
128:      |> assign(lesson: lesson)
129:      |> put_flash(:error, "Transcrição falhou: #{error}")}
130:   end
131: 
132:   @impl true
133:   def handle_info({"analysis_failed", %{error: error}}, socket) do
134:     lesson = %{socket.assigns.lesson | status: "failed"}
135: 
136:     {:noreply,
137:      socket
138:      |> assign(lesson: lesson)
139:      |> put_flash(:error, "Análise falhou: #{error}")}
140:   end
141: 
142:   @impl true
143:   def handle_info(_msg, socket) do
144:     {:noreply, socket}
145:   end
146: 
147:   @impl true
148:   def handle_event("start_processing", _params, socket) do
149:     lesson = socket.assigns.lesson
150:     user = socket.assigns.current_user
151: 
152:     case Lessons.start_processing(lesson, user) do
153:       {:ok, updated_lesson} ->
154:         {:noreply,
155:          socket
156:          |> assign(lesson: updated_lesson)
157:          |> put_flash(:info, "Processamento iniciado!")}
158: 
159:       {:error, :insufficient_credits} ->
160:         {:noreply, put_flash(socket, :error, "Créditos insuficientes")}
161: 
162:       {:error, reason} ->
163:         {:noreply, put_flash(socket, :error, "Erro ao iniciar: #{inspect(reason)}")}
164:     end
165:   end
166: 
167:   @impl true
168:   def render(assigns) do
169:     ~H"""
170:     <div class="space-y-8 animate-fade-in">
171:       <!-- Header -->
172:       <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
173:         <div>
174:           <.link
175:             navigate={~p"/aulas"}
176:             class="text-sm text-slate-500 dark:text-slate-400 hover:text-teal-600 dark:hover:text-teal-400 flex items-center mb-3 transition-colors"
177:           >
178:             <.icon name="hero-arrow-left-mini" class="h-4 w-4 mr-1" /> Voltar para Minhas Aulas
179:           </.link>
180:           <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-white tracking-tight">
181:             <%= @lesson.title || "Aula sem titulo" %>
182:           </h1>
183:           <p class="mt-2 text-sm text-slate-500 dark:text-slate-400 flex items-center gap-3">
184:             <span class="flex items-center gap-1.5">
185:               <.icon name="hero-academic-cap" class="h-4 w-4" />
186:               <%= @lesson.subject || "Disciplina nao informada" %>
187:             </span>
188:             <span class="flex items-center gap-1.5">
189:               <.icon name="hero-calendar" class="h-4 w-4" />
190:               <%= format_datetime(@lesson.inserted_at) %>
191:             </span>
192:           </p>
193:         </div>
194:         <div class="flex items-center gap-3">
195:           <!-- Trend Indicator -->
196:           <.trend_indicator
197:             :if={assigns[:trend] && @lesson.status == "completed"}
198:             trend={@trend}
199:             change={@trend_change}
200:           />
201:           <.badge variant={status_variant(@lesson.status)} class="text-sm px-3 py-1.5">
202:             <%= status_label(@lesson.status) %>
203:           </.badge>
204:         </div>
205:       </div>
206:       <!-- Pending State -->
207:       <div :if={@lesson.status == "pending"} class="animate-fade-in-up">
208:         <.card>
209:           <div class="py-8 text-center">
210:             <div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-teal-100 dark:bg-teal-900/30 mb-4">
211:               <.icon name="hero-play-circle" class="h-10 w-10 text-teal-600 dark:text-teal-400" />
212:             </div>
213:             <h3 class="text-xl font-semibold text-slate-900 dark:text-white">
214:               Pronto para processar
215:             </h3>
216:             <p class="mt-2 text-sm text-slate-500 dark:text-slate-400 max-w-md mx-auto">
217:               Clique no botao abaixo para iniciar a transcricao e analise pedagogica da aula.
218:             </p>
219:             <div class="mt-6">
220:               <.button phx-click="start_processing" icon="hero-play">
221:                 Iniciar Processamento
222:               </.button>
223:             </div>
224:           </div>
225:         </.card>
226:       </div>
227:       <!-- Processing State -->
228:       <div :if={@lesson.status in ["transcribing", "analyzing"]} class="animate-fade-in-up">
229:         <.card>
230:           <div class="py-8 text-center">
231:             <div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-cyan-100 dark:bg-cyan-900/30 mb-4">
232:               <.icon
233:                 name="hero-arrow-path"
234:                 class="h-10 w-10 text-cyan-600 dark:text-cyan-400 animate-spin"
235:               />
236:             </div>
237:             <h3 class="text-xl font-semibold text-slate-900 dark:text-white">
238:               <%= if @lesson.status == "transcribing", do: "Transcrevendo...", else: "Analisando..." %>
239:             </h3>
240:             <p class="mt-2 text-sm text-slate-500 dark:text-slate-400 max-w-md mx-auto">
241:               <%= if @lesson.status == "transcribing",
242:                 do: "Convertendo audio em texto usando IA",
243:                 else: "Gerando feedback pedagogico baseado na BNCC" %>
244:             </p>
245:             <div class="mt-6 max-w-md mx-auto">
246:               <.progress
247:                 value={assigns[:transcription_progress] || assigns[:analysis_progress] || 0}
248:                 color="teal"
249:               />
250:             </div>
251:           </div>
252:         </.card>
253:       </div>
254:       <!-- Failed State -->
255:       <div :if={@lesson.status == "failed"} class="animate-fade-in-up">
256:         <.alert variant="error" title="Erro no processamento">
257:           Ocorreu um erro ao processar esta aula. O credito foi reembolsado automaticamente.
258:           Voce pode tentar novamente.
259:         </.alert>
260:       </div>
261:       <!-- Completed State - Main Content -->
262:       <div :if={@lesson.status in ["transcribed", "completed"]} class="space-y-8">
263:         <!-- Score Evolution Chart -->
264:         <.card :if={assigns[:score_history] && length(@score_history) > 1} class="animate-fade-in-up">
265:           <:header>
266:             <div class="flex items-center justify-between">
267:               <div>
268:                 <h2 class="text-lg font-semibold text-slate-900 dark:text-white">
269:                   Evolucao do Score
270:                 </h2>
271:                 <p class="text-sm text-slate-500 dark:text-slate-400">
272:                   Historico de pontuacoes das suas aulas
273:                 </p>
274:               </div>
275:               <.trend_badge :if={assigns[:trend]} trend={@trend} change={@trend_change} />
276:             </div>
277:           </:header>
278:           <div
279:             id="score-chart"
280:             phx-hook="ScoreChart"
281:             phx-update="ignore"
282:             data-chart-data={Jason.encode!(@score_history)}
283:             data-average={@discipline_avg || 0}
284:             class="min-h-[300px]"
285:           >
286:           </div>
287:           <div
288:             :if={@discipline_avg}
289:             class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700 flex items-center justify-center gap-6 text-sm"
290:           >
291:             <div class="flex items-center gap-2">
292:               <div class="w-3 h-3 rounded-full bg-teal-500"></div>
293:               <span class="text-slate-600 dark:text-slate-400">Suas Aulas</span>
294:             </div>
295:             <div class="flex items-center gap-2">
296:               <div class="w-3 h-0.5 bg-ochre-500"></div>
297:               <span class="text-slate-600 dark:text-slate-400">
298:                 Media da Disciplina: <%= round((@discipline_avg || 0) * 100) %>%
299:               </span>
300:             </div>
301:           </div>
302:         </.card>
303:         <!-- Transcription & Analysis Grid -->
304:         <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
305:           <!-- Transcription -->
306:           <.card class="animate-fade-in-up">
307:             <:header>
308:               <div class="flex items-center justify-between">
309:                 <div class="flex items-center gap-2">
310:                   <.icon name="hero-document-text" class="h-5 w-5 text-teal-600 dark:text-teal-400" />
311:                   <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Transcricao</h2>
312:                 </div>
313:                 <.badge variant="completed">Concluida</.badge>
314:               </div>
315:             </:header>
316:             <div
317:               :if={@lesson.transcription}
318:               class="prose prose-sm dark:prose-invert max-w-none max-h-96 overflow-y-auto scrollbar-thin scrollbar-thumb-slate-300 dark:scrollbar-thumb-slate-600"
319:             >
320:               <p class="whitespace-pre-wrap text-slate-700 dark:text-slate-300 leading-relaxed">
321:                 <%= @lesson.transcription.full_text %>
322:               </p>
323:             </div>
324:             <div :if={!@lesson.transcription} class="text-center py-8">
325:               <.icon
326:                 name="hero-document-text"
327:                 class="mx-auto h-12 w-12 text-slate-300 dark:text-slate-600"
328:               />
329:               <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">
330:                 Transcricao nao disponivel
331:               </p>
332:             </div>
333:           </.card>
334:           <!-- Analysis -->
335:           <.card class="animate-fade-in-up" style="animation-delay: 100ms">
336:             <:header>
337:               <div class="flex items-center justify-between">
338:                 <div class="flex items-center gap-2">
339:                   <.icon name="hero-chart-bar" class="h-5 w-5 text-sage-600 dark:text-sage-400" />
340:                   <h2 class="text-lg font-semibold text-slate-900 dark:text-white">
341:                     Analise Pedagogica
342:                   </h2>
343:                 </div>
344:                 <.badge :if={@latest_analysis} variant="completed">Concluida</.badge>
345:                 <.badge :if={!@latest_analysis && @lesson.status == "completed"} variant="pending">
346:                   Pendente
347:                 </.badge>
348:               </div>
349:             </:header>
350: 
351:             <div :if={@latest_analysis} class="space-y-5">
352:               <div :if={@latest_analysis.overall_score} class="flex items-center justify-center py-2">
353:                 <.score_display
354:                   score={round(@latest_analysis.overall_score * 100)}
355:                   label="Pontuacao Geral"
356:                 />
357:               </div>
358: 
359:               <div :if={@latest_analysis.result} class="space-y-4">
360:                 <.analysis_section
361:                   :if={@latest_analysis.result["feedback"]}
362:                   title="Feedback"
363:                   icon="hero-chat-bubble-left-right"
364:                   variant="info"
365:                 >
366:                   <%= @latest_analysis.result["feedback"] %>
367:                 </.analysis_section>
368: 
369:                 <.analysis_section
370:                   :if={@latest_analysis.result["strengths"]}
371:                   title="Pontos Fortes"
372:                   icon="hero-check-circle"
373:                   variant="success"
374:                 >
375:                   <ul class="list-disc list-inside space-y-1">
376:                     <li
377:                       :for={strength <- @latest_analysis.result["strengths"]}
378:                       class="text-sm text-slate-700 dark:text-slate-300"
379:                     >
380:                       <%= strength %>
381:                     </li>
382:                   </ul>
383:                 </.analysis_section>
384: 
385:                 <.analysis_section
386:                   :if={@latest_analysis.result["improvements"]}
387:                   title="Sugestoes de Melhoria"
388:                   icon="hero-light-bulb"
389:                   variant="warning"
390:                 >
391:                   <ul class="list-disc list-inside space-y-1">
392:                     <li
393:                       :for={improvement <- @latest_analysis.result["improvements"]}
394:                       class="text-sm text-slate-700 dark:text-slate-300"
395:                     >
396:                       <%= improvement %>
397:                     </li>
398:                   </ul>
399:                 </.analysis_section>
400:               </div>
401:             </div>
402: 
403:             <div :if={!@latest_analysis} class="text-center py-8">
404:               <.icon
405:                 name="hero-document-magnifying-glass"
406:                 class="mx-auto h-12 w-12 text-slate-300 dark:text-slate-600"
407:               />
408:               <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">Analise nao disponivel</p>
409:             </div>
410:           </.card>
411:         </div>
412:         <!-- BNCC Coverage -->
413:         <.card
414:           :if={assigns[:bncc_coverage] && length(@bncc_coverage) > 0}
415:           class="animate-fade-in-up"
416:           style="animation-delay: 200ms"
417:         >
418:           <:header>
419:             <div class="flex items-center gap-2">
420:               <.icon name="hero-academic-cap" class="h-5 w-5 text-violet-600 dark:text-violet-400" />
421:               <div>
422:                 <h2 class="text-lg font-semibold text-slate-900 dark:text-white">
423:                   Competencias BNCC Trabalhadas
424:                 </h2>
425:                 <p class="text-sm text-slate-500 dark:text-slate-400">
426:                   Frequencia das competencias identificadas em suas aulas
427:                 </p>
428:               </div>
429:             </div>
430:           </:header>
431:           <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
432:             <div
433:               :for={comp <- @bncc_coverage}
434:               class="p-4 rounded-xl bg-slate-50 dark:bg-slate-800/50 border border-slate-200/50 dark:border-slate-700/50 hover:border-teal-300/50 dark:hover:border-teal-600/50 transition-all duration-200"
435:             >
436:               <div class="flex items-center justify-between mb-2">
437:                 <span class="text-xs font-mono font-medium text-teal-600 dark:text-teal-400 bg-teal-50 dark:bg-teal-900/30 px-2 py-0.5 rounded">
438:                   <%= comp.code %>
439:                 </span>
440:                 <span class="text-xs text-slate-500 dark:text-slate-400 font-medium">
441:                   <%= comp.count %>x
442:                 </span>
443:               </div>
444:               <p class="text-sm text-slate-700 dark:text-slate-300 line-clamp-2">
445:                 <%= comp.name || "Competencia BNCC" %>
446:               </p>
447:               <div class="mt-3 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
448:                 <div
449:                   class="h-full bg-gradient-to-r from-teal-500 to-sage-500 rounded-full transition-all duration-500"
450:                   style={"width: #{round((comp.avg_score || 0) * 100)}%"}
451:                 >
452:                 </div>
453:               </div>
454:             </div>
455:           </div>
456:         </.card>
457:       </div>
458:     </div>
459:     """
460:   end
461: 
462:   # Trend indicator component
463:   defp trend_indicator(assigns) do
464:     ~H"""
465:     <div class={[
466:       "flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium transition-colors",
467:       @trend == :improving &&
468:         "bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400",
469:       @trend == :declining && "bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400",
470:       @trend == :stable && "bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400"
471:     ]}>
472:       <.icon
473:         :if={@trend == :improving}
474:         name="hero-arrow-trending-up"
475:         class="h-4 w-4 text-emerald-600 dark:text-emerald-400"
476:       />
477:       <.icon
478:         :if={@trend == :declining}
479:         name="hero-arrow-trending-down"
480:         class="h-4 w-4 text-red-600 dark:text-red-400"
481:       />
482:       <.icon
483:         :if={@trend == :stable}
484:         name="hero-minus"
485:         class="h-4 w-4 text-slate-500 dark:text-slate-400"
486:       />
487:       <span :if={abs(@change) > 0}>
488:         <%= if @change > 0, do: "+", else: "" %><%= Float.round(@change, 1) %>%
489:       </span>
490:     </div>
491:     """
492:   end
493: 
494:   # Trend badge for chart header
495:   defp trend_badge(assigns) do
496:     ~H"""
497:     <div class={[
498:       "flex items-center gap-1.5 px-3 py-1.5 rounded-xl text-sm font-medium transition-colors",
499:       @trend == :improving &&
500:         "bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400",
501:       @trend == :declining && "bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400",
502:       @trend == :stable && "bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400"
503:     ]}>
504:       <.icon
505:         :if={@trend == :improving}
506:         name="hero-arrow-trending-up"
507:         class="h-5 w-5 text-emerald-600 dark:text-emerald-400"
508:       />
509:       <.icon
510:         :if={@trend == :declining}
511:         name="hero-arrow-trending-down"
512:         class="h-5 w-5 text-red-600 dark:text-red-400"
513:       />
514:       <.icon
515:         :if={@trend == :stable}
516:         name="hero-minus"
517:         class="h-5 w-5 text-slate-500 dark:text-slate-400"
518:       />
519:       <span>
520:         <%= case @trend do
521:           :improving -> "Melhorando"
522:           :declining -> "Em queda"
523:           :stable -> "Estavel"
524:         end %>
525:       </span>
526:     </div>
527:     """
528:   end
529: end
````

## File: assets/js/app.js
````javascript
 1: // Phoenix LiveView JavaScript
 2: import "phoenix_html"
 3: import {Socket} from "phoenix"
 4: import {LiveSocket} from "phoenix_live_view"
 5: import topbar from "../vendor/topbar"
 6: 
 7: // LiveView Hooks
 8: let Hooks = {}
 9: 
10: // Landing page hooks
11: import { ScrollAnimation, ThemeHook, ThemeToggle } from "./hooks/scroll_animation"
12: Hooks.ScrollAnimation = ScrollAnimation
13: Hooks.ThemeHook = ThemeHook
14: Hooks.ThemeToggle = ThemeToggle
15: 
16: // Sidebar and Search hooks
17: import { SidebarHook, SearchModal } from "./hooks/sidebar"
18: Hooks.SidebarHook = SidebarHook
19: Hooks.SearchModal = SearchModal
20: 
21: // Chart hooks
22: import { ScoreChart, BnccHeatmap, AlertsChart, CoordinatorBarChart, AnalyticsChart, ScoreGauge, BillingUsageChart } from "./hooks/charts"
23: Hooks.ScoreChart = ScoreChart
24: Hooks.BnccHeatmap = BnccHeatmap
25: Hooks.AlertsChart = AlertsChart
26: Hooks.CoordinatorBarChart = CoordinatorBarChart
27: Hooks.AnalyticsChart = AnalyticsChart
28: Hooks.ScoreGauge = ScoreGauge
29: Hooks.BillingUsageChart = BillingUsageChart
30: 
31: // PWA hooks
32: import { registerServiceWorker, InstallPrompt, OfflineIndicator, UpdateAvailable } from "./hooks/pwa"
33: Hooks.InstallPrompt = InstallPrompt
34: Hooks.OfflineIndicator = OfflineIndicator
35: Hooks.UpdateAvailable = UpdateAvailable
36: registerServiceWorker()
37: 
38: // Firebase Authentication hooks
39: import { GoogleSignIn } from "./hooks/firebase"
40: Hooks.GoogleSignIn = GoogleSignIn
41: 
42: // UI Enhancement hooks
43: import { AnimatedCounter, DropZone, Ripple } from "./hooks/ui_enhancements"
44: Hooks.AnimatedCounter = AnimatedCounter
45: Hooks.DropZone = DropZone
46: Hooks.Ripple = Ripple
47: 
48: let csrfToken = document.querySelector("meta[name='csrf-token']")?.getAttribute("content")
49: let liveSocket = new LiveSocket("/live", Socket, {
50:   hooks: Hooks,
51:   params: {_csrf_token: csrfToken}
52: })
53: 
54: // Configure topbar with 2025 teal color
55: topbar.config({barColors: {0: "#0d9488"}, shadowColor: "rgba(0, 0, 0, .3)"})
56: window.addEventListener("phx:page-loading-start", _info => topbar.show(300))
57: window.addEventListener("phx:page-loading-stop", _info => topbar.hide())
58: 
59: // Connect if there are any LiveViews on the page
60: liveSocket.connect()
61: 
62: // Expose liveSocket on window for debugging
63: window.liveSocket = liveSocket
````

## File: lib/hellen_web/live/dashboard_live/index.ex
````elixir
  1: defmodule HellenWeb.DashboardLive.Index do
  2:   @moduledoc """
  3:   Dashboard LiveView - 2025 Modern Design
  4:   Clean, impactful layout with visual hierarchy.
  5:   """
  6:   use HellenWeb, :live_view
  7: 
  8:   alias Hellen.Lessons
  9: 
 10:   @impl true
 11:   def mount(_params, _session, socket) do
 12:     user = socket.assigns.current_user
 13: 
 14:     {:ok,
 15:      socket
 16:      |> assign(page_title: "Dashboard")
 17:      |> assign(greeting: get_greeting())
 18:      |> assign(loading: true)
 19:      |> stream(:recent_lessons, [])
 20:      |> assign_async(:stats, fn -> load_stats(user.id) end)
 21:      |> load_lessons_async(user.id)}
 22:   end
 23: 
 24:   defp load_lessons_async(socket, user_id) do
 25:     if connected?(socket) do
 26:       start_async(socket, :load_lessons, fn ->
 27:         Lessons.list_lessons_by_user(user_id, limit: 5)
 28:       end)
 29:     else
 30:       socket
 31:     end
 32:   end
 33: 
 34:   # PWA OfflineIndicator hook events - ignore silently
 35:   @impl true
 36:   def handle_event("online", _params, socket), do: {:noreply, socket}
 37:   def handle_event("offline", _params, socket), do: {:noreply, socket}
 38: 
 39:   @impl true
 40:   def handle_async(:load_lessons, {:ok, lessons}, socket) do
 41:     {:noreply,
 42:      socket
 43:      |> assign(loading: false)
 44:      |> stream(:recent_lessons, lessons, reset: true)}
 45:   end
 46: 
 47:   def handle_async(:load_lessons, {:exit, _reason}, socket) do
 48:     {:noreply,
 49:      socket
 50:      |> assign(loading: false)
 51:      |> put_flash(:error, "Erro ao carregar aulas")}
 52:   end
 53: 
 54:   defp load_stats(user_id) do
 55:     lessons = Lessons.list_lessons_by_user(user_id)
 56: 
 57:     stats = %{
 58:       total: length(lessons),
 59:       completed: Enum.count(lessons, &(&1.status == "completed")),
 60:       processing:
 61:         Enum.count(lessons, &(&1.status in ["transcribing", "analyzing", "transcribed"])),
 62:       pending: Enum.count(lessons, &(&1.status == "pending"))
 63:     }
 64: 
 65:     # assign_async(:stats, fn) expects {:ok, %{stats: value}}
 66:     # where :stats matches the assign name, and value will be accessible via @stats.result
 67:     {:ok, %{stats: stats}}
 68:   end
 69: 
 70:   defp get_greeting do
 71:     hour = DateTime.utc_now() |> DateTime.to_time() |> Map.get(:hour)
 72: 
 73:     cond do
 74:       hour >= 5 and hour < 12 -> "Bom dia"
 75:       hour >= 12 and hour < 18 -> "Boa tarde"
 76:       true -> "Boa noite"
 77:     end
 78:   end
 79: 
 80:   @impl true
 81:   def render(assigns) do
 82:     ~H"""
 83:     <div class="space-y-6 lg:space-y-8">
 84:       <!-- Hero Section with CTA -->
 85:       <div class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-teal-600 via-teal-500 to-emerald-500 p-6 sm:p-8 lg:p-10">
 86:         <!-- Background Pattern -->
 87:         <div class="absolute inset-0 opacity-10">
 88:           <svg class="h-full w-full" viewBox="0 0 100 100" preserveAspectRatio="none">
 89:             <defs>
 90:               <pattern
 91:                 id="hero-pattern"
 92:                 x="0"
 93:                 y="0"
 94:                 width="20"
 95:                 height="20"
 96:                 patternUnits="userSpaceOnUse"
 97:               >
 98:                 <circle cx="2" cy="2" r="1" fill="white" />
 99:               </pattern>
100:             </defs>
101:             <rect fill="url(#hero-pattern)" width="100" height="100" />
102:           </svg>
103:         </div>
104: 
105:         <div class="relative flex flex-col lg:flex-row items-start lg:items-center justify-between gap-6">
106:           <div class="flex-1">
107:             <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/20 backdrop-blur-sm mb-4">
108:               <span class="relative flex h-2 w-2">
109:                 <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-75">
110:                 </span>
111:                 <span class="relative inline-flex rounded-full h-2 w-2 bg-white"></span>
112:               </span>
113:               <span class="text-sm font-medium text-white/90">Hellen AI</span>
114:             </div>
115:             <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-white mb-2">
116:               <%= @greeting %>, <%= @current_user.name || "Professor" %>!
117:             </h1>
118:             <p class="text-white/80 text-base sm:text-lg max-w-xl">
119:               Transforme suas aulas em insights pedagogicos com inteligencia artificial.
120:             </p>
121:           </div>
122: 
123:           <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
124:             <.link navigate={~p"/lessons/new"} class="flex-1 lg:flex-none">
125:               <button class="w-full lg:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 rounded-xl bg-white text-teal-600 font-semibold shadow-lg hover:shadow-xl hover:bg-slate-50 transition-all duration-200">
126:                 <.icon name="hero-plus" class="h-5 w-5" /> Nova Aula
127:               </button>
128:             </.link>
129:             <.link navigate={~p"/aulas"} class="flex-1 lg:flex-none">
130:               <button class="w-full lg:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 rounded-xl bg-white/10 backdrop-blur-sm text-white font-medium border border-white/20 hover:bg-white/20 transition-all duration-200">
131:                 <.icon name="hero-folder" class="h-5 w-5" /> Ver Aulas
132:               </button>
133:             </.link>
134:           </div>
135:         </div>
136:         <!-- Floating decoration -->
137:         <div class="absolute -bottom-8 -right-8 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
138:         <div class="absolute -top-8 -left-8 w-24 h-24 bg-emerald-400/20 rounded-full blur-2xl"></div>
139:       </div>
140:       <!-- Stats Grid -->
141:       <.async_result :let={data} assign={@stats}>
142:         <:loading>
143:           <div class="grid gap-4 grid-cols-2 lg:grid-cols-4">
144:             <.stat_skeleton :for={_ <- 1..4} />
145:           </div>
146:         </:loading>
147:         <:failed>
148:           <.alert variant="error">Erro ao carregar estatisticas</.alert>
149:         </:failed>
150: 
151:         <div class="grid gap-4 grid-cols-2 lg:grid-cols-4">
152:           <.modern_stat_card
153:             value={data.stats.total}
154:             label="Total de Aulas"
155:             icon="hero-academic-cap"
156:             color="teal"
157:           />
158:           <.modern_stat_card
159:             value={data.stats.completed}
160:             label="Concluidas"
161:             icon="hero-check-circle"
162:             color="emerald"
163:           />
164:           <.modern_stat_card
165:             value={data.stats.processing}
166:             label="Processando"
167:             icon="hero-arrow-path"
168:             color="cyan"
169:             animate={data.stats.processing > 0}
170:           />
171:           <.modern_stat_card
172:             value={data.stats.pending}
173:             label="Pendentes"
174:             icon="hero-clock"
175:             color="amber"
176:           />
177:         </div>
178:       </.async_result>
179:       <!-- Main Content Grid -->
180:       <div class="grid gap-6 lg:grid-cols-3">
181:         <!-- Recent Lessons (2 cols) -->
182:         <div class="lg:col-span-2 space-y-4">
183:           <div class="flex items-center justify-between">
184:             <h2 class="text-lg font-semibold text-slate-900 dark:text-white flex items-center gap-2">
185:               <.icon name="hero-clock" class="h-5 w-5 text-slate-400" /> Aulas Recentes
186:             </h2>
187:             <.link
188:               navigate={~p"/aulas"}
189:               class="text-sm font-medium text-teal-600 dark:text-teal-400 hover:text-teal-700 dark:hover:text-teal-300 transition-colors flex items-center gap-1 group"
190:             >
191:               Ver todas
192:               <.icon
193:                 name="hero-arrow-right-mini"
194:                 class="h-4 w-4 group-hover:translate-x-0.5 transition-transform"
195:               />
196:             </.link>
197:           </div>
198: 
199:           <div class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 overflow-hidden">
200:             <div id="recent-lessons-container" phx-update="stream">
201:               <div
202:                 :for={{dom_id, lesson} <- @streams.recent_lessons}
203:                 id={dom_id}
204:                 class="p-4 border-b border-slate-100 dark:border-slate-700/50 last:border-0 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors"
205:               >
206:                 <.lesson_row lesson={lesson} />
207:               </div>
208:             </div>
209:             <!-- Empty State -->
210:             <div
211:               :if={match?(%{ok?: true, result: %{stats: %{total: 0}}}, @stats)}
212:               class="p-8 sm:p-12 text-center"
213:             >
214:               <div class="mx-auto w-16 h-16 rounded-2xl bg-gradient-to-br from-teal-100 to-emerald-100 dark:from-teal-900/30 dark:to-emerald-900/30 flex items-center justify-center mb-4">
215:                 <.icon name="hero-document-plus" class="h-8 w-8 text-teal-600 dark:text-teal-400" />
216:               </div>
217:               <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-2">
218:                 Comece sua jornada!
219:               </h3>
220:               <p class="text-slate-500 dark:text-slate-400 mb-6 max-w-sm mx-auto">
221:                 Envie sua primeira aula para receber analise pedagogica com IA em minutos.
222:               </p>
223:               <.link navigate={~p"/lessons/new"}>
224:                 <button class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl bg-teal-600 text-white font-medium hover:bg-teal-700 transition-colors">
225:                   <.icon name="hero-plus" class="h-5 w-5" /> Enviar Primeira Aula
226:                 </button>
227:               </.link>
228:             </div>
229:           </div>
230:         </div>
231:         <!-- Sidebar (1 col) -->
232:         <div class="space-y-4">
233:           <!-- Credits Card -->
234:           <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-5 text-white">
235:             <div class="flex items-center gap-4 mb-4">
236:               <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-teal-400 to-emerald-500 flex items-center justify-center shadow-lg">
237:                 <.icon name="hero-bolt" class="h-6 w-6 text-white" />
238:               </div>
239:               <div>
240:                 <p class="text-slate-400 text-sm">Creditos</p>
241:                 <p
242:                   class="text-3xl font-bold"
243:                   phx-hook="AnimatedCounter"
244:                   id="credits-counter"
245:                   data-target={@current_user.credits || 0}
246:                 >
247:                   <span class="counter-value"><%= @current_user.credits || 0 %></span>
248:                 </p>
249:               </div>
250:             </div>
251:             <.link navigate={~p"/billing"} class="block">
252:               <button class="w-full py-2.5 rounded-xl bg-white/10 hover:bg-white/20 text-white font-medium transition-colors flex items-center justify-center gap-2">
253:                 <.icon name="hero-plus" class="h-4 w-4" /> Comprar Creditos
254:               </button>
255:             </.link>
256:           </div>
257:           <!-- Quick Tips -->
258:           <div class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-5">
259:             <h3 class="font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
260:               <.icon name="hero-light-bulb" class="h-5 w-5 text-amber-500" /> Dica do dia
261:             </h3>
262:             <div class="space-y-3">
263:               <p class="text-sm text-slate-600 dark:text-slate-300">
264:                 Grave aulas de
265:                 <span class="font-medium text-teal-600 dark:text-teal-400">15-30 minutos</span>
266:                 para obter analises mais precisas da IA.
267:               </p>
268:               <div class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
269:                 <.icon name="hero-clock" class="h-4 w-4" /> Duracao ideal para melhor qualidade
270:               </div>
271:             </div>
272:           </div>
273:           <!-- BNCC Info -->
274:           <div class="bg-gradient-to-br from-violet-50 to-purple-50 dark:from-violet-900/20 dark:to-purple-900/20 rounded-2xl border border-violet-200/50 dark:border-violet-800/50 p-5">
275:             <div class="flex items-start gap-3">
276:               <div class="w-10 h-10 rounded-xl bg-violet-100 dark:bg-violet-900/50 flex items-center justify-center flex-shrink-0">
277:                 <.icon
278:                   name="hero-document-check"
279:                   class="h-5 w-5 text-violet-600 dark:text-violet-400"
280:                 />
281:               </div>
282:               <div>
283:                 <h4 class="font-semibold text-slate-900 dark:text-white text-sm">
284:                   Alinhado a BNCC
285:                 </h4>
286:                 <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">
287:                   Analise automatica de competencias e habilidades da Base Nacional Comum Curricular.
288:                 </p>
289:               </div>
290:             </div>
291:           </div>
292:         </div>
293:       </div>
294:     </div>
295:     """
296:   end
297: 
298:   defp modern_stat_card(assigns) do
299:     assigns = assign_new(assigns, :animate, fn -> false end)
300: 
301:     ~H"""
302:     <div class="bg-white dark:bg-slate-800 rounded-xl p-4 sm:p-5 border border-slate-200/50 dark:border-slate-700/50 hover:shadow-lg hover:border-slate-300 dark:hover:border-slate-600 transition-all duration-300 group">
303:       <div class="flex items-center justify-between mb-3">
304:         <div class={[
305:           "w-10 h-10 rounded-xl flex items-center justify-center transition-transform duration-300 group-hover:scale-110",
306:           stat_bg(@color),
307:           @animate && "animate-pulse"
308:         ]}>
309:           <.icon name={@icon} class={"h-5 w-5 #{stat_text(@color)}"} />
310:         </div>
311:         <div :if={@animate} class="flex items-center gap-1.5">
312:           <span class="relative flex h-2 w-2">
313:             <span class={"animate-ping absolute inline-flex h-full w-full rounded-full #{stat_dot(@color)} opacity-75"}>
314:             </span>
315:             <span class={"relative inline-flex rounded-full h-2 w-2 #{stat_dot(@color)}"}></span>
316:           </span>
317:           <span class="text-xs font-medium text-slate-500 dark:text-slate-400">Ativo</span>
318:         </div>
319:       </div>
320:       <p class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-white tracking-tight">
321:         <%= @value %>
322:       </p>
323:       <p class="text-xs sm:text-sm text-slate-500 dark:text-slate-400 mt-1">
324:         <%= @label %>
325:       </p>
326:     </div>
327:     """
328:   end
329: 
330:   defp stat_bg("teal"), do: "bg-teal-100 dark:bg-teal-900/30"
331:   defp stat_bg("emerald"), do: "bg-emerald-100 dark:bg-emerald-900/30"
332:   defp stat_bg("cyan"), do: "bg-cyan-100 dark:bg-cyan-900/30"
333:   defp stat_bg("amber"), do: "bg-amber-100 dark:bg-amber-900/30"
334:   defp stat_bg(_), do: "bg-slate-100 dark:bg-slate-700"
335: 
336:   defp stat_text("teal"), do: "text-teal-600 dark:text-teal-400"
337:   defp stat_text("emerald"), do: "text-emerald-600 dark:text-emerald-400"
338:   defp stat_text("cyan"), do: "text-cyan-600 dark:text-cyan-400"
339:   defp stat_text("amber"), do: "text-amber-600 dark:text-amber-400"
340:   defp stat_text(_), do: "text-slate-600 dark:text-slate-400"
341: 
342:   defp stat_dot("teal"), do: "bg-teal-500"
343:   defp stat_dot("emerald"), do: "bg-emerald-500"
344:   defp stat_dot("cyan"), do: "bg-cyan-500"
345:   defp stat_dot("amber"), do: "bg-amber-500"
346:   defp stat_dot(_), do: "bg-slate-500"
347: 
348:   defp lesson_row(assigns) do
349:     ~H"""
350:     <.link navigate={~p"/lessons/#{@lesson.id}"} class="flex items-center gap-4 group">
351:       <div class={[
352:         "w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0",
353:         lesson_status_bg(@lesson.status)
354:       ]}>
355:         <.icon
356:           name={lesson_status_icon(@lesson.status)}
357:           class={"h-5 w-5 #{lesson_status_color(@lesson.status)}"}
358:         />
359:       </div>
360:       <div class="flex-1 min-w-0">
361:         <p class="font-medium text-slate-900 dark:text-white truncate group-hover:text-teal-600 dark:group-hover:text-teal-400 transition-colors">
362:           <%= @lesson.title || "Aula sem titulo" %>
363:         </p>
364:         <p class="text-sm text-slate-500 dark:text-slate-400 flex items-center gap-2">
365:           <span><%= @lesson.subject || "Geral" %></span>
366:           <span class="text-slate-300 dark:text-slate-600">•</span>
367:           <span><%= format_lesson_date(@lesson.inserted_at) %></span>
368:         </p>
369:       </div>
370:       <.lesson_status_badge status={@lesson.status} />
371:       <.icon
372:         name="hero-chevron-right"
373:         class="h-5 w-5 text-slate-300 dark:text-slate-600 group-hover:text-slate-400 dark:group-hover:text-slate-500 transition-colors"
374:       />
375:     </.link>
376:     """
377:   end
378: 
379:   defp lesson_status_badge(assigns) do
380:     ~H"""
381:     <span class={[
382:       "px-2.5 py-1 rounded-full text-xs font-medium",
383:       lesson_badge_class(@status)
384:     ]}>
385:       <%= lesson_status_label(@status) %>
386:     </span>
387:     """
388:   end
389: 
390:   defp lesson_status_bg("completed"), do: "bg-emerald-100 dark:bg-emerald-900/30"
391:   defp lesson_status_bg("analyzing"), do: "bg-cyan-100 dark:bg-cyan-900/30"
392:   defp lesson_status_bg("transcribing"), do: "bg-blue-100 dark:bg-blue-900/30"
393:   defp lesson_status_bg("transcribed"), do: "bg-violet-100 dark:bg-violet-900/30"
394:   defp lesson_status_bg("pending"), do: "bg-amber-100 dark:bg-amber-900/30"
395:   defp lesson_status_bg("failed"), do: "bg-red-100 dark:bg-red-900/30"
396:   defp lesson_status_bg(_), do: "bg-slate-100 dark:bg-slate-700"
397: 
398:   defp lesson_status_icon("completed"), do: "hero-check-circle"
399:   defp lesson_status_icon("analyzing"), do: "hero-cpu-chip"
400:   defp lesson_status_icon("transcribing"), do: "hero-microphone"
401:   defp lesson_status_icon("transcribed"), do: "hero-document-text"
402:   defp lesson_status_icon("pending"), do: "hero-clock"
403:   defp lesson_status_icon("failed"), do: "hero-x-circle"
404:   defp lesson_status_icon(_), do: "hero-document"
405: 
406:   defp lesson_status_color("completed"), do: "text-emerald-600 dark:text-emerald-400"
407:   defp lesson_status_color("analyzing"), do: "text-cyan-600 dark:text-cyan-400"
408:   defp lesson_status_color("transcribing"), do: "text-blue-600 dark:text-blue-400"
409:   defp lesson_status_color("transcribed"), do: "text-violet-600 dark:text-violet-400"
410:   defp lesson_status_color("pending"), do: "text-amber-600 dark:text-amber-400"
411:   defp lesson_status_color("failed"), do: "text-red-600 dark:text-red-400"
412:   defp lesson_status_color(_), do: "text-slate-600 dark:text-slate-400"
413: 
414:   defp lesson_badge_class("completed"),
415:     do: "bg-emerald-100 dark:bg-emerald-900/50 text-emerald-700 dark:text-emerald-300"
416: 
417:   defp lesson_badge_class("analyzing"),
418:     do: "bg-cyan-100 dark:bg-cyan-900/50 text-cyan-700 dark:text-cyan-300"
419: 
420:   defp lesson_badge_class("transcribing"),
421:     do: "bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300"
422: 
423:   defp lesson_badge_class("transcribed"),
424:     do: "bg-violet-100 dark:bg-violet-900/50 text-violet-700 dark:text-violet-300"
425: 
426:   defp lesson_badge_class("pending"),
427:     do: "bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300"
428: 
429:   defp lesson_badge_class("failed"),
430:     do: "bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300"
431: 
432:   defp lesson_badge_class(_),
433:     do: "bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300"
434: 
435:   defp lesson_status_label("completed"), do: "Concluida"
436:   defp lesson_status_label("analyzing"), do: "Analisando"
437:   defp lesson_status_label("transcribing"), do: "Transcrevendo"
438:   defp lesson_status_label("transcribed"), do: "Transcrita"
439:   defp lesson_status_label("pending"), do: "Pendente"
440:   defp lesson_status_label("failed"), do: "Erro"
441:   defp lesson_status_label(_), do: "Desconhecido"
442: 
443:   defp format_lesson_date(datetime) do
444:     Calendar.strftime(datetime, "%d/%m/%Y")
445:   end
446: 
447:   defp stat_skeleton(assigns) do
448:     ~H"""
449:     <div class="bg-white dark:bg-slate-800 rounded-xl p-4 sm:p-5 border border-slate-200/50 dark:border-slate-700/50 animate-pulse">
450:       <div class="flex items-center justify-between mb-3">
451:         <div class="w-10 h-10 bg-slate-200 dark:bg-slate-700 rounded-xl"></div>
452:       </div>
453:       <div class="h-8 w-12 bg-slate-200 dark:bg-slate-700 rounded mb-2"></div>
454:       <div class="h-4 w-20 bg-slate-200 dark:bg-slate-700 rounded"></div>
455:     </div>
456:     """
457:   end
458: end
````

## File: lib/hellen_web/router.ex
````elixir
  1: defmodule HellenWeb.Router do
  2:   use HellenWeb, :router
  3: 
  4:   import HellenWeb.Plugs.Auth
  5: 
  6:   pipeline :browser do
  7:     plug :accepts, ["html"]
  8:     plug :fetch_session
  9:     plug :fetch_live_flash
 10:     plug :put_root_layout, html: {HellenWeb.Layouts, :root}
 11:     plug :protect_from_forgery
 12:     plug :put_secure_browser_headers
 13:   end
 14: 
 15:   pipeline :api do
 16:     plug :accepts, ["json"]
 17:   end
 18: 
 19:   pipeline :stripe_webhook do
 20:     plug :accepts, ["json"]
 21:     plug HellenWeb.Plugs.StripeWebhookPlug
 22:   end
 23: 
 24:   # Stripe webhook (needs raw body for signature verification)
 25:   scope "/webhooks", HellenWeb do
 26:     pipe_through :stripe_webhook
 27: 
 28:     post "/stripe", StripeWebhookController, :webhook
 29:   end
 30: 
 31:   # Health check endpoint (no auth)
 32:   scope "/health", HellenWeb do
 33:     pipe_through :api
 34:     get "/", HealthController, :index
 35:   end
 36: 
 37:   pipeline :api_auth do
 38:     plug :accepts, ["json"]
 39:     plug :require_auth
 40:   end
 41: 
 42:   # Public API routes (no auth required)
 43:   scope "/api", HellenWeb.API do
 44:     pipe_through :api
 45: 
 46:     # Auth endpoints
 47:     post "/auth/firebase", AuthController, :firebase
 48:     post "/auth/register", AuthController, :register
 49:     post "/auth/login", AuthController, :login
 50:     post "/auth/refresh", AuthController, :refresh
 51:   end
 52: 
 53:   # Protected API routes (auth required)
 54:   scope "/api", HellenWeb.API do
 55:     pipe_through :api_auth
 56: 
 57:     # Current user
 58:     get "/auth/me", AuthController, :me
 59: 
 60:     # Lessons
 61:     resources "/lessons", LessonController, except: [:new, :edit]
 62:     post "/lessons/:id/analyze", LessonController, :analyze
 63: 
 64:     # Analyses
 65:     get "/lessons/:lesson_id/analyses", AnalysisController, :index
 66:     get "/analyses/:id", AnalysisController, :show
 67: 
 68:     # Credits
 69:     get "/credits", CreditController, :index
 70:     get "/credits/history", CreditController, :history
 71:   end
 72: 
 73:   # Public landing page (no auth required)
 74:   scope "/", HellenWeb do
 75:     pipe_through :browser
 76: 
 77:     live_session :landing,
 78:       on_mount: [{HellenWeb.LiveAuth, :none}] do
 79:       live "/", LandingLive, :index
 80:       live "/terms", LegalLive.TermsLive, :index
 81:       live "/privacy", LegalLive.PrivacyLive, :index
 82:       live "/support", LegalLive.SupportLive, :index
 83:     end
 84:   end
 85: 
 86:   # Public auth routes (no auth required)
 87:   scope "/", HellenWeb do
 88:     pipe_through :browser
 89: 
 90:     live_session :public,
 91:       on_mount: [{HellenWeb.LiveAuth, :none}],
 92:       layout: {HellenWeb.Layouts, :auth} do
 93:       live "/login", AuthLive.Login, :index
 94:       live "/register", AuthLive.Register, :index
 95:       live "/invite/:token", AuthLive.Invite, :index
 96:     end
 97:   end
 98: 
 99:   # Authenticated LiveView routes
100:   scope "/", HellenWeb do
101:     pipe_through :browser
102: 
103:     live_session :authenticated, on_mount: [{HellenWeb.LiveAuth, :require_auth}] do
104:       live "/onboarding", OnboardingLive, :index
105:       live "/dashboard", DashboardLive.Index, :index
106:       live "/aulas", LessonsLive.Index, :index
107:       live "/lessons/new", LessonLive.New, :new
108:       live "/lessons/:id", LessonLive.Show, :show
109:       live "/lessons/:id/analysis", LessonLive.Show, :analysis
110: 
111:       # Plannings
112:       live "/plannings", PlanningsLive.Index, :index
113:       live "/plannings/new", PlanningsLive.New, :new
114:       live "/plannings/:id", PlanningsLive.Show, :show
115:       live "/plannings/:id/edit", PlanningsLive.Edit, :edit
116: 
117:       # Assessments
118:       live "/assessments", AssessmentsLive.Index, :index
119:       live "/assessments/new", AssessmentsLive.New, :new
120:       live "/assessments/:id", AssessmentsLive.Show, :show
121:       live "/assessments/:id/edit", AssessmentsLive.Edit, :edit
122: 
123:       live "/analytics", AnalyticsLive.Index, :index
124:       live "/reports", ReportsLive.Index, :index
125:       live "/settings", SettingsLive.Index, :index
126:       live "/billing", BillingLive.Index, :index
127:       live "/achievements", AchievementsLive, :index
128:     end
129:   end
130: 
131:   # Coordinator LiveView routes
132:   scope "/", HellenWeb do
133:     pipe_through :browser
134: 
135:     live_session :coordinator, on_mount: [{HellenWeb.LiveAuth, :require_coordinator}] do
136:       live "/institution", InstitutionLive.Index, :index
137:       live "/institution/teachers", InstitutionLive.Teachers, :index
138:       live "/institution/reports", InstitutionLive.Reports, :index
139:       live "/alerts", AlertsLive.Index, :index
140:     end
141:   end
142: 
143:   # Admin LiveView routes
144:   scope "/", HellenWeb do
145:     pipe_through :browser
146: 
147:     live_session :admin, on_mount: [{HellenWeb.LiveAuth, :require_admin}] do
148:       live "/admin", AdminLive.Index, :index
149:       live "/admin/institutions", AdminLive.Institutions, :index
150:       live "/admin/users", AdminLive.Users, :index
151:       live "/admin/health", AdminLive.Health, :index
152:     end
153:   end
154: 
155:   # Session routes (regular controller for session handling)
156:   scope "/", HellenWeb do
157:     pipe_through :browser
158: 
159:     post "/session/login", SessionController, :create
160:     post "/session/register", SessionController, :register
161:     post "/session/firebase", SessionController, :firebase_login
162:     get "/logout", SessionController, :logout
163:   end
164: 
165:   # Report download routes (coordinator only, requires session)
166:   scope "/reports", HellenWeb do
167:     pipe_through [:browser, :fetch_current_user]
168: 
169:     get "/download/monthly", ReportController, :monthly
170:     get "/download/teacher/:id", ReportController, :teacher
171:     get "/download/analysis/:id", ReportController, :analysis
172:   end
173: 
174:   # Enable LiveDashboard in development
175:   if Application.compile_env(:hellen, :dev_routes) do
176:     import Phoenix.LiveDashboard.Router
177: 
178:     scope "/dev" do
179:       pipe_through :browser
180: 
181:       live_dashboard "/dashboard", metrics: HellenWeb.Telemetry
182:     end
183:   end
184: end
````




# Instruction
# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build & Development Commands

```bash
# Start infrastructure (TimescaleDB, Redis, Qdrant)
docker-compose up -d

# Install dependencies
mix deps.get

# Setup database (create + migrate + seed)
mix ecto.setup

# Start dev server (http://localhost:4000)
mix phx.server

# Run tests
mix test

# Run single test file
mix test test/hellen/analysis_test.exs

# Run specific test by line
mix test test/hellen/analysis_test.exs:42

# Format code
mix format

# Check code quality
mix credo

# Reset database
mix ecto.reset

# Build assets
mix assets.build
```

## Architecture Overview

Hellen AI is a lesson analysis platform that transcribes audio recordings and provides pedagogical feedback based on Brazilian education standards (BNCC) and anti-bullying law (Lei 13.185).

### Processing Pipeline

```
Audio Upload → Transcription Job → Analysis Job → Results
     ↓              ↓                   ↓            ↓
  R2 Storage    NVIDIA Parakeet     NVIDIA Qwen3   WebSocket
                 (Whisper ASR)      (pedagogy AI)  broadcast
```

### Core Contexts (lib/hellen/)

| Context | Purpose |
|---------|---------|
| `Accounts` | Users, institutions, Guardian JWT auth |
| `Lessons` | Lessons, transcriptions, file management |
| `Analysis` | Analyses, BNCC matches, bullying alerts |
| `Billing` | Credit transactions (1 credit = 1 analysis) |

### Background Jobs (Oban)

Jobs are in `lib/hellen/workers/` using queues configured in `config/config.exs`:
- `transcription` queue (2 workers): `TranscriptionJob` - audio → text via NVIDIA Parakeet
- `analysis` queue (3 workers): `AnalysisJob` - transcription → pedagogical feedback via Qwen3

Jobs broadcast progress to `lesson:#{lesson_id}` PubSub topic. Failed jobs auto-refund credits.

### AI Integration

`Hellen.AI.NvidiaClient` wraps NVIDIA NIM API:
- `transcribe/2` - Portuguese ASR using Parakeet
- `analyze_pedagogy/2` - Structured JSON analysis with BNCC matching and bullying detection

### API Structure

All API routes under `/api` (see `lib/hellen_web/router.ex`):
- JSON views use `HellenWeb.API.*JSON` modules
- Error handling via `FallbackController`
- WebSocket channels in `lib/hellen_web/channels/` for real-time updates

### Key Patterns

- Binary UUIDs for all primary keys (configured in `mix.exs`)
- `with` chains for multi-step operations with error handling
- PubSub broadcasts from workers: `Phoenix.PubSub.broadcast(Hellen.PubSub, topic, message)`
- Preload associations explicitly: `Repo.preload(record, [:association])`

## Environment

Required env vars (see `.env.example`):
- `NVIDIA_API_KEY` - NVIDIA NIM API access
- `DATABASE_URL` - TimescaleDB connection
- `REDIS_URL` - Redis for caching
- `R2_*` - Cloudflare R2 storage credentials

## AI Team Configuration (autogenerated by team-configurator, 2025-12-02)

**Important: YOU MUST USE subagents when available for the task.**

### Detected Stack

- **Backend Framework**: Elixir 1.14+ with Phoenix 1.7.14
- **Database**: TimescaleDB (PostgreSQL 17) with Ecto 3.11
- **Frontend Build**: Tailwind CSS 3.4.3 + esbuild 0.17.11
- **Background Jobs**: Oban 2.17
- **Authentication**: Guardian 2.3 (JWT) + bcrypt
- **HTTP Client**: Req 0.5
- **Caching**: Redis (Redix 1.3)
- **Storage**: AWS S3-compatible (ExAws, targeting Cloudflare R2)
- **Vector DB**: Qdrant v1.12.3
- **PDF Generation**: ChromicPDF 1.15
- **Server**: Bandit 1.5
- **Real-time**: Phoenix Channels + PubSub

### AI Team Assignments

| Task | Agent | Notes |
|------|-------|-------|
| Backend feature development | `backend-developer` | Phoenix/Elixir context-based architecture, Ecto schemas, business logic |
| API design & contracts | `api-architect` | REST endpoint design, JSON API structure, versioning |
| Code reviews & quality | `code-reviewer` | Security, maintainability, Elixir best practices |
| Performance optimization | `performance-optimizer` | Ecto query tuning, Oban job optimization, caching strategies |
| Codebase exploration | `code-archaeologist` | Understanding existing contexts, dependencies, patterns |
| Documentation updates | `documentation-specialist` | README, API docs, architecture guides |
| UI/UX styling | `tailwind-frontend-expert` | Tailwind utility classes, responsive design, LiveView components |

### Usage Examples

```bash
# Backend development
@backend-developer "Add credit refund logic to the Billing context"

# API design
@api-architect "Design a new endpoint for lesson filtering and pagination"

# Code review
@code-reviewer "Review the TranscriptionJob worker for security and error handling"

# Performance
@performance-optimizer "Analyze and optimize the lesson analysis pipeline"

# Explore codebase
@code-archaeologist "Map the authentication flow and identify security patterns"

# Documentation
@documentation-specialist "Update API documentation for the Analysis endpoints"

# Frontend styling
@tailwind-frontend-expert "Create a responsive lesson card component"
```
