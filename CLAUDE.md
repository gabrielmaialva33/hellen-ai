# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build & Development Commands

```bash
# Start infrastructure (TimescaleDB, Redis, Qdrant)
docker-compose up -d

# Install dependencies
mix deps.get

# Setup database (create + migrate + seed)
mix ecto.setup

# Start dev server (http://localhost:4000)
mix phx.server

# Run tests
mix test

# Run single test file
mix test test/hellen/analysis_test.exs

# Run specific test by line
mix test test/hellen/analysis_test.exs:42

# Format code
mix format

# Check code quality
mix credo

# Reset database
mix ecto.reset

# Build assets
mix assets.build
```

## Architecture Overview

Hellen AI is a lesson analysis platform that transcribes audio recordings and provides pedagogical feedback based on Brazilian education standards (BNCC) and anti-bullying law (Lei 13.185).

### Processing Pipeline

```
Audio Upload → Transcription Job → Analysis Job → Results
     ↓              ↓                   ↓            ↓
  R2 Storage    NVIDIA Parakeet     NVIDIA Qwen3   WebSocket
                 (Whisper ASR)      (pedagogy AI)  broadcast
```

### Core Contexts (lib/hellen/)

| Context | Purpose |
|---------|---------|
| `Accounts` | Users, institutions, Guardian JWT auth |
| `Lessons` | Lessons, transcriptions, file management |
| `Analysis` | Analyses, BNCC matches, bullying alerts |
| `Billing` | Credit transactions (1 credit = 1 analysis) |

### Background Jobs (Oban)

Jobs are in `lib/hellen/workers/` using queues configured in `config/config.exs`:
- `transcription` queue (2 workers): `TranscriptionJob` - audio → text via NVIDIA Parakeet
- `analysis` queue (3 workers): `AnalysisJob` - transcription → pedagogical feedback via Qwen3

Jobs broadcast progress to `lesson:#{lesson_id}` PubSub topic. Failed jobs auto-refund credits.

### AI Integration

`Hellen.AI.NvidiaClient` wraps NVIDIA NIM API:
- `transcribe/2` - Portuguese ASR using Parakeet
- `analyze_pedagogy/2` - Structured JSON analysis with BNCC matching and bullying detection

### API Structure

All API routes under `/api` (see `lib/hellen_web/router.ex`):
- JSON views use `HellenWeb.API.*JSON` modules
- Error handling via `FallbackController`
- WebSocket channels in `lib/hellen_web/channels/` for real-time updates

### Key Patterns

- Binary UUIDs for all primary keys (configured in `mix.exs`)
- `with` chains for multi-step operations with error handling
- PubSub broadcasts from workers: `Phoenix.PubSub.broadcast(Hellen.PubSub, topic, message)`
- Preload associations explicitly: `Repo.preload(record, [:association])`

## Environment

Required env vars (see `.env.example`):
- `NVIDIA_API_KEY` - NVIDIA NIM API access
- `DATABASE_URL` - TimescaleDB connection
- `REDIS_URL` - Redis for caching
- `R2_*` - Cloudflare R2 storage credentials

## AI Team Configuration (autogenerated by team-configurator, 2025-12-02)

**Important: YOU MUST USE subagents when available for the task.**

### Detected Stack

- **Backend Framework**: Elixir 1.14+ with Phoenix 1.7.14
- **Database**: TimescaleDB (PostgreSQL 17) with Ecto 3.11
- **Frontend Build**: Tailwind CSS 3.4.3 + esbuild 0.17.11
- **Background Jobs**: Oban 2.17
- **Authentication**: Guardian 2.3 (JWT) + bcrypt
- **HTTP Client**: Req 0.5
- **Caching**: Redis (Redix 1.3)
- **Storage**: AWS S3-compatible (ExAws, targeting Cloudflare R2)
- **Vector DB**: Qdrant v1.12.3
- **PDF Generation**: ChromicPDF 1.15
- **Server**: Bandit 1.5
- **Real-time**: Phoenix Channels + PubSub

### AI Team Assignments

| Task | Agent | Notes |
|------|-------|-------|
| Backend feature development | `backend-developer` | Phoenix/Elixir context-based architecture, Ecto schemas, business logic |
| API design & contracts | `api-architect` | REST endpoint design, JSON API structure, versioning |
| Code reviews & quality | `code-reviewer` | Security, maintainability, Elixir best practices |
| Performance optimization | `performance-optimizer` | Ecto query tuning, Oban job optimization, caching strategies |
| Codebase exploration | `code-archaeologist` | Understanding existing contexts, dependencies, patterns |
| Documentation updates | `documentation-specialist` | README, API docs, architecture guides |
| UI/UX styling | `tailwind-frontend-expert` | Tailwind utility classes, responsive design, LiveView components |

### Usage Examples

```bash
# Backend development
@backend-developer "Add credit refund logic to the Billing context"

# API design
@api-architect "Design a new endpoint for lesson filtering and pagination"

# Code review
@code-reviewer "Review the TranscriptionJob worker for security and error handling"

# Performance
@performance-optimizer "Analyze and optimize the lesson analysis pipeline"

# Explore codebase
@code-archaeologist "Map the authentication flow and identify security patterns"

# Documentation
@documentation-specialist "Update API documentation for the Analysis endpoints"

# Frontend styling
@tailwind-frontend-expert "Create a responsive lesson card component"
```

