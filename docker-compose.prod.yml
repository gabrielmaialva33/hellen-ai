# Hellen AI - Production Docker Compose
# Uses existing TimescaleDB and Redis from guardioes stack

services:
  hellen:
    image: ghcr.io/gabrielmaialva33/hellen-ai:latest
    container_name: hellen-ai
    restart: unless-stopped
    ports:
      - "4001:4000"
    environment:
      - MIX_ENV=prod
      - PHX_SERVER=true
      - PHX_HOST=${PHX_HOST:-hellen-ai.mahina.cloud}
      - PORT=4000
      - SECRET_KEY_BASE=${SECRET_KEY_BASE}
      - DATABASE_URL=${DATABASE_URL:-ecto://postgres:postgres@host.docker.internal:5432/hellen_prod}
      - REDIS_URL=${REDIS_URL:-redis://host.docker.internal:6379/1}
      - NVIDIA_API_KEY=${NVIDIA_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET=${R2_BUCKET:-hellen-uploads}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL}
      - GUARDIAN_SECRET_KEY=${GUARDIAN_SECRET_KEY}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - hellen-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  hellen-network:
    driver: bridge
