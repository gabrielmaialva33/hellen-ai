<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Relatorio Mensal - <%= @institution.name %></title>
  <%= @styles %>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <div>
        <div class="logo">
          <div class="logo-icon">H</div>
          <span>Hellen AI</span>
        </div>
        <h1><%= @institution.name %></h1>
        <p class="subtitle">Relatorio Mensal - <%= @period %></p>
      </div>
      <div class="meta">
        <p><strong>Plano:</strong> <%= String.capitalize(@institution.plan || "free") %></p>
        <p>Gerado em: <%= @h.format_datetime(@generated_at) %></p>
      </div>
    </div>
  </div>

  <!-- Stats Section -->
  <div class="section">
    <h2 class="section-title">Resumo do Periodo</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <h3><%= @stats.teachers %></h3>
        <p>Professores</p>
      </div>
      <div class="stat-card">
        <h3><%= @stats.lessons %></h3>
        <p>Aulas</p>
      </div>
      <div class="stat-card">
        <h3><%= @stats.analyses %></h3>
        <p>Analises</p>
      </div>
      <div class="stat-card">
        <h3><%= @stats.alerts %></h3>
        <p>Alertas</p>
      </div>
      <%= if @stats.avg_score do %>
        <div class="stat-card highlight">
          <h3><%= @stats.avg_score %>/10</h3>
          <p>Score Medio</p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Teachers Ranking -->
  <div class="section">
    <h2 class="section-title">Ranking de Professores</h2>
    <%= if length(@teachers_ranking) > 0 do %>
      <table>
        <thead>
          <tr>
            <th style="width: 40px;">#</th>
            <th>Professor</th>
            <th class="text-center">Aulas</th>
            <th class="text-center">Analises</th>
            <th class="text-center">Score Medio</th>
          </tr>
        </thead>
        <tbody>
          <%= for {teacher, index} <- Enum.with_index(@teachers_ranking, 1) do %>
            <tr>
              <td>
                <%= if index <= 3 do %>
                  <span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: <%= @h.medal_color(index) %>; color: white; font-weight: 700; font-size: 10px;">
                    <%= index %>
                  </span>
                <% else %>
                  <%= index %>
                <% end %>
              </td>
              <td><%= teacher.name || "Sem nome" %></td>
              <td class="text-center"><%= teacher.lessons %></td>
              <td class="text-center"><%= teacher.analyses %></td>
              <td class="text-center">
                <%= if teacher.avg_score do %>
                  <span class="<%= @h.score_class(teacher.avg_score) %>">
                    <%= teacher.avg_score %>/10
                  </span>
                <% else %>
                  <span style="color: #94a3b8;">-</span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="empty-state">
        <p>Nenhum professor com atividade no periodo.</p>
      </div>
    <% end %>
  </div>

  <!-- Performance Overview -->
  <div class="section">
    <h2 class="section-title">Visao Geral de Performance</h2>
    <div class="info-card">
      <div class="info-title">Indicadores do Periodo</div>
      <div style="display: flex; gap: 24px; margin-top: 12px;">
        <div style="flex: 1;">
          <p style="font-size: 10px; color: #64748b; margin-bottom: 4px;">Taxa de Analise</p>
          <div class="progress-bar" style="margin-bottom: 8px;">
            <div class="progress-bar-fill" style="width: <%= @h.analysis_rate(@stats) %>%;"></div>
          </div>
          <p style="font-size: 11px; font-weight: 600; color: #0d9488;"><%= @h.analysis_rate(@stats) %>% das aulas analisadas</p>
        </div>
        <div style="flex: 1;">
          <p style="font-size: 10px; color: #64748b; margin-bottom: 4px;">Professores Ativos</p>
          <div class="progress-bar" style="margin-bottom: 8px;">
            <div class="progress-bar-fill" style="width: 100%;"></div>
          </div>
          <p style="font-size: 11px; font-weight: 600; color: #0d9488;"><%= @stats.teachers %> professores cadastrados</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Two Column: Alerts & BNCC -->
  <div class="section">
    <div class="two-column">
      <!-- Alerts Summary -->
      <div>
        <h2 class="section-title">Alertas</h2>
        <%= if map_size(@alerts_summary.by_severity) > 0 do %>
          <table>
            <thead>
              <tr>
                <th>Severidade</th>
                <th class="text-center">Quantidade</th>
              </tr>
            </thead>
            <tbody>
              <%= for {severity, count} <- @h.sort_by_severity(@alerts_summary.by_severity) do %>
                <tr>
                  <td>
                    <span class="badge <%= @h.severity_badge_class(severity) %>">
                      <%= @h.severity_label(severity) %>
                    </span>
                  </td>
                  <td class="text-center"><%= count %></td>
                </tr>
              <% end %>
            </tbody>
          </table>

          <%= if map_size(@alerts_summary.by_type) > 0 do %>
            <h3 style="margin-top: 16px; margin-bottom: 8px; font-size: 11px; font-weight: 700; color: #334155;">Por Tipo</h3>
            <table>
              <tbody>
                <%= for {type, count} <- @alerts_summary.by_type do %>
                  <tr>
                    <td><%= @h.alert_type_label(type) %></td>
                    <td class="text-center"><%= count %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          <% end %>
        <% else %>
          <div class="empty-state">
            <p>Nenhum alerta no periodo.</p>
          </div>
        <% end %>
      </div>

      <!-- BNCC Coverage -->
      <div>
        <h2 class="section-title">Competencias BNCC</h2>
        <%= if length(@bncc_coverage) > 0 do %>
          <%= for item <- @bncc_coverage do %>
            <div class="bncc-item">
              <span class="bncc-code"><%= item.code %></span>
              <span class="bncc-name"><%= @h.truncate(item.name, 35) %></span>
              <span class="bncc-count"><%= item.count %>x</span>
            </div>
          <% end %>
        <% else %>
          <div class="empty-state">
            <p>Nenhuma competencia identificada no periodo.</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Info Card -->
  <div class="section">
    <div class="info-card">
      <div class="info-title">Sobre este Relatorio</div>
      <div class="info-text">
        Este relatorio apresenta um panorama completo da atividade pedagogica da instituicao durante o periodo de <%= @period %>.
        Os dados incluem metricas de aulas registradas, analises realizadas, ranking de professores e cobertura de competencias BNCC.
        Utilize essas informacoes para tomada de decisao e acompanhamento pedagogico institucional.
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <div class="footer-logo">
      <span>H</span>
      <span>Hellen AI</span>
    </div>
    <span><%= @period %> - <%= @institution.name %></span>
  </div>
</body>
</html>
